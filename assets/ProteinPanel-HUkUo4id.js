import{c as Ty,o as Zb,r as Ai,g as Kb,j as Ci,B as Jb,S as Qb,M as Dm,T as ev}from"./index-qjH87g2J.js";Number.EPSILON===void 0&&(Number.EPSILON=Math.pow(2,-52));Number.isInteger===void 0&&(Number.isInteger=function(t){return typeof t=="number"&&isFinite(t)&&Math.floor(t)===t});Math.sign===void 0&&(Math.sign=function(t){return t<0?-1:t>0?1:+t});"name"in Function.prototype||Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}});Object.assign===void 0&&(Object.assign=function(t){if(t==null)throw new TypeError("Cannot convert undefined or null to object");const e=Object(t);for(let n=1;n<arguments.length;n++){const i=arguments[n];if(i!=null)for(const r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e});const tv="118",nv=0,Bm=1,iv=2,Py=1,rv=2,Ha=3,Yo=0,yn=1,jc=2,Ey=1,or=0,Br=1,Lf=2,Om=3,km=4,sv=5,ro=100,ov=101,av=102,Fm=103,Nm=104,cv=200,lv=201,hv=202,uv=203,Iy=204,Ly=205,dv=206,fv=207,pv=208,mv=209,gv=210,yv=0,xv=1,bv=2,Rf=3,vv=4,_v=5,wv=6,Sv=7,Au=0,Mv=1,Av=2,yo=0,Cv=1,Tv=2,Pv=3,Ev=4,Iv=5,jp=300,qp=301,Xp=302,Ry=303,Yp=304,qc=306,Zp=307,Th=1e3,zn=1001,Ph=1002,zt=1003,Df=1004,Bf=1005,gn=1006,Dy=1007,Cu=1008,gs=1009,Lv=1010,Rv=1011,Eh=1012,Dv=1013,ph=1014,sr=1015,Ih=1016,Bv=1017,Ov=1018,kv=1019,Za=1020,Fv=1021,us=1022,Gn=1023,Nv=1024,zv=1025,Gv=Gn,xo=1026,sc=1027,Uv=1028,Vv=1029,Hv=1030,$v=1031,Wv=1032,jv=1033,zm=33776,Gm=33777,Um=33778,Vm=33779,Hm=35840,$m=35841,Wm=35842,jm=35843,qv=36196,qm=37492,Xm=37496,Xv=37808,Yv=37809,Zv=37810,Kv=37811,Jv=37812,Qv=37813,e_=37814,t_=37815,n_=37816,i_=37817,r_=37818,s_=37819,o_=37820,a_=37821,c_=36492,l_=37840,h_=37841,u_=37842,d_=37843,f_=37844,p_=37845,m_=37846,g_=37847,y_=37848,x_=37849,b_=37850,v_=37851,__=37852,w_=37853,S_=2200,M_=2201,A_=2202,Lh=2300,mh=2301,Yu=2302,So=2400,co=2401,Rh=2402,Kp=2500,By=2501,C_=0,Pn=3e3,Xc=3001,Jp=3007,Qp=3002,T_=3003,Oy=3004,ky=3005,Fy=3006,P_=3200,E_=3201,Zo=0,I_=1,Zu=7680,L_=519,Tu=35044,oc=35048;function xr(){}Object.assign(xr.prototype,{addEventListener:function(t,e){this._listeners===void 0&&(this._listeners={});const n=this._listeners;n[t]===void 0&&(n[t]=[]),n[t].indexOf(e)===-1&&n[t].push(e)},hasEventListener:function(t,e){if(this._listeners===void 0)return!1;const n=this._listeners;return n[t]!==void 0&&n[t].indexOf(e)!==-1},removeEventListener:function(t,e){if(this._listeners===void 0)return;const i=this._listeners[t];if(i!==void 0){const r=i.indexOf(e);r!==-1&&i.splice(r,1)}},dispatchEvent:function(t){if(this._listeners===void 0)return;const n=this._listeners[t.type];if(n!==void 0){t.target=this;const i=n.slice(0);for(let r=0,s=i.length;r<s;r++)i[r].call(this,t)}}});const Sn=[];for(let t=0;t<256;t++)Sn[t]=(t<16?"0":"")+t.toString(16);const ut={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){const t=Math.random()*4294967295|0,e=Math.random()*4294967295|0,n=Math.random()*4294967295|0,i=Math.random()*4294967295|0;return(Sn[t&255]+Sn[t>>8&255]+Sn[t>>16&255]+Sn[t>>24&255]+"-"+Sn[e&255]+Sn[e>>8&255]+"-"+Sn[e>>16&15|64]+Sn[e>>24&255]+"-"+Sn[n&63|128]+Sn[n>>8&255]+"-"+Sn[n>>16&255]+Sn[n>>24&255]+Sn[i&255]+Sn[i>>8&255]+Sn[i>>16&255]+Sn[i>>24&255]).toUpperCase()},clamp:function(t,e,n){return Math.max(e,Math.min(n,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,n,i,r){return i+(t-e)*(r-i)/(n-e)},lerp:function(t,e,n){return(1-n)*t+n*e},smoothstep:function(t,e,n){return t<=e?0:t>=n?1:(t=(t-e)/(n-e),t*t*(3-2*t))},smootherstep:function(t,e,n){return t<=e?0:t>=n?1:(t=(t-e)/(n-e),t*t*t*(t*(t*6-15)+10))},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},degToRad:function(t){return t*ut.DEG2RAD},radToDeg:function(t){return t*ut.RAD2DEG},isPowerOfTwo:function(t){return(t&t-1)===0&&t!==0},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,n,i,r){const s=Math.cos,o=Math.sin,a=s(n/2),c=o(n/2),l=s((e+i)/2),h=o((e+i)/2),u=s((e-i)/2),f=o((e-i)/2),d=s((i-e)/2),p=o((i-e)/2);switch(r){case"XYX":t.set(a*h,c*u,c*f,a*l);break;case"YZY":t.set(c*f,a*h,c*u,a*l);break;case"ZXZ":t.set(c*u,c*f,a*h,a*l);break;case"XZX":t.set(a*h,c*p,c*d,a*l);break;case"YXY":t.set(c*d,a*h,c*p,a*l);break;case"ZYZ":t.set(c*p,c*d,a*h,a*l);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}}};function Te(t=0,e=0){this.x=t,this.y=e}Object.defineProperties(Te.prototype,{width:{get:function(){return this.x},set:function(t){this.x=t}},height:{get:function(){return this.y},set:function(t){this.y=t}}});Object.assign(Te.prototype,{isVector2:!0,set:function(t,e){return this.x=t,this.y=e,this},setScalar:function(t){return this.x=t,this.y=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(t){return this.x=t.x,this.y=t.y,this},add:function(t,e){return e!==void 0?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this)},addScalar:function(t){return this.x+=t,this.y+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this},sub:function(t,e){return e!==void 0?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this)},subScalar:function(t){return this.x-=t,this.y-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},multiply:function(t){return this.x*=t.x,this.y*=t.y,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this},divide:function(t){return this.x/=t.x,this.y/=t.y,this},divideScalar:function(t){return this.multiplyScalar(1/t)},applyMatrix3:function(t){const e=this.x,n=this.y,i=t.elements;return this.x=i[0]*e+i[3]*n+i[6],this.y=i[1]*e+i[4]*n+i[7],this},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this},clampScalar:function(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this},clampLength:function(t,e){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(t,Math.min(e,n)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(t){return this.x*t.x+this.y*t.y},cross:function(t){return this.x*t.y-this.y*t.x},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length()||1)},angle:function(){return Math.atan2(-this.y,-this.x)+Math.PI},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){const e=this.x-t.x,n=this.y-t.y;return e*e+n*n},manhattanDistanceTo:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this},lerpVectors:function(t,e,n){return this.x=t.x+(e.x-t.x)*n,this.y=t.y+(e.y-t.y)*n,this},equals:function(t){return t.x===this.x&&t.y===this.y},fromArray:function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this},toArray:function(t,e){return t===void 0&&(t=[]),e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t},fromBufferAttribute:function(t,e,n){return n!==void 0&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this},rotateAround:function(t,e){const n=Math.cos(e),i=Math.sin(e),r=this.x-t.x,s=this.y-t.y;return this.x=r*n-s*i+t.x,this.y=r*i+s*n+t.y,this},random:function(){return this.x=Math.random(),this.y=Math.random(),this}});function An(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}Object.assign(An.prototype,{isMatrix3:!0,set:function(t,e,n,i,r,s,o,a,c){const l=this.elements;return l[0]=t,l[1]=i,l[2]=o,l[3]=e,l[4]=r,l[5]=a,l[6]=n,l[7]=s,l[8]=c,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return new this.constructor().fromArray(this.elements)},copy:function(t){const e=this.elements,n=t.elements;return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],this},extractBasis:function(t,e,n){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this},setFromMatrix4:function(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this},multiply:function(t){return this.multiplyMatrices(this,t)},premultiply:function(t){return this.multiplyMatrices(t,this)},multiplyMatrices:function(t,e){const n=t.elements,i=e.elements,r=this.elements,s=n[0],o=n[3],a=n[6],c=n[1],l=n[4],h=n[7],u=n[2],f=n[5],d=n[8],p=i[0],y=i[3],g=i[6],m=i[1],x=i[4],v=i[7],b=i[2],_=i[5],C=i[8];return r[0]=s*p+o*m+a*b,r[3]=s*y+o*x+a*_,r[6]=s*g+o*v+a*C,r[1]=c*p+l*m+h*b,r[4]=c*y+l*x+h*_,r[7]=c*g+l*v+h*C,r[2]=u*p+f*m+d*b,r[5]=u*y+f*x+d*_,r[8]=u*g+f*v+d*C,this},multiplyScalar:function(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this},determinant:function(){const t=this.elements,e=t[0],n=t[1],i=t[2],r=t[3],s=t[4],o=t[5],a=t[6],c=t[7],l=t[8];return e*s*l-e*o*c-n*r*l+n*o*a+i*r*c-i*s*a},getInverse:function(t,e){e!==void 0&&console.warn("THREE.Matrix3: .getInverse() can no longer be configured to throw on degenerate.");const n=t.elements,i=this.elements,r=n[0],s=n[1],o=n[2],a=n[3],c=n[4],l=n[5],h=n[6],u=n[7],f=n[8],d=f*c-l*u,p=l*h-f*a,y=u*a-c*h,g=r*d+s*p+o*y;if(g===0)return this.set(0,0,0,0,0,0,0,0,0);const m=1/g;return i[0]=d*m,i[1]=(o*u-f*s)*m,i[2]=(l*s-o*c)*m,i[3]=p*m,i[4]=(f*r-o*h)*m,i[5]=(o*a-l*r)*m,i[6]=y*m,i[7]=(s*h-u*r)*m,i[8]=(c*r-s*a)*m,this},transpose:function(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},getNormalMatrix:function(t){return this.setFromMatrix4(t).getInverse(this).transpose()},transposeIntoArray:function(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this},setUvTransform:function(t,e,n,i,r,s,o){const a=Math.cos(r),c=Math.sin(r);this.set(n*a,n*c,-n*(a*s+c*o)+s+t,-i*c,i*a,-i*(-c*s+a*o)+o+e,0,0,1)},scale:function(t,e){const n=this.elements;return n[0]*=t,n[3]*=t,n[6]*=t,n[1]*=e,n[4]*=e,n[7]*=e,this},rotate:function(t){const e=Math.cos(t),n=Math.sin(t),i=this.elements,r=i[0],s=i[3],o=i[6],a=i[1],c=i[4],l=i[7];return i[0]=e*r+n*a,i[3]=e*s+n*c,i[6]=e*o+n*l,i[1]=-n*r+e*a,i[4]=-n*s+e*c,i[7]=-n*o+e*l,this},translate:function(t,e){const n=this.elements;return n[0]+=t*n[2],n[3]+=t*n[5],n[6]+=t*n[8],n[1]+=e*n[2],n[4]+=e*n[5],n[7]+=e*n[8],this},equals:function(t){const e=this.elements,n=t.elements;for(let i=0;i<9;i++)if(e[i]!==n[i])return!1;return!0},fromArray:function(t,e){e===void 0&&(e=0);for(let n=0;n<9;n++)this.elements[n]=t[n+e];return this},toArray:function(t,e){t===void 0&&(t=[]),e===void 0&&(e=0);const n=this.elements;return t[e]=n[0],t[e+1]=n[1],t[e+2]=n[2],t[e+3]=n[3],t[e+4]=n[4],t[e+5]=n[5],t[e+6]=n[6],t[e+7]=n[7],t[e+8]=n[8],t}});let Os;const ys={getDataURL:function(t){if(/^data:/i.test(t.src)||typeof HTMLCanvasElement>"u")return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{Os===void 0&&(Os=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),Os.width=t.width,Os.height=t.height;const n=Os.getContext("2d");t instanceof ImageData?n.putImageData(t,0,0):n.drawImage(t,0,0,t.width,t.height),e=Os}return e.width>2048||e.height>2048?e.toDataURL("image/jpeg",.6):e.toDataURL("image/png")}};let R_=0;function $t(t,e,n,i,r,s,o,a,c,l){Object.defineProperty(this,"id",{value:R_++}),this.uuid=ut.generateUUID(),this.name="",this.image=t!==void 0?t:$t.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=e!==void 0?e:$t.DEFAULT_MAPPING,this.wrapS=n!==void 0?n:zn,this.wrapT=i!==void 0?i:zn,this.magFilter=r!==void 0?r:gn,this.minFilter=s!==void 0?s:Cu,this.anisotropy=c!==void 0?c:1,this.format=o!==void 0?o:Gn,this.internalFormat=null,this.type=a!==void 0?a:gs,this.offset=new Te(0,0),this.repeat=new Te(1,1),this.center=new Te(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new An,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=l!==void 0?l:Pn,this.version=0,this.onUpdate=null}$t.DEFAULT_IMAGE=void 0;$t.DEFAULT_MAPPING=jp;$t.prototype=Object.assign(Object.create(xr.prototype),{constructor:$t,isTexture:!0,updateMatrix:function(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.name=t.name,this.image=t.image,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.encoding=t.encoding,this},toJSON:function(t){const e=t===void 0||typeof t=="string";if(!e&&t.textures[this.uuid]!==void 0)return t.textures[this.uuid];const n={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(this.image!==void 0){const i=this.image;if(i.uuid===void 0&&(i.uuid=ut.generateUUID()),!e&&t.images[i.uuid]===void 0){let r;if(Array.isArray(i)){r=[];for(let s=0,o=i.length;s<o;s++)r.push(ys.getDataURL(i[s]))}else r=ys.getDataURL(i);t.images[i.uuid]={uuid:i.uuid,url:r}}n.image=i.uuid}return e||(t.textures[this.uuid]=n),n},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(t){if(this.mapping!==jp)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case Th:t.x=t.x-Math.floor(t.x);break;case zn:t.x=t.x<0?0:1;break;case Ph:Math.abs(Math.floor(t.x)%2)===1?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x);break}if(t.y<0||t.y>1)switch(this.wrapT){case Th:t.y=t.y-Math.floor(t.y);break;case zn:t.y=t.y<0?0:1;break;case Ph:Math.abs(Math.floor(t.y)%2)===1?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y);break}return this.flipY&&(t.y=1-t.y),t}});Object.defineProperty($t.prototype,"needsUpdate",{set:function(t){t===!0&&this.version++}});function Ft(t=0,e=0,n=0,i=1){this.x=t,this.y=e,this.z=n,this.w=i}Object.defineProperties(Ft.prototype,{width:{get:function(){return this.z},set:function(t){this.z=t}},height:{get:function(){return this.w},set:function(t){this.w=t}}});Object.assign(Ft.prototype,{isVector4:!0,set:function(t,e,n,i){return this.x=t,this.y=e,this.z=n,this.w=i,this},setScalar:function(t){return this.x=t,this.y=t,this.z=t,this.w=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},setW:function(t){return this.w=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w!==void 0?t.w:1,this},add:function(t,e){return e!==void 0?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this)},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this},sub:function(t,e){return e!==void 0?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this)},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},applyMatrix4:function(t){const e=this.x,n=this.y,i=this.z,r=this.w,s=t.elements;return this.x=s[0]*e+s[4]*n+s[8]*i+s[12]*r,this.y=s[1]*e+s[5]*n+s[9]*i+s[13]*r,this.z=s[2]*e+s[6]*n+s[10]*i+s[14]*r,this.w=s[3]*e+s[7]*n+s[11]*i+s[15]*r,this},divideScalar:function(t){return this.multiplyScalar(1/t)},setAxisAngleFromQuaternion:function(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this},setAxisAngleFromRotationMatrix:function(t){let e,n,i,r;const a=t.elements,c=a[0],l=a[4],h=a[8],u=a[1],f=a[5],d=a[9],p=a[2],y=a[6],g=a[10];if(Math.abs(l-u)<.01&&Math.abs(h-p)<.01&&Math.abs(d-y)<.01){if(Math.abs(l+u)<.1&&Math.abs(h+p)<.1&&Math.abs(d+y)<.1&&Math.abs(c+f+g-3)<.1)return this.set(1,0,0,0),this;e=Math.PI;const x=(c+1)/2,v=(f+1)/2,b=(g+1)/2,_=(l+u)/4,C=(h+p)/4,w=(d+y)/4;return x>v&&x>b?x<.01?(n=0,i=.707106781,r=.707106781):(n=Math.sqrt(x),i=_/n,r=C/n):v>b?v<.01?(n=.707106781,i=0,r=.707106781):(i=Math.sqrt(v),n=_/i,r=w/i):b<.01?(n=.707106781,i=.707106781,r=0):(r=Math.sqrt(b),n=C/r,i=w/r),this.set(n,i,r,e),this}let m=Math.sqrt((y-d)*(y-d)+(h-p)*(h-p)+(u-l)*(u-l));return Math.abs(m)<.001&&(m=1),this.x=(y-d)/m,this.y=(h-p)/m,this.z=(u-l)/m,this.w=Math.acos((c+f+g-1)/2),this},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this},clampScalar:function(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this},clampLength:function(t,e){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(t,Math.min(e,n)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this},lerpVectors:function(t,e,n){return this.x=t.x+(e.x-t.x)*n,this.y=t.y+(e.y-t.y)*n,this.z=t.z+(e.z-t.z)*n,this.w=t.w+(e.w-t.w)*n,this},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w},fromArray:function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},toArray:function(t,e){return t===void 0&&(t=[]),e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t},fromBufferAttribute:function(t,e,n){return n!==void 0&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this},random:function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}});function Rn(t,e,n){this.width=t,this.height=e,this.scissor=new Ft(0,0,t,e),this.scissorTest=!1,this.viewport=new Ft(0,0,t,e),n=n||{},this.texture=new $t(void 0,n.mapping,n.wrapS,n.wrapT,n.magFilter,n.minFilter,n.format,n.type,n.anisotropy,n.encoding),this.texture.image={},this.texture.image.width=t,this.texture.image.height=e,this.texture.generateMipmaps=n.generateMipmaps!==void 0?n.generateMipmaps:!1,this.texture.minFilter=n.minFilter!==void 0?n.minFilter:gn,this.depthBuffer=n.depthBuffer!==void 0?n.depthBuffer:!0,this.stencilBuffer=n.stencilBuffer!==void 0?n.stencilBuffer:!0,this.depthTexture=n.depthTexture!==void 0?n.depthTexture:null}Rn.prototype=Object.assign(Object.create(xr.prototype),{constructor:Rn,isWebGLRenderTarget:!0,setSize:function(t,e){(this.width!==t||this.height!==e)&&(this.width=t,this.height=e,this.texture.image.width=t,this.texture.image.height=e,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.width=t.width,this.height=t.height,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.depthTexture=t.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});function Ym(t,e,n){Rn.call(this,t,e,n),this.samples=4}Ym.prototype=Object.assign(Object.create(Rn.prototype),{constructor:Ym,isWebGLMultisampleRenderTarget:!0,copy:function(t){return Rn.prototype.copy.call(this,t),this.samples=t.samples,this}});function Gt(t=0,e=0,n=0,i=1){this._x=t,this._y=e,this._z=n,this._w=i}Object.assign(Gt,{slerp:function(t,e,n,i){return n.copy(t).slerp(e,i)},slerpFlat:function(t,e,n,i,r,s,o){let a=n[i+0],c=n[i+1],l=n[i+2],h=n[i+3];const u=r[s+0],f=r[s+1],d=r[s+2],p=r[s+3];if(h!==p||a!==u||c!==f||l!==d){let y=1-o,g=a*u+c*f+l*d+h*p,m=g>=0?1:-1,x=1-g*g;if(x>Number.EPSILON){const b=Math.sqrt(x),_=Math.atan2(b,g*m);y=Math.sin(y*_)/b,o=Math.sin(o*_)/b}const v=o*m;if(a=a*y+u*v,c=c*y+f*v,l=l*y+d*v,h=h*y+p*v,y===1-o){const b=1/Math.sqrt(a*a+c*c+l*l+h*h);a*=b,c*=b,l*=b,h*=b}}t[e]=a,t[e+1]=c,t[e+2]=l,t[e+3]=h},multiplyQuaternionsFlat:function(t,e,n,i,r,s){const o=n[i],a=n[i+1],c=n[i+2],l=n[i+3],h=r[s],u=r[s+1],f=r[s+2],d=r[s+3];return t[e]=o*d+l*h+a*f-c*u,t[e+1]=a*d+l*u+c*h-o*f,t[e+2]=c*d+l*f+o*u-a*h,t[e+3]=l*d-o*h-a*u-c*f,t}});Object.defineProperties(Gt.prototype,{x:{get:function(){return this._x},set:function(t){this._x=t,this._onChangeCallback()}},y:{get:function(){return this._y},set:function(t){this._y=t,this._onChangeCallback()}},z:{get:function(){return this._z},set:function(t){this._z=t,this._onChangeCallback()}},w:{get:function(){return this._w},set:function(t){this._w=t,this._onChangeCallback()}}});Object.assign(Gt.prototype,{isQuaternion:!0,set:function(t,e,n,i){return this._x=t,this._y=e,this._z=n,this._w=i,this._onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this},setFromEuler:function(t,e){if(!(t&&t.isEuler))throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const n=t._x,i=t._y,r=t._z,s=t.order,o=Math.cos,a=Math.sin,c=o(n/2),l=o(i/2),h=o(r/2),u=a(n/2),f=a(i/2),d=a(r/2);switch(s){case"XYZ":this._x=u*l*h+c*f*d,this._y=c*f*h-u*l*d,this._z=c*l*d+u*f*h,this._w=c*l*h-u*f*d;break;case"YXZ":this._x=u*l*h+c*f*d,this._y=c*f*h-u*l*d,this._z=c*l*d-u*f*h,this._w=c*l*h+u*f*d;break;case"ZXY":this._x=u*l*h-c*f*d,this._y=c*f*h+u*l*d,this._z=c*l*d+u*f*h,this._w=c*l*h-u*f*d;break;case"ZYX":this._x=u*l*h-c*f*d,this._y=c*f*h+u*l*d,this._z=c*l*d-u*f*h,this._w=c*l*h+u*f*d;break;case"YZX":this._x=u*l*h+c*f*d,this._y=c*f*h+u*l*d,this._z=c*l*d-u*f*h,this._w=c*l*h-u*f*d;break;case"XZY":this._x=u*l*h-c*f*d,this._y=c*f*h-u*l*d,this._z=c*l*d+u*f*h,this._w=c*l*h+u*f*d;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return e!==!1&&this._onChangeCallback(),this},setFromAxisAngle:function(t,e){const n=e/2,i=Math.sin(n);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(n),this._onChangeCallback(),this},setFromRotationMatrix:function(t){const e=t.elements,n=e[0],i=e[4],r=e[8],s=e[1],o=e[5],a=e[9],c=e[2],l=e[6],h=e[10],u=n+o+h;if(u>0){const f=.5/Math.sqrt(u+1);this._w=.25/f,this._x=(l-a)*f,this._y=(r-c)*f,this._z=(s-i)*f}else if(n>o&&n>h){const f=2*Math.sqrt(1+n-o-h);this._w=(l-a)/f,this._x=.25*f,this._y=(i+s)/f,this._z=(r+c)/f}else if(o>h){const f=2*Math.sqrt(1+o-n-h);this._w=(r-c)/f,this._x=(i+s)/f,this._y=.25*f,this._z=(a+l)/f}else{const f=2*Math.sqrt(1+h-n-o);this._w=(s-i)/f,this._x=(r+c)/f,this._y=(a+l)/f,this._z=.25*f}return this._onChangeCallback(),this},setFromUnitVectors:function(t,e){let i=t.dot(e)+1;return i<1e-6?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()},angleTo:function(t){return 2*Math.acos(Math.abs(ut.clamp(this.dot(t),-1,1)))},rotateTowards:function(t,e){const n=this.angleTo(t);if(n===0)return this;const i=Math.min(1,e/n);return this.slerp(t,i),this},inverse:function(){return this.conjugate()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this},dot:function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){let t=this.length();return t===0?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this},multiply:function(t,e){return e!==void 0?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)},premultiply:function(t){return this.multiplyQuaternions(t,this)},multiplyQuaternions:function(t,e){const n=t._x,i=t._y,r=t._z,s=t._w,o=e._x,a=e._y,c=e._z,l=e._w;return this._x=n*l+s*o+i*c-r*a,this._y=i*l+s*a+r*o-n*c,this._z=r*l+s*c+n*a-i*o,this._w=s*l-n*o-i*a-r*c,this._onChangeCallback(),this},slerp:function(t,e){if(e===0)return this;if(e===1)return this.copy(t);const n=this._x,i=this._y,r=this._z,s=this._w;let o=s*t._w+n*t._x+i*t._y+r*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=s,this._x=n,this._y=i,this._z=r,this;const a=1-o*o;if(a<=Number.EPSILON){const f=1-e;return this._w=f*s+e*this._w,this._x=f*n+e*this._x,this._y=f*i+e*this._y,this._z=f*r+e*this._z,this.normalize(),this._onChangeCallback(),this}const c=Math.sqrt(a),l=Math.atan2(c,o),h=Math.sin((1-e)*l)/c,u=Math.sin(e*l)/c;return this._w=s*h+this._w*u,this._x=n*h+this._x*u,this._y=i*h+this._y*u,this._z=r*h+this._z*u,this._onChangeCallback(),this},equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w},fromArray:function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this},toArray:function(t,e){return t===void 0&&(t=[]),e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t},fromBufferAttribute:function(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this},_onChange:function(t){return this._onChangeCallback=t,this},_onChangeCallback:function(){}});const Ku=new T,Zm=new Gt;function T(t=0,e=0,n=0){this.x=t,this.y=e,this.z=n}Object.assign(T.prototype,{isVector3:!0,set:function(t,e,n){return this.x=t,this.y=e,this.z=n,this},setScalar:function(t){return this.x=t,this.y=t,this.z=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},add:function(t,e){return e!==void 0?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},sub:function(t,e){return e!==void 0?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},multiply:function(t,e){return e!==void 0?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},multiplyVectors:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},applyEuler:function(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(Zm.setFromEuler(t))},applyAxisAngle:function(t,e){return this.applyQuaternion(Zm.setFromAxisAngle(t,e))},applyMatrix3:function(t){const e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6]*i,this.y=r[1]*e+r[4]*n+r[7]*i,this.z=r[2]*e+r[5]*n+r[8]*i,this},applyNormalMatrix:function(t){return this.applyMatrix3(t).normalize()},applyMatrix4:function(t){const e=this.x,n=this.y,i=this.z,r=t.elements,s=1/(r[3]*e+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*n+r[8]*i+r[12])*s,this.y=(r[1]*e+r[5]*n+r[9]*i+r[13])*s,this.z=(r[2]*e+r[6]*n+r[10]*i+r[14])*s,this},applyQuaternion:function(t){const e=this.x,n=this.y,i=this.z,r=t.x,s=t.y,o=t.z,a=t.w,c=a*e+s*i-o*n,l=a*n+o*e-r*i,h=a*i+r*n-s*e,u=-r*e-s*n-o*i;return this.x=c*a+u*-r+l*-o-h*-s,this.y=l*a+u*-s+h*-r-c*-o,this.z=h*a+u*-o+c*-s-l*-r,this},project:function(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)},unproject:function(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)},transformDirection:function(t){const e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i,this.y=r[1]*e+r[5]*n+r[9]*i,this.z=r[2]*e+r[6]*n+r[10]*i,this.normalize()},divide:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},divideScalar:function(t){return this.multiplyScalar(1/t)},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this},clampScalar:function(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this},clampLength:function(t,e){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(t,Math.min(e,n)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},lerpVectors:function(t,e,n){return this.x=t.x+(e.x-t.x)*n,this.y=t.y+(e.y-t.y)*n,this.z=t.z+(e.z-t.z)*n,this},cross:function(t,e){return e!==void 0?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)},crossVectors:function(t,e){const n=t.x,i=t.y,r=t.z,s=e.x,o=e.y,a=e.z;return this.x=i*a-r*o,this.y=r*s-n*a,this.z=n*o-i*s,this},projectOnVector:function(t){const e=t.lengthSq();if(e===0)return this.set(0,0,0);const n=t.dot(this)/e;return this.copy(t).multiplyScalar(n)},projectOnPlane:function(t){return Ku.copy(this).projectOnVector(t),this.sub(Ku)},reflect:function(t){return this.sub(Ku.copy(t).multiplyScalar(2*this.dot(t)))},angleTo:function(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(e===0)return Math.PI/2;const n=this.dot(t)/e;return Math.acos(ut.clamp(n,-1,1))},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){const e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i},manhattanDistanceTo:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)},setFromSpherical:function(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)},setFromSphericalCoords:function(t,e,n){const i=Math.sin(e)*t;return this.x=i*Math.sin(n),this.y=Math.cos(e)*t,this.z=i*Math.cos(n),this},setFromCylindrical:function(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)},setFromCylindricalCoords:function(t,e,n){return this.x=t*Math.sin(e),this.y=n,this.z=t*Math.cos(e),this},setFromMatrixPosition:function(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this},setFromMatrixScale:function(t){const e=this.setFromMatrixColumn(t,0).length(),n=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=n,this.z=i,this},setFromMatrixColumn:function(t,e){return this.fromArray(t.elements,e*4)},setFromMatrix3Column:function(t,e){return this.fromArray(t.elements,e*3)},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},fromArray:function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},toArray:function(t,e){return t===void 0&&(t=[]),e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t},fromBufferAttribute:function(t,e,n){return n!==void 0&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this},random:function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}});const ks=new T,hi=new Ie,D_=new T(0,0,0),B_=new T(1,1,1),Sr=new T,al=new T,Hn=new T;function Ie(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}Object.assign(Ie.prototype,{isMatrix4:!0,set:function(t,e,n,i,r,s,o,a,c,l,h,u,f,d,p,y){const g=this.elements;return g[0]=t,g[4]=e,g[8]=n,g[12]=i,g[1]=r,g[5]=s,g[9]=o,g[13]=a,g[2]=c,g[6]=l,g[10]=h,g[14]=u,g[3]=f,g[7]=d,g[11]=p,g[15]=y,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return new Ie().fromArray(this.elements)},copy:function(t){const e=this.elements,n=t.elements;return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],this},copyPosition:function(t){const e=this.elements,n=t.elements;return e[12]=n[12],e[13]=n[13],e[14]=n[14],this},extractBasis:function(t,e,n){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this},makeBasis:function(t,e,n){return this.set(t.x,e.x,n.x,0,t.y,e.y,n.y,0,t.z,e.z,n.z,0,0,0,0,1),this},extractRotation:function(t){const e=this.elements,n=t.elements,i=1/ks.setFromMatrixColumn(t,0).length(),r=1/ks.setFromMatrixColumn(t,1).length(),s=1/ks.setFromMatrixColumn(t,2).length();return e[0]=n[0]*i,e[1]=n[1]*i,e[2]=n[2]*i,e[3]=0,e[4]=n[4]*r,e[5]=n[5]*r,e[6]=n[6]*r,e[7]=0,e[8]=n[8]*s,e[9]=n[9]*s,e[10]=n[10]*s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},makeRotationFromEuler:function(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const e=this.elements,n=t.x,i=t.y,r=t.z,s=Math.cos(n),o=Math.sin(n),a=Math.cos(i),c=Math.sin(i),l=Math.cos(r),h=Math.sin(r);if(t.order==="XYZ"){const u=s*l,f=s*h,d=o*l,p=o*h;e[0]=a*l,e[4]=-a*h,e[8]=c,e[1]=f+d*c,e[5]=u-p*c,e[9]=-o*a,e[2]=p-u*c,e[6]=d+f*c,e[10]=s*a}else if(t.order==="YXZ"){const u=a*l,f=a*h,d=c*l,p=c*h;e[0]=u+p*o,e[4]=d*o-f,e[8]=s*c,e[1]=s*h,e[5]=s*l,e[9]=-o,e[2]=f*o-d,e[6]=p+u*o,e[10]=s*a}else if(t.order==="ZXY"){const u=a*l,f=a*h,d=c*l,p=c*h;e[0]=u-p*o,e[4]=-s*h,e[8]=d+f*o,e[1]=f+d*o,e[5]=s*l,e[9]=p-u*o,e[2]=-s*c,e[6]=o,e[10]=s*a}else if(t.order==="ZYX"){const u=s*l,f=s*h,d=o*l,p=o*h;e[0]=a*l,e[4]=d*c-f,e[8]=u*c+p,e[1]=a*h,e[5]=p*c+u,e[9]=f*c-d,e[2]=-c,e[6]=o*a,e[10]=s*a}else if(t.order==="YZX"){const u=s*a,f=s*c,d=o*a,p=o*c;e[0]=a*l,e[4]=p-u*h,e[8]=d*h+f,e[1]=h,e[5]=s*l,e[9]=-o*l,e[2]=-c*l,e[6]=f*h+d,e[10]=u-p*h}else if(t.order==="XZY"){const u=s*a,f=s*c,d=o*a,p=o*c;e[0]=a*l,e[4]=-h,e[8]=c*l,e[1]=u*h+p,e[5]=s*l,e[9]=f*h-d,e[2]=d*h-f,e[6]=o*l,e[10]=p*h+u}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},makeRotationFromQuaternion:function(t){return this.compose(D_,t,B_)},lookAt:function(t,e,n){const i=this.elements;return Hn.subVectors(t,e),Hn.lengthSq()===0&&(Hn.z=1),Hn.normalize(),Sr.crossVectors(n,Hn),Sr.lengthSq()===0&&(Math.abs(n.z)===1?Hn.x+=1e-4:Hn.z+=1e-4,Hn.normalize(),Sr.crossVectors(n,Hn)),Sr.normalize(),al.crossVectors(Hn,Sr),i[0]=Sr.x,i[4]=al.x,i[8]=Hn.x,i[1]=Sr.y,i[5]=al.y,i[9]=Hn.y,i[2]=Sr.z,i[6]=al.z,i[10]=Hn.z,this},multiply:function(t,e){return e!==void 0?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)},premultiply:function(t){return this.multiplyMatrices(t,this)},multiplyMatrices:function(t,e){const n=t.elements,i=e.elements,r=this.elements,s=n[0],o=n[4],a=n[8],c=n[12],l=n[1],h=n[5],u=n[9],f=n[13],d=n[2],p=n[6],y=n[10],g=n[14],m=n[3],x=n[7],v=n[11],b=n[15],_=i[0],C=i[4],w=i[8],S=i[12],M=i[1],B=i[5],L=i[9],U=i[13],E=i[2],O=i[6],k=i[10],ne=i[14],Y=i[3],F=i[7],te=i[11],ee=i[15];return r[0]=s*_+o*M+a*E+c*Y,r[4]=s*C+o*B+a*O+c*F,r[8]=s*w+o*L+a*k+c*te,r[12]=s*S+o*U+a*ne+c*ee,r[1]=l*_+h*M+u*E+f*Y,r[5]=l*C+h*B+u*O+f*F,r[9]=l*w+h*L+u*k+f*te,r[13]=l*S+h*U+u*ne+f*ee,r[2]=d*_+p*M+y*E+g*Y,r[6]=d*C+p*B+y*O+g*F,r[10]=d*w+p*L+y*k+g*te,r[14]=d*S+p*U+y*ne+g*ee,r[3]=m*_+x*M+v*E+b*Y,r[7]=m*C+x*B+v*O+b*F,r[11]=m*w+x*L+v*k+b*te,r[15]=m*S+x*U+v*ne+b*ee,this},multiplyScalar:function(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this},determinant:function(){const t=this.elements,e=t[0],n=t[4],i=t[8],r=t[12],s=t[1],o=t[5],a=t[9],c=t[13],l=t[2],h=t[6],u=t[10],f=t[14],d=t[3],p=t[7],y=t[11],g=t[15];return d*(+r*a*h-i*c*h-r*o*u+n*c*u+i*o*f-n*a*f)+p*(+e*a*f-e*c*u+r*s*u-i*s*f+i*c*l-r*a*l)+y*(+e*c*h-e*o*f-r*s*h+n*s*f+r*o*l-n*c*l)+g*(-i*o*l-e*a*h+e*o*u+i*s*h-n*s*u+n*a*l)},transpose:function(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},setPosition:function(t,e,n){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=n),this},getInverse:function(t,e){e!==void 0&&console.warn("THREE.Matrix4: .getInverse() can no longer be configured to throw on degenerate.");const n=this.elements,i=t.elements,r=i[0],s=i[1],o=i[2],a=i[3],c=i[4],l=i[5],h=i[6],u=i[7],f=i[8],d=i[9],p=i[10],y=i[11],g=i[12],m=i[13],x=i[14],v=i[15],b=d*x*u-m*p*u+m*h*y-l*x*y-d*h*v+l*p*v,_=g*p*u-f*x*u-g*h*y+c*x*y+f*h*v-c*p*v,C=f*m*u-g*d*u+g*l*y-c*m*y-f*l*v+c*d*v,w=g*d*h-f*m*h-g*l*p+c*m*p+f*l*x-c*d*x,S=r*b+s*_+o*C+a*w;if(S===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const M=1/S;return n[0]=b*M,n[1]=(m*p*a-d*x*a-m*o*y+s*x*y+d*o*v-s*p*v)*M,n[2]=(l*x*a-m*h*a+m*o*u-s*x*u-l*o*v+s*h*v)*M,n[3]=(d*h*a-l*p*a-d*o*u+s*p*u+l*o*y-s*h*y)*M,n[4]=_*M,n[5]=(f*x*a-g*p*a+g*o*y-r*x*y-f*o*v+r*p*v)*M,n[6]=(g*h*a-c*x*a-g*o*u+r*x*u+c*o*v-r*h*v)*M,n[7]=(c*p*a-f*h*a+f*o*u-r*p*u-c*o*y+r*h*y)*M,n[8]=C*M,n[9]=(g*d*a-f*m*a-g*s*y+r*m*y+f*s*v-r*d*v)*M,n[10]=(c*m*a-g*l*a+g*s*u-r*m*u-c*s*v+r*l*v)*M,n[11]=(f*l*a-c*d*a-f*s*u+r*d*u+c*s*y-r*l*y)*M,n[12]=w*M,n[13]=(f*m*o-g*d*o+g*s*p-r*m*p-f*s*x+r*d*x)*M,n[14]=(g*l*o-c*m*o-g*s*h+r*m*h+c*s*x-r*l*x)*M,n[15]=(c*d*o-f*l*o+f*s*h-r*d*h-c*s*p+r*l*p)*M,this},scale:function(t){const e=this.elements,n=t.x,i=t.y,r=t.z;return e[0]*=n,e[4]*=i,e[8]*=r,e[1]*=n,e[5]*=i,e[9]*=r,e[2]*=n,e[6]*=i,e[10]*=r,e[3]*=n,e[7]*=i,e[11]*=r,this},getMaxScaleOnAxis:function(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],n=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,n,i))},makeTranslation:function(t,e,n){return this.set(1,0,0,t,0,1,0,e,0,0,1,n,0,0,0,1),this},makeRotationX:function(t){const e=Math.cos(t),n=Math.sin(t);return this.set(1,0,0,0,0,e,-n,0,0,n,e,0,0,0,0,1),this},makeRotationY:function(t){const e=Math.cos(t),n=Math.sin(t);return this.set(e,0,n,0,0,1,0,0,-n,0,e,0,0,0,0,1),this},makeRotationZ:function(t){const e=Math.cos(t),n=Math.sin(t);return this.set(e,-n,0,0,n,e,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(t,e){const n=Math.cos(e),i=Math.sin(e),r=1-n,s=t.x,o=t.y,a=t.z,c=r*s,l=r*o;return this.set(c*s+n,c*o-i*a,c*a+i*o,0,c*o+i*a,l*o+n,l*a-i*s,0,c*a-i*o,l*a+i*s,r*a*a+n,0,0,0,0,1),this},makeScale:function(t,e,n){return this.set(t,0,0,0,0,e,0,0,0,0,n,0,0,0,0,1),this},makeShear:function(t,e,n){return this.set(1,e,n,0,t,1,n,0,t,e,1,0,0,0,0,1),this},compose:function(t,e,n){const i=this.elements,r=e._x,s=e._y,o=e._z,a=e._w,c=r+r,l=s+s,h=o+o,u=r*c,f=r*l,d=r*h,p=s*l,y=s*h,g=o*h,m=a*c,x=a*l,v=a*h,b=n.x,_=n.y,C=n.z;return i[0]=(1-(p+g))*b,i[1]=(f+v)*b,i[2]=(d-x)*b,i[3]=0,i[4]=(f-v)*_,i[5]=(1-(u+g))*_,i[6]=(y+m)*_,i[7]=0,i[8]=(d+x)*C,i[9]=(y-m)*C,i[10]=(1-(u+p))*C,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this},decompose:function(t,e,n){const i=this.elements;let r=ks.set(i[0],i[1],i[2]).length(),s=ks.set(i[4],i[5],i[6]).length(),o=ks.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),t.x=i[12],t.y=i[13],t.z=i[14],hi.copy(this);const c=1/r,l=1/s,h=1/o;return hi.elements[0]*=c,hi.elements[1]*=c,hi.elements[2]*=c,hi.elements[4]*=l,hi.elements[5]*=l,hi.elements[6]*=l,hi.elements[8]*=h,hi.elements[9]*=h,hi.elements[10]*=h,e.setFromRotationMatrix(hi),n.x=r,n.y=s,n.z=o,this},makePerspective:function(t,e,n,i,r,s){s===void 0&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const o=this.elements,a=2*r/(e-t),c=2*r/(n-i),l=(e+t)/(e-t),h=(n+i)/(n-i),u=-(s+r)/(s-r),f=-2*s*r/(s-r);return o[0]=a,o[4]=0,o[8]=l,o[12]=0,o[1]=0,o[5]=c,o[9]=h,o[13]=0,o[2]=0,o[6]=0,o[10]=u,o[14]=f,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},makeOrthographic:function(t,e,n,i,r,s){const o=this.elements,a=1/(e-t),c=1/(n-i),l=1/(s-r),h=(e+t)*a,u=(n+i)*c,f=(s+r)*l;return o[0]=2*a,o[4]=0,o[8]=0,o[12]=-h,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-u,o[2]=0,o[6]=0,o[10]=-2*l,o[14]=-f,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},equals:function(t){const e=this.elements,n=t.elements;for(let i=0;i<16;i++)if(e[i]!==n[i])return!1;return!0},fromArray:function(t,e){e===void 0&&(e=0);for(let n=0;n<16;n++)this.elements[n]=t[n+e];return this},toArray:function(t,e){t===void 0&&(t=[]),e===void 0&&(e=0);const n=this.elements;return t[e]=n[0],t[e+1]=n[1],t[e+2]=n[2],t[e+3]=n[3],t[e+4]=n[4],t[e+5]=n[5],t[e+6]=n[6],t[e+7]=n[7],t[e+8]=n[8],t[e+9]=n[9],t[e+10]=n[10],t[e+11]=n[11],t[e+12]=n[12],t[e+13]=n[13],t[e+14]=n[14],t[e+15]=n[15],t}});const Km=new Ie,Jm=new Gt;function Ur(t=0,e=0,n=0,i=Ur.DefaultOrder){this._x=t,this._y=e,this._z=n,this._order=i}Ur.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];Ur.DefaultOrder="XYZ";Object.defineProperties(Ur.prototype,{x:{get:function(){return this._x},set:function(t){this._x=t,this._onChangeCallback()}},y:{get:function(){return this._y},set:function(t){this._y=t,this._onChangeCallback()}},z:{get:function(){return this._z},set:function(t){this._z=t,this._onChangeCallback()}},order:{get:function(){return this._order},set:function(t){this._order=t,this._onChangeCallback()}}});Object.assign(Ur.prototype,{isEuler:!0,set:function(t,e,n,i){return this._x=t,this._y=e,this._z=n,this._order=i||this._order,this._onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this},setFromRotationMatrix:function(t,e,n){const i=ut.clamp,r=t.elements,s=r[0],o=r[4],a=r[8],c=r[1],l=r[5],h=r[9],u=r[2],f=r[6],d=r[10];switch(e=e||this._order,e){case"XYZ":this._y=Math.asin(i(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-h,d),this._z=Math.atan2(-o,s)):(this._x=Math.atan2(f,l),this._z=0);break;case"YXZ":this._x=Math.asin(-i(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(c,l)):(this._y=Math.atan2(-u,s),this._z=0);break;case"ZXY":this._x=Math.asin(i(f,-1,1)),Math.abs(f)<.9999999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-o,l)):(this._y=0,this._z=Math.atan2(c,s));break;case"ZYX":this._y=Math.asin(-i(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(f,d),this._z=Math.atan2(c,s)):(this._x=0,this._z=Math.atan2(-o,l));break;case"YZX":this._z=Math.asin(i(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-u,s)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-i(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(f,l),this._y=Math.atan2(a,s)):(this._x=Math.atan2(-h,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,n!==!1&&this._onChangeCallback(),this},setFromQuaternion:function(t,e,n){return Km.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Km,e,n)},setFromVector3:function(t,e){return this.set(t.x,t.y,t.z,e||this._order)},reorder:function(t){return Jm.setFromEuler(this),this.setFromQuaternion(Jm,t)},equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order},fromArray:function(t){return this._x=t[0],this._y=t[1],this._z=t[2],t[3]!==void 0&&(this._order=t[3]),this._onChangeCallback(),this},toArray:function(t,e){return t===void 0&&(t=[]),e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t},toVector3:function(t){return t?t.set(this._x,this._y,this._z):new T(this._x,this._y,this._z)},_onChange:function(t){return this._onChangeCallback=t,this},_onChangeCallback:function(){}});function em(){this.mask=1}Object.assign(em.prototype,{set:function(t){this.mask=1<<t|0},enable:function(t){this.mask|=1<<t|0},enableAll:function(){this.mask=-1},toggle:function(t){this.mask^=1<<t|0},disable:function(t){this.mask&=~(1<<t|0)},disableAll:function(){this.mask=0},test:function(t){return(this.mask&t.mask)!==0}});let O_=0;const Qm=new T,Fs=new Gt,qi=new Ie,cl=new T,_a=new T,k_=new T,F_=new Gt,eg=new T(1,0,0),tg=new T(0,1,0),ng=new T(0,0,1),N_={type:"added"},z_={type:"removed"};function $e(){Object.defineProperty(this,"id",{value:O_++}),this.uuid=ut.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=$e.DefaultUp.clone();const t=new T,e=new Ur,n=new Gt,i=new T(1,1,1);function r(){n.setFromEuler(e,!1)}function s(){e.setFromQuaternion(n,void 0,!1)}e._onChange(r),n._onChange(s),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new Ie},normalMatrix:{value:new An}}),this.matrix=new Ie,this.matrixWorld=new Ie,this.matrixAutoUpdate=$e.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new em,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}$e.DefaultUp=new T(0,1,0);$e.DefaultMatrixAutoUpdate=!0;$e.prototype=Object.assign(Object.create(xr.prototype),{constructor:$e,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix4:function(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(t){return this.quaternion.premultiply(t),this},setRotationFromAxisAngle:function(t,e){this.quaternion.setFromAxisAngle(t,e)},setRotationFromEuler:function(t){this.quaternion.setFromEuler(t,!0)},setRotationFromMatrix:function(t){this.quaternion.setFromRotationMatrix(t)},setRotationFromQuaternion:function(t){this.quaternion.copy(t)},rotateOnAxis:function(t,e){return Fs.setFromAxisAngle(t,e),this.quaternion.multiply(Fs),this},rotateOnWorldAxis:function(t,e){return Fs.setFromAxisAngle(t,e),this.quaternion.premultiply(Fs),this},rotateX:function(t){return this.rotateOnAxis(eg,t)},rotateY:function(t){return this.rotateOnAxis(tg,t)},rotateZ:function(t){return this.rotateOnAxis(ng,t)},translateOnAxis:function(t,e){return Qm.copy(t).applyQuaternion(this.quaternion),this.position.add(Qm.multiplyScalar(e)),this},translateX:function(t){return this.translateOnAxis(eg,t)},translateY:function(t){return this.translateOnAxis(tg,t)},translateZ:function(t){return this.translateOnAxis(ng,t)},localToWorld:function(t){return t.applyMatrix4(this.matrixWorld)},worldToLocal:function(t){return t.applyMatrix4(qi.getInverse(this.matrixWorld))},lookAt:function(t,e,n){t.isVector3?cl.copy(t):cl.set(t,e,n);const i=this.parent;this.updateWorldMatrix(!0,!1),_a.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?qi.lookAt(_a,cl,this.up):qi.lookAt(cl,_a,this.up),this.quaternion.setFromRotationMatrix(qi),i&&(qi.extractRotation(i.matrixWorld),Fs.setFromRotationMatrix(qi),this.quaternion.premultiply(Fs.inverse()))},add:function(t){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.parent!==null&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(N_)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)},remove:function(t){if(arguments.length>1){for(let n=0;n<arguments.length;n++)this.remove(arguments[n]);return this}const e=this.children.indexOf(t);return e!==-1&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(z_)),this},attach:function(t){return this.updateWorldMatrix(!0,!1),qi.getInverse(this.matrixWorld),t.parent!==null&&(t.parent.updateWorldMatrix(!0,!1),qi.multiply(t.parent.matrixWorld)),t.applyMatrix4(qi),t.updateWorldMatrix(!1,!1),this.add(t),this},getObjectById:function(t){return this.getObjectByProperty("id",t)},getObjectByName:function(t){return this.getObjectByProperty("name",t)},getObjectByProperty:function(t,e){if(this[t]===e)return this;for(let n=0,i=this.children.length;n<i;n++){const s=this.children[n].getObjectByProperty(t,e);if(s!==void 0)return s}},getWorldPosition:function(t){return t===void 0&&(console.warn("THREE.Object3D: .getWorldPosition() target is now required"),t=new T),this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(t){return t===void 0&&(console.warn("THREE.Object3D: .getWorldQuaternion() target is now required"),t=new Gt),this.updateMatrixWorld(!0),this.matrixWorld.decompose(_a,t,k_),t},getWorldScale:function(t){return t===void 0&&(console.warn("THREE.Object3D: .getWorldScale() target is now required"),t=new T),this.updateMatrixWorld(!0),this.matrixWorld.decompose(_a,F_,t),t},getWorldDirection:function(t){t===void 0&&(console.warn("THREE.Object3D: .getWorldDirection() target is now required"),t=new T),this.updateMatrixWorld(!0);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()},raycast:function(){},traverse:function(t){t(this);const e=this.children;for(let n=0,i=e.length;n<i;n++)e[n].traverse(t)},traverseVisible:function(t){if(this.visible===!1)return;t(this);const e=this.children;for(let n=0,i=e.length;n<i;n++)e[n].traverseVisible(t)},traverseAncestors:function(t){const e=this.parent;e!==null&&(t(e),e.traverseAncestors(t))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let n=0,i=e.length;n<i;n++)e[n].updateMatrixWorld(t)},updateWorldMatrix:function(t,e){const n=this.parent;if(t===!0&&n!==null&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),e===!0){const i=this.children;for(let r=0,s=i.length;r<s;r++)i[r].updateWorldMatrix(!1,!0)}},toJSON:function(t){const e=t===void 0||typeof t=="string",n={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{}},n.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const i={};i.uuid=this.uuid,i.type=this.type,this.name!==""&&(i.name=this.name),this.castShadow===!0&&(i.castShadow=!0),this.receiveShadow===!0&&(i.receiveShadow=!0),this.visible===!1&&(i.visible=!1),this.frustumCulled===!1&&(i.frustumCulled=!1),this.renderOrder!==0&&(i.renderOrder=this.renderOrder),JSON.stringify(this.userData)!=="{}"&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),this.matrixAutoUpdate===!1&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON());function r(o,a){return o[a.uuid]===void 0&&(o[a.uuid]=a.toJSON(t)),a.uuid}if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(t.geometries,this.geometry);const o=this.geometry.parameters;if(o!==void 0&&o.shapes!==void 0){const a=o.shapes;if(Array.isArray(a))for(let c=0,l=a.length;c<l;c++){const h=a[c];r(t.shapes,h)}else r(t.shapes,a)}}if(this.material!==void 0)if(Array.isArray(this.material)){const o=[];for(let a=0,c=this.material.length;a<c;a++)o.push(r(t.materials,this.material[a]));i.material=o}else i.material=r(t.materials,this.material);if(this.children.length>0){i.children=[];for(let o=0;o<this.children.length;o++)i.children.push(this.children[o].toJSON(t).object)}if(e){const o=s(t.geometries),a=s(t.materials),c=s(t.textures),l=s(t.images),h=s(t.shapes);o.length>0&&(n.geometries=o),a.length>0&&(n.materials=a),c.length>0&&(n.textures=c),l.length>0&&(n.images=l),h.length>0&&(n.shapes=h)}return n.object=i,n;function s(o){const a=[];for(const c in o){const l=o[c];delete l.metadata,a.push(l)}return a}},clone:function(t){return new this.constructor().copy(this,t)},copy:function(t,e){if(e===void 0&&(e=!0),this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),e===!0)for(let n=0;n<t.children.length;n++){const i=t.children[n];this.add(i.clone())}return this}});function Mo(){$e.call(this),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}Mo.prototype=Object.assign(Object.create($e.prototype),{constructor:Mo,isScene:!0,copy:function(t,e){return $e.prototype.copy.call(this,t,e),t.background!==null&&(this.background=t.background.clone()),t.environment!==null&&(this.environment=t.environment.clone()),t.fog!==null&&(this.fog=t.fog.clone()),t.overrideMaterial!==null&&(this.overrideMaterial=t.overrideMaterial.clone()),this.autoUpdate=t.autoUpdate,this.matrixAutoUpdate=t.matrixAutoUpdate,this},toJSON:function(t){const e=$e.prototype.toJSON.call(this,t);return this.background!==null&&(e.object.background=this.background.toJSON(t)),this.environment!==null&&(e.object.environment=this.environment.toJSON(t)),this.fog!==null&&(e.object.fog=this.fog.toJSON()),e},dispose:function(){this.dispatchEvent({type:"dispose"})}});const Xi=[new T,new T,new T,new T,new T,new T,new T,new T],wa=new T,Ju=new Ut,Ns=new T,zs=new T,Gs=new T,Mr=new T,Ar=new T,Qr=new T,Sa=new T,ll=new T,hl=new T,es=new T;function Ut(t,e){this.min=t!==void 0?t:new T(1/0,1/0,1/0),this.max=e!==void 0?e:new T(-1/0,-1/0,-1/0)}Object.assign(Ut.prototype,{isBox3:!0,set:function(t,e){return this.min.copy(t),this.max.copy(e),this},setFromArray:function(t){let e=1/0,n=1/0,i=1/0,r=-1/0,s=-1/0,o=-1/0;for(let a=0,c=t.length;a<c;a+=3){const l=t[a],h=t[a+1],u=t[a+2];l<e&&(e=l),h<n&&(n=h),u<i&&(i=u),l>r&&(r=l),h>s&&(s=h),u>o&&(o=u)}return this.min.set(e,n,i),this.max.set(r,s,o),this},setFromBufferAttribute:function(t){let e=1/0,n=1/0,i=1/0,r=-1/0,s=-1/0,o=-1/0;for(let a=0,c=t.count;a<c;a++){const l=t.getX(a),h=t.getY(a),u=t.getZ(a);l<e&&(e=l),h<n&&(n=h),u<i&&(i=u),l>r&&(r=l),h>s&&(s=h),u>o&&(o=u)}return this.min.set(e,n,i),this.max.set(r,s,o),this},setFromPoints:function(t){this.makeEmpty();for(let e=0,n=t.length;e<n;e++)this.expandByPoint(t[e]);return this},setFromCenterAndSize:function(t,e){const n=wa.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this},setFromObject:function(t){return this.makeEmpty(),this.expandByObject(t)},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.min.copy(t.min),this.max.copy(t.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(t){return t===void 0&&(console.warn("THREE.Box3: .getCenter() target is now required"),t=new T),this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(t){return t===void 0&&(console.warn("THREE.Box3: .getSize() target is now required"),t=new T),this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(t){return this.min.min(t),this.max.max(t),this},expandByVector:function(t){return this.min.sub(t),this.max.add(t),this},expandByScalar:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this},expandByObject:function(t){t.updateWorldMatrix(!1,!1);const e=t.geometry;e!==void 0&&(e.boundingBox===null&&e.computeBoundingBox(),Ju.copy(e.boundingBox),Ju.applyMatrix4(t.matrixWorld),this.union(Ju));const n=t.children;for(let i=0,r=n.length;i<r;i++)this.expandByObject(n[i]);return this},containsPoint:function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)},containsBox:function(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z},getParameter:function(t,e){return e===void 0&&(console.warn("THREE.Box3: .getParameter() target is now required"),e=new T),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)},intersectsSphere:function(t){return this.clampPoint(t.center,wa),wa.distanceToSquared(t.center)<=t.radius*t.radius},intersectsPlane:function(t){let e,n;return t.normal.x>0?(e=t.normal.x*this.min.x,n=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,n=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,n+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,n+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,n+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,n+=t.normal.z*this.min.z),e<=-t.constant&&n>=-t.constant},intersectsTriangle:function(t){if(this.isEmpty())return!1;this.getCenter(Sa),ll.subVectors(this.max,Sa),Ns.subVectors(t.a,Sa),zs.subVectors(t.b,Sa),Gs.subVectors(t.c,Sa),Mr.subVectors(zs,Ns),Ar.subVectors(Gs,zs),Qr.subVectors(Ns,Gs);let e=[0,-Mr.z,Mr.y,0,-Ar.z,Ar.y,0,-Qr.z,Qr.y,Mr.z,0,-Mr.x,Ar.z,0,-Ar.x,Qr.z,0,-Qr.x,-Mr.y,Mr.x,0,-Ar.y,Ar.x,0,-Qr.y,Qr.x,0];return!Qu(e,Ns,zs,Gs,ll)||(e=[1,0,0,0,1,0,0,0,1],!Qu(e,Ns,zs,Gs,ll))?!1:(hl.crossVectors(Mr,Ar),e=[hl.x,hl.y,hl.z],Qu(e,Ns,zs,Gs,ll))},clampPoint:function(t,e){return e===void 0&&(console.warn("THREE.Box3: .clampPoint() target is now required"),e=new T),e.copy(t).clamp(this.min,this.max)},distanceToPoint:function(t){return wa.copy(t).clamp(this.min,this.max).sub(t).length()},getBoundingSphere:function(t){return t===void 0&&console.error("THREE.Box3: .getBoundingSphere() target is now required"),this.getCenter(t.center),t.radius=this.getSize(wa).length()*.5,t},intersect:function(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this},union:function(t){return this.min.min(t.min),this.max.max(t.max),this},applyMatrix4:function(t){return this.isEmpty()?this:(Xi[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),Xi[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),Xi[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),Xi[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),Xi[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),Xi[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),Xi[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),Xi[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(Xi),this)},translate:function(t){return this.min.add(t),this.max.add(t),this},equals:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}});function Qu(t,e,n,i,r){for(let s=0,o=t.length-3;s<=o;s+=3){es.fromArray(t,s);const a=r.x*Math.abs(es.x)+r.y*Math.abs(es.y)+r.z*Math.abs(es.z),c=e.dot(es),l=n.dot(es),h=i.dot(es);if(Math.max(-Math.max(c,l,h),Math.min(c,l,h))>a)return!1}return!0}const G_=new Ut;function br(t,e){this.center=t!==void 0?t:new T,this.radius=e!==void 0?e:-1}Object.assign(br.prototype,{set:function(t,e){return this.center.copy(t),this.radius=e,this},setFromPoints:function(t,e){const n=this.center;e!==void 0?n.copy(e):G_.setFromPoints(t).getCenter(n);let i=0;for(let r=0,s=t.length;r<s;r++)i=Math.max(i,n.distanceToSquared(t[r]));return this.radius=Math.sqrt(i),this},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.center.copy(t.center),this.radius=t.radius,this},isEmpty:function(){return this.radius<0},makeEmpty:function(){return this.center.set(0,0,0),this.radius=-1,this},containsPoint:function(t){return t.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(t){return t.distanceTo(this.center)-this.radius},intersectsSphere:function(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e},intersectsBox:function(t){return t.intersectsSphere(this)},intersectsPlane:function(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius},clampPoint:function(t,e){const n=this.center.distanceToSquared(t);return e===void 0&&(console.warn("THREE.Sphere: .clampPoint() target is now required"),e=new T),e.copy(t),n>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e},getBoundingBox:function(t){return t===void 0&&(console.warn("THREE.Sphere: .getBoundingBox() target is now required"),t=new Ut),this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)},applyMatrix4:function(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this},translate:function(t){return this.center.add(t),this},equals:function(t){return t.center.equals(this.center)&&t.radius===this.radius}});const Yi=new T,ed=new T,ul=new T,Cr=new T,td=new T,dl=new T,nd=new T;function Ko(t,e){this.origin=t!==void 0?t:new T,this.direction=e!==void 0?e:new T(0,0,-1)}Object.assign(Ko.prototype,{set:function(t,e){return this.origin.copy(t),this.direction.copy(e),this},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this},at:function(t,e){return e===void 0&&(console.warn("THREE.Ray: .at() target is now required"),e=new T),e.copy(this.direction).multiplyScalar(t).add(this.origin)},lookAt:function(t){return this.direction.copy(t).sub(this.origin).normalize(),this},recast:function(t){return this.origin.copy(this.at(t,Yi)),this},closestPointToPoint:function(t,e){e===void 0&&(console.warn("THREE.Ray: .closestPointToPoint() target is now required"),e=new T),e.subVectors(t,this.origin);const n=e.dot(this.direction);return n<0?e.copy(this.origin):e.copy(this.direction).multiplyScalar(n).add(this.origin)},distanceToPoint:function(t){return Math.sqrt(this.distanceSqToPoint(t))},distanceSqToPoint:function(t){const e=Yi.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Yi.copy(this.direction).multiplyScalar(e).add(this.origin),Yi.distanceToSquared(t))},distanceSqToSegment:function(t,e,n,i){ed.copy(t).add(e).multiplyScalar(.5),ul.copy(e).sub(t).normalize(),Cr.copy(this.origin).sub(ed);const r=t.distanceTo(e)*.5,s=-this.direction.dot(ul),o=Cr.dot(this.direction),a=-Cr.dot(ul),c=Cr.lengthSq(),l=Math.abs(1-s*s);let h,u,f,d;if(l>0)if(h=s*a-o,u=s*o-a,d=r*l,h>=0)if(u>=-d)if(u<=d){const p=1/l;h*=p,u*=p,f=h*(h+s*u+2*o)+u*(s*h+u+2*a)+c}else u=r,h=Math.max(0,-(s*u+o)),f=-h*h+u*(u+2*a)+c;else u=-r,h=Math.max(0,-(s*u+o)),f=-h*h+u*(u+2*a)+c;else u<=-d?(h=Math.max(0,-(-s*r+o)),u=h>0?-r:Math.min(Math.max(-r,-a),r),f=-h*h+u*(u+2*a)+c):u<=d?(h=0,u=Math.min(Math.max(-r,-a),r),f=u*(u+2*a)+c):(h=Math.max(0,-(s*r+o)),u=h>0?r:Math.min(Math.max(-r,-a),r),f=-h*h+u*(u+2*a)+c);else u=s>0?-r:r,h=Math.max(0,-(s*u+o)),f=-h*h+u*(u+2*a)+c;return n&&n.copy(this.direction).multiplyScalar(h).add(this.origin),i&&i.copy(ul).multiplyScalar(u).add(ed),f},intersectSphere:function(t,e){Yi.subVectors(t.center,this.origin);const n=Yi.dot(this.direction),i=Yi.dot(Yi)-n*n,r=t.radius*t.radius;if(i>r)return null;const s=Math.sqrt(r-i),o=n-s,a=n+s;return o<0&&a<0?null:o<0?this.at(a,e):this.at(o,e)},intersectsSphere:function(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius},distanceToPlane:function(t){const e=t.normal.dot(this.direction);if(e===0)return t.distanceToPoint(this.origin)===0?0:null;const n=-(this.origin.dot(t.normal)+t.constant)/e;return n>=0?n:null},intersectPlane:function(t,e){const n=this.distanceToPlane(t);return n===null?null:this.at(n,e)},intersectsPlane:function(t){const e=t.distanceToPoint(this.origin);return e===0||t.normal.dot(this.direction)*e<0},intersectBox:function(t,e){let n,i,r,s,o,a;const c=1/this.direction.x,l=1/this.direction.y,h=1/this.direction.z,u=this.origin;return c>=0?(n=(t.min.x-u.x)*c,i=(t.max.x-u.x)*c):(n=(t.max.x-u.x)*c,i=(t.min.x-u.x)*c),l>=0?(r=(t.min.y-u.y)*l,s=(t.max.y-u.y)*l):(r=(t.max.y-u.y)*l,s=(t.min.y-u.y)*l),n>s||r>i||((r>n||n!==n)&&(n=r),(s<i||i!==i)&&(i=s),h>=0?(o=(t.min.z-u.z)*h,a=(t.max.z-u.z)*h):(o=(t.max.z-u.z)*h,a=(t.min.z-u.z)*h),n>a||o>i)||((o>n||n!==n)&&(n=o),(a<i||i!==i)&&(i=a),i<0)?null:this.at(n>=0?n:i,e)},intersectsBox:function(t){return this.intersectBox(t,Yi)!==null},intersectTriangle:function(t,e,n,i,r){td.subVectors(e,t),dl.subVectors(n,t),nd.crossVectors(td,dl);let s=this.direction.dot(nd),o;if(s>0){if(i)return null;o=1}else if(s<0)o=-1,s=-s;else return null;Cr.subVectors(this.origin,t);const a=o*this.direction.dot(dl.crossVectors(Cr,dl));if(a<0)return null;const c=o*this.direction.dot(td.cross(Cr));if(c<0||a+c>s)return null;const l=-o*Cr.dot(nd);return l<0?null:this.at(l/s,r)},applyMatrix4:function(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this},equals:function(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}});const id=new T,U_=new T,V_=new An;function Ri(t,e){this.normal=t!==void 0?t:new T(1,0,0),this.constant=e!==void 0?e:0}Object.assign(Ri.prototype,{isPlane:!0,set:function(t,e){return this.normal.copy(t),this.constant=e,this},setComponents:function(t,e,n,i){return this.normal.set(t,e,n),this.constant=i,this},setFromNormalAndCoplanarPoint:function(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this},setFromCoplanarPoints:function(t,e,n){const i=id.subVectors(n,e).cross(U_.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(i,t),this},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.normal.copy(t.normal),this.constant=t.constant,this},normalize:function(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(t){return this.normal.dot(t)+this.constant},distanceToSphere:function(t){return this.distanceToPoint(t.center)-t.radius},projectPoint:function(t,e){return e===void 0&&(console.warn("THREE.Plane: .projectPoint() target is now required"),e=new T),e.copy(this.normal).multiplyScalar(-this.distanceToPoint(t)).add(t)},intersectLine:function(t,e){e===void 0&&(console.warn("THREE.Plane: .intersectLine() target is now required"),e=new T);const n=t.delta(id),i=this.normal.dot(n);if(i===0)return this.distanceToPoint(t.start)===0?e.copy(t.start):void 0;const r=-(t.start.dot(this.normal)+this.constant)/i;if(!(r<0||r>1))return e.copy(n).multiplyScalar(r).add(t.start)},intersectsLine:function(t){const e=this.distanceToPoint(t.start),n=this.distanceToPoint(t.end);return e<0&&n>0||n<0&&e>0},intersectsBox:function(t){return t.intersectsPlane(this)},intersectsSphere:function(t){return t.intersectsPlane(this)},coplanarPoint:function(t){return t===void 0&&(console.warn("THREE.Plane: .coplanarPoint() target is now required"),t=new T),t.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(t,e){const n=e||V_.getNormalMatrix(t),i=this.coplanarPoint(id).applyMatrix4(t),r=this.normal.applyMatrix3(n).normalize();return this.constant=-i.dot(r),this},translate:function(t){return this.constant-=t.dot(this.normal),this},equals:function(t){return t.normal.equals(this.normal)&&t.constant===this.constant}});const mi=new T,tr=new T,rd=new T,Zi=new T,Us=new T,Vs=new T,ig=new T,sd=new T,od=new T,ad=new T;function Mn(t,e,n){this.a=t!==void 0?t:new T,this.b=e!==void 0?e:new T,this.c=n!==void 0?n:new T}Object.assign(Mn,{getNormal:function(t,e,n,i){i===void 0&&(console.warn("THREE.Triangle: .getNormal() target is now required"),i=new T),i.subVectors(n,e),mi.subVectors(t,e),i.cross(mi);const r=i.lengthSq();return r>0?i.multiplyScalar(1/Math.sqrt(r)):i.set(0,0,0)},getBarycoord:function(t,e,n,i,r){mi.subVectors(i,e),tr.subVectors(n,e),rd.subVectors(t,e);const s=mi.dot(mi),o=mi.dot(tr),a=mi.dot(rd),c=tr.dot(tr),l=tr.dot(rd),h=s*c-o*o;if(r===void 0&&(console.warn("THREE.Triangle: .getBarycoord() target is now required"),r=new T),h===0)return r.set(-2,-1,-1);const u=1/h,f=(c*a-o*l)*u,d=(s*l-o*a)*u;return r.set(1-f-d,d,f)},containsPoint:function(t,e,n,i){return Mn.getBarycoord(t,e,n,i,Zi),Zi.x>=0&&Zi.y>=0&&Zi.x+Zi.y<=1},getUV:function(t,e,n,i,r,s,o,a){return this.getBarycoord(t,e,n,i,Zi),a.set(0,0),a.addScaledVector(r,Zi.x),a.addScaledVector(s,Zi.y),a.addScaledVector(o,Zi.z),a},isFrontFacing:function(t,e,n,i){return mi.subVectors(n,e),tr.subVectors(t,e),mi.cross(tr).dot(i)<0}});Object.assign(Mn.prototype,{set:function(t,e,n){return this.a.copy(t),this.b.copy(e),this.c.copy(n),this},setFromPointsAndIndices:function(t,e,n,i){return this.a.copy(t[e]),this.b.copy(t[n]),this.c.copy(t[i]),this},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this},getArea:function(){return mi.subVectors(this.c,this.b),tr.subVectors(this.a,this.b),mi.cross(tr).length()*.5},getMidpoint:function(t){return t===void 0&&(console.warn("THREE.Triangle: .getMidpoint() target is now required"),t=new T),t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},getNormal:function(t){return Mn.getNormal(this.a,this.b,this.c,t)},getPlane:function(t){return t===void 0&&(console.warn("THREE.Triangle: .getPlane() target is now required"),t=new Ri),t.setFromCoplanarPoints(this.a,this.b,this.c)},getBarycoord:function(t,e){return Mn.getBarycoord(t,this.a,this.b,this.c,e)},getUV:function(t,e,n,i,r){return Mn.getUV(t,this.a,this.b,this.c,e,n,i,r)},containsPoint:function(t){return Mn.containsPoint(t,this.a,this.b,this.c)},isFrontFacing:function(t){return Mn.isFrontFacing(this.a,this.b,this.c,t)},intersectsBox:function(t){return t.intersectsTriangle(this)},closestPointToPoint:function(t,e){e===void 0&&(console.warn("THREE.Triangle: .closestPointToPoint() target is now required"),e=new T);const n=this.a,i=this.b,r=this.c;let s,o;Us.subVectors(i,n),Vs.subVectors(r,n),sd.subVectors(t,n);const a=Us.dot(sd),c=Vs.dot(sd);if(a<=0&&c<=0)return e.copy(n);od.subVectors(t,i);const l=Us.dot(od),h=Vs.dot(od);if(l>=0&&h<=l)return e.copy(i);const u=a*h-l*c;if(u<=0&&a>=0&&l<=0)return s=a/(a-l),e.copy(n).addScaledVector(Us,s);ad.subVectors(t,r);const f=Us.dot(ad),d=Vs.dot(ad);if(d>=0&&f<=d)return e.copy(r);const p=f*c-a*d;if(p<=0&&c>=0&&d<=0)return o=c/(c-d),e.copy(n).addScaledVector(Vs,o);const y=l*d-f*h;if(y<=0&&h-l>=0&&f-d>=0)return ig.subVectors(r,i),o=(h-l)/(h-l+(f-d)),e.copy(i).addScaledVector(ig,o);const g=1/(y+p+u);return s=p*g,o=u*g,e.copy(n).addScaledVector(Us,s).addScaledVector(Vs,o)},equals:function(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}});const Ny={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},ui={h:0,s:0,l:0},fl={h:0,s:0,l:0};function ke(t,e,n){return e===void 0&&n===void 0?this.set(t):this.setRGB(t,e,n)}function cd(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+(e-t)*6*n:n<1/2?e:n<2/3?t+(e-t)*6*(2/3-n):t}function ld(t){return t<.04045?t*.0773993808:Math.pow(t*.9478672986+.0521327014,2.4)}function hd(t){return t<.0031308?t*12.92:1.055*Math.pow(t,.41666)-.055}Object.assign(ke.prototype,{isColor:!0,r:1,g:1,b:1,set:function(t){return t&&t.isColor?this.copy(t):typeof t=="number"?this.setHex(t):typeof t=="string"&&this.setStyle(t),this},setScalar:function(t){return this.r=t,this.g=t,this.b=t,this},setHex:function(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(t&255)/255,this},setRGB:function(t,e,n){return this.r=t,this.g=e,this.b=n,this},setHSL:function(t,e,n){if(t=ut.euclideanModulo(t,1),e=ut.clamp(e,0,1),n=ut.clamp(n,0,1),e===0)this.r=this.g=this.b=n;else{const i=n<=.5?n*(1+e):n+e-n*e,r=2*n-i;this.r=cd(r,i,t+1/3),this.g=cd(r,i,t),this.b=cd(r,i,t-1/3)}return this},setStyle:function(t){function e(i){i!==void 0&&parseFloat(i)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let n;if(n=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(t)){let i;const r=n[1],s=n[2];switch(r){case"rgb":case"rgba":if(i=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(s))return this.r=Math.min(255,parseInt(i[1],10))/255,this.g=Math.min(255,parseInt(i[2],10))/255,this.b=Math.min(255,parseInt(i[3],10))/255,e(i[5]),this;if(i=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(s))return this.r=Math.min(100,parseInt(i[1],10))/100,this.g=Math.min(100,parseInt(i[2],10))/100,this.b=Math.min(100,parseInt(i[3],10))/100,e(i[5]),this;break;case"hsl":case"hsla":if(i=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(s)){const o=parseFloat(i[1])/360,a=parseInt(i[2],10)/100,c=parseInt(i[3],10)/100;return e(i[5]),this.setHSL(o,a,c)}break}}else if(n=/^\#([A-Fa-f0-9]+)$/.exec(t)){const i=n[1],r=i.length;if(r===3)return this.r=parseInt(i.charAt(0)+i.charAt(0),16)/255,this.g=parseInt(i.charAt(1)+i.charAt(1),16)/255,this.b=parseInt(i.charAt(2)+i.charAt(2),16)/255,this;if(r===6)return this.r=parseInt(i.charAt(0)+i.charAt(1),16)/255,this.g=parseInt(i.charAt(2)+i.charAt(3),16)/255,this.b=parseInt(i.charAt(4)+i.charAt(5),16)/255,this}return t&&t.length>0?this.setColorName(t):this},setColorName:function(t){const e=Ny[t];return e!==void 0?this.setHex(e):console.warn("THREE.Color: Unknown color "+t),this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},copyGammaToLinear:function(t,e){return e===void 0&&(e=2),this.r=Math.pow(t.r,e),this.g=Math.pow(t.g,e),this.b=Math.pow(t.b,e),this},copyLinearToGamma:function(t,e){e===void 0&&(e=2);const n=e>0?1/e:1;return this.r=Math.pow(t.r,n),this.g=Math.pow(t.g,n),this.b=Math.pow(t.b,n),this},convertGammaToLinear:function(t){return this.copyGammaToLinear(this,t),this},convertLinearToGamma:function(t){return this.copyLinearToGamma(this,t),this},copySRGBToLinear:function(t){return this.r=ld(t.r),this.g=ld(t.g),this.b=ld(t.b),this},copyLinearToSRGB:function(t){return this.r=hd(t.r),this.g=hd(t.g),this.b=hd(t.b),this},convertSRGBToLinear:function(){return this.copySRGBToLinear(this),this},convertLinearToSRGB:function(){return this.copyLinearToSRGB(this),this},getHex:function(){return this.r*255<<16^this.g*255<<8^this.b*255<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(t){t===void 0&&(console.warn("THREE.Color: .getHSL() target is now required"),t={h:0,s:0,l:0});const e=this.r,n=this.g,i=this.b,r=Math.max(e,n,i),s=Math.min(e,n,i);let o,a;const c=(s+r)/2;if(s===r)o=0,a=0;else{const l=r-s;switch(a=c<=.5?l/(r+s):l/(2-r-s),r){case e:o=(n-i)/l+(n<i?6:0);break;case n:o=(i-e)/l+2;break;case i:o=(e-n)/l+4;break}o/=6}return t.h=o,t.s=a,t.l=c,t},getStyle:function(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"},offsetHSL:function(t,e,n){return this.getHSL(ui),ui.h+=t,ui.s+=e,ui.l+=n,this.setHSL(ui.h,ui.s,ui.l),this},add:function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this},addColors:function(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this},addScalar:function(t){return this.r+=t,this.g+=t,this.b+=t,this},sub:function(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this},multiply:function(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this},multiplyScalar:function(t){return this.r*=t,this.g*=t,this.b*=t,this},lerp:function(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this},lerpHSL:function(t,e){this.getHSL(ui),t.getHSL(fl);const n=ut.lerp(ui.h,fl.h,e),i=ut.lerp(ui.s,fl.s,e),r=ut.lerp(ui.l,fl.l,e);return this.setHSL(n,i,r),this},equals:function(t){return t.r===this.r&&t.g===this.g&&t.b===this.b},fromArray:function(t,e){return e===void 0&&(e=0),this.r=t[e],this.g=t[e+1],this.b=t[e+2],this},toArray:function(t,e){return t===void 0&&(t=[]),e===void 0&&(e=0),t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t},fromBufferAttribute:function(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),t.normalized===!0&&(this.r/=255,this.g/=255,this.b/=255),this},toJSON:function(){return this.getHex()}});ke.NAMES=Ny;function ds(t,e,n,i,r,s){this.a=t,this.b=e,this.c=n,this.normal=i&&i.isVector3?i:new T,this.vertexNormals=Array.isArray(i)?i:[],this.color=r&&r.isColor?r:new ke,this.vertexColors=Array.isArray(r)?r:[],this.materialIndex=s!==void 0?s:0}Object.assign(ds.prototype,{clone:function(){return new this.constructor().copy(this)},copy:function(t){this.a=t.a,this.b=t.b,this.c=t.c,this.normal.copy(t.normal),this.color.copy(t.color),this.materialIndex=t.materialIndex;for(let e=0,n=t.vertexNormals.length;e<n;e++)this.vertexNormals[e]=t.vertexNormals[e].clone();for(let e=0,n=t.vertexColors.length;e<n;e++)this.vertexColors[e]=t.vertexColors[e].clone();return this}});let H_=0;function at(){Object.defineProperty(this,"id",{value:H_++}),this.uuid=ut.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.blending=Br,this.side=Yo,this.flatShading=!1,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=Iy,this.blendDst=Ly,this.blendEquation=ro,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=Rf,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=L_,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Zu,this.stencilZFail=Zu,this.stencilZPass=Zu,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0}at.prototype=Object.assign(Object.create(xr.prototype),{constructor:at,isMaterial:!0,onBeforeCompile:function(){},customProgramCacheKey:function(){return this.onBeforeCompile.toString()},setValues:function(t){if(t!==void 0)for(const e in t){const n=t[e];if(n===void 0){console.warn("THREE.Material: '"+e+"' parameter is undefined.");continue}if(e==="shading"){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=n===Ey;continue}const i=this[e];if(i===void 0){console.warn("THREE."+this.type+": '"+e+"' is not a property of this material.");continue}i&&i.isColor?i.set(n):i&&i.isVector3&&n&&n.isVector3?i.copy(n):this[e]=n}},toJSON:function(t){const e=t===void 0||typeof t=="string";e&&(t={textures:{},images:{}});const n={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};n.uuid=this.uuid,n.type=this.type,this.name!==""&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),this.roughness!==void 0&&(n.roughness=this.roughness),this.metalness!==void 0&&(n.metalness=this.metalness),this.sheen&&this.sheen.isColor&&(n.sheen=this.sheen.getHex()),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),this.emissiveIntensity&&this.emissiveIntensity!==1&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),this.shininess!==void 0&&(n.shininess=this.shininess),this.clearcoat!==void 0&&(n.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(t).uuid),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(t).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(t).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(t).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(t).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(t).uuid,n.reflectivity=this.reflectivity,n.refractionRatio=this.refractionRatio,this.combine!==void 0&&(n.combine=this.combine),this.envMapIntensity!==void 0&&(n.envMapIntensity=this.envMapIntensity)),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(t).uuid),this.size!==void 0&&(n.size=this.size),this.sizeAttenuation!==void 0&&(n.sizeAttenuation=this.sizeAttenuation),this.blending!==Br&&(n.blending=this.blending),this.flatShading===!0&&(n.flatShading=this.flatShading),this.side!==Yo&&(n.side=this.side),this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),this.transparent===!0&&(n.transparent=this.transparent),n.depthFunc=this.depthFunc,n.depthTest=this.depthTest,n.depthWrite=this.depthWrite,n.stencilWrite=this.stencilWrite,n.stencilWriteMask=this.stencilWriteMask,n.stencilFunc=this.stencilFunc,n.stencilRef=this.stencilRef,n.stencilFuncMask=this.stencilFuncMask,n.stencilFail=this.stencilFail,n.stencilZFail=this.stencilZFail,n.stencilZPass=this.stencilZPass,this.rotation&&this.rotation!==0&&(n.rotation=this.rotation),this.polygonOffset===!0&&(n.polygonOffset=!0),this.polygonOffsetFactor!==0&&(n.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(n.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&this.linewidth!==1&&(n.linewidth=this.linewidth),this.dashSize!==void 0&&(n.dashSize=this.dashSize),this.gapSize!==void 0&&(n.gapSize=this.gapSize),this.scale!==void 0&&(n.scale=this.scale),this.dithering===!0&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),this.premultipliedAlpha===!0&&(n.premultipliedAlpha=this.premultipliedAlpha),this.wireframe===!0&&(n.wireframe=this.wireframe),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(n.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(n.wireframeLinejoin=this.wireframeLinejoin),this.morphTargets===!0&&(n.morphTargets=!0),this.morphNormals===!0&&(n.morphNormals=!0),this.skinning===!0&&(n.skinning=!0),this.visible===!1&&(n.visible=!1),this.toneMapped===!1&&(n.toneMapped=!1),JSON.stringify(this.userData)!=="{}"&&(n.userData=this.userData);function i(r){const s=[];for(const o in r){const a=r[o];delete a.metadata,s.push(a)}return s}if(e){const r=i(t.textures),s=i(t.images);r.length>0&&(n.textures=r),s.length>0&&(n.images=s)}return n},clone:function(){return new this.constructor().copy(this)},copy:function(t){this.name=t.name,this.fog=t.fog,this.blending=t.blending,this.side=t.side,this.flatShading=t.flatShading,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let n=null;if(e!==null){const i=e.length;n=new Array(i);for(let r=0;r!==i;++r)n[r]=e[r].clone()}return this.clippingPlanes=n,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.premultipliedAlpha=t.premultipliedAlpha,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this},dispose:function(){this.dispatchEvent({type:"dispose"})}});Object.defineProperty(at.prototype,"needsUpdate",{set:function(t){t===!0&&this.version++}});function _i(t){at.call(this),this.type="MeshBasicMaterial",this.color=new ke(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Au,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.setValues(t)}_i.prototype=Object.create(at.prototype);_i.prototype.constructor=_i;_i.prototype.isMeshBasicMaterial=!0;_i.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this};const jt=new T,pl=new Te;function Qe(t,e,n){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=t,this.itemSize=e,this.count=t!==void 0?t.length/e:0,this.normalized=n===!0,this.usage=Tu,this.updateRange={offset:0,count:-1},this.version=0}Object.defineProperty(Qe.prototype,"needsUpdate",{set:function(t){t===!0&&this.version++}});Object.assign(Qe.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setUsage:function(t){return this.usage=t,this},copy:function(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this},copyAt:function(t,e,n){t*=this.itemSize,n*=e.itemSize;for(let i=0,r=this.itemSize;i<r;i++)this.array[t+i]=e.array[n+i];return this},copyArray:function(t){return this.array.set(t),this},copyColorsArray:function(t){const e=this.array;let n=0;for(let i=0,r=t.length;i<r;i++){let s=t[i];s===void 0&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",i),s=new ke),e[n++]=s.r,e[n++]=s.g,e[n++]=s.b}return this},copyVector2sArray:function(t){const e=this.array;let n=0;for(let i=0,r=t.length;i<r;i++){let s=t[i];s===void 0&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",i),s=new Te),e[n++]=s.x,e[n++]=s.y}return this},copyVector3sArray:function(t){const e=this.array;let n=0;for(let i=0,r=t.length;i<r;i++){let s=t[i];s===void 0&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",i),s=new T),e[n++]=s.x,e[n++]=s.y,e[n++]=s.z}return this},copyVector4sArray:function(t){const e=this.array;let n=0;for(let i=0,r=t.length;i<r;i++){let s=t[i];s===void 0&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",i),s=new Ft),e[n++]=s.x,e[n++]=s.y,e[n++]=s.z,e[n++]=s.w}return this},applyMatrix3:function(t){if(this.itemSize===2)for(let e=0,n=this.count;e<n;e++)pl.fromBufferAttribute(this,e),pl.applyMatrix3(t),this.setXY(e,pl.x,pl.y);else if(this.itemSize===3)for(let e=0,n=this.count;e<n;e++)jt.fromBufferAttribute(this,e),jt.applyMatrix3(t),this.setXYZ(e,jt.x,jt.y,jt.z);return this},applyMatrix4:function(t){for(let e=0,n=this.count;e<n;e++)jt.x=this.getX(e),jt.y=this.getY(e),jt.z=this.getZ(e),jt.applyMatrix4(t),this.setXYZ(e,jt.x,jt.y,jt.z);return this},applyNormalMatrix:function(t){for(let e=0,n=this.count;e<n;e++)jt.x=this.getX(e),jt.y=this.getY(e),jt.z=this.getZ(e),jt.applyNormalMatrix(t),this.setXYZ(e,jt.x,jt.y,jt.z);return this},transformDirection:function(t){for(let e=0,n=this.count;e<n;e++)jt.x=this.getX(e),jt.y=this.getY(e),jt.z=this.getZ(e),jt.transformDirection(t),this.setXYZ(e,jt.x,jt.y,jt.z);return this},set:function(t,e){return e===void 0&&(e=0),this.array.set(t,e),this},getX:function(t){return this.array[t*this.itemSize]},setX:function(t,e){return this.array[t*this.itemSize]=e,this},getY:function(t){return this.array[t*this.itemSize+1]},setY:function(t,e){return this.array[t*this.itemSize+1]=e,this},getZ:function(t){return this.array[t*this.itemSize+2]},setZ:function(t,e){return this.array[t*this.itemSize+2]=e,this},getW:function(t){return this.array[t*this.itemSize+3]},setW:function(t,e){return this.array[t*this.itemSize+3]=e,this},setXY:function(t,e,n){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=n,this},setXYZ:function(t,e,n,i){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=n,this.array[t+2]=i,this},setXYZW:function(t,e,n,i,r){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=n,this.array[t+2]=i,this.array[t+3]=r,this},onUpload:function(t){return this.onUploadCallback=t,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)},toJSON:function(){return{itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized}}});function Of(t,e,n){Qe.call(this,new Int8Array(t),e,n)}Of.prototype=Object.create(Qe.prototype);Of.prototype.constructor=Of;function kf(t,e,n){Qe.call(this,new Uint8Array(t),e,n)}kf.prototype=Object.create(Qe.prototype);kf.prototype.constructor=kf;function Ff(t,e,n){Qe.call(this,new Uint8ClampedArray(t),e,n)}Ff.prototype=Object.create(Qe.prototype);Ff.prototype.constructor=Ff;function Nf(t,e,n){Qe.call(this,new Int16Array(t),e,n)}Nf.prototype=Object.create(Qe.prototype);Nf.prototype.constructor=Nf;function ac(t,e,n){Qe.call(this,new Uint16Array(t),e,n)}ac.prototype=Object.create(Qe.prototype);ac.prototype.constructor=ac;function zf(t,e,n){Qe.call(this,new Int32Array(t),e,n)}zf.prototype=Object.create(Qe.prototype);zf.prototype.constructor=zf;function cc(t,e,n){Qe.call(this,new Uint32Array(t),e,n)}cc.prototype=Object.create(Qe.prototype);cc.prototype.constructor=cc;function qe(t,e,n){Qe.call(this,new Float32Array(t),e,n)}qe.prototype=Object.create(Qe.prototype);qe.prototype.constructor=qe;function Gf(t,e,n){Qe.call(this,new Float64Array(t),e,n)}Gf.prototype=Object.create(Qe.prototype);Gf.prototype.constructor=Gf;function zy(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}Object.assign(zy.prototype,{computeGroups:function(t){const e=[];let n,i,r;const s=t.faces;for(i=0;i<s.length;i++){const o=s[i];o.materialIndex!==r&&(r=o.materialIndex,n!==void 0&&(n.count=i*3-n.start,e.push(n)),n={start:i*3,materialIndex:r})}n!==void 0&&(n.count=i*3-n.start,e.push(n)),this.groups=e},fromGeometry:function(t){const e=t.faces,n=t.vertices,i=t.faceVertexUvs,r=i[0]&&i[0].length>0,s=i[1]&&i[1].length>0,o=t.morphTargets,a=o.length;let c;if(a>0){c=[];for(let g=0;g<a;g++)c[g]={name:o[g].name,data:[]};this.morphTargets.position=c}const l=t.morphNormals,h=l.length;let u;if(h>0){u=[];for(let g=0;g<h;g++)u[g]={name:l[g].name,data:[]};this.morphTargets.normal=u}const f=t.skinIndices,d=t.skinWeights,p=f.length===n.length,y=d.length===n.length;n.length>0&&e.length===0&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let g=0;g<e.length;g++){const m=e[g];this.vertices.push(n[m.a],n[m.b],n[m.c]);const x=m.vertexNormals;if(x.length===3)this.normals.push(x[0],x[1],x[2]);else{const b=m.normal;this.normals.push(b,b,b)}const v=m.vertexColors;if(v.length===3)this.colors.push(v[0],v[1],v[2]);else{const b=m.color;this.colors.push(b,b,b)}if(r===!0){const b=i[0][g];b!==void 0?this.uvs.push(b[0],b[1],b[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",g),this.uvs.push(new Te,new Te,new Te))}if(s===!0){const b=i[1][g];b!==void 0?this.uvs2.push(b[0],b[1],b[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",g),this.uvs2.push(new Te,new Te,new Te))}for(let b=0;b<a;b++){const _=o[b].vertices;c[b].data.push(_[m.a],_[m.b],_[m.c])}for(let b=0;b<h;b++){const _=l[b].vertexNormals[g];u[b].data.push(_.a,_.b,_.c)}p&&this.skinIndices.push(f[m.a],f[m.b],f[m.c]),y&&this.skinWeights.push(d[m.a],d[m.b],d[m.c])}return this.computeGroups(t),this.verticesNeedUpdate=t.verticesNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,t.boundingSphere!==null&&(this.boundingSphere=t.boundingSphere.clone()),t.boundingBox!==null&&(this.boundingBox=t.boundingBox.clone()),this}});function Gy(t){if(t.length===0)return-1/0;let e=t[0];for(let n=1,i=t.length;n<i;++n)t[n]>e&&(e=t[n]);return e}let $_=1;const Ti=new Ie,ud=new $e,Hs=new T,$n=new Ut,Ma=new Ut,vn=new T;function We(){Object.defineProperty(this,"id",{value:$_+=2}),this.uuid=ut.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}We.prototype=Object.assign(Object.create(xr.prototype),{constructor:We,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(t){Array.isArray(t)?this.index=new(Gy(t)>65535?cc:ac)(t,1):this.index=t},getAttribute:function(t){return this.attributes[t]},setAttribute:function(t,e){return this.attributes[t]=e,this},deleteAttribute:function(t){return delete this.attributes[t],this},addGroup:function(t,e,n){this.groups.push({start:t,count:e,materialIndex:n!==void 0?n:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(t,e){this.drawRange.start=t,this.drawRange.count=e},applyMatrix4:function(t){const e=this.attributes.position;e!==void 0&&(e.applyMatrix4(t),e.needsUpdate=!0);const n=this.attributes.normal;if(n!==void 0){const r=new An().getNormalMatrix(t);n.applyNormalMatrix(r),n.needsUpdate=!0}const i=this.attributes.tangent;return i!==void 0&&(i.transformDirection(t),i.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this},rotateX:function(t){return Ti.makeRotationX(t),this.applyMatrix4(Ti),this},rotateY:function(t){return Ti.makeRotationY(t),this.applyMatrix4(Ti),this},rotateZ:function(t){return Ti.makeRotationZ(t),this.applyMatrix4(Ti),this},translate:function(t,e,n){return Ti.makeTranslation(t,e,n),this.applyMatrix4(Ti),this},scale:function(t,e,n){return Ti.makeScale(t,e,n),this.applyMatrix4(Ti),this},lookAt:function(t){return ud.lookAt(t),ud.updateMatrix(),this.applyMatrix4(ud.matrix),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(Hs).negate(),this.translate(Hs.x,Hs.y,Hs.z),this},setFromObject:function(t){const e=t.geometry;if(t.isPoints||t.isLine){const n=new qe(e.vertices.length*3,3),i=new qe(e.colors.length*3,3);if(this.setAttribute("position",n.copyVector3sArray(e.vertices)),this.setAttribute("color",i.copyColorsArray(e.colors)),e.lineDistances&&e.lineDistances.length===e.vertices.length){const r=new qe(e.lineDistances.length,1);this.setAttribute("lineDistance",r.copyArray(e.lineDistances))}e.boundingSphere!==null&&(this.boundingSphere=e.boundingSphere.clone()),e.boundingBox!==null&&(this.boundingBox=e.boundingBox.clone())}else t.isMesh&&e&&e.isGeometry&&this.fromGeometry(e);return this},setFromPoints:function(t){const e=[];for(let n=0,i=t.length;n<i;n++){const r=t[n];e.push(r.x,r.y,r.z||0)}return this.setAttribute("position",new qe(e,3)),this},updateFromObject:function(t){let e=t.geometry;if(t.isMesh){let n=e.__directGeometry;if(e.elementsNeedUpdate===!0&&(n=void 0,e.elementsNeedUpdate=!1),n===void 0)return this.fromGeometry(e);n.verticesNeedUpdate=e.verticesNeedUpdate,n.normalsNeedUpdate=e.normalsNeedUpdate,n.colorsNeedUpdate=e.colorsNeedUpdate,n.uvsNeedUpdate=e.uvsNeedUpdate,n.groupsNeedUpdate=e.groupsNeedUpdate,e.verticesNeedUpdate=!1,e.normalsNeedUpdate=!1,e.colorsNeedUpdate=!1,e.uvsNeedUpdate=!1,e.groupsNeedUpdate=!1,e=n}if(e.verticesNeedUpdate===!0){const n=this.attributes.position;n!==void 0&&(n.copyVector3sArray(e.vertices),n.needsUpdate=!0),e.verticesNeedUpdate=!1}if(e.normalsNeedUpdate===!0){const n=this.attributes.normal;n!==void 0&&(n.copyVector3sArray(e.normals),n.needsUpdate=!0),e.normalsNeedUpdate=!1}if(e.colorsNeedUpdate===!0){const n=this.attributes.color;n!==void 0&&(n.copyColorsArray(e.colors),n.needsUpdate=!0),e.colorsNeedUpdate=!1}if(e.uvsNeedUpdate){const n=this.attributes.uv;n!==void 0&&(n.copyVector2sArray(e.uvs),n.needsUpdate=!0),e.uvsNeedUpdate=!1}if(e.lineDistancesNeedUpdate){const n=this.attributes.lineDistance;n!==void 0&&(n.copyArray(e.lineDistances),n.needsUpdate=!0),e.lineDistancesNeedUpdate=!1}return e.groupsNeedUpdate&&(e.computeGroups(t.geometry),this.groups=e.groups,e.groupsNeedUpdate=!1),this},fromGeometry:function(t){return t.__directGeometry=new zy().fromGeometry(t),this.fromDirectGeometry(t.__directGeometry)},fromDirectGeometry:function(t){const e=new Float32Array(t.vertices.length*3);if(this.setAttribute("position",new Qe(e,3).copyVector3sArray(t.vertices)),t.normals.length>0){const n=new Float32Array(t.normals.length*3);this.setAttribute("normal",new Qe(n,3).copyVector3sArray(t.normals))}if(t.colors.length>0){const n=new Float32Array(t.colors.length*3);this.setAttribute("color",new Qe(n,3).copyColorsArray(t.colors))}if(t.uvs.length>0){const n=new Float32Array(t.uvs.length*2);this.setAttribute("uv",new Qe(n,2).copyVector2sArray(t.uvs))}if(t.uvs2.length>0){const n=new Float32Array(t.uvs2.length*2);this.setAttribute("uv2",new Qe(n,2).copyVector2sArray(t.uvs2))}this.groups=t.groups;for(const n in t.morphTargets){const i=[],r=t.morphTargets[n];for(let s=0,o=r.length;s<o;s++){const a=r[s],c=new qe(a.data.length*3,3);c.name=a.name,i.push(c.copyVector3sArray(a.data))}this.morphAttributes[n]=i}if(t.skinIndices.length>0){const n=new qe(t.skinIndices.length*4,4);this.setAttribute("skinIndex",n.copyVector4sArray(t.skinIndices))}if(t.skinWeights.length>0){const n=new qe(t.skinWeights.length*4,4);this.setAttribute("skinWeight",n.copyVector4sArray(t.skinWeights))}return t.boundingSphere!==null&&(this.boundingSphere=t.boundingSphere.clone()),t.boundingBox!==null&&(this.boundingBox=t.boundingBox.clone()),this},computeBoundingBox:function(){this.boundingBox===null&&(this.boundingBox=new Ut);const t=this.attributes.position,e=this.morphAttributes.position;if(t!==void 0){if(this.boundingBox.setFromBufferAttribute(t),e)for(let n=0,i=e.length;n<i;n++){const r=e[n];$n.setFromBufferAttribute(r),this.morphTargetsRelative?(vn.addVectors(this.boundingBox.min,$n.min),this.boundingBox.expandByPoint(vn),vn.addVectors(this.boundingBox.max,$n.max),this.boundingBox.expandByPoint(vn)):(this.boundingBox.expandByPoint($n.min),this.boundingBox.expandByPoint($n.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){this.boundingSphere===null&&(this.boundingSphere=new br);const t=this.attributes.position,e=this.morphAttributes.position;if(t){const n=this.boundingSphere.center;if($n.setFromBufferAttribute(t),e)for(let r=0,s=e.length;r<s;r++){const o=e[r];Ma.setFromBufferAttribute(o),this.morphTargetsRelative?(vn.addVectors($n.min,Ma.min),$n.expandByPoint(vn),vn.addVectors($n.max,Ma.max),$n.expandByPoint(vn)):($n.expandByPoint(Ma.min),$n.expandByPoint(Ma.max))}$n.getCenter(n);let i=0;for(let r=0,s=t.count;r<s;r++)vn.fromBufferAttribute(t,r),i=Math.max(i,n.distanceToSquared(vn));if(e)for(let r=0,s=e.length;r<s;r++){const o=e[r],a=this.morphTargetsRelative;for(let c=0,l=o.count;c<l;c++)vn.fromBufferAttribute(o,c),a&&(Hs.fromBufferAttribute(t,c),vn.add(Hs)),i=Math.max(i,n.distanceToSquared(vn))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}},computeFaceNormals:function(){},computeVertexNormals:function(){const t=this.index,e=this.getAttribute("position");if(e!==void 0){let n=this.getAttribute("normal");if(n===void 0)n=new Qe(new Float32Array(e.count*3),3),this.setAttribute("normal",n);else for(let u=0,f=n.count;u<f;u++)n.setXYZ(u,0,0,0);const i=new T,r=new T,s=new T,o=new T,a=new T,c=new T,l=new T,h=new T;if(t)for(let u=0,f=t.count;u<f;u+=3){const d=t.getX(u+0),p=t.getX(u+1),y=t.getX(u+2);i.fromBufferAttribute(e,d),r.fromBufferAttribute(e,p),s.fromBufferAttribute(e,y),l.subVectors(s,r),h.subVectors(i,r),l.cross(h),o.fromBufferAttribute(n,d),a.fromBufferAttribute(n,p),c.fromBufferAttribute(n,y),o.add(l),a.add(l),c.add(l),n.setXYZ(d,o.x,o.y,o.z),n.setXYZ(p,a.x,a.y,a.z),n.setXYZ(y,c.x,c.y,c.z)}else for(let u=0,f=e.count;u<f;u+=3)i.fromBufferAttribute(e,u+0),r.fromBufferAttribute(e,u+1),s.fromBufferAttribute(e,u+2),l.subVectors(s,r),h.subVectors(i,r),l.cross(h),n.setXYZ(u+0,l.x,l.y,l.z),n.setXYZ(u+1,l.x,l.y,l.z),n.setXYZ(u+2,l.x,l.y,l.z);this.normalizeNormals(),n.needsUpdate=!0}},merge:function(t,e){if(!(t&&t.isBufferGeometry)){console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",t);return}e===void 0&&(e=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const n=this.attributes;for(const i in n){if(t.attributes[i]===void 0)continue;const s=n[i].array,o=t.attributes[i],a=o.array,c=o.itemSize*e,l=Math.min(a.length,s.length-c);for(let h=0,u=c;h<l;h++,u++)s[u]=a[h]}return this},normalizeNormals:function(){const t=this.attributes.normal;for(let e=0,n=t.count;e<n;e++)vn.fromBufferAttribute(t,e),vn.normalize(),t.setXYZ(e,vn.x,vn.y,vn.z)},toNonIndexed:function(){function t(o,a){const c=o.array,l=o.itemSize,h=o.normalized,u=new c.constructor(a.length*l);let f=0,d=0;for(let p=0,y=a.length;p<y;p++){f=a[p]*l;for(let g=0;g<l;g++)u[d++]=c[f++]}return new Qe(u,l,h)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;const e=new We,n=this.index.array,i=this.attributes;for(const o in i){const a=i[o],c=t(a,n);e.setAttribute(o,c)}const r=this.morphAttributes;for(const o in r){const a=[],c=r[o];for(let l=0,h=c.length;l<h;l++){const u=c[l],f=t(u,n);a.push(f)}e.morphAttributes[o]=a}e.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let o=0,a=s.length;o<a;o++){const c=s[o];e.addGroup(c.start,c.count,c.materialIndex)}return e},toJSON:function(){const t={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,this.name!==""&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),this.parameters!==void 0){const a=this.parameters;for(const c in a)a[c]!==void 0&&(t[c]=a[c]);return t}t.data={attributes:{}};const e=this.index;e!==null&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const n=this.attributes;for(const a in n){const c=n[a],l=c.toJSON(t.data);c.name!==""&&(l.name=c.name),t.data.attributes[a]=l}const i={};let r=!1;for(const a in this.morphAttributes){const c=this.morphAttributes[a],l=[];for(let h=0,u=c.length;h<u;h++){const f=c[h],d=f.toJSON(t.data);f.name!==""&&(d.name=f.name),l.push(d)}l.length>0&&(i[a]=l,r=!0)}r&&(t.data.morphAttributes=i,t.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(t.data.groups=JSON.parse(JSON.stringify(s)));const o=this.boundingSphere;return o!==null&&(t.data.boundingSphere={center:o.center.toArray(),radius:o.radius}),t},clone:function(){return new We().copy(this)},copy:function(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const n=t.index;n!==null&&this.setIndex(n.clone(e));const i=t.attributes;for(const c in i){const l=i[c];this.setAttribute(c,l.clone(e))}const r=t.morphAttributes;for(const c in r){const l=[],h=r[c];for(let u=0,f=h.length;u<f;u++)l.push(h[u].clone(e));this.morphAttributes[c]=l}this.morphTargetsRelative=t.morphTargetsRelative;const s=t.groups;for(let c=0,l=s.length;c<l;c++){const h=s[c];this.addGroup(h.start,h.count,h.materialIndex)}const o=t.boundingBox;o!==null&&(this.boundingBox=o.clone());const a=t.boundingSphere;return a!==null&&(this.boundingSphere=a.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});const rg=new Ie,ts=new Ko,dd=new br,Tr=new T,Pr=new T,Er=new T,fd=new T,pd=new T,md=new T,ml=new T,gl=new T,yl=new T,lo=new Te,ho=new Te,uo=new Te,Ka=new T,xl=new T;function Ht(t,e){$e.call(this),this.type="Mesh",this.geometry=t!==void 0?t:new We,this.material=e!==void 0?e:new _i,this.updateMorphTargets()}Ht.prototype=Object.assign(Object.create($e.prototype),{constructor:Ht,isMesh:!0,copy:function(t){return $e.prototype.copy.call(this,t),t.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),t.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=t.material,this.geometry=t.geometry,this},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,n=Object.keys(e);if(n.length>0){const i=e[n[0]];if(i!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let r=0,s=i.length;r<s;r++){const o=i[r].name||String(r);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=r}}}}else{const e=t.morphTargets;e!==void 0&&e.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}},raycast:function(t,e){const n=this.geometry,i=this.material,r=this.matrixWorld;if(i===void 0||(n.boundingSphere===null&&n.computeBoundingSphere(),dd.copy(n.boundingSphere),dd.applyMatrix4(r),t.ray.intersectsSphere(dd)===!1)||(rg.getInverse(r),ts.copy(t.ray).applyMatrix4(rg),n.boundingBox!==null&&ts.intersectsBox(n.boundingBox)===!1))return;let s;if(n.isBufferGeometry){const o=n.index,a=n.attributes.position,c=n.morphAttributes.position,l=n.morphTargetsRelative,h=n.attributes.uv,u=n.attributes.uv2,f=n.groups,d=n.drawRange;if(o!==null)if(Array.isArray(i))for(let p=0,y=f.length;p<y;p++){const g=f[p],m=i[g.materialIndex],x=Math.max(g.start,d.start),v=Math.min(g.start+g.count,d.start+d.count);for(let b=x,_=v;b<_;b+=3){const C=o.getX(b),w=o.getX(b+1),S=o.getX(b+2);s=bl(this,m,t,ts,a,c,l,h,u,C,w,S),s&&(s.faceIndex=Math.floor(b/3),s.face.materialIndex=g.materialIndex,e.push(s))}}else{const p=Math.max(0,d.start),y=Math.min(o.count,d.start+d.count);for(let g=p,m=y;g<m;g+=3){const x=o.getX(g),v=o.getX(g+1),b=o.getX(g+2);s=bl(this,i,t,ts,a,c,l,h,u,x,v,b),s&&(s.faceIndex=Math.floor(g/3),e.push(s))}}else if(a!==void 0)if(Array.isArray(i))for(let p=0,y=f.length;p<y;p++){const g=f[p],m=i[g.materialIndex],x=Math.max(g.start,d.start),v=Math.min(g.start+g.count,d.start+d.count);for(let b=x,_=v;b<_;b+=3){const C=b,w=b+1,S=b+2;s=bl(this,m,t,ts,a,c,l,h,u,C,w,S),s&&(s.faceIndex=Math.floor(b/3),s.face.materialIndex=g.materialIndex,e.push(s))}}else{const p=Math.max(0,d.start),y=Math.min(a.count,d.start+d.count);for(let g=p,m=y;g<m;g+=3){const x=g,v=g+1,b=g+2;s=bl(this,i,t,ts,a,c,l,h,u,x,v,b),s&&(s.faceIndex=Math.floor(g/3),e.push(s))}}}else if(n.isGeometry){const o=Array.isArray(i),a=n.vertices,c=n.faces;let l;const h=n.faceVertexUvs[0];h.length>0&&(l=h);for(let u=0,f=c.length;u<f;u++){const d=c[u],p=o?i[d.materialIndex]:i;if(p===void 0)continue;const y=a[d.a],g=a[d.b],m=a[d.c];if(s=Uy(this,p,t,ts,y,g,m,Ka),s){if(l&&l[u]){const x=l[u];lo.copy(x[0]),ho.copy(x[1]),uo.copy(x[2]),s.uv=Mn.getUV(Ka,y,g,m,lo,ho,uo,new Te)}s.face=d,s.faceIndex=u,e.push(s)}}}}});function Uy(t,e,n,i,r,s,o,a){let c;if(e.side===yn?c=i.intersectTriangle(o,s,r,!0,a):c=i.intersectTriangle(r,s,o,e.side!==jc,a),c===null)return null;xl.copy(a),xl.applyMatrix4(t.matrixWorld);const l=n.ray.origin.distanceTo(xl);return l<n.near||l>n.far?null:{distance:l,point:xl.clone(),object:t}}function bl(t,e,n,i,r,s,o,a,c,l,h,u){Tr.fromBufferAttribute(r,l),Pr.fromBufferAttribute(r,h),Er.fromBufferAttribute(r,u);const f=t.morphTargetInfluences;if(e.morphTargets&&s&&f){ml.set(0,0,0),gl.set(0,0,0),yl.set(0,0,0);for(let p=0,y=s.length;p<y;p++){const g=f[p],m=s[p];g!==0&&(fd.fromBufferAttribute(m,l),pd.fromBufferAttribute(m,h),md.fromBufferAttribute(m,u),o?(ml.addScaledVector(fd,g),gl.addScaledVector(pd,g),yl.addScaledVector(md,g)):(ml.addScaledVector(fd.sub(Tr),g),gl.addScaledVector(pd.sub(Pr),g),yl.addScaledVector(md.sub(Er),g)))}Tr.add(ml),Pr.add(gl),Er.add(yl)}t.isSkinnedMesh&&(t.boneTransform(l,Tr),t.boneTransform(h,Pr),t.boneTransform(u,Er));const d=Uy(t,e,n,i,Tr,Pr,Er,Ka);if(d){a&&(lo.fromBufferAttribute(a,l),ho.fromBufferAttribute(a,h),uo.fromBufferAttribute(a,u),d.uv=Mn.getUV(Ka,Tr,Pr,Er,lo,ho,uo,new Te)),c&&(lo.fromBufferAttribute(c,l),ho.fromBufferAttribute(c,h),uo.fromBufferAttribute(c,u),d.uv2=Mn.getUV(Ka,Tr,Pr,Er,lo,ho,uo,new Te));const p=new ds(l,h,u);Mn.getNormal(Tr,Pr,Er,p.normal),d.face=p}return d}let W_=0;const Pi=new Ie,gd=new $e,vl=new T;function rt(){Object.defineProperty(this,"id",{value:W_+=2}),this.uuid=ut.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}rt.prototype=Object.assign(Object.create(xr.prototype),{constructor:rt,isGeometry:!0,applyMatrix4:function(t){const e=new An().getNormalMatrix(t);for(let n=0,i=this.vertices.length;n<i;n++)this.vertices[n].applyMatrix4(t);for(let n=0,i=this.faces.length;n<i;n++){const r=this.faces[n];r.normal.applyMatrix3(e).normalize();for(let s=0,o=r.vertexNormals.length;s<o;s++)r.vertexNormals[s].applyMatrix3(e).normalize()}return this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(t){return Pi.makeRotationX(t),this.applyMatrix4(Pi),this},rotateY:function(t){return Pi.makeRotationY(t),this.applyMatrix4(Pi),this},rotateZ:function(t){return Pi.makeRotationZ(t),this.applyMatrix4(Pi),this},translate:function(t,e,n){return Pi.makeTranslation(t,e,n),this.applyMatrix4(Pi),this},scale:function(t,e,n){return Pi.makeScale(t,e,n),this.applyMatrix4(Pi),this},lookAt:function(t){return gd.lookAt(t),gd.updateMatrix(),this.applyMatrix4(gd.matrix),this},fromBufferGeometry:function(t){const e=this,n=t.index!==null?t.index:void 0,i=t.attributes;if(i.position===void 0)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;const r=i.position,s=i.normal,o=i.color,a=i.uv,c=i.uv2;c!==void 0&&(this.faceVertexUvs[1]=[]);for(let u=0;u<r.count;u++)e.vertices.push(new T().fromBufferAttribute(r,u)),o!==void 0&&e.colors.push(new ke().fromBufferAttribute(o,u));function l(u,f,d,p){const y=o===void 0?[]:[e.colors[u].clone(),e.colors[f].clone(),e.colors[d].clone()],g=s===void 0?[]:[new T().fromBufferAttribute(s,u),new T().fromBufferAttribute(s,f),new T().fromBufferAttribute(s,d)],m=new ds(u,f,d,g,y,p);e.faces.push(m),a!==void 0&&e.faceVertexUvs[0].push([new Te().fromBufferAttribute(a,u),new Te().fromBufferAttribute(a,f),new Te().fromBufferAttribute(a,d)]),c!==void 0&&e.faceVertexUvs[1].push([new Te().fromBufferAttribute(c,u),new Te().fromBufferAttribute(c,f),new Te().fromBufferAttribute(c,d)])}const h=t.groups;if(h.length>0)for(let u=0;u<h.length;u++){const f=h[u],d=f.start,p=f.count;for(let y=d,g=d+p;y<g;y+=3)n!==void 0?l(n.getX(y),n.getX(y+1),n.getX(y+2),f.materialIndex):l(y,y+1,y+2,f.materialIndex)}else if(n!==void 0)for(let u=0;u<n.count;u+=3)l(n.getX(u),n.getX(u+1),n.getX(u+2));else for(let u=0;u<r.count;u+=3)l(u,u+1,u+2);return this.computeFaceNormals(),t.boundingBox!==null&&(this.boundingBox=t.boundingBox.clone()),t.boundingSphere!==null&&(this.boundingSphere=t.boundingSphere.clone()),this},center:function(){return this.computeBoundingBox(),this.boundingBox.getCenter(vl).negate(),this.translate(vl.x,vl.y,vl.z),this},normalize:function(){this.computeBoundingSphere();const t=this.boundingSphere.center,e=this.boundingSphere.radius,n=e===0?1:1/e,i=new Ie;return i.set(n,0,0,-n*t.x,0,n,0,-n*t.y,0,0,n,-n*t.z,0,0,0,1),this.applyMatrix4(i),this},computeFaceNormals:function(){const t=new T,e=new T;for(let n=0,i=this.faces.length;n<i;n++){const r=this.faces[n],s=this.vertices[r.a],o=this.vertices[r.b],a=this.vertices[r.c];t.subVectors(a,o),e.subVectors(s,o),t.cross(e),t.normalize(),r.normal.copy(t)}},computeVertexNormals:function(t){t===void 0&&(t=!0);const e=new Array(this.vertices.length);for(let n=0,i=this.vertices.length;n<i;n++)e[n]=new T;if(t){const n=new T,i=new T;for(let r=0,s=this.faces.length;r<s;r++){const o=this.faces[r],a=this.vertices[o.a],c=this.vertices[o.b],l=this.vertices[o.c];n.subVectors(l,c),i.subVectors(a,c),n.cross(i),e[o.a].add(n),e[o.b].add(n),e[o.c].add(n)}}else{this.computeFaceNormals();for(let n=0,i=this.faces.length;n<i;n++){const r=this.faces[n];e[r.a].add(r.normal),e[r.b].add(r.normal),e[r.c].add(r.normal)}}for(let n=0,i=this.vertices.length;n<i;n++)e[n].normalize();for(let n=0,i=this.faces.length;n<i;n++){const r=this.faces[n],s=r.vertexNormals;s.length===3?(s[0].copy(e[r.a]),s[1].copy(e[r.b]),s[2].copy(e[r.c])):(s[0]=e[r.a].clone(),s[1]=e[r.b].clone(),s[2]=e[r.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){this.computeFaceNormals();for(let t=0,e=this.faces.length;t<e;t++){const n=this.faces[t],i=n.vertexNormals;i.length===3?(i[0].copy(n.normal),i[1].copy(n.normal),i[2].copy(n.normal)):(i[0]=n.normal.clone(),i[1]=n.normal.clone(),i[2]=n.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){for(let e=0,n=this.faces.length;e<n;e++){const i=this.faces[e];i.__originalFaceNormal?i.__originalFaceNormal.copy(i.normal):i.__originalFaceNormal=i.normal.clone(),i.__originalVertexNormals||(i.__originalVertexNormals=[]);for(let r=0,s=i.vertexNormals.length;r<s;r++)i.__originalVertexNormals[r]?i.__originalVertexNormals[r].copy(i.vertexNormals[r]):i.__originalVertexNormals[r]=i.vertexNormals[r].clone()}const t=new rt;t.faces=this.faces;for(let e=0,n=this.morphTargets.length;e<n;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];const r=this.morphNormals[e].faceNormals,s=this.morphNormals[e].vertexNormals;for(let o=0,a=this.faces.length;o<a;o++){const c=new T,l={a:new T,b:new T,c:new T};r.push(c),s.push(l)}}const i=this.morphNormals[e];t.vertices=this.morphTargets[e].vertices,t.computeFaceNormals(),t.computeVertexNormals();for(let r=0,s=this.faces.length;r<s;r++){const o=this.faces[r],a=i.faceNormals[r],c=i.vertexNormals[r];a.copy(o.normal),c.a.copy(o.vertexNormals[0]),c.b.copy(o.vertexNormals[1]),c.c.copy(o.vertexNormals[2])}}for(let e=0,n=this.faces.length;e<n;e++){const i=this.faces[e];i.normal=i.__originalFaceNormal,i.vertexNormals=i.__originalVertexNormals}},computeBoundingBox:function(){this.boundingBox===null&&(this.boundingBox=new Ut),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){this.boundingSphere===null&&(this.boundingSphere=new br),this.boundingSphere.setFromPoints(this.vertices)},merge:function(t,e,n){if(!(t&&t.isGeometry)){console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",t);return}let i,r=this.vertices.length,s=this.vertices,o=t.vertices,a=this.faces,c=t.faces,l=this.colors,h=t.colors;n===void 0&&(n=0),e!==void 0&&(i=new An().getNormalMatrix(e));for(let u=0,f=o.length;u<f;u++){const p=o[u].clone();e!==void 0&&p.applyMatrix4(e),s.push(p)}for(let u=0,f=h.length;u<f;u++)l.push(h[u].clone());for(let u=0,f=c.length;u<f;u++){let d=c[u],p,y,g,m=d.vertexNormals,x=d.vertexColors;p=new ds(d.a+r,d.b+r,d.c+r),p.normal.copy(d.normal),i!==void 0&&p.normal.applyMatrix3(i).normalize();for(let v=0,b=m.length;v<b;v++)y=m[v].clone(),i!==void 0&&y.applyMatrix3(i).normalize(),p.vertexNormals.push(y);p.color.copy(d.color);for(let v=0,b=x.length;v<b;v++)g=x[v],p.vertexColors.push(g.clone());p.materialIndex=d.materialIndex+n,a.push(p)}for(let u=0,f=t.faceVertexUvs.length;u<f;u++){const d=t.faceVertexUvs[u];this.faceVertexUvs[u]===void 0&&(this.faceVertexUvs[u]=[]);for(let p=0,y=d.length;p<y;p++){const g=d[p],m=[];for(let x=0,v=g.length;x<v;x++)m.push(g[x].clone());this.faceVertexUvs[u].push(m)}}},mergeMesh:function(t){if(!(t&&t.isMesh)){console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",t);return}t.matrixAutoUpdate&&t.updateMatrix(),this.merge(t.geometry,t.matrix)},mergeVertices:function(){const t={},e=[],n=[],r=Math.pow(10,4);for(let a=0,c=this.vertices.length;a<c;a++){const l=this.vertices[a],h=Math.round(l.x*r)+"_"+Math.round(l.y*r)+"_"+Math.round(l.z*r);t[h]===void 0?(t[h]=a,e.push(this.vertices[a]),n[a]=e.length-1):n[a]=n[t[h]]}const s=[];for(let a=0,c=this.faces.length;a<c;a++){const l=this.faces[a];l.a=n[l.a],l.b=n[l.b],l.c=n[l.c];const h=[l.a,l.b,l.c];for(let u=0;u<3;u++)if(h[u]===h[(u+1)%3]){s.push(a);break}}for(let a=s.length-1;a>=0;a--){const c=s[a];this.faces.splice(c,1);for(let l=0,h=this.faceVertexUvs.length;l<h;l++)this.faceVertexUvs[l].splice(c,1)}const o=this.vertices.length-e.length;return this.vertices=e,o},setFromPoints:function(t){this.vertices=[];for(let e=0,n=t.length;e<n;e++){const i=t[e];this.vertices.push(new T(i.x,i.y,i.z||0))}return this},sortFacesByMaterialIndex:function(){const t=this.faces,e=t.length;for(let a=0;a<e;a++)t[a]._id=a;function n(a,c){return a.materialIndex-c.materialIndex}t.sort(n);const i=this.faceVertexUvs[0],r=this.faceVertexUvs[1];let s,o;i&&i.length===e&&(s=[]),r&&r.length===e&&(o=[]);for(let a=0;a<e;a++){const c=t[a]._id;s&&s.push(i[c]),o&&o.push(r[c])}s&&(this.faceVertexUvs[0]=s),o&&(this.faceVertexUvs[1]=o)},toJSON:function(){const t={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,this.name!==""&&(t.name=this.name),this.parameters!==void 0){const d=this.parameters;for(const p in d)d[p]!==void 0&&(t[p]=d[p]);return t}const e=[];for(let d=0;d<this.vertices.length;d++){const p=this.vertices[d];e.push(p.x,p.y,p.z)}const n=[],i=[],r={},s=[],o={},a=[],c={};for(let d=0;d<this.faces.length;d++){const p=this.faces[d],y=!0,g=!1,m=this.faceVertexUvs[0][d]!==void 0,x=p.normal.length()>0,v=p.vertexNormals.length>0,b=p.color.r!==1||p.color.g!==1||p.color.b!==1,_=p.vertexColors.length>0;let C=0;if(C=l(C,0,0),C=l(C,1,y),C=l(C,2,g),C=l(C,3,m),C=l(C,4,x),C=l(C,5,v),C=l(C,6,b),C=l(C,7,_),n.push(C),n.push(p.a,p.b,p.c),n.push(p.materialIndex),m){const w=this.faceVertexUvs[0][d];n.push(f(w[0]),f(w[1]),f(w[2]))}if(x&&n.push(h(p.normal)),v){const w=p.vertexNormals;n.push(h(w[0]),h(w[1]),h(w[2]))}if(b&&n.push(u(p.color)),_){const w=p.vertexColors;n.push(u(w[0]),u(w[1]),u(w[2]))}}function l(d,p,y){return y?d|1<<p:d&~(1<<p)}function h(d){const p=d.x.toString()+d.y.toString()+d.z.toString();return r[p]!==void 0||(r[p]=i.length/3,i.push(d.x,d.y,d.z)),r[p]}function u(d){const p=d.r.toString()+d.g.toString()+d.b.toString();return o[p]!==void 0||(o[p]=s.length,s.push(d.getHex())),o[p]}function f(d){const p=d.x.toString()+d.y.toString();return c[p]!==void 0||(c[p]=a.length/2,a.push(d.x,d.y)),c[p]}return t.data={},t.data.vertices=e,t.data.normals=i,s.length>0&&(t.data.colors=s),a.length>0&&(t.data.uvs=[a]),t.data.faces=n,t},clone:function(){return new rt().copy(this)},copy:function(t){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=t.name;const e=t.vertices;for(let u=0,f=e.length;u<f;u++)this.vertices.push(e[u].clone());const n=t.colors;for(let u=0,f=n.length;u<f;u++)this.colors.push(n[u].clone());const i=t.faces;for(let u=0,f=i.length;u<f;u++)this.faces.push(i[u].clone());for(let u=0,f=t.faceVertexUvs.length;u<f;u++){const d=t.faceVertexUvs[u];this.faceVertexUvs[u]===void 0&&(this.faceVertexUvs[u]=[]);for(let p=0,y=d.length;p<y;p++){const g=d[p],m=[];for(let x=0,v=g.length;x<v;x++){const b=g[x];m.push(b.clone())}this.faceVertexUvs[u].push(m)}}const r=t.morphTargets;for(let u=0,f=r.length;u<f;u++){const d={};if(d.name=r[u].name,r[u].vertices!==void 0){d.vertices=[];for(let p=0,y=r[u].vertices.length;p<y;p++)d.vertices.push(r[u].vertices[p].clone())}if(r[u].normals!==void 0){d.normals=[];for(let p=0,y=r[u].normals.length;p<y;p++)d.normals.push(r[u].normals[p].clone())}this.morphTargets.push(d)}const s=t.morphNormals;for(let u=0,f=s.length;u<f;u++){const d={};if(s[u].vertexNormals!==void 0){d.vertexNormals=[];for(let p=0,y=s[u].vertexNormals.length;p<y;p++){const g=s[u].vertexNormals[p],m={};m.a=g.a.clone(),m.b=g.b.clone(),m.c=g.c.clone(),d.vertexNormals.push(m)}}if(s[u].faceNormals!==void 0){d.faceNormals=[];for(let p=0,y=s[u].faceNormals.length;p<y;p++)d.faceNormals.push(s[u].faceNormals[p].clone())}this.morphNormals.push(d)}const o=t.skinWeights;for(let u=0,f=o.length;u<f;u++)this.skinWeights.push(o[u].clone());const a=t.skinIndices;for(let u=0,f=a.length;u<f;u++)this.skinIndices.push(a[u].clone());const c=t.lineDistances;for(let u=0,f=c.length;u<f;u++)this.lineDistances.push(c[u]);const l=t.boundingBox;l!==null&&(this.boundingBox=l.clone());const h=t.boundingSphere;return h!==null&&(this.boundingSphere=h.clone()),this.elementsNeedUpdate=t.elementsNeedUpdate,this.verticesNeedUpdate=t.verticesNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.lineDistancesNeedUpdate=t.lineDistancesNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}});class j_ extends rt{constructor(e,n,i,r,s,o){super(),this.type="BoxGeometry",this.parameters={width:e,height:n,depth:i,widthSegments:r,heightSegments:s,depthSegments:o},this.fromBufferGeometry(new Yc(e,n,i,r,s,o)),this.mergeVertices()}}class Yc extends We{constructor(e,n,i,r,s,o){super(),this.type="BoxBufferGeometry",this.parameters={width:e,height:n,depth:i,widthSegments:r,heightSegments:s,depthSegments:o};const a=this;e=e||1,n=n||1,i=i||1,r=Math.floor(r)||1,s=Math.floor(s)||1,o=Math.floor(o)||1;const c=[],l=[],h=[],u=[];let f=0,d=0;p("z","y","x",-1,-1,i,n,e,o,s,0),p("z","y","x",1,-1,i,n,-e,o,s,1),p("x","z","y",1,1,e,i,n,r,o,2),p("x","z","y",1,-1,e,i,-n,r,o,3),p("x","y","z",1,-1,e,n,i,r,s,4),p("x","y","z",-1,-1,e,n,-i,r,s,5),this.setIndex(c),this.setAttribute("position",new qe(l,3)),this.setAttribute("normal",new qe(h,3)),this.setAttribute("uv",new qe(u,2));function p(y,g,m,x,v,b,_,C,w,S,M){const B=b/w,L=_/S,U=b/2,E=_/2,O=C/2,k=w+1,ne=S+1;let Y=0,F=0;const te=new T;for(let ee=0;ee<ne;ee++){const j=ee*L-E;for(let Z=0;Z<k;Z++){const ce=Z*B-U;te[y]=ce*x,te[g]=j*v,te[m]=O,l.push(te.x,te.y,te.z),te[y]=0,te[g]=0,te[m]=C>0?1:-1,h.push(te.x,te.y,te.z),u.push(Z/w),u.push(1-ee/S),Y+=1}}for(let ee=0;ee<S;ee++)for(let j=0;j<w;j++){const Z=f+j+k*ee,ce=f+j+k*(ee+1),de=f+(j+1)+k*(ee+1),oe=f+(j+1)+k*ee;c.push(Z,ce,oe),c.push(ce,de,oe),F+=6}a.addGroup(d,F,M),d+=F,f+=Y}}}function Ao(t){const e={};for(const n in t){e[n]={};for(const i in t[n]){const r=t[n][i];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture)?e[n][i]=r.clone():Array.isArray(r)?e[n][i]=r.slice():e[n][i]=r}}return e}function Tn(t){const e={};for(let n=0;n<t.length;n++){const i=Ao(t[n]);for(const r in i)e[r]=i[r]}return e}const gh={clone:Ao,merge:Tn};var q_=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,X_=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`;function bn(t){at.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader=q_,this.fragmentShader=X_,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,t!==void 0&&(t.attributes!==void 0&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(t))}bn.prototype=Object.create(at.prototype);bn.prototype.constructor=bn;bn.prototype.isShaderMaterial=!0;bn.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=Ao(t.uniforms),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.lights=t.lights,this.clipping=t.clipping,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this.extensions=Object.assign({},t.extensions),this};bn.prototype.toJSON=function(t){const e=at.prototype.toJSON.call(this,t);e.uniforms={};for(const i in this.uniforms){const s=this.uniforms[i].value;s&&s.isTexture?e.uniforms[i]={type:"t",value:s.toJSON(t).uuid}:s&&s.isColor?e.uniforms[i]={type:"c",value:s.getHex()}:s&&s.isVector2?e.uniforms[i]={type:"v2",value:s.toArray()}:s&&s.isVector3?e.uniforms[i]={type:"v3",value:s.toArray()}:s&&s.isVector4?e.uniforms[i]={type:"v4",value:s.toArray()}:s&&s.isMatrix3?e.uniforms[i]={type:"m3",value:s.toArray()}:s&&s.isMatrix4?e.uniforms[i]={type:"m4",value:s.toArray()}:e.uniforms[i]={value:s}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader;const n={};for(const i in this.extensions)this.extensions[i]===!0&&(n[i]=!0);return Object.keys(n).length>0&&(e.extensions=n),e};function ar(){$e.call(this),this.type="Camera",this.matrixWorldInverse=new Ie,this.projectionMatrix=new Ie,this.projectionMatrixInverse=new Ie}ar.prototype=Object.assign(Object.create($e.prototype),{constructor:ar,isCamera:!0,copy:function(t,e){return $e.prototype.copy.call(this,t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this},getWorldDirection:function(t){t===void 0&&(console.warn("THREE.Camera: .getWorldDirection() target is now required"),t=new T),this.updateMatrixWorld(!0);const e=this.matrixWorld.elements;return t.set(-e[8],-e[9],-e[10]).normalize()},updateMatrixWorld:function(t){$e.prototype.updateMatrixWorld.call(this,t),this.matrixWorldInverse.getInverse(this.matrixWorld)},updateWorldMatrix:function(t,e){$e.prototype.updateWorldMatrix.call(this,t,e),this.matrixWorldInverse.getInverse(this.matrixWorld)},clone:function(){return new this.constructor().copy(this)}});function pn(t,e,n,i){ar.call(this),this.type="PerspectiveCamera",this.fov=t!==void 0?t:50,this.zoom=1,this.near=n!==void 0?n:.1,this.far=i!==void 0?i:2e3,this.focus=10,this.aspect=e!==void 0?e:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}pn.prototype=Object.assign(Object.create(ar.prototype),{constructor:pn,isPerspectiveCamera:!0,copy:function(t,e){return ar.prototype.copy.call(this,t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=t.view===null?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this},setFocalLength:function(t){const e=.5*this.getFilmHeight()/t;this.fov=ut.RAD2DEG*2*Math.atan(e),this.updateProjectionMatrix()},getFocalLength:function(){const t=Math.tan(ut.DEG2RAD*.5*this.fov);return .5*this.getFilmHeight()/t},getEffectiveFOV:function(){return ut.RAD2DEG*2*Math.atan(Math.tan(ut.DEG2RAD*.5*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(t,e,n,i,r,s){this.aspect=t/e,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()},clearViewOffset:function(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){let t=this.near,e=t*Math.tan(ut.DEG2RAD*.5*this.fov)/this.zoom,n=2*e,i=this.aspect*n,r=-.5*i,s=this.view;if(this.view!==null&&this.view.enabled){const a=s.fullWidth,c=s.fullHeight;r+=s.offsetX*i/a,e-=s.offsetY*n/c,i*=s.width/a,n*=s.height/c}const o=this.filmOffset;o!==0&&(r+=t*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+i,e,e-n,t,this.far),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},toJSON:function(t){const e=$e.prototype.toJSON.call(this,t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,this.view!==null&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}});const $s=90,Ws=1;function lc(t,e,n){if($e.call(this),this.type="CubeCamera",n.isWebGLCubeRenderTarget!==!0){console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");return}this.renderTarget=n;const i=new pn($s,Ws,t,e);i.layers=this.layers,i.up.set(0,-1,0),i.lookAt(new T(1,0,0)),this.add(i);const r=new pn($s,Ws,t,e);r.layers=this.layers,r.up.set(0,-1,0),r.lookAt(new T(-1,0,0)),this.add(r);const s=new pn($s,Ws,t,e);s.layers=this.layers,s.up.set(0,0,1),s.lookAt(new T(0,1,0)),this.add(s);const o=new pn($s,Ws,t,e);o.layers=this.layers,o.up.set(0,0,-1),o.lookAt(new T(0,-1,0)),this.add(o);const a=new pn($s,Ws,t,e);a.layers=this.layers,a.up.set(0,-1,0),a.lookAt(new T(0,0,1)),this.add(a);const c=new pn($s,Ws,t,e);c.layers=this.layers,c.up.set(0,-1,0),c.lookAt(new T(0,0,-1)),this.add(c),this.update=function(l,h){this.parent===null&&this.updateMatrixWorld();const u=l.xr.enabled,f=l.getRenderTarget();l.xr.enabled=!1;const d=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,l.setRenderTarget(n,0),l.render(h,i),l.setRenderTarget(n,1),l.render(h,r),l.setRenderTarget(n,2),l.render(h,s),l.setRenderTarget(n,3),l.render(h,o),l.setRenderTarget(n,4),l.render(h,a),n.texture.generateMipmaps=d,l.setRenderTarget(n,5),l.render(h,c),l.setRenderTarget(f),l.xr.enabled=u},this.clear=function(l,h,u,f){const d=l.getRenderTarget();for(let p=0;p<6;p++)l.setRenderTarget(n,p),l.clear(h,u,f);l.setRenderTarget(d)}}lc.prototype=Object.create($e.prototype);lc.prototype.constructor=lc;function hc(t,e,n){Number.isInteger(e)&&(console.warn("THREE.WebGLCubeRenderTarget: constructor signature is now WebGLCubeRenderTarget( size, options )"),e=n),Rn.call(this,t,t,e)}hc.prototype=Object.create(Rn.prototype);hc.prototype.constructor=hc;hc.prototype.isWebGLCubeRenderTarget=!0;hc.prototype.fromEquirectangularTexture=function(t,e){this.texture.type=e.type,this.texture.format=e.format,this.texture.encoding=e.encoding;const n=new Mo,i={uniforms:{tEquirect:{value:null}},vertexShader:["varying vec3 vWorldDirection;","vec3 transformDirection( in vec3 dir, in mat4 matrix ) {","	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );","}","void main() {","	vWorldDirection = transformDirection( position, modelMatrix );","	#include <begin_vertex>","	#include <project_vertex>","}"].join(`
`),fragmentShader:["uniform sampler2D tEquirect;","varying vec3 vWorldDirection;","#include <common>","void main() {","	vec3 direction = normalize( vWorldDirection );","	vec2 sampleUV = equirectUv( direction );","	gl_FragColor = texture2D( tEquirect, sampleUV );","}"].join(`
`)},r=new bn({name:"CubemapFromEquirect",uniforms:Ao(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:yn,blending:or});r.uniforms.tEquirect.value=e;const s=new Ht(new Yc(5,5,5),r);return n.add(s),new lc(1,10,this).update(t,n),s.geometry.dispose(),s.material.dispose(),this};function cr(t,e,n,i,r,s,o,a,c,l,h,u){$t.call(this,null,s,o,a,c,l,i,r,h,u),this.image={data:t||null,width:e||1,height:n||1},this.magFilter=c!==void 0?c:zt,this.minFilter=l!==void 0?l:zt,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}cr.prototype=Object.create($t.prototype);cr.prototype.constructor=cr;cr.prototype.isDataTexture=!0;const js=new br,_l=new T;function Zc(t,e,n,i,r,s){this.planes=[t!==void 0?t:new Ri,e!==void 0?e:new Ri,n!==void 0?n:new Ri,i!==void 0?i:new Ri,r!==void 0?r:new Ri,s!==void 0?s:new Ri]}Object.assign(Zc.prototype,{set:function(t,e,n,i,r,s){const o=this.planes;return o[0].copy(t),o[1].copy(e),o[2].copy(n),o[3].copy(i),o[4].copy(r),o[5].copy(s),this},clone:function(){return new this.constructor().copy(this)},copy:function(t){const e=this.planes;for(let n=0;n<6;n++)e[n].copy(t.planes[n]);return this},setFromProjectionMatrix:function(t){const e=this.planes,n=t.elements,i=n[0],r=n[1],s=n[2],o=n[3],a=n[4],c=n[5],l=n[6],h=n[7],u=n[8],f=n[9],d=n[10],p=n[11],y=n[12],g=n[13],m=n[14],x=n[15];return e[0].setComponents(o-i,h-a,p-u,x-y).normalize(),e[1].setComponents(o+i,h+a,p+u,x+y).normalize(),e[2].setComponents(o+r,h+c,p+f,x+g).normalize(),e[3].setComponents(o-r,h-c,p-f,x-g).normalize(),e[4].setComponents(o-s,h-l,p-d,x-m).normalize(),e[5].setComponents(o+s,h+l,p+d,x+m).normalize(),this},intersectsObject:function(t){const e=t.geometry;return e.boundingSphere===null&&e.computeBoundingSphere(),js.copy(e.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(js)},intersectsSprite:function(t){return js.center.set(0,0,0),js.radius=.7071067811865476,js.applyMatrix4(t.matrixWorld),this.intersectsSphere(js)},intersectsSphere:function(t){const e=this.planes,n=t.center,i=-t.radius;for(let r=0;r<6;r++)if(e[r].distanceToPoint(n)<i)return!1;return!0},intersectsBox:function(t){const e=this.planes;for(let n=0;n<6;n++){const i=e[n];if(_l.x=i.normal.x>0?t.max.x:t.min.x,_l.y=i.normal.y>0?t.max.y:t.min.y,_l.z=i.normal.z>0?t.max.z:t.min.z,i.distanceToPoint(_l)<0)return!1}return!0},containsPoint:function(t){const e=this.planes;for(let n=0;n<6;n++)if(e[n].distanceToPoint(t)<0)return!1;return!0}});const He={common:{diffuse:{value:new ke(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new An},uv2Transform:{value:new An},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Te(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new ke(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new ke(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},uvTransform:{value:new An}},sprite:{diffuse:{value:new ke(15658734)},opacity:{value:1},center:{value:new Te(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},uvTransform:{value:new An}}};function Vy(){let t=null,e=!1,n=null,i=null;function r(s,o){n(s,o),i=t.requestAnimationFrame(r)}return{start:function(){e!==!0&&n!==null&&(i=t.requestAnimationFrame(r),e=!0)},stop:function(){t.cancelAnimationFrame(i),e=!1},setAnimationLoop:function(s){n=s},setContext:function(s){t=s}}}function Y_(t,e){const n=e.isWebGL2,i=new WeakMap;function r(l,h){const u=l.array,f=l.usage,d=t.createBuffer();t.bindBuffer(h,d),t.bufferData(h,u,f),l.onUploadCallback();let p=5126;return u instanceof Float32Array?p=5126:u instanceof Float64Array?console.warn("THREE.WebGLAttributes: Unsupported data buffer format: Float64Array."):u instanceof Uint16Array?p=5123:u instanceof Int16Array?p=5122:u instanceof Uint32Array?p=5125:u instanceof Int32Array?p=5124:u instanceof Int8Array?p=5120:u instanceof Uint8Array&&(p=5121),{buffer:d,type:p,bytesPerElement:u.BYTES_PER_ELEMENT,version:l.version}}function s(l,h,u){const f=h.array,d=h.updateRange;t.bindBuffer(u,l),d.count===-1?t.bufferSubData(u,0,f):(n?t.bufferSubData(u,d.offset*f.BYTES_PER_ELEMENT,f,d.offset,d.count):t.bufferSubData(u,d.offset*f.BYTES_PER_ELEMENT,f.subarray(d.offset,d.offset+d.count)),d.count=-1)}function o(l){return l.isInterleavedBufferAttribute&&(l=l.data),i.get(l)}function a(l){l.isInterleavedBufferAttribute&&(l=l.data);const h=i.get(l);h&&(t.deleteBuffer(h.buffer),i.delete(l))}function c(l,h){l.isInterleavedBufferAttribute&&(l=l.data);const u=i.get(l);u===void 0?i.set(l,r(l,h)):u.version<l.version&&(s(u.buffer,l,h),u.version=l.version)}return{get:o,remove:a,update:c}}function uc(t,e,n,i){rt.call(this),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:n,heightSegments:i},this.fromBufferGeometry(new Co(t,e,n,i)),this.mergeVertices()}uc.prototype=Object.create(rt.prototype);uc.prototype.constructor=uc;function Co(t,e,n,i){We.call(this),this.type="PlaneBufferGeometry",this.parameters={width:t,height:e,widthSegments:n,heightSegments:i},t=t||1,e=e||1;const r=t/2,s=e/2,o=Math.floor(n)||1,a=Math.floor(i)||1,c=o+1,l=a+1,h=t/o,u=e/a,f=[],d=[],p=[],y=[];for(let g=0;g<l;g++){const m=g*u-s;for(let x=0;x<c;x++){const v=x*h-r;d.push(v,-m,0),p.push(0,0,1),y.push(x/o),y.push(1-g/a)}}for(let g=0;g<a;g++)for(let m=0;m<o;m++){const x=m+c*g,v=m+c*(g+1),b=m+1+c*(g+1),_=m+1+c*g;f.push(x,v,_),f.push(v,b,_)}this.setIndex(f),this.setAttribute("position",new qe(d,3)),this.setAttribute("normal",new qe(p,3)),this.setAttribute("uv",new qe(y,2))}Co.prototype=Object.create(We.prototype);Co.prototype.constructor=Co;var Z_=`#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, vUv ).g;
#endif`,K_=`#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,J_=`#ifdef ALPHATEST
	if ( diffuseColor.a < ALPHATEST ) discard;
#endif`,Q_=`#ifdef USE_AOMAP
	float ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;
	reflectedLight.indirectDiffuse *= ambientOcclusion;
	#if defined( USE_ENVMAP ) && defined( STANDARD )
		float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );
		reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );
	#endif
#endif`,e2=`#ifdef USE_AOMAP
	uniform sampler2D aoMap;
	uniform float aoMapIntensity;
#endif`,t2="vec3 transformed = vec3( position );",n2=`vec3 objectNormal = vec3( normal );
#ifdef USE_TANGENT
	vec3 objectTangent = vec3( tangent.xyz );
#endif`,i2=`vec2 integrateSpecularBRDF( const in float dotNV, const in float roughness ) {
	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );
	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );
	vec4 r = roughness * c0 + c1;
	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;
	return vec2( -1.04, 1.04 ) * a004 + r.zw;
}
float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {
#if defined ( PHYSICALLY_CORRECT_LIGHTS )
	float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );
	if( cutoffDistance > 0.0 ) {
		distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );
	}
	return distanceFalloff;
#else
	if( cutoffDistance > 0.0 && decayExponent > 0.0 ) {
		return pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );
	}
	return 1.0;
#endif
}
vec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {
	return RECIPROCAL_PI * diffuseColor;
}
vec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {
	float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );
	return ( 1.0 - specularColor ) * fresnel + specularColor;
}
vec3 F_Schlick_RoughnessDependent( const in vec3 F0, const in float dotNV, const in float roughness ) {
	float fresnel = exp2( ( -5.55473 * dotNV - 6.98316 ) * dotNV );
	vec3 Fr = max( vec3( 1.0 - roughness ), F0 ) - F0;
	return Fr * fresnel + F0;
}
float G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	return 1.0 / ( gl * gv );
}
float G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	return 0.5 / max( gv + gl, EPSILON );
}
float D_GGX( const in float alpha, const in float dotNH ) {
	float a2 = pow2( alpha );
	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;
	return RECIPROCAL_PI * a2 / pow2( denom );
}
vec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {
	float alpha = pow2( roughness );
	vec3 halfDir = normalize( incidentLight.direction + viewDir );
	float dotNL = saturate( dot( normal, incidentLight.direction ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotLH = saturate( dot( incidentLight.direction, halfDir ) );
	vec3 F = F_Schlick( specularColor, dotLH );
	float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );
	float D = D_GGX( alpha, dotNH );
	return F * ( G * D );
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE  = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS  = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );
	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return vec3( result );
}
vec3 BRDF_Specular_GGX_Environment( const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	vec2 brdf = integrateSpecularBRDF( dotNV, roughness );
	return specularColor * brdf.x + brdf.y;
}
void BRDF_Specular_Multiscattering_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
	float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );
	vec3 F = F_Schlick_RoughnessDependent( specularColor, dotNV, roughness );
	vec2 brdf = integrateSpecularBRDF( dotNV, roughness );
	vec3 FssEss = F * brdf.x + brdf.y;
	float Ess = brdf.x + brdf.y;
	float Ems = 1.0 - Ess;
	vec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619;	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );
	singleScatter += FssEss;
	multiScatter += Fms * Ems;
}
float G_BlinnPhong_Implicit( ) {
	return 0.25;
}
float D_BlinnPhong( const in float shininess, const in float dotNH ) {
	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );
}
vec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {
	vec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );
	float dotNH = saturate( dot( geometry.normal, halfDir ) );
	float dotLH = saturate( dot( incidentLight.direction, halfDir ) );
	vec3 F = F_Schlick( specularColor, dotLH );
	float G = G_BlinnPhong_Implicit( );
	float D = D_BlinnPhong( shininess, dotNH );
	return F * ( G * D );
}
float GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {
	return ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );
}
float BlinnExponentToGGXRoughness( const in float blinnExponent ) {
	return sqrt( 2.0 / ( blinnExponent + 2.0 ) );
}
#if defined( USE_SHEEN )
float D_Charlie(float roughness, float NoH) {
	float invAlpha  = 1.0 / roughness;
	float cos2h = NoH * NoH;
	float sin2h = max(1.0 - cos2h, 0.0078125);	return (2.0 + invAlpha) * pow(sin2h, invAlpha * 0.5) / (2.0 * PI);
}
float V_Neubelt(float NoV, float NoL) {
	return saturate(1.0 / (4.0 * (NoL + NoV - NoL * NoV)));
}
vec3 BRDF_Specular_Sheen( const in float roughness, const in vec3 L, const in GeometricContext geometry, vec3 specularColor ) {
	vec3 N = geometry.normal;
	vec3 V = geometry.viewDir;
	vec3 H = normalize( V + L );
	float dotNH = saturate( dot( N, H ) );
	return specularColor * D_Charlie( roughness, dotNH ) * V_Neubelt( dot(N, V), dot(N, L) );
}
#endif`,r2=`#ifdef USE_BUMPMAP
	uniform sampler2D bumpMap;
	uniform float bumpScale;
	vec2 dHdxy_fwd() {
		vec2 dSTdx = dFdx( vUv );
		vec2 dSTdy = dFdy( vUv );
		float Hll = bumpScale * texture2D( bumpMap, vUv ).x;
		float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;
		float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;
		return vec2( dBx, dBy );
	}
	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {
		vec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );
		vec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );
		vec3 vN = surf_norm;
		vec3 R1 = cross( vSigmaY, vN );
		vec3 R2 = cross( vN, vSigmaX );
		float fDet = dot( vSigmaX, R1 );
		fDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );
		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
		return normalize( abs( fDet ) * surf_norm - vGrad );
	}
#endif`,s2=`#if NUM_CLIPPING_PLANES > 0
	vec4 plane;
	#pragma unroll_loop_start
	for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
		plane = clippingPlanes[ i ];
		if ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;
	}
	#pragma unroll_loop_end
	#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
		bool clipped = true;
		#pragma unroll_loop_start
		for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;
		}
		#pragma unroll_loop_end
		if ( clipped ) discard;
	#endif
#endif`,o2=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
	uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];
#endif`,a2=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
#endif`,c2=`#if NUM_CLIPPING_PLANES > 0
	vClipPosition = - mvPosition.xyz;
#endif`,l2=`#ifdef USE_COLOR
	diffuseColor.rgb *= vColor;
#endif`,h2=`#ifdef USE_COLOR
	varying vec3 vColor;
#endif`,u2=`#ifdef USE_COLOR
	varying vec3 vColor;
#endif`,d2=`#ifdef USE_COLOR
	vColor.xyz = color.xyz;
#endif`,f2=`#define PI 3.141592653589793
#define PI2 6.283185307179586
#define PI_HALF 1.5707963267948966
#define RECIPROCAL_PI 0.3183098861837907
#define RECIPROCAL_PI2 0.15915494309189535
#define EPSILON 1e-6
#ifndef saturate
#define saturate(a) clamp( a, 0.0, 1.0 )
#endif
#define whiteComplement(a) ( 1.0 - saturate( a ) )
float pow2( const in float x ) { return x*x; }
float pow3( const in float x ) { return x*x*x; }
float pow4( const in float x ) { float x2 = x*x; return x2*x2; }
float average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }
highp float rand( const in vec2 uv ) {
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
	return fract(sin(sn) * c);
}
#ifdef HIGH_PRECISION
	float precisionSafeLength( vec3 v ) { return length( v ); }
#else
	float max3( vec3 v ) { return max( max( v.x, v.y ), v.z ); }
	float precisionSafeLength( vec3 v ) {
		float maxComponent = max3( abs( v ) );
		return length( v / maxComponent ) * maxComponent;
	}
#endif
struct IncidentLight {
	vec3 color;
	vec3 direction;
	bool visible;
};
struct ReflectedLight {
	vec3 directDiffuse;
	vec3 directSpecular;
	vec3 indirectDiffuse;
	vec3 indirectSpecular;
};
struct GeometricContext {
	vec3 position;
	vec3 normal;
	vec3 viewDir;
#ifdef CLEARCOAT
	vec3 clearcoatNormal;
#endif
};
vec3 transformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );
}
vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
}
vec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {
	float distance = dot( planeNormal, point - pointOnPlane );
	return - distance * planeNormal + point;
}
float sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {
	return sign( dot( point - pointOnPlane, planeNormal ) );
}
vec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {
	return lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;
}
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
float linearToRelativeLuminance( const in vec3 color ) {
	vec3 weights = vec3( 0.2126, 0.7152, 0.0722 );
	return dot( weights, color.rgb );
}
bool isPerspectiveMatrix( mat4 m ) {
  return m[ 2 ][ 3 ] == - 1.0;
}
vec2 equirectUv( in vec3 dir ) {
	float u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;
	float v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;
	return vec2( u, v );
}`,p2=`#ifdef ENVMAP_TYPE_CUBE_UV
#define cubeUV_maxMipLevel 8.0
#define cubeUV_minMipLevel 4.0
#define cubeUV_maxTileSize 256.0
#define cubeUV_minTileSize 16.0
float getFace(vec3 direction) {
    vec3 absDirection = abs(direction);
    float face = -1.0;
    if (absDirection.x > absDirection.z) {
      if (absDirection.x > absDirection.y)
        face = direction.x > 0.0 ? 0.0 : 3.0;
      else
        face = direction.y > 0.0 ? 1.0 : 4.0;
    } else {
      if (absDirection.z > absDirection.y)
        face = direction.z > 0.0 ? 2.0 : 5.0;
      else
        face = direction.y > 0.0 ? 1.0 : 4.0;
    }
    return face;
}
vec2 getUV(vec3 direction, float face) {
    vec2 uv;
    if (face == 0.0) {
      uv = vec2(direction.z, direction.y) / abs(direction.x);    } else if (face == 1.0) {
      uv = vec2(-direction.x, -direction.z) / abs(direction.y);    } else if (face == 2.0) {
      uv = vec2(-direction.x, direction.y) / abs(direction.z);    } else if (face == 3.0) {
      uv = vec2(-direction.z, direction.y) / abs(direction.x);    } else if (face == 4.0) {
      uv = vec2(-direction.x, direction.z) / abs(direction.y);    } else {
      uv = vec2(direction.x, direction.y) / abs(direction.z);    }
    return 0.5 * (uv + 1.0);
}
vec3 bilinearCubeUV(sampler2D envMap, vec3 direction, float mipInt) {
  float face = getFace(direction);
  float filterInt = max(cubeUV_minMipLevel - mipInt, 0.0);
  mipInt = max(mipInt, cubeUV_minMipLevel);
  float faceSize = exp2(mipInt);
  float texelSize = 1.0 / (3.0 * cubeUV_maxTileSize);
  vec2 uv = getUV(direction, face) * (faceSize - 1.0);
  vec2 f = fract(uv);
  uv += 0.5 - f;
  if (face > 2.0) {
    uv.y += faceSize;
    face -= 3.0;
  }
  uv.x += face * faceSize;
  if(mipInt < cubeUV_maxMipLevel){
    uv.y += 2.0 * cubeUV_maxTileSize;
  }
  uv.y += filterInt * 2.0 * cubeUV_minTileSize;
  uv.x += 3.0 * max(0.0, cubeUV_maxTileSize - 2.0 * faceSize);
  uv *= texelSize;
  vec3 tl = envMapTexelToLinear(texture2D(envMap, uv)).rgb;
  uv.x += texelSize;
  vec3 tr = envMapTexelToLinear(texture2D(envMap, uv)).rgb;
  uv.y += texelSize;
  vec3 br = envMapTexelToLinear(texture2D(envMap, uv)).rgb;
  uv.x -= texelSize;
  vec3 bl = envMapTexelToLinear(texture2D(envMap, uv)).rgb;
  vec3 tm = mix(tl, tr, f.x);
  vec3 bm = mix(bl, br, f.x);
  return mix(tm, bm, f.y);
}
#define r0 1.0
#define v0 0.339
#define m0 -2.0
#define r1 0.8
#define v1 0.276
#define m1 -1.0
#define r4 0.4
#define v4 0.046
#define m4 2.0
#define r5 0.305
#define v5 0.016
#define m5 3.0
#define r6 0.21
#define v6 0.0038
#define m6 4.0
float roughnessToMip(float roughness) {
  float mip = 0.0;
  if (roughness >= r1) {
    mip = (r0 - roughness) * (m1 - m0) / (r0 - r1) + m0;
  } else if (roughness >= r4) {
    mip = (r1 - roughness) * (m4 - m1) / (r1 - r4) + m1;
  } else if (roughness >= r5) {
    mip = (r4 - roughness) * (m5 - m4) / (r4 - r5) + m4;
  } else if (roughness >= r6) {
    mip = (r5 - roughness) * (m6 - m5) / (r5 - r6) + m5;
  } else {
    mip = -2.0 * log2(1.16 * roughness);  }
  return mip;
}
vec4 textureCubeUV(sampler2D envMap, vec3 sampleDir, float roughness) {
  float mip = clamp(roughnessToMip(roughness), m0, cubeUV_maxMipLevel);
  float mipF = fract(mip);
  float mipInt = floor(mip);
  vec3 color0 = bilinearCubeUV(envMap, sampleDir, mipInt);
  if (mipF == 0.0) {
    return vec4(color0, 1.0);
  } else {
    vec3 color1 = bilinearCubeUV(envMap, sampleDir, mipInt + 1.0);
    return vec4(mix(color0, color1, mipF), 1.0);
  }
}
#endif`,m2=`vec3 transformedNormal = objectNormal;
#ifdef USE_INSTANCING
	mat3 m = mat3( instanceMatrix );
	transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );
	transformedNormal = m * transformedNormal;
#endif
transformedNormal = normalMatrix * transformedNormal;
#ifdef FLIP_SIDED
	transformedNormal = - transformedNormal;
#endif
#ifdef USE_TANGENT
	vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#ifdef FLIP_SIDED
		transformedTangent = - transformedTangent;
	#endif
#endif`,g2=`#ifdef USE_DISPLACEMENTMAP
	uniform sampler2D displacementMap;
	uniform float displacementScale;
	uniform float displacementBias;
#endif`,y2=`#ifdef USE_DISPLACEMENTMAP
	transformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );
#endif`,x2=`#ifdef USE_EMISSIVEMAP
	vec4 emissiveColor = texture2D( emissiveMap, vUv );
	emissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;
	totalEmissiveRadiance *= emissiveColor.rgb;
#endif`,b2=`#ifdef USE_EMISSIVEMAP
	uniform sampler2D emissiveMap;
#endif`,v2="gl_FragColor = linearToOutputTexel( gl_FragColor );",_2=`
vec4 LinearToLinear( in vec4 value ) {
	return value;
}
vec4 GammaToLinear( in vec4 value, in float gammaFactor ) {
	return vec4( pow( value.rgb, vec3( gammaFactor ) ), value.a );
}
vec4 LinearToGamma( in vec4 value, in float gammaFactor ) {
	return vec4( pow( value.rgb, vec3( 1.0 / gammaFactor ) ), value.a );
}
vec4 sRGBToLinear( in vec4 value ) {
	return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
}
vec4 LinearTosRGB( in vec4 value ) {
	return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );
}
vec4 RGBEToLinear( in vec4 value ) {
	return vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );
}
vec4 LinearToRGBE( in vec4 value ) {
	float maxComponent = max( max( value.r, value.g ), value.b );
	float fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );
	return vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );
}
vec4 RGBMToLinear( in vec4 value, in float maxRange ) {
	return vec4( value.rgb * value.a * maxRange, 1.0 );
}
vec4 LinearToRGBM( in vec4 value, in float maxRange ) {
	float maxRGB = max( value.r, max( value.g, value.b ) );
	float M = clamp( maxRGB / maxRange, 0.0, 1.0 );
	M = ceil( M * 255.0 ) / 255.0;
	return vec4( value.rgb / ( M * maxRange ), M );
}
vec4 RGBDToLinear( in vec4 value, in float maxRange ) {
	return vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );
}
vec4 LinearToRGBD( in vec4 value, in float maxRange ) {
	float maxRGB = max( value.r, max( value.g, value.b ) );
	float D = max( maxRange / maxRGB, 1.0 );
	D = clamp( floor( D ) / 255.0, 0.0, 1.0 );
	return vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );
}
const mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );
vec4 LinearToLogLuv( in vec4 value )  {
	vec3 Xp_Y_XYZp = cLogLuvM * value.rgb;
	Xp_Y_XYZp = max( Xp_Y_XYZp, vec3( 1e-6, 1e-6, 1e-6 ) );
	vec4 vResult;
	vResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;
	float Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;
	vResult.w = fract( Le );
	vResult.z = ( Le - ( floor( vResult.w * 255.0 ) ) / 255.0 ) / 255.0;
	return vResult;
}
const mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );
vec4 LogLuvToLinear( in vec4 value ) {
	float Le = value.z * 255.0 + value.w;
	vec3 Xp_Y_XYZp;
	Xp_Y_XYZp.y = exp2( ( Le - 127.0 ) / 2.0 );
	Xp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;
	Xp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;
	vec3 vRGB = cLogLuvInverseM * Xp_Y_XYZp.rgb;
	return vec4( max( vRGB, 0.0 ), 1.0 );
}`,w2=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vec3 cameraToFrag;
		
		if ( isOrthographic ) {
			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		}  else {
			cameraToFrag = normalize( vWorldPosition - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vec3 reflectVec = reflect( cameraToFrag, worldNormal );
		#else
			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );
		#endif
	#else
		vec3 reflectVec = vReflect;
	#endif
	#ifdef ENVMAP_TYPE_CUBE
		vec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );
	#elif defined( ENVMAP_TYPE_CUBE_UV )
		vec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );
	#elif defined( ENVMAP_TYPE_EQUIREC )
		reflectVec = normalize( reflectVec );
		vec2 sampleUV = equirectUv( reflectVec );
		vec4 envColor = texture2D( envMap, sampleUV );
	#else
		vec4 envColor = vec4( 0.0 );
	#endif
	#ifndef ENVMAP_TYPE_CUBE_UV
		envColor = envMapTexelToLinear( envColor );
	#endif
	#ifdef ENVMAP_BLENDING_MULTIPLY
		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_MIX )
		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_ADD )
		outgoingLight += envColor.xyz * specularStrength * reflectivity;
	#endif
#endif`,S2=`#ifdef USE_ENVMAP
	uniform float envMapIntensity;
	uniform float flipEnvMap;
	uniform int maxMipLevel;
	#ifdef ENVMAP_TYPE_CUBE
		uniform samplerCube envMap;
	#else
		uniform sampler2D envMap;
	#endif
	
#endif`,M2=`#ifdef USE_ENVMAP
	uniform float reflectivity;
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif
#endif`,A2=`#ifdef USE_ENVMAP
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		
		varying vec3 vWorldPosition;
	#else
		varying vec3 vReflect;
		uniform float refractionRatio;
	#endif
#endif`,C2=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vWorldPosition = worldPosition.xyz;
	#else
		vec3 cameraToVertex;
		if ( isOrthographic ) { 
			cameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToVertex = normalize( worldPosition.xyz - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vReflect = reflect( cameraToVertex, worldNormal );
		#else
			vReflect = refract( cameraToVertex, worldNormal, refractionRatio );
		#endif
	#endif
#endif`,T2=`#ifdef USE_FOG
	fogDepth = -mvPosition.z;
#endif`,P2=`#ifdef USE_FOG
	varying float fogDepth;
#endif`,E2=`#ifdef USE_FOG
	#ifdef FOG_EXP2
		float fogFactor = 1.0 - exp( - fogDensity * fogDensity * fogDepth * fogDepth );
	#else
		float fogFactor = smoothstep( fogNear, fogFar, fogDepth );
	#endif
	gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );
#endif`,I2=`#ifdef USE_FOG
	uniform vec3 fogColor;
	varying float fogDepth;
	#ifdef FOG_EXP2
		uniform float fogDensity;
	#else
		uniform float fogNear;
		uniform float fogFar;
	#endif
#endif`,L2=`#ifdef USE_GRADIENTMAP
	uniform sampler2D gradientMap;
#endif
vec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {
	float dotNL = dot( normal, lightDirection );
	vec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );
	#ifdef USE_GRADIENTMAP
		return texture2D( gradientMap, coord ).rgb;
	#else
		return ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );
	#endif
}`,R2=`#ifdef USE_LIGHTMAP
	vec4 lightMapTexel= texture2D( lightMap, vUv2 );
	reflectedLight.indirectDiffuse += PI * lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
#endif`,D2=`#ifdef USE_LIGHTMAP
	uniform sampler2D lightMap;
	uniform float lightMapIntensity;
#endif`,B2=`vec3 diffuse = vec3( 1.0 );
GeometricContext geometry;
geometry.position = mvPosition.xyz;
geometry.normal = normalize( transformedNormal );
geometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );
GeometricContext backGeometry;
backGeometry.position = geometry.position;
backGeometry.normal = -geometry.normal;
backGeometry.viewDir = geometry.viewDir;
vLightFront = vec3( 0.0 );
vIndirectFront = vec3( 0.0 );
#ifdef DOUBLE_SIDED
	vLightBack = vec3( 0.0 );
	vIndirectBack = vec3( 0.0 );
#endif
IncidentLight directLight;
float dotNL;
vec3 directLightColor_Diffuse;
vIndirectFront += getAmbientLightIrradiance( ambientLightColor );
vIndirectFront += getLightProbeIrradiance( lightProbe, geometry );
#ifdef DOUBLE_SIDED
	vIndirectBack += getAmbientLightIrradiance( ambientLightColor );
	vIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry );
#endif
#if NUM_POINT_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		getPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = PI * directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( -dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_SPOT_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		getSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = PI * directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( -dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_DIR_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		getDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );
		dotNL = dot( geometry.normal, directLight.direction );
		directLightColor_Diffuse = PI * directLight.color;
		vLightFront += saturate( dotNL ) * directLightColor_Diffuse;
		#ifdef DOUBLE_SIDED
			vLightBack += saturate( -dotNL ) * directLightColor_Diffuse;
		#endif
	}
	#pragma unroll_loop_end
#endif
#if NUM_HEMI_LIGHTS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
		vIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );
		#ifdef DOUBLE_SIDED
			vIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );
		#endif
	}
	#pragma unroll_loop_end
#endif`,O2=`uniform bool receiveShadow;
uniform vec3 ambientLightColor;
uniform vec3 lightProbe[ 9 ];
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {
	float x = normal.x, y = normal.y, z = normal.z;
	vec3 result = shCoefficients[ 0 ] * 0.886227;
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );
	return result;
}
vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in GeometricContext geometry ) {
	vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );
	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );
	return irradiance;
}
vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {
	vec3 irradiance = ambientLightColor;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		irradiance *= PI;
	#endif
	return irradiance;
}
#if NUM_DIR_LIGHTS > 0
	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};
	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];
	void getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {
		directLight.color = directionalLight.color;
		directLight.direction = directionalLight.direction;
		directLight.visible = true;
	}
#endif
#if NUM_POINT_LIGHTS > 0
	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};
	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];
	void getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {
		vec3 lVector = pointLight.position - geometry.position;
		directLight.direction = normalize( lVector );
		float lightDistance = length( lVector );
		directLight.color = pointLight.color;
		directLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );
		directLight.visible = ( directLight.color != vec3( 0.0 ) );
	}
#endif
#if NUM_SPOT_LIGHTS > 0
	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};
	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];
	void getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {
		vec3 lVector = spotLight.position - geometry.position;
		directLight.direction = normalize( lVector );
		float lightDistance = length( lVector );
		float angleCos = dot( directLight.direction, spotLight.direction );
		if ( angleCos > spotLight.coneCos ) {
			float spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );
			directLight.color = spotLight.color;
			directLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );
			directLight.visible = true;
		} else {
			directLight.color = vec3( 0.0 );
			directLight.visible = false;
		}
	}
#endif
#if NUM_RECT_AREA_LIGHTS > 0
	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};
	uniform sampler2D ltc_1;	uniform sampler2D ltc_2;
	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];
#endif
#if NUM_HEMI_LIGHTS > 0
	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};
	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];
	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {
		float dotNL = dot( geometry.normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;
		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );
		#ifndef PHYSICALLY_CORRECT_LIGHTS
			irradiance *= PI;
		#endif
		return irradiance;
	}
#endif`,k2=`#if defined( USE_ENVMAP )
	#ifdef ENVMAP_MODE_REFRACTION
		uniform float refractionRatio;
	#endif
	vec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {
		vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );
		#ifdef ENVMAP_TYPE_CUBE
			vec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );
			#ifdef TEXTURE_LOD_EXT
				vec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );
			#else
				vec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );
			#endif
			envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;
		#elif defined( ENVMAP_TYPE_CUBE_UV )
			vec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );
		#else
			vec4 envMapColor = vec4( 0.0 );
		#endif
		return PI * envMapColor.rgb * envMapIntensity;
	}
	float getSpecularMIPLevel( const in float roughness, const in int maxMIPLevel ) {
		float maxMIPLevelScalar = float( maxMIPLevel );
		float sigma = PI * roughness * roughness / ( 1.0 + roughness );
		float desiredMIPLevel = maxMIPLevelScalar + log2( sigma );
		return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );
	}
	vec3 getLightProbeIndirectRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in int maxMIPLevel ) {
		#ifdef ENVMAP_MODE_REFLECTION
		  vec3 reflectVec = reflect( -viewDir, normal );
		  reflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );
		#else
		  vec3 reflectVec = refract( -viewDir, normal, refractionRatio );
		#endif
		reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
		float specularMIPLevel = getSpecularMIPLevel( roughness, maxMIPLevel );
		#ifdef ENVMAP_TYPE_CUBE
			vec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );
			#ifdef TEXTURE_LOD_EXT
				vec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );
			#else
				vec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );
			#endif
			envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;
		#elif defined( ENVMAP_TYPE_CUBE_UV )
			vec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );
		#elif defined( ENVMAP_TYPE_EQUIREC )
			vec2 sampleUV = equirectUv( reflectVec );
			#ifdef TEXTURE_LOD_EXT
				vec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );
			#else
				vec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );
			#endif
			envMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;
		#endif
		return envMapColor.rgb * envMapIntensity;
	}
#endif`,F2=`ToonMaterial material;
material.diffuseColor = diffuseColor.rgb;`,N2=`varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
struct ToonMaterial {
	vec3	diffuseColor;
};
void RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	vec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		irradiance *= PI;
	#endif
	reflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Toon
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Toon
#define Material_LightProbeLOD( material )	(0)`,z2=`BlinnPhongMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularColor = specular;
material.specularShininess = shininess;
material.specularStrength = specularStrength;`,G2=`varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
struct BlinnPhongMaterial {
	vec3	diffuseColor;
	vec3	specularColor;
	float	specularShininess;
	float	specularStrength;
};
void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometry.normal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		irradiance *= PI;
	#endif
	reflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
	reflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;
}
void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong
#define Material_LightProbeLOD( material )	(0)`,U2=`PhysicalMaterial material;
material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );
vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );
float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );
material.specularRoughness = max( roughnessFactor, 0.0525 );material.specularRoughness += geometryRoughness;
material.specularRoughness = min( material.specularRoughness, 1.0 );
#ifdef REFLECTIVITY
	material.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );
#else
	material.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );
#endif
#ifdef CLEARCOAT
	material.clearcoat = clearcoat;
	material.clearcoatRoughness = clearcoatRoughness;
	#ifdef USE_CLEARCOATMAP
		material.clearcoat *= texture2D( clearcoatMap, vUv ).x;
	#endif
	#ifdef USE_CLEARCOAT_ROUGHNESSMAP
		material.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;
	#endif
	material.clearcoat = saturate( material.clearcoat );	material.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );
	material.clearcoatRoughness += geometryRoughness;
	material.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );
#endif
#ifdef USE_SHEEN
	material.sheenColor = sheen;
#endif`,V2=`struct PhysicalMaterial {
	vec3	diffuseColor;
	float	specularRoughness;
	vec3	specularColor;
#ifdef CLEARCOAT
	float clearcoat;
	float clearcoatRoughness;
#endif
#ifdef USE_SHEEN
	vec3 sheenColor;
#endif
};
#define MAXIMUM_SPECULAR_COEFFICIENT 0.16
#define DEFAULT_SPECULAR_COEFFICIENT 0.04
float clearcoatDHRApprox( const in float roughness, const in float dotNL ) {
	return DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );
}
#if NUM_RECT_AREA_LIGHTS > 0
	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
		vec3 normal = geometry.normal;
		vec3 viewDir = geometry.viewDir;
		vec3 position = geometry.position;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.specularRoughness;
		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight;		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;
		vec2 uv = LTC_Uv( normal, viewDir, roughness );
		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );
		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(    0, 1,    0 ),
			vec3( t1.z, 0, t1.w )
		);
		vec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );
		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );
		reflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );
	}
#endif
void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometry.normal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		irradiance *= PI;
	#endif
	#ifdef CLEARCOAT
		float ccDotNL = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );
		vec3 ccIrradiance = ccDotNL * directLight.color;
		#ifndef PHYSICALLY_CORRECT_LIGHTS
			ccIrradiance *= PI;
		#endif
		float clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );
		reflectedLight.directSpecular += ccIrradiance * material.clearcoat * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );
	#else
		float clearcoatDHR = 0.0;
	#endif
	#ifdef USE_SHEEN
		reflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_Sheen(
			material.specularRoughness,
			directLight.direction,
			geometry,
			material.sheenColor
		);
	#else
		reflectedLight.directSpecular += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry.viewDir, geometry.normal, material.specularColor, material.specularRoughness);
	#endif
	reflectedLight.directDiffuse += ( 1.0 - clearcoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
}
void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
	#ifdef CLEARCOAT
		float ccDotNV = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );
		reflectedLight.indirectSpecular += clearcoatRadiance * material.clearcoat * BRDF_Specular_GGX_Environment( geometry.viewDir, geometry.clearcoatNormal, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearcoatRoughness );
		float ccDotNL = ccDotNV;
		float clearcoatDHR = material.clearcoat * clearcoatDHRApprox( material.clearcoatRoughness, ccDotNL );
	#else
		float clearcoatDHR = 0.0;
	#endif
	float clearcoatInv = 1.0 - clearcoatDHR;
	vec3 singleScattering = vec3( 0.0 );
	vec3 multiScattering = vec3( 0.0 );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;
	BRDF_Specular_Multiscattering_Environment( geometry, material.specularColor, material.specularRoughness, singleScattering, multiScattering );
	vec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );
	reflectedLight.indirectSpecular += clearcoatInv * radiance * singleScattering;
	reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;
	reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;
}
#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {
	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );
}`,H2=`
GeometricContext geometry;
geometry.position = - vViewPosition;
geometry.normal = normal;
geometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );
#ifdef CLEARCOAT
	geometry.clearcoatNormal = clearcoatNormal;
#endif
IncidentLight directLight;
#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )
	PointLight pointLight;
	#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		pointLight = pointLights[ i ];
		getPointDirectLightIrradiance( pointLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )
		pointLightShadow = pointLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )
	SpotLight spotLight;
	#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		spotLight = spotLights[ i ];
		getSpotDirectLightIrradiance( spotLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		spotLightShadow = spotLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )
	DirectionalLight directionalLight;
	#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		directionalLight = directionalLights[ i ];
		getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )
		directionalLightShadow = directionalLightShadows[ i ];
		directLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )
	RectAreaLight rectAreaLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {
		rectAreaLight = rectAreaLights[ i ];
		RE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if defined( RE_IndirectDiffuse )
	vec3 iblIrradiance = vec3( 0.0 );
	vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );
	irradiance += getLightProbeIrradiance( lightProbe, geometry );
	#if ( NUM_HEMI_LIGHTS > 0 )
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
			irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );
		}
		#pragma unroll_loop_end
	#endif
#endif
#if defined( RE_IndirectSpecular )
	vec3 radiance = vec3( 0.0 );
	vec3 clearcoatRadiance = vec3( 0.0 );
#endif`,$2=`#if defined( RE_IndirectDiffuse )
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel= texture2D( lightMap, vUv2 );
		vec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
		#ifndef PHYSICALLY_CORRECT_LIGHTS
			lightMapIrradiance *= PI;
		#endif
		irradiance += lightMapIrradiance;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )
		iblIrradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );
	#endif
#endif
#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )
	radiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.normal, material.specularRoughness, maxMipLevel );
	#ifdef CLEARCOAT
		clearcoatRadiance += getLightProbeIndirectRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, maxMipLevel );
	#endif
#endif`,W2=`#if defined( RE_IndirectDiffuse )
	RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );
#endif
#if defined( RE_IndirectSpecular )
	RE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );
#endif`,j2=`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	gl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;
#endif`,q2=`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	uniform float logDepthBufFC;
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,X2=`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		varying float vFragDepth;
		varying float vIsPerspective;
	#else
		uniform float logDepthBufFC;
	#endif
#endif`,Y2=`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		vFragDepth = 1.0 + gl_Position.w;
		vIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );
	#else
		if ( isPerspectiveMatrix( projectionMatrix ) ) {
			gl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;
			gl_Position.z *= gl_Position.w;
		}
	#endif
#endif`,Z2=`#ifdef USE_MAP
	vec4 texelColor = texture2D( map, vUv );
	texelColor = mapTexelToLinear( texelColor );
	diffuseColor *= texelColor;
#endif`,K2=`#ifdef USE_MAP
	uniform sampler2D map;
#endif`,J2=`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	vec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;
#endif
#ifdef USE_MAP
	vec4 mapTexel = texture2D( map, uv );
	diffuseColor *= mapTexelToLinear( mapTexel );
#endif
#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, uv ).g;
#endif`,Q2=`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	uniform mat3 uvTransform;
#endif
#ifdef USE_MAP
	uniform sampler2D map;
#endif
#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,ew=`float metalnessFactor = metalness;
#ifdef USE_METALNESSMAP
	vec4 texelMetalness = texture2D( metalnessMap, vUv );
	metalnessFactor *= texelMetalness.b;
#endif`,tw=`#ifdef USE_METALNESSMAP
	uniform sampler2D metalnessMap;
#endif`,nw=`#ifdef USE_MORPHNORMALS
	objectNormal *= morphTargetBaseInfluence;
	objectNormal += morphNormal0 * morphTargetInfluences[ 0 ];
	objectNormal += morphNormal1 * morphTargetInfluences[ 1 ];
	objectNormal += morphNormal2 * morphTargetInfluences[ 2 ];
	objectNormal += morphNormal3 * morphTargetInfluences[ 3 ];
#endif`,iw=`#ifdef USE_MORPHTARGETS
	uniform float morphTargetBaseInfluence;
	#ifndef USE_MORPHNORMALS
	uniform float morphTargetInfluences[ 8 ];
	#else
	uniform float morphTargetInfluences[ 4 ];
	#endif
#endif`,rw=`#ifdef USE_MORPHTARGETS
	transformed *= morphTargetBaseInfluence;
	transformed += morphTarget0 * morphTargetInfluences[ 0 ];
	transformed += morphTarget1 * morphTargetInfluences[ 1 ];
	transformed += morphTarget2 * morphTargetInfluences[ 2 ];
	transformed += morphTarget3 * morphTargetInfluences[ 3 ];
	#ifndef USE_MORPHNORMALS
	transformed += morphTarget4 * morphTargetInfluences[ 4 ];
	transformed += morphTarget5 * morphTargetInfluences[ 5 ];
	transformed += morphTarget6 * morphTargetInfluences[ 6 ];
	transformed += morphTarget7 * morphTargetInfluences[ 7 ];
	#endif
#endif`,sw=`#ifdef FLAT_SHADED
	vec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );
	vec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );
	vec3 normal = normalize( cross( fdx, fdy ) );
#else
	vec3 normal = normalize( vNormal );
	#ifdef DOUBLE_SIDED
		normal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );
	#endif
	#ifdef USE_TANGENT
		vec3 tangent = normalize( vTangent );
		vec3 bitangent = normalize( vBitangent );
		#ifdef DOUBLE_SIDED
			tangent = tangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );
			bitangent = bitangent * ( float( gl_FrontFacing ) * 2.0 - 1.0 );
		#endif
		#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )
			mat3 vTBN = mat3( tangent, bitangent, normal );
		#endif
	#endif
#endif
vec3 geometryNormal = normal;`,ow=`#ifdef OBJECTSPACE_NORMALMAP
	normal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
	#ifdef FLIP_SIDED
		normal = - normal;
	#endif
	#ifdef DOUBLE_SIDED
		normal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );
	#endif
	normal = normalize( normalMatrix * normal );
#elif defined( TANGENTSPACE_NORMALMAP )
	vec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;
	mapN.xy *= normalScale;
	#ifdef USE_TANGENT
		normal = normalize( vTBN * mapN );
	#else
		normal = perturbNormal2Arb( -vViewPosition, normal, mapN );
	#endif
#elif defined( USE_BUMPMAP )
	normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );
#endif`,aw=`#ifdef USE_NORMALMAP
	uniform sampler2D normalMap;
	uniform vec2 normalScale;
#endif
#ifdef OBJECTSPACE_NORMALMAP
	uniform mat3 normalMatrix;
#endif
#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )
	vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN ) {
		vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );
		vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );
		vec2 st0 = dFdx( vUv.st );
		vec2 st1 = dFdy( vUv.st );
		float scale = sign( st1.t * st0.s - st0.t * st1.s );
		vec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );
		vec3 T = normalize( ( - q0 * st1.s + q1 * st0.s ) * scale );
		vec3 N = normalize( surf_norm );
		mat3 tsn = mat3( S, T, N );
		mapN.xy *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );
		return normalize( tsn * mapN );
	}
#endif`,cw=`#ifdef CLEARCOAT
	vec3 clearcoatNormal = geometryNormal;
#endif`,lw=`#ifdef USE_CLEARCOAT_NORMALMAP
	vec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;
	clearcoatMapN.xy *= clearcoatNormalScale;
	#ifdef USE_TANGENT
		clearcoatNormal = normalize( vTBN * clearcoatMapN );
	#else
		clearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN );
	#endif
#endif`,hw=`#ifdef USE_CLEARCOATMAP
	uniform sampler2D clearcoatMap;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform sampler2D clearcoatRoughnessMap;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform sampler2D clearcoatNormalMap;
	uniform vec2 clearcoatNormalScale;
#endif`,uw=`vec3 packNormalToRGB( const in vec3 normal ) {
	return normalize( normal ) * 0.5 + 0.5;
}
vec3 unpackRGBToNormal( const in vec3 rgb ) {
	return 2.0 * rgb.xyz - 1.0;
}
const float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;
const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );
const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );
const float ShiftRight8 = 1. / 256.;
vec4 packDepthToRGBA( const in float v ) {
	vec4 r = vec4( fract( v * PackFactors ), v );
	r.yzw -= r.xyz * ShiftRight8;	return r * PackUpscale;
}
float unpackRGBAToDepth( const in vec4 v ) {
	return dot( v, UnpackFactors );
}
vec4 pack2HalfToRGBA( vec2 v ) {
	vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ));
	return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w);
}
vec2 unpackRGBATo2Half( vec4 v ) {
	return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );
}
float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
	return ( viewZ + near ) / ( near - far );
}
float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {
	return linearClipZ * ( near - far ) - near;
}
float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
	return (( near + viewZ ) * far ) / (( far - near ) * viewZ );
}
float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {
	return ( near * far ) / ( ( far - near ) * invClipZ - far );
}`,dw=`#ifdef PREMULTIPLIED_ALPHA
	gl_FragColor.rgb *= gl_FragColor.a;
#endif`,fw=`vec4 mvPosition = vec4( transformed, 1.0 );
#ifdef USE_INSTANCING
	mvPosition = instanceMatrix * mvPosition;
#endif
mvPosition = modelViewMatrix * mvPosition;
gl_Position = projectionMatrix * mvPosition;`,pw=`#ifdef DITHERING
	gl_FragColor.rgb = dithering( gl_FragColor.rgb );
#endif`,mw=`#ifdef DITHERING
	vec3 dithering( vec3 color ) {
		float grid_position = rand( gl_FragCoord.xy );
		vec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );
		dither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );
		return color + dither_shift_RGB;
	}
#endif`,gw=`float roughnessFactor = roughness;
#ifdef USE_ROUGHNESSMAP
	vec4 texelRoughness = texture2D( roughnessMap, vUv );
	roughnessFactor *= texelRoughness.g;
#endif`,yw=`#ifdef USE_ROUGHNESSMAP
	uniform sampler2D roughnessMap;
#endif`,xw=`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];
		varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {
		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );
	}
	vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {
		return unpackRGBATo2Half( texture2D( shadow, uv ) );
	}
	float VSMShadow (sampler2D shadow, vec2 uv, float compare ){
		float occlusion = 1.0;
		vec2 distribution = texture2DDistribution( shadow, uv );
		float hard_shadow = step( compare , distribution.x );
		if (hard_shadow != 1.0 ) {
			float distance = compare - distribution.x ;
			float variance = max( 0.00000, distribution.y * distribution.y );
			float softness_probability = variance / (variance + distance * distance );			softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );			occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );
		}
		return occlusion;
	}
	float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
		float shadow = 1.0;
		shadowCoord.xyz /= shadowCoord.w;
		shadowCoord.z += shadowBias;
		bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );
		bool inFrustum = all( inFrustumVec );
		bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );
		bool frustumTest = all( frustumTestVec );
		if ( frustumTest ) {
		#if defined( SHADOWMAP_TYPE_PCF )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx0 = - texelSize.x * shadowRadius;
			float dy0 = - texelSize.y * shadowRadius;
			float dx1 = + texelSize.x * shadowRadius;
			float dy1 = + texelSize.y * shadowRadius;
			float dx2 = dx0 / 2.0;
			float dy2 = dy0 / 2.0;
			float dx3 = dx1 / 2.0;
			float dy3 = dy1 / 2.0;
			shadow = (
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )
			) * ( 1.0 / 17.0 );
		#elif defined( SHADOWMAP_TYPE_PCF_SOFT )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx = texelSize.x;
			float dy = texelSize.y;
			vec2 uv = shadowCoord.xy;
			vec2 f = fract( uv * shadowMapSize + 0.5 );
			uv -= f * texelSize;
			shadow = (
				texture2DCompare( shadowMap, uv, shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), 
					 texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), 
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),
						  f.x ),
					 mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), 
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),
						  f.x ),
					 f.y )
			) * ( 1.0 / 9.0 );
		#elif defined( SHADOWMAP_TYPE_VSM )
			shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );
		#else
			shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );
		#endif
		}
		return shadow;
	}
	vec2 cubeToUV( vec3 v, float texelSizeY ) {
		vec3 absV = abs( v );
		float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );
		absV *= scaleToCube;
		v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );
		vec2 planar = v.xy;
		float almostATexel = 1.5 * texelSizeY;
		float almostOne = 1.0 - almostATexel;
		if ( absV.z >= almostOne ) {
			if ( v.z > 0.0 )
				planar.x = 4.0 - v.x;
		} else if ( absV.x >= almostOne ) {
			float signX = sign( v.x );
			planar.x = v.z * signX + 2.0 * signX;
		} else if ( absV.y >= almostOne ) {
			float signY = sign( v.y );
			planar.x = v.x + 2.0 * signY + 2.0;
			planar.y = v.z * signY - 2.0;
		}
		return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );
	}
	float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {
		vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );
		vec3 lightToPosition = shadowCoord.xyz;
		float dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );		dp += shadowBias;
		vec3 bd3D = normalize( lightToPosition );
		#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )
			vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;
			return (
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )
			) * ( 1.0 / 9.0 );
		#else
			return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );
		#endif
	}
#endif`,bw=`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];
		varying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
#endif`,vw=`#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0
		vec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		vec4 shadowWorldPosition;
	#endif
	#if NUM_DIR_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );
		vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );
		vSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );
		vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
	#endif
#endif`,_w=`float getShadowMask() {
	float shadow = 1.0;
	#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		directionalLight = directionalLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		spotLight = spotLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		pointLight = pointLightShadows[ i ];
		shadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#endif
	return shadow;
}`,ww=`#ifdef USE_SKINNING
	mat4 boneMatX = getBoneMatrix( skinIndex.x );
	mat4 boneMatY = getBoneMatrix( skinIndex.y );
	mat4 boneMatZ = getBoneMatrix( skinIndex.z );
	mat4 boneMatW = getBoneMatrix( skinIndex.w );
#endif`,Sw=`#ifdef USE_SKINNING
	uniform mat4 bindMatrix;
	uniform mat4 bindMatrixInverse;
	#ifdef BONE_TEXTURE
		uniform highp sampler2D boneTexture;
		uniform int boneTextureSize;
		mat4 getBoneMatrix( const in float i ) {
			float j = i * 4.0;
			float x = mod( j, float( boneTextureSize ) );
			float y = floor( j / float( boneTextureSize ) );
			float dx = 1.0 / float( boneTextureSize );
			float dy = 1.0 / float( boneTextureSize );
			y = dy * ( y + 0.5 );
			vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );
			vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );
			vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );
			vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );
			mat4 bone = mat4( v1, v2, v3, v4 );
			return bone;
		}
	#else
		uniform mat4 boneMatrices[ MAX_BONES ];
		mat4 getBoneMatrix( const in float i ) {
			mat4 bone = boneMatrices[ int(i) ];
			return bone;
		}
	#endif
#endif`,Mw=`#ifdef USE_SKINNING
	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );
	vec4 skinned = vec4( 0.0 );
	skinned += boneMatX * skinVertex * skinWeight.x;
	skinned += boneMatY * skinVertex * skinWeight.y;
	skinned += boneMatZ * skinVertex * skinWeight.z;
	skinned += boneMatW * skinVertex * skinWeight.w;
	transformed = ( bindMatrixInverse * skinned ).xyz;
#endif`,Aw=`#ifdef USE_SKINNING
	mat4 skinMatrix = mat4( 0.0 );
	skinMatrix += skinWeight.x * boneMatX;
	skinMatrix += skinWeight.y * boneMatY;
	skinMatrix += skinWeight.z * boneMatZ;
	skinMatrix += skinWeight.w * boneMatW;
	skinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;
	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;
	#ifdef USE_TANGENT
		objectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#endif
#endif`,Cw=`float specularStrength;
#ifdef USE_SPECULARMAP
	vec4 texelSpecular = texture2D( specularMap, vUv );
	specularStrength = texelSpecular.r;
#else
	specularStrength = 1.0;
#endif`,Tw=`#ifdef USE_SPECULARMAP
	uniform sampler2D specularMap;
#endif`,Pw=`#if defined( TONE_MAPPING )
	gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );
#endif`,Ew=`#ifndef saturate
#define saturate(a) clamp( a, 0.0, 1.0 )
#endif
uniform float toneMappingExposure;
vec3 LinearToneMapping( vec3 color ) {
	return toneMappingExposure * color;
}
vec3 ReinhardToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	return saturate( color / ( vec3( 1.0 ) + color ) );
}
vec3 OptimizedCineonToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	color = max( vec3( 0.0 ), color - 0.004 );
	return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );
}
vec3 RRTAndODTFit( vec3 v ) {
	vec3 a = v * ( v + 0.0245786 ) - 0.000090537;
	vec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;
	return a / b;
}
vec3 ACESFilmicToneMapping( vec3 color ) {
	const mat3 ACESInputMat = mat3(
		vec3( 0.59719, 0.07600, 0.02840 ),		vec3( 0.35458, 0.90834, 0.13383 ),
		vec3( 0.04823, 0.01566, 0.83777 )
	);
	const mat3 ACESOutputMat = mat3(
		vec3(  1.60475, -0.10208, -0.00327 ),		vec3( -0.53108,  1.10813, -0.07276 ),
		vec3( -0.07367, -0.00605,  1.07602 )
	);
	color *= toneMappingExposure / 0.6;
	color = ACESInputMat * color;
	color = RRTAndODTFit( color );
	color = ACESOutputMat * color;
	return saturate( color );
}
vec3 CustomToneMapping( vec3 color ) { return color; }`,Iw=`#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )
	varying vec2 vUv;
#endif`,Lw=`#ifdef USE_UV
	#ifdef UVS_VERTEX_ONLY
		vec2 vUv;
	#else
		varying vec2 vUv;
	#endif
	uniform mat3 uvTransform;
#endif`,Rw=`#ifdef USE_UV
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
#endif`,Dw=`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	varying vec2 vUv2;
#endif`,Bw=`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	attribute vec2 uv2;
	varying vec2 vUv2;
	uniform mat3 uv2Transform;
#endif`,Ow=`#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )
	vUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;
#endif`,kw=`#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )
	vec4 worldPosition = vec4( transformed, 1.0 );
	#ifdef USE_INSTANCING
		worldPosition = instanceMatrix * worldPosition;
	#endif
	worldPosition = modelMatrix * worldPosition;
#endif`,Fw=`uniform sampler2D t2D;
varying vec2 vUv;
void main() {
	vec4 texColor = texture2D( t2D, vUv );
	gl_FragColor = mapTexelToLinear( texColor );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,Nw=`varying vec2 vUv;
uniform mat3 uvTransform;
void main() {
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	gl_Position = vec4( position.xy, 1.0, 1.0 );
}`,zw=`#include <envmap_common_pars_fragment>
uniform float opacity;
varying vec3 vWorldDirection;
#include <cube_uv_reflection_fragment>
void main() {
	vec3 vReflect = vWorldDirection;
	#include <envmap_fragment>
	gl_FragColor = envColor;
	gl_FragColor.a *= opacity;
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,Gw=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,Uw=`#if DEPTH_PACKING == 3200
	uniform float opacity;
#endif
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
varying vec2 vHighPrecisionZW;
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#if DEPTH_PACKING == 3200
		diffuseColor.a = opacity;
	#endif
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <logdepthbuf_fragment>
	float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;
	#if DEPTH_PACKING == 3200
		gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );
	#elif DEPTH_PACKING == 3201
		gl_FragColor = packDepthToRGBA( fragCoordZ );
	#endif
}`,Vw=`#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec2 vHighPrecisionZW;
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vHighPrecisionZW = gl_Position.zw;
}`,Hw=`#define DISTANCE
uniform vec3 referencePosition;
uniform float nearDistance;
uniform float farDistance;
varying vec3 vWorldPosition;
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <clipping_planes_pars_fragment>
void main () {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	float dist = length( vWorldPosition - referencePosition );
	dist = ( dist - nearDistance ) / ( farDistance - nearDistance );
	dist = saturate( dist );
	gl_FragColor = packDepthToRGBA( dist );
}`,$w=`#define DISTANCE
varying vec3 vWorldPosition;
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>
	vWorldPosition = worldPosition.xyz;
}`,Ww=`uniform sampler2D tEquirect;
varying vec3 vWorldDirection;
#include <common>
void main() {
	vec3 direction = normalize( vWorldDirection );
	vec2 sampleUV = equirectUv( direction );
	vec4 texColor = texture2D( tEquirect, sampleUV );
	gl_FragColor = mapTexelToLinear( texColor );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
}`,jw=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
}`,qw=`uniform vec3 diffuse;
uniform float opacity;
uniform float dashSize;
uniform float totalSize;
varying float vLineDistance;
#include <common>
#include <color_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	if ( mod( vLineDistance, totalSize ) > dashSize ) {
		discard;
	}
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <color_fragment>
	outgoingLight = diffuseColor.rgb;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,Xw=`uniform float scale;
attribute float lineDistance;
varying float vLineDistance;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	vLineDistance = scale * lineDistance;
	#include <color_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,Yw=`uniform vec3 diffuse;
uniform float opacity;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	#ifdef USE_LIGHTMAP
	
		vec4 lightMapTexel= texture2D( lightMap, vUv2 );
		reflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;
	#else
		reflectedLight.indirectDiffuse += vec3( 1.0 );
	#endif
	#include <aomap_fragment>
	reflectedLight.indirectDiffuse *= diffuseColor.rgb;
	vec3 outgoingLight = reflectedLight.indirectDiffuse;
	#include <envmap_fragment>
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Zw=`#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <skinbase_vertex>
	#ifdef USE_ENVMAP
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>
}`,Kw=`uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
varying vec3 vLightFront;
varying vec3 vIndirectFront;
#ifdef DOUBLE_SIDED
	varying vec3 vLightBack;
	varying vec3 vIndirectBack;
#endif
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <fog_pars_fragment>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	#include <emissivemap_fragment>
	#ifdef DOUBLE_SIDED
		reflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;
	#else
		reflectedLight.indirectDiffuse += vIndirectFront;
	#endif
	#include <lightmap_fragment>
	reflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );
	#ifdef DOUBLE_SIDED
		reflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;
	#else
		reflectedLight.directDiffuse = vLightFront;
	#endif
	reflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <envmap_fragment>
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Jw=`#define LAMBERT
varying vec3 vLightFront;
varying vec3 vIndirectFront;
#ifdef DOUBLE_SIDED
	varying vec3 vLightBack;
	varying vec3 vIndirectBack;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <envmap_pars_vertex>
#include <bsdfs>
#include <lights_pars_begin>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <lights_lambert_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,Qw=`#define MATCAP
uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D matcap;
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <fog_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;
	#ifdef USE_MATCAP
		vec4 matcapColor = texture2D( matcap, uv );
		matcapColor = matcapTexelToLinear( matcapColor );
	#else
		vec4 matcapColor = vec4( 1.0 );
	#endif
	vec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,e3=`#define MATCAP
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <displacementmap_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#ifndef FLAT_SHADED
		vNormal = normalize( transformedNormal );
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
	vViewPosition = - mvPosition.xyz;
}`,t3=`#define TOON
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <gradientmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <lights_toon_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_toon_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,n3=`#define TOON
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,i3=`#define PHONG
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 specular;
uniform float shininess;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <cube_uv_reflection_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <lights_phong_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_phong_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
	#include <envmap_fragment>
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,r3=`#define PHONG
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,s3=`#define STANDARD
#ifdef PHYSICAL
	#define REFLECTIVITY
	#define CLEARCOAT
	#define TRANSPARENCY
#endif
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;
#ifdef TRANSPARENCY
	uniform float transparency;
#endif
#ifdef REFLECTIVITY
	uniform float reflectivity;
#endif
#ifdef CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif
#ifdef USE_SHEEN
	uniform vec3 sheen;
#endif
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <uv2_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <bsdfs>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <lights_physical_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
	#ifdef TRANSPARENCY
		diffuseColor.a *= saturate( 1. - transparency + linearToRelativeLuminance( reflectedLight.directSpecular + reflectedLight.indirectSpecular ) );
	#endif
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,o3=`#define STANDARD
varying vec3 vViewPosition;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#include <common>
#include <uv_pars_vertex>
#include <uv2_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <uv2_vertex>
	#include <color_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,a3=`#define NORMAL
uniform float opacity;
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	varying vec3 vViewPosition;
#endif
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#include <packing>
#include <uv_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	gl_FragColor = vec4( packNormalToRGB( normal ), opacity );
}`,c3=`#define NORMAL
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	varying vec3 vViewPosition;
#endif
#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )
	vViewPosition = - mvPosition.xyz;
#endif
}`,l3=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <color_pars_fragment>
#include <map_particle_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_particle_fragment>
	#include <color_fragment>
	#include <alphatest_fragment>
	outgoingLight = diffuseColor.rgb;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,h3=`uniform float size;
uniform float scale;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <color_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	gl_PointSize = size;
	#ifdef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );
	#endif
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <fog_vertex>
}`,u3=`uniform vec3 color;
uniform float opacity;
#include <common>
#include <packing>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
void main() {
	gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
}`,d3=`#include <common>
#include <fog_pars_vertex>
#include <shadowmap_pars_vertex>
void main() {
	#include <begin_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,f3=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	outgoingLight = diffuseColor.rgb;
	gl_FragColor = vec4( outgoingLight, diffuseColor.a );
	#include <tonemapping_fragment>
	#include <encodings_fragment>
	#include <fog_fragment>
}`,p3=`uniform float rotation;
uniform vec2 center;
#include <common>
#include <uv_pars_vertex>
#include <fog_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec2 scale;
	scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
	scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );
	#ifndef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) scale *= - mvPosition.z;
	#endif
	vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;
	vec2 rotatedPosition;
	rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
	rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
	mvPosition.xy += rotatedPosition;
	gl_Position = projectionMatrix * mvPosition;
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`;const _t={alphamap_fragment:Z_,alphamap_pars_fragment:K_,alphatest_fragment:J_,aomap_fragment:Q_,aomap_pars_fragment:e2,begin_vertex:t2,beginnormal_vertex:n2,bsdfs:i2,bumpmap_pars_fragment:r2,clipping_planes_fragment:s2,clipping_planes_pars_fragment:o2,clipping_planes_pars_vertex:a2,clipping_planes_vertex:c2,color_fragment:l2,color_pars_fragment:h2,color_pars_vertex:u2,color_vertex:d2,common:f2,cube_uv_reflection_fragment:p2,defaultnormal_vertex:m2,displacementmap_pars_vertex:g2,displacementmap_vertex:y2,emissivemap_fragment:x2,emissivemap_pars_fragment:b2,encodings_fragment:v2,encodings_pars_fragment:_2,envmap_fragment:w2,envmap_common_pars_fragment:S2,envmap_pars_fragment:M2,envmap_pars_vertex:A2,envmap_physical_pars_fragment:k2,envmap_vertex:C2,fog_vertex:T2,fog_pars_vertex:P2,fog_fragment:E2,fog_pars_fragment:I2,gradientmap_pars_fragment:L2,lightmap_fragment:R2,lightmap_pars_fragment:D2,lights_lambert_vertex:B2,lights_pars_begin:O2,lights_toon_fragment:F2,lights_toon_pars_fragment:N2,lights_phong_fragment:z2,lights_phong_pars_fragment:G2,lights_physical_fragment:U2,lights_physical_pars_fragment:V2,lights_fragment_begin:H2,lights_fragment_maps:$2,lights_fragment_end:W2,logdepthbuf_fragment:j2,logdepthbuf_pars_fragment:q2,logdepthbuf_pars_vertex:X2,logdepthbuf_vertex:Y2,map_fragment:Z2,map_pars_fragment:K2,map_particle_fragment:J2,map_particle_pars_fragment:Q2,metalnessmap_fragment:ew,metalnessmap_pars_fragment:tw,morphnormal_vertex:nw,morphtarget_pars_vertex:iw,morphtarget_vertex:rw,normal_fragment_begin:sw,normal_fragment_maps:ow,normalmap_pars_fragment:aw,clearcoat_normal_fragment_begin:cw,clearcoat_normal_fragment_maps:lw,clearcoat_pars_fragment:hw,packing:uw,premultiplied_alpha_fragment:dw,project_vertex:fw,dithering_fragment:pw,dithering_pars_fragment:mw,roughnessmap_fragment:gw,roughnessmap_pars_fragment:yw,shadowmap_pars_fragment:xw,shadowmap_pars_vertex:bw,shadowmap_vertex:vw,shadowmask_pars_fragment:_w,skinbase_vertex:ww,skinning_pars_vertex:Sw,skinning_vertex:Mw,skinnormal_vertex:Aw,specularmap_fragment:Cw,specularmap_pars_fragment:Tw,tonemapping_fragment:Pw,tonemapping_pars_fragment:Ew,uv_pars_fragment:Iw,uv_pars_vertex:Lw,uv_vertex:Rw,uv2_pars_fragment:Dw,uv2_pars_vertex:Bw,uv2_vertex:Ow,worldpos_vertex:kw,background_frag:Fw,background_vert:Nw,cube_frag:zw,cube_vert:Gw,depth_frag:Uw,depth_vert:Vw,distanceRGBA_frag:Hw,distanceRGBA_vert:$w,equirect_frag:Ww,equirect_vert:jw,linedashed_frag:qw,linedashed_vert:Xw,meshbasic_frag:Yw,meshbasic_vert:Zw,meshlambert_frag:Kw,meshlambert_vert:Jw,meshmatcap_frag:Qw,meshmatcap_vert:e3,meshtoon_frag:t3,meshtoon_vert:n3,meshphong_frag:i3,meshphong_vert:r3,meshphysical_frag:s3,meshphysical_vert:o3,normal_frag:a3,normal_vert:c3,points_frag:l3,points_vert:h3,shadow_frag:u3,shadow_vert:d3,sprite_frag:f3,sprite_vert:p3},ir={basic:{uniforms:Tn([He.common,He.specularmap,He.envmap,He.aomap,He.lightmap,He.fog]),vertexShader:_t.meshbasic_vert,fragmentShader:_t.meshbasic_frag},lambert:{uniforms:Tn([He.common,He.specularmap,He.envmap,He.aomap,He.lightmap,He.emissivemap,He.fog,He.lights,{emissive:{value:new ke(0)}}]),vertexShader:_t.meshlambert_vert,fragmentShader:_t.meshlambert_frag},phong:{uniforms:Tn([He.common,He.specularmap,He.envmap,He.aomap,He.lightmap,He.emissivemap,He.bumpmap,He.normalmap,He.displacementmap,He.fog,He.lights,{emissive:{value:new ke(0)},specular:{value:new ke(1118481)},shininess:{value:30}}]),vertexShader:_t.meshphong_vert,fragmentShader:_t.meshphong_frag},standard:{uniforms:Tn([He.common,He.envmap,He.aomap,He.lightmap,He.emissivemap,He.bumpmap,He.normalmap,He.displacementmap,He.roughnessmap,He.metalnessmap,He.fog,He.lights,{emissive:{value:new ke(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:_t.meshphysical_vert,fragmentShader:_t.meshphysical_frag},toon:{uniforms:Tn([He.common,He.aomap,He.lightmap,He.emissivemap,He.bumpmap,He.normalmap,He.displacementmap,He.gradientmap,He.fog,He.lights,{emissive:{value:new ke(0)}}]),vertexShader:_t.meshtoon_vert,fragmentShader:_t.meshtoon_frag},matcap:{uniforms:Tn([He.common,He.bumpmap,He.normalmap,He.displacementmap,He.fog,{matcap:{value:null}}]),vertexShader:_t.meshmatcap_vert,fragmentShader:_t.meshmatcap_frag},points:{uniforms:Tn([He.points,He.fog]),vertexShader:_t.points_vert,fragmentShader:_t.points_frag},dashed:{uniforms:Tn([He.common,He.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:_t.linedashed_vert,fragmentShader:_t.linedashed_frag},depth:{uniforms:Tn([He.common,He.displacementmap]),vertexShader:_t.depth_vert,fragmentShader:_t.depth_frag},normal:{uniforms:Tn([He.common,He.bumpmap,He.normalmap,He.displacementmap,{opacity:{value:1}}]),vertexShader:_t.normal_vert,fragmentShader:_t.normal_frag},sprite:{uniforms:Tn([He.sprite,He.fog]),vertexShader:_t.sprite_vert,fragmentShader:_t.sprite_frag},background:{uniforms:{uvTransform:{value:new An},t2D:{value:null}},vertexShader:_t.background_vert,fragmentShader:_t.background_frag},cube:{uniforms:Tn([He.envmap,{opacity:{value:1}}]),vertexShader:_t.cube_vert,fragmentShader:_t.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:_t.equirect_vert,fragmentShader:_t.equirect_frag},distanceRGBA:{uniforms:Tn([He.common,He.displacementmap,{referencePosition:{value:new T},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:_t.distanceRGBA_vert,fragmentShader:_t.distanceRGBA_frag},shadow:{uniforms:Tn([He.lights,He.fog,{color:{value:new ke(0)},opacity:{value:1}}]),vertexShader:_t.shadow_vert,fragmentShader:_t.shadow_frag}};ir.physical={uniforms:Tn([ir.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new Te(1,1)},clearcoatNormalMap:{value:null},sheen:{value:new ke(0)},transparency:{value:0}}]),vertexShader:_t.meshphysical_vert,fragmentShader:_t.meshphysical_frag};function m3(t,e,n,i){const r=new ke(0);let s=0,o,a,c=null,l=0,h=null;function u(d,p,y,g){let m=p.isScene===!0?p.background:null;const x=t.xr,v=x.getSession&&x.getSession();if(v&&v.environmentBlendMode==="additive"&&(m=null),m===null?f(r,s):m&&m.isColor&&(f(m,1),g=!0),(t.autoClear||g)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),m&&(m.isCubeTexture||m.isWebGLCubeRenderTarget||m.mapping===qc)){a===void 0&&(a=new Ht(new Yc(1,1,1),new bn({name:"BackgroundCubeMaterial",uniforms:Ao(ir.cube.uniforms),vertexShader:ir.cube.vertexShader,fragmentShader:ir.cube.fragmentShader,side:yn,depthTest:!1,depthWrite:!1,fog:!1})),a.geometry.deleteAttribute("normal"),a.geometry.deleteAttribute("uv"),a.onBeforeRender=function(_,C,w){this.matrixWorld.copyPosition(w.matrixWorld)},Object.defineProperty(a.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(a));const b=m.isWebGLCubeRenderTarget?m.texture:m;a.material.uniforms.envMap.value=b,a.material.uniforms.flipEnvMap.value=b.isCubeTexture?-1:1,(c!==m||l!==b.version||h!==t.toneMapping)&&(a.material.needsUpdate=!0,c=m,l=b.version,h=t.toneMapping),d.unshift(a,a.geometry,a.material,0,0,null)}else m&&m.isTexture&&(o===void 0&&(o=new Ht(new Co(2,2),new bn({name:"BackgroundMaterial",uniforms:Ao(ir.background.uniforms),vertexShader:ir.background.vertexShader,fragmentShader:ir.background.fragmentShader,side:Yo,depthTest:!1,depthWrite:!1,fog:!1})),o.geometry.deleteAttribute("normal"),Object.defineProperty(o.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(o)),o.material.uniforms.t2D.value=m,m.matrixAutoUpdate===!0&&m.updateMatrix(),o.material.uniforms.uvTransform.value.copy(m.matrix),(c!==m||l!==m.version||h!==t.toneMapping)&&(o.material.needsUpdate=!0,c=m,l=m.version,h=t.toneMapping),d.unshift(o,o.geometry,o.material,0,0,null))}function f(d,p){e.buffers.color.setClear(d.r,d.g,d.b,p,i)}return{getClearColor:function(){return r},setClearColor:function(d,p){r.set(d),s=p!==void 0?p:1,f(r,s)},getClearAlpha:function(){return s},setClearAlpha:function(d){s=d,f(r,s)},render:u}}function g3(t,e,n,i){const r=t.getParameter(34921),s=i.isWebGL2?null:e.get("OES_vertex_array_object"),o=i.isWebGL2||s!==null,a={},c=y(null);let l=c;function h(E,O,k,ne,Y){let F=!1;if(o){const te=p(ne,k,O);l!==te&&(l=te,f(l.object)),F=g(ne),F&&m(ne)}else{const te=O.wireframe===!0;(l.geometry!==ne.id||l.program!==k.id||l.wireframe!==te)&&(l.geometry=ne.id,l.program=k.id,l.wireframe=te,F=!0)}E.isInstancedMesh===!0&&(F=!0),Y!==null&&n.update(Y,34963),F&&(w(E,O,k,ne),Y!==null&&t.bindBuffer(34963,n.get(Y).buffer))}function u(){return i.isWebGL2?t.createVertexArray():s.createVertexArrayOES()}function f(E){return i.isWebGL2?t.bindVertexArray(E):s.bindVertexArrayOES(E)}function d(E){return i.isWebGL2?t.deleteVertexArray(E):s.deleteVertexArrayOES(E)}function p(E,O,k){const ne=k.wireframe===!0;let Y=a[E.id];Y===void 0&&(Y={},a[E.id]=Y);let F=Y[O.id];F===void 0&&(F={},Y[O.id]=F);let te=F[ne];return te===void 0&&(te=y(u()),F[ne]=te),te}function y(E){const O=[],k=[],ne=[];for(let Y=0;Y<r;Y++)O[Y]=0,k[Y]=0,ne[Y]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:O,enabledAttributes:k,attributeDivisors:ne,object:E,attributes:{}}}function g(E){const O=l.attributes,k=E.attributes;if(Object.keys(O).length!==Object.keys(k).length)return!0;for(const ne in k){const Y=O[ne],F=k[ne];if(Y.attribute!==F||Y.data!==F.data)return!0}return!1}function m(E){const O={},k=E.attributes;for(const ne in k){const Y=k[ne],F={};F.attribute=Y,Y.data&&(F.data=Y.data),O[ne]=F}l.attributes=O}function x(){const E=l.newAttributes;for(let O=0,k=E.length;O<k;O++)E[O]=0}function v(E){b(E,0)}function b(E,O){const k=l.newAttributes,ne=l.enabledAttributes,Y=l.attributeDivisors;k[E]=1,ne[E]===0&&(t.enableVertexAttribArray(E),ne[E]=1),Y[E]!==O&&((i.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[i.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](E,O),Y[E]=O)}function _(){const E=l.newAttributes,O=l.enabledAttributes;for(let k=0,ne=O.length;k<ne;k++)O[k]!==E[k]&&(t.disableVertexAttribArray(k),O[k]=0)}function C(E,O,k,ne,Y,F){i.isWebGL2===!0&&(k===5124||k===5125)?t.vertexAttribIPointer(E,O,k,ne,Y,F):t.vertexAttribPointer(E,O,k,ne,Y,F)}function w(E,O,k,ne){if(i.isWebGL2===!1&&(E.isInstancedMesh||ne.isInstancedBufferGeometry)&&e.get("ANGLE_instanced_arrays")===null)return;x();const Y=ne.attributes,F=k.getAttributes(),te=O.defaultAttributeValues;for(const ee in F){const j=F[ee];if(j>=0){const Z=Y[ee];if(Z!==void 0){const ce=Z.normalized,de=Z.itemSize,oe=n.get(Z);if(oe===void 0)continue;const V=oe.buffer,re=oe.type,q=oe.bytesPerElement;if(Z.isInterleavedBufferAttribute){const J=Z.data,W=J.stride,H=Z.offset;J&&J.isInstancedInterleavedBuffer?(b(j,J.meshPerAttribute),ne._maxInstanceCount===void 0&&(ne._maxInstanceCount=J.meshPerAttribute*J.count)):v(j),t.bindBuffer(34962,V),C(j,de,re,ce,W*q,H*q)}else Z.isInstancedBufferAttribute?(b(j,Z.meshPerAttribute),ne._maxInstanceCount===void 0&&(ne._maxInstanceCount=Z.meshPerAttribute*Z.count)):v(j),t.bindBuffer(34962,V),C(j,de,re,ce,0,0)}else if(ee==="instanceMatrix"){const ce=n.get(E.instanceMatrix);if(ce===void 0)continue;const de=ce.buffer,oe=ce.type;b(j+0,1),b(j+1,1),b(j+2,1),b(j+3,1),t.bindBuffer(34962,de),t.vertexAttribPointer(j+0,4,oe,!1,64,0),t.vertexAttribPointer(j+1,4,oe,!1,64,16),t.vertexAttribPointer(j+2,4,oe,!1,64,32),t.vertexAttribPointer(j+3,4,oe,!1,64,48)}else if(te!==void 0){const ce=te[ee];if(ce!==void 0)switch(ce.length){case 2:t.vertexAttrib2fv(j,ce);break;case 3:t.vertexAttrib3fv(j,ce);break;case 4:t.vertexAttrib4fv(j,ce);break;default:t.vertexAttrib1fv(j,ce)}}}}_()}function S(){L();for(const E in a){const O=a[E];for(const k in O){const ne=O[k];for(const Y in ne)d(ne[Y].object),delete ne[Y];delete O[k]}delete a[E]}}function M(E){if(a[E.id]===void 0)return;const O=a[E.id];for(const k in O){const ne=O[k];for(const Y in ne)d(ne[Y].object),delete ne[Y];delete O[k]}delete a[E.id]}function B(E){for(const O in a){const k=a[O];if(k[E.id]===void 0)continue;const ne=k[E.id];for(const Y in ne)d(ne[Y].object),delete ne[Y];delete k[E.id]}}function L(){U(),l!==c&&(l=c,f(l.object))}function U(){c.geometry=null,c.program=null,c.wireframe=!1}return{setup:h,reset:L,resetDefaultState:U,dispose:S,releaseStatesOfGeometry:M,releaseStatesOfProgram:B,initAttributes:x,enableAttribute:v,disableUnusedAttributes:_}}function y3(t,e,n,i){const r=i.isWebGL2;let s;function o(l){s=l}function a(l,h){t.drawArrays(s,l,h),n.update(h,s)}function c(l,h,u,f){if(f===0)return;let d,p;if(r)d=t,p="drawArraysInstanced";else if(d=e.get("ANGLE_instanced_arrays"),p="drawArraysInstancedANGLE",d===null){console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");return}d[p](s,h,u,f),n.update(u,s,f)}this.setMode=o,this.render=a,this.renderInstances=c}function x3(t,e,n){let i;function r(){if(i!==void 0)return i;const C=e.get("EXT_texture_filter_anisotropic");return C!==null?i=t.getParameter(C.MAX_TEXTURE_MAX_ANISOTROPY_EXT):i=0,i}function s(C){if(C==="highp"){if(t.getShaderPrecisionFormat(35633,36338).precision>0&&t.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";C="mediump"}return C==="mediump"&&t.getShaderPrecisionFormat(35633,36337).precision>0&&t.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const o=typeof WebGL2RenderingContext<"u"&&t instanceof WebGL2RenderingContext||typeof WebGL2ComputeRenderingContext<"u"&&t instanceof WebGL2ComputeRenderingContext;let a=n.precision!==void 0?n.precision:"highp";const c=s(a);c!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",c,"instead."),a=c);const l=n.logarithmicDepthBuffer===!0,h=t.getParameter(34930),u=t.getParameter(35660),f=t.getParameter(3379),d=t.getParameter(34076),p=t.getParameter(34921),y=t.getParameter(36347),g=t.getParameter(36348),m=t.getParameter(36349),x=u>0,v=o||!!e.get("OES_texture_float"),b=x&&v,_=o?t.getParameter(36183):0;return{isWebGL2:o,getMaxAnisotropy:r,getMaxPrecision:s,precision:a,logarithmicDepthBuffer:l,maxTextures:h,maxVertexTextures:u,maxTextureSize:f,maxCubemapSize:d,maxAttributes:p,maxVertexUniforms:y,maxVaryings:g,maxFragmentUniforms:m,vertexTextures:x,floatFragmentTextures:v,floatVertexTextures:b,maxSamples:_}}function b3(){const t=this;let e=null,n=0,i=!1,r=!1;const s=new Ri,o=new An,a={value:null,needsUpdate:!1};this.uniform=a,this.numPlanes=0,this.numIntersection=0,this.init=function(h,u,f){const d=h.length!==0||u||n!==0||i;return i=u,e=l(h,f,0),n=h.length,d},this.beginShadows=function(){r=!0,l(null)},this.endShadows=function(){r=!1,c()},this.setState=function(h,u,f,d,p,y){if(!i||h===null||h.length===0||r&&!f)r?l(null):c();else{const g=r?0:n,m=g*4;let x=p.clippingState||null;a.value=x,x=l(h,d,m,y);for(let v=0;v!==m;++v)x[v]=e[v];p.clippingState=x,this.numIntersection=u?this.numPlanes:0,this.numPlanes+=g}};function c(){a.value!==e&&(a.value=e,a.needsUpdate=n>0),t.numPlanes=n,t.numIntersection=0}function l(h,u,f,d){let p=h!==null?h.length:0,y=null;if(p!==0){if(y=a.value,d!==!0||y===null){const g=f+p*4,m=u.matrixWorldInverse;o.getNormalMatrix(m),(y===null||y.length<g)&&(y=new Float32Array(g));for(let x=0,v=f;x!==p;++x,v+=4)s.copy(h[x]).applyMatrix4(m,o),s.normal.toArray(y,v),y[v+3]=s.constant}a.value=y,a.needsUpdate=!0}return t.numPlanes=p,t.numIntersection=0,y}}function v3(t){const e={};return{get:function(n){if(e[n]!==void 0)return e[n];let i;switch(n){case"WEBGL_depth_texture":i=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=t.getExtension(n)}return i===null&&console.warn("THREE.WebGLRenderer: "+n+" extension not supported."),e[n]=i,i}}}function _3(t,e,n,i){const r=new WeakMap,s=new WeakMap;function o(u){const f=u.target,d=r.get(f);d.index!==null&&e.remove(d.index);for(const y in d.attributes)e.remove(d.attributes[y]);f.removeEventListener("dispose",o),r.delete(f);const p=s.get(d);p&&(e.remove(p),s.delete(d)),i.releaseStatesOfGeometry(f),f.isInstancedBufferGeometry===!0&&delete f._maxInstanceCount,n.memory.geometries--}function a(u,f){let d=r.get(f);return d||(f.addEventListener("dispose",o),f.isBufferGeometry?d=f:f.isGeometry&&(f._bufferGeometry===void 0&&(f._bufferGeometry=new We().setFromObject(u)),d=f._bufferGeometry),r.set(f,d),n.memory.geometries++,d)}function c(u){const f=u.attributes;for(const p in f)e.update(f[p],34962);const d=u.morphAttributes;for(const p in d){const y=d[p];for(let g=0,m=y.length;g<m;g++)e.update(y[g],34962)}}function l(u){const f=[],d=u.index,p=u.attributes.position;let y=0;if(d!==null){const x=d.array;y=d.version;for(let v=0,b=x.length;v<b;v+=3){const _=x[v+0],C=x[v+1],w=x[v+2];f.push(_,C,C,w,w,_)}}else{const x=p.array;y=p.version;for(let v=0,b=x.length/3-1;v<b;v+=3){const _=v+0,C=v+1,w=v+2;f.push(_,C,C,w,w,_)}}const g=new(Gy(f)>65535?cc:ac)(f,1);g.version=y;const m=s.get(u);m&&e.remove(m),s.set(u,g)}function h(u){const f=s.get(u);if(f){const d=u.index;d!==null&&f.version<d.version&&l(u)}else l(u);return s.get(u)}return{get:a,update:c,getWireframeAttribute:h}}function w3(t,e,n,i){const r=i.isWebGL2;let s;function o(f){s=f}let a,c;function l(f){a=f.type,c=f.bytesPerElement}function h(f,d){t.drawElements(s,d,a,f*c),n.update(d,s)}function u(f,d,p,y){if(y===0)return;let g,m;if(r)g=t,m="drawElementsInstanced";else if(g=e.get("ANGLE_instanced_arrays"),m="drawElementsInstancedANGLE",g===null){console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");return}g[m](s,p,a,d*c,y),n.update(p,s,y)}this.setMode=o,this.setIndex=l,this.render=h,this.renderInstances=u}function S3(t){const e={geometries:0,textures:0},n={frame:0,calls:0,triangles:0,points:0,lines:0};function i(s,o,a){switch(a=a||1,n.calls++,o){case 4:n.triangles+=a*(s/3);break;case 1:n.lines+=a*(s/2);break;case 3:n.lines+=a*(s-1);break;case 2:n.lines+=a*s;break;case 0:n.points+=a*s;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",o);break}}function r(){n.frame++,n.calls=0,n.triangles=0,n.points=0,n.lines=0}return{memory:e,render:n,programs:null,autoReset:!0,reset:r,update:i}}function M3(t,e){return t[0]-e[0]}function A3(t,e){return Math.abs(e[1])-Math.abs(t[1])}function C3(t){const e={},n=new Float32Array(8),i=[];for(let s=0;s<8;s++)i[s]=[s,0];function r(s,o,a,c){const l=s.morphTargetInfluences,h=l===void 0?0:l.length;let u=e[o.id];if(u===void 0){u=[];for(let g=0;g<h;g++)u[g]=[g,0];e[o.id]=u}for(let g=0;g<h;g++){const m=u[g];m[0]=g,m[1]=l[g]}u.sort(A3);for(let g=0;g<8;g++)g<h&&u[g][1]?(i[g][0]=u[g][0],i[g][1]=u[g][1]):(i[g][0]=Number.MAX_SAFE_INTEGER,i[g][1]=0);i.sort(M3);const f=a.morphTargets&&o.morphAttributes.position,d=a.morphNormals&&o.morphAttributes.normal;let p=0;for(let g=0;g<8;g++){const m=i[g],x=m[0],v=m[1];x!==Number.MAX_SAFE_INTEGER&&v?(f&&o.getAttribute("morphTarget"+g)!==f[x]&&o.setAttribute("morphTarget"+g,f[x]),d&&o.getAttribute("morphNormal"+g)!==d[x]&&o.setAttribute("morphNormal"+g,d[x]),n[g]=v,p+=v):(f&&o.getAttribute("morphTarget"+g)!==void 0&&o.deleteAttribute("morphTarget"+g),d&&o.getAttribute("morphNormal"+g)!==void 0&&o.deleteAttribute("morphNormal"+g),n[g]=0)}const y=o.morphTargetsRelative?1:1-p;c.getUniforms().setValue(t,"morphTargetBaseInfluence",y),c.getUniforms().setValue(t,"morphTargetInfluences",n)}return{update:r}}function T3(t,e,n,i){let r=new WeakMap;function s(a){const c=i.render.frame,l=a.geometry,h=e.get(a,l);return r.get(h)!==c&&(l.isGeometry&&h.updateFromObject(a),e.update(h),r.set(h,c)),a.isInstancedMesh&&n.update(a.instanceMatrix,34962),h}function o(){r=new WeakMap}return{update:s,dispose:o}}function Vr(t,e,n,i,r,s,o,a,c,l){t=t!==void 0?t:[],e=e!==void 0?e:qp,o=o!==void 0?o:us,$t.call(this,t,e,n,i,r,s,o,a,c,l),this.flipY=!1}Vr.prototype=Object.create($t.prototype);Vr.prototype.constructor=Vr;Vr.prototype.isCubeTexture=!0;Object.defineProperty(Vr.prototype,"images",{get:function(){return this.image},set:function(t){this.image=t}});function dc(t,e,n,i){$t.call(this,null),this.image={data:t||null,width:e||1,height:n||1,depth:i||1},this.magFilter=zt,this.minFilter=zt,this.wrapR=zn,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}dc.prototype=Object.create($t.prototype);dc.prototype.constructor=dc;dc.prototype.isDataTexture2DArray=!0;function fc(t,e,n,i){$t.call(this,null),this.image={data:t||null,width:e||1,height:n||1,depth:i||1},this.magFilter=zt,this.minFilter=zt,this.wrapR=zn,this.generateMipmaps=!1,this.flipY=!1,this.needsUpdate=!0}fc.prototype=Object.create($t.prototype);fc.prototype.constructor=fc;fc.prototype.isDataTexture3D=!0;const Hy=new $t,P3=new dc,E3=new fc,$y=new Vr,sg=[],og=[],ag=new Float32Array(16),cg=new Float32Array(9),lg=new Float32Array(4);function Jo(t,e,n){const i=t[0];if(i<=0||i>0)return t;let r=e*n,s=sg[r];if(s===void 0&&(s=new Float32Array(r),sg[r]=s),e!==0){i.toArray(s,0);for(let o=1,a=0;o!==e;++o)a+=n,t[o].toArray(s,a)}return s}function ai(t,e){if(t.length!==e.length)return!1;for(let n=0,i=t.length;n<i;n++)if(t[n]!==e[n])return!1;return!0}function qn(t,e){for(let n=0,i=e.length;n<i;n++)t[n]=e[n]}function Wy(t,e){let n=og[e];n===void 0&&(n=new Int32Array(e),og[e]=n);for(let i=0;i!==e;++i)n[i]=t.allocateTextureUnit();return n}function I3(t,e){const n=this.cache;n[0]!==e&&(t.uniform1f(this.addr,e),n[0]=e)}function L3(t,e){const n=this.cache;if(e.x!==void 0)(n[0]!==e.x||n[1]!==e.y)&&(t.uniform2f(this.addr,e.x,e.y),n[0]=e.x,n[1]=e.y);else{if(ai(n,e))return;t.uniform2fv(this.addr,e),qn(n,e)}}function R3(t,e){const n=this.cache;if(e.x!==void 0)(n[0]!==e.x||n[1]!==e.y||n[2]!==e.z)&&(t.uniform3f(this.addr,e.x,e.y,e.z),n[0]=e.x,n[1]=e.y,n[2]=e.z);else if(e.r!==void 0)(n[0]!==e.r||n[1]!==e.g||n[2]!==e.b)&&(t.uniform3f(this.addr,e.r,e.g,e.b),n[0]=e.r,n[1]=e.g,n[2]=e.b);else{if(ai(n,e))return;t.uniform3fv(this.addr,e),qn(n,e)}}function D3(t,e){const n=this.cache;if(e.x!==void 0)(n[0]!==e.x||n[1]!==e.y||n[2]!==e.z||n[3]!==e.w)&&(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),n[0]=e.x,n[1]=e.y,n[2]=e.z,n[3]=e.w);else{if(ai(n,e))return;t.uniform4fv(this.addr,e),qn(n,e)}}function B3(t,e){const n=this.cache,i=e.elements;if(i===void 0){if(ai(n,e))return;t.uniformMatrix2fv(this.addr,!1,e),qn(n,e)}else{if(ai(n,i))return;lg.set(i),t.uniformMatrix2fv(this.addr,!1,lg),qn(n,i)}}function O3(t,e){const n=this.cache,i=e.elements;if(i===void 0){if(ai(n,e))return;t.uniformMatrix3fv(this.addr,!1,e),qn(n,e)}else{if(ai(n,i))return;cg.set(i),t.uniformMatrix3fv(this.addr,!1,cg),qn(n,i)}}function k3(t,e){const n=this.cache,i=e.elements;if(i===void 0){if(ai(n,e))return;t.uniformMatrix4fv(this.addr,!1,e),qn(n,e)}else{if(ai(n,i))return;ag.set(i),t.uniformMatrix4fv(this.addr,!1,ag),qn(n,i)}}function F3(t,e,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(t.uniform1i(this.addr,r),i[0]=r),n.safeSetTexture2D(e||Hy,r)}function N3(t,e,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(t.uniform1i(this.addr,r),i[0]=r),n.setTexture2DArray(e||P3,r)}function z3(t,e,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(t.uniform1i(this.addr,r),i[0]=r),n.setTexture3D(e||E3,r)}function G3(t,e,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(t.uniform1i(this.addr,r),i[0]=r),n.safeSetTextureCube(e||$y,r)}function U3(t,e){const n=this.cache;n[0]!==e&&(t.uniform1i(this.addr,e),n[0]=e)}function V3(t,e){const n=this.cache;ai(n,e)||(t.uniform2iv(this.addr,e),qn(n,e))}function H3(t,e){const n=this.cache;ai(n,e)||(t.uniform3iv(this.addr,e),qn(n,e))}function $3(t,e){const n=this.cache;ai(n,e)||(t.uniform4iv(this.addr,e),qn(n,e))}function W3(t,e){const n=this.cache;n[0]!==e&&(t.uniform1ui(this.addr,e),n[0]=e)}function j3(t){switch(t){case 5126:return I3;case 35664:return L3;case 35665:return R3;case 35666:return D3;case 35674:return B3;case 35675:return O3;case 35676:return k3;case 5124:case 35670:return U3;case 35667:case 35671:return V3;case 35668:case 35672:return H3;case 35669:case 35673:return $3;case 5125:return W3;case 35678:case 36198:case 36298:case 36306:case 35682:return F3;case 35679:case 36299:case 36307:return z3;case 35680:case 36300:case 36308:case 36293:return G3;case 36289:case 36303:case 36311:case 36292:return N3}}function q3(t,e){t.uniform1fv(this.addr,e)}function X3(t,e){t.uniform1iv(this.addr,e)}function Y3(t,e){t.uniform2iv(this.addr,e)}function Z3(t,e){t.uniform3iv(this.addr,e)}function K3(t,e){t.uniform4iv(this.addr,e)}function J3(t,e){const n=Jo(e,this.size,2);t.uniform2fv(this.addr,n)}function Q3(t,e){const n=Jo(e,this.size,3);t.uniform3fv(this.addr,n)}function eS(t,e){const n=Jo(e,this.size,4);t.uniform4fv(this.addr,n)}function tS(t,e){const n=Jo(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,n)}function nS(t,e){const n=Jo(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,n)}function iS(t,e){const n=Jo(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,n)}function rS(t,e,n){const i=e.length,r=Wy(n,i);t.uniform1iv(this.addr,r);for(let s=0;s!==i;++s)n.safeSetTexture2D(e[s]||Hy,r[s])}function sS(t,e,n){const i=e.length,r=Wy(n,i);t.uniform1iv(this.addr,r);for(let s=0;s!==i;++s)n.safeSetTextureCube(e[s]||$y,r[s])}function oS(t){switch(t){case 5126:return q3;case 35664:return J3;case 35665:return Q3;case 35666:return eS;case 35674:return tS;case 35675:return nS;case 35676:return iS;case 5124:case 35670:return X3;case 35667:case 35671:return Y3;case 35668:case 35672:return Z3;case 35669:case 35673:return K3;case 35678:case 36198:case 36298:case 36306:case 35682:return rS;case 35680:case 36300:case 36308:case 36293:return sS}}function aS(t,e,n){this.id=t,this.addr=n,this.cache=[],this.setValue=j3(e.type)}function jy(t,e,n){this.id=t,this.addr=n,this.cache=[],this.size=e.size,this.setValue=oS(e.type)}jy.prototype.updateCache=function(t){let e=this.cache;t instanceof Float32Array&&e.length!==t.length&&(this.cache=new Float32Array(t.length)),qn(e,t)};function qy(t){this.id=t,this.seq=[],this.map={}}qy.prototype.setValue=function(t,e,n){const i=this.seq;for(let r=0,s=i.length;r!==s;++r){const o=i[r];o.setValue(t,e[o.id],n)}};const yd=/([\w\d_]+)(\])?(\[|\.)?/g;function hg(t,e){t.seq.push(e),t.map[e.id]=e}function cS(t,e,n){const i=t.name,r=i.length;for(yd.lastIndex=0;;){const s=yd.exec(i),o=yd.lastIndex;let a=s[1],c=s[2]==="]",l=s[3];if(c&&(a=a|0),l===void 0||l==="["&&o+2===r){hg(n,l===void 0?new aS(a,t,e):new jy(a,t,e));break}else{let u=n.map[a];u===void 0&&(u=new qy(a),hg(n,u)),n=u}}}function Or(t,e){this.seq=[],this.map={};const n=t.getProgramParameter(e,35718);for(let i=0;i<n;++i){const r=t.getActiveUniform(e,i),s=t.getUniformLocation(e,r.name);cS(r,s,this)}}Or.prototype.setValue=function(t,e,n,i){const r=this.map[e];r!==void 0&&r.setValue(t,n,i)};Or.prototype.setOptional=function(t,e,n){const i=e[n];i!==void 0&&this.setValue(t,n,i)};Or.upload=function(t,e,n,i){for(let r=0,s=e.length;r!==s;++r){const o=e[r],a=n[o.id];a.needsUpdate!==!1&&o.setValue(t,a.value,i)}};Or.seqWithValue=function(t,e){const n=[];for(let i=0,r=t.length;i!==r;++i){const s=t[i];s.id in e&&n.push(s)}return n};function ug(t,e,n){const i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),i}let lS=0;function hS(t){const e=t.split(`
`);for(let n=0;n<e.length;n++)e[n]=n+1+": "+e[n];return e.join(`
`)}function Xy(t){switch(t){case Pn:return["Linear","( value )"];case Xc:return["sRGB","( value )"];case Qp:return["RGBE","( value )"];case Oy:return["RGBM","( value, 7.0 )"];case ky:return["RGBM","( value, 16.0 )"];case Fy:return["RGBD","( value, 256.0 )"];case Jp:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case T_:return["LogLuv","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",t),["Linear","( value )"]}}function dg(t,e,n){const i=t.getShaderParameter(e,35713),r=t.getShaderInfoLog(e).trim();if(i&&r==="")return"";const s=t.getShaderSource(e);return"THREE.WebGLShader: gl.getShaderInfoLog() "+n+`
`+r+hS(s)}function Aa(t,e){const n=Xy(e);return"vec4 "+t+"( vec4 value ) { return "+n[0]+"ToLinear"+n[1]+"; }"}function uS(t,e){const n=Xy(e);return"vec4 "+t+"( vec4 value ) { return LinearTo"+n[0]+n[1]+"; }"}function dS(t,e){let n;switch(e){case Cv:n="Linear";break;case Tv:n="Reinhard";break;case Pv:n="OptimizedCineon";break;case Ev:n="ACESFilmic";break;case Iv:n="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),n="Linear"}return"vec3 "+t+"( vec3 color ) { return "+n+"ToneMapping( color ); }"}function fS(t){return[t.extensionDerivatives||t.envMapCubeUV||t.bumpMap||t.tangentSpaceNormalMap||t.clearcoatNormalMap||t.flatShading||t.shaderID==="physical"?"#extension GL_OES_standard_derivatives : enable":"",(t.extensionFragDepth||t.logarithmicDepthBuffer)&&t.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",t.extensionDrawBuffers&&t.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(t.extensionShaderTextureLOD||t.envMap)&&t.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter($a).join(`
`)}function pS(t){const e=[];for(const n in t){const i=t[n];i!==!1&&e.push("#define "+n+" "+i)}return e.join(`
`)}function mS(t,e){const n={},i=t.getProgramParameter(e,35721);for(let r=0;r<i;r++){const o=t.getActiveAttrib(e,r).name;n[o]=t.getAttribLocation(e,o)}return n}function $a(t){return t!==""}function fg(t,e){return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function pg(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const gS=/^[ \t]*#include +<([\w\d./]+)>/gm;function Uf(t){return t.replace(gS,yS)}function yS(t,e){const n=_t[e];if(n===void 0)throw new Error("Can not resolve #include <"+e+">");return Uf(n)}const xS=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,bS=/#pragma unroll_loop_start[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}[\s]+?#pragma unroll_loop_end/g;function mg(t){return t.replace(bS,Yy).replace(xS,vS)}function vS(t,e,n,i){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),Yy(t,e,n,i)}function Yy(t,e,n,i){let r="";for(let s=parseInt(e);s<parseInt(n);s++)r+=i.replace(/\[ i \]/g,"[ "+s+" ]").replace(/UNROLLED_LOOP_INDEX/g,s);return r}function gg(t){let e="precision "+t.precision+` float;
precision `+t.precision+" int;";return t.precision==="highp"?e+=`
#define HIGH_PRECISION`:t.precision==="mediump"?e+=`
#define MEDIUM_PRECISION`:t.precision==="lowp"&&(e+=`
#define LOW_PRECISION`),e}function _S(t){let e="SHADOWMAP_TYPE_BASIC";return t.shadowMapType===Py?e="SHADOWMAP_TYPE_PCF":t.shadowMapType===rv?e="SHADOWMAP_TYPE_PCF_SOFT":t.shadowMapType===Ha&&(e="SHADOWMAP_TYPE_VSM"),e}function wS(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case qp:case Xp:e="ENVMAP_TYPE_CUBE";break;case qc:case Zp:e="ENVMAP_TYPE_CUBE_UV";break;case Ry:case Yp:e="ENVMAP_TYPE_EQUIREC";break}return e}function SS(t){let e="ENVMAP_MODE_REFLECTION";if(t.envMap)switch(t.envMapMode){case Xp:case Yp:e="ENVMAP_MODE_REFRACTION";break}return e}function MS(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case Au:e="ENVMAP_BLENDING_MULTIPLY";break;case Mv:e="ENVMAP_BLENDING_MIX";break;case Av:e="ENVMAP_BLENDING_ADD";break}return e}function AS(t,e,n,i){const r=t.getContext(),s=n.defines;let o=n.vertexShader,a=n.fragmentShader;const c=_S(n),l=wS(n),h=SS(n),u=MS(n),f=t.gammaFactor>0?t.gammaFactor:1,d=n.isWebGL2?"":fS(n),p=pS(s),y=r.createProgram();let g,m;if(n.isRawShaderMaterial?(g=[p].filter($a).join(`
`),g.length>0&&(g+=`
`),m=[d,p].filter($a).join(`
`),m.length>0&&(m+=`
`)):(g=[gg(n),"#define SHADER_NAME "+n.shaderName,p,n.instancing?"#define USE_INSTANCING":"",n.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+f,"#define MAX_BONES "+n.maxBones,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+h:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMap&&n.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",n.normalMap&&n.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.displacementMap&&n.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.vertexTangents?"#define USE_TANGENT":"",n.vertexColors?"#define USE_COLOR":"",n.vertexUvs?"#define USE_UV":"",n.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",n.flatShading?"#define FLAT_SHADED":"",n.skinning?"#define USE_SKINNING":"",n.useVertexTexture?"#define BONE_TEXTURE":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&n.flatShading===!1?"#define USE_MORPHNORMALS":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+c:"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&n.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING"," attribute mat4 instanceMatrix;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#ifdef USE_COLOR","	attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","	attribute vec3 morphTarget0;","	attribute vec3 morphTarget1;","	attribute vec3 morphTarget2;","	attribute vec3 morphTarget3;","	#ifdef USE_MORPHNORMALS","		attribute vec3 morphNormal0;","		attribute vec3 morphNormal1;","		attribute vec3 morphNormal2;","		attribute vec3 morphNormal3;","	#else","		attribute vec3 morphTarget4;","		attribute vec3 morphTarget5;","		attribute vec3 morphTarget6;","		attribute vec3 morphTarget7;","	#endif","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
`].filter($a).join(`
`),m=[d,gg(n),"#define SHADER_NAME "+n.shaderName,p,n.alphaTest?"#define ALPHATEST "+n.alphaTest+(n.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+f,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.matcap?"#define USE_MATCAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+l:"",n.envMap?"#define "+h:"",n.envMap?"#define "+u:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMap&&n.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",n.normalMap&&n.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.sheen?"#define USE_SHEEN":"",n.vertexTangents?"#define USE_TANGENT":"",n.vertexColors?"#define USE_COLOR":"",n.vertexUvs?"#define USE_UV":"",n.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",n.gradientMap?"#define USE_GRADIENTMAP":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+c:"",n.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",n.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&n.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(n.extensionShaderTextureLOD||n.envMap)&&n.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",n.toneMapping!==yo?"#define TONE_MAPPING":"",n.toneMapping!==yo?_t.tonemapping_pars_fragment:"",n.toneMapping!==yo?dS("toneMapping",n.toneMapping):"",n.dithering?"#define DITHERING":"",_t.encodings_pars_fragment,n.map?Aa("mapTexelToLinear",n.mapEncoding):"",n.matcap?Aa("matcapTexelToLinear",n.matcapEncoding):"",n.envMap?Aa("envMapTexelToLinear",n.envMapEncoding):"",n.emissiveMap?Aa("emissiveMapTexelToLinear",n.emissiveMapEncoding):"",n.lightMap?Aa("lightMapTexelToLinear",n.lightMapEncoding):"",uS("linearToOutputTexel",n.outputEncoding),n.depthPacking?"#define DEPTH_PACKING "+n.depthPacking:"",`
`].filter($a).join(`
`)),o=Uf(o),o=fg(o,n),o=pg(o,n),a=Uf(a),a=fg(a,n),a=pg(a,n),o=mg(o),a=mg(a),n.isWebGL2&&!n.isRawShaderMaterial){let S=!1;const M=/^\s*#version\s+300\s+es\s*\n/;n.isShaderMaterial&&o.match(M)!==null&&a.match(M)!==null&&(S=!0,o=o.replace(M,""),a=a.replace(M,"")),g=[`#version 300 es
`,"#define attribute in","#define varying out","#define texture2D texture"].join(`
`)+`
`+g,m=[`#version 300 es
`,"#define varying in",S?"":"out highp vec4 pc_fragColor;",S?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join(`
`)+`
`+m}const x=g+o,v=m+a,b=ug(r,35633,x),_=ug(r,35632,v);if(r.attachShader(y,b),r.attachShader(y,_),n.index0AttributeName!==void 0?r.bindAttribLocation(y,0,n.index0AttributeName):n.morphTargets===!0&&r.bindAttribLocation(y,0,"position"),r.linkProgram(y),t.debug.checkShaderErrors){const S=r.getProgramInfoLog(y).trim(),M=r.getShaderInfoLog(b).trim(),B=r.getShaderInfoLog(_).trim();let L=!0,U=!0;if(r.getProgramParameter(y,35714)===!1){L=!1;const E=dg(r,b,"vertex"),O=dg(r,_,"fragment");console.error("THREE.WebGLProgram: shader error: ",r.getError(),"35715",r.getProgramParameter(y,35715),"gl.getProgramInfoLog",S,E,O)}else S!==""?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",S):(M===""||B==="")&&(U=!1);U&&(this.diagnostics={runnable:L,programLog:S,vertexShader:{log:M,prefix:g},fragmentShader:{log:B,prefix:m}})}r.deleteShader(b),r.deleteShader(_);let C;this.getUniforms=function(){return C===void 0&&(C=new Or(r,y)),C};let w;return this.getAttributes=function(){return w===void 0&&(w=mS(r,y)),w},this.destroy=function(){i.releaseStatesOfProgram(this),r.deleteProgram(y),this.program=void 0},this.name=n.shaderName,this.id=lS++,this.cacheKey=e,this.usedTimes=1,this.program=y,this.vertexShader=b,this.fragmentShader=_,this}function CS(t,e,n,i){const r=[],s=n.isWebGL2,o=n.logarithmicDepthBuffer,a=n.floatVertexTextures,c=n.maxVertexUniforms,l=n.vertexTextures;let h=n.precision;const u={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},f=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","sheen"];function d(b,_){let C;if(_){const w=ir[_];C={name:b.name||b.type,uniforms:gh.clone(w.uniforms),vertexShader:w.vertexShader,fragmentShader:w.fragmentShader}}else C={name:b.name||b.type,uniforms:b.uniforms,vertexShader:b.vertexShader,fragmentShader:b.fragmentShader};return C}function p(b){const C=b.skeleton.bones;if(a)return 1024;{const S=Math.floor((c-20)/4),M=Math.min(S,C.length);return M<C.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+C.length+" bones. This GPU supports "+M+"."),0):M}}function y(b){let _;return b?b.isTexture?_=b.encoding:b.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),_=b.texture.encoding):_=Pn,_}function g(b,_,C,w,S,M,B){const L=w.fog,U=b.isMeshStandardMaterial?w.environment:null,E=b.envMap||U,O=u[b.type],k=B.isSkinnedMesh?p(B):0;b.precision!==null&&(h=n.getMaxPrecision(b.precision),h!==b.precision&&console.warn("THREE.WebGLProgram.getParameters:",b.precision,"not supported, using",h,"instead."));const ne=d(b,O);b.onBeforeCompile(ne,t);const Y=t.getRenderTarget();return{isWebGL2:s,shaderID:O,shaderName:ne.name,uniforms:ne.uniforms,vertexShader:ne.vertexShader,fragmentShader:ne.fragmentShader,defines:b.defines,isRawShaderMaterial:b.isRawShaderMaterial,isShaderMaterial:b.isShaderMaterial,precision:h,instancing:B.isInstancedMesh===!0,supportsVertexTextures:l,outputEncoding:Y!==null?y(Y.texture):t.outputEncoding,map:!!b.map,mapEncoding:y(b.map),matcap:!!b.matcap,matcapEncoding:y(b.matcap),envMap:!!E,envMapMode:E&&E.mapping,envMapEncoding:y(E),envMapCubeUV:!!E&&(E.mapping===qc||E.mapping===Zp),lightMap:!!b.lightMap,lightMapEncoding:y(b.lightMap),aoMap:!!b.aoMap,emissiveMap:!!b.emissiveMap,emissiveMapEncoding:y(b.emissiveMap),bumpMap:!!b.bumpMap,normalMap:!!b.normalMap,objectSpaceNormalMap:b.normalMapType===I_,tangentSpaceNormalMap:b.normalMapType===Zo,clearcoatMap:!!b.clearcoatMap,clearcoatRoughnessMap:!!b.clearcoatRoughnessMap,clearcoatNormalMap:!!b.clearcoatNormalMap,displacementMap:!!b.displacementMap,roughnessMap:!!b.roughnessMap,metalnessMap:!!b.metalnessMap,specularMap:!!b.specularMap,alphaMap:!!b.alphaMap,gradientMap:!!b.gradientMap,sheen:!!b.sheen,combine:b.combine,vertexTangents:b.normalMap&&b.vertexTangents,vertexColors:b.vertexColors,vertexUvs:!!b.map||!!b.bumpMap||!!b.normalMap||!!b.specularMap||!!b.alphaMap||!!b.emissiveMap||!!b.roughnessMap||!!b.metalnessMap||!!b.clearcoatMap||!!b.clearcoatRoughnessMap||!!b.clearcoatNormalMap||!!b.displacementMap,uvsVertexOnly:!(b.map||b.bumpMap||b.normalMap||b.specularMap||b.alphaMap||b.emissiveMap||b.roughnessMap||b.metalnessMap||b.clearcoatNormalMap)&&!!b.displacementMap,fog:!!L,useFog:b.fog,fogExp2:L&&L.isFogExp2,flatShading:b.flatShading,sizeAttenuation:b.sizeAttenuation,logarithmicDepthBuffer:o,skinning:b.skinning&&k>0,maxBones:k,useVertexTexture:a,morphTargets:b.morphTargets,morphNormals:b.morphNormals,maxMorphTargets:t.maxMorphTargets,maxMorphNormals:t.maxMorphNormals,numDirLights:_.directional.length,numPointLights:_.point.length,numSpotLights:_.spot.length,numRectAreaLights:_.rectArea.length,numHemiLights:_.hemi.length,numDirLightShadows:_.directionalShadowMap.length,numPointLightShadows:_.pointShadowMap.length,numSpotLightShadows:_.spotShadowMap.length,numClippingPlanes:S,numClipIntersection:M,dithering:b.dithering,shadowMapEnabled:t.shadowMap.enabled&&C.length>0,shadowMapType:t.shadowMap.type,toneMapping:b.toneMapped?t.toneMapping:yo,physicallyCorrectLights:t.physicallyCorrectLights,premultipliedAlpha:b.premultipliedAlpha,alphaTest:b.alphaTest,doubleSided:b.side===jc,flipSided:b.side===yn,depthPacking:b.depthPacking!==void 0?b.depthPacking:!1,index0AttributeName:b.index0AttributeName,extensionDerivatives:b.extensions&&b.extensions.derivatives,extensionFragDepth:b.extensions&&b.extensions.fragDepth,extensionDrawBuffers:b.extensions&&b.extensions.drawBuffers,extensionShaderTextureLOD:b.extensions&&b.extensions.shaderTextureLOD,rendererExtensionFragDepth:s||e.get("EXT_frag_depth")!==null,rendererExtensionDrawBuffers:s||e.get("WEBGL_draw_buffers")!==null,rendererExtensionShaderTextureLod:s||e.get("EXT_shader_texture_lod")!==null,customProgramCacheKey:b.customProgramCacheKey()}}function m(b){const _=[];if(b.shaderID?_.push(b.shaderID):(_.push(b.fragmentShader),_.push(b.vertexShader)),b.defines!==void 0)for(const C in b.defines)_.push(C),_.push(b.defines[C]);if(b.isRawShaderMaterial===void 0){for(let C=0;C<f.length;C++)_.push(b[f[C]]);_.push(t.outputEncoding),_.push(t.gammaFactor)}return _.push(b.customProgramCacheKey),_.join()}function x(b,_){let C;for(let w=0,S=r.length;w<S;w++){const M=r[w];if(M.cacheKey===_){C=M,++C.usedTimes;break}}return C===void 0&&(C=new AS(t,_,b,i),r.push(C)),C}function v(b){if(--b.usedTimes===0){const _=r.indexOf(b);r[_]=r[r.length-1],r.pop(),b.destroy()}}return{getParameters:g,getProgramCacheKey:m,acquireProgram:x,releaseProgram:v,programs:r}}function TS(){let t=new WeakMap;function e(s){let o=t.get(s);return o===void 0&&(o={},t.set(s,o)),o}function n(s){t.delete(s)}function i(s,o,a){t.get(s)[o]=a}function r(){t=new WeakMap}return{get:e,remove:n,update:i,dispose:r}}function PS(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program!==e.program?t.program.id-e.program.id:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function ES(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function yg(){const t=[];let e=0;const n=[],i=[],r={id:-1};function s(){e=0,n.length=0,i.length=0}function o(u,f,d,p,y,g){let m=t[e];return m===void 0?(m={id:u.id,object:u,geometry:f,material:d,program:d.program||r,groupOrder:p,renderOrder:u.renderOrder,z:y,group:g},t[e]=m):(m.id=u.id,m.object=u,m.geometry=f,m.material=d,m.program=d.program||r,m.groupOrder=p,m.renderOrder=u.renderOrder,m.z=y,m.group=g),e++,m}function a(u,f,d,p,y,g){const m=o(u,f,d,p,y,g);(d.transparent===!0?i:n).push(m)}function c(u,f,d,p,y,g){const m=o(u,f,d,p,y,g);(d.transparent===!0?i:n).unshift(m)}function l(u,f){n.length>1&&n.sort(u||PS),i.length>1&&i.sort(f||ES)}function h(){for(let u=e,f=t.length;u<f;u++){const d=t[u];if(d.id===null)break;d.id=null,d.object=null,d.geometry=null,d.material=null,d.program=null,d.group=null}}return{opaque:n,transparent:i,init:s,push:a,unshift:c,finish:h,sort:l}}function IS(){let t=new WeakMap;function e(r){const s=r.target;s.removeEventListener("dispose",e),t.delete(s)}function n(r,s){const o=t.get(r);let a;return o===void 0?(a=new yg,t.set(r,new WeakMap),t.get(r).set(s,a),r.addEventListener("dispose",e)):(a=o.get(s),a===void 0&&(a=new yg,o.set(s,a))),a}function i(){t=new WeakMap}return{get:n,dispose:i}}function LS(){const t={};return{get:function(e){if(t[e.id]!==void 0)return t[e.id];let n;switch(e.type){case"DirectionalLight":n={direction:new T,color:new ke};break;case"SpotLight":n={position:new T,direction:new T,color:new ke,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":n={position:new T,color:new ke,distance:0,decay:0};break;case"HemisphereLight":n={direction:new T,skyColor:new ke,groundColor:new ke};break;case"RectAreaLight":n={color:new ke,position:new T,halfWidth:new T,halfHeight:new T};break}return t[e.id]=n,n}}}function RS(){const t={};return{get:function(e){if(t[e.id]!==void 0)return t[e.id];let n;switch(e.type){case"DirectionalLight":n={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Te};break;case"SpotLight":n={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Te};break;case"PointLight":n={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Te,shadowCameraNear:1,shadowCameraFar:1e3};break}return t[e.id]=n,n}}}let DS=0;function BS(t,e){return(e.castShadow?1:0)-(t.castShadow?1:0)}function OS(){const t=new LS,e=RS(),n={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let a=0;a<9;a++)n.probe.push(new T);const i=new T,r=new Ie,s=new Ie;function o(a,c,l){let h=0,u=0,f=0;for(let w=0;w<9;w++)n.probe[w].set(0,0,0);let d=0,p=0,y=0,g=0,m=0,x=0,v=0,b=0;const _=l.matrixWorldInverse;a.sort(BS);for(let w=0,S=a.length;w<S;w++){const M=a[w],B=M.color,L=M.intensity,U=M.distance,E=M.shadow&&M.shadow.map?M.shadow.map.texture:null;if(M.isAmbientLight)h+=B.r*L,u+=B.g*L,f+=B.b*L;else if(M.isLightProbe)for(let O=0;O<9;O++)n.probe[O].addScaledVector(M.sh.coefficients[O],L);else if(M.isDirectionalLight){const O=t.get(M);if(O.color.copy(M.color).multiplyScalar(M.intensity),O.direction.setFromMatrixPosition(M.matrixWorld),i.setFromMatrixPosition(M.target.matrixWorld),O.direction.sub(i),O.direction.transformDirection(_),M.castShadow){const k=M.shadow,ne=e.get(M);ne.shadowBias=k.bias,ne.shadowNormalBias=k.normalBias,ne.shadowRadius=k.radius,ne.shadowMapSize=k.mapSize,n.directionalShadow[d]=ne,n.directionalShadowMap[d]=E,n.directionalShadowMatrix[d]=M.shadow.matrix,x++}n.directional[d]=O,d++}else if(M.isSpotLight){const O=t.get(M);if(O.position.setFromMatrixPosition(M.matrixWorld),O.position.applyMatrix4(_),O.color.copy(B).multiplyScalar(L),O.distance=U,O.direction.setFromMatrixPosition(M.matrixWorld),i.setFromMatrixPosition(M.target.matrixWorld),O.direction.sub(i),O.direction.transformDirection(_),O.coneCos=Math.cos(M.angle),O.penumbraCos=Math.cos(M.angle*(1-M.penumbra)),O.decay=M.decay,M.castShadow){const k=M.shadow,ne=e.get(M);ne.shadowBias=k.bias,ne.shadowNormalBias=k.normalBias,ne.shadowRadius=k.radius,ne.shadowMapSize=k.mapSize,n.spotShadow[y]=ne,n.spotShadowMap[y]=E,n.spotShadowMatrix[y]=M.shadow.matrix,b++}n.spot[y]=O,y++}else if(M.isRectAreaLight){const O=t.get(M);O.color.copy(B).multiplyScalar(L),O.position.setFromMatrixPosition(M.matrixWorld),O.position.applyMatrix4(_),s.identity(),r.copy(M.matrixWorld),r.premultiply(_),s.extractRotation(r),O.halfWidth.set(M.width*.5,0,0),O.halfHeight.set(0,M.height*.5,0),O.halfWidth.applyMatrix4(s),O.halfHeight.applyMatrix4(s),n.rectArea[g]=O,g++}else if(M.isPointLight){const O=t.get(M);if(O.position.setFromMatrixPosition(M.matrixWorld),O.position.applyMatrix4(_),O.color.copy(M.color).multiplyScalar(M.intensity),O.distance=M.distance,O.decay=M.decay,M.castShadow){const k=M.shadow,ne=e.get(M);ne.shadowBias=k.bias,ne.shadowNormalBias=k.normalBias,ne.shadowRadius=k.radius,ne.shadowMapSize=k.mapSize,ne.shadowCameraNear=k.camera.near,ne.shadowCameraFar=k.camera.far,n.pointShadow[p]=ne,n.pointShadowMap[p]=E,n.pointShadowMatrix[p]=M.shadow.matrix,v++}n.point[p]=O,p++}else if(M.isHemisphereLight){const O=t.get(M);O.direction.setFromMatrixPosition(M.matrixWorld),O.direction.transformDirection(_),O.direction.normalize(),O.skyColor.copy(M.color).multiplyScalar(L),O.groundColor.copy(M.groundColor).multiplyScalar(L),n.hemi[m]=O,m++}}n.ambient[0]=h,n.ambient[1]=u,n.ambient[2]=f;const C=n.hash;(C.directionalLength!==d||C.pointLength!==p||C.spotLength!==y||C.rectAreaLength!==g||C.hemiLength!==m||C.numDirectionalShadows!==x||C.numPointShadows!==v||C.numSpotShadows!==b)&&(n.directional.length=d,n.spot.length=y,n.rectArea.length=g,n.point.length=p,n.hemi.length=m,n.directionalShadow.length=x,n.directionalShadowMap.length=x,n.pointShadow.length=v,n.pointShadowMap.length=v,n.spotShadow.length=b,n.spotShadowMap.length=b,n.directionalShadowMatrix.length=x,n.pointShadowMatrix.length=v,n.spotShadowMatrix.length=b,C.directionalLength=d,C.pointLength=p,C.spotLength=y,C.rectAreaLength=g,C.hemiLength=m,C.numDirectionalShadows=x,C.numPointShadows=v,C.numSpotShadows=b,n.version=DS++)}return{setup:o,state:n}}function xg(){const t=new OS,e=[],n=[];function i(){e.length=0,n.length=0}function r(c){e.push(c)}function s(c){n.push(c)}function o(c){t.setup(e,n,c)}return{init:i,state:{lightsArray:e,shadowsArray:n,lights:t},setupLights:o,pushLight:r,pushShadow:s}}function kS(){let t=new WeakMap;function e(r){const s=r.target;s.removeEventListener("dispose",e),t.delete(s)}function n(r,s){let o;return t.has(r)===!1?(o=new xg,t.set(r,new WeakMap),t.get(r).set(s,o),r.addEventListener("dispose",e)):t.get(r).has(s)===!1?(o=new xg,t.get(r).set(s,o)):o=t.get(r).get(s),o}function i(){t=new WeakMap}return{get:n,dispose:i}}function xs(t){at.call(this),this.type="MeshDepthMaterial",this.depthPacking=P_,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(t)}xs.prototype=Object.create(at.prototype);xs.prototype.constructor=xs;xs.prototype.isMeshDepthMaterial=!0;xs.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.depthPacking=t.depthPacking,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this};function bs(t){at.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new T,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(t)}bs.prototype=Object.create(at.prototype);bs.prototype.constructor=bs;bs.prototype.isMeshDistanceMaterial=!0;bs.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.referencePosition.copy(t.referencePosition),this.nearDistance=t.nearDistance,this.farDistance=t.farDistance,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this};var FS=`uniform sampler2D shadow_pass;
uniform vec2 resolution;
uniform float radius;
#include <packing>
void main() {
  float mean = 0.0;
  float squared_mean = 0.0;
	float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy  ) / resolution ) );
  for ( float i = -1.0; i < 1.0 ; i += SAMPLE_RATE) {
    #ifdef HORIZONAL_PASS
      vec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( i, 0.0 ) * radius ) / resolution ) );
      mean += distribution.x;
      squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;
    #else
      float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0,  i )  * radius ) / resolution ) );
      mean += depth;
      squared_mean += depth * depth;
    #endif
  }
  mean = mean * HALF_SAMPLE_RATE;
  squared_mean = squared_mean * HALF_SAMPLE_RATE;
  float std_dev = sqrt( squared_mean - mean * mean );
  gl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );
}`,NS=`void main() {
	gl_Position = vec4( position, 1.0 );
}`;function Zy(t,e,n){let i=new Zc;const r=new Te,s=new Te,o=new Ft,a=[],c=[],l={},h={0:yn,1:Yo,2:jc},u=new bn({defines:{SAMPLE_RATE:2/8,HALF_SAMPLE_RATE:1/8},uniforms:{shadow_pass:{value:null},resolution:{value:new Te},radius:{value:4}},vertexShader:NS,fragmentShader:FS}),f=u.clone();f.defines.HORIZONAL_PASS=1;const d=new We;d.setAttribute("position",new Qe(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const p=new Ht(d,u),y=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=Py,this.render=function(_,C,w){if(y.enabled===!1||y.autoUpdate===!1&&y.needsUpdate===!1||_.length===0)return;const S=t.getRenderTarget(),M=t.getActiveCubeFace(),B=t.getActiveMipmapLevel(),L=t.state;L.setBlending(or),L.buffers.color.setClear(1,1,1,1),L.buffers.depth.setTest(!0),L.setScissorTest(!1);for(let U=0,E=_.length;U<E;U++){const O=_[U],k=O.shadow;if(k.autoUpdate===!1&&k.needsUpdate===!1)continue;if(k===void 0){console.warn("THREE.WebGLShadowMap:",O,"has no shadow.");continue}r.copy(k.mapSize);const ne=k.getFrameExtents();if(r.multiply(ne),s.copy(k.mapSize),(r.x>n||r.y>n)&&(r.x>n&&(s.x=Math.floor(n/ne.x),r.x=s.x*ne.x,k.mapSize.x=s.x),r.y>n&&(s.y=Math.floor(n/ne.y),r.y=s.y*ne.y,k.mapSize.y=s.y)),k.map===null&&!k.isPointLightShadow&&this.type===Ha){const F={minFilter:gn,magFilter:gn,format:Gn};k.map=new Rn(r.x,r.y,F),k.map.texture.name=O.name+".shadowMap",k.mapPass=new Rn(r.x,r.y,F),k.camera.updateProjectionMatrix()}if(k.map===null){const F={minFilter:zt,magFilter:zt,format:Gn};k.map=new Rn(r.x,r.y,F),k.map.texture.name=O.name+".shadowMap",k.camera.updateProjectionMatrix()}t.setRenderTarget(k.map),t.clear();const Y=k.getViewportCount();for(let F=0;F<Y;F++){const te=k.getViewport(F);o.set(s.x*te.x,s.y*te.y,s.x*te.z,s.y*te.w),L.viewport(o),k.updateMatrices(O,F),i=k.getFrustum(),b(C,w,k.camera,O,this.type)}!k.isPointLightShadow&&this.type===Ha&&g(k,w),k.needsUpdate=!1}y.needsUpdate=!1,t.setRenderTarget(S,M,B)};function g(_,C){const w=e.update(p);u.uniforms.shadow_pass.value=_.map.texture,u.uniforms.resolution.value=_.mapSize,u.uniforms.radius.value=_.radius,t.setRenderTarget(_.mapPass),t.clear(),t.renderBufferDirect(C,null,w,u,p,null),f.uniforms.shadow_pass.value=_.mapPass.texture,f.uniforms.resolution.value=_.mapSize,f.uniforms.radius.value=_.radius,t.setRenderTarget(_.map),t.clear(),t.renderBufferDirect(C,null,w,f,p,null)}function m(_,C,w){const S=_<<0|C<<1|w<<2;let M=a[S];return M===void 0&&(M=new xs({depthPacking:E_,morphTargets:_,skinning:C}),a[S]=M),M}function x(_,C,w){const S=_<<0|C<<1|w<<2;let M=c[S];return M===void 0&&(M=new bs({morphTargets:_,skinning:C}),c[S]=M),M}function v(_,C,w,S,M,B,L){let U=null,E=m,O=_.customDepthMaterial;if(S.isPointLight===!0&&(E=x,O=_.customDistanceMaterial),O===void 0){let k=!1;w.morphTargets===!0&&(k=C.morphAttributes&&C.morphAttributes.position&&C.morphAttributes.position.length>0);let ne=!1;_.isSkinnedMesh===!0&&(w.skinning===!0?ne=!0:console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",_));const Y=_.isInstancedMesh===!0;U=E(k,ne,Y)}else U=O;if(t.localClippingEnabled&&w.clipShadows===!0&&w.clippingPlanes.length!==0){const k=U.uuid,ne=w.uuid;let Y=l[k];Y===void 0&&(Y={},l[k]=Y);let F=Y[ne];F===void 0&&(F=U.clone(),Y[ne]=F),U=F}return U.visible=w.visible,U.wireframe=w.wireframe,L===Ha?U.side=w.shadowSide!==null?w.shadowSide:w.side:U.side=w.shadowSide!==null?w.shadowSide:h[w.side],U.clipShadows=w.clipShadows,U.clippingPlanes=w.clippingPlanes,U.clipIntersection=w.clipIntersection,U.wireframeLinewidth=w.wireframeLinewidth,U.linewidth=w.linewidth,S.isPointLight===!0&&U.isMeshDistanceMaterial===!0&&(U.referencePosition.setFromMatrixPosition(S.matrixWorld),U.nearDistance=M,U.farDistance=B),U}function b(_,C,w,S,M){if(_.visible===!1)return;if(_.layers.test(C.layers)&&(_.isMesh||_.isLine||_.isPoints)&&(_.castShadow||_.receiveShadow&&M===Ha)&&(!_.frustumCulled||i.intersectsObject(_))){_.modelViewMatrix.multiplyMatrices(w.matrixWorldInverse,_.matrixWorld);const U=e.update(_),E=_.material;if(Array.isArray(E)){const O=U.groups;for(let k=0,ne=O.length;k<ne;k++){const Y=O[k],F=E[Y.materialIndex];if(F&&F.visible){const te=v(_,U,F,S,w.near,w.far,M);t.renderBufferDirect(w,null,U,te,_,Y)}}}else if(E.visible){const O=v(_,U,E,S,w.near,w.far,M);t.renderBufferDirect(w,null,U,O,_,null)}}const L=_.children;for(let U=0,E=L.length;U<E;U++)b(L[U],C,w,S,M)}}function zS(t,e,n){const i=n.isWebGL2;function r(){let X=!1;const ye=new Ft;let _e=null;const xe=new Ft(0,0,0,0);return{setMask:function(Se){_e!==Se&&!X&&(t.colorMask(Se,Se,Se,Se),_e=Se)},setLocked:function(Se){X=Se},setClear:function(Se,Me,Oe,Ne,we){we===!0&&(Se*=Ne,Me*=Ne,Oe*=Ne),ye.set(Se,Me,Oe,Ne),xe.equals(ye)===!1&&(t.clearColor(Se,Me,Oe,Ne),xe.copy(ye))},reset:function(){X=!1,_e=null,xe.set(-1,0,0,0)}}}function s(){let X=!1,ye=null,_e=null,xe=null;return{setTest:function(Se){Se?ee(2929):j(2929)},setMask:function(Se){ye!==Se&&!X&&(t.depthMask(Se),ye=Se)},setFunc:function(Se){if(_e!==Se){if(Se)switch(Se){case yv:t.depthFunc(512);break;case xv:t.depthFunc(519);break;case bv:t.depthFunc(513);break;case Rf:t.depthFunc(515);break;case vv:t.depthFunc(514);break;case _v:t.depthFunc(518);break;case wv:t.depthFunc(516);break;case Sv:t.depthFunc(517);break;default:t.depthFunc(515)}else t.depthFunc(515);_e=Se}},setLocked:function(Se){X=Se},setClear:function(Se){xe!==Se&&(t.clearDepth(Se),xe=Se)},reset:function(){X=!1,ye=null,_e=null,xe=null}}}function o(){let X=!1,ye=null,_e=null,xe=null,Se=null,Me=null,Oe=null,Ne=null,we=null;return{setTest:function(Fe){X||(Fe?ee(2960):j(2960))},setMask:function(Fe){ye!==Fe&&!X&&(t.stencilMask(Fe),ye=Fe)},setFunc:function(Fe,je,Be){(_e!==Fe||xe!==je||Se!==Be)&&(t.stencilFunc(Fe,je,Be),_e=Fe,xe=je,Se=Be)},setOp:function(Fe,je,Be){(Me!==Fe||Oe!==je||Ne!==Be)&&(t.stencilOp(Fe,je,Be),Me=Fe,Oe=je,Ne=Be)},setLocked:function(Fe){X=Fe},setClear:function(Fe){we!==Fe&&(t.clearStencil(Fe),we=Fe)},reset:function(){X=!1,ye=null,_e=null,xe=null,Se=null,Me=null,Oe=null,Ne=null,we=null}}}const a=new r,c=new s,l=new o;let h={},u=null,f=null,d=null,p=null,y=null,g=null,m=null,x=null,v=null,b=!1,_=null,C=null,w=null,S=null,M=null;const B=t.getParameter(35661);let L=!1,U=0;const E=t.getParameter(7938);E.indexOf("WebGL")!==-1?(U=parseFloat(/^WebGL\ ([0-9])/.exec(E)[1]),L=U>=1):E.indexOf("OpenGL ES")!==-1&&(U=parseFloat(/^OpenGL\ ES\ ([0-9])/.exec(E)[1]),L=U>=2);let O=null,k={};const ne=new Ft,Y=new Ft;function F(X,ye,_e){const xe=new Uint8Array(4),Se=t.createTexture();t.bindTexture(X,Se),t.texParameteri(X,10241,9728),t.texParameteri(X,10240,9728);for(let Me=0;Me<_e;Me++)t.texImage2D(ye+Me,0,6408,1,1,0,6408,5121,xe);return Se}const te={};te[3553]=F(3553,3553,1),te[34067]=F(34067,34069,6),a.setClear(0,0,0,1),c.setClear(1),l.setClear(0),ee(2929),c.setFunc(Rf),re(!1),q(Bm),ee(2884),oe(or);function ee(X){h[X]!==!0&&(t.enable(X),h[X]=!0)}function j(X){h[X]!==!1&&(t.disable(X),h[X]=!1)}function Z(X){return u!==X?(t.useProgram(X),u=X,!0):!1}const ce={[ro]:32774,[ov]:32778,[av]:32779};if(i)ce[Fm]=32775,ce[Nm]=32776;else{const X=e.get("EXT_blend_minmax");X!==null&&(ce[Fm]=X.MIN_EXT,ce[Nm]=X.MAX_EXT)}const de={[cv]:0,[lv]:1,[hv]:768,[Iy]:770,[gv]:776,[pv]:774,[dv]:772,[uv]:769,[Ly]:771,[mv]:775,[fv]:773};function oe(X,ye,_e,xe,Se,Me,Oe,Ne){if(X===or){f&&(j(3042),f=!1);return}if(f||(ee(3042),f=!0),X!==sv){if(X!==d||Ne!==b){if((p!==ro||m!==ro)&&(t.blendEquation(32774),p=ro,m=ro),Ne)switch(X){case Br:t.blendFuncSeparate(1,771,1,771);break;case Lf:t.blendFunc(1,1);break;case Om:t.blendFuncSeparate(0,0,769,771);break;case km:t.blendFuncSeparate(0,768,0,770);break;default:console.error("THREE.WebGLState: Invalid blending: ",X);break}else switch(X){case Br:t.blendFuncSeparate(770,771,1,771);break;case Lf:t.blendFunc(770,1);break;case Om:t.blendFunc(0,769);break;case km:t.blendFunc(0,768);break;default:console.error("THREE.WebGLState: Invalid blending: ",X);break}y=null,g=null,x=null,v=null,d=X,b=Ne}return}Se=Se||ye,Me=Me||_e,Oe=Oe||xe,(ye!==p||Se!==m)&&(t.blendEquationSeparate(ce[ye],ce[Se]),p=ye,m=Se),(_e!==y||xe!==g||Me!==x||Oe!==v)&&(t.blendFuncSeparate(de[_e],de[xe],de[Me],de[Oe]),y=_e,g=xe,x=Me,v=Oe),d=X,b=null}function V(X,ye){X.side===jc?j(2884):ee(2884);let _e=X.side===yn;ye&&(_e=!_e),re(_e),X.blending===Br&&X.transparent===!1?oe(or):oe(X.blending,X.blendEquation,X.blendSrc,X.blendDst,X.blendEquationAlpha,X.blendSrcAlpha,X.blendDstAlpha,X.premultipliedAlpha),c.setFunc(X.depthFunc),c.setTest(X.depthTest),c.setMask(X.depthWrite),a.setMask(X.colorWrite);const xe=X.stencilWrite;l.setTest(xe),xe&&(l.setMask(X.stencilWriteMask),l.setFunc(X.stencilFunc,X.stencilRef,X.stencilFuncMask),l.setOp(X.stencilFail,X.stencilZFail,X.stencilZPass)),W(X.polygonOffset,X.polygonOffsetFactor,X.polygonOffsetUnits)}function re(X){_!==X&&(X?t.frontFace(2304):t.frontFace(2305),_=X)}function q(X){X!==nv?(ee(2884),X!==C&&(X===Bm?t.cullFace(1029):X===iv?t.cullFace(1028):t.cullFace(1032))):j(2884),C=X}function J(X){X!==w&&(L&&t.lineWidth(X),w=X)}function W(X,ye,_e){X?(ee(32823),(S!==ye||M!==_e)&&(t.polygonOffset(ye,_e),S=ye,M=_e)):j(32823)}function H(X){X?ee(3089):j(3089)}function se(X){X===void 0&&(X=33984+B-1),O!==X&&(t.activeTexture(X),O=X)}function $(X,ye){O===null&&se();let _e=k[O];_e===void 0&&(_e={type:void 0,texture:void 0},k[O]=_e),(_e.type!==X||_e.texture!==ye)&&(t.bindTexture(X,ye||te[X]),_e.type=X,_e.texture=ye)}function he(){const X=k[O];X!==void 0&&X.type!==void 0&&(t.bindTexture(X.type,null),X.type=void 0,X.texture=void 0)}function me(){try{t.compressedTexImage2D.apply(t,arguments)}catch(X){console.error("THREE.WebGLState:",X)}}function le(){try{t.texImage2D.apply(t,arguments)}catch(X){console.error("THREE.WebGLState:",X)}}function D(){try{t.texImage3D.apply(t,arguments)}catch(X){console.error("THREE.WebGLState:",X)}}function N(X){ne.equals(X)===!1&&(t.scissor(X.x,X.y,X.z,X.w),ne.copy(X))}function pe(X){Y.equals(X)===!1&&(t.viewport(X.x,X.y,X.z,X.w),Y.copy(X))}function ue(){h={},O=null,k={},u=null,d=null,_=null,C=null,a.reset(),c.reset(),l.reset()}return{buffers:{color:a,depth:c,stencil:l},enable:ee,disable:j,useProgram:Z,setBlending:oe,setMaterial:V,setFlipSided:re,setCullFace:q,setLineWidth:J,setPolygonOffset:W,setScissorTest:H,activeTexture:se,bindTexture:$,unbindTexture:he,compressedTexImage2D:me,texImage2D:le,texImage3D:D,scissor:N,viewport:pe,reset:ue}}function GS(t,e,n,i,r,s,o){const a=r.isWebGL2,c=r.maxTextures,l=r.maxCubemapSize,h=r.maxTextureSize,u=r.maxSamples,f=new WeakMap;let d,p=!1;try{p=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")!==null}catch{}function y(D,N){return p?new OffscreenCanvas(D,N):document.createElementNS("http://www.w3.org/1999/xhtml","canvas")}function g(D,N,pe,ue){let X=1;if((D.width>ue||D.height>ue)&&(X=ue/Math.max(D.width,D.height)),X<1||N===!0)if(typeof HTMLImageElement<"u"&&D instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&D instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&D instanceof ImageBitmap){const ye=N?ut.floorPowerOfTwo:Math.floor,_e=ye(X*D.width),xe=ye(X*D.height);d===void 0&&(d=y(_e,xe));const Se=pe?y(_e,xe):d;return Se.width=_e,Se.height=xe,Se.getContext("2d").drawImage(D,0,0,_e,xe),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+D.width+"x"+D.height+") to ("+_e+"x"+xe+")."),Se}else return"data"in D&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+D.width+"x"+D.height+")."),D;return D}function m(D){return ut.isPowerOfTwo(D.width)&&ut.isPowerOfTwo(D.height)}function x(D){return a?!1:D.wrapS!==zn||D.wrapT!==zn||D.minFilter!==zt&&D.minFilter!==gn}function v(D,N){return D.generateMipmaps&&N&&D.minFilter!==zt&&D.minFilter!==gn}function b(D,N,pe,ue){t.generateMipmap(D);const X=i.get(N);X.__maxMipLevel=Math.log(Math.max(pe,ue))*Math.LOG2E}function _(D,N,pe){if(a===!1)return N;if(D!==null){if(t[D]!==void 0)return t[D];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+D+"'")}let ue=N;return N===6403&&(pe===5126&&(ue=33326),pe===5131&&(ue=33325),pe===5121&&(ue=33321)),N===6407&&(pe===5126&&(ue=34837),pe===5131&&(ue=34843),pe===5121&&(ue=32849)),N===6408&&(pe===5126&&(ue=34836),pe===5131&&(ue=34842),pe===5121&&(ue=32856)),(ue===33325||ue===33326||ue===34842||ue===34836)&&e.get("EXT_color_buffer_float"),ue}function C(D){return D===zt||D===Df||D===Bf?9728:9729}function w(D){const N=D.target;N.removeEventListener("dispose",w),M(N),N.isVideoTexture&&f.delete(N),o.memory.textures--}function S(D){const N=D.target;N.removeEventListener("dispose",S),B(N),o.memory.textures--}function M(D){const N=i.get(D);N.__webglInit!==void 0&&(t.deleteTexture(N.__webglTexture),i.remove(D))}function B(D){const N=i.get(D),pe=i.get(D.texture);if(D){if(pe.__webglTexture!==void 0&&t.deleteTexture(pe.__webglTexture),D.depthTexture&&D.depthTexture.dispose(),D.isWebGLCubeRenderTarget)for(let ue=0;ue<6;ue++)t.deleteFramebuffer(N.__webglFramebuffer[ue]),N.__webglDepthbuffer&&t.deleteRenderbuffer(N.__webglDepthbuffer[ue]);else t.deleteFramebuffer(N.__webglFramebuffer),N.__webglDepthbuffer&&t.deleteRenderbuffer(N.__webglDepthbuffer),N.__webglMultisampledFramebuffer&&t.deleteFramebuffer(N.__webglMultisampledFramebuffer),N.__webglColorRenderbuffer&&t.deleteRenderbuffer(N.__webglColorRenderbuffer),N.__webglDepthRenderbuffer&&t.deleteRenderbuffer(N.__webglDepthRenderbuffer);i.remove(D.texture),i.remove(D)}}let L=0;function U(){L=0}function E(){const D=L;return D>=c&&console.warn("THREE.WebGLTextures: Trying to use "+D+" texture units while this GPU supports only "+c),L+=1,D}function O(D,N){const pe=i.get(D);if(D.isVideoTexture&&se(D),D.version>0&&pe.__version!==D.version){const ue=D.image;if(ue===void 0)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined");else if(ue.complete===!1)console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete");else{ce(pe,D,N);return}}n.activeTexture(33984+N),n.bindTexture(3553,pe.__webglTexture)}function k(D,N){const pe=i.get(D);if(D.version>0&&pe.__version!==D.version){ce(pe,D,N);return}n.activeTexture(33984+N),n.bindTexture(35866,pe.__webglTexture)}function ne(D,N){const pe=i.get(D);if(D.version>0&&pe.__version!==D.version){ce(pe,D,N);return}n.activeTexture(33984+N),n.bindTexture(32879,pe.__webglTexture)}function Y(D,N){if(D.image.length!==6)return;const pe=i.get(D);if(D.version>0&&pe.__version!==D.version){Z(pe,D),n.activeTexture(33984+N),n.bindTexture(34067,pe.__webglTexture),t.pixelStorei(37440,D.flipY);const ue=D&&(D.isCompressedTexture||D.image[0].isCompressedTexture),X=D.image[0]&&D.image[0].isDataTexture,ye=[];for(let we=0;we<6;we++)!ue&&!X?ye[we]=g(D.image[we],!1,!0,l):ye[we]=X?D.image[we].image:D.image[we];const _e=ye[0],xe=m(_e)||a,Se=s.convert(D.format),Me=s.convert(D.type),Oe=_(D.internalFormat,Se,Me);j(34067,D,xe);let Ne;if(ue){for(let we=0;we<6;we++){Ne=ye[we].mipmaps;for(let Fe=0;Fe<Ne.length;Fe++){const je=Ne[Fe];D.format!==Gn&&D.format!==us?Se!==null?n.compressedTexImage2D(34069+we,Fe,Oe,je.width,je.height,0,je.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):n.texImage2D(34069+we,Fe,Oe,je.width,je.height,0,Se,Me,je.data)}}pe.__maxMipLevel=Ne.length-1}else{Ne=D.mipmaps;for(let we=0;we<6;we++)if(X){n.texImage2D(34069+we,0,Oe,ye[we].width,ye[we].height,0,Se,Me,ye[we].data);for(let Fe=0;Fe<Ne.length;Fe++){const Be=Ne[Fe].image[we].image;n.texImage2D(34069+we,Fe+1,Oe,Be.width,Be.height,0,Se,Me,Be.data)}}else{n.texImage2D(34069+we,0,Oe,Se,Me,ye[we]);for(let Fe=0;Fe<Ne.length;Fe++){const je=Ne[Fe];n.texImage2D(34069+we,Fe+1,Oe,Se,Me,je.image[we])}}pe.__maxMipLevel=Ne.length}v(D,xe)&&b(34067,D,_e.width,_e.height),pe.__version=D.version,D.onUpdate&&D.onUpdate(D)}else n.activeTexture(33984+N),n.bindTexture(34067,pe.__webglTexture)}function F(D,N){n.activeTexture(33984+N),n.bindTexture(34067,i.get(D).__webglTexture)}const te={[Th]:10497,[zn]:33071,[Ph]:33648},ee={[zt]:9728,[Df]:9984,[Bf]:9986,[gn]:9729,[Dy]:9985,[Cu]:9987};function j(D,N,pe){pe?(t.texParameteri(D,10242,te[N.wrapS]),t.texParameteri(D,10243,te[N.wrapT]),(D===32879||D===35866)&&t.texParameteri(D,32882,te[N.wrapR]),t.texParameteri(D,10240,ee[N.magFilter]),t.texParameteri(D,10241,ee[N.minFilter])):(t.texParameteri(D,10242,33071),t.texParameteri(D,10243,33071),(D===32879||D===35866)&&t.texParameteri(D,32882,33071),(N.wrapS!==zn||N.wrapT!==zn)&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),t.texParameteri(D,10240,C(N.magFilter)),t.texParameteri(D,10241,C(N.minFilter)),N.minFilter!==zt&&N.minFilter!==gn&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter."));const ue=e.get("EXT_texture_filter_anisotropic");if(ue){if(N.type===sr&&e.get("OES_texture_float_linear")===null||N.type===Ih&&(a||e.get("OES_texture_half_float_linear"))===null)return;(N.anisotropy>1||i.get(N).__currentAnisotropy)&&(t.texParameterf(D,ue.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(N.anisotropy,r.getMaxAnisotropy())),i.get(N).__currentAnisotropy=N.anisotropy)}}function Z(D,N){D.__webglInit===void 0&&(D.__webglInit=!0,N.addEventListener("dispose",w),D.__webglTexture=t.createTexture(),o.memory.textures++)}function ce(D,N,pe){let ue=3553;N.isDataTexture2DArray&&(ue=35866),N.isDataTexture3D&&(ue=32879),Z(D,N),n.activeTexture(33984+pe),n.bindTexture(ue,D.__webglTexture),t.pixelStorei(37440,N.flipY),t.pixelStorei(37441,N.premultiplyAlpha),t.pixelStorei(3317,N.unpackAlignment);const X=x(N)&&m(N.image)===!1,ye=g(N.image,X,!1,h),_e=m(ye)||a,xe=s.convert(N.format);let Se=s.convert(N.type),Me=_(N.internalFormat,xe,Se);j(ue,N,_e);let Oe;const Ne=N.mipmaps;if(N.isDepthTexture)Me=6402,a?N.type===sr?Me=36012:N.type===ph?Me=33190:N.type===Za?Me=35056:Me=33189:N.type===sr&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),N.format===xo&&Me===6402&&N.type!==Eh&&N.type!==ph&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),N.type=Eh,Se=s.convert(N.type)),N.format===sc&&Me===6402&&(Me=34041,N.type!==Za&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),N.type=Za,Se=s.convert(N.type))),n.texImage2D(3553,0,Me,ye.width,ye.height,0,xe,Se,null);else if(N.isDataTexture)if(Ne.length>0&&_e){for(let we=0,Fe=Ne.length;we<Fe;we++)Oe=Ne[we],n.texImage2D(3553,we,Me,Oe.width,Oe.height,0,xe,Se,Oe.data);N.generateMipmaps=!1,D.__maxMipLevel=Ne.length-1}else n.texImage2D(3553,0,Me,ye.width,ye.height,0,xe,Se,ye.data),D.__maxMipLevel=0;else if(N.isCompressedTexture){for(let we=0,Fe=Ne.length;we<Fe;we++)Oe=Ne[we],N.format!==Gn&&N.format!==us?xe!==null?n.compressedTexImage2D(3553,we,Me,Oe.width,Oe.height,0,Oe.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):n.texImage2D(3553,we,Me,Oe.width,Oe.height,0,xe,Se,Oe.data);D.__maxMipLevel=Ne.length-1}else if(N.isDataTexture2DArray)n.texImage3D(35866,0,Me,ye.width,ye.height,ye.depth,0,xe,Se,ye.data),D.__maxMipLevel=0;else if(N.isDataTexture3D)n.texImage3D(32879,0,Me,ye.width,ye.height,ye.depth,0,xe,Se,ye.data),D.__maxMipLevel=0;else if(Ne.length>0&&_e){for(let we=0,Fe=Ne.length;we<Fe;we++)Oe=Ne[we],n.texImage2D(3553,we,Me,xe,Se,Oe);N.generateMipmaps=!1,D.__maxMipLevel=Ne.length-1}else n.texImage2D(3553,0,Me,xe,Se,ye),D.__maxMipLevel=0;v(N,_e)&&b(ue,N,ye.width,ye.height),D.__version=N.version,N.onUpdate&&N.onUpdate(N)}function de(D,N,pe,ue){const X=s.convert(N.texture.format),ye=s.convert(N.texture.type),_e=_(N.texture.internalFormat,X,ye);n.texImage2D(ue,0,_e,N.width,N.height,0,X,ye,null),t.bindFramebuffer(36160,D),t.framebufferTexture2D(36160,pe,ue,i.get(N.texture).__webglTexture,0),t.bindFramebuffer(36160,null)}function oe(D,N,pe){if(t.bindRenderbuffer(36161,D),N.depthBuffer&&!N.stencilBuffer){let ue=33189;if(pe){const X=N.depthTexture;X&&X.isDepthTexture&&(X.type===sr?ue=36012:X.type===ph&&(ue=33190));const ye=H(N);t.renderbufferStorageMultisample(36161,ye,ue,N.width,N.height)}else t.renderbufferStorage(36161,ue,N.width,N.height);t.framebufferRenderbuffer(36160,36096,36161,D)}else if(N.depthBuffer&&N.stencilBuffer){if(pe){const ue=H(N);t.renderbufferStorageMultisample(36161,ue,35056,N.width,N.height)}else t.renderbufferStorage(36161,34041,N.width,N.height);t.framebufferRenderbuffer(36160,33306,36161,D)}else{const ue=s.convert(N.texture.format),X=s.convert(N.texture.type),ye=_(N.texture.internalFormat,ue,X);if(pe){const _e=H(N);t.renderbufferStorageMultisample(36161,_e,ye,N.width,N.height)}else t.renderbufferStorage(36161,ye,N.width,N.height)}t.bindRenderbuffer(36161,null)}function V(D,N){if(N&&N.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(36160,D),!(N.depthTexture&&N.depthTexture.isDepthTexture))throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");(!i.get(N.depthTexture).__webglTexture||N.depthTexture.image.width!==N.width||N.depthTexture.image.height!==N.height)&&(N.depthTexture.image.width=N.width,N.depthTexture.image.height=N.height,N.depthTexture.needsUpdate=!0),O(N.depthTexture,0);const ue=i.get(N.depthTexture).__webglTexture;if(N.depthTexture.format===xo)t.framebufferTexture2D(36160,36096,3553,ue,0);else if(N.depthTexture.format===sc)t.framebufferTexture2D(36160,33306,3553,ue,0);else throw new Error("Unknown depthTexture format")}function re(D){const N=i.get(D),pe=D.isWebGLCubeRenderTarget===!0;if(D.depthTexture){if(pe)throw new Error("target.depthTexture not supported in Cube render targets");V(N.__webglFramebuffer,D)}else if(pe){N.__webglDepthbuffer=[];for(let ue=0;ue<6;ue++)t.bindFramebuffer(36160,N.__webglFramebuffer[ue]),N.__webglDepthbuffer[ue]=t.createRenderbuffer(),oe(N.__webglDepthbuffer[ue],D,!1)}else t.bindFramebuffer(36160,N.__webglFramebuffer),N.__webglDepthbuffer=t.createRenderbuffer(),oe(N.__webglDepthbuffer,D,!1);t.bindFramebuffer(36160,null)}function q(D){const N=i.get(D),pe=i.get(D.texture);D.addEventListener("dispose",S),pe.__webglTexture=t.createTexture(),o.memory.textures++;const ue=D.isWebGLCubeRenderTarget===!0,X=D.isWebGLMultisampleRenderTarget===!0,ye=m(D)||a;if(a&&D.texture.format===us&&(D.texture.type===sr||D.texture.type===Ih)&&(D.texture.format=Gn,console.warn("THREE.WebGLRenderer: Rendering to textures with RGB format is not supported. Using RGBA format instead.")),ue){N.__webglFramebuffer=[];for(let _e=0;_e<6;_e++)N.__webglFramebuffer[_e]=t.createFramebuffer()}else if(N.__webglFramebuffer=t.createFramebuffer(),X)if(a){N.__webglMultisampledFramebuffer=t.createFramebuffer(),N.__webglColorRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,N.__webglColorRenderbuffer);const _e=s.convert(D.texture.format),xe=s.convert(D.texture.type),Se=_(D.texture.internalFormat,_e,xe),Me=H(D);t.renderbufferStorageMultisample(36161,Me,Se,D.width,D.height),t.bindFramebuffer(36160,N.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(36160,36064,36161,N.__webglColorRenderbuffer),t.bindRenderbuffer(36161,null),D.depthBuffer&&(N.__webglDepthRenderbuffer=t.createRenderbuffer(),oe(N.__webglDepthRenderbuffer,D,!0)),t.bindFramebuffer(36160,null)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.");if(ue){n.bindTexture(34067,pe.__webglTexture),j(34067,D.texture,ye);for(let _e=0;_e<6;_e++)de(N.__webglFramebuffer[_e],D,36064,34069+_e);v(D.texture,ye)&&b(34067,D.texture,D.width,D.height),n.bindTexture(34067,null)}else n.bindTexture(3553,pe.__webglTexture),j(3553,D.texture,ye),de(N.__webglFramebuffer,D,36064,3553),v(D.texture,ye)&&b(3553,D.texture,D.width,D.height),n.bindTexture(3553,null);D.depthBuffer&&re(D)}function J(D){const N=D.texture,pe=m(D)||a;if(v(N,pe)){const ue=D.isWebGLCubeRenderTarget?34067:3553,X=i.get(N).__webglTexture;n.bindTexture(ue,X),b(ue,N,D.width,D.height),n.bindTexture(ue,null)}}function W(D){if(D.isWebGLMultisampleRenderTarget)if(a){const N=i.get(D);t.bindFramebuffer(36008,N.__webglMultisampledFramebuffer),t.bindFramebuffer(36009,N.__webglFramebuffer);const pe=D.width,ue=D.height;let X=16384;D.depthBuffer&&(X|=256),D.stencilBuffer&&(X|=1024),t.blitFramebuffer(0,0,pe,ue,0,0,pe,ue,X,9728),t.bindFramebuffer(36160,N.__webglMultisampledFramebuffer)}else console.warn("THREE.WebGLRenderer: WebGLMultisampleRenderTarget can only be used with WebGL2.")}function H(D){return a&&D.isWebGLMultisampleRenderTarget?Math.min(u,D.samples):0}function se(D){const N=o.render.frame;f.get(D)!==N&&(f.set(D,N),D.update())}let $=!1,he=!1;function me(D,N){D&&D.isWebGLRenderTarget&&($===!1&&(console.warn("THREE.WebGLTextures.safeSetTexture2D: don't use render targets as textures. Use their .texture property instead."),$=!0),D=D.texture),O(D,N)}function le(D,N){D&&D.isWebGLCubeRenderTarget&&(he===!1&&(console.warn("THREE.WebGLTextures.safeSetTextureCube: don't use cube render targets as textures. Use their .texture property instead."),he=!0),D=D.texture),D&&D.isCubeTexture||Array.isArray(D.image)&&D.image.length===6?Y(D,N):F(D,N)}this.allocateTextureUnit=E,this.resetTextureUnits=U,this.setTexture2D=O,this.setTexture2DArray=k,this.setTexture3D=ne,this.setTextureCube=Y,this.setTextureCubeDynamic=F,this.setupRenderTarget=q,this.updateRenderTargetMipmap=J,this.updateMultisampleRenderTarget=W,this.safeSetTexture2D=me,this.safeSetTextureCube=le}function US(t,e,n){const i=n.isWebGL2;function r(s){let o;if(s===gs)return 5121;if(s===Bv)return 32819;if(s===Ov)return 32820;if(s===kv)return 33635;if(s===Lv)return 5120;if(s===Rv)return 5122;if(s===Eh)return 5123;if(s===Dv)return 5124;if(s===ph)return 5125;if(s===sr)return 5126;if(s===Ih)return i?5131:(o=e.get("OES_texture_half_float"),o!==null?o.HALF_FLOAT_OES:null);if(s===Fv)return 6406;if(s===us)return 6407;if(s===Gn)return 6408;if(s===Nv)return 6409;if(s===zv)return 6410;if(s===xo)return 6402;if(s===sc)return 34041;if(s===Uv)return 6403;if(s===Vv)return 36244;if(s===Hv)return 33319;if(s===$v)return 33320;if(s===Wv)return 36248;if(s===jv)return 36249;if(s===zm||s===Gm||s===Um||s===Vm)if(o=e.get("WEBGL_compressed_texture_s3tc"),o!==null){if(s===zm)return o.COMPRESSED_RGB_S3TC_DXT1_EXT;if(s===Gm)return o.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(s===Um)return o.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(s===Vm)return o.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(s===Hm||s===$m||s===Wm||s===jm)if(o=e.get("WEBGL_compressed_texture_pvrtc"),o!==null){if(s===Hm)return o.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(s===$m)return o.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(s===Wm)return o.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(s===jm)return o.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null;if(s===qv)return o=e.get("WEBGL_compressed_texture_etc1"),o!==null?o.COMPRESSED_RGB_ETC1_WEBGL:null;if((s===qm||s===Xm)&&(o=e.get("WEBGL_compressed_texture_etc"),o!==null)){if(s===qm)return o.COMPRESSED_RGB8_ETC2;if(s===Xm)return o.COMPRESSED_RGBA8_ETC2_EAC}if(s===Xv||s===Yv||s===Zv||s===Kv||s===Jv||s===Qv||s===e_||s===t_||s===n_||s===i_||s===r_||s===s_||s===o_||s===a_||s===l_||s===h_||s===u_||s===d_||s===f_||s===p_||s===m_||s===g_||s===y_||s===x_||s===b_||s===v_||s===__||s===w_)return o=e.get("WEBGL_compressed_texture_astc"),o!==null?s:null;if(s===c_)return o=e.get("EXT_texture_compression_bptc"),o!==null?s:null;if(s===Za)return i?34042:(o=e.get("WEBGL_depth_texture"),o!==null?o.UNSIGNED_INT_24_8_WEBGL:null)}return{convert:r}}function Vf(t){pn.call(this),this.cameras=t||[]}Vf.prototype=Object.assign(Object.create(pn.prototype),{constructor:Vf,isArrayCamera:!0});function Ot(){$e.call(this),this.type="Group"}Ot.prototype=Object.assign(Object.create($e.prototype),{constructor:Ot,isGroup:!0});function Dh(){this._targetRay=null,this._grip=null}Object.assign(Dh.prototype,{constructor:Dh,getTargetRaySpace:function(){return this._targetRay===null&&(this._targetRay=new Ot,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1),this._targetRay},getGripSpace:function(){return this._grip===null&&(this._grip=new Ot,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1),this._grip},dispatchEvent:function(t){return this._targetRay!==null&&this._targetRay.dispatchEvent(t),this._grip!==null&&this._grip.dispatchEvent(t),this},disconnect:function(t){return this.dispatchEvent({type:"disconnected",data:t}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this},update:function(t,e,n){let i=null,r=null;const s=this._targetRay,o=this._grip;return t&&(s!==null&&(i=e.getPose(t.targetRaySpace,n),i!==null&&(s.matrix.fromArray(i.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale))),o!==null&&t.gripSpace&&(r=e.getPose(t.gripSpace,n),r!==null&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale)))),s!==null&&(s.visible=i!==null),o!==null&&(o.visible=r!==null),this}});function Ky(t,e){const n=this;let i=null,r=1,s=null,o="local-floor",a=null;const c=[],l=new Map,h=new pn;h.layers.enable(1),h.viewport=new Ft;const u=new pn;u.layers.enable(2),u.viewport=new Ft;const f=[h,u],d=new Vf;d.layers.enable(1),d.layers.enable(2);let p=null,y=null;this.enabled=!1,this.isPresenting=!1,this.getController=function(L){let U=c[L];return U===void 0&&(U=new Dh,c[L]=U),U.getTargetRaySpace()},this.getControllerGrip=function(L){let U=c[L];return U===void 0&&(U=new Dh,c[L]=U),U.getGripSpace()};function g(L){const U=l.get(L.inputSource);U&&U.dispatchEvent({type:L.type})}function m(){l.forEach(function(L,U){L.disconnect(U)}),l.clear(),t.setFramebuffer(null),t.setRenderTarget(t.getRenderTarget()),B.stop(),n.isPresenting=!1,n.dispatchEvent({type:"sessionend"})}function x(L){s=L,B.setContext(i),B.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}this.setFramebufferScaleFactor=function(L){r=L,n.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(L){o=L,n.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return s},this.getSession=function(){return i},this.setSession=function(L){if(i=L,i!==null){i.addEventListener("select",g),i.addEventListener("selectstart",g),i.addEventListener("selectend",g),i.addEventListener("squeeze",g),i.addEventListener("squeezestart",g),i.addEventListener("squeezeend",g),i.addEventListener("end",m);const U=e.getContextAttributes();U.xrCompatible!==!0&&e.makeXRCompatible();const E={antialias:U.antialias,alpha:U.alpha,depth:U.depth,stencil:U.stencil,framebufferScaleFactor:r},O=new XRWebGLLayer(i,e,E);i.updateRenderState({baseLayer:O}),i.requestReferenceSpace(o).then(x),i.addEventListener("inputsourceschange",v)}};function v(L){const U=i.inputSources;for(let E=0;E<c.length;E++)l.set(U[E],c[E]);for(let E=0;E<L.removed.length;E++){const O=L.removed[E],k=l.get(O);k&&(k.dispatchEvent({type:"disconnected",data:O}),l.delete(O))}for(let E=0;E<L.added.length;E++){const O=L.added[E],k=l.get(O);k&&k.dispatchEvent({type:"connected",data:O})}}const b=new T,_=new T;function C(L,U,E){b.setFromMatrixPosition(U.matrixWorld),_.setFromMatrixPosition(E.matrixWorld);const O=b.distanceTo(_),k=U.projectionMatrix.elements,ne=E.projectionMatrix.elements,Y=k[14]/(k[10]-1),F=k[14]/(k[10]+1),te=(k[9]+1)/k[5],ee=(k[9]-1)/k[5],j=(k[8]-1)/k[0],Z=(ne[8]+1)/ne[0],ce=Y*j,de=Y*Z,oe=O/(-j+Z),V=oe*-j;U.matrixWorld.decompose(L.position,L.quaternion,L.scale),L.translateX(V),L.translateZ(oe),L.matrixWorld.compose(L.position,L.quaternion,L.scale),L.matrixWorldInverse.getInverse(L.matrixWorld);const re=Y+oe,q=F+oe,J=ce-V,W=de+(O-V),H=te*F/q*re,se=ee*F/q*re;L.projectionMatrix.makePerspective(J,W,H,se,re,q)}function w(L,U){U===null?L.matrixWorld.copy(L.matrix):L.matrixWorld.multiplyMatrices(U.matrixWorld,L.matrix),L.matrixWorldInverse.getInverse(L.matrixWorld)}this.getCamera=function(L){d.near=u.near=h.near=L.near,d.far=u.far=h.far=L.far,(p!==d.near||y!==d.far)&&(i.updateRenderState({depthNear:d.near,depthFar:d.far}),p=d.near,y=d.far);const U=L.parent,E=d.cameras;w(d,U);for(let k=0;k<E.length;k++)w(E[k],U);L.matrixWorld.copy(d.matrixWorld);const O=L.children;for(let k=0,ne=O.length;k<ne;k++)O[k].updateMatrixWorld(!0);return E.length===2?C(d,h,u):d.projectionMatrix.copy(h.projectionMatrix),d};let S=null;function M(L,U){if(a=U.getViewerPose(s),a!==null){const O=a.views,k=i.renderState.baseLayer;t.setFramebuffer(k.framebuffer);let ne=!1;O.length!==d.cameras.length&&(d.cameras.length=0,ne=!0);for(let Y=0;Y<O.length;Y++){const F=O[Y],te=k.getViewport(F),ee=f[Y];ee.matrix.fromArray(F.transform.matrix),ee.projectionMatrix.fromArray(F.projectionMatrix),ee.viewport.set(te.x,te.y,te.width,te.height),Y===0&&d.matrix.copy(ee.matrix),ne===!0&&d.cameras.push(ee)}}const E=i.inputSources;for(let O=0;O<c.length;O++){const k=c[O],ne=E[O];k.update(ne,U,s)}S&&S(L,U)}const B=new Vy;B.setAnimationLoop(M),this.setAnimationLoop=function(L){S=L},this.dispose=function(){}}Object.assign(Ky.prototype,xr.prototype);function VS(t){function e(m,x){m.fogColor.value.copy(x.color),x.isFog?(m.fogNear.value=x.near,m.fogFar.value=x.far):x.isFogExp2&&(m.fogDensity.value=x.density)}function n(m,x,v,b,_){x.isMeshBasicMaterial?i(m,x):x.isMeshLambertMaterial?(i(m,x),c(m,x)):x.isMeshToonMaterial?(i(m,x),h(m,x)):x.isMeshPhongMaterial?(i(m,x),l(m,x)):x.isMeshStandardMaterial?(i(m,x,v),x.isMeshPhysicalMaterial?f(m,x,v):u(m,x,v)):x.isMeshMatcapMaterial?(i(m,x),d(m,x)):x.isMeshDepthMaterial?(i(m,x),p(m,x)):x.isMeshDistanceMaterial?(i(m,x),y(m,x)):x.isMeshNormalMaterial?(i(m,x),g(m,x)):x.isLineBasicMaterial?(r(m,x),x.isLineDashedMaterial&&s(m,x)):x.isPointsMaterial?o(m,x,b,_):x.isSpriteMaterial?a(m,x):x.isShadowMaterial?(m.color.value.copy(x.color),m.opacity.value=x.opacity):x.isShaderMaterial&&(x.uniformsNeedUpdate=!1)}function i(m,x,v){m.opacity.value=x.opacity,x.color&&m.diffuse.value.copy(x.color),x.emissive&&m.emissive.value.copy(x.emissive).multiplyScalar(x.emissiveIntensity),x.map&&(m.map.value=x.map),x.alphaMap&&(m.alphaMap.value=x.alphaMap),x.specularMap&&(m.specularMap.value=x.specularMap);const b=x.envMap||v;b&&(m.envMap.value=b,m.flipEnvMap.value=b.isCubeTexture?-1:1,m.reflectivity.value=x.reflectivity,m.refractionRatio.value=x.refractionRatio,m.maxMipLevel.value=t.get(b).__maxMipLevel),x.lightMap&&(m.lightMap.value=x.lightMap,m.lightMapIntensity.value=x.lightMapIntensity),x.aoMap&&(m.aoMap.value=x.aoMap,m.aoMapIntensity.value=x.aoMapIntensity);let _;x.map?_=x.map:x.specularMap?_=x.specularMap:x.displacementMap?_=x.displacementMap:x.normalMap?_=x.normalMap:x.bumpMap?_=x.bumpMap:x.roughnessMap?_=x.roughnessMap:x.metalnessMap?_=x.metalnessMap:x.alphaMap?_=x.alphaMap:x.emissiveMap&&(_=x.emissiveMap),_!==void 0&&(_.isWebGLRenderTarget&&(_=_.texture),_.matrixAutoUpdate===!0&&_.updateMatrix(),m.uvTransform.value.copy(_.matrix));let C;x.aoMap?C=x.aoMap:x.lightMap&&(C=x.lightMap),C!==void 0&&(C.isWebGLRenderTarget&&(C=C.texture),C.matrixAutoUpdate===!0&&C.updateMatrix(),m.uv2Transform.value.copy(C.matrix))}function r(m,x){m.diffuse.value.copy(x.color),m.opacity.value=x.opacity}function s(m,x){m.dashSize.value=x.dashSize,m.totalSize.value=x.dashSize+x.gapSize,m.scale.value=x.scale}function o(m,x,v,b){m.diffuse.value.copy(x.color),m.opacity.value=x.opacity,m.size.value=x.size*v,m.scale.value=b*.5,x.map&&(m.map.value=x.map),x.alphaMap&&(m.alphaMap.value=x.alphaMap);let _;x.map?_=x.map:x.alphaMap&&(_=x.alphaMap),_!==void 0&&(_.matrixAutoUpdate===!0&&_.updateMatrix(),m.uvTransform.value.copy(_.matrix))}function a(m,x){m.diffuse.value.copy(x.color),m.opacity.value=x.opacity,m.rotation.value=x.rotation,x.map&&(m.map.value=x.map),x.alphaMap&&(m.alphaMap.value=x.alphaMap);let v;x.map?v=x.map:x.alphaMap&&(v=x.alphaMap),v!==void 0&&(v.matrixAutoUpdate===!0&&v.updateMatrix(),m.uvTransform.value.copy(v.matrix))}function c(m,x){x.emissiveMap&&(m.emissiveMap.value=x.emissiveMap)}function l(m,x){m.specular.value.copy(x.specular),m.shininess.value=Math.max(x.shininess,1e-4),x.emissiveMap&&(m.emissiveMap.value=x.emissiveMap),x.bumpMap&&(m.bumpMap.value=x.bumpMap,m.bumpScale.value=x.bumpScale,x.side===yn&&(m.bumpScale.value*=-1)),x.normalMap&&(m.normalMap.value=x.normalMap,m.normalScale.value.copy(x.normalScale),x.side===yn&&m.normalScale.value.negate()),x.displacementMap&&(m.displacementMap.value=x.displacementMap,m.displacementScale.value=x.displacementScale,m.displacementBias.value=x.displacementBias)}function h(m,x){x.gradientMap&&(m.gradientMap.value=x.gradientMap),x.emissiveMap&&(m.emissiveMap.value=x.emissiveMap),x.bumpMap&&(m.bumpMap.value=x.bumpMap,m.bumpScale.value=x.bumpScale,x.side===yn&&(m.bumpScale.value*=-1)),x.normalMap&&(m.normalMap.value=x.normalMap,m.normalScale.value.copy(x.normalScale),x.side===yn&&m.normalScale.value.negate()),x.displacementMap&&(m.displacementMap.value=x.displacementMap,m.displacementScale.value=x.displacementScale,m.displacementBias.value=x.displacementBias)}function u(m,x,v){m.roughness.value=x.roughness,m.metalness.value=x.metalness,x.roughnessMap&&(m.roughnessMap.value=x.roughnessMap),x.metalnessMap&&(m.metalnessMap.value=x.metalnessMap),x.emissiveMap&&(m.emissiveMap.value=x.emissiveMap),x.bumpMap&&(m.bumpMap.value=x.bumpMap,m.bumpScale.value=x.bumpScale,x.side===yn&&(m.bumpScale.value*=-1)),x.normalMap&&(m.normalMap.value=x.normalMap,m.normalScale.value.copy(x.normalScale),x.side===yn&&m.normalScale.value.negate()),x.displacementMap&&(m.displacementMap.value=x.displacementMap,m.displacementScale.value=x.displacementScale,m.displacementBias.value=x.displacementBias),(x.envMap||v)&&(m.envMapIntensity.value=x.envMapIntensity)}function f(m,x,v){u(m,x,v),m.reflectivity.value=x.reflectivity,m.clearcoat.value=x.clearcoat,m.clearcoatRoughness.value=x.clearcoatRoughness,x.sheen&&m.sheen.value.copy(x.sheen),x.clearcoatMap&&(m.clearcoatMap.value=x.clearcoatMap),x.clearcoatRoughnessMap&&(m.clearcoatRoughnessMap.value=x.clearcoatRoughnessMap),x.clearcoatNormalMap&&(m.clearcoatNormalScale.value.copy(x.clearcoatNormalScale),m.clearcoatNormalMap.value=x.clearcoatNormalMap,x.side===yn&&m.clearcoatNormalScale.value.negate()),m.transparency.value=x.transparency}function d(m,x){x.matcap&&(m.matcap.value=x.matcap),x.bumpMap&&(m.bumpMap.value=x.bumpMap,m.bumpScale.value=x.bumpScale,x.side===yn&&(m.bumpScale.value*=-1)),x.normalMap&&(m.normalMap.value=x.normalMap,m.normalScale.value.copy(x.normalScale),x.side===yn&&m.normalScale.value.negate()),x.displacementMap&&(m.displacementMap.value=x.displacementMap,m.displacementScale.value=x.displacementScale,m.displacementBias.value=x.displacementBias)}function p(m,x){x.displacementMap&&(m.displacementMap.value=x.displacementMap,m.displacementScale.value=x.displacementScale,m.displacementBias.value=x.displacementBias)}function y(m,x){x.displacementMap&&(m.displacementMap.value=x.displacementMap,m.displacementScale.value=x.displacementScale,m.displacementBias.value=x.displacementBias),m.referencePosition.value.copy(x.referencePosition),m.nearDistance.value=x.nearDistance,m.farDistance.value=x.farDistance}function g(m,x){x.bumpMap&&(m.bumpMap.value=x.bumpMap,m.bumpScale.value=x.bumpScale,x.side===yn&&(m.bumpScale.value*=-1)),x.normalMap&&(m.normalMap.value=x.normalMap,m.normalScale.value.copy(x.normalScale),x.side===yn&&m.normalScale.value.negate()),x.displacementMap&&(m.displacementMap.value=x.displacementMap,m.displacementScale.value=x.displacementScale,m.displacementBias.value=x.displacementBias)}return{refreshFogUniforms:e,refreshMaterialUniforms:n}}function Kc(t){t=t||{};const e=t.canvas!==void 0?t.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),n=t.context!==void 0?t.context:null,i=t.alpha!==void 0?t.alpha:!1,r=t.depth!==void 0?t.depth:!0,s=t.stencil!==void 0?t.stencil:!0,o=t.antialias!==void 0?t.antialias:!1,a=t.premultipliedAlpha!==void 0?t.premultipliedAlpha:!0,c=t.preserveDrawingBuffer!==void 0?t.preserveDrawingBuffer:!1,l=t.powerPreference!==void 0?t.powerPreference:"default",h=t.failIfMajorPerformanceCaveat!==void 0?t.failIfMajorPerformanceCaveat:!1;let u=null,f=null;this.domElement=e,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=Pn,this.physicallyCorrectLights=!1,this.toneMapping=yo,this.toneMappingExposure=1,this.maxMorphTargets=8,this.maxMorphNormals=4;const d=this;let p=!1,y=null,g=0,m=0,x=null,v=null,b=-1,_=null,C=null;const w=new Ft,S=new Ft;let M=null,B=e.width,L=e.height,U=1,E=null,O=null;const k=new Ft(0,0,B,L),ne=new Ft(0,0,B,L);let Y=!1;const F=new Zc,te=new b3;let ee=!1,j=!1;const Z=new Ie,ce=new T,de={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function oe(){return x===null?U:1}let V=n;function re(K,Ae){for(let ge=0;ge<K.length;ge++){const A=K[ge],P=e.getContext(A,Ae);if(P!==null)return P}return null}try{const K={alpha:i,depth:r,stencil:s,antialias:o,premultipliedAlpha:a,preserveDrawingBuffer:c,powerPreference:l,failIfMajorPerformanceCaveat:h};if(e.addEventListener("webglcontextlost",Fe,!1),e.addEventListener("webglcontextrestored",je,!1),V===null){const Ae=["webgl2","webgl","experimental-webgl"];if(d.isWebGL1Renderer===!0&&Ae.shift(),V=re(Ae,K),V===null)throw re(Ae)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}V.getShaderPrecisionFormat===void 0&&(V.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(K){throw console.error("THREE.WebGLRenderer: "+K.message),K}let q,J,W,H,se,$,he,me,le,D,N,pe,ue,X,ye,_e,xe,Se,Me;function Oe(){q=new v3(V),J=new x3(V,q,t),J.isWebGL2===!1&&(q.get("WEBGL_depth_texture"),q.get("OES_texture_float"),q.get("OES_texture_half_float"),q.get("OES_texture_half_float_linear"),q.get("OES_standard_derivatives"),q.get("OES_element_index_uint"),q.get("OES_vertex_array_object"),q.get("ANGLE_instanced_arrays")),q.get("OES_texture_float_linear"),Se=new US(V,q,J),W=new zS(V,q,J),W.scissor(S.copy(ne).multiplyScalar(U).floor()),W.viewport(w.copy(k).multiplyScalar(U).floor()),H=new S3,se=new TS,$=new GS(V,q,W,se,J,Se,H),he=new Y_(V,J),Me=new g3(V,q,he,J),me=new _3(V,he,H,Me),le=new T3(V,me,he,H),ye=new C3(V),D=new CS(d,q,J,Me),N=new VS(se),pe=new IS,ue=new kS,X=new m3(d,W,le,a),_e=new y3(V,q,H,J),xe=new w3(V,q,H,J),H.programs=D.programs,d.capabilities=J,d.extensions=q,d.properties=se,d.renderLists=pe,d.state=W,d.info=H}Oe();const Ne=new Ky(d,V);this.xr=Ne;const we=new Zy(d,le,J.maxTextureSize);this.shadowMap=we,this.getContext=function(){return V},this.getContextAttributes=function(){return V.getContextAttributes()},this.forceContextLoss=function(){const K=q.get("WEBGL_lose_context");K&&K.loseContext()},this.forceContextRestore=function(){const K=q.get("WEBGL_lose_context");K&&K.restoreContext()},this.getPixelRatio=function(){return U},this.setPixelRatio=function(K){K!==void 0&&(U=K,this.setSize(B,L,!1))},this.getSize=function(K){return K===void 0&&(console.warn("WebGLRenderer: .getsize() now requires a Vector2 as an argument"),K=new Te),K.set(B,L)},this.setSize=function(K,Ae,ge){if(Ne.isPresenting){console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting.");return}B=K,L=Ae,e.width=Math.floor(K*U),e.height=Math.floor(Ae*U),ge!==!1&&(e.style.width=K+"px",e.style.height=Ae+"px"),this.setViewport(0,0,K,Ae)},this.getDrawingBufferSize=function(K){return K===void 0&&(console.warn("WebGLRenderer: .getdrawingBufferSize() now requires a Vector2 as an argument"),K=new Te),K.set(B*U,L*U).floor()},this.setDrawingBufferSize=function(K,Ae,ge){B=K,L=Ae,U=ge,e.width=Math.floor(K*ge),e.height=Math.floor(Ae*ge),this.setViewport(0,0,K,Ae)},this.getCurrentViewport=function(K){return K===void 0&&(console.warn("WebGLRenderer: .getCurrentViewport() now requires a Vector4 as an argument"),K=new Ft),K.copy(w)},this.getViewport=function(K){return K.copy(k)},this.setViewport=function(K,Ae,ge,A){K.isVector4?k.set(K.x,K.y,K.z,K.w):k.set(K,Ae,ge,A),W.viewport(w.copy(k).multiplyScalar(U).floor())},this.getScissor=function(K){return K.copy(ne)},this.setScissor=function(K,Ae,ge,A){K.isVector4?ne.set(K.x,K.y,K.z,K.w):ne.set(K,Ae,ge,A),W.scissor(S.copy(ne).multiplyScalar(U).floor())},this.getScissorTest=function(){return Y},this.setScissorTest=function(K){W.setScissorTest(Y=K)},this.setOpaqueSort=function(K){E=K},this.setTransparentSort=function(K){O=K},this.getClearColor=function(){return X.getClearColor()},this.setClearColor=function(){X.setClearColor.apply(X,arguments)},this.getClearAlpha=function(){return X.getClearAlpha()},this.setClearAlpha=function(){X.setClearAlpha.apply(X,arguments)},this.clear=function(K,Ae,ge){let A=0;(K===void 0||K)&&(A|=16384),(Ae===void 0||Ae)&&(A|=256),(ge===void 0||ge)&&(A|=1024),V.clear(A)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",Fe,!1),e.removeEventListener("webglcontextrestored",je,!1),pe.dispose(),ue.dispose(),se.dispose(),le.dispose(),Me.dispose(),Ne.dispose(),dt.stop()};function Fe(K){K.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),p=!0}function je(){console.log("THREE.WebGLRenderer: Context Restored."),p=!1,Oe()}function Be(K){const Ae=K.target;Ae.removeEventListener("dispose",Be),tt(Ae)}function tt(K){Ue(K),se.remove(K)}function Ue(K){const Ae=se.get(K).program;K.program=void 0,Ae!==void 0&&D.releaseProgram(Ae)}function yt(K,Ae){K.render(function(ge){d.renderBufferImmediate(ge,Ae)})}this.renderBufferImmediate=function(K,Ae){Me.initAttributes();const ge=se.get(K);K.hasPositions&&!ge.position&&(ge.position=V.createBuffer()),K.hasNormals&&!ge.normal&&(ge.normal=V.createBuffer()),K.hasUvs&&!ge.uv&&(ge.uv=V.createBuffer()),K.hasColors&&!ge.color&&(ge.color=V.createBuffer());const A=Ae.getAttributes();K.hasPositions&&(V.bindBuffer(34962,ge.position),V.bufferData(34962,K.positionArray,35048),Me.enableAttribute(A.position),V.vertexAttribPointer(A.position,3,5126,!1,0,0)),K.hasNormals&&(V.bindBuffer(34962,ge.normal),V.bufferData(34962,K.normalArray,35048),Me.enableAttribute(A.normal),V.vertexAttribPointer(A.normal,3,5126,!1,0,0)),K.hasUvs&&(V.bindBuffer(34962,ge.uv),V.bufferData(34962,K.uvArray,35048),Me.enableAttribute(A.uv),V.vertexAttribPointer(A.uv,2,5126,!1,0,0)),K.hasColors&&(V.bindBuffer(34962,ge.color),V.bufferData(34962,K.colorArray,35048),Me.enableAttribute(A.color),V.vertexAttribPointer(A.color,3,5126,!1,0,0)),Me.disableUnusedAttributes(),V.drawArrays(4,0,K.count),K.count=0},this.renderBufferDirect=function(K,Ae,ge,A,P,R){Ae===null&&(Ae=de);const G=P.isMesh&&P.matrixWorld.determinant()<0,z=Ve(K,Ae,A,P);W.setMaterial(A,G);let Q=ge.index;const ie=ge.attributes.position;if(Q===null){if(ie===void 0||ie.count===0)return}else if(Q.count===0)return;let ae=1;A.wireframe===!0&&(Q=me.getWireframeAttribute(ge),ae=2),(A.morphTargets||A.morphNormals)&&ye.update(P,ge,A,z),Me.setup(P,A,z,ge,Q);let ve,be=_e;Q!==null&&(ve=he.get(Q),be=xe,be.setIndex(ve));const Re=Q!==null?Q.count:ie.count,Ge=ge.drawRange.start*ae,Ee=ge.drawRange.count*ae,De=R!==null?R.start*ae:0,ze=R!==null?R.count*ae:1/0,Je=Math.max(Ge,De),ht=Math.min(Re,Ge+Ee,De+ze)-1,Ze=Math.max(0,ht-Je+1);if(Ze!==0){if(P.isMesh)A.wireframe===!0?(W.setLineWidth(A.wireframeLinewidth*oe()),be.setMode(1)):be.setMode(4);else if(P.isLine){let Wt=A.linewidth;Wt===void 0&&(Wt=1),W.setLineWidth(Wt*oe()),P.isLineSegments?be.setMode(1):P.isLineLoop?be.setMode(2):be.setMode(3)}else P.isPoints?be.setMode(0):P.isSprite&&be.setMode(4);if(P.isInstancedMesh)be.renderInstances(ge,Je,Ze,P.count);else if(ge.isInstancedBufferGeometry){const Wt=Math.min(ge.instanceCount,ge._maxInstanceCount);be.renderInstances(ge,Je,Ze,Wt)}else be.render(Je,Ze)}},this.compile=function(K,Ae){f=ue.get(K,Ae),f.init(),K.traverse(function(A){A.isLight&&(f.pushLight(A),A.castShadow&&f.pushShadow(A))}),f.setupLights(Ae);const ge=new WeakMap;K.traverse(function(A){let P=A.material;if(P)if(Array.isArray(P))for(let R=0;R<P.length;R++){let G=P[R];ge.has(G)===!1&&(Ye(G,K,A),ge.set(G))}else ge.has(P)===!1&&(Ye(P,K,A),ge.set(P))})};let Rt=null;function Vt(K){Ne.isPresenting||Rt&&Rt(K)}const dt=new Vy;dt.setAnimationLoop(Vt),typeof window<"u"&&dt.setContext(window),this.setAnimationLoop=function(K){Rt=K,Ne.setAnimationLoop(K),K===null?dt.stop():dt.start()},this.render=function(K,Ae){let ge,A;if(arguments[2]!==void 0&&(console.warn("THREE.WebGLRenderer.render(): the renderTarget argument has been removed. Use .setRenderTarget() instead."),ge=arguments[2]),arguments[3]!==void 0&&(console.warn("THREE.WebGLRenderer.render(): the forceClear argument has been removed. Use .clear() instead."),A=arguments[3]),Ae!==void 0&&Ae.isCamera!==!0){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}if(p===!0)return;Me.resetDefaultState(),b=-1,_=null,K.autoUpdate===!0&&K.updateMatrixWorld(),Ae.parent===null&&Ae.updateMatrixWorld(),Ne.enabled===!0&&Ne.isPresenting===!0&&(Ae=Ne.getCamera(Ae)),K.isScene===!0&&K.onBeforeRender(d,K,Ae,ge||x),f=ue.get(K,Ae),f.init(),Z.multiplyMatrices(Ae.projectionMatrix,Ae.matrixWorldInverse),F.setFromProjectionMatrix(Z),j=this.localClippingEnabled,ee=te.init(this.clippingPlanes,j,Ae),u=pe.get(K,Ae),u.init(),xt(K,Ae,0,d.sortObjects),u.finish(),d.sortObjects===!0&&u.sort(E,O),ee===!0&&te.beginShadows();const P=f.state.shadowsArray;we.render(P,K,Ae),f.setupLights(Ae),ee===!0&&te.endShadows(),this.info.autoReset===!0&&this.info.reset(),ge!==void 0&&this.setRenderTarget(ge),X.render(u,K,Ae,A);const R=u.opaque,G=u.transparent;R.length>0&&Mt(R,K,Ae),G.length>0&&Mt(G,K,Ae),K.isScene===!0&&K.onAfterRender(d,K,Ae),x!==null&&($.updateRenderTargetMipmap(x),$.updateMultisampleRenderTarget(x)),W.buffers.depth.setTest(!0),W.buffers.depth.setMask(!0),W.buffers.color.setMask(!0),W.setPolygonOffset(!1),u=null,f=null};function xt(K,Ae,ge,A){if(K.visible===!1)return;if(K.layers.test(Ae.layers)){if(K.isGroup)ge=K.renderOrder;else if(K.isLOD)K.autoUpdate===!0&&K.update(Ae);else if(K.isLight)f.pushLight(K),K.castShadow&&f.pushShadow(K);else if(K.isSprite){if(!K.frustumCulled||F.intersectsSprite(K)){A&&ce.setFromMatrixPosition(K.matrixWorld).applyMatrix4(Z);const G=le.update(K),z=K.material;z.visible&&u.push(K,G,z,ge,ce.z,null)}}else if(K.isImmediateRenderObject)A&&ce.setFromMatrixPosition(K.matrixWorld).applyMatrix4(Z),u.push(K,null,K.material,ge,ce.z,null);else if((K.isMesh||K.isLine||K.isPoints)&&(K.isSkinnedMesh&&K.skeleton.frame!==H.render.frame&&(K.skeleton.update(),K.skeleton.frame=H.render.frame),!K.frustumCulled||F.intersectsObject(K))){A&&ce.setFromMatrixPosition(K.matrixWorld).applyMatrix4(Z);const G=le.update(K),z=K.material;if(Array.isArray(z)){const Q=G.groups;for(let ie=0,ae=Q.length;ie<ae;ie++){const ve=Q[ie],be=z[ve.materialIndex];be&&be.visible&&u.push(K,G,be,ge,ce.z,ve)}}else z.visible&&u.push(K,G,z,ge,ce.z,null)}}const R=K.children;for(let G=0,z=R.length;G<z;G++)xt(R[G],Ae,ge,A)}function Mt(K,Ae,ge){const A=Ae.isScene===!0?Ae.overrideMaterial:null;for(let P=0,R=K.length;P<R;P++){const G=K[P],z=G.object,Q=G.geometry,ie=A===null?G.material:A,ae=G.group;if(ge.isArrayCamera){C=ge;const ve=ge.cameras;for(let be=0,Re=ve.length;be<Re;be++){const Ge=ve[be];z.layers.test(Ge.layers)&&(W.viewport(w.copy(Ge.viewport)),f.setupLights(Ge),Le(z,Ae,Ge,Q,ie,ae))}}else C=null,Le(z,Ae,ge,Q,ie,ae)}}function Le(K,Ae,ge,A,P,R){if(K.onBeforeRender(d,Ae,ge,A,P,R),f=ue.get(Ae,C||ge),K.modelViewMatrix.multiplyMatrices(ge.matrixWorldInverse,K.matrixWorld),K.normalMatrix.getNormalMatrix(K.modelViewMatrix),K.isImmediateRenderObject){const G=Ve(ge,Ae,P,K);W.setMaterial(P),Me.reset(),yt(K,G)}else d.renderBufferDirect(ge,Ae,A,P,K,R);K.onAfterRender(d,Ae,ge,A,P,R),f=ue.get(Ae,C||ge)}function Ye(K,Ae,ge){Ae.isScene!==!0&&(Ae=de);const A=se.get(K),P=f.state.lights,R=f.state.shadowsArray,G=P.state.version,z=D.getParameters(K,P.state,R,Ae,te.numPlanes,te.numIntersection,ge),Q=D.getProgramCacheKey(z);let ie=A.program,ae=!0;if(ie===void 0)K.addEventListener("dispose",Be);else if(ie.cacheKey!==Q)Ue(K);else if(A.lightsStateVersion!==G)A.lightsStateVersion=G,ae=!1;else{if(z.shaderID!==void 0)return;ae=!1}ae&&(ie=D.acquireProgram(z,Q),A.program=ie,A.uniforms=z.uniforms,A.outputEncoding=z.outputEncoding,K.program=ie);const ve=ie.getAttributes();if(K.morphTargets){K.numSupportedMorphTargets=0;for(let Ee=0;Ee<d.maxMorphTargets;Ee++)ve["morphTarget"+Ee]>=0&&K.numSupportedMorphTargets++}if(K.morphNormals){K.numSupportedMorphNormals=0;for(let Ee=0;Ee<d.maxMorphNormals;Ee++)ve["morphNormal"+Ee]>=0&&K.numSupportedMorphNormals++}const be=A.uniforms;(!K.isShaderMaterial&&!K.isRawShaderMaterial||K.clipping===!0)&&(A.numClippingPlanes=te.numPlanes,A.numIntersection=te.numIntersection,be.clippingPlanes=te.uniform),A.environment=K.isMeshStandardMaterial?Ae.environment:null,A.fog=Ae.fog,A.needsLights=wt(K),A.lightsStateVersion=G,A.needsLights&&(be.ambientLightColor.value=P.state.ambient,be.lightProbe.value=P.state.probe,be.directionalLights.value=P.state.directional,be.directionalLightShadows.value=P.state.directionalShadow,be.spotLights.value=P.state.spot,be.spotLightShadows.value=P.state.spotShadow,be.rectAreaLights.value=P.state.rectArea,be.pointLights.value=P.state.point,be.pointLightShadows.value=P.state.pointShadow,be.hemisphereLights.value=P.state.hemi,be.directionalShadowMap.value=P.state.directionalShadowMap,be.directionalShadowMatrix.value=P.state.directionalShadowMatrix,be.spotShadowMap.value=P.state.spotShadowMap,be.spotShadowMatrix.value=P.state.spotShadowMatrix,be.pointShadowMap.value=P.state.pointShadowMap,be.pointShadowMatrix.value=P.state.pointShadowMatrix);const Re=A.program.getUniforms(),Ge=Or.seqWithValue(Re.seq,be);A.uniformsList=Ge}function Ve(K,Ae,ge,A){Ae.isScene!==!0&&(Ae=de),$.resetTextureUnits();const P=Ae.fog,R=ge.isMeshStandardMaterial?Ae.environment:null,G=x===null?d.outputEncoding:x.texture.encoding,z=se.get(ge),Q=f.state.lights;if(ee===!0&&(j===!0||K!==_)){const Ee=K===_&&ge.id===b;te.setState(ge.clippingPlanes,ge.clipIntersection,ge.clipShadows,K,z,Ee)}ge.version===z.__version?(z.program===void 0||ge.fog&&z.fog!==P||z.environment!==R||z.needsLights&&z.lightsStateVersion!==Q.state.version||z.numClippingPlanes!==void 0&&(z.numClippingPlanes!==te.numPlanes||z.numIntersection!==te.numIntersection)||z.outputEncoding!==G)&&Ye(ge,Ae,A):(Ye(ge,Ae,A),z.__version=ge.version);let ie=!1,ae=!1,ve=!1;const be=z.program,Re=be.getUniforms(),Ge=z.uniforms;if(W.useProgram(be.program)&&(ie=!0,ae=!0,ve=!0),ge.id!==b&&(b=ge.id,ae=!0),ie||_!==K){if(Re.setValue(V,"projectionMatrix",K.projectionMatrix),J.logarithmicDepthBuffer&&Re.setValue(V,"logDepthBufFC",2/(Math.log(K.far+1)/Math.LN2)),_!==K&&(_=K,ae=!0,ve=!0),ge.isShaderMaterial||ge.isMeshPhongMaterial||ge.isMeshToonMaterial||ge.isMeshStandardMaterial||ge.envMap){const Ee=Re.map.cameraPosition;Ee!==void 0&&Ee.setValue(V,ce.setFromMatrixPosition(K.matrixWorld))}(ge.isMeshPhongMaterial||ge.isMeshToonMaterial||ge.isMeshLambertMaterial||ge.isMeshBasicMaterial||ge.isMeshStandardMaterial||ge.isShaderMaterial)&&Re.setValue(V,"isOrthographic",K.isOrthographicCamera===!0),(ge.isMeshPhongMaterial||ge.isMeshToonMaterial||ge.isMeshLambertMaterial||ge.isMeshBasicMaterial||ge.isMeshStandardMaterial||ge.isShaderMaterial||ge.isShadowMaterial||ge.skinning)&&Re.setValue(V,"viewMatrix",K.matrixWorldInverse)}if(ge.skinning){Re.setOptional(V,A,"bindMatrix"),Re.setOptional(V,A,"bindMatrixInverse");const Ee=A.skeleton;if(Ee){const De=Ee.bones;if(J.floatVertexTextures){if(Ee.boneTexture===void 0){let ze=Math.sqrt(De.length*4);ze=ut.ceilPowerOfTwo(ze),ze=Math.max(ze,4);const Je=new Float32Array(ze*ze*4);Je.set(Ee.boneMatrices);const ht=new cr(Je,ze,ze,Gn,sr);Ee.boneMatrices=Je,Ee.boneTexture=ht,Ee.boneTextureSize=ze}Re.setValue(V,"boneTexture",Ee.boneTexture,$),Re.setValue(V,"boneTextureSize",Ee.boneTextureSize)}else Re.setOptional(V,Ee,"boneMatrices")}}return(ae||z.receiveShadow!==A.receiveShadow)&&(z.receiveShadow=A.receiveShadow,Re.setValue(V,"receiveShadow",A.receiveShadow)),ae&&(Re.setValue(V,"toneMappingExposure",d.toneMappingExposure),z.needsLights&&Xe(Ge,ve),P&&ge.fog&&N.refreshFogUniforms(Ge,P),N.refreshMaterialUniforms(Ge,ge,R,U,L),Ge.ltc_1!==void 0&&(Ge.ltc_1.value=He.LTC_1),Ge.ltc_2!==void 0&&(Ge.ltc_2.value=He.LTC_2),Or.upload(V,z.uniformsList,Ge,$)),ge.isShaderMaterial&&ge.uniformsNeedUpdate===!0&&(Or.upload(V,z.uniformsList,Ge,$),ge.uniformsNeedUpdate=!1),ge.isSpriteMaterial&&Re.setValue(V,"center",A.center),Re.setValue(V,"modelViewMatrix",A.modelViewMatrix),Re.setValue(V,"normalMatrix",A.normalMatrix),Re.setValue(V,"modelMatrix",A.matrixWorld),be}function Xe(K,Ae){K.ambientLightColor.needsUpdate=Ae,K.lightProbe.needsUpdate=Ae,K.directionalLights.needsUpdate=Ae,K.directionalLightShadows.needsUpdate=Ae,K.pointLights.needsUpdate=Ae,K.pointLightShadows.needsUpdate=Ae,K.spotLights.needsUpdate=Ae,K.spotLightShadows.needsUpdate=Ae,K.rectAreaLights.needsUpdate=Ae,K.hemisphereLights.needsUpdate=Ae}function wt(K){return K.isMeshLambertMaterial||K.isMeshToonMaterial||K.isMeshPhongMaterial||K.isMeshStandardMaterial||K.isShadowMaterial||K.isShaderMaterial&&K.lights===!0}this.setFramebuffer=function(K){y!==K&&x===null&&V.bindFramebuffer(36160,K),y=K},this.getActiveCubeFace=function(){return g},this.getActiveMipmapLevel=function(){return m},this.getRenderTarget=function(){return x},this.setRenderTarget=function(K,Ae,ge){x=K,g=Ae,m=ge,K&&se.get(K).__webglFramebuffer===void 0&&$.setupRenderTarget(K);let A=y,P=!1;if(K){const R=se.get(K).__webglFramebuffer;K.isWebGLCubeRenderTarget?(A=R[Ae||0],P=!0):K.isWebGLMultisampleRenderTarget?A=se.get(K).__webglMultisampledFramebuffer:A=R,w.copy(K.viewport),S.copy(K.scissor),M=K.scissorTest}else w.copy(k).multiplyScalar(U).floor(),S.copy(ne).multiplyScalar(U).floor(),M=Y;if(v!==A&&(V.bindFramebuffer(36160,A),v=A),W.viewport(w),W.scissor(S),W.setScissorTest(M),P){const R=se.get(K.texture);V.framebufferTexture2D(36160,36064,34069+(Ae||0),R.__webglTexture,ge||0)}},this.readRenderTargetPixels=function(K,Ae,ge,A,P,R,G){if(!(K&&K.isWebGLRenderTarget)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");return}let z=se.get(K).__webglFramebuffer;if(K.isWebGLCubeRenderTarget&&G!==void 0&&(z=z[G]),z){let Q=!1;z!==v&&(V.bindFramebuffer(36160,z),Q=!0);try{const ie=K.texture,ae=ie.format,ve=ie.type;if(ae!==Gn&&Se.convert(ae)!==V.getParameter(35739)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");return}if(ve!==gs&&Se.convert(ve)!==V.getParameter(35738)&&!(ve===sr&&(J.isWebGL2||q.get("OES_texture_float")||q.get("WEBGL_color_buffer_float")))&&!(ve===Ih&&(J.isWebGL2?q.get("EXT_color_buffer_float"):q.get("EXT_color_buffer_half_float")))){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");return}V.checkFramebufferStatus(36160)===36053?Ae>=0&&Ae<=K.width-A&&ge>=0&&ge<=K.height-P&&V.readPixels(Ae,ge,A,P,Se.convert(ae),Se.convert(ve),R):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{Q&&V.bindFramebuffer(36160,v)}}},this.copyFramebufferToTexture=function(K,Ae,ge){ge===void 0&&(ge=0);const A=Math.pow(2,-ge),P=Math.floor(Ae.image.width*A),R=Math.floor(Ae.image.height*A),G=Se.convert(Ae.format);$.setTexture2D(Ae,0),V.copyTexImage2D(3553,ge,G,K.x,K.y,P,R,0),W.unbindTexture()},this.copyTextureToTexture=function(K,Ae,ge,A){A===void 0&&(A=0);const P=Ae.image.width,R=Ae.image.height,G=Se.convert(ge.format),z=Se.convert(ge.type);$.setTexture2D(ge,0),V.pixelStorei(37440,ge.flipY),V.pixelStorei(37441,ge.premultiplyAlpha),V.pixelStorei(3317,ge.unpackAlignment),Ae.isDataTexture?V.texSubImage2D(3553,A,K.x,K.y,P,R,G,z,Ae.image.data):Ae.isCompressedTexture?V.compressedTexSubImage2D(3553,A,K.x,K.y,Ae.mipmaps[0].width,Ae.mipmaps[0].height,G,Ae.mipmaps[0].data):V.texSubImage2D(3553,A,K.x,K.y,G,z,Ae.image),A===0&&ge.generateMipmaps&&V.generateMipmap(3553),W.unbindTexture()},this.initTexture=function(K){$.setTexture2D(K,0),W.unbindTexture()},typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}function bg(t){Kc.call(this,t)}bg.prototype=Object.assign(Object.create(Kc.prototype),{constructor:bg,isWebGL1Renderer:!0});function Hf(t,e){this.name="",this.color=new ke(t),this.density=e!==void 0?e:25e-5}Object.assign(Hf.prototype,{isFogExp2:!0,clone:function(){return new Hf(this.color,this.density)},toJSON:function(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}}});function Bh(t,e,n){this.name="",this.color=new ke(t),this.near=e!==void 0?e:1,this.far=n!==void 0?n:1e3}Object.assign(Bh.prototype,{isFog:!0,clone:function(){return new Bh(this.color,this.near,this.far)},toJSON:function(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}});function si(t,e){this.array=t,this.stride=e,this.count=t!==void 0?t.length/e:0,this.usage=Tu,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=ut.generateUUID()}Object.defineProperty(si.prototype,"needsUpdate",{set:function(t){t===!0&&this.version++}});Object.assign(si.prototype,{isInterleavedBuffer:!0,onUploadCallback:function(){},setUsage:function(t){return this.usage=t,this},copy:function(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this},copyAt:function(t,e,n){t*=this.stride,n*=e.stride;for(let i=0,r=this.stride;i<r;i++)this.array[t+i]=e.array[n+i];return this},set:function(t,e){return e===void 0&&(e=0),this.array.set(t,e),this},clone:function(t){t.arrayBuffers===void 0&&(t.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=ut.generateUUID()),t.arrayBuffers[this.array.buffer._uuid]===void 0&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),n=new si(e,this.stride);return n.setUsage(this.usage),n},onUpload:function(t){return this.onUploadCallback=t,this},toJSON:function(t){return t.arrayBuffers===void 0&&(t.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=ut.generateUUID()),t.arrayBuffers[this.array.buffer._uuid]===void 0&&(t.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}});const ns=new T;function vs(t,e,n,i){this.name="",this.data=t,this.itemSize=e,this.offset=n,this.normalized=i===!0}Object.defineProperties(vs.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}});Object.assign(vs.prototype,{isInterleavedBufferAttribute:!0,applyMatrix4:function(t){for(let e=0,n=this.data.count;e<n;e++)ns.x=this.getX(e),ns.y=this.getY(e),ns.z=this.getZ(e),ns.applyMatrix4(t),this.setXYZ(e,ns.x,ns.y,ns.z);return this},setX:function(t,e){return this.data.array[t*this.data.stride+this.offset]=e,this},setY:function(t,e){return this.data.array[t*this.data.stride+this.offset+1]=e,this},setZ:function(t,e){return this.data.array[t*this.data.stride+this.offset+2]=e,this},setW:function(t,e){return this.data.array[t*this.data.stride+this.offset+3]=e,this},getX:function(t){return this.data.array[t*this.data.stride+this.offset]},getY:function(t){return this.data.array[t*this.data.stride+this.offset+1]},getZ:function(t){return this.data.array[t*this.data.stride+this.offset+2]},getW:function(t){return this.data.array[t*this.data.stride+this.offset+3]},setXY:function(t,e,n){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=n,this},setXYZ:function(t,e,n,i){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=n,this.data.array[t+2]=i,this},setXYZW:function(t,e,n,i,r){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=n,this.data.array[t+2]=i,this.data.array[t+3]=r,this},clone:function(t){if(t===void 0){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interlaved buffer attribute will deinterleave buffer data.");const e=[];for(let n=0;n<this.count;n++){const i=n*this.data.stride+this.offset;for(let r=0;r<this.itemSize;r++)e.push(this.data.array[i+r])}return new Qe(new this.array.constructor(e),this.itemSize,this.normalized)}else return t.interleavedBuffers===void 0&&(t.interleavedBuffers={}),t.interleavedBuffers[this.data.uuid]===void 0&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new vs(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)},toJSON:function(t){if(t===void 0){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interlaved buffer attribute will deinterleave buffer data.");const e=[];for(let n=0;n<this.count;n++){const i=n*this.data.stride+this.offset;for(let r=0;r<this.itemSize;r++)e.push(this.data.array[i+r])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}else return t.interleavedBuffers===void 0&&(t.interleavedBuffers={}),t.interleavedBuffers[this.data.uuid]===void 0&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}});function _s(t){at.call(this),this.type="SpriteMaterial",this.color=new ke(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.setValues(t)}_s.prototype=Object.create(at.prototype);_s.prototype.constructor=_s;_s.prototype.isSpriteMaterial=!0;_s.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.rotation=t.rotation,this.sizeAttenuation=t.sizeAttenuation,this};let qs;const Ca=new T,Xs=new T,Ys=new T,Zs=new Te,Ta=new Te,Jy=new Ie,wl=new T,Pa=new T,Sl=new T,vg=new Te,xd=new Te,_g=new Te;function $f(t){if($e.call(this),this.type="Sprite",qs===void 0){qs=new We;const e=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),n=new si(e,5);qs.setIndex([0,1,2,0,2,3]),qs.setAttribute("position",new vs(n,3,0,!1)),qs.setAttribute("uv",new vs(n,2,3,!1))}this.geometry=qs,this.material=t!==void 0?t:new _s,this.center=new Te(.5,.5)}$f.prototype=Object.assign(Object.create($e.prototype),{constructor:$f,isSprite:!0,raycast:function(t,e){t.camera===null&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),Xs.setFromMatrixScale(this.matrixWorld),Jy.copy(t.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(t.camera.matrixWorldInverse,this.matrixWorld),Ys.setFromMatrixPosition(this.modelViewMatrix),t.camera.isPerspectiveCamera&&this.material.sizeAttenuation===!1&&Xs.multiplyScalar(-Ys.z);const n=this.material.rotation;let i,r;n!==0&&(r=Math.cos(n),i=Math.sin(n));const s=this.center;Ml(wl.set(-.5,-.5,0),Ys,s,Xs,i,r),Ml(Pa.set(.5,-.5,0),Ys,s,Xs,i,r),Ml(Sl.set(.5,.5,0),Ys,s,Xs,i,r),vg.set(0,0),xd.set(1,0),_g.set(1,1);let o=t.ray.intersectTriangle(wl,Pa,Sl,!1,Ca);if(o===null&&(Ml(Pa.set(-.5,.5,0),Ys,s,Xs,i,r),xd.set(0,1),o=t.ray.intersectTriangle(wl,Sl,Pa,!1,Ca),o===null))return;const a=t.ray.origin.distanceTo(Ca);a<t.near||a>t.far||e.push({distance:a,point:Ca.clone(),uv:Mn.getUV(Ca,wl,Pa,Sl,vg,xd,_g,new Te),face:null,object:this})},copy:function(t){return $e.prototype.copy.call(this,t),t.center!==void 0&&this.center.copy(t.center),this.material=t.material,this}});function Ml(t,e,n,i,r,s){Zs.subVectors(t,n).addScalar(.5).multiply(i),r!==void 0?(Ta.x=s*Zs.x-r*Zs.y,Ta.y=r*Zs.x+s*Zs.y):Ta.copy(Zs),t.copy(e),t.x+=Ta.x,t.y+=Ta.y,t.applyMatrix4(Jy)}const Al=new T,wg=new T;function Oh(){$e.call(this),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}}),this.autoUpdate=!0}Oh.prototype=Object.assign(Object.create($e.prototype),{constructor:Oh,isLOD:!0,copy:function(t){$e.prototype.copy.call(this,t,!1);const e=t.levels;for(let n=0,i=e.length;n<i;n++){const r=e[n];this.addLevel(r.object.clone(),r.distance)}return this.autoUpdate=t.autoUpdate,this},addLevel:function(t,e){e===void 0&&(e=0),e=Math.abs(e);const n=this.levels;let i;for(i=0;i<n.length&&!(e<n[i].distance);i++);return n.splice(i,0,{distance:e,object:t}),this.add(t),this},getCurrentLevel:function(){return this._currentLevel},getObjectForDistance:function(t){const e=this.levels;if(e.length>0){let n,i;for(n=1,i=e.length;n<i&&!(t<e[n].distance);n++);return e[n-1].object}return null},raycast:function(t,e){if(this.levels.length>0){Al.setFromMatrixPosition(this.matrixWorld);const i=t.ray.origin.distanceTo(Al);this.getObjectForDistance(i).raycast(t,e)}},update:function(t){const e=this.levels;if(e.length>1){Al.setFromMatrixPosition(t.matrixWorld),wg.setFromMatrixPosition(this.matrixWorld);const n=Al.distanceTo(wg)/t.zoom;e[0].object.visible=!0;let i,r;for(i=1,r=e.length;i<r&&n>=e[i].distance;i++)e[i-1].object.visible=!1,e[i].object.visible=!0;for(this._currentLevel=i-1;i<r;i++)e[i].object.visible=!1}},toJSON:function(t){const e=$e.prototype.toJSON.call(this,t);this.autoUpdate===!1&&(e.object.autoUpdate=!1),e.object.levels=[];const n=this.levels;for(let i=0,r=n.length;i<r;i++){const s=n[i];e.object.levels.push({object:s.object.uuid,distance:s.distance})}return e}});function Wf(t,e){t&&t.isGeometry&&console.error("THREE.SkinnedMesh no longer supports THREE.Geometry. Use THREE.BufferGeometry instead."),Ht.call(this,t,e),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Ie,this.bindMatrixInverse=new Ie}Wf.prototype=Object.assign(Object.create(Ht.prototype),{constructor:Wf,isSkinnedMesh:!0,copy:function(t){return Ht.prototype.copy.call(this,t),this.bindMode=t.bindMode,this.bindMatrix.copy(t.bindMatrix),this.bindMatrixInverse.copy(t.bindMatrixInverse),this.skeleton=t.skeleton,this},bind:function(t,e){this.skeleton=t,e===void 0&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),e=this.matrixWorld),this.bindMatrix.copy(e),this.bindMatrixInverse.getInverse(e)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){const t=new Ft,e=this.geometry.attributes.skinWeight;for(let n=0,i=e.count;n<i;n++){t.x=e.getX(n),t.y=e.getY(n),t.z=e.getZ(n),t.w=e.getW(n);const r=1/t.manhattanLength();r!==1/0?t.multiplyScalar(r):t.set(1,0,0,0),e.setXYZW(n,t.x,t.y,t.z,t.w)}},updateMatrixWorld:function(t){Ht.prototype.updateMatrixWorld.call(this,t),this.bindMode==="attached"?this.bindMatrixInverse.getInverse(this.matrixWorld):this.bindMode==="detached"?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},boneTransform:function(){const t=new T,e=new Ft,n=new Ft,i=new T,r=new Ie;return function(s,o){const a=this.skeleton,c=this.geometry;e.fromBufferAttribute(c.attributes.skinIndex,s),n.fromBufferAttribute(c.attributes.skinWeight,s),t.fromBufferAttribute(c.attributes.position,s).applyMatrix4(this.bindMatrix),o.set(0,0,0);for(let l=0;l<4;l++){const h=n.getComponent(l);if(h!==0){const u=e.getComponent(l);r.multiplyMatrices(a.bones[u].matrixWorld,a.boneInverses[u]),o.addScaledVector(i.copy(t).applyMatrix4(r),h)}}return o.applyMatrix4(this.bindMatrixInverse)}}()});const Sg=new Ie,HS=new Ie;function jf(t,e){if(t=t||[],this.bones=t.slice(0),this.boneMatrices=new Float32Array(this.bones.length*16),this.frame=-1,e===void 0)this.calculateInverses();else if(this.bones.length===e.length)this.boneInverses=e.slice(0);else{console.warn("THREE.Skeleton boneInverses is the wrong length."),this.boneInverses=[];for(let n=0,i=this.bones.length;n<i;n++)this.boneInverses.push(new Ie)}}Object.assign(jf.prototype,{calculateInverses:function(){this.boneInverses=[];for(let t=0,e=this.bones.length;t<e;t++){const n=new Ie;this.bones[t]&&n.getInverse(this.bones[t].matrixWorld),this.boneInverses.push(n)}},pose:function(){for(let t=0,e=this.bones.length;t<e;t++){const n=this.bones[t];n&&n.matrixWorld.getInverse(this.boneInverses[t])}for(let t=0,e=this.bones.length;t<e;t++){const n=this.bones[t];n&&(n.parent&&n.parent.isBone?(n.matrix.getInverse(n.parent.matrixWorld),n.matrix.multiply(n.matrixWorld)):n.matrix.copy(n.matrixWorld),n.matrix.decompose(n.position,n.quaternion,n.scale))}},update:function(){const t=this.bones,e=this.boneInverses,n=this.boneMatrices,i=this.boneTexture;for(let r=0,s=t.length;r<s;r++){const o=t[r]?t[r].matrixWorld:HS;Sg.multiplyMatrices(o,e[r]),Sg.toArray(n,r*16)}i!==void 0&&(i.needsUpdate=!0)},clone:function(){return new jf(this.bones,this.boneInverses)},getBoneByName:function(t){for(let e=0,n=this.bones.length;e<n;e++){const i=this.bones[e];if(i.name===t)return i}},dispose:function(){this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=void 0)}});function Mg(){$e.call(this),this.type="Bone"}Mg.prototype=Object.assign(Object.create($e.prototype),{constructor:Mg,isBone:!0});const Ag=new Ie,Cg=new Ie,Cl=[],Ea=new Ht;function qf(t,e,n){Ht.call(this,t,e),this.instanceMatrix=new Qe(new Float32Array(n*16),16),this.count=n,this.frustumCulled=!1}qf.prototype=Object.assign(Object.create(Ht.prototype),{constructor:qf,isInstancedMesh:!0,copy:function(t){return Ht.prototype.copy.call(this,t),this.instanceMatrix.copy(t.instanceMatrix),this.count=t.count,this},getMatrixAt:function(t,e){e.fromArray(this.instanceMatrix.array,t*16)},raycast:function(t,e){const n=this.matrixWorld,i=this.count;if(Ea.geometry=this.geometry,Ea.material=this.material,Ea.material!==void 0)for(let r=0;r<i;r++){this.getMatrixAt(r,Ag),Cg.multiplyMatrices(n,Ag),Ea.matrixWorld=Cg,Ea.raycast(t,Cl);for(let s=0,o=Cl.length;s<o;s++){const a=Cl[s];a.instanceId=r,a.object=this,e.push(a)}Cl.length=0}},setMatrixAt:function(t,e){e.toArray(this.instanceMatrix.array,t*16)},updateMorphTargets:function(){}});function dn(t){at.call(this),this.type="LineBasicMaterial",this.color=new ke(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.morphTargets=!1,this.setValues(t)}dn.prototype=Object.create(at.prototype);dn.prototype.constructor=dn;dn.prototype.isLineBasicMaterial=!0;dn.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.morphTargets=t.morphTargets,this};const Tg=new T,Pg=new T,Eg=new Ie,Tl=new Ko,Pl=new br;function ci(t,e,n){n===1&&console.error("THREE.Line: parameter THREE.LinePieces no longer supported. Use THREE.LineSegments instead."),$e.call(this),this.type="Line",this.geometry=t!==void 0?t:new We,this.material=e!==void 0?e:new dn,this.updateMorphTargets()}ci.prototype=Object.assign(Object.create($e.prototype),{constructor:ci,isLine:!0,copy:function(t){return $e.prototype.copy.call(this,t),this.material=t.material,this.geometry=t.geometry,this},computeLineDistances:function(){const t=this.geometry;if(t.isBufferGeometry)if(t.index===null){const e=t.attributes.position,n=[0];for(let i=1,r=e.count;i<r;i++)Tg.fromBufferAttribute(e,i-1),Pg.fromBufferAttribute(e,i),n[i]=n[i-1],n[i]+=Tg.distanceTo(Pg);t.setAttribute("lineDistance",new qe(n,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(t.isGeometry){const e=t.vertices,n=t.lineDistances;n[0]=0;for(let i=1,r=e.length;i<r;i++)n[i]=n[i-1],n[i]+=e[i-1].distanceTo(e[i])}return this},raycast:function(t,e){const n=this.geometry,i=this.matrixWorld,r=t.params.Line.threshold;if(n.boundingSphere===null&&n.computeBoundingSphere(),Pl.copy(n.boundingSphere),Pl.applyMatrix4(i),Pl.radius+=r,t.ray.intersectsSphere(Pl)===!1)return;Eg.getInverse(i),Tl.copy(t.ray).applyMatrix4(Eg);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=s*s,a=new T,c=new T,l=new T,h=new T,u=this&&this.isLineSegments?2:1;if(n.isBufferGeometry){const f=n.index,p=n.attributes.position.array;if(f!==null){const y=f.array;for(let g=0,m=y.length-1;g<m;g+=u){const x=y[g],v=y[g+1];if(a.fromArray(p,x*3),c.fromArray(p,v*3),Tl.distanceSqToSegment(a,c,h,l)>o)continue;h.applyMatrix4(this.matrixWorld);const _=t.ray.origin.distanceTo(h);_<t.near||_>t.far||e.push({distance:_,point:l.clone().applyMatrix4(this.matrixWorld),index:g,face:null,faceIndex:null,object:this})}}else for(let y=0,g=p.length/3-1;y<g;y+=u){if(a.fromArray(p,3*y),c.fromArray(p,3*y+3),Tl.distanceSqToSegment(a,c,h,l)>o)continue;h.applyMatrix4(this.matrixWorld);const x=t.ray.origin.distanceTo(h);x<t.near||x>t.far||e.push({distance:x,point:l.clone().applyMatrix4(this.matrixWorld),index:y,face:null,faceIndex:null,object:this})}}else if(n.isGeometry){const f=n.vertices,d=f.length;for(let p=0;p<d-1;p+=u){if(Tl.distanceSqToSegment(f[p],f[p+1],h,l)>o)continue;h.applyMatrix4(this.matrixWorld);const g=t.ray.origin.distanceTo(h);g<t.near||g>t.far||e.push({distance:g,point:l.clone().applyMatrix4(this.matrixWorld),index:p,face:null,faceIndex:null,object:this})}}},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,n=Object.keys(e);if(n.length>0){const i=e[n[0]];if(i!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let r=0,s=i.length;r<s;r++){const o=i[r].name||String(r);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=r}}}}else{const e=t.morphTargets;e!==void 0&&e.length>0&&console.error("THREE.Line.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});const El=new T,Il=new T;function on(t,e){ci.call(this,t,e),this.type="LineSegments"}on.prototype=Object.assign(Object.create(ci.prototype),{constructor:on,isLineSegments:!0,computeLineDistances:function(){const t=this.geometry;if(t.isBufferGeometry)if(t.index===null){const e=t.attributes.position,n=[];for(let i=0,r=e.count;i<r;i+=2)El.fromBufferAttribute(e,i),Il.fromBufferAttribute(e,i+1),n[i]=i===0?0:n[i-1],n[i+1]=n[i]+El.distanceTo(Il);t.setAttribute("lineDistance",new qe(n,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");else if(t.isGeometry){const e=t.vertices,n=t.lineDistances;for(let i=0,r=e.length;i<r;i+=2)El.copy(e[i]),Il.copy(e[i+1]),n[i]=i===0?0:n[i-1],n[i+1]=n[i]+El.distanceTo(Il)}return this}});function Xf(t,e){ci.call(this,t,e),this.type="LineLoop"}Xf.prototype=Object.assign(Object.create(ci.prototype),{constructor:Xf,isLineLoop:!0});function ws(t){at.call(this),this.type="PointsMaterial",this.color=new ke(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.setValues(t)}ws.prototype=Object.create(at.prototype);ws.prototype.constructor=ws;ws.prototype.isPointsMaterial=!0;ws.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.morphTargets=t.morphTargets,this};const Ig=new Ie,Yf=new Ko,Ll=new br,Rl=new T;function pc(t,e){$e.call(this),this.type="Points",this.geometry=t!==void 0?t:new We,this.material=e!==void 0?e:new ws,this.updateMorphTargets()}pc.prototype=Object.assign(Object.create($e.prototype),{constructor:pc,isPoints:!0,copy:function(t){return $e.prototype.copy.call(this,t),this.material=t.material,this.geometry=t.geometry,this},raycast:function(t,e){const n=this.geometry,i=this.matrixWorld,r=t.params.Points.threshold;if(n.boundingSphere===null&&n.computeBoundingSphere(),Ll.copy(n.boundingSphere),Ll.applyMatrix4(i),Ll.radius+=r,t.ray.intersectsSphere(Ll)===!1)return;Ig.getInverse(i),Yf.copy(t.ray).applyMatrix4(Ig);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=s*s;if(n.isBufferGeometry){const a=n.index,l=n.attributes.position.array;if(a!==null){const h=a.array;for(let u=0,f=h.length;u<f;u++){const d=h[u];Rl.fromArray(l,d*3),bd(Rl,d,o,i,t,e,this)}}else for(let h=0,u=l.length/3;h<u;h++)Rl.fromArray(l,h*3),bd(Rl,h,o,i,t,e,this)}else{const a=n.vertices;for(let c=0,l=a.length;c<l;c++)bd(a[c],c,o,i,t,e,this)}},updateMorphTargets:function(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,n=Object.keys(e);if(n.length>0){const i=e[n[0]];if(i!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let r=0,s=i.length;r<s;r++){const o=i[r].name||String(r);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=r}}}}else{const e=t.morphTargets;e!==void 0&&e.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}});function bd(t,e,n,i,r,s,o){const a=Yf.distanceSqToPoint(t);if(a<n){const c=new T;Yf.closestPointToPoint(t,c),c.applyMatrix4(i);const l=r.ray.origin.distanceTo(c);if(l<r.near||l>r.far)return;s.push({distance:l,distanceToRay:Math.sqrt(a),point:c,index:e,face:null,object:o})}}function Lg(t,e,n,i,r,s,o,a,c){$t.call(this,t,e,n,i,r,s,o,a,c),this.format=o!==void 0?o:us,this.minFilter=s!==void 0?s:gn,this.magFilter=r!==void 0?r:gn,this.generateMipmaps=!1}Lg.prototype=Object.assign(Object.create($t.prototype),{constructor:Lg,isVideoTexture:!0,update:function(){const t=this.image;t.readyState>=t.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}});function mc(t,e,n,i,r,s,o,a,c,l,h,u){$t.call(this,null,s,o,a,c,l,i,r,h,u),this.image={width:e,height:n},this.mipmaps=t,this.flipY=!1,this.generateMipmaps=!1}mc.prototype=Object.create($t.prototype);mc.prototype.constructor=mc;mc.prototype.isCompressedTexture=!0;function gc(t,e,n,i,r,s,o,a,c){$t.call(this,t,e,n,i,r,s,o,a,c),this.needsUpdate=!0}gc.prototype=Object.create($t.prototype);gc.prototype.constructor=gc;gc.prototype.isCanvasTexture=!0;function kh(t,e,n,i,r,s,o,a,c,l){if(l=l!==void 0?l:xo,l!==xo&&l!==sc)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");n===void 0&&l===xo&&(n=Eh),n===void 0&&l===sc&&(n=Za),$t.call(this,null,i,r,s,o,a,l,n,c),this.image={width:t,height:e},this.magFilter=o!==void 0?o:zt,this.minFilter=a!==void 0?a:zt,this.flipY=!1,this.generateMipmaps=!1}kh.prototype=Object.create($t.prototype);kh.prototype.constructor=kh;kh.prototype.isDepthTexture=!0;function Fh(t){We.call(this),this.type="WireframeGeometry";const e=[],n=[0,0],i={},r=["a","b","c"];if(t&&t.isGeometry){const s=t.faces;for(let o=0,a=s.length;o<a;o++){const c=s[o];for(let l=0;l<3;l++){const h=c[r[l]],u=c[r[(l+1)%3]];n[0]=Math.min(h,u),n[1]=Math.max(h,u);const f=n[0]+","+n[1];i[f]===void 0&&(i[f]={index1:n[0],index2:n[1]})}}for(const o in i){const a=i[o];let c=t.vertices[a.index1];e.push(c.x,c.y,c.z),c=t.vertices[a.index2],e.push(c.x,c.y,c.z)}}else if(t&&t.isBufferGeometry){let s=new T;if(t.index!==null){const o=t.attributes.position,a=t.index;let c=t.groups;c.length===0&&(c=[{start:0,count:a.count,materialIndex:0}]);for(let l=0,h=c.length;l<h;++l){const u=c[l],f=u.start,d=u.count;for(let p=f,y=f+d;p<y;p+=3)for(let g=0;g<3;g++){const m=a.getX(p+g),x=a.getX(p+(g+1)%3);n[0]=Math.min(m,x),n[1]=Math.max(m,x);const v=n[0]+","+n[1];i[v]===void 0&&(i[v]={index1:n[0],index2:n[1]})}}for(const l in i){const h=i[l];s.fromBufferAttribute(o,h.index1),e.push(s.x,s.y,s.z),s.fromBufferAttribute(o,h.index2),e.push(s.x,s.y,s.z)}}else{const o=t.attributes.position;for(let a=0,c=o.count/3;a<c;a++)for(let l=0;l<3;l++){const h=3*a+l;s.fromBufferAttribute(o,h),e.push(s.x,s.y,s.z);const u=3*a+(l+1)%3;s.fromBufferAttribute(o,u),e.push(s.x,s.y,s.z)}}}this.setAttribute("position",new qe(e,3))}Fh.prototype=Object.create(We.prototype);Fh.prototype.constructor=Fh;function Nh(t,e,n){rt.call(this),this.type="ParametricGeometry",this.parameters={func:t,slices:e,stacks:n},this.fromBufferGeometry(new yc(t,e,n)),this.mergeVertices()}Nh.prototype=Object.create(rt.prototype);Nh.prototype.constructor=Nh;function yc(t,e,n){We.call(this),this.type="ParametricBufferGeometry",this.parameters={func:t,slices:e,stacks:n};const i=[],r=[],s=[],o=[],a=1e-5,c=new T,l=new T,h=new T,u=new T,f=new T;t.length<3&&console.error("THREE.ParametricGeometry: Function must now modify a Vector3 as third parameter.");const d=e+1;for(let p=0;p<=n;p++){const y=p/n;for(let g=0;g<=e;g++){const m=g/e;t(m,y,l),r.push(l.x,l.y,l.z),m-a>=0?(t(m-a,y,h),u.subVectors(l,h)):(t(m+a,y,h),u.subVectors(h,l)),y-a>=0?(t(m,y-a,h),f.subVectors(l,h)):(t(m,y+a,h),f.subVectors(h,l)),c.crossVectors(u,f).normalize(),s.push(c.x,c.y,c.z),o.push(m,y)}}for(let p=0;p<n;p++)for(let y=0;y<e;y++){const g=p*d+y,m=p*d+y+1,x=(p+1)*d+y+1,v=(p+1)*d+y;i.push(g,m,v),i.push(m,x,v)}this.setIndex(i),this.setAttribute("position",new qe(r,3)),this.setAttribute("normal",new qe(s,3)),this.setAttribute("uv",new qe(o,2))}yc.prototype=Object.create(We.prototype);yc.prototype.constructor=yc;function zh(t,e,n,i){rt.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:t,indices:e,radius:n,detail:i},this.fromBufferGeometry(new Xn(t,e,n,i)),this.mergeVertices()}zh.prototype=Object.create(rt.prototype);zh.prototype.constructor=zh;function Xn(t,e,n,i){We.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:t,indices:e,radius:n,detail:i},n=n||1,i=i||0;const r=[],s=[];o(i),c(n),l(),this.setAttribute("position",new qe(r,3)),this.setAttribute("normal",new qe(r.slice(),3)),this.setAttribute("uv",new qe(s,2)),i===0?this.computeVertexNormals():this.normalizeNormals();function o(m){const x=new T,v=new T,b=new T;for(let _=0;_<e.length;_+=3)f(e[_+0],x),f(e[_+1],v),f(e[_+2],b),a(x,v,b,m)}function a(m,x,v,b){const _=Math.pow(2,b),C=[];for(let w=0;w<=_;w++){C[w]=[];const S=m.clone().lerp(v,w/_),M=x.clone().lerp(v,w/_),B=_-w;for(let L=0;L<=B;L++)L===0&&w===_?C[w][L]=S:C[w][L]=S.clone().lerp(M,L/B)}for(let w=0;w<_;w++)for(let S=0;S<2*(_-w)-1;S++){const M=Math.floor(S/2);S%2===0?(u(C[w][M+1]),u(C[w+1][M]),u(C[w][M])):(u(C[w][M+1]),u(C[w+1][M+1]),u(C[w+1][M]))}}function c(m){const x=new T;for(let v=0;v<r.length;v+=3)x.x=r[v+0],x.y=r[v+1],x.z=r[v+2],x.normalize().multiplyScalar(m),r[v+0]=x.x,r[v+1]=x.y,r[v+2]=x.z}function l(){const m=new T;for(let x=0;x<r.length;x+=3){m.x=r[x+0],m.y=r[x+1],m.z=r[x+2];const v=y(m)/2/Math.PI+.5,b=g(m)/Math.PI+.5;s.push(v,1-b)}d(),h()}function h(){for(let m=0;m<s.length;m+=6){const x=s[m+0],v=s[m+2],b=s[m+4],_=Math.max(x,v,b),C=Math.min(x,v,b);_>.9&&C<.1&&(x<.2&&(s[m+0]+=1),v<.2&&(s[m+2]+=1),b<.2&&(s[m+4]+=1))}}function u(m){r.push(m.x,m.y,m.z)}function f(m,x){const v=m*3;x.x=t[v+0],x.y=t[v+1],x.z=t[v+2]}function d(){const m=new T,x=new T,v=new T,b=new T,_=new Te,C=new Te,w=new Te;for(let S=0,M=0;S<r.length;S+=9,M+=6){m.set(r[S+0],r[S+1],r[S+2]),x.set(r[S+3],r[S+4],r[S+5]),v.set(r[S+6],r[S+7],r[S+8]),_.set(s[M+0],s[M+1]),C.set(s[M+2],s[M+3]),w.set(s[M+4],s[M+5]),b.copy(m).add(x).add(v).divideScalar(3);const B=y(b);p(_,M+0,m,B),p(C,M+2,x,B),p(w,M+4,v,B)}}function p(m,x,v,b){b<0&&m.x===1&&(s[x]=m.x-1),v.x===0&&v.z===0&&(s[x]=b/2/Math.PI+.5)}function y(m){return Math.atan2(m.z,-m.x)}function g(m){return Math.atan2(-m.y,Math.sqrt(m.x*m.x+m.z*m.z))}}Xn.prototype=Object.create(We.prototype);Xn.prototype.constructor=Xn;function Gh(t,e){rt.call(this),this.type="TetrahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new To(t,e)),this.mergeVertices()}Gh.prototype=Object.create(rt.prototype);Gh.prototype.constructor=Gh;function To(t,e){const n=[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],i=[2,1,0,0,3,2,1,3,0,2,3,1];Xn.call(this,n,i,t,e),this.type="TetrahedronBufferGeometry",this.parameters={radius:t,detail:e}}To.prototype=Object.create(Xn.prototype);To.prototype.constructor=To;function Uh(t,e){rt.call(this),this.type="OctahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new Ss(t,e)),this.mergeVertices()}Uh.prototype=Object.create(rt.prototype);Uh.prototype.constructor=Uh;function Ss(t,e){const n=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],i=[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2];Xn.call(this,n,i,t,e),this.type="OctahedronBufferGeometry",this.parameters={radius:t,detail:e}}Ss.prototype=Object.create(Xn.prototype);Ss.prototype.constructor=Ss;function Vh(t,e){rt.call(this),this.type="IcosahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new Ms(t,e)),this.mergeVertices()}Vh.prototype=Object.create(rt.prototype);Vh.prototype.constructor=Vh;function Ms(t,e){const n=(1+Math.sqrt(5))/2,i=[-1,n,0,1,n,0,-1,-n,0,1,-n,0,0,-1,n,0,1,n,0,-1,-n,0,1,-n,n,0,-1,n,0,1,-n,0,-1,-n,0,1],r=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];Xn.call(this,i,r,t,e),this.type="IcosahedronBufferGeometry",this.parameters={radius:t,detail:e}}Ms.prototype=Object.create(Xn.prototype);Ms.prototype.constructor=Ms;function Hh(t,e){rt.call(this),this.type="DodecahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new xc(t,e)),this.mergeVertices()}Hh.prototype=Object.create(rt.prototype);Hh.prototype.constructor=Hh;function xc(t,e){const n=(1+Math.sqrt(5))/2,i=1/n,r=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-i,-n,0,-i,n,0,i,-n,0,i,n,-i,-n,0,-i,n,0,i,-n,0,i,n,0,-n,0,-i,n,0,-i,-n,0,i,n,0,i],s=[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9];Xn.call(this,r,s,t,e),this.type="DodecahedronBufferGeometry",this.parameters={radius:t,detail:e}}xc.prototype=Object.create(Xn.prototype);xc.prototype.constructor=xc;function $h(t,e,n,i,r,s){rt.call(this),this.type="TubeGeometry",this.parameters={path:t,tubularSegments:e,radius:n,radialSegments:i,closed:r},s!==void 0&&console.warn("THREE.TubeGeometry: taper has been removed.");const o=new Po(t,e,n,i,r);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals,this.fromBufferGeometry(o),this.mergeVertices()}$h.prototype=Object.create(rt.prototype);$h.prototype.constructor=$h;function Po(t,e,n,i,r){We.call(this),this.type="TubeBufferGeometry",this.parameters={path:t,tubularSegments:e,radius:n,radialSegments:i,closed:r},e=e||64,n=n||1,i=i||8,r=r||!1;const s=t.computeFrenetFrames(e,r);this.tangents=s.tangents,this.normals=s.normals,this.binormals=s.binormals;const o=new T,a=new T,c=new Te;let l=new T;const h=[],u=[],f=[],d=[];p(),this.setIndex(d),this.setAttribute("position",new qe(h,3)),this.setAttribute("normal",new qe(u,3)),this.setAttribute("uv",new qe(f,2));function p(){for(let x=0;x<e;x++)y(x);y(r===!1?e:0),m(),g()}function y(x){l=t.getPointAt(x/e,l);const v=s.normals[x],b=s.binormals[x];for(let _=0;_<=i;_++){const C=_/i*Math.PI*2,w=Math.sin(C),S=-Math.cos(C);a.x=S*v.x+w*b.x,a.y=S*v.y+w*b.y,a.z=S*v.z+w*b.z,a.normalize(),u.push(a.x,a.y,a.z),o.x=l.x+n*a.x,o.y=l.y+n*a.y,o.z=l.z+n*a.z,h.push(o.x,o.y,o.z)}}function g(){for(let x=1;x<=e;x++)for(let v=1;v<=i;v++){const b=(i+1)*(x-1)+(v-1),_=(i+1)*x+(v-1),C=(i+1)*x+v,w=(i+1)*(x-1)+v;d.push(b,_,w),d.push(_,C,w)}}function m(){for(let x=0;x<=e;x++)for(let v=0;v<=i;v++)c.x=x/e,c.y=v/i,f.push(c.x,c.y)}}Po.prototype=Object.create(We.prototype);Po.prototype.constructor=Po;Po.prototype.toJSON=function(){const t=We.prototype.toJSON.call(this);return t.path=this.parameters.path.toJSON(),t};function Wh(t,e,n,i,r,s,o){rt.call(this),this.type="TorusKnotGeometry",this.parameters={radius:t,tube:e,tubularSegments:n,radialSegments:i,p:r,q:s},o!==void 0&&console.warn("THREE.TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new bc(t,e,n,i,r,s)),this.mergeVertices()}Wh.prototype=Object.create(rt.prototype);Wh.prototype.constructor=Wh;function bc(t,e,n,i,r,s){We.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:t,tube:e,tubularSegments:n,radialSegments:i,p:r,q:s},t=t||1,e=e||.4,n=Math.floor(n)||64,i=Math.floor(i)||8,r=r||2,s=s||3;const o=[],a=[],c=[],l=[],h=new T,u=new T,f=new T,d=new T,p=new T,y=new T,g=new T;for(let x=0;x<=n;++x){const v=x/n*r*Math.PI*2;m(v,r,s,t,f),m(v+.01,r,s,t,d),y.subVectors(d,f),g.addVectors(d,f),p.crossVectors(y,g),g.crossVectors(p,y),p.normalize(),g.normalize();for(let b=0;b<=i;++b){const _=b/i*Math.PI*2,C=-e*Math.cos(_),w=e*Math.sin(_);h.x=f.x+(C*g.x+w*p.x),h.y=f.y+(C*g.y+w*p.y),h.z=f.z+(C*g.z+w*p.z),a.push(h.x,h.y,h.z),u.subVectors(h,f).normalize(),c.push(u.x,u.y,u.z),l.push(x/n),l.push(b/i)}}for(let x=1;x<=n;x++)for(let v=1;v<=i;v++){const b=(i+1)*(x-1)+(v-1),_=(i+1)*x+(v-1),C=(i+1)*x+v,w=(i+1)*(x-1)+v;o.push(b,_,w),o.push(_,C,w)}this.setIndex(o),this.setAttribute("position",new qe(a,3)),this.setAttribute("normal",new qe(c,3)),this.setAttribute("uv",new qe(l,2));function m(x,v,b,_,C){const w=Math.cos(x),S=Math.sin(x),M=b/v*x,B=Math.cos(M);C.x=_*(2+B)*.5*w,C.y=_*(2+B)*S*.5,C.z=_*Math.sin(M)*.5}}bc.prototype=Object.create(We.prototype);bc.prototype.constructor=bc;function jh(t,e,n,i,r){rt.call(this),this.type="TorusGeometry",this.parameters={radius:t,tube:e,radialSegments:n,tubularSegments:i,arc:r},this.fromBufferGeometry(new Eo(t,e,n,i,r)),this.mergeVertices()}jh.prototype=Object.create(rt.prototype);jh.prototype.constructor=jh;function Eo(t,e,n,i,r){We.call(this),this.type="TorusBufferGeometry",this.parameters={radius:t,tube:e,radialSegments:n,tubularSegments:i,arc:r},t=t||1,e=e||.4,n=Math.floor(n)||8,i=Math.floor(i)||6,r=r||Math.PI*2;const s=[],o=[],a=[],c=[],l=new T,h=new T,u=new T;for(let f=0;f<=n;f++)for(let d=0;d<=i;d++){const p=d/i*r,y=f/n*Math.PI*2;h.x=(t+e*Math.cos(y))*Math.cos(p),h.y=(t+e*Math.cos(y))*Math.sin(p),h.z=e*Math.sin(y),o.push(h.x,h.y,h.z),l.x=t*Math.cos(p),l.y=t*Math.sin(p),u.subVectors(h,l).normalize(),a.push(u.x,u.y,u.z),c.push(d/i),c.push(f/n)}for(let f=1;f<=n;f++)for(let d=1;d<=i;d++){const p=(i+1)*f+d-1,y=(i+1)*(f-1)+d-1,g=(i+1)*(f-1)+d,m=(i+1)*f+d;s.push(p,y,m),s.push(y,g,m)}this.setIndex(s),this.setAttribute("position",new qe(o,3)),this.setAttribute("normal",new qe(a,3)),this.setAttribute("uv",new qe(c,2))}Eo.prototype=Object.create(We.prototype);Eo.prototype.constructor=Eo;const $S={triangulate:function(t,e,n){n=n||2;let i=e&&e.length,r=i?e[0]*n:t.length,s=Qy(t,0,r,n,!0),o=[];if(!s||s.next===s.prev)return o;let a,c,l,h,u,f,d;if(i&&(s=YS(t,e,s,n)),t.length>80*n){a=l=t[0],c=h=t[1];for(let p=n;p<r;p+=n)u=t[p],f=t[p+1],u<a&&(a=u),f<c&&(c=f),u>l&&(l=u),f>h&&(h=f);d=Math.max(l-a,h-c),d=d!==0?1/d:0}return vc(s,o,n,a,c,d),o}};function Qy(t,e,n,i,r){let s,o;if(r===oM(t,e,n,i)>0)for(s=e;s<n;s+=i)o=Rg(s,t[s],t[s+1],o);else for(s=n-i;s>=e;s-=i)o=Rg(s,t[s],t[s+1],o);return o&&Pu(o,o.next)&&(wc(o),o=o.next),o}function Hr(t,e){if(!t)return t;e||(e=t);let n=t,i;do if(i=!1,!n.steiner&&(Pu(n,n.next)||sn(n.prev,n,n.next)===0)){if(wc(n),n=e=n.prev,n===n.next)break;i=!0}else n=n.next;while(i||n!==e);return e}function vc(t,e,n,i,r,s,o){if(!t)return;!o&&s&&eM(t,i,r,s);let a=t,c,l;for(;t.prev!==t.next;){if(c=t.prev,l=t.next,s?jS(t,i,r,s):WS(t)){e.push(c.i/n),e.push(t.i/n),e.push(l.i/n),wc(t),t=l.next,a=l.next;continue}if(t=l,t===a){o?o===1?(t=qS(Hr(t),e,n),vc(t,e,n,i,r,s,2)):o===2&&XS(t,e,n,i,r,s):vc(Hr(t),e,n,i,r,s,1);break}}}function WS(t){let e=t.prev,n=t,i=t.next;if(sn(e,n,i)>=0)return!1;let r=t.next.next;for(;r!==t.prev;){if(fo(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&sn(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function jS(t,e,n,i){let r=t.prev,s=t,o=t.next;if(sn(r,s,o)>=0)return!1;let a=r.x<s.x?r.x<o.x?r.x:o.x:s.x<o.x?s.x:o.x,c=r.y<s.y?r.y<o.y?r.y:o.y:s.y<o.y?s.y:o.y,l=r.x>s.x?r.x>o.x?r.x:o.x:s.x>o.x?s.x:o.x,h=r.y>s.y?r.y>o.y?r.y:o.y:s.y>o.y?s.y:o.y,u=Zf(a,c,e,n,i),f=Zf(l,h,e,n,i),d=t.prevZ,p=t.nextZ;for(;d&&d.z>=u&&p&&p.z<=f;){if(d!==t.prev&&d!==t.next&&fo(r.x,r.y,s.x,s.y,o.x,o.y,d.x,d.y)&&sn(d.prev,d,d.next)>=0||(d=d.prevZ,p!==t.prev&&p!==t.next&&fo(r.x,r.y,s.x,s.y,o.x,o.y,p.x,p.y)&&sn(p.prev,p,p.next)>=0))return!1;p=p.nextZ}for(;d&&d.z>=u;){if(d!==t.prev&&d!==t.next&&fo(r.x,r.y,s.x,s.y,o.x,o.y,d.x,d.y)&&sn(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;p&&p.z<=f;){if(p!==t.prev&&p!==t.next&&fo(r.x,r.y,s.x,s.y,o.x,o.y,p.x,p.y)&&sn(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function qS(t,e,n){let i=t;do{let r=i.prev,s=i.next.next;!Pu(r,s)&&ex(r,i,i.next,s)&&_c(r,s)&&_c(s,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(s.i/n),wc(i),wc(i.next),i=t=s),i=i.next}while(i!==t);return Hr(i)}function XS(t,e,n,i,r,s){let o=t;do{let a=o.next.next;for(;a!==o.prev;){if(o.i!==a.i&&iM(o,a)){let c=tx(o,a);o=Hr(o,o.next),c=Hr(c,c.next),vc(o,e,n,i,r,s),vc(c,e,n,i,r,s);return}a=a.next}o=o.next}while(o!==t)}function YS(t,e,n,i){let r=[],s,o,a,c,l;for(s=0,o=e.length;s<o;s++)a=e[s]*i,c=s<o-1?e[s+1]*i:t.length,l=Qy(t,a,c,i,!1),l===l.next&&(l.steiner=!0),r.push(nM(l));for(r.sort(ZS),s=0;s<r.length;s++)KS(r[s],n),n=Hr(n,n.next);return n}function ZS(t,e){return t.x-e.x}function KS(t,e){if(e=JS(t,e),e){const n=tx(e,t);Hr(e,e.next),Hr(n,n.next)}}function JS(t,e){let n=e,i=t.x,r=t.y,s=-1/0,o;do{if(r<=n.y&&r>=n.next.y&&n.next.y!==n.y){let f=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(f<=i&&f>s){if(s=f,f===i){if(r===n.y)return n;if(r===n.next.y)return n.next}o=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!o)return null;if(i===s)return o;let a=o,c=o.x,l=o.y,h=1/0,u;n=o;do i>=n.x&&n.x>=c&&i!==n.x&&fo(r<l?i:s,r,c,l,r<l?s:i,r,n.x,n.y)&&(u=Math.abs(r-n.y)/(i-n.x),_c(n,t)&&(u<h||u===h&&(n.x>o.x||n.x===o.x&&QS(o,n)))&&(o=n,h=u)),n=n.next;while(n!==a);return o}function QS(t,e){return sn(t.prev,t,e.prev)<0&&sn(e.next,t,t.next)<0}function eM(t,e,n,i){let r=t;do r.z===null&&(r.z=Zf(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next;while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,tM(r)}function tM(t){let e,n,i,r,s,o,a,c,l=1;do{for(n=t,t=null,s=null,o=0;n;){for(o++,i=n,a=0,e=0;e<l&&(a++,i=i.nextZ,!!i);e++);for(c=l;a>0||c>0&&i;)a!==0&&(c===0||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,c--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;n=i}s.nextZ=null,l*=2}while(o>1);return t}function Zf(t,e,n,i,r){return t=32767*(t-n)*r,e=32767*(e-i)*r,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,t|e<<1}function nM(t){let e=t,n=t;do(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next;while(e!==t);return n}function fo(t,e,n,i,r,s,o,a){return(r-o)*(e-a)-(t-o)*(s-a)>=0&&(t-o)*(i-a)-(n-o)*(e-a)>=0&&(n-o)*(s-a)-(r-o)*(i-a)>=0}function iM(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!rM(t,e)&&(_c(t,e)&&_c(e,t)&&sM(t,e)&&(sn(t.prev,t,e.prev)||sn(t,e.prev,e))||Pu(t,e)&&sn(t.prev,t,t.next)>0&&sn(e.prev,e,e.next)>0)}function sn(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Pu(t,e){return t.x===e.x&&t.y===e.y}function ex(t,e,n,i){const r=Bl(sn(t,e,n)),s=Bl(sn(t,e,i)),o=Bl(sn(n,i,t)),a=Bl(sn(n,i,e));return!!(r!==s&&o!==a||r===0&&Dl(t,n,e)||s===0&&Dl(t,i,e)||o===0&&Dl(n,t,i)||a===0&&Dl(n,e,i))}function Dl(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Bl(t){return t>0?1:t<0?-1:0}function rM(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&ex(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}function _c(t,e){return sn(t.prev,t,t.next)<0?sn(t,e,t.next)>=0&&sn(t,t.prev,e)>=0:sn(t,e,t.prev)<0||sn(t,t.next,e)<0}function sM(t,e){let n=t,i=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do n.y>s!=n.next.y>s&&n.next.y!==n.y&&r<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next;while(n!==t);return i}function tx(t,e){let n=new Kf(t.i,t.x,t.y),i=new Kf(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function Rg(t,e,n,i){const r=new Kf(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function wc(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Kf(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function oM(t,e,n,i){let r=0;for(let s=e,o=n-i;s<n;s+=i)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}const kr={area:function(t){const e=t.length;let n=0;for(let i=e-1,r=0;r<e;i=r++)n+=t[i].x*t[r].y-t[r].x*t[i].y;return n*.5},isClockWise:function(t){return kr.area(t)<0},triangulateShape:function(t,e){const n=[],i=[],r=[];Dg(t),Bg(n,t);let s=t.length;e.forEach(Dg);for(let a=0;a<e.length;a++)i.push(s),s+=e[a].length,Bg(n,e[a]);const o=$S.triangulate(n,i);for(let a=0;a<o.length;a+=3)r.push(o.slice(a,a+3));return r}};function Dg(t){const e=t.length;e>2&&t[e-1].equals(t[0])&&t.pop()}function Bg(t,e){for(let n=0;n<e.length;n++)t.push(e[n].x),t.push(e[n].y)}function Io(t,e){rt.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:t,options:e},this.fromBufferGeometry(new lr(t,e)),this.mergeVertices()}Io.prototype=Object.create(rt.prototype);Io.prototype.constructor=Io;Io.prototype.toJSON=function(){const t=rt.prototype.toJSON.call(this),e=this.parameters.shapes,n=this.parameters.options;return nx(e,n,t)};function lr(t,e){We.call(this),this.type="ExtrudeBufferGeometry",this.parameters={shapes:t,options:e},t=Array.isArray(t)?t:[t];const n=this,i=[],r=[];for(let o=0,a=t.length;o<a;o++){const c=t[o];s(c)}this.setAttribute("position",new qe(i,3)),this.setAttribute("uv",new qe(r,2)),this.computeVertexNormals();function s(o){const a=[],c=e.curveSegments!==void 0?e.curveSegments:12,l=e.steps!==void 0?e.steps:1;let h=e.depth!==void 0?e.depth:100,u=e.bevelEnabled!==void 0?e.bevelEnabled:!0,f=e.bevelThickness!==void 0?e.bevelThickness:6,d=e.bevelSize!==void 0?e.bevelSize:f-2,p=e.bevelOffset!==void 0?e.bevelOffset:0,y=e.bevelSegments!==void 0?e.bevelSegments:3;const g=e.extrudePath,m=e.UVGenerator!==void 0?e.UVGenerator:aM;e.amount!==void 0&&(console.warn("THREE.ExtrudeBufferGeometry: amount has been renamed to depth."),h=e.amount);let x,v=!1,b,_,C,w;g&&(x=g.getSpacedPoints(l),v=!0,u=!1,b=g.computeFrenetFrames(l,!1),_=new T,C=new T,w=new T),u||(y=0,f=0,d=0,p=0);const S=o.extractPoints(c);let M=S.shape;const B=S.holes;if(!kr.isClockWise(M)){M=M.reverse();for(let H=0,se=B.length;H<se;H++){const $=B[H];kr.isClockWise($)&&(B[H]=$.reverse())}}const U=kr.triangulateShape(M,B),E=M;for(let H=0,se=B.length;H<se;H++){const $=B[H];M=M.concat($)}function O(H,se,$){return se||console.error("THREE.ExtrudeGeometry: vec does not exist"),se.clone().multiplyScalar($).add(H)}const k=M.length,ne=U.length;function Y(H,se,$){let he,me,le;const D=H.x-se.x,N=H.y-se.y,pe=$.x-H.x,ue=$.y-H.y,X=D*D+N*N,ye=D*ue-N*pe;if(Math.abs(ye)>Number.EPSILON){const _e=Math.sqrt(X),xe=Math.sqrt(pe*pe+ue*ue),Se=se.x-N/_e,Me=se.y+D/_e,Oe=$.x-ue/xe,Ne=$.y+pe/xe,we=((Oe-Se)*ue-(Ne-Me)*pe)/(D*ue-N*pe);he=Se+D*we-H.x,me=Me+N*we-H.y;const Fe=he*he+me*me;if(Fe<=2)return new Te(he,me);le=Math.sqrt(Fe/2)}else{let _e=!1;D>Number.EPSILON?pe>Number.EPSILON&&(_e=!0):D<-Number.EPSILON?pe<-Number.EPSILON&&(_e=!0):Math.sign(N)===Math.sign(ue)&&(_e=!0),_e?(he=-N,me=D,le=Math.sqrt(X)):(he=D,me=N,le=Math.sqrt(X/2))}return new Te(he/le,me/le)}const F=[];for(let H=0,se=E.length,$=se-1,he=H+1;H<se;H++,$++,he++)$===se&&($=0),he===se&&(he=0),F[H]=Y(E[H],E[$],E[he]);const te=[];let ee,j=F.concat();for(let H=0,se=B.length;H<se;H++){const $=B[H];ee=[];for(let he=0,me=$.length,le=me-1,D=he+1;he<me;he++,le++,D++)le===me&&(le=0),D===me&&(D=0),ee[he]=Y($[he],$[le],$[D]);te.push(ee),j=j.concat(ee)}for(let H=0;H<y;H++){const se=H/y,$=f*Math.cos(se*Math.PI/2),he=d*Math.sin(se*Math.PI/2)+p;for(let me=0,le=E.length;me<le;me++){const D=O(E[me],F[me],he);V(D.x,D.y,-$)}for(let me=0,le=B.length;me<le;me++){const D=B[me];ee=te[me];for(let N=0,pe=D.length;N<pe;N++){const ue=O(D[N],ee[N],he);V(ue.x,ue.y,-$)}}}const Z=d+p;for(let H=0;H<k;H++){const se=u?O(M[H],j[H],Z):M[H];v?(C.copy(b.normals[0]).multiplyScalar(se.x),_.copy(b.binormals[0]).multiplyScalar(se.y),w.copy(x[0]).add(C).add(_),V(w.x,w.y,w.z)):V(se.x,se.y,0)}for(let H=1;H<=l;H++)for(let se=0;se<k;se++){const $=u?O(M[se],j[se],Z):M[se];v?(C.copy(b.normals[H]).multiplyScalar($.x),_.copy(b.binormals[H]).multiplyScalar($.y),w.copy(x[H]).add(C).add(_),V(w.x,w.y,w.z)):V($.x,$.y,h/l*H)}for(let H=y-1;H>=0;H--){const se=H/y,$=f*Math.cos(se*Math.PI/2),he=d*Math.sin(se*Math.PI/2)+p;for(let me=0,le=E.length;me<le;me++){const D=O(E[me],F[me],he);V(D.x,D.y,h+$)}for(let me=0,le=B.length;me<le;me++){const D=B[me];ee=te[me];for(let N=0,pe=D.length;N<pe;N++){const ue=O(D[N],ee[N],he);v?V(ue.x,ue.y+x[l-1].y,x[l-1].x+$):V(ue.x,ue.y,h+$)}}}ce(),de();function ce(){const H=i.length/3;if(u){let se=0,$=k*se;for(let he=0;he<ne;he++){const me=U[he];re(me[2]+$,me[1]+$,me[0]+$)}se=l+y*2,$=k*se;for(let he=0;he<ne;he++){const me=U[he];re(me[0]+$,me[1]+$,me[2]+$)}}else{for(let se=0;se<ne;se++){const $=U[se];re($[2],$[1],$[0])}for(let se=0;se<ne;se++){const $=U[se];re($[0]+k*l,$[1]+k*l,$[2]+k*l)}}n.addGroup(H,i.length/3-H,0)}function de(){const H=i.length/3;let se=0;oe(E,se),se+=E.length;for(let $=0,he=B.length;$<he;$++){const me=B[$];oe(me,se),se+=me.length}n.addGroup(H,i.length/3-H,1)}function oe(H,se){let $=H.length;for(;--$>=0;){const he=$;let me=$-1;me<0&&(me=H.length-1);for(let le=0,D=l+y*2;le<D;le++){const N=k*le,pe=k*(le+1),ue=se+he+N,X=se+me+N,ye=se+me+pe,_e=se+he+pe;q(ue,X,ye,_e)}}}function V(H,se,$){a.push(H),a.push(se),a.push($)}function re(H,se,$){J(H),J(se),J($);const he=i.length/3,me=m.generateTopUV(n,i,he-3,he-2,he-1);W(me[0]),W(me[1]),W(me[2])}function q(H,se,$,he){J(H),J(se),J(he),J(se),J($),J(he);const me=i.length/3,le=m.generateSideWallUV(n,i,me-6,me-3,me-2,me-1);W(le[0]),W(le[1]),W(le[3]),W(le[1]),W(le[2]),W(le[3])}function J(H){i.push(a[H*3+0]),i.push(a[H*3+1]),i.push(a[H*3+2])}function W(H){r.push(H.x),r.push(H.y)}}}lr.prototype=Object.create(We.prototype);lr.prototype.constructor=lr;lr.prototype.toJSON=function(){const t=We.prototype.toJSON.call(this),e=this.parameters.shapes,n=this.parameters.options;return nx(e,n,t)};const aM={generateTopUV:function(t,e,n,i,r){const s=e[n*3],o=e[n*3+1],a=e[i*3],c=e[i*3+1],l=e[r*3],h=e[r*3+1];return[new Te(s,o),new Te(a,c),new Te(l,h)]},generateSideWallUV:function(t,e,n,i,r,s){const o=e[n*3],a=e[n*3+1],c=e[n*3+2],l=e[i*3],h=e[i*3+1],u=e[i*3+2],f=e[r*3],d=e[r*3+1],p=e[r*3+2],y=e[s*3],g=e[s*3+1],m=e[s*3+2];return Math.abs(a-h)<.01?[new Te(o,1-c),new Te(l,1-u),new Te(f,1-p),new Te(y,1-m)]:[new Te(a,1-c),new Te(h,1-u),new Te(d,1-p),new Te(g,1-m)]}};function nx(t,e,n){if(n.shapes=[],Array.isArray(t))for(let i=0,r=t.length;i<r;i++){const s=t[i];n.shapes.push(s.uuid)}else n.shapes.push(t.uuid);return e.extrudePath!==void 0&&(n.options.extrudePath=e.extrudePath.toJSON()),n}function qh(t,e){rt.call(this),this.type="TextGeometry",this.parameters={text:t,parameters:e},this.fromBufferGeometry(new Sc(t,e)),this.mergeVertices()}qh.prototype=Object.create(rt.prototype);qh.prototype.constructor=qh;function Sc(t,e){e=e||{};const n=e.font;if(!(n&&n.isFont))return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new rt;const i=n.generateShapes(t,e.size);e.depth=e.height!==void 0?e.height:50,e.bevelThickness===void 0&&(e.bevelThickness=10),e.bevelSize===void 0&&(e.bevelSize=8),e.bevelEnabled===void 0&&(e.bevelEnabled=!1),lr.call(this,i,e),this.type="TextBufferGeometry"}Sc.prototype=Object.create(lr.prototype);Sc.prototype.constructor=Sc;function Xh(t,e,n,i,r,s,o){rt.call(this),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:n,phiStart:i,phiLength:r,thetaStart:s,thetaLength:o},this.fromBufferGeometry(new Lo(t,e,n,i,r,s,o)),this.mergeVertices()}Xh.prototype=Object.create(rt.prototype);Xh.prototype.constructor=Xh;function Lo(t,e,n,i,r,s,o){We.call(this),this.type="SphereBufferGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:n,phiStart:i,phiLength:r,thetaStart:s,thetaLength:o},t=t||1,e=Math.max(3,Math.floor(e)||8),n=Math.max(2,Math.floor(n)||6),i=i!==void 0?i:0,r=r!==void 0?r:Math.PI*2,s=s!==void 0?s:0,o=o!==void 0?o:Math.PI;const a=Math.min(s+o,Math.PI);let c=0;const l=[],h=new T,u=new T,f=[],d=[],p=[],y=[];for(let g=0;g<=n;g++){const m=[],x=g/n;let v=0;g==0&&s==0?v=.5/e:g==n&&a==Math.PI&&(v=-.5/e);for(let b=0;b<=e;b++){const _=b/e;h.x=-t*Math.cos(i+_*r)*Math.sin(s+x*o),h.y=t*Math.cos(s+x*o),h.z=t*Math.sin(i+_*r)*Math.sin(s+x*o),d.push(h.x,h.y,h.z),u.copy(h).normalize(),p.push(u.x,u.y,u.z),y.push(_+v,1-x),m.push(c++)}l.push(m)}for(let g=0;g<n;g++)for(let m=0;m<e;m++){const x=l[g][m+1],v=l[g][m],b=l[g+1][m],_=l[g+1][m+1];(g!==0||s>0)&&f.push(x,v,_),(g!==n-1||a<Math.PI)&&f.push(v,b,_)}this.setIndex(f),this.setAttribute("position",new qe(d,3)),this.setAttribute("normal",new qe(p,3)),this.setAttribute("uv",new qe(y,2))}Lo.prototype=Object.create(We.prototype);Lo.prototype.constructor=Lo;function Yh(t,e,n,i,r,s){rt.call(this),this.type="RingGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:n,phiSegments:i,thetaStart:r,thetaLength:s},this.fromBufferGeometry(new Mc(t,e,n,i,r,s)),this.mergeVertices()}Yh.prototype=Object.create(rt.prototype);Yh.prototype.constructor=Yh;function Mc(t,e,n,i,r,s){We.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:n,phiSegments:i,thetaStart:r,thetaLength:s},t=t||.5,e=e||1,r=r!==void 0?r:0,s=s!==void 0?s:Math.PI*2,n=n!==void 0?Math.max(3,n):8,i=i!==void 0?Math.max(1,i):1;const o=[],a=[],c=[],l=[];let h=t;const u=(e-t)/i,f=new T,d=new Te;for(let p=0;p<=i;p++){for(let y=0;y<=n;y++){const g=r+y/n*s;f.x=h*Math.cos(g),f.y=h*Math.sin(g),a.push(f.x,f.y,f.z),c.push(0,0,1),d.x=(f.x/e+1)/2,d.y=(f.y/e+1)/2,l.push(d.x,d.y)}h+=u}for(let p=0;p<i;p++){const y=p*(n+1);for(let g=0;g<n;g++){const m=g+y,x=m,v=m+n+1,b=m+n+2,_=m+1;o.push(x,v,_),o.push(v,b,_)}}this.setIndex(o),this.setAttribute("position",new qe(a,3)),this.setAttribute("normal",new qe(c,3)),this.setAttribute("uv",new qe(l,2))}Mc.prototype=Object.create(We.prototype);Mc.prototype.constructor=Mc;function Zh(t,e,n,i){rt.call(this),this.type="LatheGeometry",this.parameters={points:t,segments:e,phiStart:n,phiLength:i},this.fromBufferGeometry(new Ac(t,e,n,i)),this.mergeVertices()}Zh.prototype=Object.create(rt.prototype);Zh.prototype.constructor=Zh;function Ac(t,e,n,i){We.call(this),this.type="LatheBufferGeometry",this.parameters={points:t,segments:e,phiStart:n,phiLength:i},e=Math.floor(e)||12,n=n||0,i=i||Math.PI*2,i=ut.clamp(i,0,Math.PI*2);const r=[],s=[],o=[],a=1/e,c=new T,l=new Te;for(let h=0;h<=e;h++){const u=n+h*a*i,f=Math.sin(u),d=Math.cos(u);for(let p=0;p<=t.length-1;p++)c.x=t[p].x*f,c.y=t[p].y,c.z=t[p].x*d,s.push(c.x,c.y,c.z),l.x=h/e,l.y=p/(t.length-1),o.push(l.x,l.y)}for(let h=0;h<e;h++)for(let u=0;u<t.length-1;u++){const f=u+h*t.length,d=f,p=f+t.length,y=f+t.length+1,g=f+1;r.push(d,p,g),r.push(p,y,g)}if(this.setIndex(r),this.setAttribute("position",new qe(s,3)),this.setAttribute("uv",new qe(o,2)),this.computeVertexNormals(),i===Math.PI*2){const h=this.attributes.normal.array,u=new T,f=new T,d=new T,p=e*t.length*3;for(let y=0,g=0;y<t.length;y++,g+=3)u.x=h[g+0],u.y=h[g+1],u.z=h[g+2],f.x=h[p+g+0],f.y=h[p+g+1],f.z=h[p+g+2],d.addVectors(u,f).normalize(),h[g+0]=h[p+g+0]=d.x,h[g+1]=h[p+g+1]=d.y,h[g+2]=h[p+g+2]=d.z}}Ac.prototype=Object.create(We.prototype);Ac.prototype.constructor=Ac;function Ro(t,e){rt.call(this),this.type="ShapeGeometry",typeof e=="object"&&(console.warn("THREE.ShapeGeometry: Options parameter has been removed."),e=e.curveSegments),this.parameters={shapes:t,curveSegments:e},this.fromBufferGeometry(new Do(t,e)),this.mergeVertices()}Ro.prototype=Object.create(rt.prototype);Ro.prototype.constructor=Ro;Ro.prototype.toJSON=function(){const t=rt.prototype.toJSON.call(this),e=this.parameters.shapes;return ix(e,t)};function Do(t,e){We.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:t,curveSegments:e},e=e||12;const n=[],i=[],r=[],s=[];let o=0,a=0;if(Array.isArray(t)===!1)c(t);else for(let l=0;l<t.length;l++)c(t[l]),this.addGroup(o,a,l),o+=a,a=0;this.setIndex(n),this.setAttribute("position",new qe(i,3)),this.setAttribute("normal",new qe(r,3)),this.setAttribute("uv",new qe(s,2));function c(l){const h=i.length/3,u=l.extractPoints(e);let f=u.shape;const d=u.holes;kr.isClockWise(f)===!1&&(f=f.reverse());for(let y=0,g=d.length;y<g;y++){const m=d[y];kr.isClockWise(m)===!0&&(d[y]=m.reverse())}const p=kr.triangulateShape(f,d);for(let y=0,g=d.length;y<g;y++){const m=d[y];f=f.concat(m)}for(let y=0,g=f.length;y<g;y++){const m=f[y];i.push(m.x,m.y,0),r.push(0,0,1),s.push(m.x,m.y)}for(let y=0,g=p.length;y<g;y++){const m=p[y],x=m[0]+h,v=m[1]+h,b=m[2]+h;n.push(x,v,b),a+=3}}}Do.prototype=Object.create(We.prototype);Do.prototype.constructor=Do;Do.prototype.toJSON=function(){const t=We.prototype.toJSON.call(this),e=this.parameters.shapes;return ix(e,t)};function ix(t,e){if(e.shapes=[],Array.isArray(t))for(let n=0,i=t.length;n<i;n++){const r=t[n];e.shapes.push(r.uuid)}else e.shapes.push(t.uuid);return e}function Kh(t,e){We.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:e},e=e!==void 0?e:1;const n=[],i=Math.cos(ut.DEG2RAD*e),r=[0,0],s={};let o,a,c;const l=["a","b","c"];let h;t.isBufferGeometry?(h=new rt,h.fromBufferGeometry(t)):h=t.clone(),h.mergeVertices(),h.computeFaceNormals();const u=h.vertices,f=h.faces;for(let d=0,p=f.length;d<p;d++){const y=f[d];for(let g=0;g<3;g++)o=y[l[g]],a=y[l[(g+1)%3]],r[0]=Math.min(o,a),r[1]=Math.max(o,a),c=r[0]+","+r[1],s[c]===void 0?s[c]={index1:r[0],index2:r[1],face1:d,face2:void 0}:s[c].face2=d}for(c in s){const d=s[c];if(d.face2===void 0||f[d.face1].normal.dot(f[d.face2].normal)<=i){let p=u[d.index1];n.push(p.x,p.y,p.z),p=u[d.index2],n.push(p.x,p.y,p.z)}}this.setAttribute("position",new qe(n,3))}Kh.prototype=Object.create(We.prototype);Kh.prototype.constructor=Kh;function Bo(t,e,n,i,r,s,o,a){rt.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:n,radialSegments:i,heightSegments:r,openEnded:s,thetaStart:o,thetaLength:a},this.fromBufferGeometry(new hr(t,e,n,i,r,s,o,a)),this.mergeVertices()}Bo.prototype=Object.create(rt.prototype);Bo.prototype.constructor=Bo;function hr(t,e,n,i,r,s,o,a){We.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:n,radialSegments:i,heightSegments:r,openEnded:s,thetaStart:o,thetaLength:a};const c=this;t=t!==void 0?t:1,e=e!==void 0?e:1,n=n||1,i=Math.floor(i)||8,r=Math.floor(r)||1,s=s!==void 0?s:!1,o=o!==void 0?o:0,a=a!==void 0?a:Math.PI*2;const l=[],h=[],u=[],f=[];let d=0;const p=[],y=n/2;let g=0;m(),s===!1&&(t>0&&x(!0),e>0&&x(!1)),this.setIndex(l),this.setAttribute("position",new qe(h,3)),this.setAttribute("normal",new qe(u,3)),this.setAttribute("uv",new qe(f,2));function m(){const v=new T,b=new T;let _=0;const C=(e-t)/n;for(let w=0;w<=r;w++){const S=[],M=w/r,B=M*(e-t)+t;for(let L=0;L<=i;L++){const U=L/i,E=U*a+o,O=Math.sin(E),k=Math.cos(E);b.x=B*O,b.y=-M*n+y,b.z=B*k,h.push(b.x,b.y,b.z),v.set(O,C,k).normalize(),u.push(v.x,v.y,v.z),f.push(U,1-M),S.push(d++)}p.push(S)}for(let w=0;w<i;w++)for(let S=0;S<r;S++){const M=p[S][w],B=p[S+1][w],L=p[S+1][w+1],U=p[S][w+1];l.push(M,B,U),l.push(B,L,U),_+=6}c.addGroup(g,_,0),g+=_}function x(v){let b,_;const C=new Te,w=new T;let S=0;const M=v===!0?t:e,B=v===!0?1:-1;b=d;for(let L=1;L<=i;L++)h.push(0,y*B,0),u.push(0,B,0),f.push(.5,.5),d++;_=d;for(let L=0;L<=i;L++){const E=L/i*a+o,O=Math.cos(E),k=Math.sin(E);w.x=M*k,w.y=y*B,w.z=M*O,h.push(w.x,w.y,w.z),u.push(0,B,0),C.x=O*.5+.5,C.y=k*.5*B+.5,f.push(C.x,C.y),d++}for(let L=0;L<i;L++){const U=b+L,E=_+L;v===!0?l.push(E,E+1,U):l.push(E+1,E,U),S+=3}c.addGroup(g,S,v===!0?1:2),g+=S}}hr.prototype=Object.create(We.prototype);hr.prototype.constructor=hr;function Jh(t,e,n,i,r,s,o){Bo.call(this,0,t,e,n,i,r,s,o),this.type="ConeGeometry",this.parameters={radius:t,height:e,radialSegments:n,heightSegments:i,openEnded:r,thetaStart:s,thetaLength:o}}Jh.prototype=Object.create(Bo.prototype);Jh.prototype.constructor=Jh;function Cc(t,e,n,i,r,s,o){hr.call(this,0,t,e,n,i,r,s,o),this.type="ConeBufferGeometry",this.parameters={radius:t,height:e,radialSegments:n,heightSegments:i,openEnded:r,thetaStart:s,thetaLength:o}}Cc.prototype=Object.create(hr.prototype);Cc.prototype.constructor=Cc;function Qh(t,e,n,i){rt.call(this),this.type="CircleGeometry",this.parameters={radius:t,segments:e,thetaStart:n,thetaLength:i},this.fromBufferGeometry(new Tc(t,e,n,i)),this.mergeVertices()}Qh.prototype=Object.create(rt.prototype);Qh.prototype.constructor=Qh;function Tc(t,e,n,i){We.call(this),this.type="CircleBufferGeometry",this.parameters={radius:t,segments:e,thetaStart:n,thetaLength:i},t=t||1,e=e!==void 0?Math.max(3,e):8,n=n!==void 0?n:0,i=i!==void 0?i:Math.PI*2;const r=[],s=[],o=[],a=[],c=new T,l=new Te;s.push(0,0,0),o.push(0,0,1),a.push(.5,.5);for(let h=0,u=3;h<=e;h++,u+=3){const f=n+h/e*i;c.x=t*Math.cos(f),c.y=t*Math.sin(f),s.push(c.x,c.y,c.z),o.push(0,0,1),l.x=(s[u]/t+1)/2,l.y=(s[u+1]/t+1)/2,a.push(l.x,l.y)}for(let h=1;h<=e;h++)r.push(h,h+1,0);this.setIndex(r),this.setAttribute("position",new qe(s,3)),this.setAttribute("normal",new qe(o,3)),this.setAttribute("uv",new qe(a,2))}Tc.prototype=Object.create(We.prototype);Tc.prototype.constructor=Tc;var In=Object.freeze({__proto__:null,WireframeGeometry:Fh,ParametricGeometry:Nh,ParametricBufferGeometry:yc,TetrahedronGeometry:Gh,TetrahedronBufferGeometry:To,OctahedronGeometry:Uh,OctahedronBufferGeometry:Ss,IcosahedronGeometry:Vh,IcosahedronBufferGeometry:Ms,DodecahedronGeometry:Hh,DodecahedronBufferGeometry:xc,PolyhedronGeometry:zh,PolyhedronBufferGeometry:Xn,TubeGeometry:$h,TubeBufferGeometry:Po,TorusKnotGeometry:Wh,TorusKnotBufferGeometry:bc,TorusGeometry:jh,TorusBufferGeometry:Eo,TextGeometry:qh,TextBufferGeometry:Sc,SphereGeometry:Xh,SphereBufferGeometry:Lo,RingGeometry:Yh,RingBufferGeometry:Mc,PlaneGeometry:uc,PlaneBufferGeometry:Co,LatheGeometry:Zh,LatheBufferGeometry:Ac,ShapeGeometry:Ro,ShapeBufferGeometry:Do,ExtrudeGeometry:Io,ExtrudeBufferGeometry:lr,EdgesGeometry:Kh,ConeGeometry:Jh,ConeBufferGeometry:Cc,CylinderGeometry:Bo,CylinderBufferGeometry:hr,CircleGeometry:Qh,CircleBufferGeometry:Tc,BoxGeometry:j_,BoxBufferGeometry:Yc});function Oo(t){at.call(this),this.type="ShadowMaterial",this.color=new ke(0),this.transparent=!0,this.setValues(t)}Oo.prototype=Object.create(at.prototype);Oo.prototype.constructor=Oo;Oo.prototype.isShadowMaterial=!0;Oo.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.color.copy(t.color),this};function $r(t){bn.call(this,t),this.type="RawShaderMaterial"}$r.prototype=Object.create(bn.prototype);$r.prototype.constructor=$r;$r.prototype.isRawShaderMaterial=!0;function ur(t){at.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new ke(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ke(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Zo,this.normalScale=new Te(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.vertexTangents=!1,this.setValues(t)}ur.prototype=Object.create(at.prototype);ur.prototype.constructor=ur;ur.prototype.isMeshStandardMaterial=!0;ur.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapIntensity=t.envMapIntensity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this.vertexTangents=t.vertexTangents,this};function ko(t){ur.call(this),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoat=0,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new Te(1,1),this.clearcoatNormalMap=null,this.reflectivity=.5,this.sheen=null,this.transparency=0,this.setValues(t)}ko.prototype=Object.create(ur.prototype);ko.prototype.constructor=ko;ko.prototype.isMeshPhysicalMaterial=!0;ko.prototype.copy=function(t){return ur.prototype.copy.call(this,t),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=t.clearcoat,this.clearcoatMap=t.clearcoatMap,this.clearcoatRoughness=t.clearcoatRoughness,this.clearcoatRoughnessMap=t.clearcoatRoughnessMap,this.clearcoatNormalMap=t.clearcoatNormalMap,this.clearcoatNormalScale.copy(t.clearcoatNormalScale),this.reflectivity=t.reflectivity,t.sheen?this.sheen=(this.sheen||new ke).copy(t.sheen):this.sheen=null,this.transparency=t.transparency,this};function As(t){at.call(this),this.type="MeshPhongMaterial",this.color=new ke(16777215),this.specular=new ke(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ke(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Zo,this.normalScale=new Te(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Au,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}As.prototype=Object.create(at.prototype);As.prototype.constructor=As;As.prototype.isMeshPhongMaterial=!0;As.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this};function Fo(t){at.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new ke(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ke(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Zo,this.normalScale=new Te(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}Fo.prototype=Object.create(at.prototype);Fo.prototype.constructor=Fo;Fo.prototype.isMeshToonMaterial=!0;Fo.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.gradientMap=t.gradientMap,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this};function No(t){at.call(this),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Zo,this.normalScale=new Te(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}No.prototype=Object.create(at.prototype);No.prototype.constructor=No;No.prototype.isMeshNormalMaterial=!0;No.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this};function zo(t){at.call(this),this.type="MeshLambertMaterial",this.color=new ke(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ke(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Au,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}zo.prototype=Object.create(at.prototype);zo.prototype.constructor=zo;zo.prototype.isMeshLambertMaterial=!0;zo.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this};function Go(t){at.call(this),this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new ke(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Zo,this.normalScale=new Te(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}Go.prototype=Object.create(at.prototype);Go.prototype.constructor=Go;Go.prototype.isMeshMatcapMaterial=!0;Go.prototype.copy=function(t){return at.prototype.copy.call(this,t),this.defines={MATCAP:""},this.color.copy(t.color),this.matcap=t.matcap,this.map=t.map,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this};function Uo(t){dn.call(this),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(t)}Uo.prototype=Object.create(dn.prototype);Uo.prototype.constructor=Uo;Uo.prototype.isLineDashedMaterial=!0;Uo.prototype.copy=function(t){return dn.prototype.copy.call(this,t),this.scale=t.scale,this.dashSize=t.dashSize,this.gapSize=t.gapSize,this};var cM=Object.freeze({__proto__:null,ShadowMaterial:Oo,SpriteMaterial:_s,RawShaderMaterial:$r,ShaderMaterial:bn,PointsMaterial:ws,MeshPhysicalMaterial:ko,MeshStandardMaterial:ur,MeshPhongMaterial:As,MeshToonMaterial:Fo,MeshNormalMaterial:No,MeshLambertMaterial:zo,MeshDepthMaterial:xs,MeshDistanceMaterial:bs,MeshBasicMaterial:_i,MeshMatcapMaterial:Go,LineDashedMaterial:Uo,LineBasicMaterial:dn,Material:at});const tn={arraySlice:function(t,e,n){return tn.isTypedArray(t)?new t.constructor(t.subarray(e,n!==void 0?n:t.length)):t.slice(e,n)},convertArray:function(t,e,n){return!t||!n&&t.constructor===e?t:typeof e.BYTES_PER_ELEMENT=="number"?new e(t):Array.prototype.slice.call(t)},isTypedArray:function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},getKeyframeOrder:function(t){function e(r,s){return t[r]-t[s]}const n=t.length,i=new Array(n);for(let r=0;r!==n;++r)i[r]=r;return i.sort(e),i},sortedArray:function(t,e,n){const i=t.length,r=new t.constructor(i);for(let s=0,o=0;o!==i;++s){const a=n[s]*e;for(let c=0;c!==e;++c)r[o++]=t[a+c]}return r},flattenJSON:function(t,e,n,i){let r=1,s=t[0];for(;s!==void 0&&s[i]===void 0;)s=t[r++];if(s===void 0)return;let o=s[i];if(o!==void 0)if(Array.isArray(o))do o=s[i],o!==void 0&&(e.push(s.time),n.push.apply(n,o)),s=t[r++];while(s!==void 0);else if(o.toArray!==void 0)do o=s[i],o!==void 0&&(e.push(s.time),o.toArray(n,n.length)),s=t[r++];while(s!==void 0);else do o=s[i],o!==void 0&&(e.push(s.time),n.push(o)),s=t[r++];while(s!==void 0)},subclip:function(t,e,n,i,r){r=r||30;const s=t.clone();s.name=e;const o=[];for(let c=0;c<s.tracks.length;++c){const l=s.tracks[c],h=l.getValueSize(),u=[],f=[];for(let d=0;d<l.times.length;++d){const p=l.times[d]*r;if(!(p<n||p>=i)){u.push(l.times[d]);for(let y=0;y<h;++y)f.push(l.values[d*h+y])}}u.length!==0&&(l.times=tn.convertArray(u,l.times.constructor),l.values=tn.convertArray(f,l.values.constructor),o.push(l))}s.tracks=o;let a=1/0;for(let c=0;c<s.tracks.length;++c)a>s.tracks[c].times[0]&&(a=s.tracks[c].times[0]);for(let c=0;c<s.tracks.length;++c)s.tracks[c].shift(-1*a);return s.resetDuration(),s},makeClipAdditive:function(t,e,n,i){e===void 0&&(e=0),n===void 0&&(n=t),(i===void 0||i<=0)&&(i=30);const r=t.tracks.length,s=e/i;for(let o=0;o<r;++o){const a=n.tracks[o],c=a.ValueTypeName;if(c==="bool"||c==="string")continue;const l=t.tracks.find(function(p){return p.name===a.name&&p.ValueTypeName===c});if(l===void 0)continue;const h=a.getValueSize(),u=a.times.length-1;let f;if(s<=a.times[0])f=tn.arraySlice(a.values,0,a.valueSize);else if(s>=a.times[u]){const p=u*h;f=tn.arraySlice(a.values,p)}else{const p=a.createInterpolant();p.evaluate(s),f=p.resultBuffer}c==="quaternion"&&new Gt(f[0],f[1],f[2],f[3]).normalize().conjugate().toArray(f);const d=l.times.length;for(let p=0;p<d;++p){const y=p*h;if(c==="quaternion")Gt.multiplyQuaternionsFlat(l.values,y,f,0,l.values,y);else for(let g=0;g<h;++g)l.values[y+g]-=f[g]}}return t.blendMode=By,t}};function oi(t,e,n,i){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=i!==void 0?i:new e.constructor(n),this.sampleValues=e,this.valueSize=n}Object.assign(oi.prototype,{evaluate:function(t){let e=this.parameterPositions,n=this._cachedIndex,i=e[n],r=e[n-1];e:{t:{let s;n:{i:if(!(t<i)){for(let o=n+2;;){if(i===void 0){if(t<r)break i;return n=e.length,this._cachedIndex=n,this.afterEnd_(n-1,t,r)}if(n===o)break;if(r=i,i=e[++n],t<i)break t}s=e.length;break n}if(!(t>=r)){const o=e[1];t<o&&(n=2,r=o);for(let a=n-2;;){if(r===void 0)return this._cachedIndex=0,this.beforeStart_(0,t,i);if(n===a)break;if(i=r,r=e[--n-1],t>=r)break t}s=n,n=0;break n}break e}for(;n<s;){const o=n+s>>>1;t<e[o]?s=o:n=o+1}if(i=e[n],r=e[n-1],r===void 0)return this._cachedIndex=0,this.beforeStart_(0,t,i);if(i===void 0)return n=e.length,this._cachedIndex=n,this.afterEnd_(n-1,r,t)}this._cachedIndex=n,this.intervalChanged_(n,r,i)}return this.interpolate_(n,r,t,i)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(t){const e=this.resultBuffer,n=this.sampleValues,i=this.valueSize,r=t*i;for(let s=0;s!==i;++s)e[s]=n[r+s];return e},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}});Object.assign(oi.prototype,{beforeStart_:oi.prototype.copySampleValue_,afterEnd_:oi.prototype.copySampleValue_});function Jf(t,e,n,i){oi.call(this,t,e,n,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}Jf.prototype=Object.assign(Object.create(oi.prototype),{constructor:Jf,DefaultSettings_:{endingStart:So,endingEnd:So},intervalChanged_:function(t,e,n){let i=this.parameterPositions,r=t-2,s=t+1,o=i[r],a=i[s];if(o===void 0)switch(this.getSettings_().endingStart){case co:r=t,o=2*e-n;break;case Rh:r=i.length-2,o=e+i[r]-i[r+1];break;default:r=t,o=n}if(a===void 0)switch(this.getSettings_().endingEnd){case co:s=t,a=2*n-e;break;case Rh:s=1,a=n+i[1]-i[0];break;default:s=t-1,a=e}const c=(n-e)*.5,l=this.valueSize;this._weightPrev=c/(e-o),this._weightNext=c/(a-n),this._offsetPrev=r*l,this._offsetNext=s*l},interpolate_:function(t,e,n,i){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=t*o,c=a-o,l=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,f=this._weightNext,d=(n-e)/(i-e),p=d*d,y=p*d,g=-u*y+2*u*p-u*d,m=(1+u)*y+(-1.5-2*u)*p+(-.5+u)*d+1,x=(-1-f)*y+(1.5+f)*p+.5*d,v=f*y-f*p;for(let b=0;b!==o;++b)r[b]=g*s[l+b]+m*s[c+b]+x*s[a+b]+v*s[h+b];return r}});function eu(t,e,n,i){oi.call(this,t,e,n,i)}eu.prototype=Object.assign(Object.create(oi.prototype),{constructor:eu,interpolate_:function(t,e,n,i){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=t*o,c=a-o,l=(n-e)/(i-e),h=1-l;for(let u=0;u!==o;++u)r[u]=s[c+u]*h+s[a+u]*l;return r}});function Qf(t,e,n,i){oi.call(this,t,e,n,i)}Qf.prototype=Object.assign(Object.create(oi.prototype),{constructor:Qf,interpolate_:function(t){return this.copySampleValue_(t-1)}});function En(t,e,n,i){if(t===void 0)throw new Error("THREE.KeyframeTrack: track name is undefined");if(e===void 0||e.length===0)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=tn.convertArray(e,this.TimeBufferType),this.values=tn.convertArray(n,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation)}Object.assign(En,{toJSON:function(t){const e=t.constructor;let n;if(e.toJSON!==void 0)n=e.toJSON(t);else{n={name:t.name,times:tn.convertArray(t.times,Array),values:tn.convertArray(t.values,Array)};const i=t.getInterpolation();i!==t.DefaultInterpolation&&(n.interpolation=i)}return n.type=t.ValueTypeName,n}});Object.assign(En.prototype,{constructor:En,TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:mh,InterpolantFactoryMethodDiscrete:function(t){return new Qf(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodLinear:function(t){return new eu(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:function(t){return new Jf(this.times,this.values,this.getValueSize(),t)},setInterpolation:function(t){let e;switch(t){case Lh:e=this.InterpolantFactoryMethodDiscrete;break;case mh:e=this.InterpolantFactoryMethodLinear;break;case Yu:e=this.InterpolantFactoryMethodSmooth;break}if(e===void 0){const n="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(this.createInterpolant===void 0)if(t!==this.DefaultInterpolation)this.setInterpolation(this.DefaultInterpolation);else throw new Error(n);return console.warn("THREE.KeyframeTrack:",n),this}return this.createInterpolant=e,this},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return Lh;case this.InterpolantFactoryMethodLinear:return mh;case this.InterpolantFactoryMethodSmooth:return Yu}},getValueSize:function(){return this.values.length/this.times.length},shift:function(t){if(t!==0){const e=this.times;for(let n=0,i=e.length;n!==i;++n)e[n]+=t}return this},scale:function(t){if(t!==1){const e=this.times;for(let n=0,i=e.length;n!==i;++n)e[n]*=t}return this},trim:function(t,e){const n=this.times,i=n.length;let r=0,s=i-1;for(;r!==i&&n[r]<t;)++r;for(;s!==-1&&n[s]>e;)--s;if(++s,r!==0||s!==i){r>=s&&(s=Math.max(s,1),r=s-1);const o=this.getValueSize();this.times=tn.arraySlice(n,r,s),this.values=tn.arraySlice(this.values,r*o,s*o)}return this},validate:function(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!==0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),t=!1);const n=this.times,i=this.values,r=n.length;r===0&&(console.error("THREE.KeyframeTrack: Track is empty.",this),t=!1);let s=null;for(let o=0;o!==r;o++){const a=n[o];if(typeof a=="number"&&isNaN(a)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,o,a),t=!1;break}if(s!==null&&s>a){console.error("THREE.KeyframeTrack: Out of order keys.",this,o,a,s),t=!1;break}s=a}if(i!==void 0&&tn.isTypedArray(i))for(let o=0,a=i.length;o!==a;++o){const c=i[o];if(isNaN(c)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,o,c),t=!1;break}}return t},optimize:function(){const t=tn.arraySlice(this.times),e=tn.arraySlice(this.values),n=this.getValueSize(),i=this.getInterpolation()===Yu,r=t.length-1;let s=1;for(let o=1;o<r;++o){let a=!1;const c=t[o],l=t[o+1];if(c!==l&&(o!==1||c!==c[0]))if(i)a=!0;else{const h=o*n,u=h-n,f=h+n;for(let d=0;d!==n;++d){const p=e[h+d];if(p!==e[u+d]||p!==e[f+d]){a=!0;break}}}if(a){if(o!==s){t[s]=t[o];const h=o*n,u=s*n;for(let f=0;f!==n;++f)e[u+f]=e[h+f]}++s}}if(r>0){t[s]=t[r];for(let o=r*n,a=s*n,c=0;c!==n;++c)e[a+c]=e[o+c];++s}return s!==t.length?(this.times=tn.arraySlice(t,0,s),this.values=tn.arraySlice(e,0,s*n)):(this.times=t,this.values=e),this},clone:function(){const t=tn.arraySlice(this.times,0),e=tn.arraySlice(this.values,0),n=this.constructor,i=new n(this.name,t,e);return i.createInterpolant=this.createInterpolant,i}});function ep(t,e,n){En.call(this,t,e,n)}ep.prototype=Object.assign(Object.create(En.prototype),{constructor:ep,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:Lh,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0});function tp(t,e,n,i){En.call(this,t,e,n,i)}tp.prototype=Object.assign(Object.create(En.prototype),{constructor:tp,ValueTypeName:"color"});function Pc(t,e,n,i){En.call(this,t,e,n,i)}Pc.prototype=Object.assign(Object.create(En.prototype),{constructor:Pc,ValueTypeName:"number"});function np(t,e,n,i){oi.call(this,t,e,n,i)}np.prototype=Object.assign(Object.create(oi.prototype),{constructor:np,interpolate_:function(t,e,n,i){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=(n-e)/(i-e);let c=t*o;for(let l=c+o;c!==l;c+=4)Gt.slerpFlat(r,0,s,c-o,s,c,a);return r}});function tu(t,e,n,i){En.call(this,t,e,n,i)}tu.prototype=Object.assign(Object.create(En.prototype),{constructor:tu,ValueTypeName:"quaternion",DefaultInterpolation:mh,InterpolantFactoryMethodLinear:function(t){return new np(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:void 0});function ip(t,e,n,i){En.call(this,t,e,n,i)}ip.prototype=Object.assign(Object.create(En.prototype),{constructor:ip,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:Lh,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0});function Ec(t,e,n,i){En.call(this,t,e,n,i)}Ec.prototype=Object.assign(Object.create(En.prototype),{constructor:Ec,ValueTypeName:"vector"});function xi(t,e,n,i){this.name=t,this.tracks=n,this.duration=e!==void 0?e:-1,this.blendMode=i!==void 0?i:Kp,this.uuid=ut.generateUUID(),this.duration<0&&this.resetDuration()}function lM(t){switch(t.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Pc;case"vector":case"vector2":case"vector3":case"vector4":return Ec;case"color":return tp;case"quaternion":return tu;case"bool":case"boolean":return ep;case"string":return ip}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+t)}function hM(t){if(t.type===void 0)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const e=lM(t.type);if(t.times===void 0){const n=[],i=[];tn.flattenJSON(t.keys,n,i,"value"),t.times=n,t.values=i}return e.parse!==void 0?e.parse(t):new e(t.name,t.times,t.values,t.interpolation)}Object.assign(xi,{parse:function(t){const e=[],n=t.tracks,i=1/(t.fps||1);for(let r=0,s=n.length;r!==s;++r)e.push(hM(n[r]).scale(i));return new xi(t.name,t.duration,e,t.blendMode)},toJSON:function(t){const e=[],n=t.tracks,i={name:t.name,duration:t.duration,tracks:e,uuid:t.uuid,blendMode:t.blendMode};for(let r=0,s=n.length;r!==s;++r)e.push(En.toJSON(n[r]));return i},CreateFromMorphTargetSequence:function(t,e,n,i){const r=e.length,s=[];for(let o=0;o<r;o++){let a=[],c=[];a.push((o+r-1)%r,o,(o+1)%r),c.push(0,1,0);const l=tn.getKeyframeOrder(a);a=tn.sortedArray(a,1,l),c=tn.sortedArray(c,1,l),!i&&a[0]===0&&(a.push(r),c.push(c[0])),s.push(new Pc(".morphTargetInfluences["+e[o].name+"]",a,c).scale(1/n))}return new xi(t,-1,s)},findByName:function(t,e){let n=t;if(!Array.isArray(t)){const i=t;n=i.geometry&&i.geometry.animations||i.animations}for(let i=0;i<n.length;i++)if(n[i].name===e)return n[i];return null},CreateClipsFromMorphTargetSequences:function(t,e,n){const i={},r=/^([\w-]*?)([\d]+)$/;for(let o=0,a=t.length;o<a;o++){const c=t[o],l=c.name.match(r);if(l&&l.length>1){const h=l[1];let u=i[h];u||(i[h]=u=[]),u.push(c)}}const s=[];for(const o in i)s.push(xi.CreateFromMorphTargetSequence(o,i[o],e,n));return s},parseAnimation:function(t,e){if(!t)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const n=function(h,u,f,d,p){if(f.length!==0){const y=[],g=[];tn.flattenJSON(f,y,g,d),y.length!==0&&p.push(new h(u,y,g))}},i=[],r=t.name||"default",s=t.fps||30,o=t.blendMode;let a=t.length||-1;const c=t.hierarchy||[];for(let h=0;h<c.length;h++){const u=c[h].keys;if(!(!u||u.length===0))if(u[0].morphTargets){const f={};let d;for(d=0;d<u.length;d++)if(u[d].morphTargets)for(let p=0;p<u[d].morphTargets.length;p++)f[u[d].morphTargets[p]]=-1;for(const p in f){const y=[],g=[];for(let m=0;m!==u[d].morphTargets.length;++m){const x=u[d];y.push(x.time),g.push(x.morphTarget===p?1:0)}i.push(new Pc(".morphTargetInfluence["+p+"]",y,g))}a=f.length*(s||1)}else{const f=".bones["+e[h].name+"]";n(Ec,f+".position",u,"pos",i),n(tu,f+".quaternion",u,"rot",i),n(Ec,f+".scale",u,"scl",i)}}return i.length===0?null:new xi(r,a,i,o)}});Object.assign(xi.prototype,{resetDuration:function(){const t=this.tracks;let e=0;for(let n=0,i=t.length;n!==i;++n){const r=this.tracks[n];e=Math.max(e,r.times[r.times.length-1])}return this.duration=e,this},trim:function(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].trim(0,this.duration);return this},validate:function(){let t=!0;for(let e=0;e<this.tracks.length;e++)t=t&&this.tracks[e].validate();return t},optimize:function(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].optimize();return this},clone:function(){const t=[];for(let e=0;e<this.tracks.length;e++)t.push(this.tracks[e].clone());return new xi(this.name,this.duration,t,this.blendMode)}});const Vo={enabled:!1,files:{},add:function(t,e){this.enabled!==!1&&(this.files[t]=e)},get:function(t){if(this.enabled!==!1)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};function rx(t,e,n){const i=this;let r=!1,s=0,o=0,a;const c=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=n,this.itemStart=function(l){o++,r===!1&&i.onStart!==void 0&&i.onStart(l,s,o),r=!0},this.itemEnd=function(l){s++,i.onProgress!==void 0&&i.onProgress(l,s,o),s===o&&(r=!1,i.onLoad!==void 0&&i.onLoad())},this.itemError=function(l){i.onError!==void 0&&i.onError(l)},this.resolveURL=function(l){return a?a(l):l},this.setURLModifier=function(l){return a=l,this},this.addHandler=function(l,h){return c.push(l,h),this},this.removeHandler=function(l){const h=c.indexOf(l);return h!==-1&&c.splice(h,2),this},this.getHandler=function(l){for(let h=0,u=c.length;h<u;h+=2){const f=c[h],d=c[h+1];if(f.global&&(f.lastIndex=0),f.test(l))return d}return null}}const uM=new rx;function Nt(t){this.manager=t!==void 0?t:uM,this.crossOrigin="anonymous",this.path="",this.resourcePath="",this.requestHeader={}}Object.assign(Nt.prototype,{load:function(){},loadAsync:function(t,e){const n=this;return new Promise(function(i,r){n.load(t,i,e,r)})},parse:function(){},setCrossOrigin:function(t){return this.crossOrigin=t,this},setPath:function(t){return this.path=t,this},setResourcePath:function(t){return this.resourcePath=t,this},setRequestHeader:function(t){return this.requestHeader=t,this}});const di={};function zi(t){Nt.call(this,t)}zi.prototype=Object.assign(Object.create(Nt.prototype),{constructor:zi,load:function(t,e,n,i){t===void 0&&(t=""),this.path!==void 0&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=Vo.get(t);if(s!==void 0)return r.manager.itemStart(t),setTimeout(function(){e&&e(s),r.manager.itemEnd(t)},0),s;if(di[t]!==void 0){di[t].push({onLoad:e,onProgress:n,onError:i});return}const o=/^data:(.*?)(;base64)?,(.*)$/,a=t.match(o);let c;if(a){const l=a[1],h=!!a[2];let u=a[3];u=decodeURIComponent(u),h&&(u=atob(u));try{let f;const d=(this.responseType||"").toLowerCase();switch(d){case"arraybuffer":case"blob":const p=new Uint8Array(u.length);for(let g=0;g<u.length;g++)p[g]=u.charCodeAt(g);d==="blob"?f=new Blob([p.buffer],{type:l}):f=p.buffer;break;case"document":f=new DOMParser().parseFromString(u,l);break;case"json":f=JSON.parse(u);break;default:f=u;break}setTimeout(function(){e&&e(f),r.manager.itemEnd(t)},0)}catch(f){setTimeout(function(){i&&i(f),r.manager.itemError(t),r.manager.itemEnd(t)},0)}}else{di[t]=[],di[t].push({onLoad:e,onProgress:n,onError:i}),c=new XMLHttpRequest,c.open("GET",t,!0),c.addEventListener("load",function(l){const h=this.response,u=di[t];if(delete di[t],this.status===200||this.status===0){this.status===0&&console.warn("THREE.FileLoader: HTTP Status 0 received."),Vo.add(t,h);for(let f=0,d=u.length;f<d;f++){const p=u[f];p.onLoad&&p.onLoad(h)}r.manager.itemEnd(t)}else{for(let f=0,d=u.length;f<d;f++){const p=u[f];p.onError&&p.onError(l)}r.manager.itemError(t),r.manager.itemEnd(t)}},!1),c.addEventListener("progress",function(l){const h=di[t];for(let u=0,f=h.length;u<f;u++){const d=h[u];d.onProgress&&d.onProgress(l)}},!1),c.addEventListener("error",function(l){const h=di[t];delete di[t];for(let u=0,f=h.length;u<f;u++){const d=h[u];d.onError&&d.onError(l)}r.manager.itemError(t),r.manager.itemEnd(t)},!1),c.addEventListener("abort",function(l){const h=di[t];delete di[t];for(let u=0,f=h.length;u<f;u++){const d=h[u];d.onError&&d.onError(l)}r.manager.itemError(t),r.manager.itemEnd(t)},!1),this.responseType!==void 0&&(c.responseType=this.responseType),this.withCredentials!==void 0&&(c.withCredentials=this.withCredentials),c.overrideMimeType&&c.overrideMimeType(this.mimeType!==void 0?this.mimeType:"text/plain");for(const l in this.requestHeader)c.setRequestHeader(l,this.requestHeader[l]);c.send(null)}return r.manager.itemStart(t),c},setResponseType:function(t){return this.responseType=t,this},setWithCredentials:function(t){return this.withCredentials=t,this},setMimeType:function(t){return this.mimeType=t,this}});function Og(t){Nt.call(this,t)}Og.prototype=Object.assign(Object.create(Nt.prototype),{constructor:Og,load:function(t,e,n,i){const r=this,s=new zi(r.manager);s.setPath(r.path),s.load(t,function(o){try{e(r.parse(JSON.parse(o)))}catch(a){i?i(a):console.error(a),r.manager.itemError(t)}},n,i)},parse:function(t){const e=[];for(let n=0;n<t.length;n++){const i=xi.parse(t[n]);e.push(i)}return e}});function kg(t){Nt.call(this,t)}kg.prototype=Object.assign(Object.create(Nt.prototype),{constructor:kg,load:function(t,e,n,i){const r=this,s=[],o=new mc;o.image=s;const a=new zi(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer");let c=0;function l(h){a.load(t[h],function(u){const f=r.parse(u,!0);s[h]={width:f.width,height:f.height,format:f.format,mipmaps:f.mipmaps},c+=1,c===6&&(f.mipmapCount===1&&(o.minFilter=gn),o.format=f.format,o.needsUpdate=!0,e&&e(o))},n,i)}if(Array.isArray(t))for(let h=0,u=t.length;h<u;++h)l(h);else a.load(t,function(h){const u=r.parse(h,!0);if(u.isCubemap){const f=u.mipmaps.length/u.mipmapCount;for(let d=0;d<f;d++){s[d]={mipmaps:[]};for(let p=0;p<u.mipmapCount;p++)s[d].mipmaps.push(u.mipmaps[d*u.mipmapCount+p]),s[d].format=u.format,s[d].width=u.width,s[d].height=u.height}}else o.image.width=u.width,o.image.height=u.height,o.mipmaps=u.mipmaps;u.mipmapCount===1&&(o.minFilter=gn),o.format=u.format,o.needsUpdate=!0,e&&e(o)},n,i);return o}});function Fg(t){Nt.call(this,t)}Fg.prototype=Object.assign(Object.create(Nt.prototype),{constructor:Fg,load:function(t,e,n,i){const r=this,s=new cr,o=new zi(this.manager);return o.setResponseType("arraybuffer"),o.setPath(this.path),o.load(t,function(a){const c=r.parse(a);c&&(c.image!==void 0?s.image=c.image:c.data!==void 0&&(s.image.width=c.width,s.image.height=c.height,s.image.data=c.data),s.wrapS=c.wrapS!==void 0?c.wrapS:zn,s.wrapT=c.wrapT!==void 0?c.wrapT:zn,s.magFilter=c.magFilter!==void 0?c.magFilter:gn,s.minFilter=c.minFilter!==void 0?c.minFilter:gn,s.anisotropy=c.anisotropy!==void 0?c.anisotropy:1,c.format!==void 0&&(s.format=c.format),c.type!==void 0&&(s.type=c.type),c.mipmaps!==void 0&&(s.mipmaps=c.mipmaps,s.minFilter=Cu),c.mipmapCount===1&&(s.minFilter=gn),s.needsUpdate=!0,e&&e(s,c))},n,i),s}});function Ic(t){Nt.call(this,t)}Ic.prototype=Object.assign(Object.create(Nt.prototype),{constructor:Ic,load:function(t,e,n,i){this.path!==void 0&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=Vo.get(t);if(s!==void 0)return r.manager.itemStart(t),setTimeout(function(){e&&e(s),r.manager.itemEnd(t)},0),s;const o=document.createElementNS("http://www.w3.org/1999/xhtml","img");function a(){o.removeEventListener("load",a,!1),o.removeEventListener("error",c,!1),Vo.add(t,this),e&&e(this),r.manager.itemEnd(t)}function c(l){o.removeEventListener("load",a,!1),o.removeEventListener("error",c,!1),i&&i(l),r.manager.itemError(t),r.manager.itemEnd(t)}return o.addEventListener("load",a,!1),o.addEventListener("error",c,!1),t.substr(0,5)!=="data:"&&this.crossOrigin!==void 0&&(o.crossOrigin=this.crossOrigin),r.manager.itemStart(t),o.src=t,o}});function rp(t){Nt.call(this,t)}rp.prototype=Object.assign(Object.create(Nt.prototype),{constructor:rp,load:function(t,e,n,i){const r=new Vr,s=new Ic(this.manager);s.setCrossOrigin(this.crossOrigin),s.setPath(this.path);let o=0;function a(c){s.load(t[c],function(l){r.images[c]=l,o++,o===6&&(r.needsUpdate=!0,e&&e(r))},void 0,i)}for(let c=0;c<t.length;++c)a(c);return r}});function sp(t){Nt.call(this,t)}sp.prototype=Object.assign(Object.create(Nt.prototype),{constructor:sp,load:function(t,e,n,i){const r=new $t,s=new Ic(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(t,function(o){r.image=o;const a=t.search(/\.jpe?g($|\?)/i)>0||t.search(/^data\:image\/jpeg/)===0;r.format=a?us:Gn,r.needsUpdate=!0,e!==void 0&&e(r)},n,i),r}});function nt(){this.type="Curve",this.arcLengthDivisions=200}Object.assign(nt.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(t,e){const n=this.getUtoTmapping(t);return this.getPoint(n,e)},getPoints:function(t){t===void 0&&(t=5);const e=[];for(let n=0;n<=t;n++)e.push(this.getPoint(n/t));return e},getSpacedPoints:function(t){t===void 0&&(t=5);const e=[];for(let n=0;n<=t;n++)e.push(this.getPointAt(n/t));return e},getLength:function(){const t=this.getLengths();return t[t.length-1]},getLengths:function(t){if(t===void 0&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const e=[];let n,i=this.getPoint(0),r=0;e.push(0);for(let s=1;s<=t;s++)n=this.getPoint(s/t),r+=n.distanceTo(i),e.push(r),i=n;return this.cacheArcLengths=e,e},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(t,e){const n=this.getLengths();let i=0,r=n.length,s;e?s=e:s=t*n[r-1];let o=0,a=r-1,c;for(;o<=a;)if(i=Math.floor(o+(a-o)/2),c=n[i]-s,c<0)o=i+1;else if(c>0)a=i-1;else{a=i;break}if(i=a,n[i]===s)return i/(r-1);const l=n[i],u=n[i+1]-l,f=(s-l)/u;return(i+f)/(r-1)},getTangent:function(t,e){let i=t-1e-4,r=t+1e-4;i<0&&(i=0),r>1&&(r=1);const s=this.getPoint(i),o=this.getPoint(r),a=e||(s.isVector2?new Te:new T);return a.copy(o).sub(s).normalize(),a},getTangentAt:function(t,e){const n=this.getUtoTmapping(t);return this.getTangent(n,e)},computeFrenetFrames:function(t,e){const n=new T,i=[],r=[],s=[],o=new T,a=new Ie;for(let f=0;f<=t;f++){const d=f/t;i[f]=this.getTangentAt(d,new T),i[f].normalize()}r[0]=new T,s[0]=new T;let c=Number.MAX_VALUE;const l=Math.abs(i[0].x),h=Math.abs(i[0].y),u=Math.abs(i[0].z);l<=c&&(c=l,n.set(1,0,0)),h<=c&&(c=h,n.set(0,1,0)),u<=c&&n.set(0,0,1),o.crossVectors(i[0],n).normalize(),r[0].crossVectors(i[0],o),s[0].crossVectors(i[0],r[0]);for(let f=1;f<=t;f++){if(r[f]=r[f-1].clone(),s[f]=s[f-1].clone(),o.crossVectors(i[f-1],i[f]),o.length()>Number.EPSILON){o.normalize();const d=Math.acos(ut.clamp(i[f-1].dot(i[f]),-1,1));r[f].applyMatrix4(a.makeRotationAxis(o,d))}s[f].crossVectors(i[f],r[f])}if(e===!0){let f=Math.acos(ut.clamp(r[0].dot(r[t]),-1,1));f/=t,i[0].dot(o.crossVectors(r[0],r[t]))>0&&(f=-f);for(let d=1;d<=t;d++)r[d].applyMatrix4(a.makeRotationAxis(i[d],f*d)),s[d].crossVectors(i[d],r[d])}return{tangents:i,normals:r,binormals:s}},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this},toJSON:function(){const t={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t},fromJSON:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}});function li(t,e,n,i,r,s,o,a){nt.call(this),this.type="EllipseCurve",this.aX=t||0,this.aY=e||0,this.xRadius=n||1,this.yRadius=i||1,this.aStartAngle=r||0,this.aEndAngle=s||2*Math.PI,this.aClockwise=o||!1,this.aRotation=a||0}li.prototype=Object.create(nt.prototype);li.prototype.constructor=li;li.prototype.isEllipseCurve=!0;li.prototype.getPoint=function(t,e){const n=e||new Te,i=Math.PI*2;let r=this.aEndAngle-this.aStartAngle;const s=Math.abs(r)<Number.EPSILON;for(;r<0;)r+=i;for(;r>i;)r-=i;r<Number.EPSILON&&(s?r=0:r=i),this.aClockwise===!0&&!s&&(r===i?r=-i:r=r-i);const o=this.aStartAngle+t*r;let a=this.aX+this.xRadius*Math.cos(o),c=this.aY+this.yRadius*Math.sin(o);if(this.aRotation!==0){const l=Math.cos(this.aRotation),h=Math.sin(this.aRotation),u=a-this.aX,f=c-this.aY;a=u*l-f*h+this.aX,c=u*h+f*l+this.aY}return n.set(a,c)};li.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this};li.prototype.toJSON=function(){const t=nt.prototype.toJSON.call(this);return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t};li.prototype.fromJSON=function(t){return nt.prototype.fromJSON.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this};function Lc(t,e,n,i,r,s){li.call(this,t,e,n,n,i,r,s),this.type="ArcCurve"}Lc.prototype=Object.create(li.prototype);Lc.prototype.constructor=Lc;Lc.prototype.isArcCurve=!0;function tm(){let t=0,e=0,n=0,i=0;function r(s,o,a,c){t=s,e=a,n=-3*s+3*o-2*a-c,i=2*s-2*o+a+c}return{initCatmullRom:function(s,o,a,c,l){r(o,a,l*(a-s),l*(c-o))},initNonuniformCatmullRom:function(s,o,a,c,l,h,u){let f=(o-s)/l-(a-s)/(l+h)+(a-o)/h,d=(a-o)/h-(c-o)/(h+u)+(c-a)/u;f*=h,d*=h,r(o,a,f,d)},calc:function(s){const o=s*s,a=o*s;return t+e*s+n*o+i*a}}}const Ol=new T,vd=new tm,_d=new tm,wd=new tm;function Yn(t,e,n,i){nt.call(this),this.type="CatmullRomCurve3",this.points=t||[],this.closed=e||!1,this.curveType=n||"centripetal",this.tension=i||.5}Yn.prototype=Object.create(nt.prototype);Yn.prototype.constructor=Yn;Yn.prototype.isCatmullRomCurve3=!0;Yn.prototype.getPoint=function(t,e){const n=e||new T,i=this.points,r=i.length,s=(r-(this.closed?0:1))*t;let o=Math.floor(s),a=s-o;this.closed?o+=o>0?0:(Math.floor(Math.abs(o)/r)+1)*r:a===0&&o===r-1&&(o=r-2,a=1);let c,l,h,u;if(this.closed||o>0?c=i[(o-1)%r]:(Ol.subVectors(i[0],i[1]).add(i[0]),c=Ol),l=i[o%r],h=i[(o+1)%r],this.closed||o+2<r?u=i[(o+2)%r]:(Ol.subVectors(i[r-1],i[r-2]).add(i[r-1]),u=Ol),this.curveType==="centripetal"||this.curveType==="chordal"){const f=this.curveType==="chordal"?.5:.25;let d=Math.pow(c.distanceToSquared(l),f),p=Math.pow(l.distanceToSquared(h),f),y=Math.pow(h.distanceToSquared(u),f);p<1e-4&&(p=1),d<1e-4&&(d=p),y<1e-4&&(y=p),vd.initNonuniformCatmullRom(c.x,l.x,h.x,u.x,d,p,y),_d.initNonuniformCatmullRom(c.y,l.y,h.y,u.y,d,p,y),wd.initNonuniformCatmullRom(c.z,l.z,h.z,u.z,d,p,y)}else this.curveType==="catmullrom"&&(vd.initCatmullRom(c.x,l.x,h.x,u.x,this.tension),_d.initCatmullRom(c.y,l.y,h.y,u.y,this.tension),wd.initCatmullRom(c.z,l.z,h.z,u.z,this.tension));return n.set(vd.calc(a),_d.calc(a),wd.calc(a)),n};Yn.prototype.copy=function(t){nt.prototype.copy.call(this,t),this.points=[];for(let e=0,n=t.points.length;e<n;e++){const i=t.points[e];this.points.push(i.clone())}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this};Yn.prototype.toJSON=function(){const t=nt.prototype.toJSON.call(this);t.points=[];for(let e=0,n=this.points.length;e<n;e++){const i=this.points[e];t.points.push(i.toArray())}return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t};Yn.prototype.fromJSON=function(t){nt.prototype.fromJSON.call(this,t),this.points=[];for(let e=0,n=t.points.length;e<n;e++){const i=t.points[e];this.points.push(new T().fromArray(i))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this};function Ng(t,e,n,i,r){const s=(i-e)*.5,o=(r-n)*.5,a=t*t,c=t*a;return(2*n-2*i+s+o)*c+(-3*n+3*i-2*s-o)*a+s*t+n}function dM(t,e){const n=1-t;return n*n*e}function fM(t,e){return 2*(1-t)*t*e}function pM(t,e){return t*t*e}function Ja(t,e,n,i){return dM(t,e)+fM(t,n)+pM(t,i)}function mM(t,e){const n=1-t;return n*n*n*e}function gM(t,e){const n=1-t;return 3*n*n*t*e}function yM(t,e){return 3*(1-t)*t*t*e}function xM(t,e){return t*t*t*e}function Qa(t,e,n,i,r){return mM(t,e)+gM(t,n)+yM(t,i)+xM(t,r)}function Gi(t,e,n,i){nt.call(this),this.type="CubicBezierCurve",this.v0=t||new Te,this.v1=e||new Te,this.v2=n||new Te,this.v3=i||new Te}Gi.prototype=Object.create(nt.prototype);Gi.prototype.constructor=Gi;Gi.prototype.isCubicBezierCurve=!0;Gi.prototype.getPoint=function(t,e){const n=e||new Te,i=this.v0,r=this.v1,s=this.v2,o=this.v3;return n.set(Qa(t,i.x,r.x,s.x,o.x),Qa(t,i.y,r.y,s.y,o.y)),n};Gi.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this};Gi.prototype.toJSON=function(){const t=nt.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t};Gi.prototype.fromJSON=function(t){return nt.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this};function dr(t,e,n,i){nt.call(this),this.type="CubicBezierCurve3",this.v0=t||new T,this.v1=e||new T,this.v2=n||new T,this.v3=i||new T}dr.prototype=Object.create(nt.prototype);dr.prototype.constructor=dr;dr.prototype.isCubicBezierCurve3=!0;dr.prototype.getPoint=function(t,e){const n=e||new T,i=this.v0,r=this.v1,s=this.v2,o=this.v3;return n.set(Qa(t,i.x,r.x,s.x,o.x),Qa(t,i.y,r.y,s.y,o.y),Qa(t,i.z,r.z,s.z,o.z)),n};dr.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this};dr.prototype.toJSON=function(){const t=nt.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t};dr.prototype.fromJSON=function(t){return nt.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this};function Zn(t,e){nt.call(this),this.type="LineCurve",this.v1=t||new Te,this.v2=e||new Te}Zn.prototype=Object.create(nt.prototype);Zn.prototype.constructor=Zn;Zn.prototype.isLineCurve=!0;Zn.prototype.getPoint=function(t,e){const n=e||new Te;return t===1?n.copy(this.v2):(n.copy(this.v2).sub(this.v1),n.multiplyScalar(t).add(this.v1)),n};Zn.prototype.getPointAt=function(t,e){return this.getPoint(t,e)};Zn.prototype.getTangent=function(t,e){const n=e||new Te;return n.copy(this.v2).sub(this.v1).normalize(),n};Zn.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this};Zn.prototype.toJSON=function(){const t=nt.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t};Zn.prototype.fromJSON=function(t){return nt.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this};function Ui(t,e){nt.call(this),this.type="LineCurve3",this.v1=t||new T,this.v2=e||new T}Ui.prototype=Object.create(nt.prototype);Ui.prototype.constructor=Ui;Ui.prototype.isLineCurve3=!0;Ui.prototype.getPoint=function(t,e){const n=e||new T;return t===1?n.copy(this.v2):(n.copy(this.v2).sub(this.v1),n.multiplyScalar(t).add(this.v1)),n};Ui.prototype.getPointAt=function(t,e){return this.getPoint(t,e)};Ui.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this};Ui.prototype.toJSON=function(){const t=nt.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t};Ui.prototype.fromJSON=function(t){return nt.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this};function Vi(t,e,n){nt.call(this),this.type="QuadraticBezierCurve",this.v0=t||new Te,this.v1=e||new Te,this.v2=n||new Te}Vi.prototype=Object.create(nt.prototype);Vi.prototype.constructor=Vi;Vi.prototype.isQuadraticBezierCurve=!0;Vi.prototype.getPoint=function(t,e){const n=e||new Te,i=this.v0,r=this.v1,s=this.v2;return n.set(Ja(t,i.x,r.x,s.x),Ja(t,i.y,r.y,s.y)),n};Vi.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this};Vi.prototype.toJSON=function(){const t=nt.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t};Vi.prototype.fromJSON=function(t){return nt.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this};function fr(t,e,n){nt.call(this),this.type="QuadraticBezierCurve3",this.v0=t||new T,this.v1=e||new T,this.v2=n||new T}fr.prototype=Object.create(nt.prototype);fr.prototype.constructor=fr;fr.prototype.isQuadraticBezierCurve3=!0;fr.prototype.getPoint=function(t,e){const n=e||new T,i=this.v0,r=this.v1,s=this.v2;return n.set(Ja(t,i.x,r.x,s.x),Ja(t,i.y,r.y,s.y),Ja(t,i.z,r.z,s.z)),n};fr.prototype.copy=function(t){return nt.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this};fr.prototype.toJSON=function(){const t=nt.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t};fr.prototype.fromJSON=function(t){return nt.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this};function Hi(t){nt.call(this),this.type="SplineCurve",this.points=t||[]}Hi.prototype=Object.create(nt.prototype);Hi.prototype.constructor=Hi;Hi.prototype.isSplineCurve=!0;Hi.prototype.getPoint=function(t,e){const n=e||new Te,i=this.points,r=(i.length-1)*t,s=Math.floor(r),o=r-s,a=i[s===0?s:s-1],c=i[s],l=i[s>i.length-2?i.length-1:s+1],h=i[s>i.length-3?i.length-1:s+2];return n.set(Ng(o,a.x,c.x,l.x,h.x),Ng(o,a.y,c.y,l.y,h.y)),n};Hi.prototype.copy=function(t){nt.prototype.copy.call(this,t),this.points=[];for(let e=0,n=t.points.length;e<n;e++){const i=t.points[e];this.points.push(i.clone())}return this};Hi.prototype.toJSON=function(){const t=nt.prototype.toJSON.call(this);t.points=[];for(let e=0,n=this.points.length;e<n;e++){const i=this.points[e];t.points.push(i.toArray())}return t};Hi.prototype.fromJSON=function(t){nt.prototype.fromJSON.call(this,t),this.points=[];for(let e=0,n=t.points.length;e<n;e++){const i=t.points[e];this.points.push(new Te().fromArray(i))}return this};var op=Object.freeze({__proto__:null,ArcCurve:Lc,CatmullRomCurve3:Yn,CubicBezierCurve:Gi,CubicBezierCurve3:dr,EllipseCurve:li,LineCurve:Zn,LineCurve3:Ui,QuadraticBezierCurve:Vi,QuadraticBezierCurve3:fr,SplineCurve:Hi});function Dr(){nt.call(this),this.type="CurvePath",this.curves=[],this.autoClose=!1}Dr.prototype=Object.assign(Object.create(nt.prototype),{constructor:Dr,add:function(t){this.curves.push(t)},closePath:function(){const t=this.curves[0].getPoint(0),e=this.curves[this.curves.length-1].getPoint(1);t.equals(e)||this.curves.push(new Zn(e,t))},getPoint:function(t){const e=t*this.getLength(),n=this.getCurveLengths();let i=0;for(;i<n.length;){if(n[i]>=e){const r=n[i]-e,s=this.curves[i],o=s.getLength(),a=o===0?0:1-r/o;return s.getPointAt(a)}i++}return null},getLength:function(){const t=this.getCurveLengths();return t[t.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const t=[];let e=0;for(let n=0,i=this.curves.length;n<i;n++)e+=this.curves[n].getLength(),t.push(e);return this.cacheLengths=t,t},getSpacedPoints:function(t){t===void 0&&(t=40);const e=[];for(let n=0;n<=t;n++)e.push(this.getPoint(n/t));return this.autoClose&&e.push(e[0]),e},getPoints:function(t){t=t||12;const e=[];let n;for(let i=0,r=this.curves;i<r.length;i++){const s=r[i],o=s&&s.isEllipseCurve?t*2:s&&(s.isLineCurve||s.isLineCurve3)?1:s&&s.isSplineCurve?t*s.points.length:t,a=s.getPoints(o);for(let c=0;c<a.length;c++){const l=a[c];n&&n.equals(l)||(e.push(l),n=l)}}return this.autoClose&&e.length>1&&!e[e.length-1].equals(e[0])&&e.push(e[0]),e},copy:function(t){nt.prototype.copy.call(this,t),this.curves=[];for(let e=0,n=t.curves.length;e<n;e++){const i=t.curves[e];this.curves.push(i.clone())}return this.autoClose=t.autoClose,this},toJSON:function(){const t=nt.prototype.toJSON.call(this);t.autoClose=this.autoClose,t.curves=[];for(let e=0,n=this.curves.length;e<n;e++){const i=this.curves[e];t.curves.push(i.toJSON())}return t},fromJSON:function(t){nt.prototype.fromJSON.call(this,t),this.autoClose=t.autoClose,this.curves=[];for(let e=0,n=t.curves.length;e<n;e++){const i=t.curves[e];this.curves.push(new op[i.type]().fromJSON(i))}return this}});function Di(t){Dr.call(this),this.type="Path",this.currentPoint=new Te,t&&this.setFromPoints(t)}Di.prototype=Object.assign(Object.create(Dr.prototype),{constructor:Di,setFromPoints:function(t){this.moveTo(t[0].x,t[0].y);for(let e=1,n=t.length;e<n;e++)this.lineTo(t[e].x,t[e].y);return this},moveTo:function(t,e){return this.currentPoint.set(t,e),this},lineTo:function(t,e){const n=new Zn(this.currentPoint.clone(),new Te(t,e));return this.curves.push(n),this.currentPoint.set(t,e),this},quadraticCurveTo:function(t,e,n,i){const r=new Vi(this.currentPoint.clone(),new Te(t,e),new Te(n,i));return this.curves.push(r),this.currentPoint.set(n,i),this},bezierCurveTo:function(t,e,n,i,r,s){const o=new Gi(this.currentPoint.clone(),new Te(t,e),new Te(n,i),new Te(r,s));return this.curves.push(o),this.currentPoint.set(r,s),this},splineThru:function(t){const e=[this.currentPoint.clone()].concat(t),n=new Hi(e);return this.curves.push(n),this.currentPoint.copy(t[t.length-1]),this},arc:function(t,e,n,i,r,s){const o=this.currentPoint.x,a=this.currentPoint.y;return this.absarc(t+o,e+a,n,i,r,s),this},absarc:function(t,e,n,i,r,s){return this.absellipse(t,e,n,n,i,r,s),this},ellipse:function(t,e,n,i,r,s,o,a){const c=this.currentPoint.x,l=this.currentPoint.y;return this.absellipse(t+c,e+l,n,i,r,s,o,a),this},absellipse:function(t,e,n,i,r,s,o,a){const c=new li(t,e,n,i,r,s,o,a);if(this.curves.length>0){const h=c.getPoint(0);h.equals(this.currentPoint)||this.lineTo(h.x,h.y)}this.curves.push(c);const l=c.getPoint(1);return this.currentPoint.copy(l),this},copy:function(t){return Dr.prototype.copy.call(this,t),this.currentPoint.copy(t.currentPoint),this},toJSON:function(){const t=Dr.prototype.toJSON.call(this);return t.currentPoint=this.currentPoint.toArray(),t},fromJSON:function(t){return Dr.prototype.fromJSON.call(this,t),this.currentPoint.fromArray(t.currentPoint),this}});function fs(t){Di.call(this,t),this.uuid=ut.generateUUID(),this.type="Shape",this.holes=[]}fs.prototype=Object.assign(Object.create(Di.prototype),{constructor:fs,getPointsHoles:function(t){const e=[];for(let n=0,i=this.holes.length;n<i;n++)e[n]=this.holes[n].getPoints(t);return e},extractPoints:function(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}},copy:function(t){Di.prototype.copy.call(this,t),this.holes=[];for(let e=0,n=t.holes.length;e<n;e++){const i=t.holes[e];this.holes.push(i.clone())}return this},toJSON:function(){const t=Di.prototype.toJSON.call(this);t.uuid=this.uuid,t.holes=[];for(let e=0,n=this.holes.length;e<n;e++){const i=this.holes[e];t.holes.push(i.toJSON())}return t},fromJSON:function(t){Di.prototype.fromJSON.call(this,t),this.uuid=t.uuid,this.holes=[];for(let e=0,n=t.holes.length;e<n;e++){const i=t.holes[e];this.holes.push(new Di().fromJSON(i))}return this}});function Zt(t,e){$e.call(this),this.type="Light",this.color=new ke(t),this.intensity=e!==void 0?e:1,this.receiveShadow=void 0}Zt.prototype=Object.assign(Object.create($e.prototype),{constructor:Zt,isLight:!0,copy:function(t){return $e.prototype.copy.call(this,t),this.color.copy(t.color),this.intensity=t.intensity,this},toJSON:function(t){const e=$e.prototype.toJSON.call(this,t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,this.groundColor!==void 0&&(e.object.groundColor=this.groundColor.getHex()),this.distance!==void 0&&(e.object.distance=this.distance),this.angle!==void 0&&(e.object.angle=this.angle),this.decay!==void 0&&(e.object.decay=this.decay),this.penumbra!==void 0&&(e.object.penumbra=this.penumbra),this.shadow!==void 0&&(e.object.shadow=this.shadow.toJSON()),e}});function ap(t,e,n){Zt.call(this,t,n),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy($e.DefaultUp),this.updateMatrix(),this.groundColor=new ke(e)}ap.prototype=Object.assign(Object.create(Zt.prototype),{constructor:ap,isHemisphereLight:!0,copy:function(t){return Zt.prototype.copy.call(this,t),this.groundColor.copy(t.groundColor),this}});function pr(t){this.camera=t,this.bias=0,this.normalBias=0,this.radius=1,this.mapSize=new Te(512,512),this.map=null,this.mapPass=null,this.matrix=new Ie,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Zc,this._frameExtents=new Te(1,1),this._viewportCount=1,this._viewports=[new Ft(0,0,1,1)]}Object.assign(pr.prototype,{_projScreenMatrix:new Ie,_lightPositionWorld:new T,_lookTarget:new T,getViewportCount:function(){return this._viewportCount},getFrustum:function(){return this._frustum},updateMatrices:function(t){const e=this.camera,n=this.matrix,i=this._projScreenMatrix,r=this._lookTarget,s=this._lightPositionWorld;s.setFromMatrixPosition(t.matrixWorld),e.position.copy(s),r.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(r),e.updateMatrixWorld(),i.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(i),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply(e.projectionMatrix),n.multiply(e.matrixWorldInverse)},getViewport:function(t){return this._viewports[t]},getFrameExtents:function(){return this._frameExtents},copy:function(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this},clone:function(){return new this.constructor().copy(this)},toJSON:function(){const t={};return this.bias!==0&&(t.bias=this.bias),this.normalBias!==0&&(t.normalBias=this.normalBias),this.radius!==1&&(t.radius=this.radius),(this.mapSize.x!==512||this.mapSize.y!==512)&&(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}});function cp(){pr.call(this,new pn(50,1,.5,500))}cp.prototype=Object.assign(Object.create(pr.prototype),{constructor:cp,isSpotLightShadow:!0,updateMatrices:function(t){const e=this.camera,n=ut.RAD2DEG*2*t.angle,i=this.mapSize.width/this.mapSize.height,r=t.distance||e.far;(n!==e.fov||i!==e.aspect||r!==e.far)&&(e.fov=n,e.aspect=i,e.far=r,e.updateProjectionMatrix()),pr.prototype.updateMatrices.call(this,t)}});function nu(t,e,n,i,r,s){Zt.call(this,t,e),this.type="SpotLight",this.position.copy($e.DefaultUp),this.updateMatrix(),this.target=new $e,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(o){this.intensity=o/Math.PI}}),this.distance=n!==void 0?n:0,this.angle=i!==void 0?i:Math.PI/3,this.penumbra=r!==void 0?r:0,this.decay=s!==void 0?s:1,this.shadow=new cp}nu.prototype=Object.assign(Object.create(Zt.prototype),{constructor:nu,isSpotLight:!0,copy:function(t){return Zt.prototype.copy.call(this,t),this.distance=t.distance,this.angle=t.angle,this.penumbra=t.penumbra,this.decay=t.decay,this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}});function lp(){pr.call(this,new pn(90,1,.5,500)),this._frameExtents=new Te(4,2),this._viewportCount=6,this._viewports=[new Ft(2,1,1,1),new Ft(0,1,1,1),new Ft(3,1,1,1),new Ft(1,1,1,1),new Ft(3,0,1,1),new Ft(1,0,1,1)],this._cubeDirections=[new T(1,0,0),new T(-1,0,0),new T(0,0,1),new T(0,0,-1),new T(0,1,0),new T(0,-1,0)],this._cubeUps=[new T(0,1,0),new T(0,1,0),new T(0,1,0),new T(0,1,0),new T(0,0,1),new T(0,0,-1)]}lp.prototype=Object.assign(Object.create(pr.prototype),{constructor:lp,isPointLightShadow:!0,updateMatrices:function(t,e){e===void 0&&(e=0);const n=this.camera,i=this.matrix,r=this._lightPositionWorld,s=this._lookTarget,o=this._projScreenMatrix;r.setFromMatrixPosition(t.matrixWorld),n.position.copy(r),s.copy(n.position),s.add(this._cubeDirections[e]),n.up.copy(this._cubeUps[e]),n.lookAt(s),n.updateMatrixWorld(),i.makeTranslation(-r.x,-r.y,-r.z),o.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),this._frustum.setFromProjectionMatrix(o)}});function hp(t,e,n,i){Zt.call(this,t,e),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return this.intensity*4*Math.PI},set:function(r){this.intensity=r/(4*Math.PI)}}),this.distance=n!==void 0?n:0,this.decay=i!==void 0?i:1,this.shadow=new lp}hp.prototype=Object.assign(Object.create(Zt.prototype),{constructor:hp,isPointLight:!0,copy:function(t){return Zt.prototype.copy.call(this,t),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}});function Wr(t,e,n,i,r,s){ar.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t!==void 0?t:-1,this.right=e!==void 0?e:1,this.top=n!==void 0?n:1,this.bottom=i!==void 0?i:-1,this.near=r!==void 0?r:.1,this.far=s!==void 0?s:2e3,this.updateProjectionMatrix()}Wr.prototype=Object.assign(Object.create(ar.prototype),{constructor:Wr,isOrthographicCamera:!0,copy:function(t,e){return ar.prototype.copy.call(this,t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=t.view===null?null:Object.assign({},t.view),this},setViewOffset:function(t,e,n,i,r,s){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()},clearViewOffset:function(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let r=n-t,s=n+t,o=i+e,a=i-e;if(this.view!==null&&this.view.enabled){const c=(this.right-this.left)/this.view.fullWidth/this.zoom,l=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=c*this.view.offsetX,s=r+c*this.view.width,o-=l*this.view.offsetY,a=o-l*this.view.height}this.projectionMatrix.makeOrthographic(r,s,o,a,this.near,this.far),this.projectionMatrixInverse.getInverse(this.projectionMatrix)},toJSON:function(t){const e=$e.prototype.toJSON.call(this,t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,this.view!==null&&(e.object.view=Object.assign({},this.view)),e}});function up(){pr.call(this,new Wr(-5,5,5,-5,.5,500))}up.prototype=Object.assign(Object.create(pr.prototype),{constructor:up,isDirectionalLightShadow:!0,updateMatrices:function(t){pr.prototype.updateMatrices.call(this,t)}});function dp(t,e){Zt.call(this,t,e),this.type="DirectionalLight",this.position.copy($e.DefaultUp),this.updateMatrix(),this.target=new $e,this.shadow=new up}dp.prototype=Object.assign(Object.create(Zt.prototype),{constructor:dp,isDirectionalLight:!0,copy:function(t){return Zt.prototype.copy.call(this,t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}});function iu(t,e){Zt.call(this,t,e),this.type="AmbientLight",this.castShadow=void 0}iu.prototype=Object.assign(Object.create(Zt.prototype),{constructor:iu,isAmbientLight:!0});function fp(t,e,n,i){Zt.call(this,t,e),this.type="RectAreaLight",this.width=n!==void 0?n:10,this.height=i!==void 0?i:10}fp.prototype=Object.assign(Object.create(Zt.prototype),{constructor:fp,isRectAreaLight:!0,copy:function(t){return Zt.prototype.copy.call(this,t),this.width=t.width,this.height=t.height,this},toJSON:function(t){const e=Zt.prototype.toJSON.call(this,t);return e.object.width=this.width,e.object.height=this.height,e}});function nm(){this.coefficients=[];for(let t=0;t<9;t++)this.coefficients.push(new T)}Object.assign(nm.prototype,{isSphericalHarmonics3:!0,set:function(t){for(let e=0;e<9;e++)this.coefficients[e].copy(t[e]);return this},zero:function(){for(let t=0;t<9;t++)this.coefficients[t].set(0,0,0);return this},getAt:function(t,e){const n=t.x,i=t.y,r=t.z,s=this.coefficients;return e.copy(s[0]).multiplyScalar(.282095),e.addScaledVector(s[1],.488603*i),e.addScaledVector(s[2],.488603*r),e.addScaledVector(s[3],.488603*n),e.addScaledVector(s[4],1.092548*(n*i)),e.addScaledVector(s[5],1.092548*(i*r)),e.addScaledVector(s[6],.315392*(3*r*r-1)),e.addScaledVector(s[7],1.092548*(n*r)),e.addScaledVector(s[8],.546274*(n*n-i*i)),e},getIrradianceAt:function(t,e){const n=t.x,i=t.y,r=t.z,s=this.coefficients;return e.copy(s[0]).multiplyScalar(.886227),e.addScaledVector(s[1],2*.511664*i),e.addScaledVector(s[2],2*.511664*r),e.addScaledVector(s[3],2*.511664*n),e.addScaledVector(s[4],2*.429043*n*i),e.addScaledVector(s[5],2*.429043*i*r),e.addScaledVector(s[6],.743125*r*r-.247708),e.addScaledVector(s[7],2*.429043*n*r),e.addScaledVector(s[8],.429043*(n*n-i*i)),e},add:function(t){for(let e=0;e<9;e++)this.coefficients[e].add(t.coefficients[e]);return this},addScaledSH:function(t,e){for(let n=0;n<9;n++)this.coefficients[n].addScaledVector(t.coefficients[n],e);return this},scale:function(t){for(let e=0;e<9;e++)this.coefficients[e].multiplyScalar(t);return this},lerp:function(t,e){for(let n=0;n<9;n++)this.coefficients[n].lerp(t.coefficients[n],e);return this},equals:function(t){for(let e=0;e<9;e++)if(!this.coefficients[e].equals(t.coefficients[e]))return!1;return!0},copy:function(t){return this.set(t.coefficients)},clone:function(){return new this.constructor().copy(this)},fromArray:function(t,e){e===void 0&&(e=0);const n=this.coefficients;for(let i=0;i<9;i++)n[i].fromArray(t,e+i*3);return this},toArray:function(t,e){t===void 0&&(t=[]),e===void 0&&(e=0);const n=this.coefficients;for(let i=0;i<9;i++)n[i].toArray(t,e+i*3);return t}});Object.assign(nm,{getBasisAt:function(t,e){const n=t.x,i=t.y,r=t.z;e[0]=.282095,e[1]=.488603*i,e[2]=.488603*r,e[3]=.488603*n,e[4]=1.092548*n*i,e[5]=1.092548*i*r,e[6]=.315392*(3*r*r-1),e[7]=1.092548*n*r,e[8]=.546274*(n*n-i*i)}});function vi(t,e){Zt.call(this,void 0,e),this.type="LightProbe",this.sh=t!==void 0?t:new nm}vi.prototype=Object.assign(Object.create(Zt.prototype),{constructor:vi,isLightProbe:!0,copy:function(t){return Zt.prototype.copy.call(this,t),this.sh.copy(t.sh),this},fromJSON:function(t){return this.intensity=t.intensity,this.sh.fromArray(t.sh),this},toJSON:function(t){const e=Zt.prototype.toJSON.call(this,t);return e.object.sh=this.sh.toArray(),e}});function pp(t){Nt.call(this,t),this.textures={}}pp.prototype=Object.assign(Object.create(Nt.prototype),{constructor:pp,load:function(t,e,n,i){const r=this,s=new zi(r.manager);s.setPath(r.path),s.load(t,function(o){try{e(r.parse(JSON.parse(o)))}catch(a){i?i(a):console.error(a),r.manager.itemError(t)}},n,i)},parse:function(t){const e=this.textures;function n(r){return e[r]===void 0&&console.warn("THREE.MaterialLoader: Undefined texture",r),e[r]}const i=new cM[t.type];if(t.uuid!==void 0&&(i.uuid=t.uuid),t.name!==void 0&&(i.name=t.name),t.color!==void 0&&i.color.setHex(t.color),t.roughness!==void 0&&(i.roughness=t.roughness),t.metalness!==void 0&&(i.metalness=t.metalness),t.sheen!==void 0&&(i.sheen=new ke().setHex(t.sheen)),t.emissive!==void 0&&i.emissive.setHex(t.emissive),t.specular!==void 0&&i.specular.setHex(t.specular),t.shininess!==void 0&&(i.shininess=t.shininess),t.clearcoat!==void 0&&(i.clearcoat=t.clearcoat),t.clearcoatRoughness!==void 0&&(i.clearcoatRoughness=t.clearcoatRoughness),t.fog!==void 0&&(i.fog=t.fog),t.flatShading!==void 0&&(i.flatShading=t.flatShading),t.blending!==void 0&&(i.blending=t.blending),t.combine!==void 0&&(i.combine=t.combine),t.side!==void 0&&(i.side=t.side),t.opacity!==void 0&&(i.opacity=t.opacity),t.transparent!==void 0&&(i.transparent=t.transparent),t.alphaTest!==void 0&&(i.alphaTest=t.alphaTest),t.depthTest!==void 0&&(i.depthTest=t.depthTest),t.depthWrite!==void 0&&(i.depthWrite=t.depthWrite),t.colorWrite!==void 0&&(i.colorWrite=t.colorWrite),t.stencilWrite!==void 0&&(i.stencilWrite=t.stencilWrite),t.stencilWriteMask!==void 0&&(i.stencilWriteMask=t.stencilWriteMask),t.stencilFunc!==void 0&&(i.stencilFunc=t.stencilFunc),t.stencilRef!==void 0&&(i.stencilRef=t.stencilRef),t.stencilFuncMask!==void 0&&(i.stencilFuncMask=t.stencilFuncMask),t.stencilFail!==void 0&&(i.stencilFail=t.stencilFail),t.stencilZFail!==void 0&&(i.stencilZFail=t.stencilZFail),t.stencilZPass!==void 0&&(i.stencilZPass=t.stencilZPass),t.wireframe!==void 0&&(i.wireframe=t.wireframe),t.wireframeLinewidth!==void 0&&(i.wireframeLinewidth=t.wireframeLinewidth),t.wireframeLinecap!==void 0&&(i.wireframeLinecap=t.wireframeLinecap),t.wireframeLinejoin!==void 0&&(i.wireframeLinejoin=t.wireframeLinejoin),t.rotation!==void 0&&(i.rotation=t.rotation),t.linewidth!==1&&(i.linewidth=t.linewidth),t.dashSize!==void 0&&(i.dashSize=t.dashSize),t.gapSize!==void 0&&(i.gapSize=t.gapSize),t.scale!==void 0&&(i.scale=t.scale),t.polygonOffset!==void 0&&(i.polygonOffset=t.polygonOffset),t.polygonOffsetFactor!==void 0&&(i.polygonOffsetFactor=t.polygonOffsetFactor),t.polygonOffsetUnits!==void 0&&(i.polygonOffsetUnits=t.polygonOffsetUnits),t.skinning!==void 0&&(i.skinning=t.skinning),t.morphTargets!==void 0&&(i.morphTargets=t.morphTargets),t.morphNormals!==void 0&&(i.morphNormals=t.morphNormals),t.dithering!==void 0&&(i.dithering=t.dithering),t.vertexTangents!==void 0&&(i.vertexTangents=t.vertexTangents),t.visible!==void 0&&(i.visible=t.visible),t.toneMapped!==void 0&&(i.toneMapped=t.toneMapped),t.userData!==void 0&&(i.userData=t.userData),t.vertexColors!==void 0&&(typeof t.vertexColors=="number"?i.vertexColors=t.vertexColors>0:i.vertexColors=t.vertexColors),t.uniforms!==void 0)for(const r in t.uniforms){const s=t.uniforms[r];switch(i.uniforms[r]={},s.type){case"t":i.uniforms[r].value=n(s.value);break;case"c":i.uniforms[r].value=new ke().setHex(s.value);break;case"v2":i.uniforms[r].value=new Te().fromArray(s.value);break;case"v3":i.uniforms[r].value=new T().fromArray(s.value);break;case"v4":i.uniforms[r].value=new Ft().fromArray(s.value);break;case"m3":i.uniforms[r].value=new An().fromArray(s.value);case"m4":i.uniforms[r].value=new Ie().fromArray(s.value);break;default:i.uniforms[r].value=s.value}}if(t.defines!==void 0&&(i.defines=t.defines),t.vertexShader!==void 0&&(i.vertexShader=t.vertexShader),t.fragmentShader!==void 0&&(i.fragmentShader=t.fragmentShader),t.extensions!==void 0)for(const r in t.extensions)i.extensions[r]=t.extensions[r];if(t.shading!==void 0&&(i.flatShading=t.shading===1),t.size!==void 0&&(i.size=t.size),t.sizeAttenuation!==void 0&&(i.sizeAttenuation=t.sizeAttenuation),t.map!==void 0&&(i.map=n(t.map)),t.matcap!==void 0&&(i.matcap=n(t.matcap)),t.alphaMap!==void 0&&(i.alphaMap=n(t.alphaMap)),t.bumpMap!==void 0&&(i.bumpMap=n(t.bumpMap)),t.bumpScale!==void 0&&(i.bumpScale=t.bumpScale),t.normalMap!==void 0&&(i.normalMap=n(t.normalMap)),t.normalMapType!==void 0&&(i.normalMapType=t.normalMapType),t.normalScale!==void 0){let r=t.normalScale;Array.isArray(r)===!1&&(r=[r,r]),i.normalScale=new Te().fromArray(r)}return t.displacementMap!==void 0&&(i.displacementMap=n(t.displacementMap)),t.displacementScale!==void 0&&(i.displacementScale=t.displacementScale),t.displacementBias!==void 0&&(i.displacementBias=t.displacementBias),t.roughnessMap!==void 0&&(i.roughnessMap=n(t.roughnessMap)),t.metalnessMap!==void 0&&(i.metalnessMap=n(t.metalnessMap)),t.emissiveMap!==void 0&&(i.emissiveMap=n(t.emissiveMap)),t.emissiveIntensity!==void 0&&(i.emissiveIntensity=t.emissiveIntensity),t.specularMap!==void 0&&(i.specularMap=n(t.specularMap)),t.envMap!==void 0&&(i.envMap=n(t.envMap)),t.envMapIntensity!==void 0&&(i.envMapIntensity=t.envMapIntensity),t.reflectivity!==void 0&&(i.reflectivity=t.reflectivity),t.refractionRatio!==void 0&&(i.refractionRatio=t.refractionRatio),t.lightMap!==void 0&&(i.lightMap=n(t.lightMap)),t.lightMapIntensity!==void 0&&(i.lightMapIntensity=t.lightMapIntensity),t.aoMap!==void 0&&(i.aoMap=n(t.aoMap)),t.aoMapIntensity!==void 0&&(i.aoMapIntensity=t.aoMapIntensity),t.gradientMap!==void 0&&(i.gradientMap=n(t.gradientMap)),t.clearcoatMap!==void 0&&(i.clearcoatMap=n(t.clearcoatMap)),t.clearcoatRoughnessMap!==void 0&&(i.clearcoatRoughnessMap=n(t.clearcoatRoughnessMap)),t.clearcoatNormalMap!==void 0&&(i.clearcoatNormalMap=n(t.clearcoatNormalMap)),t.clearcoatNormalScale!==void 0&&(i.clearcoatNormalScale=new Te().fromArray(t.clearcoatNormalScale)),i},setTextures:function(t){return this.textures=t,this}});const sx={decodeText:function(t){if(typeof TextDecoder<"u")return new TextDecoder().decode(t);let e="";for(let n=0,i=t.length;n<i;n++)e+=String.fromCharCode(t[n]);try{return decodeURIComponent(escape(e))}catch{return e}},extractUrlBase:function(t){const e=t.lastIndexOf("/");return e===-1?"./":t.substr(0,e+1)}};function ru(){We.call(this),this.type="InstancedBufferGeometry",this.instanceCount=1/0}ru.prototype=Object.assign(Object.create(We.prototype),{constructor:ru,isInstancedBufferGeometry:!0,copy:function(t){return We.prototype.copy.call(this,t),this.instanceCount=t.instanceCount,this},clone:function(){return new this.constructor().copy(this)},toJSON:function(){const t=We.prototype.toJSON.call(this);return t.instanceCount=this.instanceCount,t.isInstancedBufferGeometry=!0,t}});function mp(t,e,n,i){typeof n=="number"&&(i=n,n=!1,console.error("THREE.InstancedBufferAttribute: The constructor now expects normalized as the third argument.")),Qe.call(this,t,e,n),this.meshPerAttribute=i||1}mp.prototype=Object.assign(Object.create(Qe.prototype),{constructor:mp,isInstancedBufferAttribute:!0,copy:function(t){return Qe.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this},toJSON:function(){const t=Qe.prototype.toJSON.call(this);return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}});function gp(t){Nt.call(this,t)}gp.prototype=Object.assign(Object.create(Nt.prototype),{constructor:gp,load:function(t,e,n,i){const r=this,s=new zi(r.manager);s.setPath(r.path),s.load(t,function(o){try{e(r.parse(JSON.parse(o)))}catch(a){i?i(a):console.error(a),r.manager.itemError(t)}},n,i)},parse:function(t){const e={},n={};function i(f,d){if(e[d]!==void 0)return e[d];const y=f.interleavedBuffers[d],g=r(f,y.buffer),m=new kl[y.type](g),x=new si(m,y.stride);return x.uuid=y.uuid,e[d]=x,x}function r(f,d){if(n[d]!==void 0)return n[d];const y=f.arrayBuffers[d],g=new Uint32Array(y).buffer;return n[d]=g,g}const s=t.isInstancedBufferGeometry?new ru:new We,o=t.data.index;if(o!==void 0){const f=new kl[o.type](o.array);s.setIndex(new Qe(f,1))}const a=t.data.attributes;for(const f in a){const d=a[f];let p;if(d.isInterleavedBufferAttribute){const y=i(t.data,d.data);p=new vs(y,d.itemSize,d.offset,d.normalized)}else{const y=new kl[d.type](d.array),g=d.isInstancedBufferAttribute?mp:Qe;p=new g(y,d.itemSize,d.normalized)}d.name!==void 0&&(p.name=d.name),s.setAttribute(f,p)}const c=t.data.morphAttributes;if(c)for(const f in c){const d=c[f],p=[];for(let y=0,g=d.length;y<g;y++){const m=d[y];let x;if(m.isInterleavedBufferAttribute){const v=i(t.data,m.data);x=new vs(v,m.itemSize,m.offset,m.normalized)}else{const v=new kl[m.type](m.array);x=new Qe(v,m.itemSize,m.normalized)}m.name!==void 0&&(x.name=m.name),p.push(x)}s.morphAttributes[f]=p}t.data.morphTargetsRelative&&(s.morphTargetsRelative=!0);const h=t.data.groups||t.data.drawcalls||t.data.offsets;if(h!==void 0)for(let f=0,d=h.length;f!==d;++f){const p=h[f];s.addGroup(p.start,p.count,p.materialIndex)}const u=t.data.boundingSphere;if(u!==void 0){const f=new T;u.center!==void 0&&f.fromArray(u.center),s.boundingSphere=new br(f,u.radius)}return t.name&&(s.name=t.name),t.userData&&(s.userData=t.userData),s}});const kl={Int8Array,Uint8Array,Uint8ClampedArray:typeof Uint8ClampedArray<"u"?Uint8ClampedArray:Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array};function yp(t){Nt.call(this,t)}yp.prototype=Object.assign(Object.create(Nt.prototype),{constructor:yp,load:function(t,e,n,i){const r=this,s=this.path===""?sx.extractUrlBase(t):this.path;this.resourcePath=this.resourcePath||s;const o=new zi(r.manager);o.setPath(this.path),o.load(t,function(a){let c=null;try{c=JSON.parse(a)}catch(h){i!==void 0&&i(h),console.error("THREE:ObjectLoader: Can't parse "+t+".",h.message);return}const l=c.metadata;if(l===void 0||l.type===void 0||l.type.toLowerCase()==="geometry"){console.error("THREE.ObjectLoader: Can't load "+t);return}r.parse(c,e)},n,i)},parse:function(t,e){const n=this.parseShape(t.shapes),i=this.parseGeometries(t.geometries,n),r=this.parseImages(t.images,function(){e!==void 0&&e(a)}),s=this.parseTextures(t.textures,r),o=this.parseMaterials(t.materials,s),a=this.parseObject(t.object,i,o);return t.animations&&(a.animations=this.parseAnimations(t.animations)),(t.images===void 0||t.images.length===0)&&e!==void 0&&e(a),a},parseShape:function(t){const e={};if(t!==void 0)for(let n=0,i=t.length;n<i;n++){const r=new fs().fromJSON(t[n]);e[r.uuid]=r}return e},parseGeometries:function(t,e){const n={};let i;if(t!==void 0){const r=new gp;for(let s=0,o=t.length;s<o;s++){let a;const c=t[s];switch(c.type){case"PlaneGeometry":case"PlaneBufferGeometry":a=new In[c.type](c.width,c.height,c.widthSegments,c.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":a=new In[c.type](c.width,c.height,c.depth,c.widthSegments,c.heightSegments,c.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":a=new In[c.type](c.radius,c.segments,c.thetaStart,c.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":a=new In[c.type](c.radiusTop,c.radiusBottom,c.height,c.radialSegments,c.heightSegments,c.openEnded,c.thetaStart,c.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":a=new In[c.type](c.radius,c.height,c.radialSegments,c.heightSegments,c.openEnded,c.thetaStart,c.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":a=new In[c.type](c.radius,c.widthSegments,c.heightSegments,c.phiStart,c.phiLength,c.thetaStart,c.thetaLength);break;case"DodecahedronGeometry":case"DodecahedronBufferGeometry":case"IcosahedronGeometry":case"IcosahedronBufferGeometry":case"OctahedronGeometry":case"OctahedronBufferGeometry":case"TetrahedronGeometry":case"TetrahedronBufferGeometry":a=new In[c.type](c.radius,c.detail);break;case"RingGeometry":case"RingBufferGeometry":a=new In[c.type](c.innerRadius,c.outerRadius,c.thetaSegments,c.phiSegments,c.thetaStart,c.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":a=new In[c.type](c.radius,c.tube,c.radialSegments,c.tubularSegments,c.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":a=new In[c.type](c.radius,c.tube,c.tubularSegments,c.radialSegments,c.p,c.q);break;case"TubeGeometry":case"TubeBufferGeometry":a=new In[c.type](new op[c.path.type]().fromJSON(c.path),c.tubularSegments,c.radius,c.radialSegments,c.closed);break;case"LatheGeometry":case"LatheBufferGeometry":a=new In[c.type](c.points,c.segments,c.phiStart,c.phiLength);break;case"PolyhedronGeometry":case"PolyhedronBufferGeometry":a=new In[c.type](c.vertices,c.indices,c.radius,c.details);break;case"ShapeGeometry":case"ShapeBufferGeometry":i=[];for(let h=0,u=c.shapes.length;h<u;h++){const f=e[c.shapes[h]];i.push(f)}a=new In[c.type](i,c.curveSegments);break;case"ExtrudeGeometry":case"ExtrudeBufferGeometry":i=[];for(let h=0,u=c.shapes.length;h<u;h++){const f=e[c.shapes[h]];i.push(f)}const l=c.options.extrudePath;l!==void 0&&(c.options.extrudePath=new op[l.type]().fromJSON(l)),a=new In[c.type](i,c.options);break;case"BufferGeometry":case"InstancedBufferGeometry":a=r.parse(c);break;case"Geometry":console.error('THREE.ObjectLoader: Loading "Geometry" is not supported anymore.');break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+c.type+'"');continue}a.uuid=c.uuid,c.name!==void 0&&(a.name=c.name),a.isBufferGeometry===!0&&c.userData!==void 0&&(a.userData=c.userData),n[c.uuid]=a}}return n},parseMaterials:function(t,e){const n={},i={};if(t!==void 0){const r=new pp;r.setTextures(e);for(let s=0,o=t.length;s<o;s++){const a=t[s];if(a.type==="MultiMaterial"){const c=[];for(let l=0;l<a.materials.length;l++){const h=a.materials[l];n[h.uuid]===void 0&&(n[h.uuid]=r.parse(h)),c.push(n[h.uuid])}i[a.uuid]=c}else n[a.uuid]===void 0&&(n[a.uuid]=r.parse(a)),i[a.uuid]=n[a.uuid]}}return i},parseAnimations:function(t){const e=[];for(let n=0;n<t.length;n++){const i=t[n],r=xi.parse(i);i.uuid!==void 0&&(r.uuid=i.uuid),e.push(r)}return e},parseImages:function(t,e){const n=this,i={};let r;function s(o){return n.manager.itemStart(o),r.load(o,function(){n.manager.itemEnd(o)},void 0,function(){n.manager.itemError(o),n.manager.itemEnd(o)})}if(t!==void 0&&t.length>0){const o=new rx(e);r=new Ic(o),r.setCrossOrigin(this.crossOrigin);for(let a=0,c=t.length;a<c;a++){const l=t[a],h=l.url;if(Array.isArray(h)){i[l.uuid]=[];for(let u=0,f=h.length;u<f;u++){const d=h[u],p=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(d)?d:n.resourcePath+d;i[l.uuid].push(s(p))}}else{const u=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(l.url)?l.url:n.resourcePath+l.url;i[l.uuid]=s(u)}}}return i},parseTextures:function(t,e){function n(r,s){return typeof r=="number"?r:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",r),s[r])}const i={};if(t!==void 0)for(let r=0,s=t.length;r<s;r++){const o=t[r];o.image===void 0&&console.warn('THREE.ObjectLoader: No "image" specified for',o.uuid),e[o.image]===void 0&&console.warn("THREE.ObjectLoader: Undefined image",o.image);let a;Array.isArray(e[o.image])?a=new Vr(e[o.image]):a=new $t(e[o.image]),a.needsUpdate=!0,a.uuid=o.uuid,o.name!==void 0&&(a.name=o.name),o.mapping!==void 0&&(a.mapping=n(o.mapping,bM)),o.offset!==void 0&&a.offset.fromArray(o.offset),o.repeat!==void 0&&a.repeat.fromArray(o.repeat),o.center!==void 0&&a.center.fromArray(o.center),o.rotation!==void 0&&(a.rotation=o.rotation),o.wrap!==void 0&&(a.wrapS=n(o.wrap[0],zg),a.wrapT=n(o.wrap[1],zg)),o.format!==void 0&&(a.format=o.format),o.type!==void 0&&(a.type=o.type),o.encoding!==void 0&&(a.encoding=o.encoding),o.minFilter!==void 0&&(a.minFilter=n(o.minFilter,Gg)),o.magFilter!==void 0&&(a.magFilter=n(o.magFilter,Gg)),o.anisotropy!==void 0&&(a.anisotropy=o.anisotropy),o.flipY!==void 0&&(a.flipY=o.flipY),o.premultiplyAlpha!==void 0&&(a.premultiplyAlpha=o.premultiplyAlpha),o.unpackAlignment!==void 0&&(a.unpackAlignment=o.unpackAlignment),i[o.uuid]=a}return i},parseObject:function(t,e,n){let i;function r(c){return e[c]===void 0&&console.warn("THREE.ObjectLoader: Undefined geometry",c),e[c]}function s(c){if(c!==void 0){if(Array.isArray(c)){const l=[];for(let h=0,u=c.length;h<u;h++){const f=c[h];n[f]===void 0&&console.warn("THREE.ObjectLoader: Undefined material",f),l.push(n[f])}return l}return n[c]===void 0&&console.warn("THREE.ObjectLoader: Undefined material",c),n[c]}}let o,a;switch(t.type){case"Scene":i=new Mo,t.background!==void 0&&Number.isInteger(t.background)&&(i.background=new ke(t.background)),t.fog!==void 0&&(t.fog.type==="Fog"?i.fog=new Bh(t.fog.color,t.fog.near,t.fog.far):t.fog.type==="FogExp2"&&(i.fog=new Hf(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":i=new pn(t.fov,t.aspect,t.near,t.far),t.focus!==void 0&&(i.focus=t.focus),t.zoom!==void 0&&(i.zoom=t.zoom),t.filmGauge!==void 0&&(i.filmGauge=t.filmGauge),t.filmOffset!==void 0&&(i.filmOffset=t.filmOffset),t.view!==void 0&&(i.view=Object.assign({},t.view));break;case"OrthographicCamera":i=new Wr(t.left,t.right,t.top,t.bottom,t.near,t.far),t.zoom!==void 0&&(i.zoom=t.zoom),t.view!==void 0&&(i.view=Object.assign({},t.view));break;case"AmbientLight":i=new iu(t.color,t.intensity);break;case"DirectionalLight":i=new dp(t.color,t.intensity);break;case"PointLight":i=new hp(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":i=new fp(t.color,t.intensity,t.width,t.height);break;case"SpotLight":i=new nu(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":i=new ap(t.color,t.groundColor,t.intensity);break;case"LightProbe":i=new vi().fromJSON(t);break;case"SkinnedMesh":console.warn("THREE.ObjectLoader.parseObject() does not support SkinnedMesh yet.");case"Mesh":o=r(t.geometry),a=s(t.material),i=new Ht(o,a);break;case"InstancedMesh":o=r(t.geometry),a=s(t.material);const c=t.count,l=t.instanceMatrix;i=new qf(o,a,c),i.instanceMatrix=new Qe(new Float32Array(l.array),16);break;case"LOD":i=new Oh;break;case"Line":i=new ci(r(t.geometry),s(t.material),t.mode);break;case"LineLoop":i=new Xf(r(t.geometry),s(t.material));break;case"LineSegments":i=new on(r(t.geometry),s(t.material));break;case"PointCloud":case"Points":i=new pc(r(t.geometry),s(t.material));break;case"Sprite":i=new $f(s(t.material));break;case"Group":i=new Ot;break;default:i=new $e}if(i.uuid=t.uuid,t.name!==void 0&&(i.name=t.name),t.matrix!==void 0?(i.matrix.fromArray(t.matrix),t.matrixAutoUpdate!==void 0&&(i.matrixAutoUpdate=t.matrixAutoUpdate),i.matrixAutoUpdate&&i.matrix.decompose(i.position,i.quaternion,i.scale)):(t.position!==void 0&&i.position.fromArray(t.position),t.rotation!==void 0&&i.rotation.fromArray(t.rotation),t.quaternion!==void 0&&i.quaternion.fromArray(t.quaternion),t.scale!==void 0&&i.scale.fromArray(t.scale)),t.castShadow!==void 0&&(i.castShadow=t.castShadow),t.receiveShadow!==void 0&&(i.receiveShadow=t.receiveShadow),t.shadow&&(t.shadow.bias!==void 0&&(i.shadow.bias=t.shadow.bias),t.shadow.normalBias!==void 0&&(i.shadow.normalBias=t.shadow.normalBias),t.shadow.radius!==void 0&&(i.shadow.radius=t.shadow.radius),t.shadow.mapSize!==void 0&&i.shadow.mapSize.fromArray(t.shadow.mapSize),t.shadow.camera!==void 0&&(i.shadow.camera=this.parseObject(t.shadow.camera))),t.visible!==void 0&&(i.visible=t.visible),t.frustumCulled!==void 0&&(i.frustumCulled=t.frustumCulled),t.renderOrder!==void 0&&(i.renderOrder=t.renderOrder),t.userData!==void 0&&(i.userData=t.userData),t.layers!==void 0&&(i.layers.mask=t.layers),t.children!==void 0){const c=t.children;for(let l=0;l<c.length;l++)i.add(this.parseObject(c[l],e,n))}if(t.type==="LOD"){t.autoUpdate!==void 0&&(i.autoUpdate=t.autoUpdate);const c=t.levels;for(let l=0;l<c.length;l++){const h=c[l],u=i.getObjectByProperty("uuid",h.object);u!==void 0&&i.addLevel(u,h.distance)}}return i}});const bM={UVMapping:jp,CubeReflectionMapping:qp,CubeRefractionMapping:Xp,EquirectangularReflectionMapping:Ry,EquirectangularRefractionMapping:Yp,CubeUVReflectionMapping:qc,CubeUVRefractionMapping:Zp},zg={RepeatWrapping:Th,ClampToEdgeWrapping:zn,MirroredRepeatWrapping:Ph},Gg={NearestFilter:zt,NearestMipmapNearestFilter:Df,NearestMipmapLinearFilter:Bf,LinearFilter:gn,LinearMipmapNearestFilter:Dy,LinearMipmapLinearFilter:Cu};function Ug(t){typeof createImageBitmap>"u"&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),typeof fetch>"u"&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),Nt.call(this,t),this.options={premultiplyAlpha:"none"}}Ug.prototype=Object.assign(Object.create(Nt.prototype),{constructor:Ug,isImageBitmapLoader:!0,setOptions:function(e){return this.options=e,this},load:function(t,e,n,i){t===void 0&&(t=""),this.path!==void 0&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=Vo.get(t);if(s!==void 0)return r.manager.itemStart(t),setTimeout(function(){e&&e(s),r.manager.itemEnd(t)},0),s;fetch(t).then(function(o){return o.blob()}).then(function(o){return createImageBitmap(o,r.options)}).then(function(o){Vo.add(t,o),e&&e(o),r.manager.itemEnd(t)}).catch(function(o){i&&i(o),r.manager.itemError(t),r.manager.itemEnd(t)}),r.manager.itemStart(t)}});function ox(){this.type="ShapePath",this.color=new ke,this.subPaths=[],this.currentPath=null}Object.assign(ox.prototype,{moveTo:function(t,e){return this.currentPath=new Di,this.subPaths.push(this.currentPath),this.currentPath.moveTo(t,e),this},lineTo:function(t,e){return this.currentPath.lineTo(t,e),this},quadraticCurveTo:function(t,e,n,i){return this.currentPath.quadraticCurveTo(t,e,n,i),this},bezierCurveTo:function(t,e,n,i,r,s){return this.currentPath.bezierCurveTo(t,e,n,i,r,s),this},splineThru:function(t){return this.currentPath.splineThru(t),this},toShapes:function(t,e){function n(m){const x=[];for(let v=0,b=m.length;v<b;v++){const _=m[v],C=new fs;C.curves=_.curves,x.push(C)}return x}function i(m,x){const v=x.length;let b=!1;for(let _=v-1,C=0;C<v;_=C++){let w=x[_],S=x[C],M=S.x-w.x,B=S.y-w.y;if(Math.abs(B)>Number.EPSILON){if(B<0&&(w=x[C],M=-M,S=x[_],B=-B),m.y<w.y||m.y>S.y)continue;if(m.y===w.y){if(m.x===w.x)return!0}else{const L=B*(m.x-w.x)-M*(m.y-w.y);if(L===0)return!0;if(L<0)continue;b=!b}}else{if(m.y!==w.y)continue;if(S.x<=m.x&&m.x<=w.x||w.x<=m.x&&m.x<=S.x)return!0}}return b}const r=kr.isClockWise,s=this.subPaths;if(s.length===0)return[];if(e===!0)return n(s);let o,a,c,l=[];if(s.length===1)return a=s[0],c=new fs,c.curves=a.curves,l.push(c),l;let h=!r(s[0].getPoints());h=t?!h:h;const u=[],f=[];let d=[],p=0,y;f[p]=void 0,d[p]=[];for(let m=0,x=s.length;m<x;m++)a=s[m],y=a.getPoints(),o=r(y),o=t?!o:o,o?(!h&&f[p]&&p++,f[p]={s:new fs,p:y},f[p].s.curves=a.curves,h&&p++,d[p]=[]):d[p].push({h:a,p:y[0]});if(!f[0])return n(s);if(f.length>1){let m=!1;const x=[];for(let v=0,b=f.length;v<b;v++)u[v]=[];for(let v=0,b=f.length;v<b;v++){const _=d[v];for(let C=0;C<_.length;C++){const w=_[C];let S=!0;for(let M=0;M<f.length;M++)i(w.p,f[M].p)&&(v!==M&&x.push({froms:v,tos:M,hole:C}),S?(S=!1,u[M].push(w)):m=!0);S&&u[v].push(w)}}x.length>0&&(m||(d=u))}let g;for(let m=0,x=f.length;m<x;m++){c=f[m].s,l.push(c),g=d[m];for(let v=0,b=g.length;v<b;v++)c.holes.push(g[v].h)}return l}});function ax(t){this.type="Font",this.data=t}Object.assign(ax.prototype,{isFont:!0,generateShapes:function(t,e){e===void 0&&(e=100);const n=[],i=vM(t,e,this.data);for(let r=0,s=i.length;r<s;r++)Array.prototype.push.apply(n,i[r].toShapes());return n}});function vM(t,e,n){const i=Array.from?Array.from(t):String(t).split(""),r=e/n.resolution,s=(n.boundingBox.yMax-n.boundingBox.yMin+n.underlineThickness)*r,o=[];let a=0,c=0;for(let l=0;l<i.length;l++){const h=i[l];if(h===`
`)a=0,c-=s;else{const u=_M(h,r,a,c,n);a+=u.offsetX,o.push(u.path)}}return o}function _M(t,e,n,i,r){const s=r.glyphs[t]||r.glyphs["?"];if(!s){console.error('THREE.Font: character "'+t+'" does not exists in font family '+r.familyName+".");return}const o=new ox;let a,c,l,h,u,f,d,p;if(s.o){const y=s._cachedOutline||(s._cachedOutline=s.o.split(" "));for(let g=0,m=y.length;g<m;)switch(y[g++]){case"m":a=y[g++]*e+n,c=y[g++]*e+i,o.moveTo(a,c);break;case"l":a=y[g++]*e+n,c=y[g++]*e+i,o.lineTo(a,c);break;case"q":l=y[g++]*e+n,h=y[g++]*e+i,u=y[g++]*e+n,f=y[g++]*e+i,o.quadraticCurveTo(u,f,l,h);break;case"b":l=y[g++]*e+n,h=y[g++]*e+i,u=y[g++]*e+n,f=y[g++]*e+i,d=y[g++]*e+n,p=y[g++]*e+i,o.bezierCurveTo(u,f,d,p,l,h);break}}return{offsetX:s.ha*e,path:o}}function Vg(t){Nt.call(this,t)}Vg.prototype=Object.assign(Object.create(Nt.prototype),{constructor:Vg,load:function(t,e,n,i){const r=this,s=new zi(this.manager);s.setPath(this.path),s.load(t,function(o){let a;try{a=JSON.parse(o)}catch{console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),a=JSON.parse(o.substring(65,o.length-2))}const c=r.parse(a);e&&e(c)},n,i)},parse:function(t){return new ax(t)}});let Fl;const cx={getContext:function(){return Fl===void 0&&(Fl=new(window.AudioContext||window.webkitAudioContext)),Fl},setContext:function(t){Fl=t}};function xp(t){Nt.call(this,t)}xp.prototype=Object.assign(Object.create(Nt.prototype),{constructor:xp,load:function(t,e,n,i){const r=this,s=new zi(r.manager);s.setResponseType("arraybuffer"),s.setPath(r.path),s.load(t,function(o){try{const a=o.slice(0);cx.getContext().decodeAudioData(a,function(l){e(l)})}catch(a){i?i(a):console.error(a),r.manager.itemError(t)}},n,i)}});function Hg(t,e,n){vi.call(this,void 0,n);const i=new ke().set(t),r=new ke().set(e),s=new T(i.r,i.g,i.b),o=new T(r.r,r.g,r.b),a=Math.sqrt(Math.PI),c=a*Math.sqrt(.75);this.sh.coefficients[0].copy(s).add(o).multiplyScalar(a),this.sh.coefficients[1].copy(s).sub(o).multiplyScalar(c)}Hg.prototype=Object.assign(Object.create(vi.prototype),{constructor:Hg,isHemisphereLightProbe:!0,copy:function(t){return vi.prototype.copy.call(this,t),this},toJSON:function(t){return vi.prototype.toJSON.call(this,t)}});function $g(t,e){vi.call(this,void 0,e);const n=new ke().set(t);this.sh.coefficients[0].set(n.r,n.g,n.b).multiplyScalar(2*Math.sqrt(Math.PI))}$g.prototype=Object.assign(Object.create(vi.prototype),{constructor:$g,isAmbientLightProbe:!0,copy:function(t){return vi.prototype.copy.call(this,t),this},toJSON:function(t){return vi.prototype.toJSON.call(this,t)}});const Wg=new Ie,jg=new Ie;function lx(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new pn,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new pn,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}Object.assign(lx.prototype,{update:function(t){const e=this._cache;if(e.focus!==t.focus||e.fov!==t.fov||e.aspect!==t.aspect*this.aspect||e.near!==t.near||e.far!==t.far||e.zoom!==t.zoom||e.eyeSep!==this.eyeSep){e.focus=t.focus,e.fov=t.fov,e.aspect=t.aspect*this.aspect,e.near=t.near,e.far=t.far,e.zoom=t.zoom,e.eyeSep=this.eyeSep;const i=t.projectionMatrix.clone(),r=e.eyeSep/2,s=r*e.near/e.focus,o=e.near*Math.tan(ut.DEG2RAD*e.fov*.5)/e.zoom;let a,c;jg.elements[12]=-r,Wg.elements[12]=r,a=-o*e.aspect+s,c=o*e.aspect+s,i.elements[0]=2*e.near/(c-a),i.elements[8]=(c+a)/(c-a),this.cameraL.projectionMatrix.copy(i),a=-o*e.aspect-s,c=o*e.aspect-s,i.elements[0]=2*e.near/(c-a),i.elements[8]=(c+a)/(c-a),this.cameraR.projectionMatrix.copy(i)}this.cameraL.matrixWorld.copy(t.matrixWorld).multiply(jg),this.cameraR.matrixWorld.copy(t.matrixWorld).multiply(Wg)}});function hx(t){this.autoStart=t!==void 0?t:!0,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}Object.assign(hx.prototype,{start:function(){this.startTime=(typeof performance>"u"?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1,this.autoStart=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=(typeof performance>"u"?Date:performance).now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}});const is=new T,qg=new Gt,wM=new T,rs=new T;function Xg(){$e.call(this),this.type="AudioListener",this.context=cx.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new hx}Xg.prototype=Object.assign(Object.create($e.prototype),{constructor:Xg,getInput:function(){return this.gain},removeFilter:function(){return this.filter!==null&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this},getFilter:function(){return this.filter},setFilter:function(t){return this.filter!==null?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=t,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this},updateMatrixWorld:function(t){$e.prototype.updateMatrixWorld.call(this,t);const e=this.context.listener,n=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(is,qg,wM),rs.set(0,0,-1).applyQuaternion(qg),e.positionX){const i=this.context.currentTime+this.timeDelta;e.positionX.linearRampToValueAtTime(is.x,i),e.positionY.linearRampToValueAtTime(is.y,i),e.positionZ.linearRampToValueAtTime(is.z,i),e.forwardX.linearRampToValueAtTime(rs.x,i),e.forwardY.linearRampToValueAtTime(rs.y,i),e.forwardZ.linearRampToValueAtTime(rs.z,i),e.upX.linearRampToValueAtTime(n.x,i),e.upY.linearRampToValueAtTime(n.y,i),e.upZ.linearRampToValueAtTime(n.z,i)}else e.setPosition(is.x,is.y,is.z),e.setOrientation(rs.x,rs.y,rs.z,n.x,n.y,n.z)}});function Rc(t){$e.call(this),this.type="Audio",this.listener=t,this.context=t.context,this.gain=this.context.createGain(),this.gain.connect(t.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this._startedAt=0,this._progress=0,this.filters=[]}Rc.prototype=Object.assign(Object.create($e.prototype),{constructor:Rc,getOutput:function(){return this.gain},setNodeSource:function(t){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=t,this.connect(),this},setMediaElementSource:function(t){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(t),this.connect(),this},setMediaStreamSource:function(t){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(t),this.connect(),this},setBuffer:function(t){return this.buffer=t,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(t){if(t===void 0&&(t=0),this.isPlaying===!0){console.warn("THREE.Audio: Audio is already playing.");return}if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}this._startedAt=this.context.currentTime+t;const e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.loopStart=this.loopStart,e.loopEnd=this.loopEnd,e.onended=this.onEnded.bind(this),e.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=e,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()},pause:function(){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this.isPlaying===!0&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,this.loop===!0&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this},stop:function(){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this._progress=0,this.source.stop(),this.source.onended=null,this.isPlaying=!1,this},connect:function(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let t=1,e=this.filters.length;t<e;t++)this.filters[t-1].connect(this.filters[t]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let t=1,e=this.filters.length;t<e;t++)this.filters[t-1].disconnect(this.filters[t]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(t){return t||(t=[]),this.isPlaying===!0?(this.disconnect(),this.filters=t,this.connect()):this.filters=t,this},setDetune:function(t){if(this.detune=t,this.source.detune!==void 0)return this.isPlaying===!0&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this},getDetune:function(){return this.detune},getFilter:function(){return this.getFilters()[0]},setFilter:function(t){return this.setFilters(t?[t]:[])},setPlaybackRate:function(t){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this.playbackRate=t,this.isPlaying===!0&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return this.hasPlaybackControl===!1?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop},setLoop:function(t){if(this.hasPlaybackControl===!1){console.warn("THREE.Audio: this Audio has no playback control.");return}return this.loop=t,this.isPlaying===!0&&(this.source.loop=this.loop),this},setLoopStart:function(t){return this.loopStart=t,this},setLoopEnd:function(t){return this.loopEnd=t,this},getVolume:function(){return this.gain.gain.value},setVolume:function(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this}});const ss=new T,Yg=new Gt,SM=new T,os=new T;function Zg(t){Rc.call(this,t),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}Zg.prototype=Object.assign(Object.create(Rc.prototype),{constructor:Zg,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(t){return this.panner.refDistance=t,this},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(t){return this.panner.rolloffFactor=t,this},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(t){return this.panner.distanceModel=t,this},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(t){return this.panner.maxDistance=t,this},setDirectionalCone:function(t,e,n){return this.panner.coneInnerAngle=t,this.panner.coneOuterAngle=e,this.panner.coneOuterGain=n,this},updateMatrixWorld:function(t){if($e.prototype.updateMatrixWorld.call(this,t),this.hasPlaybackControl===!0&&this.isPlaying===!1)return;this.matrixWorld.decompose(ss,Yg,SM),os.set(0,0,1).applyQuaternion(Yg);const e=this.panner;if(e.positionX){const n=this.context.currentTime+this.listener.timeDelta;e.positionX.linearRampToValueAtTime(ss.x,n),e.positionY.linearRampToValueAtTime(ss.y,n),e.positionZ.linearRampToValueAtTime(ss.z,n),e.orientationX.linearRampToValueAtTime(os.x,n),e.orientationY.linearRampToValueAtTime(os.y,n),e.orientationZ.linearRampToValueAtTime(os.z,n)}else e.setPosition(ss.x,ss.y,ss.z),e.setOrientation(os.x,os.y,os.z)}});function ux(t,e){this.analyser=t.context.createAnalyser(),this.analyser.fftSize=e!==void 0?e:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),t.getOutput().connect(this.analyser)}Object.assign(ux.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){let t=0;const e=this.getFrequencyData();for(let n=0;n<e.length;n++)t+=e[n];return t/e.length}});function dx(t,e,n){this.binding=t,this.valueSize=n;let i,r,s;switch(e){case"quaternion":i=this._slerp,r=this._slerpAdditive,s=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(n*6),this._workIndex=5;break;case"string":case"bool":i=this._select,r=this._select,s=this._setAdditiveIdentityOther,this.buffer=new Array(n*5);break;default:i=this._lerp,r=this._lerpAdditive,s=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(n*5)}this._mixBufferRegion=i,this._mixBufferRegionAdditive=r,this._setIdentity=s,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}Object.assign(dx.prototype,{accumulate:function(t,e){const n=this.buffer,i=this.valueSize,r=t*i+i;let s=this.cumulativeWeight;if(s===0){for(let o=0;o!==i;++o)n[r+o]=n[o];s=e}else{s+=e;const o=e/s;this._mixBufferRegion(n,r,0,o,i)}this.cumulativeWeight=s},accumulateAdditive:function(t){const e=this.buffer,n=this.valueSize,i=n*this._addIndex;this.cumulativeWeightAdditive===0&&this._setIdentity(),this._mixBufferRegionAdditive(e,i,0,t,n),this.cumulativeWeightAdditive+=t},apply:function(t){const e=this.valueSize,n=this.buffer,i=t*e+e,r=this.cumulativeWeight,s=this.cumulativeWeightAdditive,o=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,r<1){const a=e*this._origIndex;this._mixBufferRegion(n,i,a,1-r,e)}s>0&&this._mixBufferRegionAdditive(n,i,this._addIndex*e,1,e);for(let a=e,c=e+e;a!==c;++a)if(n[a]!==n[a+e]){o.setValue(n,i);break}},saveOriginalState:function(){const t=this.binding,e=this.buffer,n=this.valueSize,i=n*this._origIndex;t.getValue(e,i);for(let r=n,s=i;r!==s;++r)e[r]=e[i+r%n];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0},restoreOriginalState:function(){const t=this.valueSize*3;this.binding.setValue(this.buffer,t)},_setAdditiveIdentityNumeric:function(){const t=this._addIndex*this.valueSize,e=t+this.valueSize;for(let n=t;n<e;n++)this.buffer[n]=0},_setAdditiveIdentityQuaternion:function(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*4+3]=1},_setAdditiveIdentityOther:function(){const t=this._origIndex*this.valueSize,e=this._addIndex*this.valueSize;for(let n=0;n<this.valueSize;n++)this.buffer[e+n]=this.buffer[t+n]},_select:function(t,e,n,i,r){if(i>=.5)for(let s=0;s!==r;++s)t[e+s]=t[n+s]},_slerp:function(t,e,n,i){Gt.slerpFlat(t,e,t,e,t,n,i)},_slerpAdditive:function(t,e,n,i,r){const s=this._workIndex*r;Gt.multiplyQuaternionsFlat(t,s,t,e,t,n),Gt.slerpFlat(t,e,t,e,t,s,i)},_lerp:function(t,e,n,i,r){const s=1-i;for(let o=0;o!==r;++o){const a=e+o;t[a]=t[a]*s+t[n+o]*i}},_lerpAdditive:function(t,e,n,i,r){for(let s=0;s!==r;++s){const o=e+s;t[o]=t[o]+t[n+s]*i}}});const im="\\[\\]\\.:\\/",MM=new RegExp("["+im+"]","g"),rm="[^"+im+"]",AM="[^"+im.replace("\\.","")+"]",CM=/((?:WC+[\/:])*)/.source.replace("WC",rm),TM=/(WCOD+)?/.source.replace("WCOD",AM),PM=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",rm),EM=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",rm),IM=new RegExp("^"+CM+TM+PM+EM+"$"),LM=["material","materials","bones"];function fx(t,e,n){const i=n||Dn.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,i)}Object.assign(fx.prototype,{getValue:function(t,e){this.bind();const n=this._targetGroup.nCachedObjects_,i=this._bindings[n];i!==void 0&&i.getValue(t,e)},setValue:function(t,e){const n=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=n.length;i!==r;++i)n[i].setValue(t,e)},bind:function(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,n=t.length;e!==n;++e)t[e].bind()},unbind:function(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,n=t.length;e!==n;++e)t[e].unbind()}});function Dn(t,e,n){this.path=e,this.parsedPath=n||Dn.parseTrackName(e),this.node=Dn.findNode(t,this.parsedPath.nodeName)||t,this.rootNode=t}Object.assign(Dn,{Composite:fx,create:function(t,e,n){return t&&t.isAnimationObjectGroup?new Dn.Composite(t,e,n):new Dn(t,e,n)},sanitizeNodeName:function(t){return t.replace(/\s/g,"_").replace(MM,"")},parseTrackName:function(t){const e=IM.exec(t);if(!e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);const n={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},i=n.nodeName&&n.nodeName.lastIndexOf(".");if(i!==void 0&&i!==-1){const r=n.nodeName.substring(i+1);LM.indexOf(r)!==-1&&(n.nodeName=n.nodeName.substring(0,i),n.objectName=r)}if(n.propertyName===null||n.propertyName.length===0)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return n},findNode:function(t,e){if(!e||e===""||e==="."||e===-1||e===t.name||e===t.uuid)return t;if(t.skeleton){const n=t.skeleton.getBoneByName(e);if(n!==void 0)return n}if(t.children){const n=function(r){for(let s=0;s<r.length;s++){const o=r[s];if(o.name===e||o.uuid===e)return o;const a=n(o.children);if(a)return a}return null},i=n(t.children);if(i)return i}return null}});Object.assign(Dn.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(e,n){e[n]=this.node[this.propertyName]},function(e,n){const i=this.resolvedProperty;for(let r=0,s=i.length;r!==s;++r)e[n++]=i[r]},function(e,n){e[n]=this.resolvedProperty[this.propertyIndex]},function(e,n){this.resolvedProperty.toArray(e,n)}],SetterByBindingTypeAndVersioning:[[function(e,n){this.targetObject[this.propertyName]=e[n]},function(e,n){this.targetObject[this.propertyName]=e[n],this.targetObject.needsUpdate=!0},function(e,n){this.targetObject[this.propertyName]=e[n],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,n){const i=this.resolvedProperty;for(let r=0,s=i.length;r!==s;++r)i[r]=e[n++]},function(e,n){const i=this.resolvedProperty;for(let r=0,s=i.length;r!==s;++r)i[r]=e[n++];this.targetObject.needsUpdate=!0},function(e,n){const i=this.resolvedProperty;for(let r=0,s=i.length;r!==s;++r)i[r]=e[n++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,n){this.resolvedProperty[this.propertyIndex]=e[n]},function(e,n){this.resolvedProperty[this.propertyIndex]=e[n],this.targetObject.needsUpdate=!0},function(e,n){this.resolvedProperty[this.propertyIndex]=e[n],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,n){this.resolvedProperty.fromArray(e,n)},function(e,n){this.resolvedProperty.fromArray(e,n),this.targetObject.needsUpdate=!0},function(e,n){this.resolvedProperty.fromArray(e,n),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(e,n){this.bind(),this.getValue(e,n)},setValue:function(e,n){this.bind(),this.setValue(e,n)},bind:function(){let t=this.node,e=this.parsedPath,n=e.objectName,i=e.propertyName,r=e.propertyIndex;if(t||(t=Dn.findNode(this.rootNode,e.nodeName)||this.rootNode,this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!t){console.error("THREE.PropertyBinding: Trying to update node for track: "+this.path+" but it wasn't found.");return}if(n){let c=e.objectIndex;switch(n){case"materials":if(!t.material){console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);return}if(!t.material.materials){console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);return}t=t.material.materials;break;case"bones":if(!t.skeleton){console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);return}t=t.skeleton.bones;for(let l=0;l<t.length;l++)if(t[l].name===c){c=l;break}break;default:if(t[n]===void 0){console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);return}t=t[n]}if(c!==void 0){if(t[c]===void 0){console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,t);return}t=t[c]}}const s=t[i];if(s===void 0){const c=e.nodeName;console.error("THREE.PropertyBinding: Trying to update property for track: "+c+"."+i+" but it wasn't found.",t);return}let o=this.Versioning.None;this.targetObject=t,t.needsUpdate!==void 0?o=this.Versioning.NeedsUpdate:t.matrixWorldNeedsUpdate!==void 0&&(o=this.Versioning.MatrixWorldNeedsUpdate);let a=this.BindingType.Direct;if(r!==void 0){if(i==="morphTargetInfluences"){if(!t.geometry){console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);return}if(t.geometry.isBufferGeometry){if(!t.geometry.morphAttributes){console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);return}t.morphTargetDictionary[r]!==void 0&&(r=t.morphTargetDictionary[r])}else{console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences on THREE.Geometry. Use THREE.BufferGeometry instead.",this);return}}a=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=r}else s.fromArray!==void 0&&s.toArray!==void 0?(a=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(a=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=i;this.getValue=this.GetterByBindingType[a],this.setValue=this.SetterByBindingTypeAndVersioning[a][o]},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}});Object.assign(Dn.prototype,{_getValue_unbound:Dn.prototype.getValue,_setValue_unbound:Dn.prototype.setValue});function RM(){this.uuid=ut.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const t={};this._indicesByUUID=t;for(let n=0,i=arguments.length;n!==i;++n)t[arguments[n].uuid]=n;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const e=this;this.stats={objects:{get total(){return e._objects.length},get inUse(){return this.total-e.nCachedObjects_}},get bindingsPerObject(){return e._bindings.length}}}Object.assign(RM.prototype,{isAnimationObjectGroup:!0,add:function(){const t=this._objects,e=this._indicesByUUID,n=this._paths,i=this._parsedPaths,r=this._bindings,s=r.length;let o,a=t.length,c=this.nCachedObjects_;for(let l=0,h=arguments.length;l!==h;++l){const u=arguments[l],f=u.uuid;let d=e[f];if(d===void 0){d=a++,e[f]=d,t.push(u);for(let p=0,y=s;p!==y;++p)r[p].push(new Dn(u,n[p],i[p]))}else if(d<c){o=t[d];const p=--c,y=t[p];e[y.uuid]=d,t[d]=y,e[f]=p,t[p]=u;for(let g=0,m=s;g!==m;++g){const x=r[g],v=x[p];let b=x[d];x[d]=v,b===void 0&&(b=new Dn(u,n[g],i[g])),x[p]=b}}else t[d]!==o&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=c},remove:function(){const t=this._objects,e=this._indicesByUUID,n=this._bindings,i=n.length;let r=this.nCachedObjects_;for(let s=0,o=arguments.length;s!==o;++s){const a=arguments[s],c=a.uuid,l=e[c];if(l!==void 0&&l>=r){const h=r++,u=t[h];e[u.uuid]=l,t[l]=u,e[c]=h,t[h]=a;for(let f=0,d=i;f!==d;++f){const p=n[f],y=p[h],g=p[l];p[l]=y,p[h]=g}}}this.nCachedObjects_=r},uncache:function(){const t=this._objects,e=this._indicesByUUID,n=this._bindings,i=n.length;let r=this.nCachedObjects_,s=t.length;for(let o=0,a=arguments.length;o!==a;++o){const c=arguments[o],l=c.uuid,h=e[l];if(h!==void 0)if(delete e[l],h<r){const u=--r,f=t[u],d=--s,p=t[d];e[f.uuid]=h,t[h]=f,e[p.uuid]=u,t[u]=p,t.pop();for(let y=0,g=i;y!==g;++y){const m=n[y],x=m[u],v=m[d];m[h]=x,m[u]=v,m.pop()}}else{const u=--s,f=t[u];e[f.uuid]=h,t[h]=f,t.pop();for(let d=0,p=i;d!==p;++d){const y=n[d];y[h]=y[u],y.pop()}}}this.nCachedObjects_=r},subscribe_:function(t,e){let n=this._bindingsIndicesByPath,i=n[t],r=this._bindings;if(i!==void 0)return r[i];const s=this._paths,o=this._parsedPaths,a=this._objects,c=a.length,l=this.nCachedObjects_,h=new Array(c);i=r.length,n[t]=i,s.push(t),o.push(e),r.push(h);for(let u=l,f=a.length;u!==f;++u){const d=a[u];h[u]=new Dn(d,t,e)}return h},unsubscribe_:function(t){const e=this._bindingsIndicesByPath,n=e[t];if(n!==void 0){const i=this._paths,r=this._parsedPaths,s=this._bindings,o=s.length-1,a=s[o],c=t[o];e[c]=n,s[n]=a,s.pop(),r[n]=r[o],r.pop(),i[n]=i[o],i.pop()}}});function px(t,e,n,i){this._mixer=t,this._clip=e,this._localRoot=n||null,this.blendMode=i||e.blendMode;const r=e.tracks,s=r.length,o=new Array(s),a={endingStart:So,endingEnd:So};for(let c=0;c!==s;++c){const l=r[c].createInterpolant(null);o[c]=l,l.settings=a}this._interpolantSettings=a,this._interpolants=o,this._propertyBindings=new Array(s),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=M_,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}Object.assign(px.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&this.timeScale!==0&&this._startTime===null&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(t){return this._startTime=t,this},setLoop:function(t,e){return this.loop=t,this.repetitions=e,this},setEffectiveWeight:function(t){return this.weight=t,this._effectiveWeight=this.enabled?t:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(t){return this._scheduleFading(t,0,1)},fadeOut:function(t){return this._scheduleFading(t,1,0)},crossFadeFrom:function(t,e,n){if(t.fadeOut(e),this.fadeIn(e),n){const i=this._clip.duration,r=t._clip.duration,s=r/i,o=i/r;t.warp(1,s,e),this.warp(o,1,e)}return this},crossFadeTo:function(t,e,n){return t.crossFadeFrom(this,e,n)},stopFading:function(){let t=this._weightInterpolant;return t!==null&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this},setEffectiveTimeScale:function(t){return this.timeScale=t,this._effectiveTimeScale=this.paused?0:t,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(t){return this.timeScale=this._clip.duration/t,this.stopWarping()},syncWith:function(t){return this.time=t.time,this.timeScale=t.timeScale,this.stopWarping()},halt:function(t){return this.warp(this._effectiveTimeScale,0,t)},warp:function(t,e,n){const i=this._mixer,r=i.time,s=this.timeScale;let o=this._timeScaleInterpolant;o===null&&(o=i._lendControlInterpolant(),this._timeScaleInterpolant=o);const a=o.parameterPositions,c=o.sampleValues;return a[0]=r,a[1]=r+n,c[0]=t/s,c[1]=e/s,this},stopWarping:function(){let t=this._timeScaleInterpolant;return t!==null&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(t,e,n,i){if(!this.enabled){this._updateWeight(t);return}const r=this._startTime;if(r!==null){const a=(t-r)*n;if(a<0||n===0)return;this._startTime=null,e=n*a}e*=this._updateTimeScale(t);const s=this._updateTime(e),o=this._updateWeight(t);if(o>0){const a=this._interpolants,c=this._propertyBindings;switch(this.blendMode){case By:for(let l=0,h=a.length;l!==h;++l)a[l].evaluate(s),c[l].accumulateAdditive(o);break;case Kp:default:for(let l=0,h=a.length;l!==h;++l)a[l].evaluate(s),c[l].accumulate(i,o)}}},_updateWeight:function(t){let e=0;if(this.enabled){e=this.weight;const n=this._weightInterpolant;if(n!==null){const i=n.evaluate(t)[0];e*=i,t>n.parameterPositions[1]&&(this.stopFading(),i===0&&(this.enabled=!1))}}return this._effectiveWeight=e,e},_updateTimeScale:function(t){let e=0;if(!this.paused){e=this.timeScale;const n=this._timeScaleInterpolant;if(n!==null){const i=n.evaluate(t)[0];e*=i,t>n.parameterPositions[1]&&(this.stopWarping(),e===0?this.paused=!0:this.timeScale=e)}}return this._effectiveTimeScale=e,e},_updateTime:function(t){const e=this._clip.duration,n=this.loop;let i=this.time+t,r=this._loopCount;const s=n===A_;if(t===0)return r===-1?i:s&&(r&1)===1?e-i:i;if(n===S_){r===-1&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(i>=e)i=e;else if(i<0)i=0;else{this.time=i;break e}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=i,this._mixer.dispatchEvent({type:"finished",action:this,direction:t<0?-1:1})}}else{if(r===-1&&(t>=0?(r=0,this._setEndings(!0,this.repetitions===0,s)):this._setEndings(this.repetitions===0,!0,s)),i>=e||i<0){const o=Math.floor(i/e);i-=e*o,r+=Math.abs(o);const a=this.repetitions-r;if(a<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,i=t>0?e:0,this.time=i,this._mixer.dispatchEvent({type:"finished",action:this,direction:t>0?1:-1});else{if(a===1){const c=t<0;this._setEndings(c,!c,s)}else this._setEndings(!1,!1,s);this._loopCount=r,this.time=i,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:o})}}else this.time=i;if(s&&(r&1)===1)return e-i}return i},_setEndings:function(t,e,n){const i=this._interpolantSettings;n?(i.endingStart=co,i.endingEnd=co):(t?i.endingStart=this.zeroSlopeAtStart?co:So:i.endingStart=Rh,e?i.endingEnd=this.zeroSlopeAtEnd?co:So:i.endingEnd=Rh)},_scheduleFading:function(t,e,n){const i=this._mixer,r=i.time;let s=this._weightInterpolant;s===null&&(s=i._lendControlInterpolant(),this._weightInterpolant=s);const o=s.parameterPositions,a=s.sampleValues;return o[0]=r,a[0]=e,o[1]=r+t,a[1]=n,this}});function Kg(t){this._root=t,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}Kg.prototype=Object.assign(Object.create(xr.prototype),{constructor:Kg,_bindAction:function(t,e){const n=t._localRoot||this._root,i=t._clip.tracks,r=i.length,s=t._propertyBindings,o=t._interpolants,a=n.uuid,c=this._bindingsByRootAndName;let l=c[a];l===void 0&&(l={},c[a]=l);for(let h=0;h!==r;++h){const u=i[h],f=u.name;let d=l[f];if(d!==void 0)s[h]=d;else{if(d=s[h],d!==void 0){d._cacheIndex===null&&(++d.referenceCount,this._addInactiveBinding(d,a,f));continue}const p=e&&e._propertyBindings[h].binding.parsedPath;d=new dx(Dn.create(n,f,p),u.ValueTypeName,u.getValueSize()),++d.referenceCount,this._addInactiveBinding(d,a,f),s[h]=d}o[h].resultBuffer=d.buffer}},_activateAction:function(t){if(!this._isActiveAction(t)){if(t._cacheIndex===null){const n=(t._localRoot||this._root).uuid,i=t._clip.uuid,r=this._actionsByClip[i];this._bindAction(t,r&&r.knownActions[0]),this._addInactiveAction(t,i,n)}const e=t._propertyBindings;for(let n=0,i=e.length;n!==i;++n){const r=e[n];r.useCount++===0&&(this._lendBinding(r),r.saveOriginalState())}this._lendAction(t)}},_deactivateAction:function(t){if(this._isActiveAction(t)){const e=t._propertyBindings;for(let n=0,i=e.length;n!==i;++n){const r=e[n];--r.useCount===0&&(r.restoreOriginalState(),this._takeBackBinding(r))}this._takeBackAction(t)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const t=this;this.stats={actions:{get total(){return t._actions.length},get inUse(){return t._nActiveActions}},bindings:{get total(){return t._bindings.length},get inUse(){return t._nActiveBindings}},controlInterpolants:{get total(){return t._controlInterpolants.length},get inUse(){return t._nActiveControlInterpolants}}}},_isActiveAction:function(t){const e=t._cacheIndex;return e!==null&&e<this._nActiveActions},_addInactiveAction:function(t,e,n){const i=this._actions,r=this._actionsByClip;let s=r[e];if(s===void 0)s={knownActions:[t],actionByRoot:{}},t._byClipCacheIndex=0,r[e]=s;else{const o=s.knownActions;t._byClipCacheIndex=o.length,o.push(t)}t._cacheIndex=i.length,i.push(t),s.actionByRoot[n]=t},_removeInactiveAction:function(t){const e=this._actions,n=e[e.length-1],i=t._cacheIndex;n._cacheIndex=i,e[i]=n,e.pop(),t._cacheIndex=null;const r=t._clip.uuid,s=this._actionsByClip,o=s[r],a=o.knownActions,c=a[a.length-1],l=t._byClipCacheIndex;c._byClipCacheIndex=l,a[l]=c,a.pop(),t._byClipCacheIndex=null;const h=o.actionByRoot,u=(t._localRoot||this._root).uuid;delete h[u],a.length===0&&delete s[r],this._removeInactiveBindingsForAction(t)},_removeInactiveBindingsForAction:function(t){const e=t._propertyBindings;for(let n=0,i=e.length;n!==i;++n){const r=e[n];--r.referenceCount===0&&this._removeInactiveBinding(r)}},_lendAction:function(t){const e=this._actions,n=t._cacheIndex,i=this._nActiveActions++,r=e[i];t._cacheIndex=i,e[i]=t,r._cacheIndex=n,e[n]=r},_takeBackAction:function(t){const e=this._actions,n=t._cacheIndex,i=--this._nActiveActions,r=e[i];t._cacheIndex=i,e[i]=t,r._cacheIndex=n,e[n]=r},_addInactiveBinding:function(t,e,n){const i=this._bindingsByRootAndName,r=this._bindings;let s=i[e];s===void 0&&(s={},i[e]=s),s[n]=t,t._cacheIndex=r.length,r.push(t)},_removeInactiveBinding:function(t){const e=this._bindings,n=t.binding,i=n.rootNode.uuid,r=n.path,s=this._bindingsByRootAndName,o=s[i],a=e[e.length-1],c=t._cacheIndex;a._cacheIndex=c,e[c]=a,e.pop(),delete o[r],Object.keys(o).length===0&&delete s[i]},_lendBinding:function(t){const e=this._bindings,n=t._cacheIndex,i=this._nActiveBindings++,r=e[i];t._cacheIndex=i,e[i]=t,r._cacheIndex=n,e[n]=r},_takeBackBinding:function(t){const e=this._bindings,n=t._cacheIndex,i=--this._nActiveBindings,r=e[i];t._cacheIndex=i,e[i]=t,r._cacheIndex=n,e[n]=r},_lendControlInterpolant:function(){const t=this._controlInterpolants,e=this._nActiveControlInterpolants++;let n=t[e];return n===void 0&&(n=new eu(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),n.__cacheIndex=e,t[e]=n),n},_takeBackControlInterpolant:function(t){const e=this._controlInterpolants,n=t.__cacheIndex,i=--this._nActiveControlInterpolants,r=e[i];t.__cacheIndex=i,e[i]=t,r.__cacheIndex=n,e[n]=r},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(t,e,n){const i=e||this._root,r=i.uuid;let s=typeof t=="string"?xi.findByName(i,t):t;const o=s!==null?s.uuid:t;let a=this._actionsByClip[o],c=null;if(n===void 0&&(s!==null?n=s.blendMode:n=Kp),a!==void 0){const h=a.actionByRoot[r];if(h!==void 0&&h.blendMode===n)return h;c=a.knownActions[0],s===null&&(s=c._clip)}if(s===null)return null;const l=new px(this,s,e,n);return this._bindAction(l,c),this._addInactiveAction(l,o,r),l},existingAction:function(t,e){const n=e||this._root,i=n.uuid,r=typeof t=="string"?xi.findByName(n,t):t,s=r?r.uuid:t,o=this._actionsByClip[s];return o!==void 0&&o.actionByRoot[i]||null},stopAllAction:function(){const t=this._actions,e=this._nActiveActions;for(let n=e-1;n>=0;--n)t[n].stop();return this},update:function(t){t*=this.timeScale;const e=this._actions,n=this._nActiveActions,i=this.time+=t,r=Math.sign(t),s=this._accuIndex^=1;for(let c=0;c!==n;++c)e[c]._update(i,t,r,s);const o=this._bindings,a=this._nActiveBindings;for(let c=0;c!==a;++c)o[c].apply(s);return this},setTime:function(t){this.time=0;for(let e=0;e<this._actions.length;e++)this._actions[e].time=0;return this.update(t)},getRoot:function(){return this._root},uncacheClip:function(t){const e=this._actions,n=t.uuid,i=this._actionsByClip,r=i[n];if(r!==void 0){const s=r.knownActions;for(let o=0,a=s.length;o!==a;++o){const c=s[o];this._deactivateAction(c);const l=c._cacheIndex,h=e[e.length-1];c._cacheIndex=null,c._byClipCacheIndex=null,h._cacheIndex=l,e[l]=h,e.pop(),this._removeInactiveBindingsForAction(c)}delete i[n]}},uncacheRoot:function(t){const e=t.uuid,n=this._actionsByClip;for(const s in n){const o=n[s].actionByRoot,a=o[e];a!==void 0&&(this._deactivateAction(a),this._removeInactiveAction(a))}const i=this._bindingsByRootAndName,r=i[e];if(r!==void 0)for(const s in r){const o=r[s];o.restoreOriginalState(),this._removeInactiveBinding(o)}},uncacheAction:function(t,e){const n=this.existingAction(t,e);n!==null&&(this._deactivateAction(n),this._removeInactiveAction(n))}});function Dc(t){typeof t=="string"&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),t=arguments[1]),this.value=t}Dc.prototype.clone=function(){return new Dc(this.value.clone===void 0?this.value:this.value.clone())};function Jg(t,e,n){si.call(this,t,e),this.meshPerAttribute=n||1}Jg.prototype=Object.assign(Object.create(si.prototype),{constructor:Jg,isInstancedInterleavedBuffer:!0,copy:function(t){return si.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this},clone:function(t){const e=si.prototype.clone.call(this,t);return e.meshPerAttribute=this.meshPerAttribute,e},toJSON:function(t){const e=si.prototype.toJSON.call(this,t);return e.isInstancedInterleavedBuffer=!0,e.meshPerAttribute=this.meshPerAttribute,e}});function mx(t,e,n,i){this.ray=new Ko(t,e),this.near=n||0,this.far=i||1/0,this.camera=null,this.layers=new em,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function Qg(t,e){return t.distance-e.distance}function bp(t,e,n,i){if(t.layers.test(e.layers)&&t.raycast(e,n),i===!0){const r=t.children;for(let s=0,o=r.length;s<o;s++)bp(r[s],e,n,!0)}}Object.assign(mx.prototype,{set:function(t,e){this.ray.set(t,e)},setFromCamera:function(t,e){e&&e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e&&e.isOrthographicCamera?(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(t,e,n){const i=n||[];return bp(t,this,i,e),i.sort(Qg),i},intersectObjects:function(t,e,n){const i=n||[];if(Array.isArray(t)===!1)return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),i;for(let r=0,s=t.length;r<s;r++)bp(t[r],this,i,e);return i.sort(Qg),i}});function DM(t,e,n){return this.radius=t!==void 0?t:1,this.phi=e!==void 0?e:0,this.theta=n!==void 0?n:0,this}Object.assign(DM.prototype,{set:function(t,e,n){return this.radius=t,this.phi=e,this.theta=n,this},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(t){return this.setFromCartesianCoords(t.x,t.y,t.z)},setFromCartesianCoords:function(t,e,n){return this.radius=Math.sqrt(t*t+e*e+n*n),this.radius===0?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t,n),this.phi=Math.acos(ut.clamp(e/this.radius,-1,1))),this}});function BM(t,e,n){return this.radius=t!==void 0?t:1,this.theta=e!==void 0?e:0,this.y=n!==void 0?n:0,this}Object.assign(BM.prototype,{set:function(t,e,n){return this.radius=t,this.theta=e,this.y=n,this},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.radius=t.radius,this.theta=t.theta,this.y=t.y,this},setFromVector3:function(t){return this.setFromCartesianCoords(t.x,t.y,t.z)},setFromCartesianCoords:function(t,e,n){return this.radius=Math.sqrt(t*t+n*n),this.theta=Math.atan2(t,n),this.y=e,this}});const e0=new Te;function gx(t,e){this.min=t!==void 0?t:new Te(1/0,1/0),this.max=e!==void 0?e:new Te(-1/0,-1/0)}Object.assign(gx.prototype,{set:function(t,e){return this.min.copy(t),this.max.copy(e),this},setFromPoints:function(t){this.makeEmpty();for(let e=0,n=t.length;e<n;e++)this.expandByPoint(t[e]);return this},setFromCenterAndSize:function(t,e){const n=e0.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.min.copy(t.min),this.max.copy(t.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(t){return t===void 0&&(console.warn("THREE.Box2: .getCenter() target is now required"),t=new Te),this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(t){return t===void 0&&(console.warn("THREE.Box2: .getSize() target is now required"),t=new Te),this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(t){return this.min.min(t),this.max.max(t),this},expandByVector:function(t){return this.min.sub(t),this.max.add(t),this},expandByScalar:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this},containsPoint:function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)},containsBox:function(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y},getParameter:function(t,e){return e===void 0&&(console.warn("THREE.Box2: .getParameter() target is now required"),e=new Te),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)},clampPoint:function(t,e){return e===void 0&&(console.warn("THREE.Box2: .clampPoint() target is now required"),e=new Te),e.copy(t).clamp(this.min,this.max)},distanceToPoint:function(t){return e0.copy(t).clamp(this.min,this.max).sub(t).length()},intersect:function(t){return this.min.max(t.min),this.max.min(t.max),this},union:function(t){return this.min.min(t.min),this.max.max(t.max),this},translate:function(t){return this.min.add(t),this.max.add(t),this},equals:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}});const t0=new T,Nl=new T;function yx(t,e){this.start=t!==void 0?t:new T,this.end=e!==void 0?e:new T}Object.assign(yx.prototype,{set:function(t,e){return this.start.copy(t),this.end.copy(e),this},clone:function(){return new this.constructor().copy(this)},copy:function(t){return this.start.copy(t.start),this.end.copy(t.end),this},getCenter:function(t){return t===void 0&&(console.warn("THREE.Line3: .getCenter() target is now required"),t=new T),t.addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(t){return t===void 0&&(console.warn("THREE.Line3: .delta() target is now required"),t=new T),t.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,e){return e===void 0&&(console.warn("THREE.Line3: .at() target is now required"),e=new T),this.delta(e).multiplyScalar(t).add(this.start)},closestPointToPointParameter:function(t,e){t0.subVectors(t,this.start),Nl.subVectors(this.end,this.start);const n=Nl.dot(Nl);let r=Nl.dot(t0)/n;return e&&(r=ut.clamp(r,0,1)),r},closestPointToPoint:function(t,e,n){const i=this.closestPointToPointParameter(t,e);return n===void 0&&(console.warn("THREE.Line3: .closestPointToPoint() target is now required"),n=new T),this.delta(n).multiplyScalar(i).add(this.start)},applyMatrix4:function(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this},equals:function(t){return t.start.equals(this.start)&&t.end.equals(this.end)}});function su(t){$e.call(this),this.material=t,this.render=function(){},this.hasPositions=!1,this.hasNormals=!1,this.hasColors=!1,this.hasUvs=!1,this.positionArray=null,this.normalArray=null,this.colorArray=null,this.uvArray=null,this.count=0}su.prototype=Object.create($e.prototype);su.prototype.constructor=su;su.prototype.isImmediateRenderObject=!0;const n0=new T;function Bc(t,e){$e.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=e;const n=new We,i=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let s=0,o=1,a=32;s<a;s++,o++){const c=s/a*Math.PI*2,l=o/a*Math.PI*2;i.push(Math.cos(c),Math.sin(c),1,Math.cos(l),Math.sin(l),1)}n.setAttribute("position",new qe(i,3));const r=new dn({fog:!1,toneMapped:!1});this.cone=new on(n,r),this.add(this.cone),this.update()}Bc.prototype=Object.create($e.prototype);Bc.prototype.constructor=Bc;Bc.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()};Bc.prototype.update=function(){this.light.updateMatrixWorld();const t=this.light.distance?this.light.distance:1e3,e=t*Math.tan(this.light.angle);this.cone.scale.set(e,e,t),n0.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(n0),this.color!==void 0?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)};const Ir=new T,zl=new Ie,Sd=new Ie;function xx(t){const e=[];t&&t.isBone&&e.push(t);for(let n=0;n<t.children.length;n++)e.push.apply(e,xx(t.children[n]));return e}function Ho(t){const e=xx(t),n=new We,i=[],r=[],s=new ke(0,0,1),o=new ke(0,1,0);for(let c=0;c<e.length;c++){const l=e[c];l.parent&&l.parent.isBone&&(i.push(0,0,0),i.push(0,0,0),r.push(s.r,s.g,s.b),r.push(o.r,o.g,o.b))}n.setAttribute("position",new qe(i,3)),n.setAttribute("color",new qe(r,3));const a=new dn({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0});on.call(this,n,a),this.type="SkeletonHelper",this.root=t,this.bones=e,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}Ho.prototype=Object.create(on.prototype);Ho.prototype.constructor=Ho;Ho.prototype.isSkeletonHelper=!0;Ho.prototype.updateMatrixWorld=function(t){const e=this.bones,n=this.geometry,i=n.getAttribute("position");Sd.getInverse(this.root.matrixWorld);for(let r=0,s=0;r<e.length;r++){const o=e[r];o.parent&&o.parent.isBone&&(zl.multiplyMatrices(Sd,o.matrixWorld),Ir.setFromMatrixPosition(zl),i.setXYZ(s,Ir.x,Ir.y,Ir.z),zl.multiplyMatrices(Sd,o.parent.matrixWorld),Ir.setFromMatrixPosition(zl),i.setXYZ(s+1,Ir.x,Ir.y,Ir.z),s+=2)}n.getAttribute("position").needsUpdate=!0,$e.prototype.updateMatrixWorld.call(this,t)};function Oc(t,e,n){this.light=t,this.light.updateMatrixWorld(),this.color=n;const i=new Lo(e,4,2),r=new _i({wireframe:!0,fog:!1,toneMapped:!1});Ht.call(this,i,r),this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}Oc.prototype=Object.create(Ht.prototype);Oc.prototype.constructor=Oc;Oc.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()};Oc.prototype.update=function(){this.color!==void 0?this.material.color.set(this.color):this.material.color.copy(this.light.color)};const OM=new T,i0=new ke,r0=new ke;function kc(t,e,n){$e.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=n;const i=new Ss(e);i.rotateY(Math.PI*.5),this.material=new _i({wireframe:!0,fog:!1,toneMapped:!1}),this.color===void 0&&(this.material.vertexColors=!0);const r=i.getAttribute("position"),s=new Float32Array(r.count*3);i.setAttribute("color",new Qe(s,3)),this.add(new Ht(i,this.material)),this.update()}kc.prototype=Object.create($e.prototype);kc.prototype.constructor=kc;kc.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()};kc.prototype.update=function(){const t=this.children[0];if(this.color!==void 0)this.material.color.set(this.color);else{const e=t.geometry.getAttribute("color");i0.copy(this.light.color),r0.copy(this.light.groundColor);for(let n=0,i=e.count;n<i;n++){const r=n<i/2?i0:r0;e.setXYZ(n,r.r,r.g,r.b)}e.needsUpdate=!0}t.lookAt(OM.setFromMatrixPosition(this.light.matrixWorld).negate())};function vp(t,e,n,i){t=t||10,e=e||10,n=new ke(n!==void 0?n:4473924),i=new ke(i!==void 0?i:8947848);const r=e/2,s=t/e,o=t/2,a=[],c=[];for(let u=0,f=0,d=-o;u<=e;u++,d+=s){a.push(-o,0,d,o,0,d),a.push(d,0,-o,d,0,o);const p=u===r?n:i;p.toArray(c,f),f+=3,p.toArray(c,f),f+=3,p.toArray(c,f),f+=3,p.toArray(c,f),f+=3}const l=new We;l.setAttribute("position",new qe(a,3)),l.setAttribute("color",new qe(c,3));const h=new dn({vertexColors:!0,toneMapped:!1});on.call(this,l,h),this.type="GridHelper"}vp.prototype=Object.assign(Object.create(on.prototype),{constructor:vp,copy:function(t){return on.prototype.copy.call(this,t),this.geometry.copy(t.geometry),this.material.copy(t.material),this},clone:function(){return new this.constructor().copy(this)}});function _p(t,e,n,i,r,s){t=t||10,e=e||16,n=n||8,i=i||64,r=new ke(r!==void 0?r:4473924),s=new ke(s!==void 0?s:8947848);const o=[],a=[];for(let h=0;h<=e;h++){const u=h/e*(Math.PI*2),f=Math.sin(u)*t,d=Math.cos(u)*t;o.push(0,0,0),o.push(f,0,d);const p=h&1?r:s;a.push(p.r,p.g,p.b),a.push(p.r,p.g,p.b)}for(let h=0;h<=n;h++){const u=h&1?r:s,f=t-t/n*h;for(let d=0;d<i;d++){let p=d/i*(Math.PI*2),y=Math.sin(p)*f,g=Math.cos(p)*f;o.push(y,0,g),a.push(u.r,u.g,u.b),p=(d+1)/i*(Math.PI*2),y=Math.sin(p)*f,g=Math.cos(p)*f,o.push(y,0,g),a.push(u.r,u.g,u.b)}}const c=new We;c.setAttribute("position",new qe(o,3)),c.setAttribute("color",new qe(a,3));const l=new dn({vertexColors:!0,toneMapped:!1});on.call(this,c,l),this.type="PolarGridHelper"}_p.prototype=Object.create(on.prototype);_p.prototype.constructor=_p;const s0=new T,Gl=new T,o0=new T;function Fc(t,e,n){$e.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=n,e===void 0&&(e=1);let i=new We;i.setAttribute("position",new qe([-e,e,0,e,e,0,e,-e,0,-e,-e,0,-e,e,0],3));const r=new dn({fog:!1,toneMapped:!1});this.lightPlane=new ci(i,r),this.add(this.lightPlane),i=new We,i.setAttribute("position",new qe([0,0,0,0,0,1],3)),this.targetLine=new ci(i,r),this.add(this.targetLine),this.update()}Fc.prototype=Object.create($e.prototype);Fc.prototype.constructor=Fc;Fc.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()};Fc.prototype.update=function(){s0.setFromMatrixPosition(this.light.matrixWorld),Gl.setFromMatrixPosition(this.light.target.matrixWorld),o0.subVectors(Gl,s0),this.lightPlane.lookAt(Gl),this.color!==void 0?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(Gl),this.targetLine.scale.z=o0.length()};const Ul=new T,an=new ar;function ou(t){const e=new We,n=new dn({color:16777215,vertexColors:!0,toneMapped:!1}),i=[],r=[],s={},o=new ke(16755200),a=new ke(16711680),c=new ke(43775),l=new ke(16777215),h=new ke(3355443);u("n1","n2",o),u("n2","n4",o),u("n4","n3",o),u("n3","n1",o),u("f1","f2",o),u("f2","f4",o),u("f4","f3",o),u("f3","f1",o),u("n1","f1",o),u("n2","f2",o),u("n3","f3",o),u("n4","f4",o),u("p","n1",a),u("p","n2",a),u("p","n3",a),u("p","n4",a),u("u1","u2",c),u("u2","u3",c),u("u3","u1",c),u("c","t",l),u("p","c",h),u("cn1","cn2",h),u("cn3","cn4",h),u("cf1","cf2",h),u("cf3","cf4",h);function u(d,p,y){f(d,y),f(p,y)}function f(d,p){i.push(0,0,0),r.push(p.r,p.g,p.b),s[d]===void 0&&(s[d]=[]),s[d].push(i.length/3-1)}e.setAttribute("position",new qe(i,3)),e.setAttribute("color",new qe(r,3)),on.call(this,e,n),this.type="CameraHelper",this.camera=t,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=s,this.update()}ou.prototype=Object.create(on.prototype);ou.prototype.constructor=ou;ou.prototype.update=function(){const t=this.geometry,e=this.pointMap,n=1,i=1;an.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),ln("c",e,t,an,0,0,-1),ln("t",e,t,an,0,0,1),ln("n1",e,t,an,-n,-i,-1),ln("n2",e,t,an,n,-i,-1),ln("n3",e,t,an,-n,i,-1),ln("n4",e,t,an,n,i,-1),ln("f1",e,t,an,-n,-i,1),ln("f2",e,t,an,n,-i,1),ln("f3",e,t,an,-n,i,1),ln("f4",e,t,an,n,i,1),ln("u1",e,t,an,n*.7,i*1.1,-1),ln("u2",e,t,an,-n*.7,i*1.1,-1),ln("u3",e,t,an,0,i*2,-1),ln("cf1",e,t,an,-n,0,1),ln("cf2",e,t,an,n,0,1),ln("cf3",e,t,an,0,-i,1),ln("cf4",e,t,an,0,i,1),ln("cn1",e,t,an,-n,0,-1),ln("cn2",e,t,an,n,0,-1),ln("cn3",e,t,an,0,-i,-1),ln("cn4",e,t,an,0,i,-1),t.getAttribute("position").needsUpdate=!0};function ln(t,e,n,i,r,s,o){Ul.set(r,s,o).unproject(i);const a=e[t];if(a!==void 0){const c=n.getAttribute("position");for(let l=0,h=a.length;l<h;l++)c.setXYZ(a[l],Ul.x,Ul.y,Ul.z)}}const Vl=new Ut;function Cs(t,e){this.object=t,e===void 0&&(e=16776960);const n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),i=new Float32Array(8*3),r=new We;r.setIndex(new Qe(n,1)),r.setAttribute("position",new Qe(i,3)),on.call(this,r,new dn({color:e,toneMapped:!1})),this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}Cs.prototype=Object.create(on.prototype);Cs.prototype.constructor=Cs;Cs.prototype.update=function(t){if(t!==void 0&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),this.object!==void 0&&Vl.setFromObject(this.object),Vl.isEmpty())return;const e=Vl.min,n=Vl.max,i=this.geometry.attributes.position,r=i.array;r[0]=n.x,r[1]=n.y,r[2]=n.z,r[3]=e.x,r[4]=n.y,r[5]=n.z,r[6]=e.x,r[7]=e.y,r[8]=n.z,r[9]=n.x,r[10]=e.y,r[11]=n.z,r[12]=n.x,r[13]=n.y,r[14]=e.z,r[15]=e.x,r[16]=n.y,r[17]=e.z,r[18]=e.x,r[19]=e.y,r[20]=e.z,r[21]=n.x,r[22]=e.y,r[23]=e.z,i.needsUpdate=!0,this.geometry.computeBoundingSphere()};Cs.prototype.setFromObject=function(t){return this.object=t,this.update(),this};Cs.prototype.copy=function(t){return on.prototype.copy.call(this,t),this.object=t.object,this};Cs.prototype.clone=function(){return new this.constructor().copy(this)};function au(t,e){this.type="Box3Helper",this.box=t,e=e||16776960;const n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),i=[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],r=new We;r.setIndex(new Qe(n,1)),r.setAttribute("position",new qe(i,3)),on.call(this,r,new dn({color:e,toneMapped:!1})),this.type="Box3Helper",this.geometry.computeBoundingSphere()}au.prototype=Object.create(on.prototype);au.prototype.constructor=au;au.prototype.updateMatrixWorld=function(t){const e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5),$e.prototype.updateMatrixWorld.call(this,t))};function cu(t,e,n){this.plane=t,this.size=e===void 0?1:e;const i=n!==void 0?n:16776960,r=[1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],s=new We;s.setAttribute("position",new qe(r,3)),s.computeBoundingSphere(),ci.call(this,s,new dn({color:i,toneMapped:!1})),this.type="PlaneHelper";const o=[1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],a=new We;a.setAttribute("position",new qe(o,3)),a.computeBoundingSphere(),this.add(new Ht(a,new _i({color:i,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}cu.prototype=Object.create(ci.prototype);cu.prototype.constructor=cu;cu.prototype.updateMatrixWorld=function(t){let e=-this.plane.constant;Math.abs(e)<1e-8&&(e=1e-8),this.scale.set(.5*this.size,.5*this.size,e),this.children[0].material.side=e<0?yn:Yo,this.lookAt(this.plane.normal),$e.prototype.updateMatrixWorld.call(this,t)};const a0=new T;let Hl,Md;function jr(t,e,n,i,r,s){$e.call(this),this.type="ArrowHelper",t===void 0&&(t=new T(0,0,1)),e===void 0&&(e=new T(0,0,0)),n===void 0&&(n=1),i===void 0&&(i=16776960),r===void 0&&(r=.2*n),s===void 0&&(s=.2*r),Hl===void 0&&(Hl=new We,Hl.setAttribute("position",new qe([0,0,0,0,1,0],3)),Md=new hr(0,.5,1,5,1),Md.translate(0,-.5,0)),this.position.copy(e),this.line=new ci(Hl,new dn({color:i,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Ht(Md,new _i({color:i,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(t),this.setLength(n,r,s)}jr.prototype=Object.create($e.prototype);jr.prototype.constructor=jr;jr.prototype.setDirection=function(t){if(t.y>.99999)this.quaternion.set(0,0,0,1);else if(t.y<-.99999)this.quaternion.set(1,0,0,0);else{a0.set(t.z,0,-t.x).normalize();const e=Math.acos(t.y);this.quaternion.setFromAxisAngle(a0,e)}};jr.prototype.setLength=function(t,e,n){e===void 0&&(e=.2*t),n===void 0&&(n=.2*e),this.line.scale.set(1,Math.max(1e-4,t-e),1),this.line.updateMatrix(),this.cone.scale.set(n,e,n),this.cone.position.y=t,this.cone.updateMatrix()};jr.prototype.setColor=function(t){this.line.material.color.set(t),this.cone.material.color.set(t)};jr.prototype.copy=function(t){return $e.prototype.copy.call(this,t,!1),this.line.copy(t.line),this.cone.copy(t.cone),this};jr.prototype.clone=function(){return new this.constructor().copy(this)};function wp(t){t=t||1;const e=[0,0,0,t,0,0,0,0,0,0,t,0,0,0,0,0,0,t],n=[1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],i=new We;i.setAttribute("position",new qe(e,3)),i.setAttribute("color",new qe(n,3));const r=new dn({vertexColors:!0,toneMapped:!1});on.call(this,i,r),this.type="AxesHelper"}wp.prototype=Object.create(on.prototype);wp.prototype.constructor=wp;const bo=4,Fr=8,Li=Math.pow(2,Fr),bx=[.125,.215,.35,.446,.526,.582],vx=Fr-bo+1+bx.length,so=20,Oi={[Pn]:0,[Xc]:1,[Qp]:2,[Oy]:3,[ky]:4,[Fy]:5,[Jp]:6},Ad=new Wr,{_lodPlanes:Ia,_sizeLods:c0,_sigmas:$l}=FM();let Cd=null;const cs=(1+Math.sqrt(5))/2,Ks=1/cs,l0=[new T(1,1,1),new T(-1,1,1),new T(1,1,-1),new T(-1,1,-1),new T(0,cs,Ks),new T(0,cs,-Ks),new T(Ks,0,cs),new T(-Ks,0,cs),new T(cs,Ks,0),new T(-cs,Ks,0)];function h0(t){this._renderer=t,this._pingPongRenderTarget=null,this._blurMaterial=NM(so),this._equirectShader=null,this._cubemapShader=null,this._compileMaterial(this._blurMaterial)}h0.prototype={constructor:h0,fromScene:function(t,e=0,n=.1,i=100){Cd=this._renderer.getRenderTarget();const r=this._allocateTargets();return this._sceneToCubeUV(t,n,i,r),e>0&&this._blur(r,0,0,e),this._applyPMREM(r),this._cleanup(r),r},fromEquirectangular:function(t){return this._fromTexture(t)},fromCubemap:function(t){return this._fromTexture(t)},compileCubemapShader:function(){this._cubemapShader===null&&(this._cubemapShader=f0(),this._compileMaterial(this._cubemapShader))},compileEquirectangularShader:function(){this._equirectShader===null&&(this._equirectShader=d0(),this._compileMaterial(this._equirectShader))},dispose:function(){this._blurMaterial.dispose(),this._cubemapShader!==null&&this._cubemapShader.dispose(),this._equirectShader!==null&&this._equirectShader.dispose();for(let t=0;t<Ia.length;t++)Ia[t].dispose()},_cleanup:function(t){this._pingPongRenderTarget.dispose(),this._renderer.setRenderTarget(Cd),t.scissorTest=!1,Wl(t,0,0,t.width,t.height)},_fromTexture:function(t){Cd=this._renderer.getRenderTarget();const e=this._allocateTargets(t);return this._textureToCubeUV(t,e),this._applyPMREM(e),this._cleanup(e),e},_allocateTargets:function(t){const e={magFilter:zt,minFilter:zt,generateMipmaps:!1,type:gs,format:Gv,encoding:kM(t)?t.encoding:Qp,depthBuffer:!1,stencilBuffer:!1},n=u0(e);return n.depthBuffer=!t,this._pingPongRenderTarget=u0(e),n},_compileMaterial:function(t){const e=new Ht(Ia[0],t);this._renderer.compile(e,Ad)},_sceneToCubeUV:function(t,e,n,i){const o=new pn(90,1,e,n),a=[1,-1,1,1,1,1],c=[1,1,1,-1,-1,-1],l=this._renderer,h=l.outputEncoding,u=l.toneMapping,f=l.getClearColor(),d=l.getClearAlpha();l.toneMapping=yo,l.outputEncoding=Pn;let p=t.background;if(p&&p.isColor){p.convertSRGBToLinear();const y=Math.max(p.r,p.g,p.b),g=Math.min(Math.max(Math.ceil(Math.log2(y)),-128),127);p=p.multiplyScalar(Math.pow(2,-g));const m=(g+128)/255;l.setClearColor(p,m),t.background=null}for(let y=0;y<6;y++){const g=y%3;g==0?(o.up.set(0,a[y],0),o.lookAt(c[y],0,0)):g==1?(o.up.set(0,0,a[y]),o.lookAt(0,c[y],0)):(o.up.set(0,a[y],0),o.lookAt(0,0,c[y])),Wl(i,g*Li,y>2?Li:0,Li,Li),l.setRenderTarget(i),l.render(t,o)}l.toneMapping=u,l.outputEncoding=h,l.setClearColor(f,d)},_textureToCubeUV:function(t,e){const n=this._renderer;t.isCubeTexture?this._cubemapShader==null&&(this._cubemapShader=f0()):this._equirectShader==null&&(this._equirectShader=d0());const i=t.isCubeTexture?this._cubemapShader:this._equirectShader,r=new Ht(Ia[0],i),s=i.uniforms;s.envMap.value=t,t.isCubeTexture||s.texelSize.value.set(1/t.image.width,1/t.image.height),s.inputEncoding.value=Oi[t.encoding],s.outputEncoding.value=Oi[e.texture.encoding],Wl(e,0,0,3*Li,2*Li),n.setRenderTarget(e),n.render(r,Ad)},_applyPMREM:function(t){const e=this._renderer,n=e.autoClear;e.autoClear=!1;for(let i=1;i<vx;i++){const r=Math.sqrt($l[i]*$l[i]-$l[i-1]*$l[i-1]),s=l0[(i-1)%l0.length];this._blur(t,i-1,i,r,s)}e.autoClear=n},_blur:function(t,e,n,i,r){const s=this._pingPongRenderTarget;this._halfBlur(t,s,e,n,i,"latitudinal",r),this._halfBlur(s,t,n,n,i,"longitudinal",r)},_halfBlur:function(t,e,n,i,r,s,o){const a=this._renderer,c=this._blurMaterial;s!=="latitudinal"&&s!=="longitudinal"&&console.error("blur direction must be either latitudinal or longitudinal!");const l=3,h=new Ht(Ia[i],c),u=c.uniforms,f=c0[n]-1,d=isFinite(r)?Math.PI/(2*f):2*Math.PI/(2*so-1),p=r/d,y=isFinite(r)?1+Math.floor(l*p):so;y>so&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${y} samples when the maximum is set to ${so}`);const g=[];let m=0;for(let _=0;_<so;++_){const C=_/p,w=Math.exp(-C*C/2);g.push(w),_==0?m+=w:_<y&&(m+=2*w)}for(let _=0;_<g.length;_++)g[_]=g[_]/m;u.envMap.value=t.texture,u.samples.value=y,u.weights.value=g,u.latitudinal.value=s==="latitudinal",o&&(u.poleAxis.value=o),u.dTheta.value=d,u.mipInt.value=Fr-n,u.inputEncoding.value=Oi[t.texture.encoding],u.outputEncoding.value=Oi[t.texture.encoding];const x=c0[i],v=3*Math.max(0,Li-2*x),b=(i===0?0:2*Li)+2*x*(i>Fr-bo?i-Fr+bo:0);Wl(e,v,b,3*x,2*x),a.setRenderTarget(e),a.render(h,Ad)}};function kM(t){return t===void 0||t.type!==gs?!1:t.encoding===Pn||t.encoding===Xc||t.encoding===Jp}function FM(){const t=[],e=[],n=[];let i=Fr;for(let r=0;r<vx;r++){const s=Math.pow(2,i);e.push(s);let o=1/s;r>Fr-bo?o=bx[r-Fr+bo-1]:r==0&&(o=0),n.push(o);const a=1/(s-1),c=-a/2,l=1+a/2,h=[c,c,l,c,l,l,c,c,l,l,c,l],u=6,f=6,d=3,p=2,y=1,g=new Float32Array(d*f*u),m=new Float32Array(p*f*u),x=new Float32Array(y*f*u);for(let b=0;b<u;b++){const _=b%3*2/3-1,C=b>2?0:-1,w=[_,C,0,_+2/3,C,0,_+2/3,C+1,0,_,C,0,_+2/3,C+1,0,_,C+1,0];g.set(w,d*f*b),m.set(h,p*f*b);const S=[b,b,b,b,b,b];x.set(S,y*f*b)}const v=new We;v.setAttribute("position",new Qe(g,d)),v.setAttribute("uv",new Qe(m,p)),v.setAttribute("faceIndex",new Qe(x,y)),t.push(v),i>bo&&i--}return{_lodPlanes:t,_sizeLods:e,_sigmas:n}}function u0(t){const e=new Rn(3*Li,3*Li,t);return e.texture.mapping=qc,e.texture.name="PMREM.cubeUv",e.scissorTest=!0,e}function Wl(t,e,n,i,r){t.viewport.set(e,n,i,r),t.scissor.set(e,n,i,r)}function NM(t){const e=new Float32Array(t),n=new T(0,1,0);return new $r({name:"SphericalGaussianBlur",defines:{n:t},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:e},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:n},inputEncoding:{value:Oi[Pn]},outputEncoding:{value:Oi[Pn]}},vertexShader:sm(),fragmentShader:`
precision mediump float;
precision mediump int;
varying vec3 vOutputDirection;
uniform sampler2D envMap;
uniform int samples;
uniform float weights[n];
uniform bool latitudinal;
uniform float dTheta;
uniform float mipInt;
uniform vec3 poleAxis;

${om()}

#define ENVMAP_TYPE_CUBE_UV
#include <cube_uv_reflection_fragment>

vec3 getSample(float theta, vec3 axis) {
	float cosTheta = cos(theta);
	// Rodrigues' axis-angle rotation
	vec3 sampleDirection = vOutputDirection * cosTheta
		+ cross(axis, vOutputDirection) * sin(theta)
		+ axis * dot(axis, vOutputDirection) * (1.0 - cosTheta);
	return bilinearCubeUV(envMap, sampleDirection, mipInt);
}

void main() {
	vec3 axis = latitudinal ? poleAxis : cross(poleAxis, vOutputDirection);
	if (all(equal(axis, vec3(0.0))))
		axis = vec3(vOutputDirection.z, 0.0, - vOutputDirection.x);
	axis = normalize(axis);
	gl_FragColor = vec4(0.0);
	gl_FragColor.rgb += weights[0] * getSample(0.0, axis);
	for (int i = 1; i < n; i++) {
		if (i >= samples)
			break;
		float theta = dTheta * float(i);
		gl_FragColor.rgb += weights[i] * getSample(-1.0 * theta, axis);
		gl_FragColor.rgb += weights[i] * getSample(theta, axis);
	}
	gl_FragColor = linearToOutputTexel(gl_FragColor);
}
		`,blending:or,depthTest:!1,depthWrite:!1})}function d0(){const t=new Te(1,1);return new $r({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null},texelSize:{value:t},inputEncoding:{value:Oi[Pn]},outputEncoding:{value:Oi[Pn]}},vertexShader:sm(),fragmentShader:`
precision mediump float;
precision mediump int;
varying vec3 vOutputDirection;
uniform sampler2D envMap;
uniform vec2 texelSize;

${om()}

#include <common>

void main() {
	gl_FragColor = vec4(0.0);
	vec3 outputDirection = normalize(vOutputDirection);
	vec2 uv = equirectUv( outputDirection );
	vec2 f = fract(uv / texelSize - 0.5);
	uv -= f * texelSize;
	vec3 tl = envMapTexelToLinear(texture2D(envMap, uv)).rgb;
	uv.x += texelSize.x;
	vec3 tr = envMapTexelToLinear(texture2D(envMap, uv)).rgb;
	uv.y += texelSize.y;
	vec3 br = envMapTexelToLinear(texture2D(envMap, uv)).rgb;
	uv.x -= texelSize.x;
	vec3 bl = envMapTexelToLinear(texture2D(envMap, uv)).rgb;
	vec3 tm = mix(tl, tr, f.x);
	vec3 bm = mix(bl, br, f.x);
	gl_FragColor.rgb = mix(tm, bm, f.y);
	gl_FragColor = linearToOutputTexel(gl_FragColor);
}
		`,blending:or,depthTest:!1,depthWrite:!1})}function f0(){return new $r({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},inputEncoding:{value:Oi[Pn]},outputEncoding:{value:Oi[Pn]}},vertexShader:sm(),fragmentShader:`
precision mediump float;
precision mediump int;
varying vec3 vOutputDirection;
uniform samplerCube envMap;

${om()}

void main() {
	gl_FragColor = vec4(0.0);
	gl_FragColor.rgb = envMapTexelToLinear(textureCube(envMap, vec3( - vOutputDirection.x, vOutputDirection.yz ))).rgb;
	gl_FragColor = linearToOutputTexel(gl_FragColor);
}
		`,blending:or,depthTest:!1,depthWrite:!1})}function sm(){return`
precision mediump float;
precision mediump int;
attribute vec3 position;
attribute vec2 uv;
attribute float faceIndex;
varying vec3 vOutputDirection;

// RH coordinate system; PMREM face-indexing convention
vec3 getDirection(vec2 uv, float face) {
	uv = 2.0 * uv - 1.0;
	vec3 direction = vec3(uv, 1.0);
	if (face == 0.0) {
		direction = direction.zyx; // ( 1, v, u ) pos x
	} else if (face == 1.0) {
		direction = direction.xzy;
		direction.xz *= -1.0; // ( -u, 1, -v ) pos y
	} else if (face == 2.0) {
		direction.x *= -1.0; // ( -u, v, 1 ) pos z
	} else if (face == 3.0) {
		direction = direction.zyx;
		direction.xz *= -1.0; // ( -1, v, -u ) neg x
	} else if (face == 4.0) {
		direction = direction.xzy;
		direction.xy *= -1.0; // ( -u, -1, v ) neg y
	} else if (face == 5.0) {
		direction.z *= -1.0; // ( u, v, -1 ) neg z
	}
	return direction;
}

void main() {
	vOutputDirection = getDirection(uv, faceIndex);
	gl_Position = vec4( position, 1.0 );
}
	`}function om(){return`
uniform int inputEncoding;
uniform int outputEncoding;

#include <encodings_pars_fragment>

vec4 inputTexelToLinear(vec4 value){
	if(inputEncoding == 0){
		return value;
	}else if(inputEncoding == 1){
		return sRGBToLinear(value);
	}else if(inputEncoding == 2){
		return RGBEToLinear(value);
	}else if(inputEncoding == 3){
		return RGBMToLinear(value, 7.0);
	}else if(inputEncoding == 4){
		return RGBMToLinear(value, 16.0);
	}else if(inputEncoding == 5){
		return RGBDToLinear(value, 256.0);
	}else{
		return GammaToLinear(value, 2.2);
	}
}

vec4 linearToOutputTexel(vec4 value){
	if(outputEncoding == 0){
		return value;
	}else if(outputEncoding == 1){
		return LinearTosRGB(value);
	}else if(outputEncoding == 2){
		return LinearToRGBE(value);
	}else if(outputEncoding == 3){
		return LinearToRGBM(value, 7.0);
	}else if(outputEncoding == 4){
		return LinearToRGBM(value, 16.0);
	}else if(outputEncoding == 5){
		return LinearToRGBD(value, 256.0);
	}else{
		return LinearToGamma(value, 2.2);
	}
}

vec4 envMapTexelToLinear(vec4 color) {
	return inputTexelToLinear(color);
}
	`}nt.create=function(t,e){return console.log("THREE.Curve.create() has been deprecated"),t.prototype=Object.create(nt.prototype),t.prototype.constructor=t,t.prototype.getPoint=e,t};Object.assign(Dr.prototype,{createPointsGeometry:function(t){console.warn("THREE.CurvePath: .createPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");const e=this.getPoints(t);return this.createGeometry(e)},createSpacedPointsGeometry:function(t){console.warn("THREE.CurvePath: .createSpacedPointsGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");const e=this.getSpacedPoints(t);return this.createGeometry(e)},createGeometry:function(t){console.warn("THREE.CurvePath: .createGeometry() has been removed. Use new THREE.Geometry().setFromPoints( points ) instead.");const e=new rt;for(let n=0,i=t.length;n<i;n++){const r=t[n];e.vertices.push(new T(r.x,r.y,r.z||0))}return e}});Object.assign(Di.prototype,{fromPoints:function(t){return console.warn("THREE.Path: .fromPoints() has been renamed to .setFromPoints()."),this.setFromPoints(t)}});Object.create(Yn.prototype);Object.create(Yn.prototype);function _x(t){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),Yn.call(this,t),this.type="catmullrom"}_x.prototype=Object.create(Yn.prototype);Object.assign(_x.prototype,{initFromArray:function(){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}});vp.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")};Ho.prototype.update=function(){console.error("THREE.SkeletonHelper: update() no longer needs to be called.")};Object.assign(Nt.prototype,{extractUrlBase:function(t){return console.warn("THREE.Loader: .extractUrlBase() has been deprecated. Use THREE.LoaderUtils.extractUrlBase() instead."),sx.extractUrlBase(t)}});Nt.Handlers={add:function(){console.error("THREE.Loader: Handlers.add() has been removed. Use LoadingManager.addHandler() instead.")},get:function(){console.error("THREE.Loader: Handlers.get() has been removed. Use LoadingManager.getHandler() instead.")}};Object.assign(yp.prototype,{setTexturePath:function(t){return console.warn("THREE.ObjectLoader: .setTexturePath() has been renamed to .setResourcePath()."),this.setResourcePath(t)}});Object.assign(gx.prototype,{center:function(t){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(t)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(t){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},size:function(t){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(t)}});Object.assign(Ut.prototype,{center:function(t){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(t)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(t){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},isIntersectionSphere:function(t){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(t)},size:function(t){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(t)}});Object.assign(br.prototype,{empty:function(){return console.warn("THREE.Sphere: .empty() has been renamed to .isEmpty()."),this.isEmpty()}});Zc.prototype.setFromMatrix=function(t){return console.warn("THREE.Frustum: .setFromMatrix() has been renamed to .setFromProjectionMatrix()."),this.setFromProjectionMatrix(t)};yx.prototype.center=function(t){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(t)};Object.assign(ut,{random16:function(){return console.warn("THREE.Math: .random16() has been deprecated. Use Math.random() instead."),Math.random()},nearestPowerOfTwo:function(t){return console.warn("THREE.Math: .nearestPowerOfTwo() has been renamed to .floorPowerOfTwo()."),ut.floorPowerOfTwo(t)},nextPowerOfTwo:function(t){return console.warn("THREE.Math: .nextPowerOfTwo() has been renamed to .ceilPowerOfTwo()."),ut.ceilPowerOfTwo(t)}});Object.assign(An.prototype,{flattenToArrayOffset:function(t,e){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(t,e)},multiplyVector3:function(t){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),t.applyMatrix3(this)},multiplyVector3Array:function(){console.error("THREE.Matrix3: .multiplyVector3Array() has been removed.")},applyToBufferAttribute:function(t){return console.warn("THREE.Matrix3: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix3( matrix ) instead."),t.applyMatrix3(this)},applyToVector3Array:function(){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")}});Object.assign(Ie.prototype,{extractPosition:function(t){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(t)},flattenToArrayOffset:function(t,e){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(t,e)},getPosition:function(){return console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),new T().setFromMatrixColumn(this,3)},setRotationFromQuaternion:function(t){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(t)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(t){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector4:function(t){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},multiplyVector3Array:function(){console.error("THREE.Matrix4: .multiplyVector3Array() has been removed.")},rotateAxis:function(t){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),t.transformDirection(this)},crossVector:function(t){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBufferAttribute:function(t){return console.warn("THREE.Matrix4: .applyToBufferAttribute() has been removed. Use attribute.applyMatrix4( matrix ) instead."),t.applyMatrix4(this)},applyToVector3Array:function(){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(t,e,n,i,r,s){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(t,e,i,n,r,s)}});Ri.prototype.isIntersectionLine=function(t){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(t)};Gt.prototype.multiplyVector3=function(t){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),t.applyQuaternion(this)};Object.assign(Ko.prototype,{isIntersectionBox:function(t){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(t)},isIntersectionPlane:function(t){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(t)},isIntersectionSphere:function(t){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(t)}});Object.assign(Mn.prototype,{area:function(){return console.warn("THREE.Triangle: .area() has been renamed to .getArea()."),this.getArea()},barycoordFromPoint:function(t,e){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),this.getBarycoord(t,e)},midpoint:function(t){return console.warn("THREE.Triangle: .midpoint() has been renamed to .getMidpoint()."),this.getMidpoint(t)},normal:function(t){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),this.getNormal(t)},plane:function(t){return console.warn("THREE.Triangle: .plane() has been renamed to .getPlane()."),this.getPlane(t)}});Object.assign(Mn,{barycoordFromPoint:function(t,e,n,i,r){return console.warn("THREE.Triangle: .barycoordFromPoint() has been renamed to .getBarycoord()."),Mn.getBarycoord(t,e,n,i,r)},normal:function(t,e,n,i){return console.warn("THREE.Triangle: .normal() has been renamed to .getNormal()."),Mn.getNormal(t,e,n,i)}});Object.assign(fs.prototype,{extractAllPoints:function(t){return console.warn("THREE.Shape: .extractAllPoints() has been removed. Use .extractPoints() instead."),this.extractPoints(t)},extrude:function(t){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new Io(this,t)},makeGeometry:function(t){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new Ro(this,t)}});Object.assign(Te.prototype,{fromAttribute:function(t,e,n){return console.warn("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,n)},distanceToManhattan:function(t){return console.warn("THREE.Vector2: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(t)},lengthManhattan:function(){return console.warn("THREE.Vector2: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}});Object.assign(T.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(t){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(t)},getScaleFromMatrix:function(t){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(t)},getColumnFromMatrix:function(t,e){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(e,t)},applyProjection:function(t){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(t)},fromAttribute:function(t,e,n){return console.warn("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,n)},distanceToManhattan:function(t){return console.warn("THREE.Vector3: .distanceToManhattan() has been renamed to .manhattanDistanceTo()."),this.manhattanDistanceTo(t)},lengthManhattan:function(){return console.warn("THREE.Vector3: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}});Object.assign(Ft.prototype,{fromAttribute:function(t,e,n){return console.warn("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(t,e,n)},lengthManhattan:function(){return console.warn("THREE.Vector4: .lengthManhattan() has been renamed to .manhattanLength()."),this.manhattanLength()}});Object.assign(rt.prototype,{computeTangents:function(){console.error("THREE.Geometry: .computeTangents() has been removed.")},computeLineDistances:function(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")},applyMatrix:function(t){return console.warn("THREE.Geometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(t)}});Object.assign($e.prototype,{getChildByName:function(t){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(t)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(t,e){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(e,t)},getWorldRotation:function(){console.error("THREE.Object3D: .getWorldRotation() has been removed. Use THREE.Object3D.getWorldQuaternion( target ) instead.")},applyMatrix:function(t){return console.warn("THREE.Object3D: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(t)}});Object.defineProperties($e.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(t){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=t}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}});Object.assign(Ht.prototype,{setDrawMode:function(){console.error("THREE.Mesh: .setDrawMode() has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}});Object.defineProperties(Ht.prototype,{drawMode:{get:function(){return console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode."),C_},set:function(){console.error("THREE.Mesh: .drawMode has been removed. The renderer now always assumes THREE.TrianglesDrawMode. Transform your geometry via BufferGeometryUtils.toTrianglesDrawMode() if necessary.")}}});Object.defineProperties(Oh.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}});Object.defineProperty(jf.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}});Wf.prototype.initBones=function(){console.error("THREE.SkinnedMesh: initBones() has been removed.")};Object.defineProperty(nt.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(t){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=t}});pn.prototype.setLens=function(t,e){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),e!==void 0&&(this.filmGauge=e),this.setFocalLength(t)};Object.defineProperties(Zt.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(t){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=t}},shadowCameraLeft:{set:function(t){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=t}},shadowCameraRight:{set:function(t){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=t}},shadowCameraTop:{set:function(t){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=t}},shadowCameraBottom:{set:function(t){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=t}},shadowCameraNear:{set:function(t){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=t}},shadowCameraFar:{set:function(t){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=t}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(t){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=t}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(t){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=t}},shadowMapHeight:{set:function(t){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=t}}});Object.defineProperties(Qe.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}},dynamic:{get:function(){return console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.usage===oc},set:function(){console.warn("THREE.BufferAttribute: .dynamic has been deprecated. Use .usage instead."),this.setUsage(oc)}}});Object.assign(Qe.prototype,{setDynamic:function(t){return console.warn("THREE.BufferAttribute: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(t===!0?oc:Tu),this},copyIndicesArray:function(){console.error("THREE.BufferAttribute: .copyIndicesArray() has been removed.")},setArray:function(){console.error("THREE.BufferAttribute: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")}});Object.assign(We.prototype,{addIndex:function(t){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(t)},addAttribute:function(t,e){return console.warn("THREE.BufferGeometry: .addAttribute() has been renamed to .setAttribute()."),!(e&&e.isBufferAttribute)&&!(e&&e.isInterleavedBufferAttribute)?(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),this.setAttribute(t,new Qe(arguments[1],arguments[2]))):t==="index"?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),this.setIndex(e),this):this.setAttribute(t,e)},addDrawCall:function(t,e,n){n!==void 0&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(t,e)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")},removeAttribute:function(t){return console.warn("THREE.BufferGeometry: .removeAttribute() has been renamed to .deleteAttribute()."),this.deleteAttribute(t)},applyMatrix:function(t){return console.warn("THREE.BufferGeometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(t)}});Object.defineProperties(We.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}});Object.defineProperties(ru.prototype,{maxInstancedCount:{get:function(){return console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount},set:function(t){console.warn("THREE.InstancedBufferGeometry: .maxInstancedCount has been renamed to .instanceCount."),this.instanceCount=t}}});Object.defineProperties(mx.prototype,{linePrecision:{get:function(){return console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold},set:function(t){console.warn("THREE.Raycaster: .linePrecision has been deprecated. Use .params.Line.threshold instead."),this.params.Line.threshold=t}}});Object.defineProperties(si.prototype,{dynamic:{get:function(){return console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.usage===oc},set:function(t){console.warn("THREE.InterleavedBuffer: .length has been deprecated. Use .usage instead."),this.setUsage(t)}}});Object.assign(si.prototype,{setDynamic:function(t){return console.warn("THREE.InterleavedBuffer: .setDynamic() has been deprecated. Use .setUsage() instead."),this.setUsage(t===!0?oc:Tu),this},setArray:function(){console.error("THREE.InterleavedBuffer: .setArray has been removed. Use BufferGeometry .setAttribute to replace/resize attribute buffers")}});Object.assign(lr.prototype,{getArrays:function(){console.error("THREE.ExtrudeBufferGeometry: .getArrays() has been removed.")},addShapeList:function(){console.error("THREE.ExtrudeBufferGeometry: .addShapeList() has been removed.")},addShape:function(){console.error("THREE.ExtrudeBufferGeometry: .addShape() has been removed.")}});Object.defineProperties(Dc.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}});Object.defineProperties(at.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},overdraw:{get:function(){console.warn("THREE.Material: .overdraw has been removed.")},set:function(){console.warn("THREE.Material: .overdraw has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new ke}},shading:{get:function(){console.error("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead.")},set:function(t){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=t===Ey}},stencilMask:{get:function(){return console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask},set:function(t){console.warn("THREE."+this.type+": .stencilMask has been removed. Use .stencilFuncMask instead."),this.stencilFuncMask=t}}});Object.defineProperties(As.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}});Object.defineProperties(bn.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(t){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=t}}});Object.assign(Kc.prototype,{clearTarget:function(t,e,n,i){console.warn("THREE.WebGLRenderer: .clearTarget() has been deprecated. Use .setRenderTarget() and .clear() instead."),this.setRenderTarget(t),this.clear(e,n,i)},animate:function(t){console.warn("THREE.WebGLRenderer: .animate() is now .setAnimationLoop()."),this.setAnimationLoop(t)},getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},getMaxAnisotropy:function(){return console.warn("THREE.WebGLRenderer: .getMaxAnisotropy() is now .capabilities.getMaxAnisotropy()."),this.capabilities.getMaxAnisotropy()},getPrecision:function(){return console.warn("THREE.WebGLRenderer: .getPrecision() is now .capabilities.precision."),this.capabilities.precision},resetGLState:function(){return console.warn("THREE.WebGLRenderer: .resetGLState() is now .state.reset()."),this.state.reset()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(t){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(t)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")},setFaceCulling:function(){console.warn("THREE.WebGLRenderer: .setFaceCulling() has been removed.")},allocTextureUnit:function(){console.warn("THREE.WebGLRenderer: .allocTextureUnit() has been removed.")},setTexture:function(){console.warn("THREE.WebGLRenderer: .setTexture() has been removed.")},setTexture2D:function(){console.warn("THREE.WebGLRenderer: .setTexture2D() has been removed.")},setTextureCube:function(){console.warn("THREE.WebGLRenderer: .setTextureCube() has been removed.")},getActiveMipMapLevel:function(){return console.warn("THREE.WebGLRenderer: .getActiveMipMapLevel() is now .getActiveMipmapLevel()."),this.getActiveMipmapLevel()}});Object.defineProperties(Kc.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(t){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=t}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(t){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=t}},shadowMapCullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMapCullFace has been removed. Set Material.shadowSide instead.")}},context:{get:function(){return console.warn("THREE.WebGLRenderer: .context has been removed. Use .getContext() instead."),this.getContext()}},vr:{get:function(){return console.warn("THREE.WebGLRenderer: .vr has been renamed to .xr"),this.xr}},gammaInput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead."),!1},set:function(){console.warn("THREE.WebGLRenderer: .gammaInput has been removed. Set the encoding for textures via Texture.encoding instead.")}},gammaOutput:{get:function(){return console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),!1},set:function(t){console.warn("THREE.WebGLRenderer: .gammaOutput has been removed. Set WebGLRenderer.outputEncoding instead."),this.outputEncoding=t===!0?Xc:Pn}},toneMappingWhitePoint:{get:function(){return console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed."),1},set:function(){console.warn("THREE.WebGLRenderer: .toneMappingWhitePoint has been removed.")}}});Object.defineProperties(Zy.prototype,{cullFace:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.cullFace has been removed. Set Material.shadowSide instead.")}},renderReverseSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderReverseSided has been removed. Set Material.shadowSide instead.")}},renderSingleSided:{get:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")},set:function(){console.warn("THREE.WebGLRenderer: .shadowMap.renderSingleSided has been removed. Set Material.shadowSide instead.")}}});Object.defineProperties(Rn.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(t){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=t}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(t){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=t}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(t){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=t}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(t){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=t}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(t){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=t}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(t){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=t}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(t){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=t}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(t){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=t}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(t){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=t}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(t){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=t}}});Object.defineProperties(Rc.prototype,{load:{value:function(t){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");const e=this;return new xp().load(t,function(i){e.setBuffer(i)}),this}},startTime:{set:function(){console.warn("THREE.Audio: .startTime is now .play( delay ).")}}});ux.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()};lc.prototype.updateCubeMap=function(t,e){return console.warn("THREE.CubeCamera: .updateCubeMap() is now .update()."),this.update(t,e)};ys.crossOrigin=void 0;ys.loadTexture=function(t,e,n,i){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");const r=new sp;r.setCrossOrigin(this.crossOrigin);const s=r.load(t,n,void 0,i);return e&&(s.mapping=e),s};ys.loadTextureCube=function(t,e,n,i){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");const r=new rp;r.setCrossOrigin(this.crossOrigin);const s=r.load(t,n,void 0,i);return e&&(s.mapping=e),s};ys.loadCompressedTexture=function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")};ys.loadCompressedTextureCube=function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")};typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:tv}}));var lu={exports:{}};lu.exports;(function(t,e){/**
 * @license
 *
 * chroma.js - JavaScript library for color conversions
 * 
 * Copyright (c) 2011-2017, Gregor Aisch
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 * 
 * 1. Redistributions of source code must retain the above copyright notice, this
 *    list of conditions and the following disclaimer.
 * 
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 * 
 * 3. The name Gregor Aisch may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL GREGOR AISCH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
 * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
 * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */(function(){var n,i,r,s,o,a,c,l,h,u,f,d,p,y,g,m,x,v,b,_,C,w,S,M,B,L,U,E,O,k,ne,Y,F,te,ee,j,Z,ce,de,oe,V,re,q,J,W,H,se,$,he,me,le,D,N,pe,ue,X,ye,_e,xe,Se,Me,Oe,Ne,we,Fe,je,Be,tt,Ue,yt,Rt,Vt,dt,xt,Mt,Le,Ye,Ve,Xe,wt,K,Ae,ge=[].slice;Ve=function(){var A,P,R,G,z;for(A={},z="Boolean Number String Function Array Date RegExp Undefined Null".split(" "),G=0,P=z.length;G<P;G++)R=z[G],A["[object "+R+"]"]=R.toLowerCase();return function(Q){var ie;return ie=Object.prototype.toString.call(Q),A[ie]||"object"}}(),se=function(A,P,R){return P==null&&(P=0),R==null&&(R=1),A<P&&(A=P),A>R&&(A=R),A},Xe=function(A){return A.length>=3?Array.prototype.slice.call(A):A[0]},C=function(A){var P,R;for(A._clipped=!1,A._unclipped=A.slice(0),P=R=0;R<3;P=++R)P<3?((A[P]<0||A[P]>255)&&(A._clipped=!0),A[P]<0&&(A[P]=0),A[P]>255&&(A[P]=255)):P===3&&(A[P]<0&&(A[P]=0),A[P]>1&&(A[P]=1));return A._clipped||delete A._unclipped,A},s=Math.PI,dt=Math.round,S=Math.cos,E=Math.floor,X=Math.pow,$=Math.log,Mt=Math.sin,Le=Math.sqrt,y=Math.atan2,le=Math.max,p=Math.abs,c=s*2,o=s/3,i=s/180,a=180/s,_=function(){return arguments[0]instanceof n?arguments[0]:function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,arguments,function(){})},_.default=_,d=[],t!==null&&t.exports!=null&&(t.exports=_),Vt=e!==null?e:this,Vt.chroma=_,_.version="1.4.1",f={},h=[],u=!1,n=function(){function A(){var P,R,G,z,Q,ie,ae,ve,be;for(ie=this,R=[],ve=0,z=arguments.length;ve<z;ve++)P=arguments[ve],P!=null&&R.push(P);if(R.length>1&&(ae=R[R.length-1]),f[ae]!=null)ie._rgb=C(f[ae](Xe(R.slice(0,-1))));else{for(u||(h=h.sort(function(Re,Ge){return Ge.p-Re.p}),u=!0),be=0,Q=h.length;be<Q&&(G=h[be],ae=G.test.apply(G,R),!ae);be++);ae&&(ie._rgb=C(f[ae].apply(f,R)))}ie._rgb==null&&console.warn("unknown format: "+R),ie._rgb==null&&(ie._rgb=[0,0,0]),ie._rgb.length===3&&ie._rgb.push(1)}return A.prototype.toString=function(){return this.hex()},A}(),_._input=f;/**
	ColorBrewer colors for chroma.js

	Copyright (c) 2002 Cynthia Brewer, Mark Harrower, and The 
	Pennsylvania State University.

	Licensed under the Apache License, Version 2.0 (the "License"); 
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at	
	http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, software distributed
	under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
	CONDITIONS OF ANY KIND, either express or implied. See the License for the
	specific language governing permissions and limitations under the License.

    @preserve
 */_.brewer=v={OrRd:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],PuBu:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"],BuPu:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],Oranges:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],BuGn:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"],YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],YlGn:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"],Reds:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"],RdPu:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"],Greens:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],YlGnBu:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],Purples:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"],GnBu:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],Greys:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"],YlOrRd:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],PuRd:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"],Blues:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],PuBuGn:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"],Viridis:["#440154","#482777","#3f4a8a","#31678e","#26838f","#1f9d8a","#6cce5a","#b6de2b","#fee825"],Spectral:["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],RdYlGn:["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"],RdBu:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],PiYG:["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"],PRGn:["#40004b","#762a83","#9970ab","#c2a5cf","#e7d4e8","#f7f7f7","#d9f0d3","#a6dba0","#5aae61","#1b7837","#00441b"],RdYlBu:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],BrBG:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],RdGy:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"],PuOr:["#7f3b08","#b35806","#e08214","#fdb863","#fee0b6","#f7f7f7","#d8daeb","#b2abd2","#8073ac","#542788","#2d004b"],Set2:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],Accent:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],Set1:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],Set3:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],Dark2:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"],Paired:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"],Pastel2:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"],Pastel1:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"]},function(){var A,P;P=[];for(A in v)P.push(v[A.toLowerCase()]=v[A]);return P}(),wt={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflower:"#6495ed",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",laserlemon:"#ffff54",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrod:"#fafad2",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",maroon2:"#7f0000",maroon3:"#b03060",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",purple2:"#7f007f",purple3:"#a020f0",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},_.colors=wt,re=function(){var A,P,R,G,z,Q,ie,ae,ve;return P=Xe(arguments),z=P[0],A=P[1],R=P[2],ae=(z+16)/116,ie=isNaN(A)?ae:ae+A/500,ve=isNaN(R)?ae:ae-R/200,ae=r.Yn*q(ae),ie=r.Xn*q(ie),ve=r.Zn*q(ve),Q=Ae(3.2404542*ie-1.5371385*ae-.4985314*ve),G=Ae(-.969266*ie+1.8760108*ae+.041556*ve),R=Ae(.0556434*ie-.2040259*ae+1.0572252*ve),[Q,G,R,P.length>3?P[3]:1]},Ae=function(A){return 255*(A<=.00304?12.92*A:1.055*X(A,1/2.4)-.055)},q=function(A){return A>r.t1?A*A*A:r.t2*(A-r.t0)},r={Kn:18,Xn:.95047,Yn:1,Zn:1.08883,t0:.137931034,t1:.206896552,t2:.12841855,t3:.008856452},we=function(){var A,P,R,G,z,Q,ie,ae;return G=Xe(arguments),R=G[0],P=G[1],A=G[2],z=Ue(R,P,A),Q=z[0],ie=z[1],ae=z[2],[116*ie-16,500*(Q-ie),200*(ie-ae)]},yt=function(A){return(A/=255)<=.04045?A/12.92:X((A+.055)/1.055,2.4)},K=function(A){return A>r.t3?X(A,1/3):A/r.t2+r.t0},Ue=function(){var A,P,R,G,z,Q,ie;return G=Xe(arguments),R=G[0],P=G[1],A=G[2],R=yt(R),P=yt(P),A=yt(A),z=K((.4124564*R+.3575761*P+.1804375*A)/r.Xn),Q=K((.2126729*R+.7151522*P+.072175*A)/r.Yn),ie=K((.0193339*R+.119192*P+.9503041*A)/r.Zn),[z,Q,ie]},_.lab=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["lab"]),function(){})},f.lab=re,n.prototype.lab=function(){return we(this._rgb)},g=function(A){var P,R,G,z,Q,ie,ae,ve,be,Re,Ge;return A=function(){var Ee,De,ze;for(ze=[],De=0,Ee=A.length;De<Ee;De++)z=A[De],ze.push(_(z));return ze}(),A.length===2?(be=function(){var Ee,De,ze;for(ze=[],De=0,Ee=A.length;De<Ee;De++)z=A[De],ze.push(z.lab());return ze}(),Q=be[0],ie=be[1],P=function(Ee){var De,ze;return ze=function(){var Je,ht;for(ht=[],De=Je=0;Je<=2;De=++Je)ht.push(Q[De]+Ee*(ie[De]-Q[De]));return ht}(),_.lab.apply(_,ze)}):A.length===3?(Re=function(){var Ee,De,ze;for(ze=[],De=0,Ee=A.length;De<Ee;De++)z=A[De],ze.push(z.lab());return ze}(),Q=Re[0],ie=Re[1],ae=Re[2],P=function(Ee){var De,ze;return ze=function(){var Je,ht;for(ht=[],De=Je=0;Je<=2;De=++Je)ht.push((1-Ee)*(1-Ee)*Q[De]+2*(1-Ee)*Ee*ie[De]+Ee*Ee*ae[De]);return ht}(),_.lab.apply(_,ze)}):A.length===4?(Ge=function(){var Ee,De,ze;for(ze=[],De=0,Ee=A.length;De<Ee;De++)z=A[De],ze.push(z.lab());return ze}(),Q=Ge[0],ie=Ge[1],ae=Ge[2],ve=Ge[3],P=function(Ee){var De,ze;return ze=function(){var Je,ht;for(ht=[],De=Je=0;Je<=2;De=++Je)ht.push((1-Ee)*(1-Ee)*(1-Ee)*Q[De]+3*(1-Ee)*(1-Ee)*Ee*ie[De]+3*(1-Ee)*Ee*Ee*ae[De]+Ee*Ee*Ee*ve[De]);return ht}(),_.lab.apply(_,ze)}):A.length===5&&(R=g(A.slice(0,3)),G=g(A.slice(2,5)),P=function(Ee){return Ee<.5?R(Ee*2):G((Ee-.5)*2)}),P},_.bezier=function(A){var P;return P=g(A),P.scale=function(){return _.scale(P)},P},_.cubehelix=function(A,P,R,G,z){var Q,ie,ae;return A==null&&(A=300),P==null&&(P=-1.5),R==null&&(R=1),G==null&&(G=1),z==null&&(z=[0,1]),Q=0,Ve(z)==="array"?ie=z[1]-z[0]:(ie=0,z=[z,z]),ae=function(ve){var be,Re,Ge,Ee,De,ze,Je,ht,Ze;return be=c*((A+120)/360+P*ve),Je=X(z[0]+ie*ve,G),ze=Q!==0?R[0]+ve*Q:R,Re=ze*Je*(1-Je)/2,Ee=S(be),Ze=Mt(be),ht=Je+Re*(-.14861*Ee+1.78277*Ze),De=Je+Re*(-.29227*Ee-.90649*Ze),Ge=Je+Re*(1.97294*Ee),_(C([ht*255,De*255,Ge*255,1]))},ae.start=function(ve){return ve==null?A:(A=ve,ae)},ae.rotations=function(ve){return ve==null?P:(P=ve,ae)},ae.gamma=function(ve){return ve==null?G:(G=ve,ae)},ae.hue=function(ve){return ve==null?R:(R=ve,Ve(R)==="array"?(Q=R[1]-R[0],Q===0&&(R=R[1])):Q=0,ae)},ae.lightness=function(ve){return ve==null?z:(Ve(ve)==="array"?(z=ve,ie=ve[1]-ve[0]):(z=[ve,ve],ie=0),ae)},ae.scale=function(){return _.scale(ae)},ae.hue(R),ae},_.random=function(){var A,P,R;for(P="0123456789abcdef",A="#",R=0;R<6;++R)A+=P.charAt(E(Math.random()*16));return new n(A)},d=[],ee=function(A,P,R,G){var z,Q,ie,ae;for(R==null&&(R=.5),G==null&&(G="rgb"),Ve(A)!=="object"&&(A=_(A)),Ve(P)!=="object"&&(P=_(P)),ie=0,Q=d.length;ie<Q;ie++)if(z=d[ie],G===z[0]){ae=z[1](A,P,R,G);break}if(ae==null)throw"color mode "+G+" is not supported";return ae.alpha(A.alpha()+R*(P.alpha()-A.alpha()))},_.interpolate=ee,n.prototype.interpolate=function(A,P,R){return ee(this,A,P,R)},_.mix=ee,n.prototype.mix=n.prototype.interpolate,f.rgb=function(){var A,P,R,G;P=Xe(arguments),R=[];for(A in P)G=P[A],R.push(G);return R},_.rgb=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["rgb"]),function(){})},n.prototype.rgb=function(A){return A==null&&(A=!0),A?this._rgb.map(Math.round).slice(0,3):this._rgb.slice(0,3)},n.prototype.rgba=function(A){return A==null&&(A=!0),A?[Math.round(this._rgb[0]),Math.round(this._rgb[1]),Math.round(this._rgb[2]),this._rgb[3]]:this._rgb.slice(0)},h.push({p:3,test:function(A){var P;if(P=Xe(arguments),Ve(P)==="array"&&P.length===3||P.length===4&&Ve(P[3])==="number"&&P[3]>=0&&P[3]<=1)return"rgb"}}),f.lrgb=f.rgb,ce=function(A,P,R,G){var z,Q;return z=A._rgb,Q=P._rgb,new n(Le(X(z[0],2)*(1-R)+X(Q[0],2)*R),Le(X(z[1],2)*(1-R)+X(Q[1],2)*R),Le(X(z[2],2)*(1-R)+X(Q[2],2)*R),G)},l=function(A){var P,R,G,z,Q,ie;for(R=1/A.length,ie=[0,0,0,0],z=0,G=A.length;z<G;z++)P=A[z],Q=P._rgb,ie[0]+=X(Q[0],2)*R,ie[1]+=X(Q[1],2)*R,ie[2]+=X(Q[2],2)*R,ie[3]+=Q[3]*R;return ie[0]=Le(ie[0]),ie[1]=Le(ie[1]),ie[2]=Le(ie[2]),ie[3]>1&&(ie[3]=1),new n(C(ie))},d.push(["lrgb",ce]),_.average=function(A,P){var R,G,z,Q,ie,ae,ve,be,Re,Ge,Ee,De,ze;if(P==null&&(P="rgb"),Re=A.length,A=A.map(function(Je){return _(Je)}),ve=A.splice(0,1)[0],P==="lrgb")return l(A);De=ve.get(P),Q=[],ie=0,ae=0;for(be in De)De[be]=De[be]||0,Q.push(isNaN(De[be])?0:1),P.charAt(be)==="h"&&!isNaN(De[be])&&(R=De[be]/180*s,ie+=S(R),ae+=Mt(R));for(G=ve.alpha(),Ee=0,Ge=A.length;Ee<Ge;Ee++){z=A[Ee],ze=z.get(P),G+=z.alpha();for(be in De)isNaN(ze[be])||(Q[be]+=1,P.charAt(be)==="h"?(R=ze[be]/180*s,ie+=S(R),ae+=Mt(R)):De[be]+=ze[be])}for(be in De)if(P.charAt(be)==="h"){for(R=y(ae/Q[be],ie/Q[be])/s*180;R<0;)R+=360;for(;R>=360;)R-=360;De[be]=R}else De[be]=De[be]/Q[be];return _(De,P).alpha(G/Re)},k=function(A){var P,R,G,z,Q,ie;if(A.match(/^#?([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/))return(A.length===4||A.length===7)&&(A=A.substr(1)),A.length===3&&(A=A.split(""),A=A[0]+A[0]+A[1]+A[1]+A[2]+A[2]),ie=parseInt(A,16),z=ie>>16,G=ie>>8&255,R=ie&255,[z,G,R,1];if(A.match(/^#?([A-Fa-f0-9]{8})$/))return A.length===9&&(A=A.substr(1)),ie=parseInt(A,16),z=ie>>24&255,G=ie>>16&255,R=ie>>8&255,P=dt((ie&255)/255*100)/100,[z,G,R,P];if(f.css!=null&&(Q=f.css(A)))return Q;throw"unknown color: "+A},Se=function(A,P){var R,G,z,Q,ie,ae,ve;return P==null&&(P="auto"),ie=A[0],z=A[1],G=A[2],R=A[3],P==="auto"&&(P=R<1?"rgba":"rgb"),ie=Math.round(ie),z=Math.round(z),G=Math.round(G),ve=ie<<16|z<<8|G,ae="000000"+ve.toString(16),ae=ae.substr(ae.length-6),Q="0"+dt(R*255).toString(16),Q=Q.substr(Q.length-2),"#"+function(){switch(P.toLowerCase()){case"rgba":return ae+Q;case"argb":return Q+ae;default:return ae}}()},f.hex=function(A){return k(A)},_.hex=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["hex"]),function(){})},n.prototype.hex=function(A){return A==null&&(A="auto"),Se(this._rgb,A)},h.push({p:4,test:function(A){if(arguments.length===1&&Ve(A)==="string")return"hex"}}),F=function(){var A,P,R,G,z,Q,ie,ae,ve,be,Re,Ge,Ee,De;if(A=Xe(arguments),z=A[0],Re=A[1],ie=A[2],Re===0)ve=G=P=ie*255;else{for(De=[0,0,0],R=[0,0,0],Ee=ie<.5?ie*(1+Re):ie+Re-ie*Re,Ge=2*ie-Ee,z/=360,De[0]=z+1/3,De[1]=z,De[2]=z-1/3,Q=ae=0;ae<=2;Q=++ae)De[Q]<0&&(De[Q]+=1),De[Q]>1&&(De[Q]-=1),6*De[Q]<1?R[Q]=Ge+(Ee-Ge)*6*De[Q]:2*De[Q]<1?R[Q]=Ee:3*De[Q]<2?R[Q]=Ge+(Ee-Ge)*(2/3-De[Q])*6:R[Q]=Ge;be=[dt(R[0]*255),dt(R[1]*255),dt(R[2]*255)],ve=be[0],G=be[1],P=be[2]}return A.length>3?[ve,G,P,A[3]]:[ve,G,P]},Oe=function(A,P,R){var G,z,Q,ie,ae;return A!==void 0&&A.length>=3&&(ie=A,A=ie[0],P=ie[1],R=ie[2]),A/=255,P/=255,R/=255,Q=Math.min(A,P,R),le=Math.max(A,P,R),z=(le+Q)/2,le===Q?(ae=0,G=Number.NaN):ae=z<.5?(le-Q)/(le+Q):(le-Q)/(2-le-Q),A===le?G=(P-R)/(le-Q):P===le?G=2+(R-A)/(le-Q):R===le&&(G=4+(A-P)/(le-Q)),G*=60,G<0&&(G+=360),[G,ae,z]},_.hsl=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["hsl"]),function(){})},f.hsl=F,n.prototype.hsl=function(){return Oe(this._rgb)},te=function(){var A,P,R,G,z,Q,ie,ae,ve,be,Re,Ge,Ee,De,ze,Je,ht,Ze;if(A=Xe(arguments),z=A[0],Je=A[1],Ze=A[2],Ze*=255,Je===0)ve=G=P=Ze;else switch(z===360&&(z=0),z>360&&(z-=360),z<0&&(z+=360),z/=60,Q=E(z),R=z-Q,ie=Ze*(1-Je),ae=Ze*(1-Je*R),ht=Ze*(1-Je*(1-R)),Q){case 0:be=[Ze,ht,ie],ve=be[0],G=be[1],P=be[2];break;case 1:Re=[ae,Ze,ie],ve=Re[0],G=Re[1],P=Re[2];break;case 2:Ge=[ie,Ze,ht],ve=Ge[0],G=Ge[1],P=Ge[2];break;case 3:Ee=[ie,ae,Ze],ve=Ee[0],G=Ee[1],P=Ee[2];break;case 4:De=[ht,ie,Ze],ve=De[0],G=De[1],P=De[2];break;case 5:ze=[Ze,ie,ae],ve=ze[0],G=ze[1],P=ze[2]}return[ve,G,P,A.length>3?A[3]:1]},Ne=function(){var A,P,R,G,z,Q,ie,ae,ve;return ie=Xe(arguments),Q=ie[0],R=ie[1],A=ie[2],z=Math.min(Q,R,A),le=Math.max(Q,R,A),P=le-z,ve=le/255,le===0?(G=Number.NaN,ae=0):(ae=P/le,Q===le&&(G=(R-A)/P),R===le&&(G=2+(A-Q)/P),A===le&&(G=4+(Q-R)/P),G*=60,G<0&&(G+=360)),[G,ae,ve]},_.hsv=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["hsv"]),function(){})},f.hsv=te,n.prototype.hsv=function(){return Ne(this._rgb)},pe=function(A){var P,R,G;return Ve(A)==="number"&&A>=0&&A<=16777215?(G=A>>16,R=A>>8&255,P=A&255,[G,R,P,1]):(console.warn("unknown num color: "+A),[0,0,0,1])},Be=function(){var A,P,R,G;return G=Xe(arguments),R=G[0],P=G[1],A=G[2],(R<<16)+(P<<8)+A},_.num=function(A){return new n(A,"num")},n.prototype.num=function(A){return A==null&&(A="rgb"),Be(this._rgb,A)},f.num=pe,h.push({p:1,test:function(A){if(arguments.length===1&&Ve(A)==="number"&&A>=0&&A<=16777215)return"num"}}),O=function(){var A,P,R,G,z,Q,ie,ae,ve,be,Re,Ge,Ee,De,ze,Je,ht,Ze,Wt,Tt;if(R=Xe(arguments),ae=R[0],z=R[1],P=R[2],z=z/100,ie=ie/100*255,A=z*255,z===0)Ge=ie=G=P;else switch(ae===360&&(ae=0),ae>360&&(ae-=360),ae<0&&(ae+=360),ae/=60,ve=E(ae),Q=ae-ve,be=P*(1-z),Re=be+A*(1-Q),Wt=be+A*Q,Tt=be+A,ve){case 0:Ee=[Tt,Wt,be],Ge=Ee[0],ie=Ee[1],G=Ee[2];break;case 1:De=[Re,Tt,be],Ge=De[0],ie=De[1],G=De[2];break;case 2:ze=[be,Tt,Wt],Ge=ze[0],ie=ze[1],G=ze[2];break;case 3:Je=[be,Re,Tt],Ge=Je[0],ie=Je[1],G=Je[2];break;case 4:ht=[Wt,be,Tt],Ge=ht[0],ie=ht[1],G=ht[2];break;case 5:Ze=[Tt,be,Re],Ge=Ze[0],ie=Ze[1],G=Ze[2]}return[Ge,ie,G,R.length>3?R[3]:1]},xe=function(){var A,P,R,G,z,Q,ie,ae,ve;return ve=Xe(arguments),ae=ve[0],z=ve[1],P=ve[2],ie=Math.min(ae,z,P),le=Math.max(ae,z,P),G=le-ie,R=G*100/255,A=ie/(255-G)*100,G===0?Q=Number.NaN:(ae===le&&(Q=(z-P)/G),z===le&&(Q=2+(P-ae)/G),P===le&&(Q=4+(ae-z)/G),Q*=60,Q<0&&(Q+=360)),[Q,R,A]},_.hcg=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["hcg"]),function(){})},f.hcg=O,n.prototype.hcg=function(){return xe(this._rgb)},M=function(A){var P,R,G,z,Q,ie,ae,ve;if(A=A.toLowerCase(),_.colors!=null&&_.colors[A])return k(_.colors[A]);if(Q=A.match(/rgb\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*\)/)){for(ae=Q.slice(1,4),z=ie=0;ie<=2;z=++ie)ae[z]=+ae[z];ae[3]=1}else if(Q=A.match(/rgba\(\s*(\-?\d+),\s*(\-?\d+)\s*,\s*(\-?\d+)\s*,\s*([01]|[01]?\.\d+)\)/))for(ae=Q.slice(1,5),z=ve=0;ve<=3;z=++ve)ae[z]=+ae[z];else if(Q=A.match(/rgb\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/)){for(ae=Q.slice(1,4),z=P=0;P<=2;z=++P)ae[z]=dt(ae[z]*2.55);ae[3]=1}else if(Q=A.match(/rgba\(\s*(\-?\d+(?:\.\d+)?)%,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/)){for(ae=Q.slice(1,5),z=R=0;R<=2;z=++R)ae[z]=dt(ae[z]*2.55);ae[3]=+ae[3]}else(Q=A.match(/hsl\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*\)/))?(G=Q.slice(1,4),G[1]*=.01,G[2]*=.01,ae=F(G),ae[3]=1):(Q=A.match(/hsla\(\s*(\-?\d+(?:\.\d+)?),\s*(\-?\d+(?:\.\d+)?)%\s*,\s*(\-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)/))&&(G=Q.slice(1,4),G[1]*=.01,G[2]*=.01,ae=F(G),ae[3]=+Q[4]);return ae},_e=function(A){var P;if(P=A[3]<1?"rgba":"rgb",P==="rgb")return P+"("+A.slice(0,3).map(dt).join(",")+")";if(P==="rgba")return P+"("+A.slice(0,3).map(dt).join(",")+","+A[3]+")"},Rt=function(A){return dt(A*100)/100},Y=function(A,P){var R;return R=P<1?"hsla":"hsl",A[0]=Rt(A[0]||0),A[1]=Rt(A[1]*100)+"%",A[2]=Rt(A[2]*100)+"%",R==="hsla"&&(A[3]=P),R+"("+A.join(",")+")"},f.css=function(A){return M(A)},_.css=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["css"]),function(){})},n.prototype.css=function(A){if(A==null&&(A="rgb"),A.slice(0,3)==="rgb")return _e(this._rgb);if(A.slice(0,3)==="hsl")return Y(this.hsl(),this.alpha())},f.named=function(A){return k(wt[A])},h.push({p:5,test:function(A){if(arguments.length===1&&wt[A]!=null)return"named"}}),n.prototype.name=function(A){var P,R;arguments.length&&(wt[A]&&(this._rgb=k(wt[A])),this._rgb[3]=1),P=this.hex("rgb");for(R in wt)if(P===wt[R])return R;return P},J=function(){var A,P,R,G;return G=Xe(arguments),R=G[0],A=G[1],P=G[2],P=P*i,[R,S(P)*A,Mt(P)*A]},W=function(){var A,P,R,G,z,Q,ie,ae,ve,be,Re;return R=Xe(arguments),ae=R[0],z=R[1],ie=R[2],be=J(ae,z,ie),A=be[0],P=be[1],G=be[2],Re=re(A,P,G),ve=Re[0],Q=Re[1],G=Re[2],[ve,Q,G,R.length>3?R[3]:1]},V=function(){var A,P,R,G,z,Q;return Q=Xe(arguments),z=Q[0],A=Q[1],P=Q[2],R=Le(A*A+P*P),G=(y(P,A)*a+360)%360,dt(R*1e4)===0&&(G=Number.NaN),[z,R,G]},Fe=function(){var A,P,R,G,z,Q,ie;return Q=Xe(arguments),z=Q[0],R=Q[1],P=Q[2],ie=we(z,R,P),G=ie[0],A=ie[1],P=ie[2],V(G,A,P)},_.lch=function(){var A;return A=Xe(arguments),new n(A,"lch")},_.hcl=function(){var A;return A=Xe(arguments),new n(A,"hcl")},f.lch=W,f.hcl=function(){var A,P,R,G;return G=Xe(arguments),P=G[0],A=G[1],R=G[2],W([R,A,P])},n.prototype.lch=function(){return Fe(this._rgb)},n.prototype.hcl=function(){return Fe(this._rgb).reverse()},ye=function(A){var P,R,G,z,Q,ie,ae,ve,be;return A==null&&(A="rgb"),ve=Xe(arguments),ae=ve[0],z=ve[1],P=ve[2],ae=ae/255,z=z/255,P=P/255,Q=1-Math.max(ae,Math.max(z,P)),G=Q<1?1/(1-Q):0,R=(1-ae-Q)*G,ie=(1-z-Q)*G,be=(1-P-Q)*G,[R,ie,be,Q]},w=function(){var A,P,R,G,z,Q,ie,ae,ve;return P=Xe(arguments),G=P[0],ie=P[1],ve=P[2],Q=P[3],A=P.length>4?P[4]:1,Q===1?[0,0,0,A]:(ae=G>=1?0:255*(1-G)*(1-Q),z=ie>=1?0:255*(1-ie)*(1-Q),R=ve>=1?0:255*(1-ve)*(1-Q),[ae,z,R,A])},f.cmyk=function(){return w(Xe(arguments))},_.cmyk=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["cmyk"]),function(){})},n.prototype.cmyk=function(){return ye(this._rgb)},f.gl=function(){var A,P,R,G,z;for(G=(function(){var Q,ie;Q=Xe(arguments),ie=[];for(P in Q)z=Q[P],ie.push(z);return ie}).apply(this,arguments),A=R=0;R<=2;A=++R)G[A]*=255;return G},_.gl=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["gl"]),function(){})},n.prototype.gl=function(){var A;return A=this._rgb,[A[0]/255,A[1]/255,A[2]/255,A[3]]},je=function(A,P,R){var G;return G=Xe(arguments),A=G[0],P=G[1],R=G[2],A=he(A),P=he(P),R=he(R),.2126*A+.7152*P+.0722*R},he=function(A){return A/=255,A<=.03928?A/12.92:X((A+.055)/1.055,2.4)},oe=function(A,P,R,G){var z,Q;return z=A._rgb,Q=P._rgb,new n(z[0]+R*(Q[0]-z[0]),z[1]+R*(Q[1]-z[1]),z[2]+R*(Q[2]-z[2]),G)},d.push(["rgb",oe]),n.prototype.luminance=function(A,P){var R,G,z,Q,ie;return P==null&&(P="rgb"),arguments.length?(Q=this._rgb,A===0?Q=[0,0,0,this._rgb[3]]:A===1?Q=[255,255,255,this[3]]:(R=je(this._rgb),G=1e-7,z=20,ie=function(ae,ve){var be,Re;return Re=ae.interpolate(ve,.5,P),be=Re.luminance(),Math.abs(A-be)<G||!z--?Re:be>A?ie(ae,Re):ie(Re,ve)},R>A?Q=ie(_("black"),this).rgba():Q=ie(this,_("white")).rgba()),_(Q).alpha(this.alpha())):je(this._rgb)},Ye=function(A){var P,R,G,z;return z=A/100,z<66?(G=255,R=-155.25485562709179-.44596950469579133*(R=z-2)+104.49216199393888*$(R),P=z<20?0:-254.76935184120902+.8274096064007395*(P=z-10)+115.67994401066147*$(P)):(G=351.97690566805693+.114206453784165*(G=z-55)-40.25366309332127*$(G),R=325.4494125711974+.07943456536662342*(R=z-50)-28.0852963507957*$(R),P=255),[G,R,P]},tt=function(){var A,P,R,G,z,Q,ie,ae;for(Q=Xe(arguments),z=Q[0],Q[1],A=Q[2],G=1e3,R=4e4,P=.4;R-G>P;)ae=(R+G)*.5,ie=Ye(ae),ie[2]/ie[0]>=A/z?R=ae:G=ae;return dt(ae)},_.temperature=_.kelvin=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["temperature"]),function(){})},f.temperature=f.kelvin=f.K=Ye,n.prototype.temperature=function(){return tt(this._rgb)},n.prototype.kelvin=n.prototype.temperature,_.contrast=function(A,P){var R,G,z,Q;return((z=Ve(A))==="string"||z==="number")&&(A=new n(A)),((Q=Ve(P))==="string"||Q==="number")&&(P=new n(P)),R=A.luminance(),G=P.luminance(),R>G?(R+.05)/(G+.05):(G+.05)/(R+.05)},_.distance=function(A,P,R){var G,z,Q,ie,ae,ve,be;R==null&&(R="lab"),((ae=Ve(A))==="string"||ae==="number")&&(A=new n(A)),((ve=Ve(P))==="string"||ve==="number")&&(P=new n(P)),Q=A.get(R),ie=P.get(R),be=0;for(z in Q)G=(Q[z]||0)-(ie[z]||0),be+=G*G;return Math.sqrt(be)},_.deltaE=function(A,P,R,G){var z,Q,ie,ae,ve,be,Re,Ge,Ee,De,ze,Je,ht,Ze,Wt,Tt,ei,Si,gt,Pe,Ke,ft,Ct,ct,St,bt,Dt;for(R==null&&(R=1),G==null&&(G=1),((ei=Ve(A))==="string"||ei==="number")&&(A=new n(A)),((Si=Ve(P))==="string"||Si==="number")&&(P=new n(P)),gt=A.lab(),z=gt[0],ie=gt[1],ve=gt[2],Pe=P.lab(),Q=Pe[0],ae=Pe[1],be=Pe[2],Re=Le(ie*ie+ve*ve),Ge=Le(ae*ae+be*be),Ct=z<16?.511:.040975*z/(1+.01765*z),Ke=.0638*Re/(1+.0131*Re)+.638,Tt=Re<1e-6?0:y(ve,ie)*180/s;Tt<0;)Tt+=360;for(;Tt>=360;)Tt-=360;return ct=Tt>=164&&Tt<=345?.56+p(.2*S(s*(Tt+168)/180)):.36+p(.4*S(s*(Tt+35)/180)),Ee=Re*Re*Re*Re,Wt=Le(Ee/(Ee+1900)),ft=Ke*(Wt*ct+1-Wt),Ze=z-Q,ht=Re-Ge,ze=ie-ae,Je=ve-be,De=ze*ze+Je*Je-ht*ht,St=Ze/(R*Ct),bt=ht/(G*Ke),Dt=ft,Le(St*St+bt*bt+De/(Dt*Dt))},n.prototype.get=function(A){var P,R,G,z,Q,ie;return G=this,Q=A.split("."),z=Q[0],P=Q[1],ie=G[z](),P?(R=z.indexOf(P),R>-1?ie[R]:console.warn("unknown channel "+P+" in mode "+z)):ie},n.prototype.set=function(A,P){var R,G,z,Q,ie,ae;if(z=this,ie=A.split("."),Q=ie[0],R=ie[1],R)if(ae=z[Q](),G=Q.indexOf(R),G>-1)if(Ve(P)==="string")switch(P.charAt(0)){case"+":ae[G]+=+P;break;case"-":ae[G]+=+P;break;case"*":ae[G]*=+P.substr(1);break;case"/":ae[G]/=+P.substr(1);break;default:ae[G]=+P}else ae[G]=P;else console.warn("unknown channel "+R+" in mode "+Q);else ae=P;return _(ae,Q).alpha(z.alpha())},n.prototype.clipped=function(){return this._rgb._clipped||!1},n.prototype.alpha=function(A){return arguments.length?_.rgb([this._rgb[0],this._rgb[1],this._rgb[2],A]):this._rgb[3]},n.prototype.darken=function(A){var P,R;return A==null&&(A=1),R=this,P=R.lab(),P[0]-=r.Kn*A,_.lab(P).alpha(R.alpha())},n.prototype.brighten=function(A){return A==null&&(A=1),this.darken(-A)},n.prototype.darker=n.prototype.darken,n.prototype.brighter=n.prototype.brighten,n.prototype.saturate=function(A){var P,R;return A==null&&(A=1),R=this,P=R.lch(),P[1]+=A*r.Kn,P[1]<0&&(P[1]=0),_.lch(P).alpha(R.alpha())},n.prototype.desaturate=function(A){return A==null&&(A=1),this.saturate(-A)},n.prototype.premultiply=function(){var A,P;return P=this.rgb(),A=this.alpha(),_(P[0]*A,P[1]*A,P[2]*A,A)},m=function(A,P,R){if(!m[R])throw"unknown blend mode "+R;return m[R](A,P)},x=function(A){return function(P,R){var G,z;return G=_(R).rgb(),z=_(P).rgb(),_(A(G,z),"rgb")}},U=function(A){return function(P,R){var G,z,Q;for(Q=[],G=z=0;z<=3;G=++z)Q[G]=A(P[G],R[G]);return Q}},N=function(A,P){return A},D=function(A,P){return A*P/255},B=function(A,P){return A>P?P:A},H=function(A,P){return A>P?A:P},xt=function(A,P){return 255*(1-(1-A/255)*(1-P/255))},ue=function(A,P){return P<128?2*A*P/255:255*(1-2*(1-A/255)*(1-P/255))},b=function(A,P){return 255*(1-(1-P/255)/(A/255))},L=function(A,P){return A===255||(A=255*(P/255)/(1-A/255),A>255)?255:A},m.normal=x(U(N)),m.multiply=x(U(D)),m.screen=x(U(xt)),m.overlay=x(U(ue)),m.darken=x(U(B)),m.lighten=x(U(H)),m.dodge=x(U(L)),m.burn=x(U(b)),_.blend=m,_.analyze=function(A){var P,R,G,z;for(G={min:Number.MAX_VALUE,max:Number.MAX_VALUE*-1,sum:0,values:[],count:0},R=0,P=A.length;R<P;R++)z=A[R],z!=null&&!isNaN(z)&&(G.values.push(z),G.sum+=z,z<G.min&&(G.min=z),z>G.max&&(G.max=z),G.count+=1);return G.domain=[G.min,G.max],G.limits=function(Q,ie){return _.limits(G,Q,ie)},G},_.scale=function(A,P){var R,G,z,Q,ie,ae,ve,be,Re,Ge,Ee,De,ze,Je,ht,Ze,Wt,Tt,ei,Si,gt;return Re="rgb",Ge=_("#ccc"),Je=0,ie=[0,1],ze=[],De=[0,0],R=!1,z=[],Ee=!1,be=0,ve=1,Q=!1,G={},ht=!0,ae=1,Si=function(Pe){var Ke,ft,Ct,ct,St,bt;if(Pe==null&&(Pe=["#fff","#000"]),Pe!=null&&Ve(Pe)==="string"&&_.brewer!=null&&(Pe=_.brewer[Pe]||_.brewer[Pe.toLowerCase()]||Pe),Ve(Pe)==="array"){for(Pe.length===1&&(Pe=[Pe[0],Pe[0]]),Pe=Pe.slice(0),Ke=Ct=0,ct=Pe.length-1;0<=ct?Ct<=ct:Ct>=ct;Ke=0<=ct?++Ct:--Ct)ft=Pe[Ke],Ve(ft)==="string"&&(Pe[Ke]=_(ft));for(ze.length=0,Ke=bt=0,St=Pe.length-1;0<=St?bt<=St:bt>=St;Ke=0<=St?++bt:--bt)ze.push(Ke/(Pe.length-1))}return ei(),z=Pe},Wt=function(Pe){var Ke,ft;if(R!=null){for(ft=R.length-1,Ke=0;Ke<ft&&Pe>=R[Ke];)Ke++;return Ke-1}return 0},gt=function(Pe){return Pe},Tt=function(Pe,Ke){var ft,Ct,ct,St,bt,Dt,wn,pt;if(Ke==null&&(Ke=!1),isNaN(Pe)||Pe===null)return Ge;if(Ke?pt=Pe:R&&R.length>2?(ft=Wt(Pe),pt=ft/(R.length-2)):ve!==be?pt=(Pe-be)/(ve-be):pt=1,Ke||(pt=gt(pt)),ae!==1&&(pt=X(pt,ae)),pt=De[0]+pt*(1-De[0]-De[1]),pt=Math.min(1,Math.max(0,pt)),St=Math.floor(pt*1e4),ht&&G[St])Ct=G[St];else{if(Ve(z)==="array")for(ct=bt=0,wn=ze.length-1;0<=wn?bt<=wn:bt>=wn;ct=0<=wn?++bt:--bt){if(Dt=ze[ct],pt<=Dt){Ct=z[ct];break}if(pt>=Dt&&ct===ze.length-1){Ct=z[ct];break}if(pt>Dt&&pt<ze[ct+1]){pt=(pt-Dt)/(ze[ct+1]-Dt),Ct=_.interpolate(z[ct],z[ct+1],pt,Re);break}}else Ve(z)==="function"&&(Ct=z(pt));ht&&(G[St]=Ct)}return Ct},ei=function(){return G={}},Si(A),Ze=function(Pe){var Ke;return Ke=_(Tt(Pe)),Ee&&Ke[Ee]?Ke[Ee]():Ke},Ze.classes=function(Pe){var Ke;return Pe!=null?(Ve(Pe)==="array"?(R=Pe,ie=[Pe[0],Pe[Pe.length-1]]):(Ke=_.analyze(ie),Pe===0?R=[Ke.min,Ke.max]:R=_.limits(Ke,"e",Pe)),Ze):R},Ze.domain=function(Pe){var Ke,ft,Ct,ct,St,bt,Dt;if(!arguments.length)return ie;if(be=Pe[0],ve=Pe[Pe.length-1],ze=[],Ct=z.length,Pe.length===Ct&&be!==ve)for(St=0,ct=Pe.length;St<ct;St++)ft=Pe[St],ze.push((ft-be)/(ve-be));else for(Ke=Dt=0,bt=Ct-1;0<=bt?Dt<=bt:Dt>=bt;Ke=0<=bt?++Dt:--Dt)ze.push(Ke/(Ct-1));return ie=[be,ve],Ze},Ze.mode=function(Pe){return arguments.length?(Re=Pe,ei(),Ze):Re},Ze.range=function(Pe,Ke){return Si(Pe,Ke),Ze},Ze.out=function(Pe){return Ee=Pe,Ze},Ze.spread=function(Pe){return arguments.length?(Je=Pe,Ze):Je},Ze.correctLightness=function(Pe){return Pe==null&&(Pe=!0),Q=Pe,ei(),Q?gt=function(Ke){var ft,Ct,ct,St,bt,Dt,wn,pt,cn;for(ft=Tt(0,!0).lab()[0],Ct=Tt(1,!0).lab()[0],wn=ft>Ct,ct=Tt(Ke,!0).lab()[0],bt=ft+(Ct-ft)*Ke,St=ct-bt,pt=0,cn=1,Dt=20;Math.abs(St)>.01&&Dt-- >0;)(function(){return wn&&(St*=-1),St<0?(pt=Ke,Ke+=(cn-Ke)*.5):(cn=Ke,Ke+=(pt-Ke)*.5),ct=Tt(Ke,!0).lab()[0],St=ct-bt})();return Ke}:gt=function(Ke){return Ke},Ze},Ze.padding=function(Pe){return Pe!=null?(Ve(Pe)==="number"&&(Pe=[Pe,Pe]),De=Pe,Ze):De},Ze.colors=function(Pe,Ke){var ft,Ct,ct,St,bt,Dt,wn,pt;if(arguments.length<2&&(Ke="hex"),bt=[],arguments.length===0)bt=z.slice(0);else if(Pe===1)bt=[Ze(.5)];else if(Pe>1)Ct=ie[0],ft=ie[1]-Ct,bt=(function(){Dt=[];for(var cn=0;0<=Pe?cn<Pe:cn>Pe;0<=Pe?cn++:cn--)Dt.push(cn);return Dt}).apply(this).map(function(cn){return Ze(Ct+cn/(Pe-1)*ft)});else{if(A=[],wn=[],R&&R.length>2)for(ct=pt=1,St=R.length;1<=St?pt<St:pt>St;ct=1<=St?++pt:--pt)wn.push((R[ct-1]+R[ct])*.5);else wn=ie;bt=wn.map(function(cn){return Ze(cn)})}return _[Ke]&&(bt=bt.map(function(cn){return cn[Ke]()})),bt},Ze.cache=function(Pe){return Pe!=null?(ht=Pe,Ze):ht},Ze.gamma=function(Pe){return Pe!=null?(ae=Pe,Ze):ae},Ze.nodata=function(Pe){return Pe!=null?(Ge=_(Pe),Ze):Ge},Ze},_.scales==null&&(_.scales={}),_.scales.cool=function(){return _.scale([_.hsl(180,1,.9),_.hsl(250,.7,.4)])},_.scales.hot=function(){return _.scale(["#000","#f00","#ff0","#fff"],[0,.25,.75,1]).mode("rgb")},_.analyze=function(A,P,R){var G,z,Q,ie,ae,ve,be;if(ae={min:Number.MAX_VALUE,max:Number.MAX_VALUE*-1,sum:0,values:[],count:0},R==null&&(R=function(){return!0}),G=function(Re){Re!=null&&!isNaN(Re)&&(ae.values.push(Re),ae.sum+=Re,Re<ae.min&&(ae.min=Re),Re>ae.max&&(ae.max=Re),ae.count+=1)},be=function(Re,Ge){if(R(Re,Ge))return P!=null&&Ve(P)==="function"?G(P(Re)):P!=null&&Ve(P)==="string"||Ve(P)==="number"?G(Re[P]):G(Re)},Ve(A)==="array")for(ie=0,Q=A.length;ie<Q;ie++)ve=A[ie],be(ve);else for(z in A)ve=A[z],be(ve,z);return ae.domain=[ae.min,ae.max],ae.limits=function(Re,Ge){return _.limits(ae,Re,Ge)},ae},_.limits=function(A,P,R){var G,z,Q,ie,ae,ve,be,Re,Ge,Ee,De,ze,Je,ht,Ze,Wt,Tt,ei,Si,gt,Pe,Ke,ft,Ct,ct,St,bt,Dt,wn,pt,cn,sl,Bs,ju,sa,oa,aa,ca,la,ha,Lm,ua,da,fa,pa,ma,ga,ya,xa,ba,wr,ol,Rm,Mi,va;if(P==null&&(P="equal"),R==null&&(R=7),Ve(A)==="array"&&(A=_.analyze(A)),ct=A.min,le=A.max,A.sum,Mi=A.values.sort(function(qu,Xu){return qu-Xu}),R===1)return[ct,le];if(ft=[],P.substr(0,1)==="c"&&(ft.push(ct),ft.push(le)),P.substr(0,1)==="e"){for(ft.push(ct),gt=cn=1,sa=R-1;1<=sa?cn<=sa:cn>=sa;gt=1<=sa?++cn:--cn)ft.push(ct+gt/R*(le-ct));ft.push(le)}else if(P.substr(0,1)==="l"){if(ct<=0)throw"Logarithmic scales are only possible for values > 0";for(St=Math.LOG10E*$(ct),Ct=Math.LOG10E*$(le),ft.push(ct),gt=va=1,oa=R-1;1<=oa?va<=oa:va>=oa;gt=1<=oa?++va:--va)ft.push(X(10,St+gt/R*(Ct-St)));ft.push(le)}else if(P.substr(0,1)==="q"){for(ft.push(ct),gt=G=1,ua=R-1;1<=ua?G<=ua:G>=ua;gt=1<=ua?++G:--G)sl=(Mi.length-1)*gt/R,Bs=E(sl),Bs===sl?ft.push(Mi[Bs]):(ju=sl-Bs,ft.push(Mi[Bs]*(1-ju)+Mi[Bs+1]*ju));ft.push(le)}else if(P.substr(0,1)==="k"){for(Dt=Mi.length,ht=new Array(Dt),ei=new Array(R),ba=!0,wn=0,Wt=null,Wt=[],Wt.push(ct),gt=z=1,da=R-1;1<=da?z<=da:z>=da;gt=1<=da?++z:--z)Wt.push(ct+gt/R*(le-ct));for(Wt.push(le);ba;){for(Pe=Q=0,fa=R-1;0<=fa?Q<=fa:Q>=fa;Pe=0<=fa?++Q:--Q)ei[Pe]=0;for(gt=ie=0,pa=Dt-1;0<=pa?ie<=pa:ie>=pa;gt=0<=pa?++ie:--ie){for(Rm=Mi[gt],bt=Number.MAX_VALUE,Pe=ae=0,ma=R-1;0<=ma?ae<=ma:ae>=ma;Pe=0<=ma?++ae:--ae)Si=p(Wt[Pe]-Rm),Si<bt&&(bt=Si,Ze=Pe);ei[Ze]++,ht[gt]=Ze}for(pt=new Array(R),Pe=ve=0,ga=R-1;0<=ga?ve<=ga:ve>=ga;Pe=0<=ga?++ve:--ve)pt[Pe]=null;for(gt=be=0,ya=Dt-1;0<=ya?be<=ya:be>=ya;gt=0<=ya?++be:--be)Tt=ht[gt],pt[Tt]===null?pt[Tt]=Mi[gt]:pt[Tt]+=Mi[gt];for(Pe=Re=0,xa=R-1;0<=xa?Re<=xa:Re>=xa;Pe=0<=xa?++Re:--Re)pt[Pe]*=1/ei[Pe];for(ba=!1,Pe=Ge=0,aa=R-1;0<=aa?Ge<=aa:Ge>=aa;Pe=0<=aa?++Ge:--Ge)if(pt[Pe]!==Wt[gt]){ba=!0;break}Wt=pt,wn++,wn>200&&(ba=!1)}for(Ke={},Pe=Ee=0,ca=R-1;0<=ca?Ee<=ca:Ee>=ca;Pe=0<=ca?++Ee:--Ee)Ke[Pe]=[];for(gt=De=0,la=Dt-1;0<=la?De<=la:De>=la;gt=0<=la?++De:--De)Tt=ht[gt],Ke[Tt].push(Mi[gt]);for(wr=[],Pe=ze=0,ha=R-1;0<=ha?ze<=ha:ze>=ha;Pe=0<=ha?++ze:--ze)wr.push(Ke[Pe][0]),wr.push(Ke[Pe][Ke[Pe].length-1]);for(wr=wr.sort(function(qu,Xu){return qu-Xu}),ft.push(wr[0]),gt=Je=1,Lm=wr.length-1;Je<=Lm;gt=Je+=2)ol=wr[gt],!isNaN(ol)&&ft.indexOf(ol)===-1&&ft.push(ol)}return ft},ne=function(A,P,R){var G,z,Q,ie;return G=Xe(arguments),A=G[0],P=G[1],R=G[2],isNaN(A)&&(A=0),A/=360,A<1/3?(z=(1-P)/3,ie=(1+P*S(c*A)/S(o-c*A))/3,Q=1-(z+ie)):A<2/3?(A-=1/3,ie=(1-P)/3,Q=(1+P*S(c*A)/S(o-c*A))/3,z=1-(ie+Q)):(A-=2/3,Q=(1-P)/3,z=(1+P*S(c*A)/S(o-c*A))/3,ie=1-(Q+z)),ie=se(R*ie*3),Q=se(R*Q*3),z=se(R*z*3),[ie*255,Q*255,z*255,G.length>3?G[3]:1]},Me=function(){var A,P,R,G,z,Q,ie,ae;return ie=Xe(arguments),Q=ie[0],P=ie[1],A=ie[2],c=Math.PI*2,Q/=255,P/=255,A/=255,z=Math.min(Q,P,A),G=(Q+P+A)/3,ae=1-z/G,ae===0?R=0:(R=(Q-P+(Q-A))/2,R/=Math.sqrt((Q-P)*(Q-P)+(Q-A)*(P-A)),R=Math.acos(R),A>P&&(R=c-R),R/=c),[R*360,ae,G]},_.hsi=function(){return function(A,P,R){R.prototype=A.prototype;var G=new R,z=A.apply(G,P);return Object(z)===z?z:G}(n,ge.call(arguments).concat(["hsi"]),function(){})},f.hsi=ne,n.prototype.hsi=function(){return Me(this._rgb)},j=function(A,P,R,G){var z,Q,ie,ae,ve,be,Re,Ge,Ee,De,ze,Je;return G==="hsl"?(ze=A.hsl(),Je=P.hsl()):G==="hsv"?(ze=A.hsv(),Je=P.hsv()):G==="hcg"?(ze=A.hcg(),Je=P.hcg()):G==="hsi"?(ze=A.hsi(),Je=P.hsi()):(G==="lch"||G==="hcl")&&(G="hcl",ze=A.hcl(),Je=P.hcl()),G.substr(0,1)==="h"&&(ie=ze[0],Ee=ze[1],be=ze[2],ae=Je[0],De=Je[1],Re=Je[2]),!isNaN(ie)&&!isNaN(ae)?(ae>ie&&ae-ie>180?z=ae-(ie+360):ae<ie&&ie-ae>180?z=ae+360-ie:z=ae-ie,Q=ie+R*z):isNaN(ie)?isNaN(ae)?Q=Number.NaN:(Q=ae,(be===1||be===0)&&G!=="hsv"&&(Ge=De)):(Q=ie,(Re===1||Re===0)&&G!=="hsv"&&(Ge=Ee)),Ge==null&&(Ge=Ee+R*(De-Ee)),ve=be+R*(Re-be),_[G](Q,Ge,ve)},d=d.concat(function(){var A,P,R,G;for(R=["hsv","hsl","hsi","hcl","lch","hcg"],G=[],P=0,A=R.length;P<A;P++)me=R[P],G.push([me,j]);return G}()),de=function(A,P,R,G){var z,Q;return z=A.num(),Q=P.num(),_.num(z+(Q-z)*R,"num")},d.push(["num",de]),Z=function(A,P,R,G){var z,Q;return z=A.lab(),Q=P.lab(),new n(z[0]+R*(Q[0]-z[0]),z[1]+R*(Q[1]-z[1]),z[2]+R*(Q[2]-z[2]),G)},d.push(["lab",Z])}).call(Ty)})(lu,lu.exports);var zM=lu.exports,wx={exports:{}};(function(t){/** @license
 * JS Signals <http://millermedeiros.github.com/js-signals/>
 * Released under the MIT license
 * Author: Miller Medeiros
 * Version: 1.0.0 - Build: 268 (2012/11/29 05:48 PM)
 */(function(e){function n(o,a,c,l,h){this._listener=a,this._isOnce=c,this.context=l,this._signal=o,this._priority=h||0}n.prototype={active:!0,params:null,execute:function(o){var a,c;return this.active&&this._listener&&(c=this.params?this.params.concat(o):o,a=this._listener.apply(this.context,c),this._isOnce&&this.detach()),a},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}};function i(o,a){if(typeof o!="function")throw new Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",a))}function r(){this._bindings=[],this._prevParams=null;var o=this;this.dispatch=function(){r.prototype.dispatch.apply(o,arguments)}}r.prototype={VERSION:"1.0.0",memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(o,a,c,l){var h=this._indexOfListener(o,c),u;if(h!==-1){if(u=this._bindings[h],u.isOnce()!==a)throw new Error("You cannot add"+(a?"":"Once")+"() then add"+(a?"Once":"")+"() the same listener without removing the relationship first.")}else u=new n(this,o,a,c,l),this._addBinding(u);return this.memorize&&this._prevParams&&u.execute(this._prevParams),u},_addBinding:function(o){var a=this._bindings.length;do--a;while(this._bindings[a]&&o._priority<=this._bindings[a]._priority);this._bindings.splice(a+1,0,o)},_indexOfListener:function(o,a){for(var c=this._bindings.length,l;c--;)if(l=this._bindings[c],l._listener===o&&l.context===a)return c;return-1},has:function(o,a){return this._indexOfListener(o,a)!==-1},add:function(o,a,c){return i(o,"add"),this._registerListener(o,!1,a,c)},addOnce:function(o,a,c){return i(o,"addOnce"),this._registerListener(o,!0,a,c)},remove:function(o,a){i(o,"remove");var c=this._indexOfListener(o,a);return c!==-1&&(this._bindings[c]._destroy(),this._bindings.splice(c,1)),o},removeAll:function(){for(var o=this._bindings.length;o--;)this._bindings[o]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(o){if(this.active){var a=Array.prototype.slice.call(arguments),c=this._bindings.length,l;if(this.memorize&&(this._prevParams=a),!!c){l=this._bindings.slice(),this._shouldPropagate=!0;do c--;while(l[c]&&this._shouldPropagate&&l[c].execute(a)!==!1)}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};var s=r;s.Signal=r,t.exports?t.exports=s:e.signals=s})(Ty)})(wx);var ot=wx.exports,Sx={};(function(t){(function(){var e={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/};function n(a){return r(o(a),arguments)}function i(a,c){return n.apply(null,[a].concat(c||[]))}function r(a,c){var l=1,h=a.length,u,f="",d,p,y,g,m,x,v,b;for(d=0;d<h;d++)if(typeof a[d]=="string")f+=a[d];else if(typeof a[d]=="object"){if(y=a[d],y.keys)for(u=c[l],p=0;p<y.keys.length;p++){if(u==null)throw new Error(n('[sprintf] Cannot access property "%s" of undefined value "%s"',y.keys[p],y.keys[p-1]));u=u[y.keys[p]]}else y.param_no?u=c[y.param_no]:u=c[l++];if(e.not_type.test(y.type)&&e.not_primitive.test(y.type)&&u instanceof Function&&(u=u()),e.numeric_arg.test(y.type)&&typeof u!="number"&&isNaN(u))throw new TypeError(n("[sprintf] expecting number but found %T",u));switch(e.number.test(y.type)&&(v=u>=0),y.type){case"b":u=parseInt(u,10).toString(2);break;case"c":u=String.fromCharCode(parseInt(u,10));break;case"d":case"i":u=parseInt(u,10);break;case"j":u=JSON.stringify(u,null,y.width?parseInt(y.width):0);break;case"e":u=y.precision?parseFloat(u).toExponential(y.precision):parseFloat(u).toExponential();break;case"f":u=y.precision?parseFloat(u).toFixed(y.precision):parseFloat(u);break;case"g":u=y.precision?String(Number(u.toPrecision(y.precision))):parseFloat(u);break;case"o":u=(parseInt(u,10)>>>0).toString(8);break;case"s":u=String(u),u=y.precision?u.substring(0,y.precision):u;break;case"t":u=String(!!u),u=y.precision?u.substring(0,y.precision):u;break;case"T":u=Object.prototype.toString.call(u).slice(8,-1).toLowerCase(),u=y.precision?u.substring(0,y.precision):u;break;case"u":u=parseInt(u,10)>>>0;break;case"v":u=u.valueOf(),u=y.precision?u.substring(0,y.precision):u;break;case"x":u=(parseInt(u,10)>>>0).toString(16);break;case"X":u=(parseInt(u,10)>>>0).toString(16).toUpperCase();break}e.json.test(y.type)?f+=u:(e.number.test(y.type)&&(!v||y.sign)?(b=v?"+":"-",u=u.toString().replace(e.sign,"")):b="",m=y.pad_char?y.pad_char==="0"?"0":y.pad_char.charAt(1):" ",x=y.width-(b+u).length,g=y.width&&x>0?m.repeat(x):"",f+=y.align?b+u+g:m==="0"?b+g+u:g+b+u)}return f}var s=Object.create(null);function o(a){if(s[a])return s[a];for(var c=a,l,h=[],u=0;c;){if((l=e.text.exec(c))!==null)h.push(l[0]);else if((l=e.modulo.exec(c))!==null)h.push("%");else if((l=e.placeholder.exec(c))!==null){if(l[2]){u|=1;var f=[],d=l[2],p=[];if((p=e.key.exec(d))!==null)for(f.push(p[1]);(d=d.substring(p[0].length))!=="";)if((p=e.key_access.exec(d))!==null)f.push(p[1]);else if((p=e.index_access.exec(d))!==null)f.push(p[1]);else throw new SyntaxError("[sprintf] failed to parse named argument key");else throw new SyntaxError("[sprintf] failed to parse named argument key");l[2]=f}else u|=2;if(u===3)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");h.push({placeholder:l[0],param_no:l[1],keys:l[2],sign:l[3],pad_char:l[4],align:l[5],width:l[6],precision:l[7],type:l[8]})}else throw new SyntaxError("[sprintf] unexpected placeholder");c=c.substring(l[0].length)}return s[a]=h}t.sprintf=n,t.vsprintf=i,typeof window<"u"&&(window.sprintf=n,window.vsprintf=i)})()})(Sx);function GM(t){if(typeof window>"u")return;const e=new RegExp(`${t}=([^&#=]*)`).exec(window.location.search);return e?decodeURIComponent(e[1]):void 0}function I(t,e){return t!==void 0?t:e}function Kn(t,e){const n=Object.assign({},t);for(const i in e)t[i]===void 0&&(n[i]=e[i]);return n}function Mx(t,e){for(const n in e){const i=e[n];i!==void 0&&(t[n]=i)}return t}function am(){const t=window.location.protocol;return t.match(/http(s)?:/gi)===null?"http:":t}function UM(){if(typeof window>"u")return!1;const t=window.navigator.userAgent;return/Opera|OPR/.test(t)?"Opera":/Chrome/i.test(t)?"Chrome":/Firefox/i.test(t)?"Firefox":/Mobile(\/.*)? Safari/i.test(t)?"Mobile Safari":/MSIE/i.test(t)?"Internet Explorer":!!/Safari/i.test(t)&&"Safari"}function VM(t,e){return t<e?-1:t>e?1:0}function ls(t,e,n=VM){let i=0,r=t.length-1;for(;i<=r;){const s=i+r>>1,o=n(e,t[s]);if(o>0)i=s+1;else{if(!(o<0))return s;r=s-1}}return-i-1}function cm(t,e,n){const i=function(s,o){let a=s.length-1;if(s[a]<o)return-1;let c=0;for(;c<=a;){const l=c+a>>1;s[l]>=o?a=l-1:c=l+1}return a+1}(t,e),r=function(s,o){if(s[0]>o)return-1;let a=0,c=s.length-1;for(;a<=c;){const l=a+c>>1;s[l]>o?c=l-1:a=l+1}return a-1}(t,n);return i===-1||r===-1||i>r?0:r-i+1}function lm(t){return t.sort().filter(function(e,n,i){return n===0||e!==i[n-1]})}function hu(t){if(t.length>28672){const n=[];for(let i=0;i<t.length;i+=28672)n.push(String.fromCharCode.apply(null,t.subarray(i,i+28672)));return n.join("")}return String.fromCharCode.apply(null,t)}function Ax(t,e){switch(t){case"int8":return new Int8Array(e);case"int16":return new Int16Array(e);case"int32":return new Int32Array(e);case"uint8":return new Uint8Array(e);case"uint16":return new Uint16Array(e);case"uint32":return new Uint32Array(e);case"float32":return new Float32Array(e);default:throw new Error("arrayType unknown: "+t)}}function $i(t,e){return new(e>65535?Uint32Array:Uint16Array)(t)}function Qo(t){return t.buffer&&t.buffer instanceof ArrayBuffer?t.buffer:t}function Eu(t,e){return t===void 0?t=new e:Array.isArray(t)&&(t=new e().fromArray(t)),t}function ps(t){return Eu(t,T)}function Wa(t){return Eu(t,Ie)}function Sp(t){return Eu(t,Gt)}function Td(t){return e=t,n=Float32Array,e instanceof n?e:new n(e);var e,n}function p0(t){return I(t,"").toString().toLowerCase()}class Zr{constructor(e){this.name=e,this._dict={}}add(e,n){this._dict[p0(e)]=n}get(e){return this._dict[p0(e)]}get names(){return Object.keys(this._dict)}}function rn(t){return .01745*t}const HM="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),jl=new Array(36);function hm(){let t,e=0;for(let n=0;n<36;n++)n===8||n===13||n===18||n===23?jl[n]="-":n===14?jl[n]="4":(e<=2&&(e=33554432+16777216*Math.random()|0),t=15&e,e>>=4,jl[n]=HM[n===19?3&t|8:t]);return jl.join("")}function Mp(t,e,n){return Math.max(e,Math.min(n,t))}function ri(t,e,n){return t+(e-t)*n}function rr(t,e,n,i,r,s){const o=(n-t)*s,a=(i-e)*s,c=r*r;return(2*e-2*n+o+a)*(r*c)+(-3*e+3*n-2*o-a)*c+o*r+e}function Jc(t,e,n){var i;return i=function(r,s,o){return(r-s)/(o-s)}(n,t,e),(n=Mp(i,0,1))*n*(3-2*n)}var Cx="sRGB";const $M={scale:"uniform",mode:"hcl",domain:[0,1],value:16777215,reverse:!1},yh=new ke;function It(t,e,n){const i=n.value;return n.value=function(r,s){let o=i.bind(this,r,s)();return Cx=="linear"?(yh.set(o),yh.convertSRGBToLinear(),yh.getHex()):o},n}class Et{constructor(e={}){this.parameters=Kn(e,$M),typeof this.parameters.value=="string"&&(this.parameters.value=yh.set(this.parameters.value).getHex()),this.parameters.structure&&(this.atomProxy=this.parameters.structure.getAtomProxy())}getScale(e={}){const n=Kn(e,this.parameters);return n.scale==="rainbow"?n.scale=["red","orange","yellow","green","blue"]:n.scale==="rwb"&&(n.scale=["red","white","blue"]),n.reverse&&(n.domain=n.domain.slice().reverse()),zM.scale(n.scale).mode(n.mode).domain(n.domain).out("num")}colorToArray(e,n=[],i=0){return n[i]=(e>>16&255)/255,n[i+1]=(e>>8&255)/255,n[i+2]=(255&e)/255,n}atomColorToArray(e,n,i){return this.colorToArray(this.atomColor?this.atomColor(e):0,n,i)}bondColor(e,n){return this.atomProxy&&this.atomColor?(this.atomProxy.index=n?e.atomIndex1:e.atomIndex2,this.atomColor(this.atomProxy)):0}bondColorToArray(e,n,i,r){return this.colorToArray(this.bondColor(e,n),i,r)}volumeColorToArray(e,n,i){return this.colorToArray(this.volumeColor?this.volumeColor(e):0,n,i)}positionColorToArray(e,n,i){return this.colorToArray(this.positionColor?this.positionColor(e):0,n,i)}}var et;(function(t){t[t.PROTEIN=1]="PROTEIN",t[t.NUCLEIC=2]="NUCLEIC",t[t.RNA=3]="RNA",t[t.DNA=4]="DNA",t[t.POLYMER=5]="POLYMER",t[t.WATER=6]="WATER",t[t.HELIX=7]="HELIX",t[t.SHEET=8]="SHEET",t[t.TURN=9]="TURN",t[t.BACKBONE=10]="BACKBONE",t[t.SIDECHAIN=11]="SIDECHAIN",t[t.ALL=12]="ALL",t[t.HETERO=13]="HETERO",t[t.ION=14]="ION",t[t.SACCHARIDE=15]="SACCHARIDE",t[t.SUGAR=15]="SUGAR",t[t.BONDED=16]="BONDED",t[t.RING=17]="RING",t[t.AROMATICRING=18]="AROMATICRING",t[t.METAL=19]="METAL",t[t.POLARH=20]="POLARH",t[t.NONE=21]="NONE"})(et||(et={}));const m0=["*","","ALL"],WM=["NONE"],um=[et.BACKBONE,et.SIDECHAIN,et.BONDED,et.RING,et.AROMATICRING,et.METAL,et.POLARH],Tx=[et.POLYMER,et.WATER],jM=["ALA","GLY","SER"],qM=["CYS","SER","THR"],XM=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],YM=["PHE","TRP","TYR","HIS"],ZM=["ASN","GLN"],KM=["ASP","GLU"],JM=["ARG","HIS","LYS"],QM=["ARG","ASP","GLU","HIS","LYS"],eA=["ASN","ARG","ASP","CYS","GLY","GLN","GLU","HIS","LYS","SER","THR","TYR"],tA=["ALA","ILE","LEU","MET","PHE","PRO","TRP","VAL"],nA=["HIS","PHE","PRO","TRP","TYR"],iA=["ALA","GLY","ILE","LEU","VAL"];function rA(t,e){if(e.atomname===void 0&&e.element===void 0&&e.altloc===void 0&&e.atomindex===void 0&&e.keyword===void 0&&e.inscode===void 0&&e.resname===void 0&&e.sstruc===void 0&&e.resno===void 0&&e.chainname===void 0&&e.model===void 0)return-1;if(e.keyword!==void 0&&(e.keyword===et.BACKBONE&&!t.isBackbone()||e.keyword===et.SIDECHAIN&&!t.isSidechain()||e.keyword===et.BONDED&&!t.isBonded()||e.keyword===et.RING&&!t.isRing()||e.keyword===et.AROMATICRING&&!t.isAromatic()||e.keyword===et.HETERO&&!t.isHetero()||e.keyword===et.PROTEIN&&!t.isProtein()||e.keyword===et.NUCLEIC&&!t.isNucleic()||e.keyword===et.RNA&&!t.isRna()||e.keyword===et.DNA&&!t.isDna()||e.keyword===et.POLYMER&&!t.isPolymer()||e.keyword===et.WATER&&!t.isWater()||e.keyword===et.HELIX&&!t.isHelix()||e.keyword===et.SHEET&&!t.isSheet()||e.keyword===et.TURN&&!t.isTurn()||e.keyword===et.ION&&!t.isIon()||e.keyword===et.SACCHARIDE&&!t.isSaccharide()||e.keyword===et.METAL&&!t.isMetal()||e.keyword===et.POLARH&&!t.isPolarHydrogen())||e.atomname!==void 0&&e.atomname!==t.atomname||e.element!==void 0&&e.element!==t.element||e.altloc!==void 0&&e.altloc!==t.altloc||e.atomindex!==void 0&&ls(e.atomindex,t.index)<0)return!1;if(e.resname!==void 0){if(Array.isArray(e.resname)){if(!e.resname.includes(t.resname))return!1}else if(e.resname!==t.resname)return!1}if(e.sstruc!==void 0&&e.sstruc!==t.sstruc)return!1;if(e.resno!==void 0){if(Array.isArray(e.resno)&&e.resno.length===2){if(e.resno[0]>t.resno||e.resno[1]<t.resno)return!1}else if(e.resno!==t.resno)return!1}return(e.inscode===void 0||e.inscode===t.inscode)&&(e.chainname===void 0||e.chainname===t.chainname)&&(e.model===void 0||e.model===t.modelIndex)}function sA(t,e){if(e.resname===void 0&&e.resno===void 0&&e.inscode===void 0&&e.sstruc===void 0&&e.model===void 0&&e.chainname===void 0&&e.atomindex===void 0&&(e.keyword===void 0||um.includes(e.keyword)))return-1;if(e.keyword!==void 0&&(e.keyword===et.HETERO&&!t.isHetero()||e.keyword===et.PROTEIN&&!t.isProtein()||e.keyword===et.NUCLEIC&&!t.isNucleic()||e.keyword===et.RNA&&!t.isRna()||e.keyword===et.DNA&&!t.isDna()||e.keyword===et.POLYMER&&!t.isPolymer()||e.keyword===et.WATER&&!t.isWater()||e.keyword===et.HELIX&&!t.isHelix()||e.keyword===et.SHEET&&!t.isSheet()||e.keyword===et.TURN&&!t.isTurn()||e.keyword===et.ION&&!t.isIon()||e.keyword===et.SACCHARIDE&&!t.isSaccharide())||e.atomindex!==void 0&&cm(e.atomindex,t.atomOffset,t.atomEnd)===0)return!1;if(e.resname!==void 0){if(Array.isArray(e.resname)){if(!e.resname.includes(t.resname))return!1}else if(e.resname!==t.resname)return!1}if(e.sstruc!==void 0&&e.sstruc!==t.sstruc)return!1;if(e.resno!==void 0){if(Array.isArray(e.resno)&&e.resno.length===2){if(e.resno[0]>t.resno||e.resno[1]<t.resno)return!1}else if(e.resno!==t.resno)return!1}return(e.inscode===void 0||e.inscode===t.inscode)&&(e.chainname===void 0||e.chainname===t.chainname)&&(e.model===void 0||e.model===t.modelIndex)}function oA(t,e){return e.chainname!==void 0||e.model!==void 0||e.atomindex!==void 0||e.keyword!==void 0&&Tx.includes(e.keyword)&&t.entity?e.keyword!==void 0&&(e.keyword===et.POLYMER&&!t.entity.isPolymer()||e.keyword===et.WATER&&!t.entity.isWater())?!1:(e.atomindex===void 0||cm(e.atomindex,t.atomOffset,t.atomEnd)!==0)&&(e.chainname===void 0||e.chainname===t.chainname)&&(e.model===void 0||e.model===t.modelIndex):-1}function aA(t,e){return e.model===void 0&&e.atomindex===void 0?-1:(e.atomindex===void 0||cm(e.atomindex,t.atomOffset,t.atomEnd)!==0)&&(e.model===void 0||e.model===t.index)}function Qc(t,e){if(t===null||t.error||!t.rules||t.rules.length===0)return!1;const n=t.rules.length,i=!t.negate,r=!!t.negate,s=[];for(let o=0;o<n;++o){const a=t.rules[o];a.hasOwnProperty("operator")&&(s[o]=Qc(a,e))}return function(o){const a=t.operator==="AND";let c=!1;for(let l=0;l<n;++l){const h=t.rules[l];let u;if(h.hasOwnProperty("operator")){const f=s[l];if(u=f!==!1?f(o):-1,u===-1){c=!0;continue}if(u===!0){if(a)continue;return i}if(a)return r}else{if(h.keyword===et.ALL){if(a)continue;return i}if(h.keyword===et.NONE){if(a)continue;return r}if(u=e(o,h),u!==-1){if(u===!0){if(a)continue;return i}if(a)return r}else c=!0}}return c?-1:a?i:r}}function el(t,e){if(t.error||!t.rules||t.rules.length===0)return t;const n=t.rules.length,i={operator:t.operator,rules:[]};t.hasOwnProperty("negate")&&(i.negate=t.negate);for(let r=0;r<n;++r){const s=t.rules[r];if(s.hasOwnProperty("operator")){const o=el(s,e);o!==null&&i.rules.push(o)}else e(s)||i.rules.push(s)}return i.rules.length>0?t:null}function g0(t,e=!1){let n=t;return e&&(n=el(t,function(i){return i.keyword!==void 0&&!um.includes(i.keyword)||i.model!==void 0||i.chainname!==void 0||i.resname!==void 0||i.resno!==void 0||i.sstruc!==void 0})),Qc(n,rA)}function y0(t,e=!1){let n=t;return e&&(n=el(t,function(i){return!(i.keyword===void 0||!um.includes(i.keyword))||i.model!==void 0||i.chainname!==void 0||i.atomname!==void 0||i.element!==void 0||i.altloc!==void 0})),Qc(n,sA)}function x0(t,e=!1){let n=t;return e&&(n=el(t,function(i){return i.keyword!==void 0&&!Tx.includes(i.keyword)||i.resname!==void 0||i.resno!==void 0||i.atomname!==void 0||i.element!==void 0||i.altloc!==void 0||i.sstruc!==void 0||i.inscode!==void 0})),Qc(n,oA)}function b0(t,e=!1){let n=t;return e&&(n=el(t,function(i){return i.keyword!==void 0||i.chainname!==void 0||i.resname!==void 0||i.resno!==void 0||i.atomname!==void 0||i.element!==void 0||i.altloc!==void 0||i.sstruc!==void 0||i.inscode!==void 0})),Qc(n,aA)}class qt{constructor(e){this.signals={stringChanged:new ot.Signal},this.setString(e)}get type(){return"selection"}setString(e,n){if(e===void 0&&(e=this.string||""),e===this.string)return;try{this.selection=function(r){let s={operator:void 0,rules:[]};if(!r)return s;let o,a,c=s;const l=[];(r=r.replace(/\(/g," ( ").replace(/\)/g," ) ").trim()).charAt(0)==="("&&r.substr(-1)===")"&&(r=r.slice(1,-1).trim());const h=r.split(/\s+/),u=y=>{o={operator:y,rules:[]},c===void 0?(c=o,s=o):(c.rules.push(o),l.push(c),c=o)},f=function(y){a=c,c=l.pop(),c===void 0&&(u(y),d(a))},d=function(y){c.rules.push(y)};let p=!1;for(let y=0;y<h.length;++y){const g=h[y],m=g.toUpperCase();if(g==="("){p=!1,u();continue}if(g===")"){f(),c.negate&&f();continue}if(p>0)if(m==="NOT")p=1;else if(p===1)p=2;else{if(p!==2)throw new Error("something went wrong with 'not'");p=!1,f()}if(m==="AND"){if(c.operator==="OR"){const S=c.rules.pop();u("AND"),d(S)}else c.operator="AND";continue}if(m==="OR"){c.operator==="AND"?f("OR"):c.operator="OR";continue}if(g.toUpperCase()==="NOT"){p=1,u(),c.negate=!0;continue}if(+m!=+m){const S=et[m];if(S!==void 0){d({keyword:S});continue}}if(m==="HYDROGEN"){d({operator:"OR",rules:[{element:"H"},{element:"D"}]});continue}if(m==="SMALL"){d({resname:jM});continue}if(m==="NUCLEOPHILIC"){d({resname:qM});continue}if(m==="HYDROPHOBIC"){d({resname:XM});continue}if(m==="AROMATIC"){d({resname:YM});continue}if(m==="AMIDE"){d({resname:ZM});continue}if(m==="ACIDIC"){d({resname:KM});continue}if(m==="BASIC"){d({resname:JM});continue}if(m==="CHARGED"){d({resname:QM});continue}if(m==="POLAR"){d({resname:eA});continue}if(m==="NONPOLAR"){d({resname:tA});continue}if(m==="CYCLIC"){d({resname:nA});continue}if(m==="ALIPHATIC"){d({resname:iA});continue}if(m==="SIDECHAINATTACHED"){d({operator:"OR",rules:[{keyword:et.SIDECHAIN},{operator:"AND",negate:!1,rules:[{keyword:et.PROTEIN},{operator:"OR",negate:!1,rules:[{atomname:"CA"},{atomname:"BB"}]}]},{operator:"AND",negate:!1,rules:[{resname:"PRO"},{atomname:"N"}]},{operator:"AND",negate:!1,rules:[{keyword:et.NUCLEIC},{operator:"OR",negate:!0,rules:[{atomname:"P"},{atomname:"OP1"},{atomname:"OP2"},{atomname:"O3'"},{atomname:"O3*"},{atomname:"HO3'"},{atomname:"O5'"},{atomname:"O5*"},{atomname:"HO5'"},{atomname:"C5'"},{atomname:"C5*"},{atomname:"H5'"},{atomname:"H5''"}]}]}]});continue}if(m==="APOLARH"){d({operator:"AND",negate:!1,rules:[{element:"H"},{negate:!0,operator:void 0,rules:[{keyword:et.POLARH}]}]});continue}if(m==="LIGAND"){d({operator:"AND",rules:[{operator:"OR",rules:[{operator:"AND",rules:[{keyword:et.HETERO},{negate:!0,operator:void 0,rules:[{keyword:et.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{keyword:et.POLYMER}]}]},{negate:!0,operator:void 0,rules:[{operator:"OR",rules:[{keyword:et.WATER},{keyword:et.ION}]}]}]});continue}if(m0.indexOf(m)!==-1){d({keyword:et.ALL});continue}if(g.charAt(0)==="@"){const S=g.substr(1).split(",").map(M=>parseInt(M));S.sort(function(M,B){return M-B}),d({atomindex:S});continue}if(g.charAt(0)==="#"){console.error("# for element selection deprecated, use _"),d({element:m.substr(1)});continue}if(g.charAt(0)==="_"){d({element:m.substr(1)});continue}if(g[0]==="["&&g[g.length-1]==="]"){const S=m.substr(1,g.length-2).split(","),M=S.length>1?S:S[0];d({resname:M});continue}if(g.length>=1&&g.length<=4&&g[0]!=="^"&&g[0]!==":"&&g[0]!=="."&&g[0]!=="%"&&g[0]!=="/"&&isNaN(parseInt(g))){d({resname:m});continue}const x={operator:"AND",rules:[]},v=g.split("/");if(v.length>1&&v[1]){if(isNaN(parseInt(v[1])))throw new Error("model must be an integer");x.rules.push({model:parseInt(v[1])})}const b=v[0].split("%");b.length>1&&x.rules.push({altloc:b[1]});const _=b[0].split(".");if(_.length>1&&_[1]){if(_[1].length>4)throw new Error("atomname must be one to four characters");x.rules.push({atomname:_[1].substring(0,4).toUpperCase()})}const C=_[0].split(":");C.length>1&&C[1]&&x.rules.push({chainname:C[1]});const w=C[0].split("^");if(w.length>1&&x.rules.push({inscode:w[1]}),w[0]){let S,M;w[0][0]==="-"&&(w[0]=w[0].substr(1),S=!0),w[0].includes("--")&&(w[0]=w[0].replace("--","-"),M=!0);let B=w[0].split("-");if(B.length===1){let L=parseInt(B[0]);if(isNaN(L))throw new Error("resi must be an integer");S&&(L*=-1),x.rules.push({resno:L})}else{if(B.length!==2)throw new Error("resi range must contain one '-'");{const L=B.map(U=>parseInt(U));S&&(L[0]*=-1),M&&(L[1]*=-1),x.rules.push({resno:[L[0],L[1]]})}}}if(x.rules.length===1)d(x.rules[0]);else{if(!(x.rules.length>1))throw new Error("empty selection chunk");d(x)}}return s.operator===void 0&&s.rules.length===1&&s.rules[0].hasOwnProperty("operator")&&(s=s.rules[0]),s}(e)}catch(r){this.selection={error:r.message}}const i=this.selection;this.string=e,this.test=g0(i),this.residueTest=y0(i),this.chainTest=x0(i),this.modelTest=b0(i),this.atomOnlyTest=g0(i,!0),this.residueOnlyTest=y0(i,!0),this.chainOnlyTest=x0(i,!0),this.modelOnlyTest=b0(i,!0),n||this.signals.stringChanged.dispatch(this.string)}isAllSelection(){return m0.includes(this.string.toUpperCase())}isNoneSelection(){return WM.includes(this.string.toUpperCase())}}class cA extends Et{constructor(e){super(e),this.colormakerList=[],this.selectionList=[],(e.dataList||[]).forEach(n=>{const[i,r,s={}]=n;mt.hasScheme(i)?Object.assign(s,{scheme:i,structure:this.parameters.structure}):Object.assign(s,{scheme:"uniform",value:new ke(i).getHex()}),this.colormakerList.push(mt.getScheme(s)),this.selectionList.push(new qt(r))})}atomColor(e){for(let n=0,i=this.selectionList.length;n<i;++n){const r=this.selectionList[n].test;if(r&&r(e))return this.colormakerList[n].atomColor(e)}return 16777215}}const lA={"":"",OrRd:"[S] Orange-Red",PuBu:"[S] Purple-Blue",BuPu:"[S] Blue-Purple",Oranges:"[S] Oranges",BuGn:"[S] Blue-Green",YlOrBr:"[S] Yellow-Orange-Brown",YlGn:"[S] Yellow-Green",Reds:"[S] Reds",RdPu:"[S] Red-Purple",Greens:"[S] Greens",YlGnBu:"[S] Yellow-Green-Blue",Purples:"[S] Purples",GnBu:"[S] Green-Blue",Greys:"[S] Greys",YlOrRd:"[S] Yellow-Orange-Red",PuRd:"[S] Purple-Red",Blues:"[S] Blues",PuBuGn:"[S] Purple-Blue-Green",Viridis:"[D] Viridis",Spectral:"[D] Spectral",RdYlGn:"[D] Red-Yellow-Green",RdBu:"[D] Red-Blue",PiYG:"[D] Pink-Yellowgreen",PRGn:"[D] Purplered-Green",RdYlBu:"[D] Red-Yellow-Blue",BrBG:"[D] Brown-Bluegreen",RdGy:"[D] Red-Grey",PuOr:"[D] Purple-Orange",Set1:"[Q] Set1",Set2:"[Q] Set2",Set3:"[Q] Set3",Dark2:"[Q] Dark2",Paired:"[Q] Paired",Pastel1:"[Q] Pastel1",Pastel2:"[Q] Pastel2",Accent:"[Q] Accent",rainbow:"[?] Rainbow",rwb:"[?] Red-White-Blue"},hA={"":"",rgb:"Red Green Blue",hsv:"Hue Saturation Value",hsl:"Hue Saturation Lightness",hsi:"Hue Saturation Intensity",lab:"CIE L*a*b*",hcl:"Hue Chroma Lightness"};function Px(t){const e=t;return t.forEach(function(n){n.__deps&&Array.prototype.push.apply(e,Px(n.__deps))}),e}function uA(t){return lm(Px(t)).map(function(e){return e.toString()}).join(`


`)}function dA(t){const e=t.data.__name,n=t.data.__postId;if(e===void 0)console.error("message __name undefined");else if(self.func===void 0)console.error("worker func undefined",e);else{const i=function(r,s){r=r||{},n!==void 0&&(r.__postId=n);try{self.postMessage(r,s)}catch(o){console.error("self.postMessage:",o),self.postMessage(r)}};self.func(t,i)}}function fA(t,e){let n=`'use strict';

`+uA(e);return n+=`


self.func = `+t.toString()+";",n+=`


self.onmessage = `+dA.toString()+";",new Blob([n],{type:"application/javascript"})}const Ex=UM();let Ix=!1;try{const t=Object.defineProperty({},"passive",{get:function(){Ix=!0}});window.addEventListener("test",e=>{},t)}catch{}const Lx=typeof window<"u"&&window.orientation!==void 0;let Rr=!1;function v0(t){Rr=t}let ki=!1;function _0(t){ki=t}const fe={log:Function.prototype.bind.call(console.log,console),info:Function.prototype.bind.call(console.info,console),warn:Function.prototype.bind.call(console.warn,console),error:Function.prototype.bind.call(console.error,console),time:Function.prototype.bind.call(console.time,console),timeEnd:Function.prototype.bind.call(console.timeEnd,console)};let La={color:"green",labelColor:8421504,labelAttachment:"bottom-center",labelSize:.7,labelZOffset:.5,labelYOffset:.1,labelBorder:!0,labelBorderColor:13882323,labelBorderWidth:.25,lineOpacity:.8,linewidth:5,opacity:.6,labelUnit:"angstrom",arcVisible:!0,planeVisible:!1},Ce=!!(Pd=GM("debug"))&&(typeof Pd!="string"||/^1|true|t|yes|y$/i.test(Pd));var Pd;const pA=["ngl","js"],ec=new class{constructor(){this.activeWorkerCount=0,this._funcDict={},this._depsDict={},this._blobDict={}}add(t,e,n){this._funcDict[t]=e,this._depsDict[t]=n}get(t){return this._blobDict[t]||(this._blobDict[t]=fA(this._funcDict[t],this._depsDict[t])),this._blobDict[t]}},mt=new class{constructor(){this.schemes={},this.userSchemes={}}getScheme(t){const e=((t||{}).scheme||"").toLowerCase();let n;return n=e in this.schemes?this.schemes[e]:e in this.userSchemes?this.userSchemes[e]:Et,new n(t)}getSchemes(){const t={};return Object.keys(this.schemes).forEach(function(e){t[e]=e}),Object.keys(this.userSchemes).forEach(function(e){t[e]=e.split("|")[1]}),t}getScales(){return lA}getModes(){return hA}add(t,e){t=t.toLowerCase(),this.schemes[t]=e}addScheme(t,e){return t instanceof Et||(t=this._createScheme(t)),this._addUserScheme(t,e)}_addUserScheme(t,e){e=e||"";const n=`${hm()}|${e}`.toLowerCase();return this.userSchemes[n]=t,n}removeScheme(t){t=t.toLowerCase(),delete this.userSchemes[t]}_createScheme(t){const e=function(n){Et.call(this,n),t.call(this,n)};return(e.prototype=Et.prototype).constructor=Et,e}addSelectionScheme(t,e){return this._addUserScheme(class extends cA{constructor(n){super(Object.assign({dataList:t},n))}},e)}hasScheme(t){return(t=t.toLowerCase())in this.schemes||t in this.userSchemes}},Nr=new Zr("datasource"),Xt=new Zr("representatation"),it=new class extends Zr{constructor(){super("parser")}__hasObjName(t,e){const n=this.get(t);return n&&n.prototype.__objName===e}isTrajectory(t){return this.__hasObjName(t,"frames")}isStructure(t){return this.__hasObjName(t,"structure")}isVolume(t){return this.__hasObjName(t,"volume")}isSurface(t){return this.__hasObjName(t,"surface")}isBinary(t){const e=this.get(t);return e&&e.prototype.isBinary}isXml(t){const e=this.get(t);return e&&e.prototype.isXml}isJson(t){const e=this.get(t);return e&&e.prototype.isJson}getTrajectoryExtensions(){return this.names.filter(t=>this.isTrajectory(t))}getStructureExtensions(){return this.names.filter(t=>this.isStructure(t))}getVolumeExtensions(){return this.names.filter(t=>this.isVolume(t))}getSurfaceExtensions(){return this.names.filter(t=>this.isSurface(t))}},At=new Zr("shader"),dm=new Zr("decompressor"),$o=new Zr("component"),Qn=new Zr("buffer"),ni=new Zr("picker");let Ed;class Rx{constructor(e,n={}){this.chunkSize=10485760,this.newline=`
`,this.__pointer=0,this.__partialLine="",this.compressed=I(n.compressed,!1),this.binary=I(n.binary,!1),this.json=I(n.json,!1),this.xml=I(n.xml,!1),this.src=e}isBinary(){return this.binary||this.compressed}read(){return this._read().then(e=>{const n=this.compressed?dm.get(this.compressed):void 0;return this.compressed&&n?this.data=n(e):((this.binary||this.compressed)&&e instanceof ArrayBuffer&&(e=new Uint8Array(e)),this.data=e),this.data})}_chunk(e,n){return n=Math.min(this.data.length,n),e===0&&this.data.length===n?this.data:this.isBinary()?this.data.subarray(e,n):this.data.substring(e,n)}chunk(e){const n=e+this.chunkSize;return this._chunk(e,n)}peekLines(e){const n=this.data,i=n.length,r=this.isBinary()?this.newline.charCodeAt(0):this.newline;let s,o=0;for(s=0;s<i&&(n[s]===r&&++o,o!==e);++s);const a=this._chunk(0,s+1);return this.chunkToLines(a,"",s>i).lines}chunkCount(){return Math.floor(this.data.length/this.chunkSize)+1}asText(){return this.isBinary()?hu(this.data):this.data}chunkToLines(e,n,i){const r=this.newline;if(!this.isBinary()&&e.length===this.data.length)return{lines:e.split(r),partialLine:""};let s=[];const o=this.isBinary()?hu(e):e,a=o.lastIndexOf(r);if(a===-1)n+=o;else{const c=n+o.substr(0,a);s=s.concat(c.split(r)),n=a===o.length-r.length?"":o.substr(a+r.length)}return i&&n!==""&&s.push(n),{lines:s,partialLine:n}}nextChunk(){const e=this.__pointer;if(!(e>this.data.length))return this.__pointer+=this.chunkSize,this.chunk(e)}nextChunkOfLines(){const e=this.nextChunk();if(e===void 0)return;const n=this.__pointer>this.data.length,i=this.chunkToLines(e,this.__partialLine,n);return this.__partialLine=i.partialLine,i.lines}eachChunk(e){const n=this.chunkSize,i=this.data.length,r=this.chunkCount();for(let s=0;s<i;s+=n)e(this.chunk(s),Math.round(s/n),r)}eachChunkOfLines(e){this.eachChunk((n,i,r)=>{const s=i===r+1,o=this.chunkToLines(n,this.__partialLine,s);this.__partialLine=o.partialLine,e(o.lines,i,r)})}dispose(){delete this.src}}class mA extends Rx{_read(){return new Promise((e,n)=>{const i=this.src,r=new FileReader;r.onload=s=>{s.target&&e(s.target.result)},r.onerror=s=>n(s),this.binary||this.compressed?r.readAsArrayBuffer(i):r.readAsText(i)})}}class gA extends Rx{_read(){return new Promise((e,n)=>{const i=this.src,r=new XMLHttpRequest;r.open("GET",i,!0),r.addEventListener("load",()=>{if(r.status===200||r.status===304||r.status===0)try{e(r.response)}catch(s){n(s)}else n(r.statusText)},!1),r.addEventListener("error",s=>n("network error"),!1),this.isBinary()?r.responseType="arraybuffer":this.json?r.responseType="json":this.xml?r.responseType="document":r.responseType="text",r.send()})}}class Dx{constructor(e,n={}){this.parameters=Kn(n,{ext:"",compressed:!1,binary:it.isBinary(n.ext||""),name:"",dir:"",path:"",protocol:""});const i={compressed:this.parameters.compressed,binary:this.parameters.binary,json:it.isJson(this.parameters.ext),xml:it.isXml(this.parameters.ext)};typeof File<"u"&&e instanceof File||typeof Blob<"u"&&e instanceof Blob?this.streamer=new mA(e,i):this.streamer=new gA(e,i)}}class yA extends Dx{constructor(e,n={}){super(e,n),this.parserParams={voxelSize:n.voxelSize,firstModelOnly:n.firstModelOnly,asTrajectory:n.asTrajectory,cAlphaOnly:n.cAlphaOnly,delimiter:n.delimiter,comment:n.comment,columnNames:n.columnNames,inferBonds:n.inferBonds,name:this.parameters.name,path:this.parameters.path}}load(){return new(it.get(this.parameters.ext))(this.streamer,this.parserParams).parse()}}class xA{constructor(e,n,i){this.name=n,this.path=i,this.signals={elementAdded:new ot.Signal,elementRemoved:new ot.Signal,nameChanged:new ot.Signal},this.type="Script",this.dir=i.substring(0,i.lastIndexOf("/")+1);try{this.fn=new Function("stage","__name","__path","__dir",e)}catch(r){fe.error("Script compilation failed",r),this.fn=function(){}}}run(e){return new Promise((n,i)=>{try{this.fn.apply(null,[e,this.name,this.path,this.dir]),n()}catch(r){fe.error("Script.fn",r),i(r)}})}}class bA extends Dx{load(){return this.streamer.read().then(()=>new xA(this.streamer.asText(),this.parameters.name,this.parameters.path))}}function Un(t){const e=dm.names;let n,i,r="";n=t instanceof File?t.name:t instanceof Blob?"":t;const s=n.lastIndexOf("?"),o=s!==-1?n.substring(s):"";n=n.substring(0,s===-1?n.length:s);const a=n.replace(/^.*[\\/]/,"");let c=a.substring(0,a.lastIndexOf("."));const l=a.split(".");let h=l.length>1?(l.pop()||"").toLowerCase():"";const u=n.match(/^(.+):\/\/(.+)$/);u&&(r=u[1].toLowerCase(),n=u[2]||"");const f=n.substring(0,n.lastIndexOf("/")+1);if(e.includes(h)){i=h;const d=n.length-h.length-1;h=(n.substr(0,d).split(".").pop()||"").toLowerCase();const p=c.length-h.length-1;c=c.substr(0,p)}else i=!1;return{path:n,name:a,ext:h,base:c,dir:f,compressed:i,protocol:r,query:o,src:t}}function vA(t){let e=Un(t);const n=Nr.get(e.protocol);return n&&(e=Un(n.getUrl(e.src)),!e.ext&&n.getExt&&(e.ext=n.getExt(t))),e}function w0(t,e={}){const n=Object.assign(vA(t),e);let i;return it.names.includes(n.ext)?i=new yA(n.src,n):pA.includes(n.ext)&&(i=new bA(n.src,n)),i?i.load():Promise.reject(new Error(`autoLoad: ext '${n.ext}' unknown`))}const Id=[];class _A{constructor(e,n={}){this._mark=0,this._marks=[],this.offset=0,this.littleEndian=!0;let i=!1;e===void 0&&(e=8192),typeof e=="number"?e=new ArrayBuffer(e):i=!0;const r=n.offset?n.offset>>>0:0;let s=e.byteLength-r,o=r;e instanceof ArrayBuffer||(e.byteLength!==e.buffer.byteLength&&(o=e.byteOffset+r),e=e.buffer),this._lastWrittenByte=i?s:0,this.buffer=e,this.length=s,this.byteLength=s,this.byteOffset=o,this._data=new DataView(this.buffer,o,s)}available(e){return e===void 0&&(e=1),this.offset+e<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(e){return e===void 0&&(e=1),this.offset+=e,this}seek(e){return this.offset=e,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const e=this._marks.pop();if(e===void 0)throw new Error("Mark stack empty");return this.seek(e),this}rewind(){return this.offset=0,this}ensureAvailable(e){if(e===void 0&&(e=1),!this.available(e)){const n=2*(this.offset+e),i=new Uint8Array(n);i.set(new Uint8Array(this.buffer)),this.buffer=i.buffer,this.length=this.byteLength=n,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(e){e===void 0&&(e=1);for(var n=new Uint8Array(e),i=0;i<e;i++)n[i]=this.readByte();return n}readInt16(){var e=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}readUint16(){var e=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,e}readInt32(){var e=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}readUint32(){var e=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat32(){var e=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat64(){var e=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}readChar(){return String.fromCharCode(this.readInt8())}readChars(e=1){Id.length=e;for(var n=0;n<e;n++)Id[n]=this.readChar();return Id.join("")}writeBoolean(e=!1){return this.writeUint8(e?255:0),this}writeInt8(e){return this.ensureAvailable(1),this._data.setInt8(this.offset++,e),this._updateLastWrittenByte(),this}writeUint8(e){return this.ensureAvailable(1),this._data.setUint8(this.offset++,e),this._updateLastWrittenByte(),this}writeByte(e){return this.writeUint8(e)}writeBytes(e){this.ensureAvailable(e.length);for(var n=0;n<e.length;n++)this._data.setUint8(this.offset++,e[n]);return this._updateLastWrittenByte(),this}writeInt16(e){return this.ensureAvailable(2),this._data.setInt16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(e){return this.ensureAvailable(2),this._data.setUint16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(e){return this.ensureAvailable(4),this._data.setInt32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(e){return this.ensureAvailable(4),this._data.setUint32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(e){return this.ensureAvailable(4),this._data.setFloat32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(e){return this.ensureAvailable(8),this._data.setFloat64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(e){return this.writeUint8(e.charCodeAt(0))}writeChars(e){for(var n=0;n<e.length;n++)this.writeUint8(e.charCodeAt(n));return this}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this._lastWrittenByte)}_updateLastWrittenByte(){this.offset>this._lastWrittenByte&&(this._lastWrittenByte=this.offset)}}class Bx{constructor(){this.count=0,this.signals={countChanged:new ot.Signal}}clear(){this.change(-this.count)}change(e){this.count+=e,this.signals.countChanged.dispatch(e,this.count),this.count<0&&fe.warn("Counter.count below zero",this.count)}increment(){this.change(1)}decrement(){this.change(-1)}listen(e){this.change(e.count),e.signals.countChanged.add(this.change,this)}unlisten(e){const n=e.signals.countChanged;n.has(this.change,this)&&n.remove(this.change,this)}onZeroOnce(e,n){if(this.count===0)e.call(n);else{const i=()=>{this.count===0&&(this.signals.countChanged.remove(i,this),e.call(n))};this.signals.countChanged.add(i,this)}}dispose(){this.clear(),this.signals.countChanged.dispose()}}At.add("shader/BasicLine.vert",`void main(){
#include begin_vertex
#include project_vertex
}`),At.add("shader/BasicLine.frag",`uniform vec3 uColor;
#include common
#include fog_pars_fragment
void main(){
gl_FragColor = vec4( uColor, 1.0 );
#include premultiplied_alpha_fragment
#include tonemapping_fragment
#include encodings_fragment
#include fog_fragment
}`),At.add("shader/Quad.vert",`varying vec2 vUv;
void main() {
vUv = uv;
gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`),At.add("shader/Quad.frag",`varying vec2 vUv;
uniform sampler2D tForeground;
uniform float scale;
void main() {
vec4 foreground = texture2D( tForeground, vUv );
gl_FragColor = foreground * scale;
}`);class wA{constructor(){this.signals={updated:new ot.Signal},this.maxDuration=-1/0,this.minDuration=1/0,this.avgDuration=14,this.lastDuration=1/0,this.prevFpsTime=0,this.lastFps=1/0,this.lastFrames=1,this.frames=0,this.count=0,this.begin()}update(){this.startTime=this.end(),this.currentTime=this.startTime,this.signals.updated.dispatch()}begin(){this.startTime=window.performance.now(),this.lastFrames=this.frames}end(){const e=window.performance.now();return this.count+=1,this.frames+=1,this.lastDuration=e-this.startTime,this.minDuration=Math.min(this.minDuration,this.lastDuration),this.maxDuration=Math.max(this.maxDuration,this.lastDuration),this.avgDuration-=this.avgDuration/30,this.avgDuration+=this.lastDuration/30,e>this.prevFpsTime+1e3&&(this.lastFps=this.frames,this.prevFpsTime=e,this.frames=0),e}}At.add("shader/chunk/fog_fragment.glsl",`#ifdef USE_FOG
float depth = length( vViewPosition );
#ifdef FOG_EXP2
float fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );
#else
float fogFactor = smoothstep( fogNear, fogFar, depth );
#endif
gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );
#endif`),At.add("shader/chunk/interior_fragment.glsl",`if( gl_FrontFacing == false ){
#ifdef USE_INTERIOR_COLOR
outgoingLight.xyz = interiorColor;
#else
#ifdef DIFFUSE_INTERIOR
outgoingLight.xyz = vColor;
#endif
#endif
outgoingLight.xyz *= 1.0 - interiorDarkening;
}`),At.add("shader/chunk/matrix_scale.glsl",`float matrixScale( in mat4 m ){
vec4 r = m[ 0 ];
return sqrt( r[ 0 ] * r[ 0 ] + r[ 1 ] * r[ 1 ] + r[ 2 ] * r[ 2 ] );
}`),At.add("shader/chunk/nearclip_vertex.glsl",`#ifdef NEAR_CLIP
if( vViewPosition.z < clipNear - 5.0 )
gl_Position.z = 2.0 * gl_Position.w;
#endif`),At.add("shader/chunk/nearclip_fragment.glsl",`#ifdef NEAR_CLIP
if( vViewPosition.z < clipNear )
discard;
#endif`),At.add("shader/chunk/opaque_back_fragment.glsl",`#ifdef OPAQUE_BACK
#ifdef FLIP_SIDED
if( gl_FrontFacing == true ){
gl_FragColor.a = 1.0;
}
#else
if( gl_FrontFacing == false ){
gl_FragColor.a = 1.0;
}
#endif
#endif`),At.add("shader/chunk/radiusclip_vertex.glsl",`#ifdef RADIUS_CLIP
if( distance( vViewPosition, vClipCenter ) > clipRadius + 5.0 )
gl_Position.z = 2.0 * gl_Position.w;
#endif`),At.add("shader/chunk/radiusclip_fragment.glsl",`#ifdef RADIUS_CLIP
if( distance( vViewPosition, vClipCenter ) > clipRadius )
discard;
#endif`),At.add("shader/chunk/unpack_color.glsl",`vec3 unpackColor(float f) {
vec3 color;
color.r = floor(f / 256.0 / 256.0);
color.g = floor((f - color.r * 256.0 * 256.0) / 256.0);
color.b = floor(f - color.r * 256.0 * 256.0 - color.g * 256.0);
return color / 255.0;
}`);const SA=/^(?!\/\/)\s*#include\s+(\S+)/gim,Ld={};function ja(t,e={}){let n=t+"|";for(const i in e)n+=i+":"+e[i];if(!Ld[n]){const i=function(s){if(s===void 0)return"";const o=[];for(const a in s){const c=s[a];c&&o.push(`#define ${a} ${c}`)}return o.join(`
`)+`
`}(e);let r=At.get(`shader/${t}`);if(!r)throw new Error(`empty shader, '${t}'`);r=r.replace(SA,function(s,o){const a=`shader/chunk/${o}.glsl`,c=At.get(a)||_t[o];if(!c)throw new Error(`empty chunk, '${o}'`);return c}),Ld[n]=i+r}return Ld[n]}if(typeof WebGLRenderingContext<"u"){const t=WebGLRenderingContext.prototype,e=t.getShaderParameter;t.getShaderParameter=function(){return!Ce||e.apply(this,arguments)};const n=t.getShaderInfoLog;t.getShaderInfoLog=function(){return Ce?n.apply(this,arguments):""};const i=t.getProgramParameter;t.getProgramParameter=function(s,o){return!Ce&&o===t.LINK_STATUS||i.apply(this,arguments)};const r=t.getProgramInfoLog;t.getProgramInfoLog=function(){return Ce?r.apply(this,arguments):""}}const Ox=[[[0,0]],[[4,4],[-4,-4]],[[-2,-6],[6,-2],[-6,2],[2,6]],[[1,-3],[-1,3],[5,1],[-3,-5],[-5,5],[-7,-1],[3,7],[7,-7]],[[1,1],[-1,-3],[-3,2],[4,-1],[-5,-2],[2,5],[5,3],[3,-5],[-2,6],[0,-7],[-4,-6],[-6,4],[-8,0],[7,-4],[6,7],[-7,-8]],[[-4,-7],[-7,-5],[-3,-5],[-5,-4],[-1,-4],[-2,-2],[-6,-1],[-4,0],[-7,1],[-1,2],[-6,3],[-3,3],[-7,6],[-3,6],[-5,7],[-1,7],[5,-7],[1,-6],[6,-5],[4,-4],[2,-3],[7,-2],[1,-1],[4,-1],[2,1],[6,2],[0,4],[4,4],[2,5],[7,5],[5,6],[3,7]]];Ox.forEach(t=>{t.forEach(e=>{e[0]*=.0625,e[1]*=.0625})});class MA{constructor(e,n,i,r){this.canvas=document.createElement("canvas"),this._viewer=i,this._factor=I(r.factor,2),this._antialias=I(r.antialias,!1),this._onProgress=r.onProgress,this._onFinish=r.onFinish,this._antialias&&(this._factor*=2),this._n=this._factor*this._factor,this._width=this._viewer.width,this._height=this._viewer.height,this._antialias?(this.canvas.width=this._width*this._factor/2,this.canvas.height=this._height*this._factor/2):(this.canvas.width=this._width*this._factor,this.canvas.height=this._height*this._factor),this._ctx=this.canvas.getContext("2d"),this._viewerSampleLevel=i.sampleLevel,this._viewer.setSampling(-1)}_renderTile(e){const n=this._viewer,i=this._width,r=this._height,s=this._factor,o=e%s*i,a=Math.floor(e/s)*r;if(n.camera.setViewOffset(i*s,r*s,o,a,i,r),n.render(),this._antialias){const c=Math.round((o+i)/2)-Math.round(o/2),l=Math.round((a+r)/2)-Math.round(a/2);this._ctx.drawImage(n.renderer.domElement,Math.round(o/2),Math.round(a/2),c,l)}else this._ctx.drawImage(n.renderer.domElement,Math.floor(o),Math.floor(a),Math.ceil(i),Math.ceil(r));typeof this._onProgress=="function"&&this._onProgress(e+1,this._n,!1)}_finalize(){this._viewer.setSampling(this._viewerSampleLevel),this._viewer.camera.view=null,typeof this._onFinish=="function"&&this._onFinish(this._n+1,this._n,!1)}render(){for(let e=0;e<=this._n;++e)e===this._n?this._finalize():this._renderTile(e)}renderAsync(){let e=0;const n=this._n,i=()=>{e===n?this._finalize():this._renderTile(e),e+=1};for(let r=0;r<=n;++r)setTimeout(i,0)}}const Rd=2*Math.PI,kx=180/Math.PI;function Dd(t,e,n=1,i=0,r){const s=r?r.length:t.length/n;let o=0,a=0;if(r)for(let c=0;c<s;++c){const l=(t[r[c]*n+i]+e)%e/e*Rd-Math.PI;o+=Math.cos(l),a+=Math.sin(l)}else for(let c=i;c<s;c+=n){const l=(t[c]+e)%e/e*Rd-Math.PI;o+=Math.cos(l),a+=Math.sin(l)}return o/=s,a/=s,(Math.atan2(a,o)+Math.PI)/Rd*e}function Fi(t,e,n,i=0){const r=t.length,s=n||new Float32Array(r);for(let o=0;o<r;o+=3)s[i+o+0]=(t[o+0]+e[o+0])/2,s[i+o+1]=(t[o+1]+e[o+1])/2,s[i+o+2]=(t[o+2]+e[o+2])/2;return s}function Iu(t,e){const n=t.length,i=new Float32Array(n);for(let r=0;r<n;r+=3)i[r+0]=e[r+0]-t[r+0],i[r+1]=e[r+1]-t[r+1],i[r+2]=e[r+2]-t[r+2];return i}function Jn(t,e,n){const i=n||new Float32Array(t);for(let r=0;r<t;++r)i[r]=e;return i}function Bt(t,e,n,i,r){const s=r||new Float32Array(3*t);for(let o=0;o<t;++o){const a=3*o;s[a+0]=e,s[a+1]=n,s[a+2]=i}return s}function ea(t){const e=new Float32Array(t);for(let n=0;n<t;++n)e[n]=n;return e}function Ap(t,e,n=0,i){const r=i||new Float32Array(t*e);for(let s=0;s<t;++s){const o=n+s*e;for(let a=0;a<e;++a)r[o+a]=s}return r}function Bd(t,e){const n=t.length,i=new Float32Array(n*e);for(let r=0;r<n;++r){const s=r*e,o=t[r];for(let a=0;a<e;++a)i[s+a]=o}return i}function mn(t,e,n,i,r){for(let s=0;s<r;++s)e[i+s]=t[n+s]}function S0(t,e,n,i){mn(t,t,e,n,i)}function xh(t){let e=-1/0;for(let n=0,i=t.length;n<i;++n)t[n]>e&&(e=t[n]);return e}function bh(t){let e=1/0;for(let n=0,i=t.length;n<i;++n)t[n]<e&&(e=t[n]);return e}function fm(t,e=1,n=0){const i=t.length;let r=0;for(let s=n;s<i;s+=e)r+=t[s];return r}function vh(t,e=1,n=0){return fm(t,e,n)/(t.length/e)}const AA={trim:!1,factor:1,antialias:!1,transparent:!1,onProgress:void 0};function CA(t,e={}){const{trim:n,factor:i,antialias:r,transparent:s}=Kn(e,AA),o=t.renderer,a=t.camera,c=o.getClearAlpha(),l=o.getClearColor();function h(d=!1){let p=i;r&&(p*=2),d&&(p=1/p),t.scene.traverse(function(y){const g=y.material;g&&g.linewidth&&(g.linewidth*=p),g&&g.uniforms&&g.uniforms.size&&g.uniforms.size.__seen===void 0&&(g.uniforms.size.value*=p,g.uniforms.size.__seen=!0),g&&g.uniforms&&g.uniforms.linewidth&&g.uniforms.linewidth.__seen===void 0&&(g.uniforms.linewidth.value*=p,g.uniforms.linewidth.__seen=!0)}),t.scene.traverse(function(y){const g=y.material;g&&g.uniforms&&g.uniforms.size&&delete g.uniforms.size.__seen,g&&g.uniforms&&g.uniforms.linewidth&&delete g.uniforms.linewidth.__seen})}function u(d){if(n){const p=l;return function(y,g,m,x,v){const b=y.height,_=y.width,C=y.getContext("2d").getImageData(0,0,_,b).data;let w,S,M,B;for(M=!1,S=0;S<b;S++){for(w=0;w<_;w++)if(B=4*(S*_+w),C[B]!==g||C[B+1]!==m||C[B+2]!==x||C[B+3]!==v){M=!0;break}if(M)break}const L=S;for(M=!1,w=0;w<_;w++){for(S=0;S<b;S++)if(B=4*(S*_+w),C[B]!==g||C[B+1]!==m||C[B+2]!==x||C[B+3]!==v){M=!0;break}if(M)break}const U=w;for(M=!1,S=b-1;S>=0;S--){for(w=_-1;w>=0;w--)if(B=4*(S*_+w),C[B]!==g||C[B+1]!==m||C[B+2]!==x||C[B+3]!==v){M=!0;break}if(M)break}const E=S;for(M=!1,w=_-1;w>=0;w--){for(S=b-1;S>=0;S--)if(B=4*(S*_+w),C[B]!==g||C[B+1]!==m||C[B+2]!==x||C[B+3]!==v){M=!0;break}if(M)break}const O=w,k=document.createElement("canvas");return k.width=O-U,k.height=E-L,k.getContext("2d").drawImage(y,U,L,k.width,k.height,0,0,k.width,k.height),k}(d,s?0:255*p.r,s?0:255*p.g,s?0:255*p.b,s?0:255)}return d}function f(d,p,y){typeof e.onProgress=="function"&&e.onProgress(d,p,y)}return new Promise(function(d,p){const y=new MA(o,a,t,{factor:i,antialias:r,onProgress:f,onFinish:function(g,m){u(y.canvas).toBlob(function(x){o.setClearAlpha(c),h(!0),t.requestRender(),f(m,m,!0),x?d(x):p("error creating image")},"image/png")}});o.setClearAlpha(s?0:1),h(),y.renderAsync()})}const Od=new T,M0=new Ie,A0=new Ie,C0=new Te,uu=new Ie,du=new Ie;function kd(t,e){uu.getInverse(e.projectionMatrix),du.copy(e.projectionMatrix).transpose(),t.traverse(function(n){const i=n.material;if(!i)return;const r=i.uniforms;r&&(r.projectionMatrixInverse&&r.projectionMatrixInverse.value.copy(uu),r.projectionMatrixTranspose&&r.projectionMatrixTranspose.value.copy(du))})}function T0(t,e,n){const i=t.createShader(n);return i?(t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.log(`error compiling shader ${i}: ${t.getShaderInfoLog(i)}`),t.deleteShader(i),null)):void console.log(`error creating WebGL shader ${n}`)}function Fd(t,e){const n=t.getExtension(e);return n||console.log(`extension '${e}' not available`),n}const TA=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);function ql(t){const e=document.createElement("canvas");e.width=16,e.height=16,e.style.width="16px",e.style.height="16px";const n=e.getContext("webgl")||e.getContext("experimental-webgl");if(!n)return console.log(`error creating webgl context for ${t}`),!1;if(!(n instanceof WebGLRenderingContext))return console.log("Got unexpected type for WebGL rendering context"),!1;Fd(n,"OES_texture_float"),Fd(n,"OES_texture_half_float"),Fd(n,"WEBGL_color_buffer_float");const i=T0(n,`
attribute vec4 a_position;

void main() {
  gl_Position = a_position;
}`,n.VERTEX_SHADER),r=T0(n,`
precision mediump float;
uniform vec4 u_color;
uniform sampler2D u_texture;

void main() {
  gl_FragColor = texture2D(u_texture, vec2(0.5, 0.5)) * u_color;
}`,n.FRAGMENT_SHADER);if(!i||!r)return!1;const s=function(p,y,g,m){const x=p.createProgram();return x?(y.forEach(v=>p.attachShader(x,v)),g&&g.forEach((v,b)=>{p.bindAttribLocation(x,m?m[b]:b,v)}),p.linkProgram(x),p.getProgramParameter(x,p.LINK_STATUS)?x:(console.log(`error linking program: ${p.getProgramInfoLog(x)}`),p.deleteProgram(x),null)):void console.log("error creating WebGL program")}(n,[i,r]);if(!s)return console.log("error creating WebGL program"),!1;n.useProgram(s);const o=n.getAttribLocation(s,"a_position"),a=n.getUniformLocation(s,"u_color");if(!a)return console.log("error getting 'u_color' uniform location"),!1;const c=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,c),n.bufferData(n.ARRAY_BUFFER,TA,n.STATIC_DRAW),n.enableVertexAttribArray(o),n.vertexAttribPointer(o,2,n.FLOAT,!1,0,0);const l=n.createTexture(),h=new Uint8Array([255,255,255,255]);n.bindTexture(n.TEXTURE_2D,l),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,1,1,0,n.RGBA,n.UNSIGNED_BYTE,h);const u=n.createTexture();n.bindTexture(n.TEXTURE_2D,u),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,1,1,0,n.RGBA,t,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST);const f=n.createFramebuffer();if(n.bindFramebuffer(n.FRAMEBUFFER,f),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,u,0),n.checkFramebufferStatus(n.FRAMEBUFFER)!==n.FRAMEBUFFER_COMPLETE)return console.log(`error creating framebuffer for ${t}`),!1;n.bindTexture(n.TEXTURE_2D,l),n.uniform4fv(a,[0,10,20,1]),n.drawArrays(n.TRIANGLES,0,6),n.bindTexture(n.TEXTURE_2D,u),n.bindFramebuffer(n.FRAMEBUFFER,null),n.clearColor(1,0,0,1),n.clear(n.COLOR_BUFFER_BIT),n.uniform4fv(a,[0,.1,.05,1]),n.drawArrays(n.TRIANGLES,0,6);const d=new Uint8Array(4);if(n.readPixels(0,0,1,1,n.RGBA,n.UNSIGNED_BYTE,d),d[0]!==0||d[1]<248||d[2]<248||d[3]<254)return console.log(`not able to actually render to ${t} texture`),!1;if(t===n.FLOAT){n.bindFramebuffer(n.FRAMEBUFFER,f);const p=new Float32Array(4);n.readPixels(0,0,1,1,n.RGBA,n.FLOAT,p);const y=n.getError();if(y)return console.log(`error reading pixels as float: '${function(g,m){switch(m){case g.NO_ERROR:return"no error";case g.INVALID_ENUM:return"invalid enum";case g.INVALID_VALUE:return"invalid value";case g.INVALID_OPERATION:return"invalid operation";case g.INVALID_FRAMEBUFFER_OPERATION:return"invalid framebuffer operation";case g.OUT_OF_MEMORY:return"out of memory";case g.CONTEXT_LOST_WEBGL:return"context lost"}return"unknown error"}(n,y)}'`),!1}return!0}const PA=new Float32Array(100),EA=new Uint8Array(100),P0=[12,7,13,17,11,6,8,18,16,2,14,22,10,1,3,9,19,23,21,15,5,0,4,24,20],Xl=new Ie;function IA(t,e,n,i,r){const s=r.uniforms,o=[];if(s&&(s.objectId&&(s.objectId.value=Rr?this.id:this.id/255,o.push("objectId")),(s.modelViewMatrixInverse||s.modelViewMatrixInverseTranspose||s.modelViewProjectionMatrix||s.modelViewProjectionMatrixInverse)&&this.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,this.matrixWorld),s.modelViewMatrixInverse&&(s.modelViewMatrixInverse.value.getInverse(this.modelViewMatrix),o.push("modelViewMatrixInverse")),s.modelViewMatrixInverseTranspose&&(s.modelViewMatrixInverse?s.modelViewMatrixInverseTranspose.value.copy(s.modelViewMatrixInverse.value).transpose():s.modelViewMatrixInverseTranspose.value.getInverse(this.modelViewMatrix).transpose(),o.push("modelViewMatrixInverseTranspose")),s.modelViewProjectionMatrix&&(s.modelViewProjectionMatrix.value.multiplyMatrices(n.projectionMatrix,this.modelViewMatrix),o.push("modelViewProjectionMatrix")),s.modelViewProjectionMatrixInverse&&(s.modelViewProjectionMatrix?(Xl.copy(s.modelViewProjectionMatrix.value),s.modelViewProjectionMatrixInverse.value.getInverse(Xl)):(Xl.multiplyMatrices(n.projectionMatrix,this.modelViewMatrix),s.modelViewProjectionMatrixInverse.value.getInverse(Xl)),o.push("modelViewProjectionMatrixInverse")),o.length)){const a=t.properties.get(r);if(a.program){const c=t.getContext(),l=a.program;c.useProgram(l.program);const h=l.getUniforms();o.forEach(function(u){h.setValue(c,u,s[u].value)})}}}class LA{constructor(e){if(this.boundingBox=new Ut,this.boundingBoxSize=new T,this.boundingBoxLength=0,this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}},this.distVector=new T,this.signals={ticked:new ot.Signal,rendered:new ot.Signal},typeof e=="string"){const n=document.getElementById(e);this.container=n===null?document.createElement("div"):n}else e instanceof HTMLElement?this.container=e:this.container=document.createElement("div");if(this.container===document.body)this.width=window.innerWidth||1,this.height=window.innerHeight||1;else{const n=this.container.getBoundingClientRect();this.width=n.width||1,this.height=n.height||1,this.container.style.overflow="hidden"}this.wrapper=document.createElement("div"),this.wrapper.style.position="relative",this.container.appendChild(this.wrapper),this._initParams(),this._initStats(),this._initCamera(),this._initScene(),this._initRenderer()!==!1?(this._initHelper(),this.setBackground(),this.setFog(),this.animate=this.animate.bind(this)):fe.error("Viewer: could not initialize renderer")}_initParams(){this.parameters={fogColor:new ke(0),fogNear:50,fogFar:100,backgroundColor:new ke(0),cameraType:"perspective",cameraFov:40,cameraEyeSep:.3,cameraZ:-80,clipNear:0,clipFar:100,clipDist:10,clipMode:"scene",clipScale:"relative",lightColor:new ke(14540253),lightIntensity:1,ambientColor:new ke(14540253),ambientIntensity:.2,sampleLevel:0,rendererEncoding:Pn}}_initCamera(){const e=new T(0,0,0),{width:n,height:i}=this;this.perspectiveCamera=new pn(this.parameters.cameraFov,n/i),this.perspectiveCamera.position.z=this.parameters.cameraZ,this.perspectiveCamera.lookAt(e),this.orthographicCamera=new Wr(n/-2,n/2,i/2,i/-2),this.orthographicCamera.position.z=this.parameters.cameraZ,this.orthographicCamera.lookAt(e),this.stereoCamera=new lx,this.stereoCamera.aspect=.5,this.stereoCamera.eyeSep=this.parameters.cameraEyeSep;const r=this.parameters.cameraType;if(r==="orthographic")this.camera=this.orthographicCamera;else{if(r!=="perspective"&&r!=="stereo")throw new Error(`Unknown cameraType '${r}'`);this.camera=this.perspectiveCamera}this.camera.updateProjectionMatrix()}_initStats(){this.stats=new wA}_initScene(){this.scene||(this.scene=new Mo,this.scene.name="scene"),this.rotationGroup=new Ot,this.rotationGroup.name="rotationGroup",this.scene.add(this.rotationGroup),this.translationGroup=new Ot,this.translationGroup.name="translationGroup",this.rotationGroup.add(this.translationGroup),this.modelGroup=new Ot,this.modelGroup.name="modelGroup",this.translationGroup.add(this.modelGroup),this.pickingGroup=new Ot,this.pickingGroup.name="pickingGroup",this.translationGroup.add(this.pickingGroup),this.backgroundGroup=new Ot,this.backgroundGroup.name="backgroundGroup",this.translationGroup.add(this.backgroundGroup),this.helperGroup=new Ot,this.helperGroup.name="helperGroup",this.translationGroup.add(this.helperGroup),this.scene.fog=new Bh(this.parameters.fogColor.getHex()),this.spotLight=new nu(this.parameters.lightColor.getHex(),this.parameters.lightIntensity),this.scene.add(this.spotLight),this.ambientLight=new iu(this.parameters.ambientColor.getHex(),this.parameters.ambientIntensity),this.scene.add(this.ambientLight)}_initRenderer(){const e=window.devicePixelRatio,{width:n,height:i}=this;try{this.renderer=new Kc({preserveDrawingBuffer:!0,alpha:!0,antialias:!0})}catch{return this.wrapper.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;"><p style="padding:15px;text-align:center;">Your browser/graphics card does not seem to support <a target="_blank" href="https://en.wikipedia.org/wiki/WebGL">WebGL</a>.<br/><br/>Find out how to get it <a target="_blank" href="http://get.webgl.org/">here</a>.</p></div>',!1}this.renderer.setPixelRatio(e),this.renderer.setSize(n,i),this.renderer.autoClear=!1,this.renderer.sortObjects=!0,this.renderer.outputEncoding=this.parameters.rendererEncoding;const r=this.renderer.getContext();this.renderer.capabilities.isWebGL2?(_0(!0),v0(this.renderer.extensions.get("EXT_color_buffer_float")),this.supportsHalfFloat=!0):(_0(this.renderer.extensions.get("EXT_frag_depth")),this.renderer.extensions.get("OES_element_index_uint"),v0(this.renderer.extensions.get("OES_texture_float")&&this.renderer.extensions.get("WEBGL_color_buffer_float")||this.renderer.extensions.get("OES_texture_float")&&ql(r.FLOAT)),this.renderer.extensions.get("OES_texture_float"),this.supportsHalfFloat=this.renderer.extensions.get("OES_texture_half_float")&&ql(36193)),this.wrapper.appendChild(this.renderer.domElement);const s=n*e,o=i*e;Ce&&console.log(JSON.stringify({Browser:Ex,OES_texture_float:!!this.renderer.extensions.get("OES_texture_float"),OES_texture_half_float:!!this.renderer.extensions.get("OES_texture_half_float"),WEBGL_color_buffer_float:!!this.renderer.extensions.get("WEBGL_color_buffer_float"),"testTextureSupport Float":ql(r.FLOAT),"testTextureSupport HalfFloat":ql(36193),"this.supportsHalfFloat":this.supportsHalfFloat,SupportsReadPixelsFloat:Rr},null,2)),this.pickingTarget=new Rn(s,o,{minFilter:zt,magFilter:zt,stencilBuffer:!1,format:Gn,type:Rr?sr:gs}),this.pickingTarget.texture.generateMipmaps=!1,this.pickingTarget.texture.encoding=this.parameters.rendererEncoding,this.renderer.setRenderTarget(this.pickingTarget),this.renderer.clear(),this.renderer.setRenderTarget(null),this.sampleTarget=new Rn(s,o,{minFilter:gn,magFilter:gn,format:Gn}),this.sampleTarget.texture.encoding=this.parameters.rendererEncoding,this.holdTarget=new Rn(s,o,{minFilter:zt,magFilter:zt,format:Gn,type:gs}),this.holdTarget.texture.encoding=this.parameters.rendererEncoding,this.compositeUniforms={tForeground:new Dc(this.sampleTarget.texture),scale:new Dc(1)},this.compositeMaterial=new bn({uniforms:this.compositeUniforms,vertexShader:ja("Quad.vert"),fragmentShader:ja("Quad.frag"),premultipliedAlpha:!0,transparent:!0,blending:Lf,depthTest:!1,depthWrite:!1}),this.compositeCamera=new Wr(-1,1,1,-1,0,1),this.compositeScene=new Mo,this.compositeScene.name="compositeScene",this.compositeScene.add(new Ht(new uc(2,2),this.compositeMaterial))}_initHelper(){const e=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24),i=new We;i.setIndex(new Qe(e,1)),i.setAttribute("position",new Qe(n,3));const r=new bn({uniforms:{uColor:{value:new ke("skyblue")}},vertexShader:ja("BasicLine.vert"),fragmentShader:ja("BasicLine.frag")});this.boundingBoxMesh=new on(i,r),this.helperGroup.add(this.boundingBoxMesh)}updateHelper(){const e=this.boundingBoxMesh.geometry.attributes.position,n=e.array,{min:i,max:r}=this.boundingBox;n[0]=r.x,n[1]=r.y,n[2]=r.z,n[3]=i.x,n[4]=r.y,n[5]=r.z,n[6]=i.x,n[7]=i.y,n[8]=r.z,n[9]=r.x,n[10]=i.y,n[11]=r.z,n[12]=r.x,n[13]=r.y,n[14]=i.z,n[15]=i.x,n[16]=r.y,n[17]=i.z,n[18]=i.x,n[19]=i.y,n[20]=i.z,n[21]=r.x,n[22]=i.y,n[23]=i.z,e.needsUpdate=!0,this.boundingBox.isEmpty()||this.boundingBoxMesh.geometry.computeBoundingSphere()}get cameraDistance(){return Math.abs(this.camera.position.z)}set cameraDistance(e){this.camera.position.z=-e}add(e,n){n?n.forEach(i=>this.addBuffer(e,i)):this.addBuffer(e),e.group.name="meshGroup",e.wireframeGroup.name="wireframeGroup",e.parameters.background?(this.backgroundGroup.add(e.group),this.backgroundGroup.add(e.wireframeGroup)):(this.modelGroup.add(e.group),this.modelGroup.add(e.wireframeGroup)),e.pickable&&this.pickingGroup.add(e.pickingGroup),Ce&&this.updateHelper()}addBuffer(e,n){function i(o){o instanceof Ot?o.children.forEach(i):(o.userData.buffer=e,o.userData.instance=n,o.onBeforeRender=IA)}const r=e.getMesh();n&&r.applyMatrix4(n.matrix),i(r),e.group.add(r);const s=e.getWireframeMesh();if(n&&(s.matrix.copy(r.matrix),s.position.copy(r.position),s.quaternion.copy(r.quaternion),s.scale.copy(r.scale)),i(s),e.wireframeGroup.add(s),e.pickable){const o=e.getPickingMesh();n&&(o.matrix.copy(r.matrix),o.position.copy(r.position),o.quaternion.copy(r.quaternion),o.scale.copy(r.scale)),i(o),e.pickingGroup.add(o)}n?this._updateBoundingBox(e.geometry,e.matrix,n.matrix):this._updateBoundingBox(e.geometry,e.matrix)}remove(e){this.translationGroup.children.forEach(function(n){n.remove(e.group),n.remove(e.wireframeGroup)}),e.pickable&&this.pickingGroup.remove(e.pickingGroup),this.updateBoundingBox(),Ce&&this.updateHelper()}_updateBoundingBox(e,n,i){const r=this.boundingBox;function s(a,c,l){a.boundingBox==null&&a.computeBoundingBox();const h=a.boundingBox.clone();c&&h.applyMatrix4(c),l&&h.applyMatrix4(l),h.min.equals(h.max)&&h.expandByScalar(5),r.union(h)}function o(a){if(a.geometry!==void 0){let c,l;a.userData.buffer&&(c=a.userData.buffer.matrix),a.userData.instance&&(l=a.userData.instance.matrix),s(a.geometry,c,l)}}e?s(e,n,i):(r.makeEmpty(),this.modelGroup.traverse(o),this.backgroundGroup.traverse(o)),r.getSize(this.boundingBoxSize),this.boundingBoxLength=this.boundingBoxSize.length()}updateBoundingBox(){this._updateBoundingBox(),Ce&&this.updateHelper()}getPickingPixels(){const{width:e,height:n}=this,i=e*n*4,r=Rr?new Float32Array(i):new Uint8Array(i);return this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,0,0,e,n,r),r}getImage(e){return new Promise(n=>{if(e){const{width:i,height:r}=this,s=i*r*4;let o=this.getPickingPixels();if(Rr){const h=new Uint8Array(s);for(let u=0;u<s;++u)h[u]=Math.round(255*o[u]);o=h}const a=document.createElement("canvas");a.width=i,a.height=r;const c=a.getContext("2d"),l=c.getImageData(0,0,i,r);l.data.set(o),c.putImageData(l,0,0),a.toBlob(n,"image/png")}else this.renderer.domElement.toBlob(n,"image/png")})}makeImage(e={}){return CA(this,e)}setLight(e,n,i,r){const s=this.parameters;e!==void 0&&s.lightColor.set(e),n!==void 0&&(s.lightIntensity=n),i!==void 0&&s.ambientColor.set(i),r!==void 0&&(s.ambientIntensity=r),this.requestRender()}setFog(e,n,i){const r=this.parameters;e!==void 0&&r.fogColor.set(e),n!==void 0&&(r.fogNear=n),i!==void 0&&(r.fogFar=i),this.requestRender()}setBackground(e){const n=this.parameters;e&&n.backgroundColor.set(e),this.setFog(n.backgroundColor),this.renderer.setClearColor(n.backgroundColor,0),this.renderer.domElement.style.backgroundColor=n.backgroundColor.getStyle(),this.requestRender()}setSampling(e){e!==void 0&&(this.parameters.sampleLevel=e,this.sampleLevel=e),this.requestRender()}setOutputEncoding(e){this.parameters.rendererEncoding=e,this.renderer.outputEncoding=e,this.pickingTarget.texture.encoding=e,this.sampleTarget.texture.encoding=e,this.holdTarget.texture.encoding=e}setColorWorkflow(e){if(e!="linear"&&e!="sRGB")throw new Error(`setColorWorkflow: invalid color workflow ${e}`);Cx=e=="linear"?"linear":"sRGB",this.setOutputEncoding(e=="linear"?Xc:Pn),this.requestRender()}setCamera(e,n,i){const r=this.parameters;if(e&&(r.cameraType=e),n&&(r.cameraFov=n),i&&(r.cameraEyeSep=i),r.cameraType==="orthographic")this.camera!==this.orthographicCamera&&(this.camera=this.orthographicCamera,this.camera.position.copy(this.perspectiveCamera.position),this.camera.up.copy(this.perspectiveCamera.up),this.updateZoom());else{if(r.cameraType!=="perspective"&&r.cameraType!=="stereo")throw new Error(`Unknown cameraType '${r.cameraType}'`);this.camera!==this.perspectiveCamera&&(this.camera=this.perspectiveCamera,this.camera.position.copy(this.orthographicCamera.position),this.camera.up.copy(this.orthographicCamera.up))}this.perspectiveCamera.fov=r.cameraFov,this.stereoCamera.eyeSep=r.cameraEyeSep,this.camera.updateProjectionMatrix(),this.requestRender()}setClip(e,n,i,r,s){const o=this.parameters;e!==void 0&&(o.clipNear=e),n!==void 0&&(o.clipFar=n),i!==void 0&&(o.clipDist=i),r!==void 0&&(o.clipMode=r),s!==void 0&&(o.clipScale=s),this.requestRender()}setSize(e,n){this.width=e||1,this.height=n||1,this.perspectiveCamera.aspect=this.width/this.height,this.orthographicCamera.left=-this.width/2,this.orthographicCamera.right=this.width/2,this.orthographicCamera.top=this.height/2,this.orthographicCamera.bottom=-this.height/2,this.camera.updateProjectionMatrix();const i=window.devicePixelRatio;this.renderer.setPixelRatio(i),this.renderer.setSize(e,n);const r=this.width*i,s=this.height*i;this.pickingTarget.setSize(r,s),this.sampleTarget.setSize(r,s),this.holdTarget.setSize(r,s),this.requestRender()}handleResize(){if(this.container===document.body)this.setSize(window.innerWidth,window.innerHeight);else{const e=this.container.getBoundingClientRect();this.setSize(e.width,e.height)}}updateInfo(e){const{memory:n,render:i}=this.info;if(e)n.programs=0,n.geometries=0,n.textures=0,i.calls=0,i.vertices=0,i.points=0;else{const r=this.renderer.info,s=r.memory,o=r.render;n.geometries=s.geometries,n.textures=s.textures,i.calls+=o.calls,i.faces+=o.triangles,i.points+=o.points}}animate(){if(this.signals.ticked.dispatch(this.stats),window.performance.now()-this.stats.startTime>500&&!this.isStill&&this.sampleLevel<3&&this.sampleLevel!==-1){const e=this.sampleLevel;this.sampleLevel=3,this.renderPending=!0,this.render(),this.isStill=!0,this.sampleLevel=e,Ce&&fe.log("rendered still frame")}this.frameRequest=window.requestAnimationFrame(this.animate)}pick(e,n){if(this.parameters.cameraType==="stereo")return{pid:0,instance:void 0,picker:void 0};e*=window.devicePixelRatio,n*=window.devicePixelRatio,e=Math.max(e-2,0),n=Math.max(n-2,0);let i,r,s=0;const o=Rr?PA:EA;this.render(!0),this.renderer.readRenderTargetPixels(this.pickingTarget,e,n,5,5,o);for(let a=0;a<P0.length;a++){const c=4*P0[a],l=Math.round(o[c+3]),h=this.pickingGroup.getObjectById(l);h&&(i=h.userData.instance,r=h.userData.buffer.picking,s=Rr?Math.round(255*o[c])<<16&16711680|Math.round(255*o[c+1])<<8&65280|255&Math.round(255*o[c+2]):o[c]<<16|o[c+1]<<8|o[c+2])}return{pid:s,instance:i,picker:r}}requestRender(){this.renderPending||(window.performance.now()-this.stats.startTime>22&&(this.stats.begin(),this.isStill=!1),this.renderPending=!0,window.requestAnimationFrame(()=>{this.render(),this.stats.update()}))}updateZoom(){const e=rn(this.perspectiveCamera.fov),n=2*Math.tan(e/2)*this.cameraDistance;this.orthographicCamera.zoom=this.height/n}absoluteToRelative(e){return 50*(1-e/this.bRadius)}relativeToAbsolute(e){return this.bRadius*(1-e/50)}__updateClipping(){const e=this.parameters;this.bRadius=Math.max(10,.5*this.boundingBoxLength),isFinite(this.bRadius)||(this.bRadius=50),this.camera.getWorldPosition(this.distVector),this.cDist=this.distVector.length(),this.cDist||(this.cameraDistance=Math.abs(e.cameraZ),this.cDist=Math.abs(e.cameraZ));const n=this.scene.fog;if(n.color.set(e.fogColor),e.clipMode==="camera")this.camera.near=e.clipNear,this.camera.far=e.clipFar,n.near=e.fogNear,n.far=e.fogFar;else if(e.clipScale==="absolute")this.camera.near=this.cDist-e.clipNear,this.camera.far=this.cDist+e.clipFar,n.near=this.cDist-e.fogNear,n.far=this.cDist+e.fogFar;else{const i=(50-e.clipNear)/50,r=-(50-e.clipFar)/50;this.camera.near=this.cDist-this.bRadius*i,this.camera.far=this.cDist+this.bRadius*r;const s=(50-e.fogNear)/50,o=-(50-e.fogFar)/50;n.near=this.cDist-this.bRadius*s,n.far=this.cDist+this.bRadius*o}e.clipMode!=="camera"&&(this.camera.type==="PerspectiveCamera"?(this.camera.near=Math.max(.1,e.clipDist,this.camera.near),this.camera.far=Math.max(1,this.camera.far),n.near=Math.max(.1,n.near),n.far=Math.max(1,n.far)):this.camera.type==="OrthographicCamera"&&e.clipDist>0&&(this.camera.near=Math.max(e.clipDist,this.camera.near)))}__updateCamera(){const e=this.camera;e.updateMatrix(),e.updateMatrixWorld(!0),e.updateProjectionMatrix(),function(n,i,r,s,o){let a=new Te;r.getSize(a);const c=a.height,l=r.getPixelRatio(),h=i.type==="OrthographicCamera";C0.set(a.width,a.height),uu.getInverse(i.projectionMatrix),du.copy(i.projectionMatrix).transpose(),n.traverse(function(u){const f=u.material;if(!f)return;const d=f.uniforms;if(d){if(f.clipNear){const p=(50-f.clipNear)/50,y=s-o*p;d.clipNear.value=y}d.canvasHeight&&(d.canvasHeight.value=c),d.resolution&&d.resolution.value.copy(C0),d.pixelRatio&&(d.pixelRatio.value=l),d.projectionMatrixInverse&&d.projectionMatrixInverse.value.copy(uu),d.projectionMatrixTranspose&&d.projectionMatrixTranspose.value.copy(du),d.ortho&&(d.ortho.value=h)}})}(this.scene,e,this.renderer,this.cDist,this.bRadius),function(n,i){n.traverseVisible(function(r){if(!(r instanceof pc&&r.userData.buffer.parameters.sortParticles))return;const s=r.geometry.attributes,o=s.position.count;if(o===0)return;let a,c,l,h,u,f,d,p;M0.multiplyMatrices(i.matrixWorldInverse,r.matrixWorld),A0.multiplyMatrices(i.projectionMatrix,M0),r.userData.sortData?(a=r.userData.sortData,l=a.__zArray,c=a.__sortArray,h=a.__cmpFn):(l=new Float32Array(o),c=new Uint32Array(o),h=function(y,g){const m=l[y],x=l[g];return m>x?1:m<x?-1:0},a={__zArray:l,__sortArray:c,__cmpFn:h},r.userData.sortData=a);for(let y=0;y<o;++y)Od.fromArray(s.position.array,3*y),Od.applyMatrix4(A0),l[y]=-Od.z,c[y]=y;(function(y,g,m=0,x){g=g||function(L,U){return L>U?1:L<U?-1:0};const v=[];let b,_,C,w=-1,S=m,M=x=(x||y.length)-1;function B(L,U){const E=y[L];y[L]=y[U],y[U]=E}for(;;)if(M-S<=25){for(let L=S+1;L<=M;++L){for(b=y[L],_=L-1;_>=S&&g(y[_],b)>0;)y[_+1]=y[_],--_;y[_+1]=b}if(w===-1)break;M=v[w--],S=v[w--]}else{for(_=S+1,C=M,B(S+M>>1,_),g(y[S],y[M])>0&&B(S,M),g(y[_],y[M])>0&&B(_,M),g(y[S],y[_])>0&&B(S,_),b=y[_];;){do _++;while(g(y[_],b)<0);do C--;while(g(y[C],b)>0);if(C<_)break;B(_,C)}y[S+1]=y[C],y[C]=b,M-_+1>=C-S?(v[++w]=_,v[++w]=M,M=C-1):(v[++w]=S,v[++w]=C-1,S=_)}})(c,h);for(let y in s){const g=s[y],m=g.array,x=g.itemSize;a[y]||(a[y]=new Float32Array(x*o)),p=a[y],a[y]=m;for(let v=0;v<o;++v){u=c[v];for(let b=0;b<x;++b)f=u*x+b,d=v*x+b,p[d]=m[f]}s[y].array=p,s[y].needsUpdate=!0}})}(this.scene,e)}__setVisibility(e,n,i,r){this.modelGroup.visible=e,this.pickingGroup.visible=n,this.backgroundGroup.visible=i,this.helperGroup.visible=r}__updateLights(){this.spotLight.color.set(this.parameters.lightColor),this.spotLight.intensity=this.parameters.lightIntensity,this.distVector.copy(this.camera.position).setLength(100*this.boundingBoxLength),this.spotLight.position.copy(this.camera.position).add(this.distVector),this.ambientLight.color.set(this.parameters.ambientColor),this.ambientLight.intensity=this.parameters.ambientIntensity}__renderPickingGroup(e){this.renderer.setRenderTarget(this.pickingTarget||null),this.renderer.clear(),this.__setVisibility(!1,!0,!1,!1),this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.updateInfo()}__renderModelGroup(e,n){this.renderer.setRenderTarget(n||null),this.renderer.clear(),this.__setVisibility(!1,!1,!0,!1),this.renderer.render(this.scene,e),this.renderer.clear(!1,!0,!0),this.updateInfo(),this.__setVisibility(!0,!1,!1,Ce),this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.updateInfo()}__renderSuperSample(e,n){const i=Ox[Math.max(0,Math.min(this.sampleLevel,5))],r=1/i.length;this.compositeUniforms.tForeground.value=this.sampleTarget.texture;let s=this.sampleTarget.width;const o=this.sampleTarget.height;this.parameters.cameraType==="stereo"&&(s/=2);for(let a=0;a<i.length;++a){const c=i[a];e.setViewOffset(s,o,c[0],c[1],s,o),e.updateProjectionMatrix(),kd(this.scene,e);let l=r;l+=.03125*((a+.5)/i.length-.5),this.compositeUniforms.scale.value=l,this.__renderModelGroup(e,this.sampleTarget),this.renderer.setRenderTarget(this.holdTarget),a===0&&this.renderer.clear(),this.renderer.render(this.compositeScene,this.compositeCamera)}this.compositeUniforms.scale.value=1,this.compositeUniforms.tForeground.value=this.holdTarget.texture,e.clearViewOffset(),this.renderer.setRenderTarget(n||null),this.renderer.clear(),this.renderer.render(this.compositeScene,this.compositeCamera)}__renderStereo(e=!1,n){const i=this.stereoCamera;i.update(this.perspectiveCamera);const r=this.renderer;let s=new Te;r.getSize(s),r.setScissorTest(!0),r.setScissor(0,0,s.width/2,s.height),r.setViewport(0,0,s.width/2,s.height),kd(this.scene,i.cameraL),this.__render(e,i.cameraL),r.setScissor(s.width/2,0,s.width/2,s.height),r.setViewport(s.width/2,0,s.width/2,s.height),kd(this.scene,i.cameraR),this.__render(e,i.cameraR),r.setScissorTest(!1),r.setViewport(0,0,s.width,s.height)}__render(e=!1,n,i){e?this.lastRenderedPicking||this.__renderPickingGroup(n):this.sampleLevel>0&&this.parameters.cameraType!=="stereo"?this.__renderSuperSample(n,i):this.__renderModelGroup(n,i)}render(e=!1,n){if(this.rendering)fe.warn("'tried to call 'render' from within 'render'");else{this.rendering=!0;try{this.__updateClipping(),this.__updateCamera(),this.__updateLights(),this.updateInfo(!0),this.parameters.cameraType==="stereo"?this.__renderStereo(e,n):this.__render(e,this.camera,n),this.lastRenderedPicking=e}finally{this.rendering=!1,this.renderPending=!1}this.signals.rendered.dispatch()}}clear(){fe.log("scene cleared"),this.scene.remove(this.rotationGroup),this._initScene(),this.renderer.clear()}dispose(){this.renderer.dispose(),window.cancelAnimationFrame(this.frameRequest)}}function E0(t){const e=t.touches[0].pageX-t.touches[1].pageX,n=t.touches[0].pageY-t.touches[1].pageY;return Math.sqrt(e*e+n*n)}class RA{constructor(e,n={}){this.domElement=e,this.signals={moved:new ot.Signal,scrolled:new ot.Signal,dragged:new ot.Signal,dropped:new ot.Signal,clicked:new ot.Signal,hovered:new ot.Signal,doubleClicked:new ot.Signal},this.position=new Te,this.prevPosition=new Te,this.down=new Te,this.canvasPosition=new Te,this.prevClickCP=new Te,this.moving=!1,this.hovering=!0,this.scrolled=!1,this.lastMoved=1/0,this.which=0,this.buttons=0,this.pressed=!1,this.altKey=!1,this.ctrlKey=!1,this.metaKey=!1,this.shiftKey=!1,this.domElement.style.touchAction="none",this.hoverTimeout=I(n.hoverTimeout,50),this.handleScroll=I(n.handleScroll,!0),this.doubleClickSpeed=I(n.doubleClickSpeed,500),this._listen=this._listen.bind(this),this._onMousewheel=this._onMousewheel.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMousedown=this._onMousedown.bind(this),this._onMouseup=this._onMouseup.bind(this),this._onContextmenu=this._onContextmenu.bind(this),this._onTouchstart=this._onTouchstart.bind(this),this._onTouchend=this._onTouchend.bind(this),this._onTouchmove=this._onTouchmove.bind(this),this._listen();const i={passive:!1};document.addEventListener("mousewheel",this._onMousewheel,i),document.addEventListener("wheel",this._onMousewheel,i),document.addEventListener("MozMousePixelScroll",this._onMousewheel,i),document.addEventListener("mousemove",this._onMousemove,i),document.addEventListener("mousedown",this._onMousedown,i),document.addEventListener("mouseup",this._onMouseup,i),document.addEventListener("contextmenu",this._onContextmenu,i),document.addEventListener("touchstart",this._onTouchstart,i),document.addEventListener("touchend",this._onTouchend,i),document.addEventListener("touchmove",this._onTouchmove,i)}get key(){let e=0;return this.altKey&&(e+=1),this.ctrlKey&&(e+=2),this.metaKey&&(e+=4),this.shiftKey&&(e+=8),e}setParameters(e={}){this.hoverTimeout=I(e.hoverTimeout,this.hoverTimeout)}_listen(){const e=window.performance.now(),n=this.canvasPosition;this.doubleClickPending&&e-this.lastClicked>this.doubleClickSpeed&&(this.doubleClickPending=!1),e-this.lastMoved>this.hoverTimeout&&(this.moving=!1),(this.scrolled||!this.moving&&!this.hovering)&&(this.scrolled=!1,this.hoverTimeout!==-1&&this.overElement&&(this.hovering=!0,this.signals.hovered.dispatch(n.x,n.y))),this.frameRequest=window.requestAnimationFrame(this._listen)}_onMousewheel(e){if(e.target!==this.domElement||!this.handleScroll)return;e.preventDefault(),this._setKeys(e);let n=0;"deltaY"in e&&"deltaMode"in e&&e.deltaY!==void 0&&e.deltaMode!==void 0?n=e.deltaMode===WheelEvent.DOM_DELTA_PIXEL?.025*-e.deltaY:e.deltaMode===WheelEvent.DOM_DELTA_LINE?-e.deltaY*(2.5/3):2.5*-e.deltaY:"deltaY"in e&&!("detail"in e)?n=.025*-e.deltaY:e.wheelDelta!==void 0?n=.025*-e.wheelDelta:e.wheelDeltaY!==void 0?n=.025*-e.wheelDeltaY:e.detail!==void 0&&(n=-e.detail/3),this.signals.scrolled.dispatch(n),setTimeout(()=>{this.scrolled=!0},this.hoverTimeout)}_onMousemove(e){e.target===this.domElement?(e.preventDefault(),this.overElement=!0):this.overElement=!1,this._setKeys(e),this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(e.clientX,e.clientY),this._setCanvasPosition(e);const n=this.prevPosition.x-this.position.x,i=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(n,i),this.pressed&&this.signals.dragged.dispatch(n,i)}_onMousedown(e){e.target===this.domElement&&(e.preventDefault(),this._setKeys(e),this.moving=!1,this.hovering=!1,this.down.set(e.clientX,e.clientY),this.position.set(e.clientX,e.clientY),this.which=e.which,this.buttons=function(n){if(typeof n=="object"){if("buttons"in n)return n.buttons;if("which"in n){const i=n.which;if(i===2)return 4;if(i===3)return 2;if(i>0)return 1<<i-1}else if("button"in n){const i=n.button;if(i===1)return 4;if(i===2)return 2;if(i>=0)return 1<<i}}return 0}(e),this.pressed=!0,this._setCanvasPosition(e))}_onMouseup(e){e.target===this.domElement&&e.preventDefault(),this._setKeys(e);const n=this.canvasPosition;this._distance()<4&&(this.lastClicked=window.performance.now(),this.doubleClickPending&&this.prevClickCP.distanceTo(n)<4&&(this.signals.doubleClicked.dispatch(n.x,n.y),this.doubleClickPending=!1),this.signals.clicked.dispatch(n.x,n.y),this.doubleClickPending=!0,this.prevClickCP.copy(n)),this.which=void 0,this.buttons=void 0,this.pressed=void 0}_onContextmenu(e){e.target===this.domElement&&e.preventDefault()}_onTouchstart(e){if(e.target===this.domElement)switch(e.preventDefault(),this.pressed=!0,e.touches.length){case 1:this.moving=!1,this.hovering=!1,this.down.set(e.touches[0].pageX,e.touches[0].pageY),this.position.set(e.touches[0].pageX,e.touches[0].pageY),this._setCanvasPosition(e.touches[0]);break;case 2:this.down.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),this.position.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),this.lastTouchDistance=E0(e)}}_onTouchend(e){e.target===this.domElement&&e.preventDefault(),this.which=void 0,this.buttons=void 0,this.pressed=void 0}_onTouchmove(e){switch(e.target===this.domElement?(e.preventDefault(),this.overElement=!0):this.overElement=!1,e.touches.length){case 1:{this._setKeys(e),this.which=1,this.buttons=1,this.moving=!0,this.hovering=!1,this.lastMoved=window.performance.now(),this.prevPosition.copy(this.position),this.position.set(e.touches[0].pageX,e.touches[0].pageY),this._setCanvasPosition(e.touches[0]);const n=this.prevPosition.x-this.position.x,i=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(n,i),this.pressed&&this.signals.dragged.dispatch(n,i);break}case 2:{const n=E0(e),i=n-this.lastTouchDistance;if(this.lastTouchDistance=n,this.prevPosition.copy(this.position),this.position.set((e.touches[0].pageX+e.touches[1].pageX)/2,(e.touches[0].pageY+e.touches[1].pageY)/2),Math.abs(i)>2&&this.handleScroll&&this.position.distanceTo(this.prevPosition)<2)this.which=0,this.buttons=0,this.signals.scrolled.dispatch(i/2);else{this.which=3,this.buttons=2;const r=this.prevPosition.x-this.position.x,s=this.prevPosition.y-this.position.y;this.signals.moved.dispatch(r,s),this.pressed&&this.signals.dragged.dispatch(r,s)}}}}_distance(){return this.position.distanceTo(this.down)}_setCanvasPosition(e){const n=this.domElement.getBoundingClientRect();let i,r;"clientX"in e&&"clientY"in e?(i=e.clientX-n.left,r=e.clientY-n.top):(i=e.offsetX,r=e.offsetY),this.canvasPosition.set(i,n.height-r)}_setKeys(e){this.altKey=e.altKey,this.ctrlKey=e.ctrlKey,this.metaKey=e.metaKey,this.shiftKey=e.shiftKey}dispose(){document.removeEventListener("mousewheel",this._onMousewheel),document.removeEventListener("wheel",this._onMousewheel),document.removeEventListener("MozMousePixelScroll",this._onMousewheel),document.removeEventListener("mousemove",this._onMousemove),document.removeEventListener("mousedown",this._onMousedown),document.removeEventListener("mouseup",this._onMouseup),document.removeEventListener("contextmenu",this._onContextmenu),document.removeEventListener("touchstart",this._onTouchstart),document.removeEventListener("touchend",this._onTouchend),document.removeEventListener("touchmove",this._onTouchmove),window.cancelAnimationFrame(this.frameRequest)}}const Nd=new Ie,zd=new Ie,I0=new Ie,On=new Ie,L0=new Ie,ti=new T,Ra=new Gt,R0=new Gt,Ki=new Ie,as=new T,Yl=new T;class DA{constructor(e,n={}){this.stage=e,this.rotateSpeed=I(n.rotateSpeed,2),this.zoomSpeed=I(n.zoomSpeed,1.2),this.panSpeed=I(n.panSpeed,1),this.viewer=e.viewer,this.mouse=e.mouseObserver,this.controls=e.viewerControls}get component(){return this.stage.transformComponent}get atom(){return this.stage.transformAtom}_setPanVector(e,n,i=0){const r=this.controls.getCanvasScaleFactor(i);as.set(e,n,0),as.multiplyScalar(this.panSpeed*r)}_getRotateXY(e,n){return[this.rotateSpeed*-e*.01,this.rotateSpeed*n*.01]}_getCameraRotation(e){return e.extractRotation(this.viewer.camera.matrixWorld),e.multiply(zd.makeRotationY(Math.PI)),e}_transformPanVector(){this.component&&(Ki.extractRotation(this.component.transform),Ki.premultiply(this.viewer.rotationGroup.matrix),Ki.getInverse(Ki),Ki.multiply(this._getCameraRotation(On)),as.applyMatrix4(Ki))}zoom(e){this.controls.zoom(this.zoomSpeed*e*.02)}pan(e,n){this._setPanVector(e,n),Ki.getInverse(this.viewer.rotationGroup.matrix),Ki.multiply(this._getCameraRotation(On)),as.applyMatrix4(Ki),this.controls.translate(as)}panComponent(e,n){this.component&&(this._setPanVector(e,n),this._transformPanVector(),this.component.position.add(as),this.component.updateMatrix())}panAtom(e,n){this.atom&&this.component&&(this.atom.positionToVector3(Yl),Yl.add(this.viewer.translationGroup.position),Yl.applyMatrix4(this.viewer.rotationGroup.matrix),this._setPanVector(e,n,Yl.z),this._transformPanVector(),this.atom.positionAdd(as),this.component.updateRepresentations({position:!0}))}rotate(e,n){const[i,r]=this._getRotateXY(e,n);this._getCameraRotation(On),ti.set(1,0,0),ti.applyMatrix4(On),Ra.setFromAxisAngle(ti,r),ti.set(0,1,0),ti.applyMatrix4(On),R0.setFromAxisAngle(ti,i),Ra.multiply(R0),On.makeRotationFromQuaternion(Ra),this.controls.applyMatrix(On)}zRotate(e,n){const i=this.rotateSpeed*((-e+n)/-2)*.01;I0.makeRotationZ(i),this.controls.applyMatrix(I0)}rotateComponent(e,n){if(!this.component)return;const[i,r]=this._getRotateXY(e,n);this._getCameraRotation(L0),On.extractRotation(this.component.transform),On.premultiply(this.viewer.rotationGroup.matrix),On.getInverse(On),On.premultiply(L0),ti.set(1,0,0),ti.applyMatrix4(On),Nd.makeRotationAxis(ti,r),ti.set(0,1,0),ti.applyMatrix4(On),zd.makeRotationAxis(ti,i),Nd.multiply(zd),Ra.setFromRotationMatrix(Nd),this.component.quaternion.premultiply(Ra),this.component.quaternion.normalize(),this.component.updateMatrix()}}const Js=new T;class BA{constructor(e,n){this.stage=n,this.pid=e.pid,this.picker=e.picker,this.instance=e.instance,this.stage=n,this.controls=n.viewerControls,this.mouse=n.mouseObserver}get type(){return this.picker.type}get altKey(){return this.mouse.altKey}get ctrlKey(){return this.mouse.ctrlKey}get metaKey(){return this.mouse.metaKey}get shiftKey(){return this.mouse.shiftKey}get canvasPosition(){return this.mouse.canvasPosition}get component(){return this.stage.getComponentsByObject(this.picker.data).list[0]}get object(){return this.picker.getObject(this.pid)}get position(){return this.picker.getPosition(this.pid,this.instance,this.component)}get closestBondAtom(){if(this.type!=="bond"||!this.bond)return;const e=this.bond,n=this.controls,i=this.canvasPosition,r=e.atom1.positionToVector3(),s=e.atom2.positionToVector3();r.applyMatrix4(this.component.matrix),s.applyMatrix4(this.component.matrix);const o=n.getPositionOnCanvas(r),a=n.getPositionOnCanvas(s);return l=o,h=a,(c=i).distanceTo(l)<c.distanceTo(h)?e.atom1:e.atom2;var c,l,h}get closeAtom(){const e=this.canvasPosition,n=this.closestBondAtom;if(!n)return;const i=n.positionToVector3().applyMatrix4(this.component.matrix),r=this.controls.getPositionOnCanvas(i);n.positionToVector3(Js),this.instance&&Js.applyMatrix4(this.instance.matrix),Js.applyMatrix4(this.component.matrix);const s=this.controls.viewer;Js.add(s.translationGroup.position),Js.applyMatrix4(s.rotationGroup.matrix);const o=this.controls.getCanvasScaleFactor(Js.z),a=this.component.getMaxRepresentationRadius(n.index);return e.distanceTo(r)<=a/o?n:void 0}get arrow(){return this._objectIfType("arrow")}get atom(){return this._objectIfType("atom")}get axes(){return this._objectIfType("axes")}get bond(){return this._objectIfType("bond")}get box(){return this._objectIfType("box")}get cone(){return this._objectIfType("cone")}get clash(){return this._objectIfType("clash")}get contact(){return this._objectIfType("contact")}get cylinder(){return this._objectIfType("cylinder")}get distance(){return this._objectIfType("distance")}get ellipsoid(){return this._objectIfType("ellipsoid")}get octahedron(){return this._objectIfType("octahedron")}get point(){return this._objectIfType("point")}get mesh(){return this._objectIfType("mesh")}get slice(){return this._objectIfType("slice")}get sphere(){return this._objectIfType("sphere")}get tetrahedron(){return this._objectIfType("tetrahedron")}get torus(){return this._objectIfType("torus")}get surface(){return this._objectIfType("surface")}get unitcell(){return this._objectIfType("unitcell")}get unknown(){return this._objectIfType("unknown")}get volume(){return this._objectIfType("volume")}get wideline(){return this._objectIfType("wideline")}_objectIfType(e){return this.type===e?this.object:void 0}getLabel(){const e=this.atom||this.closeAtom;let n="nothing";return this.arrow?n=this.arrow.name:e?n=`atom: ${e.qualifiedName()} (${e.structure.name})`:this.axes?n="axes":this.bond?n=`bond: ${this.bond.atom1.qualifiedName()} - ${this.bond.atom2.qualifiedName()} (${this.bond.structure.name})`:this.box?n=this.box.name:this.cone?n=this.cone.name:this.clash?n=`clash: ${this.clash.clash.sele1} - ${this.clash.clash.sele2}`:this.contact?n=`${this.contact.type}: ${this.contact.atom1.qualifiedName()} - ${this.contact.atom2.qualifiedName()} (${this.contact.atom1.structure.name})`:this.cylinder?n=this.cylinder.name:this.distance?n=`distance: ${this.distance.atom1.qualifiedName()} - ${this.distance.atom2.qualifiedName()} (${this.distance.structure.name})`:this.ellipsoid?n=this.ellipsoid.name:this.octahedron?n=this.octahedron.name:this.point?n=this.point.name:this.mesh?n=`mesh: ${this.mesh.name||this.mesh.serial} (${this.mesh.shape.name})`:this.slice?n=`slice: ${this.slice.value.toPrecision(3)} (${this.slice.volume.name})`:this.sphere?n=this.sphere.name:this.surface?n=`surface: ${this.surface.surface.name}`:this.tetrahedron?n=this.tetrahedron.name:this.torus?n=this.torus.name:this.unitcell?n=`unitcell: ${this.unitcell.unitcell.spacegroup} (${this.unitcell.structure.name})`:this.unknown?n="unknown":this.volume?n=`volume: ${this.volume.value.toPrecision(3)} (${this.volume.volume.name})`:this.wideline&&(n=this.wideline.name),n}}class OA{constructor(e){this.stage=e,this.viewer=e.viewer}pick(e,n){const i=this.viewer.pick(e,n);if(i.picker&&i.picker.type!=="ignore"&&i.pid!==void 0){const r=i.picker.array;if(!(r&&i.pid>=r.length))return new BA(i,this.stage);console.error("pid >= picker.array.length")}}}const D0=new Gt,B0=new T,O0=new T,Gd=new T,kA=new T,k0=new Ie,F0=new T,N0=new Ie;class FA{constructor(e){this.stage=e,this.signals={changed:new ot.Signal},this.viewer=e.viewer}get position(){return this.viewer.translationGroup.position}get rotation(){return this.viewer.rotationGroup.quaternion}changed(){this.viewer.requestRender(),this.signals.changed.dispatch()}getPositionOnCanvas(e,n){const i=Eu(n,Te),r=this.viewer;return Gd.copy(e).add(r.translationGroup.position).applyMatrix4(r.rotationGroup.matrix).project(r.camera),i.set((Gd.x+1)*r.width/2,(Gd.y+1)*r.height/2)}getCanvasScaleFactor(e=0){const n=this.viewer.camera;if(n instanceof Wr)return 1/n.zoom;{e=Math.abs(e),e+=this.getCameraDistance();const i=rn(n.fov);return 2*e*Math.tan(i/2)/this.viewer.height}}getOrientation(e){const n=Wa(e);n.copy(this.viewer.rotationGroup.matrix);const i=this.getCameraDistance();return n.scale(kA.set(i,i,i)),n.setPosition(this.viewer.translationGroup.position),n}orient(e){Wa(e).decompose(B0,D0,O0);const n=this.viewer;n.rotationGroup.setRotationFromQuaternion(D0),n.translationGroup.position.copy(B0),n.cameraDistance=O0.z,n.updateZoom(),this.changed()}translate(e){this.viewer.translationGroup.position.add(ps(e)),this.changed()}center(e){this.viewer.translationGroup.position.copy(ps(e)).negate(),this.changed()}zoom(e){this.distance(this.getCameraDistance()*(1-e))}getCameraDistance(){return this.viewer.cameraDistance}distance(e){this.viewer.cameraDistance=Math.max(Math.abs(e),.2),this.viewer.updateZoom(),this.changed()}spin(e,n){k0.getInverse(this.viewer.rotationGroup.matrix),F0.copy(ps(e)).applyMatrix4(k0),this.viewer.rotationGroup.rotateOnAxis(F0,n),this.changed()}rotate(e){this.viewer.rotationGroup.setRotationFromQuaternion(Sp(e)),this.changed()}align(e){N0.getInverse(Wa(e)),this.viewer.rotationGroup.setRotationFromMatrix(N0),this.changed()}applyMatrix(e){this.viewer.rotationGroup.applyMatrix4(Wa(e)),this.changed()}}class Ls{constructor(e,n,...i){this.pausedTime=-1,this.elapsedDuration=0,this.pausedDuration=0,this.ignoreGlobalToggle=!1,this._paused=!1,this._resolveList=[],this.duration=I(e,1e3),this.controls=n,this.startTime=window.performance.now(),this._init(...i)}get done(){return this.alpha===1}get paused(){return this._paused}tick(e){if(!this._paused)return this.elapsedDuration=e.currentTime-this.startTime-this.pausedDuration,this.duration===0?this.alpha=1:this.alpha=Jc(0,1,this.elapsedDuration/this.duration),this._tick(e),this.done&&this._resolveList.forEach(n=>n()),this.done}pause(e){e&&(this._hold=!0),this.pausedTime===-1&&(this.pausedTime=window.performance.now()),this._paused=!0}resume(e){!e&&this._hold||(this.pausedDuration+=window.performance.now()-this.pausedTime,this._paused=!1,this._hold=!1,this.pausedTime=-1)}toggle(){this._paused?this.resume():this.pause()}then(e){let n;return n=this.done?Promise.resolve():new Promise(i=>this._resolveList.push(i)),n.then(e)}}class z0 extends Ls{constructor(e,n,...i){super(I(e,1/0),n,...i)}_init(e,n){Array.isArray(e)?this.axis=new T().fromArray(e):this.axis=I(e,new T(0,1,0)),this.angle=I(n,.01)}_tick(e){this.axis&&this.angle&&this.controls.spin(this.axis,this.angle*e.lastDuration/16)}}class G0 extends Ls{constructor(e,n,...i){super(I(e,1/0),n,...i),this.angleSum=0,this.direction=1}_init(e,n,i){Array.isArray(e)?this.axis=new T().fromArray(e):this.axis=I(e,new T(0,1,0)),this.angleStep=I(n,.01),this.angleEnd=I(i,.2)}_tick(e){if(!this.axis||!this.angleStep||!this.angleEnd)return;const n=Jc(0,1,Math.abs(this.angleSum)/this.angleEnd),i=this.angleStep*this.direction*(1.1-n);this.controls.spin(this.axis,i*e.lastDuration/16),this.angleSum+=this.angleStep,this.angleSum>=this.angleEnd&&(this.direction*=-1,this.angleSum=-this.angleEnd)}}class U0 extends Ls{_init(e,n){this.moveFrom=ps(I(e,new T)),this.moveTo=ps(I(n,new T))}_tick(){this.controls.position.lerpVectors(this.moveFrom,this.moveTo,this.alpha).negate(),this.controls.changed()}}class NA extends Ls{_init(e,n){this.zoomFrom=e,this.zoomTo=n}_tick(){this.controls.distance(ri(this.zoomFrom,this.zoomTo,this.alpha))}}class zA extends Ls{constructor(){super(...arguments),this._currentRotation=new Gt}_init(e,n){this.rotateFrom=Sp(e),this.rotateTo=Sp(n),this._currentRotation=new Gt}_tick(){this._currentRotation.copy(this.rotateFrom).slerp(this.rotateTo,this.alpha),this.controls.rotate(this._currentRotation)}}class GA extends Ls{_init(e,n,i){this.valueFrom=e,this.valueTo=n,this.callback=i}_tick(){this.callback(ri(this.valueFrom,this.valueTo,this.alpha))}}class UA extends Ls{_init(e){this.callback=e}_tick(){this.alpha===1&&this.callback()}}class V0{constructor(e=[]){this._resolveList=[],this._list=e}get done(){return this._list.every(e=>e.done)}then(e){let n;return n=this.done?Promise.resolve():new Promise(i=>{this._resolveList.push(i),this._list.forEach(r=>{r.then(()=>{this._resolveList.forEach(s=>{s()}),this._resolveList.length=0})})}),n.then(e)}}class VA{constructor(e){this.stage=e,this.animationList=[],this.finishedList=[],this.viewer=e.viewer,this.controls=e.viewerControls}get paused(){return this.animationList.every(e=>e.paused)}add(e){return e.duration===0?e.tick(this.viewer.stats):this.animationList.push(e),e}remove(e){const n=this.animationList,i=n.indexOf(e);i>-1&&n.splice(i,1)}run(e){const n=this.finishedList,i=this.animationList,r=i.length;for(let o=0;o<r;++o){const a=i[o];a.tick(e)&&n.push(a)}const s=n.length;if(s){for(let o=0;o<s;++o)this.remove(n[o]);n.length=0}}spin(e,n,i){return this.add(new z0(i,this.controls,e,n))}rock(e,n,i,r){return this.add(new G0(r,this.controls,e,n,i))}rotate(e,n){const i=this.viewer.rotationGroup.quaternion.clone();return this.add(new zA(n,this.controls,i,e))}move(e,n){const i=this.controls.position.clone().negate();return this.add(new U0(n,this.controls,i,e))}zoom(e,n){const i=this.viewer.camera.position.z;return this.add(new NA(n,this.controls,i,e))}zoomMove(e,n,i){return new V0([this.move(e,i),this.zoom(n,i)])}orient(e,n){const i=new T,r=new Gt,s=new T;return Wa(e).decompose(i,r,s),new V0([this.move(i.negate(),n),this.rotate(r,n),this.zoom(-s.x,n)])}value(e,n,i,r){return this.add(new GA(r,this.controls,e,n,i))}timeout(e,n){return this.add(new UA(n,this.controls,e))}spinComponent(e,n,i,r){return this.add(new z0(r,e.controls,n,i))}rockComponent(e,n,i,r,s){return this.add(new G0(s,e.controls,n,i,r))}moveComponent(e,n,i){const r=e.controls.position.clone().negate();return this.add(new U0(i,e.controls,r,n))}pause(){this.animationList.forEach(e=>e.pause())}resume(){this.animationList.forEach(e=>e.resume())}toggle(){this.paused?this.resume():this.pause()}clear(){this.animationList.length=0}dispose(){this.clear()}}class HA{constructor(e,n){if(this.fn=e,this.queue=[],this.pending=!1,this.next=this.next.bind(this),n){for(let i=0,r=n.length;i<r;++i)this.queue.push(n[i]);this.next()}}run(e){this.fn(e,this.next)}next(){const e=this.queue.shift();e!==void 0?(this.pending=!0,setTimeout(()=>this.run(e))):this.pending=!1}push(e){this.queue.push(e),this.pending||this.next()}kill(){this.queue.length=0}length(){return this.queue.length}}class tl{constructor(e,n,i){this.type="",this.parameters={lazy:{type:"boolean"},clipNear:{type:"range",step:1,max:100,min:0,buffer:!0},clipRadius:{type:"number",precision:1,max:1e3,min:0,buffer:!0},clipCenter:{type:"vector3",precision:1,buffer:!0},flatShaded:{type:"boolean",buffer:!0},opacity:{type:"range",step:.01,max:1,min:0,buffer:!0},depthWrite:{type:"boolean",buffer:!0},side:{type:"select",buffer:!0,options:{front:"front",back:"back",double:"double"}},wireframe:{type:"boolean",buffer:!0},colorData:{type:"hidden",update:"color"},colorScheme:{type:"select",update:"color",options:{}},colorScale:{type:"select",update:"color",options:mt.getScales()},colorReverse:{type:"boolean",update:"color"},colorValue:{type:"color",update:"color"},colorDomain:{type:"hidden",update:"color"},colorMode:{type:"select",update:"color",options:mt.getModes()},roughness:{type:"range",step:.01,max:1,min:0,buffer:!0},metalness:{type:"range",step:.01,max:1,min:0,buffer:!0},diffuse:{type:"color",buffer:!0},diffuseInterior:{type:"boolean",buffer:!0},useInteriorColor:{type:"boolean",buffer:!0},interiorColor:{type:"color",buffer:!0},interiorDarkening:{type:"range",step:.01,max:1,min:0,buffer:!0},matrix:{type:"hidden",buffer:!0},disablePicking:{type:"boolean",rebuild:!0}},this.viewer=n,this.tasks=new Bx,this.queue=new HA(this.make.bind(this)),this.bufferList=[],this.parameters.colorScheme&&(this.parameters.colorScheme.options=mt.getSchemes()),this.toBePrepared=!1}init(e){const n=e||{};this.clipNear=I(n.clipNear,0),this.clipRadius=I(n.clipRadius,0),this.clipCenter=I(n.clipCenter,new T),this.flatShaded=I(n.flatShaded,!1),this.side=I(n.side,"double"),this.opacity=I(n.opacity,1),this.depthWrite=I(n.depthWrite,!0),this.wireframe=I(n.wireframe,!1),this.setColor(n.color,n),this.colorData=I(n.colorData,void 0),this.colorScheme=I(n.colorScheme,"uniform"),this.colorScale=I(n.colorScale,""),this.colorReverse=I(n.colorReverse,!1),this.colorValue=I(n.colorValue,9474192),this.colorDomain=I(n.colorDomain,void 0),this.colorMode=I(n.colorMode,"hcl"),this.visible=I(n.visible,!0),this.quality=I(n.quality,void 0),this.roughness=I(n.roughness,.4),this.metalness=I(n.metalness,0),this.diffuse=I(n.diffuse,16777215),this.diffuseInterior=I(n.diffuseInterior,!1),this.useInteriorColor=I(n.useInteriorColor,!1),this.interiorColor=I(n.interiorColor,2236962),this.interiorDarkening=I(n.interiorDarkening,0),this.lazy=I(n.lazy,!1),this.lazyProps={build:!1,bufferParams:{},what:{}},this.matrix=I(n.matrix,new Ie),this.disablePicking=I(n.disablePicking,!1);const i=this.parameters;i.sphereDetail===!0&&(i.sphereDetail={type:"integer",max:3,min:0,rebuild:"impostor"}),i.radialSegments===!0&&(i.radialSegments={type:"integer",max:25,min:5,rebuild:"impostor"}),i.openEnded===!0&&(i.openEnded={type:"boolean",rebuild:"impostor",buffer:!0}),i.disableImpostor===!0&&(i.disableImpostor={type:"boolean",rebuild:!0}),n.quality==="low"?(i.sphereDetail&&(this.sphereDetail=0),i.radialSegments&&(this.radialSegments=5)):n.quality==="medium"?(i.sphereDetail&&(this.sphereDetail=1),i.radialSegments&&(this.radialSegments=10)):n.quality==="high"?(i.sphereDetail&&(this.sphereDetail=2),i.radialSegments&&(this.radialSegments=20)):(i.sphereDetail&&(this.sphereDetail=I(n.sphereDetail,1)),i.radialSegments&&(this.radialSegments=I(n.radialSegments,10))),i.openEnded&&(this.openEnded=I(n.openEnded,!0)),i.disableImpostor&&(this.disableImpostor=I(n.disableImpostor,!1))}getColorParams(e){return Object.assign({data:this.colorData,scheme:this.colorScheme,scale:this.colorScale,reverse:this.colorReverse,value:this.colorValue,domain:this.colorDomain,mode:this.colorMode,colorSpace:this.colorSpace},e)}getBufferParams(e={}){return Object.assign({clipNear:this.clipNear,clipRadius:this.clipRadius,clipCenter:this.clipCenter,flatShaded:this.flatShaded,opacity:this.opacity,depthWrite:this.depthWrite,side:this.side,wireframe:this.wireframe,roughness:this.roughness,metalness:this.metalness,diffuse:this.diffuse,diffuseInterior:this.diffuseInterior,useInteriorColor:this.useInteriorColor,interiorColor:this.interiorColor,interiorDarkening:this.interiorDarkening,matrix:this.matrix,disablePicking:this.disablePicking},e)}setColor(e,n){const i=Object.keys(mt.getSchemes());if(typeof e=="string"&&i.includes(e.toLowerCase()))n?n.colorScheme=e:this.setParameters({colorScheme:e});else if(e!==void 0){let r=new ke(e).getHex();n?(n.colorScheme="uniform",n.colorValue=r):this.setParameters({colorScheme:"uniform",colorValue:r})}return this}prepare(e){}create(){}update(e){this.build()}build(e){if(!this.lazy||this.visible&&this.opacity){if(!this.toBePrepared)return this.tasks.increment(),void this.make();this.queue.length()>0?(this.tasks.change(1-this.queue.length()),this.queue.kill()):this.tasks.increment(),this.queue.push(e||!1)}else this.lazyProps.build=!0}make(e,n){Ce&&fe.time("Representation.make "+this.type);const i=()=>{e?(this.update(e),this.viewer.requestRender(),this.tasks.decrement(),n&&n()):(this.clear(),this.create(),this.manualAttach||this.disposed||(Ce&&fe.time("Representation.attach "+this.type),this.attach(()=>{Ce&&fe.timeEnd("Representation.attach "+this.type),this.tasks.decrement(),n&&n()}))),Ce&&fe.timeEnd("Representation.make "+this.type)};this.toBePrepared?this.prepare(i):i()}attach(e){this.setVisibility(this.visible),e()}setVisibility(e,n){if(this.visible=e,this.visible&&this.opacity){const i=this.lazyProps,r=i.bufferParams,s=i.what;if(i.build)return i.build=!1,this.build(),this;(Object.keys(r).length||Object.keys(s).length)&&(i.bufferParams={},i.what={},this.updateParameters(r,s))}return this.bufferList.forEach(function(i){i.setVisibility(e)}),n||this.viewer.requestRender(),this}setParameters(e,n={},i=!1){const r=e||{},s=this.parameters,o={};this.opacity||r.opacity===void 0||(this.lazyProps.build?(this.lazyProps.build=!1,i=!0):(Object.assign(o,this.lazyProps.bufferParams),Object.assign(n,this.lazyProps.what),this.lazyProps.bufferParams={},this.lazyProps.what={})),this.setColor(r.color,r);for(let a in r)r[a]!==void 0&&s[a]!=null&&(s[a].int&&(r[a]=parseInt(r[a])),s[a].float&&(r[a]=parseFloat(r[a])),r[a]!==this[a]||r[a].equals&&!r[a].equals(this[a]))&&(this[a]&&this[a].copy&&r[a].copy?this[a].copy(r[a]):this[a]&&this[a].set?this[a].set(r[a]):this[a]=r[a],s[a].buffer&&(s[a].buffer===!0?o[a]=r[a]:o[s[a].buffer]=r[a]),s[a].update&&(n[s[a].update]=!0),!s[a].rebuild||s[a].rebuild==="impostor"&&ki&&!this.disableImpostor||(i=!0));return i?this.build():this.updateParameters(o,n),this}updateParameters(e={},n){if(this.lazy&&(!this.visible||!this.opacity)&&e.hasOwnProperty("opacity")===!1)return Object.assign(this.lazyProps.bufferParams,e),void Object.assign(this.lazyProps.what,n);this.bufferList.forEach(function(i){i.setParameters(e)}),Object.keys(n).length&&this.update(n),this.viewer.requestRender()}getParameters(){const e={lazy:this.lazy,visible:this.visible,quality:this.quality};return Object.keys(this.parameters).forEach(n=>{this.parameters[n]!==null&&(e[n]=this[n])}),e}clear(){this.bufferList.forEach(e=>{this.viewer.remove(e),e.dispose()}),this.bufferList.length=0,this.viewer.requestRender()}dispose(){this.disposed=!0,this.queue.kill(),this.tasks.dispose(),this.clear()}}class Fx{constructor(e){this.pending=0,this.postCount=0,this.onmessageDict={},this.onerrorDict={},this.name=e,this.blobUrl=window.URL.createObjectURL(ec.get(e)),this.worker=new Worker(this.blobUrl),ec.activeWorkerCount+=1,this.worker.onmessage=n=>{this.pending-=1;const i=n.data.__postId;Ce&&fe.timeEnd("Worker.postMessage "+e+" #"+i);const r=this.onmessageDict[i];r&&r.call(this.worker,n),delete this.onmessageDict[i],delete this.onerrorDict[i]},this.worker.onerror=n=>{if(this.pending-=1,n.data){const i=n.data.__postId,r=this.onerrorDict[i];r?r.call(this.worker,n):fe.error("Worker.onerror",i,e,n),delete this.onmessageDict[i],delete this.onerrorDict[i]}else fe.error("Worker.onerror",e,n)}}post(e={},n,i,r){this.onmessageDict[this.postCount]=i,this.onerrorDict[this.postCount]=r,e.__name=this.name,e.__postId=this.postCount,e.__debug=Ce,Ce&&fe.time(`Worker.postMessage ${this.name} #${this.postCount}`);try{this.worker.postMessage(e,n)}catch(s){fe.error("worker.post:",s),this.worker.postMessage(e)}return this.pending+=1,this.postCount+=1,this}terminate(){this.worker?(this.worker.terminate(),window.URL.revokeObjectURL(this.blobUrl),ec.activeWorkerCount-=1):fe.log("no worker to terminate")}}class Cp{constructor(e,n=2){this.pool=[],this.count=0,this.maxCount=Math.min(8,n),this.name=e}post(e={},n,i,r){const s=this.getNextWorker();return s?s.post(e,n,i,r):console.error("unable to get worker from pool"),this}terminate(){this.pool.forEach(function(e){e.terminate()})}getNextWorker(){let e,n=1/0;for(let i=0;i<this.maxCount;++i){if(i>=this.count){e=new Fx(this.name),this.pool.push(e),this.count+=1;break}const r=this.pool[i];if(r.pending===0){e=r;break}r.pending<n&&(n=r.pending,e=r)}return e}}function Tp(t){const e=t.length,n=e/3;let i=0,r=0,s=0;for(let o=0;o<e;o+=3)i+=t[o+0],r+=t[o+1],s+=t[o+2];return new T(i/n,r/n,s/n)}function ms(t,e,n){return n?t.sub(n).projectOnVector(e).add(n):t.projectOnVector(e),t}function Nc(t){let e=1/0,n=1/0,i=1/0,r=-1/0,s=-1/0,o=-1/0;for(let a=0,c=t.length;a<c;a+=3){const l=t[a],h=t[a+1],u=t[a+2];l<e&&(e=l),h<n&&(n=h),u<i&&(i=u),l>r&&(r=l),h>s&&(s=h),u>o&&(o=u)}return[st([e,n,i]),st([r,s,o])]}function Lu(t,e){for(let n=0,i=e.length;n<i;n+=3){const r=e[n],s=e[n+1],o=e[n+2];e[n]=t[0]*r+t[4]*s+t[8]*o+t[12],e[n+1]=t[1]*r+t[5]*s+t[9]*o+t[13],e[n+2]=t[2]*r+t[6]*s+t[10]*o+t[14]}}function pm(t,e){for(let n=0,i=e.length;n<i;n+=3){const r=e[n],s=e[n+1],o=e[n+2];e[n]=t[0]*r+t[3]*s+t[6]*o,e[n+1]=t[1]*r+t[4]*s+t[7]*o,e[n+2]=t[2]*r+t[5]*s+t[8]*o}}function Nx(t){for(let e=0,n=t.length;e<n;e+=3){const i=t[e],r=t[e+1],s=t[e+2],o=i*i+r*r+s*s;if(o>0){const a=1/Math.sqrt(o);t[e]=i*a,t[e+1]=r*a,t[e+2]=s*a}}}function st(t){return new Float32Array(t||3)}function Vn(t,e,n){const i=e[0],r=e[1],s=e[2],o=n[0],a=n[1],c=n[2];t[0]=r*c-s*a,t[1]=s*o-i*c,t[2]=i*a-r*o}function Fn(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Qt(t,e,n){t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2]}function yi(t,e,n){t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2]}function Ln(t,e,n=0){t[0]=e[n],t[1]=e[n+1],t[2]=e[n+2]}function lt(t,e,n=0){e[n]=t[0],e[n+1]=t[1],e[n+2]=t[2]}function zx(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function zr(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}function po(t,e,n){kt(t,e,1/n)}function kt(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n}function nn(t,e){const n=zx(e);n==0?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):kt(t,e,1/Math.sqrt(n))}function Gx(t,e,n){t[0]=e[0]-n,t[1]=e[1]-n,t[2]=e[2]-n}function _h(t,e,n){t[0]=e[0]+n,t[1]=e[1]+n,t[2]=e[2]+n}function Pp(t,e){t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2])}function qa(t,e){t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2])}function Ru(t,e){t[0]=-e[0],t[1]=-e[1],t[2]=-e[2]}function $A(t,e){const n=t[0],i=t[1],r=t[2],s=e[0],o=e[1],a=e[2],c=i*a-r*o,l=r*s-n*a,h=n*o-i*s,u=Math.sqrt(c*c+l*l+h*h),f=n*s+i*o+r*a;return Math.atan2(u,f)}function WA(t,e=9){const n=Math.floor(e/2),i=t.position1.length/3,r=3*(n*i),s=1/e,o=Iu(t.position1,t.position2),a=new Float32Array(r),c=new Float32Array(r),l=new T;for(let d=0;d<i;++d){const p=3*d;l.set(o[p],o[p+1],o[p+2]);const y=t.position1[p],g=t.position1[p+1],m=t.position1[p+2];for(let x=0;x<n;++x){const v=n*p+3*x,b=s*(2*x+1),_=s*(2*x+2);a[v]=y+l.x*b,a[v+1]=g+l.y*b,a[v+2]=m+l.z*b,c[v]=y+l.x*_,c[v+1]=g+l.y*_,c[v+2]=m+l.z*_}}const h=Fi(a,c),u=function(d,p){const y=d.length/3,g=new Float32Array(y*p*3);for(let m=0;m<y;++m){const x=3*m,v=m*p*3,b=d[x+0],_=d[x+1],C=d[x+2];for(let w=0;w<p;++w){const S=v+3*w;g[S+0]=b,g[S+1]=_,g[S+2]=C}}return g}(t.color,n),f={position:h,position1:a,position2:c,color:u,color2:u};return t.radius&&(f.radius=Bd(t.radius,n)),t.picking&&t.picking.array&&(t.picking.array=Bd(t.picking.array,n),f.picking=t.picking),t.primitiveId&&(f.primitiveId=Bd(t.primitiveId,n)),f}function Ux(t,e=.1){const n=Iu(t.position1,t.position2),i=[],r=[],s=[],o=t.radius?[]:void 0,a=t.picking?[]:void 0,c=t.primitiveId?[]:void 0,l=new T,h=t.position1.length/3;let u=0;for(let m=0;m<h;++m){const x=3*m;l.set(n[x],n[x+1],n[x+2]);const v=l.length()/e,b=Math.floor(v/2),_=1/v,C=t.position1[x],w=t.position1[x+1],S=t.position1[x+2];for(let M=0;M<b;++M){const B=3*u+3*M,L=_*(2*M+1),U=_*(2*M+2);i[B]=C+l.x*L,i[B+1]=w+l.y*L,i[B+2]=S+l.z*L,r[B]=C+l.x*U,r[B+1]=w+l.y*U,r[B+2]=S+l.z*U,t.color&&(s[B]=t.color[x],s[B+1]=t.color[x+1],s[B+2]=t.color[x+2]),o&&(o[u+M]=t.radius[m]),a&&(t.picking.array?a[u+M]=t.picking.array[m]:a[u+M]=m),c&&(c[u+M]=t.primitiveId[m])}u+=b}const f=new Float32Array(i),d=new Float32Array(r),p=Fi(f,d),y=new Float32Array(s),g={position:p,position1:f,position2:d,color:y,color2:y};return o&&(g.radius=new Float32Array(o)),a&&t.picking&&(t.picking.array=new Float32Array(a),g.picking=t.picking),c&&(g.primitiveId=new Float32Array(c)),g}function Ep(t,e=.1){const n=Iu(t.position1,t.position2),i=[],r=[],s=[],o=t.radius?[]:void 0,a=t.picking?[]:void 0,c=t.primitiveId?[]:void 0,l=new T,h=t.position1.length/3;let u=e,f=!0,d=0,p=0,y=0;for(let _=0;_<h;++_){const C=3*_,w=t.position1[C],S=t.position1[C+1],M=t.position1[C+2];l.set(n[C],n[C+1],n[C+2]);const B=l.length();f&&(i[p]=w,i[p+1]=S,i[p+2]=M);let L=u;const U=1/B;for(;L<B;){const E=f?r:i;E[p]=w+l.x*L*U,E[p+1]=S+l.y*L*U,E[p+2]=M+l.z*L*U,f&&(d++,p=3*d),f=!f,u=e,L+=e}f&&(r[p]=t.position2[C],r[p+1]=t.position2[C+1],r[p+2]=t.position2[C+2],d++,p=3*d),u=L-B;for(let E=y;E<d;E++){if(t.color){const O=3*E;s[O]=t.color[C],s[O+1]=t.color[C+1],s[O+2]=t.color[C+2]}o&&(o[E]=t.radius[_]),a&&(t.picking.array?a[E]=t.picking.array[_]:a[E]=_),c&&(c[E]=t.primitiveId[_])}y=d}if(!f&&h>0){const _=3*d;r[_]=t.position2[3*h-3],r[_+1]=t.position2[3*h-2],r[_+1]=t.position2[3*h-1]}const g=new Float32Array(i),m=new Float32Array(r),x=Fi(g,m),v=new Float32Array(s),b={position:x,position1:g,position2:m,color:v,color2:v};return o&&(b.radius=new Float32Array(o)),a&&t.picking&&(t.picking.array=new Float32Array(a),b.picking=t.picking),c&&(b.primitiveId=new Float32Array(c)),b}Cp.prototype.constructor=Cp,Nc.__deps=[st],po.__deps=[kt],nn.__deps=[kt,zx];const qr=new T;class Xr{static get Picker(){return ni.get(this.type)}static get Buffer(){return Qn.get(this.type)}static getShapeKey(e){return this.type+e[0].toUpperCase()+e.substr(1)}static expandBoundingBox(e,n){}static valueToShape(e,n,i){const r=e._primitiveData[this.getShapeKey(n)];switch(this.fields[n]){case"v3":case"c":o=r,(s=i).toArray!==void 0?s=s.toArray():s.x!==void 0?s=[s.x,s.y,s.z]:s.r!==void 0&&(s=[s.r,s.g,s.b]),o.push.apply(o,s);break;default:r.push(i)}var s,o}static objectToShape(e,n){Object.keys(this.fields).forEach(i=>{this.valueToShape(e,i,n[i])}),this.valueToShape(e,"name",n.name),this.expandBoundingBox(e.boundingBox,n)}static valueFromShape(e,n,i){const r=e._primitiveData[this.getShapeKey(i)];switch(this.fields[i]){case"v3":return new T().fromArray(r,3*n);case"c":return new ke().fromArray(r,3*n);default:return r[n]}}static objectFromShape(e,n){let i=this.valueFromShape(e,n,"name");i===void 0&&(i=`${this.type}: ${n} (${e.name})`);const r={shape:e,name:i};return Object.keys(this.fields).forEach(s=>{r[s]=this.valueFromShape(e,n,s)}),r}static arrayFromShape(e,n){const i=e._primitiveData[this.getShapeKey(n)];return this.fields[n]==="s"?i:new Float32Array(i)}static dataFromShape(e){const n={};return this.Picker&&(n.picking=new this.Picker(e)),Object.keys(this.fields).forEach(i=>{n[i]=this.arrayFromShape(e,i)}),n}static bufferFromShape(e,n){return new this.Buffer(this.dataFromShape(e),n)}}Xr.type="",Xr.fields={};class Wo extends Xr{static positionFromShape(e,n){return this.valueFromShape(e,n,"position")}static expandBoundingBox(e,n){e.expandByPoint(qr.fromArray(n.position))}}Wo.type="sphere",Wo.fields={position:"v3",color:"c",radius:"f"};class Ts extends Xr{static positionFromShape(e,n){return this.valueFromShape(e,n,"position")}static expandBoundingBox(e,n){e.expandByPoint(qr.fromArray(n.position))}}Ts.type="box",Ts.fields={position:"v3",color:"c",size:"f",heightAxis:"v3",depthAxis:"v3"};class Du extends Ts{}Du.type="octahedron";class Bu extends Ts{}Bu.type="tetrahedron";class Ps extends Xr{static positionFromShape(e,n){const i=this.valueFromShape(e,n,"position1"),r=this.valueFromShape(e,n,"position2");return i.add(r).multiplyScalar(.5)}static expandBoundingBox(e,n){e.expandByPoint(qr.fromArray(n.position1)),e.expandByPoint(qr.fromArray(n.position2))}static bufferFromShape(e,n={}){let i=this.dataFromShape(e);return this.type==="cylinder"&&n.dashedCylinder&&(i=Ux(i)),new this.Buffer(i,n)}}Ps.type="cylinder",Ps.fields={position1:"v3",position2:"v3",color:"c",radius:"f"};class Ou extends Ps{}Ou.type="arrow";class ku extends Ps{}ku.type="cone";class jo extends Wo{}jo.type="ellipsoid",jo.fields={position:"v3",color:"c",radius:"f",majorAxis:"v3",minorAxis:"v3"};class Fu extends jo{}Fu.type="torus";class fu extends Xr{static positionFromShape(e,n){return this.valueFromShape(e,n,"position")}static expandBoundingBox(e,n){e.expandByPoint(qr.fromArray(n.position))}}fu.type="text",fu.fields={position:"v3",color:"c",size:"f",text:"s"};class zc extends Xr{static positionFromShape(e,n){return this.valueFromShape(e,n,"position")}static expandBoundingBox(e,n){e.expandByPoint(qr.fromArray(n.position))}}zc.type="point",zc.fields={position:"v3",color:"c"};class Gc extends Xr{static positionFromShape(e,n){const i=this.valueFromShape(e,n,"position1"),r=this.valueFromShape(e,n,"position2");return i.add(r).multiplyScalar(.5)}static expandBoundingBox(e,n){e.expandByPoint(qr.fromArray(n.position1)),e.expandByPoint(qr.fromArray(n.position2))}}Gc.type="wideline",Gc.fields={position1:"v3",position2:"v3",color:"c"};class Uc{constructor(e,n){this.exp=3;const i=n||function(g){const{x:m,y:x,z:v}=g,b=new Ut,_=m.length,{min:C,max:w}=b;for(let S=0;S<_;S++)C.x=Math.min(m[S],C.x),C.y=Math.min(x[S],C.y),C.z=Math.min(v[S],C.z),w.x=Math.max(m[S],w.x),w.y=Math.max(x[S],w.y),w.z=Math.max(v[S],w.z);return b}(e);this.minX=i.min.x,this.minY=i.min.y,this.minZ=i.min.z,this.boundX=1+(i.max.x-this.minX>>this.exp),this.boundY=1+(i.max.y-this.minY>>this.exp),this.boundZ=1+(i.max.z-this.minZ>>this.exp);const r=this.boundX*this.boundY*this.boundZ,s=e.count!==void 0?e.count:e.x.length,o=e.x,a=e.y,c=e.z;let l=0;const h=new Uint32Array(r),u=new Int32Array(s);for(let g=0;g<s;++g){const m=o[g]-this.minX>>this.exp,x=a[g]-this.minY>>this.exp,v=c[g]-this.minZ>>this.exp,b=(m*this.boundY+x)*this.boundZ+v;(h[b]+=1)===1&&(l+=1),u[g]=b}const f=new Uint16Array(l);for(let g=0,m=0;g<r;++g){const x=h[g];x>0&&(h[g]=m+1,f[m]=x,m+=1)}const d=new Uint32Array(l);for(let g=1;g<l;++g)d[g]+=d[g-1]+f[g-1];const p=new Uint16Array(l),y=new Int32Array(s);for(let g=0;g<s;++g){const m=h[u[g]];if(m>0){const x=m-1;y[d[x]+p[x]]=g,p[x]+=1}}this.grid=h,this.bucketCount=f,this.bucketOffset=d,this.bucketArray=y,this.xArray=o,this.yArray=a,this.zArray=c}within(e,n,i,r){const s=[];return this.eachWithin(e,n,i,r,o=>s.push(o)),s}eachWithin(e,n,i,r,s){const o=r*r,a=Math.max(0,e-r-this.minX>>this.exp),c=Math.max(0,n-r-this.minY>>this.exp),l=Math.max(0,i-r-this.minZ>>this.exp),h=Math.min(this.boundX,1+(e+r-this.minX>>this.exp)),u=Math.min(this.boundY,1+(n+r-this.minY>>this.exp)),f=Math.min(this.boundZ,1+(i+r-this.minZ>>this.exp));for(let d=a;d<h;++d)for(let p=c;p<u;++p)for(let y=l;y<f;++y){const g=(d*this.boundY+p)*this.boundZ+y,m=this.grid[g];if(m>0){const x=m-1,v=this.bucketOffset[x],b=v+this.bucketCount[x];for(let _=v;_<b;++_){const C=this.bucketArray[_],w=this.xArray[C]-e,S=this.yArray[C]-n,M=this.zArray[C]-i,B=w*w+S*S+M*M;B<=o&&s(C,B)}}}}}class ta{constructor(e=0){this._fields=this._defaultFields,this._init(0)}get _defaultFields(){return[]}_init(e){this.length=e,this.count=0;for(let n=0,i=this._fields.length;n<i;++n){const[r,s,o]=this._fields[n];this._initField(r,s,o)}}_initField(e,n,i){this[e]=Ax(i,this.length*n)}addField(e,n,i){this._fields.push([e,n,i]),this._initField(e,n,i)}resize(e){this.length=Math.round(e||0),this.count=Math.min(this.count,this.length);for(let n=0,i=this._fields.length;n<i;++n){const r=this._fields[n][0],s=this._fields[n][1],o=this.length*s,a=new this[r].constructor(o);this[r].length>o?a.set(this[r].subarray(0,o)):a.set(this[r]),this[r]=a}}growIfFull(){if(this.count>=this.length){const e=Math.round(1.5*this.length);this.resize(Math.max(256,e))}}copyFrom(e,n,i,r){for(let s=0,o=this._fields.length;s<o;++s){const a=this._fields[s][0],c=this._fields[s][1],l=this[a],h=e[a];for(let u=0;u<r;++u){const f=c*(n+u),d=c*(i+u);for(let p=0;p<c;++p)l[f+p]=h[d+p]}}}copyWithin(e,n,i){for(let r=0,s=this._fields.length;r<s;++r){const o=this._fields[r][0],a=this._fields[r][1],c=this[o];for(let l=0;l<i;++l){const h=a*(e+l),u=a*(n+l);for(let f=0;f<a;++f)c[h+f]=c[u+f]}}}sort(e){fe.time("Store.sort");const n=this,i=new this.constructor(1);(function r(s,o){if(s<o){let l=Math.floor((s+o)/2),h=s,u=o;do{for(;e(h,l)<0;)h+=1;for(;e(u,l)>0;)u-=1;h<=u&&(h===l?l=u:u===l&&(l=h),(a=h)!==(c=u)&&(i.copyFrom(n,0,a,1),n.copyWithin(a,c,1),n.copyFrom(i,c,0,1)),h+=1,u-=1)}while(h<=u);r(s,u),r(h,o)}var a,c})(0,this.count-1),fe.timeEnd("Store.sort")}clear(){this.count=0}dispose(){for(let e=0,n=this._fields.length;e<n;++e)delete this[this._fields[e][0]]}}class jA extends ta{get _defaultFields(){return[["index1",1,"int32"],["index2",1,"int32"],["type",1,"int8"]]}addContact(e,n,i){this.growIfFull();const r=this.count;e<n?(this.index1[r]=e,this.index2[r]=n):(this.index2[r]=e,this.index1[r]=n),i&&(this.type[r]=i),this.count+=1}}function Zl(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24}class xn{constructor(e,n){this.length=e,this._words=new Uint32Array(e+32>>>5),n===!0&&this.setAll()}get(e){return(this._words[e>>>5]&1<<e)!=0}set(e){this._words[e>>>5]|=1<<e}clear(e){this._words[e>>>5]&=~(1<<e)}flip(e){this._words[e>>>5]^=1<<e}_assignRange(e,n,i){if(n<e)return;const r=this._words,s=i===!0?4294967295:0,o=e>>>5,a=n>>>5;for(let h=o+1;h<a;++h)r[h]=s;const c=o<<5,l=a<<5;if(i===!0)if(n-e<32)for(let h=e,u=n+1;h<u;++h)r[h>>>5]|=1<<h;else{for(let h=e,u=c+32;h<u;++h)r[h>>>5]|=1<<h;for(let h=l,u=n+1;h<u;++h)r[h>>>5]|=1<<h}else if(n-e<32)for(let h=e,u=n+1;h<u;++h)r[h>>>5]&=~(1<<h);else{for(let h=e,u=c+32;h<u;++h)r[h>>>5]&=~(1<<h);for(let h=l,u=n+1;h<u;++h)r[h>>>5]&=~(1<<h)}return this}setRange(e,n){return this._assignRange(e,n,!0)}clearRange(e,n){return this._assignRange(e,n,!1)}setBits(...e){const n=this._words,i=e.length;for(let r=0;r<i;++r){const s=e[r];n[s>>>5]|=1<<s}return this}clearBits(...e){const n=this._words,i=e.length;for(let r=0;r<i;++r){const s=e[r];n[s>>>5]&=~(1<<s)}return this}setAll(){return this._assignRange(0,this.length-1,!0)}clearAll(){return this._assignRange(0,this.length-1,!1)}flipAll(){const e=this._words.length,n=this._words,i=32-this.length%32;for(let r=0;r<e-1;++r)n[r]=~n[r];return n[e-1]=~(n[e-1]<<i)>>>i,this}_isRangeValue(e,n,i){if(n<e)return;const r=this._words,s=i===!0?4294967295:0,o=e>>>5,a=n>>>5;for(let c=o+1;c<a;++c)if(r[c]!==s)return!1;if(n-e<32){for(let c=e,l=n+1;c<l;++c)if(!!(r[c>>>5]&1<<c)!==i)return!1}else{const c=a<<5;for(let l=e,h=(o<<5)+32;l<h;++l)if(!!(r[l>>>5]&1<<l)!==i)return!1;for(let l=c,h=n+1;l<h;++l)if(!!(r[l>>>5]&1<<l)!==i)return!1}return!0}isRangeSet(e,n){return this._isRangeValue(e,n,!0)}isRangeClear(e,n){return this._isRangeValue(e,n,!1)}isAllSet(){return this._isRangeValue(0,this.length-1,!0)}isAllClear(){return this._isRangeValue(0,this.length-1,!1)}isSet(...e){const n=this._words,i=e.length;for(let r=0;r<i;++r){const s=e[r];if(!(n[s>>>5]&1<<s))return!1}return!0}isClear(...e){const n=this._words,i=e.length;for(let r=0;r<i;++r){const s=e[r];if(n[s>>>5]&1<<s)return!1}return!0}isEqualTo(e){const n=this._words,i=e._words,r=Math.min(n.length,i.length);for(let s=0;s<r;++s)if(n[s]!==i[s])return!1;return!0}getSize(){const e=this._words.length,n=this._words;let i=0;for(let r=0;r<e;++r)i+=Zl(n[r]);return i}difference(e){const n=this._words,i=e._words,r=Math.min(n.length,i.length);for(let s=0;s<r;++s)n[s]=n[s]&~i[s];for(let s=n.length;s<r;++s)n[s]=0;return this}union(e){const n=this._words,i=e._words,r=Math.min(n.length,i.length);for(let s=0;s<r;++s)n[s]|=i[s];for(let s=n.length;s<r;++s)n[s]=0;return this}intersection(e){const n=this._words,i=e._words,r=Math.min(n.length,i.length);for(let s=0;s<r;++s)n[s]&=i[s];for(let s=n.length;s<r;++s)n[s]=0;return this}intersects(e){const n=this._words,i=e._words,r=Math.min(n.length,i.length);for(let s=0;s<r;++s)if(n[s]&i[s])return!0;return!1}getIntersectionSize(e){const n=this._words,i=e._words,r=Math.min(n.length,i.length);let s=0;for(let o=0;o<r;++o)s+=Zl(n[o]&i[o]);return s}makeIntersection(e){const n=this._words,i=e._words,r=Math.min(n.length,i.length),s=new Uint32Array(r),o=Object.create(xn.prototype);o._words=s,o.length=Math.min(this.length,e.length);for(let a=0;a<r;++a)s[a]=n[a]&i[a];return o}forEach(e){const n=this._words.length,i=this._words;let r=0;for(let s=0;s<n;++s){let o=i[s];for(;o!==0;){const a=o&-o;e((s<<5)+Zl(a-1),r),o^=a,++r}}}toArray(){const e=this._words,n=new Array(this.getSize()),i=this._words.length;let r=0;for(let s=0;s<i;++s){let o=e[s];for(;o!==0;){const a=o&-o;n[r++]=(s<<5)+Zl(a-1),o^=a}}return n}toString(){return"{"+this.toArray().join(",")+"}"}toSeleString(){const e=this.toArray().join(",");return e?"@"+e:"NONE"}clone(){const e=Object.create(xn.prototype);return e.length=this.length,e._words=new Uint32Array(this._words),e}}function Vx(t){const{edgeCount:e,nodeCount:n,nodeArray1:i,nodeArray2:r}=t,s=new Uint8Array(n),o=new Int32Array(n);for(let l=0;l<e;++l)s[i[l]]+=1,s[r[l]]+=1;for(let l=1;l<n;++l)o[l]+=o[l-1]+s[l-1];const a=2*e,c=new Int32Array(a);for(let l=0;l<a;++l)c[l]=-1;for(let l=0;l<e;++l){const h=i[l],u=r[l];let f=o[h];for(;c[f]!==-1&&f<a;)f+=1;c[f]=l;let d=o[u];for(;c[d]!==-1&&d<a;)d+=1;c[d]=l}return{countArray:s,offsetArray:o,indexArray:c}}function _n(t=0,e=0){return{type:t,group:e,x:0,y:0,z:0,atomSet:[]}}function hn(t,e){t.x+=e.x,t.y+=e.y,t.z+=e.z,t.atomSet.push(e.index)}function un(t,e){const n=e.atomSet.length;if(n>0){const{types:i,groups:r,centers:s,atomSets:o}=t;i.push(e.type),r.push(e.group),s.x.push(e.x/n),s.y.push(e.y/n),s.z.push(e.z/n),o.push(e.atomSet)}}const Es=0,qA=["D-BETA-PEPTIDE, C-GAMMA LINKING","D-GAMMA-PEPTIDE, C-DELTA LINKING","D-PEPTIDE COOH CARBOXY TERMINUS","D-PEPTIDE NH3 AMINO TERMINUS","D-PEPTIDE LINKING","L-BETA-PEPTIDE, C-GAMMA LINKING","L-GAMMA-PEPTIDE, C-DELTA LINKING","L-PEPTIDE COOH CARBOXY TERMINUS","L-PEPTIDE NH3 AMINO TERMINUS","L-PEPTIDE LINKING","PEPTIDE LINKING","PEPTIDE-LIKE"],XA=["RNA OH 3 PRIME TERMINUS","RNA OH 5 PRIME TERMINUS","RNA LINKING"],YA=["DNA OH 3 PRIME TERMINUS","DNA OH 5 PRIME TERMINUS","DNA LINKING","L-DNA LINKING","L-RNA LINKING"],Hx=["D-SACCHARIDE","D-SACCHARIDE 1,4 AND 1,4 LINKING","D-SACCHARIDE 1,4 AND 1,6 LINKING","L-SACCHARIDE","L-SACCHARIDE 1,4 AND 1,4 LINKING","L-SACCHARIDE 1,4 AND 1,6 LINKING","SACCHARIDE"],ZA=["NON-POLYMER"].concat(["OTHER"],Hx),$x=["h","g","i"],Wx=["e","b"],jx=["s","t","l",""],qx={H:1,D:1,T:1,HE:2,LI:3,BE:4,B:5,C:6,N:7,O:8,F:9,NE:10,NA:11,MG:12,AL:13,SI:14,P:15,S:16,CL:17,AR:18,K:19,CA:20,SC:21,TI:22,V:23,CR:24,MN:25,FE:26,CO:27,NI:28,CU:29,ZN:30,GA:31,GE:32,AS:33,SE:34,BR:35,KR:36,RB:37,SR:38,Y:39,ZR:40,NB:41,MO:42,TC:43,RU:44,RH:45,PD:46,AG:47,CD:48,IN:49,SN:50,SB:51,TE:52,I:53,XE:54,CS:55,BA:56,LA:57,CE:58,PR:59,ND:60,PM:61,SM:62,EU:63,GD:64,TB:65,DY:66,HO:67,ER:68,TM:69,YB:70,LU:71,HF:72,TA:73,W:74,RE:75,OS:76,IR:77,PT:78,AU:79,HG:80,TL:81,PB:82,BI:83,PO:84,AT:85,RN:86,FR:87,RA:88,AC:89,TH:90,PA:91,U:92,NP:93,PU:94,AM:95,CM:96,BK:97,CF:98,ES:99,FM:100,MD:101,NO:102,LR:103,RF:104,DB:105,SG:106,BH:107,HS:108,MT:109,DS:110,RG:111,CN:112,NH:113,FL:114,MC:115,LV:116,TS:117,OG:118},KA={1:1.1,2:1.4,3:1.81,4:1.53,5:1.92,6:1.7,7:1.55,8:1.52,9:1.47,10:1.54,11:2.27,12:1.73,13:1.84,14:2.1,15:1.8,16:1.8,17:1.75,18:1.88,19:2.75,20:2.31,21:2.3,22:2.15,23:2.05,24:2.05,25:2.05,26:2.05,27:2,28:2,29:2,30:2.1,31:1.87,32:2.11,33:1.85,34:1.9,35:1.83,36:2.02,37:3.03,38:2.49,39:2.4,40:2.3,41:2.15,42:2.1,43:2.05,44:2.05,45:2,46:2.05,47:2.1,48:2.2,49:2.2,50:1.93,51:2.17,52:2.06,53:1.98,54:2.16,55:3.43,56:2.68,57:2.5,58:2.48,59:2.47,60:2.45,61:2.43,62:2.42,63:2.4,64:2.38,65:2.37,66:2.35,67:2.33,68:2.32,69:2.3,70:2.28,71:2.27,72:2.25,73:2.2,74:2.1,75:2.05,76:2,77:2,78:2.05,79:2.1,80:2.05,81:1.96,82:2.02,83:2.07,84:1.97,85:2.02,86:2.2,87:3.48,88:2.83,89:2,90:2.4,91:2,92:2.3,93:2,94:2,95:2,96:2,97:2,98:2,99:2,100:2,101:2,102:2,103:2,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:2,114:2,115:2,116:2,117:2,118:2},JA={1:.31,2:.28,3:1.28,4:.96,5:.84,6:.76,7:.71,8:.66,9:.57,10:.58,11:1.66,12:1.41,13:1.21,14:1.11,15:1.07,16:1.05,17:1.02,18:1.06,19:2.03,20:1.76,21:1.7,22:1.6,23:1.53,24:1.39,25:1.39,26:1.32,27:1.26,28:1.24,29:1.32,30:1.22,31:1.22,32:1.2,33:1.19,34:1.2,35:1.2,36:1.16,37:2.2,38:1.95,39:1.9,40:1.75,41:1.64,42:1.54,43:1.47,44:1.46,45:1.42,46:1.39,47:1.45,48:1.44,49:1.42,50:1.39,51:1.39,52:1.38,53:1.39,54:1.4,55:2.44,56:2.15,57:2.07,58:2.04,59:2.03,60:2.01,61:1.99,62:1.98,63:1.98,64:1.96,65:1.94,66:1.92,67:1.92,68:1.89,69:1.9,70:1.87,71:1.87,72:1.75,73:1.7,74:1.62,75:1.51,76:1.44,77:1.41,78:1.36,79:1.36,80:1.32,81:1.45,82:1.46,83:1.48,84:1.4,85:1.5,86:1.5,87:2.6,88:2.21,89:2.15,90:2.06,91:2,92:1.96,93:1.9,94:1.87,95:1.8,96:1.69,97:1.6,98:1.6,99:1.6,100:1.6,101:1.6,102:1.6,103:1.6,104:1.6,105:1.6,106:1.6,107:1.6,108:1.6,109:1.6,110:1.6,111:1.6,112:1.6,113:1.6,114:1.6,115:1.6,116:1.6,117:1.6,118:1.6},H0={1:[1],2:[0],3:[1],4:[2],5:[3],6:[4],7:[3],8:[2],9:[1],10:[0],11:[1],12:[2],13:[6],14:[6],15:[3,5,7],16:[2,4,6],17:[1],18:[0],19:[1],20:[2],31:[3],32:[4],33:[3,5],34:[2,4,6],35:[1],36:[0],37:[1],38:[2],49:[3],50:[4],51:[3,5],52:[2],53:[1,2,5],54:[0,2],55:[1],56:[2],81:[3],82:[4],83:[3],84:[2],85:[1],86:[0],87:[1],88:[2]},QA={1:1,2:2,3:1,4:2,5:3,6:4,7:5,8:6,9:7,10:8,11:1,12:2,13:3,14:4,15:5,16:6,17:7,18:8,19:1,20:2,21:3,22:4,23:5,24:6,25:7,26:8,27:9,28:10,29:11,30:2,31:3,32:4,33:5,34:6,35:7,36:8,37:1,38:2,39:3,40:4,41:5,42:6,43:7,44:8,45:9,46:10,47:11,48:2,49:3,50:4,51:5,52:6,53:7,54:8,55:1,56:2,57:3,58:4,59:3,60:4,61:5,62:6,63:7,64:8,65:9,66:10,67:11,68:12,69:13,70:14,71:15,72:4,73:5,74:6,75:7,76:8,77:9,78:10,79:11,80:2,81:3,82:4,83:5,84:6,85:7,86:8,87:1,88:2,89:3,90:4,91:3,92:4,93:5,94:6,95:7,96:8,97:9,98:10,99:11,100:12,101:13,102:14,103:15,104:2,105:2,106:2,107:2,108:2,109:2,110:2,111:2,112:2,113:3,114:4,115:5,116:6,117:7,118:8},$0={ALA:[.17,.5,.33],ARG:[.81,1.81,1],ASN:[.42,.85,.43],ASP:[1.23,3.64,2.41],ASH:[-.07,.43,.5],CYS:[-.24,-.02,.22],GLN:[.58,.77,.19],GLU:[2.02,3.63,1.61],GLH:[-.01,.11,.12],GLY:[.01,1.15,1.14],HIS:[.17,.11,-.06],ILE:[-.31,-1.12,-.81],LEU:[-.56,-1.25,-.69],LYS:[.99,2.8,1.81],MET:[-.23,-.67,-.44],PHE:[-1.13,-1.71,-.58],PRO:[.45,.14,-.31],SER:[.13,.46,.33],THR:[.14,.25,.11],TRP:[-1.85,-2.09,-.24],TYR:[-.94,-.71,.23],VAL:[.07,-.46,-.53]},eC=[0,0,0],pu={HIS:"H",ARG:"R",LYS:"K",ILE:"I",PHE:"F",LEU:"L",TRP:"W",ALA:"A",MET:"M",PRO:"P",CYS:"C",ASN:"N",VAL:"V",GLY:"G",SER:"S",GLN:"Q",TYR:"Y",ASP:"D",GLU:"E",THR:"T",SEC:"U",PYL:"O"},vo=Object.keys(pu),Xx=["A","C","T","G","U","I"],Yx=["DA","DC","DT","DG","DU","DI"],tC=["A","G","I","DA","DG","DI"],tc=Xx.concat(Yx),mu=["SOL","WAT","HOH","H2O","W","DOD","D3O","TIP3","TIP4","SPC"],nC=["118","119","1AL","1CU","2FK","2HP","2OF","3CO","3MT","3NI","3OF","3P8","4MO","4PU","543","6MO","ACT","AG","AL","ALF","AM","ATH","AU","AU3","AUC","AZI","BA","BCT","BEF","BF4","BO4","BR","BS3","BSY","CA","CAC","CD","CD1","CD3","CD5","CE","CHT","CL","CO","CO3","CO5","CON","CR","CS","CSB","CU","CU1","CU3","CUA","CUZ","CYN","DME","DMI","DSC","DTI","DY","E4N","EDR","EMC","ER3","EU","EU3","F","FE","FE2","FPO","GA","GD3","GEP","HAI","HG","HGC","IN","IOD","IR","IR3","IRI","IUM","K","KO4","LA","LCO","LCP","LI","LU","MAC","MG","MH2","MH3","MLI","MLT","MMC","MN","MN3","MN5","MN6","MO1","MO2","MO3","MO4","MO5","MO6","MOO","MOS","MOW","MW1","MW2","MW3","NA","NA2","NA5","NA6","NAO","NAW","NCO","NET","NH4","NI","NI1","NI2","NI3","NO2","NO3","NRU","O4M","OAA","OC1","OC2","OC3","OC4","OC5","OC6","OC7","OC8","OCL","OCM","OCN","OCO","OF1","OF2","OF3","OH","OS","OS4","OXL","PB","PBM","PD","PDV","PER","PI","PO3","PO4","PR","PT","PT4","PTN","RB","RH3","RHD","RU","SB","SCN","SE4","SEK","SM","SMO","SO3","SO4","SR","T1A","TB","TBA","TCN","TEA","TH","THE","TL","TMA","TRA","UNX","V","VN3","VO4","W","WO5","Y1","YB","YB2","YH","YT3","ZCM","ZN","ZN2","ZN3","ZNO","ZO3","OHX"],iC=["045","0AT","0BD","0MK","0NZ","0TS","0V4","0XY","0YT","10M","147","149","14T","15L","16G","18T","18Y","1AR","1BW","1GL","1GN","1JB","1LL","1NA","1S3","26M","26Q","26R","26V","26W","26Y","27C","289","291","293","2DG","2F8","2FG","2FL","2FP","2GL","2M4","2M5","32O","34V","3CM","3DO","3DY","3FM","3LR","3MF","3MG","3SA","3ZW","46D","46M","46Z","48Z","4CQ","4GC","4NN","50A","5DI","5GF","5MM","5RP","5SA","5SP","64K","6PG","6SA","7JZ","7SA","A1Q","A2G","AAB","AAL","AAO","ABC","ABD","ABE","ABF","ABL","ACG","ACI","ACR","ACX","ADA","ADG","ADR","AF1","AFD","AFL","AFO","AFP","AFR","AGC","AGH","AGL","AHR","AIG","ALL","ALX","AMU","AOG","AOS","ARA","ARB","ARE","ARI","ASG","ASO","AXP","AXR","B0D","B16","B2G","B4G","B6D","B8D","B9D","BBK","BCD","BDG","BDP","BDR","BEM","BFP","BGC","BGL","BGP","BGS","BHG","BMA","BMX","BNG","BNX","BOG","BRI","BXF","BXP","BXX","BXY","C3X","C4X","C5X","CAP","CBI","CBK","CBS","CDR","CEG","CGF","CHO","CR1","CR6","CRA","CT3","CTO","CTR","CTT","D6G","DAF","DAG","DDA","DDB","DDL","DEL","DFR","DFX","DG0","DGC","DGD","DGM","DGS","DIG","DLF","DLG","DMU","DNO","DOM","DP5","DQQ","DQR","DR2","DR3","DR4","DRI","DSR","DT6","DVC","E4P","E5G","EAG","EBG","EBQ","EGA","EJT","EPG","ERE","ERI","F1P","F1X","F6P","FBP","FCA","FCB","FCT","FDP","FDQ","FFC","FIX","FMO","FRU","FSI","FU4","FUB","FUC","FUD","FUL","FXP","G16","G1P","G2F","G3I","G4D","G4S","G6D","G6P","G6S","GAC","GAD","GAL","GC1","GC4","GCD","GCN","GCO","GCS","GCT","GCU","GCV","GCW","GCX","GE1","GFG","GFP","GIV","GL0","GL2","GL5","GL6","GL7","GL9","GLA","GLB","GLC","GLD","GLF","GLG","GLO","GLP","GLS","GLT","GLW","GMH","GN1","GNX","GP1","GP4","GPH","GPM","GQ1","GQ2","GQ4","GS1","GS4","GSA","GSD","GTE","GTH","GTK","GTR","GTZ","GU0","GU1","GU2","GU3","GU4","GU5","GU6","GU8","GU9","GUF","GUP","GUZ","GYP","GYV","H2P","HDL","HMS","HS2","HSD","HSG","HSH","HSJ","HSQ","HSR","HSU","HSX","HSY","HSZ","IAB","IDG","IDR","IDS","IDT","IDU","IDX","IDY","IMK","IN1","IPT","ISL","KBG","KD2","KDA","KDM","KDO","KFN","KO1","KO2","KTU","L6S","LAG","LAI","LAK","LAO","LAT","LB2","LBT","LCN","LDY","LGC","LGU","LM2","LMT","LMU","LOG","LOX","LPK","LSM","LTM","LVZ","LXB","LXZ","M1F","M3M","M6P","M8C","MA1","MA2","MA3","MAB","MAG","MAL","MAN","MAT","MAV","MAW","MBG","MCU","MDA","MDM","MDP","MFA","MFB","MFU","MG5","MGA","MGL","MLB","MMA","MMN","MN0","MRP","MTT","MUG","MVP","MXY","N1L","N9S","NAA","NAG","NBG","NDG","NED","NG1","NG6","NGA","NGB","NGC","NGE","NGF","NGL","NGS","NGY","NHF","NM6","NM9","NTF","NTO","NTP","NXD","NYT","OPG","OPM","ORP","OX2","P3M","P53","P6P","PA5","PNA","PNG","PNW","PRP","PSJ","PSV","PTQ","QDK","QPS","QV4","R1P","R1X","R2B","R5P","RAA","RAE","RAF","RAM","RAO","RAT","RB5","RBL","RCD","RDP","REL","RER","RF5","RG1","RGG","RHA","RIB","RIP","RNS","RNT","ROB","ROR","RPA","RST","RUB","RUU","RZM","S6P","S7P","SA0","SCR","SDD","SF6","SF9","SG4","SG5","SG6","SG7","SGA","SGC","SGD","SGN","SGS","SHB","SHG","SI3","SIO","SOE","SOL","SSG","SUC","SUP","SUS","T6P","T6T","TAG","TCB","TDG","TGK","TGY","TH1","TIA","TM5","TM6","TM9","TMR","TMX","TOA","TOC","TRE","TYV","UCD","UDC","VG1","X0X","X1X","X2F","X4S","X5S","X6X","XBP","XDN","XDP","XIF","XIM","XLF","XLS","XMM","XUL","XXR","XYP","XYS","YO5","Z3Q","Z6J","Z9M","ZDC","ZDM"],rC=["CA","C","N","O","O1","O2","OC1","OC2","OX1","OXT","OT1","OT2","H","H1","H2","H3","HA","HN","BB"],Zx=["P","OP1","OP2","HOP2","HOP3","O2'","O3'","O4'","O5'","C1'","C2'","C3'","C4'","C5'","H1'","H2'","H2''","HO2'","H3'","H4'","H5'","H5''","HO3'","HO5'","O2*","O3*","O4*","O5*","C1*","C2*","C3*","C4*","C5*"],Xa={1:{trace:"CA",direction1:"C",direction2:["O","OC1","O1","OX1","OXT","OT1","OT2"],backboneStart:"N",backboneEnd:"C"},2:{trace:["C4'","C4*"],direction1:["C1'","C1*"],direction2:["C3'","C3*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},3:{trace:["C3'","C3*"],direction1:["C2'","C2*"],direction2:["O4'","O4*"],backboneStart:"P",backboneEnd:["O3'","O3*"]},4:{trace:["CA","BB"],backboneStart:["CA","BB"],backboneEnd:["CA","BB"]},5:{trace:["C4'","C4*","P"],backboneStart:["C4'","C4*","P"],backboneEnd:["C4'","C4*","P"]},6:{trace:["C3'","C3*","C2'","P"],backboneStart:["C3'","C3*","C2'","P"],backboneEnd:["C3'","C3*","C2'","P"]}};Xa[Es]={};const W0={HD:"H",HS:"H",A:"C",NA:"N",NS:"N",OA:"O",OS:"O",SA:"S",G0:"C",G1:"C",G2:"C",G3:"C",CG0:"C",CG1:"C",CG2:"C",CG3:"C",W:"O"};function Kl(t){switch(t){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;default:return 8}}const j0=new Map([[2,rn(180)],[3,rn(120)],[4,rn(109.4721)],[6,rn(90)]]);function Jl(t,e){let n=[];const i=new T,r=new T;return i.subVectors(e,t),t.eachBondedAtom(s=>{s.number!==1&&(r.subVectors(s,t),n.push(i.angleTo(r)))}),n}function q0(t,e){const n=t.clone(),i=new T;i.subVectors(e,t);const r=[new T,new T];let s=0;if(t.eachBondedAtom(a=>{s>1||a.number!==1&&(n.index=a.index,r[s++].subVectors(a,t))}),s===1&&n.eachBondedAtom(a=>{s>1||a.number!==1&&a.index!==t.index&&r[s++].subVectors(a,t)}),s!==2)return;const o=r[0].cross(r[1]);return Math.abs(Math.PI/2-o.angleTo(i))}function sC(t,e){const n=t.structure,i=n.atomCount,r=new Int8Array(i),s=new Int8Array(i),o=new Int8Array(i),a=new Int8Array(i);return n.eachAtom(c=>{const l=c.index,[h,u,f,d]=function(p,y){const g=p.bondToElementCount(1);let m=p.formalCharge||0;const x=y.assignCharge==="always"||y.assignCharge==="auto"&&m===0,v=y.assignH==="always"||y.assignH==="auto"&&g===0,b=p.bondCount,_=function(B){let L=0;return B.eachBond(U=>L+=U.bondOrder),L}(p),C=function(B){const L=B.structure.getBondProxy(),U=B.number,E=U===8||U===7;if(E&&B.bondCount===4)return!1;let O=!1;return B.eachBond(k=>{if(k.bondOrder>1)O=!0;else if(E){const ne=k.getOtherAtom(B);ne.eachBond(Y=>{if(Y.bondOrder>1){const F=ne.number;if((F===15||F===16)&&Y.getOtherAtom(ne).number===8)return;O=!0}},L)}}),O}(p),w=_-b>0;let S=0,M=8;switch(p.number){case 1:x&&(b===0?(m=1,M=0):b===1&&(m=0,M=1));break;case 6:x&&(m=0),v&&(S=Math.max(0,4-_-Math.abs(m))),M=Kl(b+S+Math.max(0,-m));break;case 7:if(x)if(v)if(C&&_<4)m=b-g==1&&_-g==2?1:0;else{let B=!1;p.eachBondedAtom(L=>{(L.number===16||L.isMetal())&&(B=!0)}),m=B?0:1}else m=_-3;v&&(S=Math.max(0,3-_+m)),M=Kl(C&&!w?b+S-m:b+S+1-m);break;case 8:x&&(v||(m=_-2),_===1&&p.eachBondedAtom(B=>{B.eachBond(L=>{const U=L.getOtherAtom(B);U.index!==p.index&&U.number===8&&L.bondOrder===2&&(m=-1)})})),v&&(S=Math.max(0,2-_+m)),M=Kl(C&&!w?b+S-m+1:b+S-m+2);break;case 16:x&&(v||(m=_<=3&&!p.bondToElementCount(8)?_-2:0)),v&&_<2&&(S=Math.max(0,2-_+m)),_<=3&&(M=Kl(b+S-m+2));break;case 9:case 17:case 35:case 53:case 85:x&&(m=_-1);break;case 3:case 11:case 19:case 37:case 55:case 87:x&&(m=1-_);break;case 4:case 12:case 20:case 38:case 56:case 88:x&&(m=2-_);break;default:console.warn("Requested charge, protonation for an unhandled element",p.element)}return[m,S,S+g,M]}(c,e);r[l]=h,s[l]=u,o[l]=f,a[l]=d}),{charge:r,implicitH:s,totalH:o,idealGeometry:a}}function oo(t){if(t["@valenceModel"])return t["@valenceModel"];const e=sC(t,{assignCharge:"auto",assignH:"auto"});return t["@valenceModel"]=e,e}function X0(t){return t.number===15&&t.bondToElementCount(8)===t.bondCount}const oC=["ARG","HIS","LYS"],aC=["GLU","ASP"];function cC(t,e){return t===2&&e===1||t===1&&e===2}function lC(t,e){return t===3&&e===3}function hC(t,e){return t===3&&e===1||t===1&&e===3}function Y0(t){return t.resname==="HIS"&&t.number==7&&t.isRing()}function uC(t,e){return t===5&&e===4||t===4&&e===5}function dC(t,e){return t===9&&e===5||t===5&&e===9}const fC=[3,11,19,37,55,12,20,38,56,13,31,49,81,21,50,82,83,51,80];function pC(t,e){return t===12?e===11||e===12:t===13?e===10:void 0}const mC=[17,35,53,85],gC=[7,8,16],yC=[6,7,15,16],xC=rn(180),bC=rn(120);function Z0(t,e,n){return!Kx(t,e,n)&&(t.modelIndex!==e.modelIndex||t.altloc&&e.altloc&&t.altloc!==e.altloc)}const Kt={maxHydrophobicDist:4,maxHbondDist:3.5,maxHbondSulfurDist:4.1,maxHbondAccAngle:45,maxHbondDonAngle:45,maxHbondAccPlaneAngle:90,maxHbondDonPlaneAngle:30,maxPiStackingDist:5.5,maxPiStackingOffset:2,maxPiStackingAngle:30,maxCationPiDist:6,maxCationPiOffset:2,maxIonicDist:5,maxHalogenBondDist:4,maxHalogenBondAngle:30,maxMetalDist:3,refineSaltBridges:!0,masterModelIndex:-1,lineOfSightDistFactor:1};function Kx(t,e,n){return t.modelIndex===n&&e.modelIndex!==n||e.modelIndex===n&&t.modelIndex!==n}function Da(t,e,n){return!Kx(t,e,n)&&(t.modelIndex!==e.modelIndex||t.residueIndex===e.residueIndex||t.altloc&&e.altloc&&t.altloc!==e.altloc)}function vC(t){const e={types:[],groups:[],centers:{x:[],y:[],z:[]},atomSets:[]};return Ce&&fe.time("calculateFeatures"),function(n,i){const{charge:r}=oo(n.data),s={};n.eachResidue(o=>{if(oC.includes(o.resname)){const a=_n(1);o.eachAtom(c=>{c.number===7&&c.isSidechain()&&hn(a,c)}),un(i,a)}else vo.includes(o.resname)||o.isNucleic()||(o.eachAtom(a=>{let c=!1;const l=_n(1);(function(h){let u=0;return h.number===6&&h.bondCount===3&&h.bondToElementCount(7)===3&&h.eachBondedAtom(f=>{f.bondCount-f.bondToElementCount(1)==1&&++u}),u===2})(a)?(l.group=8,c=!0):function(h){let u=0;return h.number===6&&h.bondCount===3&&h.bondToElementCount(7)===2&&h.bondToElementCount(6)===1&&h.eachBondedAtom(f=>{f.bondCount-f.bondToElementCount(1)==1&&++u}),u===2}(a)&&(l.group=9,c=!0),c&&(a.eachBondedAtom(h=>{h.number===7&&(s[h.index]=!0,hn(l,h))}),un(i,l))}),o.eachAtom(a=>{const c=_n(1);r[a.index]>0&&(s[a.index]||(hn(c,a),un(i,c)))}))})}(t,e),function(n,i){const{charge:r}=oo(n.data),s={};n.eachResidue(o=>{if(aC.includes(o.resname)){const a=_n(2);o.eachAtom(c=>{c.number===8&&c.isSidechain()&&hn(a,c)}),un(i,a)}else if(tc.includes(o.resname)){const a=_n(2);o.eachAtom(c=>{X0(c)&&(a.group=6,c.eachBondedAtom(l=>{l.number===8&&hn(a,l)}),un(i,a))})}else vo.includes(o.resname)||tc.includes(o.resname)||(o.eachAtom(a=>{let c=!1;const l=_n(2);(function(h){return h.number===16&&h.bondToElementCount(8)===3})(a)?(l.group=4,c=!0):X0(a)?(l.group=6,c=!0):function(h){return h.number===16&&h.bondToElementCount(8)===4}(a)?(l.group=5,c=!0):function(h){let u=0;return h.number===6&&h.bondToElementCount(8)===2&&h.bondToElementCount(6)===1&&h.eachBondedAtom(f=>{f.number===8&&f.bondCount-f.bondToElementCount(1)==1&&++u}),u===2}(a)&&(l.group=10,c=!0),c&&(a.eachBondedAtom(h=>{h.number===8&&(s[h.index]=!0,hn(l,h))}),un(i,l))}),o.eachAtom(a=>{const c=_n(2);r[a.index]<0&&(s[a.index]||(hn(c,a),un(i,c)))}))})}(t,e),function(n,i){const r=n.getAtomProxy();n.eachResidue(s=>{const o=s.getAromaticRings();if(o){const a=s.atomOffset;o.forEach(c=>{const l=_n(3);c.forEach(h=>{r.index=h+a,hn(l,r)}),un(i,l)})}})}(t,e),function(n,i){const{charge:r,implicitH:s,idealGeometry:o}=oo(n.data);n.eachAtom(a=>{const c=_n(5),l=a.number;if(l===8)hn(c,a),un(i,c);else if(l===7){if(Y0(a))hn(c,a),un(i,c);else if(r[a.index]<1){const h=a.bondCount+s[a.index],u=o[a.index];(u===4&&h<4||u===3&&h<3||u===2&&h<2)&&(hn(c,a),un(i,c))}}else l===16&&(a.resname!=="CYS"&&a.resname!=="MET"&&a.formalCharge!==-1||(hn(c,a),un(i,c)))})}(t,e),function(n,i){const{totalH:r}=oo(n.data);n.eachAtom(s=>{const o=_n(4),a=s.number;(Y0(s)||r[s.index]>0&&(a===7||a===8||a===16))&&(hn(o,s),un(i,o))})}(t,e),function(n,i){const{totalH:r}=oo(n.data);n.eachAtom(s=>{if(s.number===6&&r[s.index]>0&&(s.bondToElementCount(7)>0||s.bondToElementCount(8)>0||function(o){if(!o.isAromatic())return!1;const a=o.residueType.getRings();if(!a)return!1;let c=!1;return a.rings.forEach(l=>{c||l.some(h=>o.index-o.residueAtomOffset===h)&&(c=l.some(h=>{const u=o.residueType.atomTypeIdList[h],f=o.atomMap.get(u).number;return f===7||f===8}))}),c}(s))){const o=_n(9);hn(o,s),un(i,o)}})}(t,e),function(n,i){n.eachAtom(r=>{let s=!1,o=!1;const a=vo.includes(r.resname),c=tc.includes(r.resname);if(a||c?a?r.number===8?(["ASP","GLU","SER","THR","TYR","ASN","GLN"].includes(r.resname)&&r.isSidechain()||r.isBackbone())&&(s=!0,o=!0):r.number===16&&r.resname==="CYS"?(s=!0,o=!0):r.number===7&&r.resname==="HIS"&&r.isSidechain()&&(s=!0):c&&(r.number===8&&r.isBackbone()?(s=!0,o=!0):["N3","N4","N7"].includes(r.atomname)?s=!0:["O2","O4","O6"].includes(r.atomname)&&(s=!0,o=!0)):r.isHalogen()||r.number===8||r.number===16?(s=!0,o=!0):r.number===7&&(s=!0),s){const l=_n(11);hn(l,r),un(i,l)}if(o){const l=_n(10);hn(l,r),un(i,l)}})}(t,e),function(n,i){n.eachAtom(r=>{if(r.isTransitionMetal()||r.number===30||r.number===48){const s=_n(12);hn(s,r),un(i,s)}else if(fC.includes(r.number)){const s=_n(13);hn(s,r),un(i,s)}})}(t,e),function(n,i){n.eachAtom(r=>{const s=_n(8);let o=!1;r.number===6?(o=!0,r.eachBondedAtom(a=>{const c=a.number;c!==6&&c!==1&&(o=!1)})):r.number===9&&(o=!0),o&&(hn(s,r),un(i,s))})}(t,e),function(n,i){n.eachAtom(r=>{if(gC.includes(r.number)){let s=!1;if(r.eachBondedAtom(o=>{yC.includes(o.number)&&(s=!0)}),s){const o=_n(7);hn(o,r),un(i,o)}}})}(t,e),function(n,i){n.eachAtom(r=>{if(mC.includes(r.number)&&r.bondToElementCount(6)===1){const s=_n(6);hn(s,r),un(i,s)}})}(t,e),Ce&&fe.timeEnd("calculateFeatures"),e}function _C(t,e=Kt){const n=function(r){const{types:s,centers:o}=r;return{features:r,spatialHash:new Uc(o),contactStore:new jA,featureSet:new xn(s.length,!1)}}(vC(t));Ce&&fe.time("calculateContacts"),function(r,s,o={}){const a=I(o.maxIonicDist,Kt.maxIonicDist),c=I(o.maxPiStackingDist,Kt.maxPiStackingDist),l=I(o.maxPiStackingOffset,Kt.maxPiStackingOffset),h=I(o.maxPiStackingAngle,Kt.maxPiStackingAngle),u=I(o.maxCationPiDist,Kt.maxCationPiDist),f=I(o.maxCationPiOffset,Kt.maxCationPiOffset),d=I(o.masterModelIndex,Kt.masterModelIndex),p=Math.max(a+2,c,u),y=c*c,g=u*u,{features:m,spatialHash:x,contactStore:v,featureSet:b}=s,{types:_,centers:C,atomSets:w}=m,{x:S,y:M,z:B}=C,L=_.length,U=r.atomStore.x,E=r.atomStore.y,O=r.atomStore.z,k=r.getAtomProxy(),ne=r.getAtomProxy(),Y=function(q,J,W){const H=q.length,se=J.length;for(let $=0;$<H;++$){k.index=q[$];for(let he=0;he<se;++he)if(ne.index=J[he],k.distanceTo(ne)<=W)return!0}return!1},F=new T,te=new T,ee=new T,j=new T,Z=new T,ce=new T,de=new T,oe=function(q,J){F.set(U[q[0]],E[q[0]],O[q[0]]),te.set(U[q[1]],E[q[1]],O[q[1]]),ee.set(U[q[2]],E[q[2]],O[q[2]]),j.subVectors(F,te),Z.subVectors(F,ee),J.crossVectors(j,Z)},V=function(q,J,W){return F.set(S[q],M[q],B[q]),te.set(S[J],M[J],B[J]),F.sub(te).projectOnPlane(W).add(te).distanceTo(te)},re=function(q,J,W){b.setBits(q,J),v.addContact(q,J,W)};for(let q=0;q<L;++q)x.eachWithin(S[q],M[q],B[q],p,(J,W)=>{if(J<=q||(k.index=w[q][0],ne.index=w[J][0],Da(k,ne,d)))return;const H=_[q],se=_[J];if(cC(H,se))Y(w[q],w[J],a)&&re(q,J,1);else if(lC(H,se)){if(W<=y){oe(w[q],ce),oe(w[J],de);const $=57.29578*ce.angleTo(de);Math.min(V(q,J,de),V(J,q,ce))<=l&&($<=h||$>=180-h||$<=h+90&&$>=90-h)&&re(q,J,3)}}else if(hC(H,se)&&W<=g){const[$,he]=H===3?[q,J]:[J,q];oe(w[$],ce),V(he,$,ce)<=f&&re($,he,2)}})}(t,n,e),function(r,s,o={}){const a=I(o.maxHbondDist,Kt.maxHbondDist),c=I(o.maxHbondSulfurDist,Kt.maxHbondSulfurDist),l=rn(I(o.maxHbondAccAngle,Kt.maxHbondAccAngle)),h=rn(I(o.maxHbondDonAngle,Kt.maxHbondDonAngle)),u=rn(I(o.maxHbondAccPlaneAngle,Kt.maxHbondAccPlaneAngle)),f=rn(I(o.maxHbondDonPlaneAngle,Kt.maxHbondDonPlaneAngle)),d=I(o.masterModelIndex,Kt.masterModelIndex),p=Math.max(a,c),y=a*a,{features:g,spatialHash:m,contactStore:x,featureSet:v}=s,{types:b,centers:_,atomSets:C}=g,{x:w,y:S,z:M}=_,B=b.length,{idealGeometry:L}=oo(r.data),U=r.getAtomProxy(),E=r.getAtomProxy();for(let O=0;O<B;++O)m.eachWithin(w[O],S[O],M[O],p,(k,ne)=>{if(k<=O)return;const Y=b[O],F=b[k],te=dC(Y,F);if(!te&&!uC(Y,F))return;const[ee,j]=F===5?[O,k]:[k,O];if(U.index=C[ee][0],E.index=C[j][0],E.index===U.index||Da(U,E,d)||U.number!==16&&E.number!==16&&ne>y||U.connectedTo(E))return;const Z=Jl(U,E),ce=j0.get(L[U.index])||rn(120);if(Z.some(J=>Math.abs(ce-J)>h))return;if(L[U.index]===3){const J=q0(U,E);if(J!==void 0&&J>f)return}const de=Jl(E,U),oe=j0.get(L[E.index])||rn(120);if(de.some(J=>oe-J>l))return;if(L[E.index]===3){const J=q0(E,U);if(J!==void 0&&J>u)return}v.setBits(ee,j);const V=te?8:function(J,W){return J.isWater()&&W.isWater()}(re=U,q=E)?9:function(J,W){return J.isBackbone()&&W.isBackbone()}(re,q)?10:4;var re,q;x.addContact(ee,j,V)})}(t,n,e),function(r,s,o={}){const a=I(o.maxMetalDist,Kt.maxMetalDist),c=I(o.masterModelIndex,Kt.masterModelIndex),{features:l,spatialHash:h,contactStore:u,featureSet:f}=s,{types:d,centers:p,atomSets:y}=l,{x:g,y:m,z:x}=p,v=d.length,b=r.getAtomProxy(),_=r.getAtomProxy();for(let C=0;C<v;++C)h.eachWithin(g[C],m[C],x[C],a,(w,S)=>{if(w<=C||(b.index=y[C][0],_.index=y[w][0],Da(b,_,c)))return;const M=b.isMetal(),B=_.isMetal();if(!M&&!B)return;const[L,U]=M?[d[C],d[w]]:[d[w],d[C]];pC(L,U)&&(f.setBits(C,w),u.addContact(C,w,7))})}(t,n,e),function(r,s,o={}){const a=I(o.maxHydrophobicDist,Kt.maxHydrophobicDist),c=I(o.masterModelIndex,Kt.masterModelIndex),{features:l,spatialHash:h,contactStore:u,featureSet:f}=s,{types:d,centers:p,atomSets:y}=l,{x:g,y:m,z:x}=p,v=d.length,b=r.getAtomProxy(),_=r.getAtomProxy();for(let C=0;C<v;++C)h.eachWithin(g[C],m[C],x[C],a,(w,S)=>{var M,B;w<=C||(b.index=y[C][0],_.index=y[w][0],Da(b,_,c)||b.number===9&&_.number===9||b.connectedTo(_)||(M=d[C],B=d[w],M===8&&B===8&&(f.setBits(C,w),u.addContact(C,w,6))))})}(t,n,e),function(r,s,o={}){const a=I(o.maxHalogenBondDist,Kt.maxHalogenBondDist),c=rn(I(o.maxHalogenBondAngle,Kt.maxHalogenBondAngle)),l=I(o.masterModelIndex,Kt.masterModelIndex),{features:h,spatialHash:u,contactStore:f,featureSet:d}=s,{types:p,centers:y,atomSets:g}=h,{x:m,y:x,z:v}=y,b=p.length,_=r.getAtomProxy(),C=r.getAtomProxy();for(let w=0;w<b;++w)u.eachWithin(m[w],x[w],v[w],a,(S,M)=>{if(S<=w||(_.index=g[w][0],C.index=g[S][0],Da(_,C,l))||(B=p[w],L=p[S],!(B===7&&L===6||B===6&&L===7)))return;var B,L;const[U,E]=p[w]===6?[_,C]:[C,_],O=Jl(U,E);if(O.length!==1||xC-O[0]>c)return;const k=Jl(E,U);k.length!==0&&(k.some(ne=>bC-ne>c)||(d.setBits(w,S),f.addContact(w,S,5)))})}(t,n,e);const i=function(r){const{index1:s,index2:o,count:a}=r.contactStore,c=Vx({nodeArray1:s,nodeArray2:o,edgeCount:a,nodeCount:r.featureSet.length}),l=new xn(r.contactStore.count,!0);return Object.assign({adjacencyList:c,contactSet:l},r)}(n);return function(r,s,o={}){Ce&&fe.time("refineLineOfSight");const a=I(o.lineOfSightDistFactor,Kt.lineOfSightDistFactor),c=I(o.masterModelIndex,Kt.masterModelIndex),l=r.spatialHash,{contactSet:h,contactStore:u,features:f}=s,{index1:d,index2:p}=u,{centers:y,atomSets:g}=f,{x:m,y:x,z:v}=y,b=r.getAtomProxy(),_=r.getAtomProxy(),C=r.getAtomProxy(),w=new T,S=new T,M=3*a,B=a*a;h.forEach(L=>{w.set(m[d[L]],x[d[L]],v[d[L]]),S.set(m[p[L]],x[p[L]],v[p[L]]);const U=(w.x+S.x)/2,E=(w.y+S.y)/2,O=(w.z+S.z)/2,k=g[d[L]],ne=g[p[L]];b.index=k[0],_.index=ne[0],l.eachWithin(U,E,O,M,(Y,F)=>{C.index=Y,C.number!==1&&C.vdw*C.vdw*B>F&&!Z0(b,C,c)&&!Z0(_,C,c)&&!k.includes(Y)&&!ne.includes(Y)&&w.distanceToSquared(C)>1&&S.distanceToSquared(C)>1&&(h.clear(L),Ce&&fe.log("removing",b.qualifiedName(),_.qualifiedName(),"because",C.qualifiedName()))})}),Ce&&fe.timeEnd("refineLineOfSight")}(t,i,e),function(r,s){const{contactSet:o,contactStore:a,features:c}=s,{type:l,index1:h,index2:u}=a,{atomSets:f}=c,d=r.getAtomProxy(),p=r.getAtomProxy(),y={},g=function(m,x,v){const[b,_]=y[v]||[1/0,-1];m<b?(_!==-1&&o.clear(_),y[v]=[m,x]):o.clear(x)};o.forEach(m=>{if(l[m]!==6)return;d.index=f[h[m]][0],p.index=f[u[m]][0];const x=d.distanceTo(p);g(x,m,`${d.index}|${p.residueIndex}`),g(x,m,`${p.index}|${d.residueIndex}`)})}(t,i),e.refineSaltBridges&&function(r,s){const{contactSet:o,contactStore:a,features:c}=s,{type:l,index1:h,index2:u}=a,{atomSets:f}=c,d={},p=function(y,g){d[y]||(d[y]=[]),d[y].push(g)};o.forEach(y=>{l[y]===1&&(f[h[y]].forEach(g=>p(g,y)),f[u[y]].forEach(g=>p(g,y)))}),o.forEach(y=>{if(!function(v){return v===4||v===9||v===10}(l[y]))return;const g=d[f[h[y]][0]],m=d[f[u[y]][0]];if(!g||!m)return;const x=g.length;for(let v=0;v<x;++v)if(m.includes(g[v]))return void o.clear(y)})}(0,i),function(r,s){const{contactSet:o,contactStore:a,features:c}=s,{type:l,index1:h,index2:u}=a,{atomSets:f}=c,d={},p=function(y,g){d[y]||(d[y]=[]),d[y].push(g)};o.forEach(y=>{l[y]===3&&(f[h[y]].forEach(g=>p(g,y)),f[u[y]].forEach(g=>p(g,y)))}),o.forEach(y=>{if(l[y]!==6&&l[y]!==2)return;const g=d[f[h[y]][0]],m=d[f[u[y]][0]];if(!g||!m)return;const x=g.length;for(let v=0;v<x;++v)if(m.includes(g[v]))return void o.clear(y)})}(0,i),function(r,s){const{contactSet:o,contactStore:a,features:c}=s,{type:l,index1:h,index2:u}=a,{atomSets:f}=c,d={},p=function(y,g){d[y]||(d[y]=[]),d[y].push(g)};o.forEach(y=>{l[y]===1&&(f[h[y]].forEach(g=>p(g,y)),f[u[y]].forEach(g=>p(g,y)))}),o.forEach(y=>{if(l[y]!==7)return;const g=d[f[h[y]][0]],m=d[f[u[y]][0]];if(!g||!m)return;const x=g.length;for(let v=0;v<x;++v)if(m.includes(g[v]))return void o.clear(g[v])})}(0,i),Ce&&fe.timeEnd("calculateContacts"),i}function wC(t){switch(t){case 4:case 9:case 10:return"hydrogen bond";case 6:return"hydrophobic contact";case 5:return"halogen bond";case 1:return"ionic interaction";case 7:return"metal coordination";case 2:return"cation-pi interaction";case 3:return"pi-pi stacking";case 8:return"weak hydrogen bond";default:return"unknown contact"}}const SC={hydrogenBond:!0,hydrophobic:!0,halogenBond:!0,ionicInteraction:!0,metalCoordination:!0,cationPi:!0,piStacking:!0,weakHydrogenBond:!0,waterHydrogenBond:!0,backboneHydrogenBond:!0,radius:1,filterSele:""},Ji=new ke;function MC(t,e,n){const i=Kn(n,SC),r=[];i.hydrogenBond&&r.push(4),i.hydrophobic&&r.push(6),i.halogenBond&&r.push(5),i.ionicInteraction&&r.push(1),i.metalCoordination&&r.push(7),i.cationPi&&r.push(2),i.piStacking&&r.push(3),i.weakHydrogenBond&&r.push(8),i.waterHydrogenBond&&r.push(9),i.backboneHydrogenBond&&r.push(10);const{features:s,contactSet:o,contactStore:a}=t,{centers:c,atomSets:l}=s,{x:h,y:u,z:f}=c,{index1:d,index2:p,type:y}=a,g=[],m=[],x=[],v=[],b=[];let _;return i.filterSele&&(_=Array.isArray(i.filterSele)?i.filterSele.map(C=>e.getAtomSet(new qt(C))):e.getAtomSet(new qt(i.filterSele))),o.forEach(C=>{const w=y[C];if(!r.includes(w))return;if(_){const B=l[d[C]][0],L=l[p[C]][0];if(Array.isArray(_)){if(!(_[0].isSet(B)&&_[1].isSet(L)||_[1].isSet(B)&&_[0].isSet(L)))return}else if(!_.isSet(B)&&!_.isSet(L))return}const S=d[C],M=p[C];g.push(h[S],u[S],f[S]),m.push(h[M],u[M],f[M]),x.push(...function(B){switch(B){case 4:case 9:case 10:return Ji.setHex(2851770).toArray();case 6:return Ji.setHex(8421504).toArray();case 5:return Ji.setHex(4259775).toArray();case 1:return Ji.setHex(15779860).toArray();case 7:return Ji.setHex(9191577).toArray();case 2:return Ji.setHex(16744448).toArray();case 3:return Ji.setHex(9220966).toArray();case 8:return Ji.setHex(12967404).toArray();default:return Ji.setHex(13421772).toArray()}}(w)),v.push(i.radius),b.push(C)}),{position1:new Float32Array(g),position2:new Float32Array(m),color:new Float32Array(x),color2:new Float32Array(x),radius:new Float32Array(v),picking:new CC(b,t,e)}}class ji{constructor(e){this.array=e}get type(){return""}get data(){return{}}getIndex(e){return this.array?this.array[e]:e}getObject(e){return{}}_applyTransformations(e,n,i){return n&&e.applyMatrix4(n.matrix),i&&e.applyMatrix4(i.matrix),e}_getPosition(e){return new T}getPosition(e,n,i){return this._applyTransformations(this._getPosition(e),n,i)}}class ii extends ji{constructor(e){super(),this.shape=e}get primitive(){}get data(){return this.shape}get type(){return this.primitive.type}getObject(e){return this.primitive.objectFromShape(this.shape,this.getIndex(e))}_getPosition(e){return this.primitive.positionFromShape(this.shape,this.getIndex(e))}}class Rs extends ji{constructor(e,n){super(e),this.structure=n}get type(){return"atom"}get data(){return this.structure}getObject(e){return this.structure.getAtomProxy(this.getIndex(e))}_getPosition(e){return new T().copy(this.getObject(e))}}class AC extends ji{constructor(e){super(),this.axes=e}get type(){return"axes"}get data(){return this.axes}getObject(){return{axes:this.axes}}_getPosition(){return this.axes.center.clone()}}class Jx extends ji{constructor(e,n,i){super(e),this.structure=n,this.bondStore=i||n.bondStore}get type(){return"bond"}get data(){return this.structure}getObject(e){const n=this.structure.getBondProxy(this.getIndex(e));return n.bondStore=this.bondStore,n}_getPosition(e){const n=this.getObject(e);return new T().copy(n.atom1).add(n.atom2).multiplyScalar(.5)}}class CC extends ji{constructor(e,n,i){super(e),this.contacts=n,this.structure=i}get type(){return"contact"}get data(){return this.contacts}getObject(e){const n=this.getIndex(e),{features:i,contactStore:r}=this.contacts,{centers:s,atomSets:o}=i,{x:a,y:c,z:l}=s,{index1:h,index2:u,type:f}=r,d=h[n],p=u[n];return{center1:new T(a[d],c[d],l[d]),center2:new T(a[p],c[p],l[p]),atom1:this.structure.getAtomProxy(o[d][0]),atom2:this.structure.getAtomProxy(o[p][0]),type:wC(f[n])}}_getPosition(e){const{center1:n,center2:i}=this.getObject(e);return new T().addVectors(n,i).multiplyScalar(.5)}}class TC extends ji{constructor(e,n,i){super(e),this.validation=n,this.structure=i}get type(){return"clash"}get data(){return this.validation}getObject(e){const n=this.validation,i=this.getIndex(e);return{validation:n,index:i,clash:n.clashArray[i]}}_getAtomProxyFromSele(e){const n=new qt(e),i=this.structure.getAtomIndices(n)[0];return this.structure.getAtomProxy(i)}_getPosition(e){const n=this.getObject(e).clash,i=this._getAtomProxyFromSele(n.sele1),r=this._getAtomProxyFromSele(n.sele2);return new T().copy(i).add(r).multiplyScalar(.5)}}class PC extends Jx{get type(){return"distance"}}class EC extends ji{get type(){return"ignore"}}class IC extends ii{constructor(e,n){super(e),this.mesh=n}get type(){return"mesh"}getObject(){const e=this.mesh;return{shape:this.shape,name:e.name,serial:e.serial}}_getPosition(){return this.__position||(this.__position=Tp(this.mesh.position)),this.__position}}class LC extends ji{constructor(e,n){super(e),this.surface=n}get type(){return"surface"}get data(){return this.surface}getObject(e){return{surface:this.surface,index:this.getIndex(e)}}_getPosition(){return this.surface.center.clone()}}class RC extends ji{constructor(e,n){super(),this.unitcell=e,this.structure=n}get type(){return"unitcell"}get data(){return this.unitcell}getObject(){return{unitcell:this.unitcell,structure:this.structure}}_getPosition(){return this.unitcell.getCenter(this.structure)}}class Qx extends ji{constructor(e,n){super(e),this.volume=n}get type(){return"volume"}get data(){return this.volume}getObject(e){const n=this.volume,i=this.getIndex(e);return{volume:n,index:i,value:n.data[i]}}_getPosition(e){const n=this.volume.position,i=this.getIndex(e);return new T(n[3*i],n[3*i+1],n[3*i+2])}}class DC extends Qx{get type(){return"slice"}}function eb(){return new Uint32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0])}function tb(){return new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1])}function mm(t,e,n,i,r){var s,o,a,c,l,h,u,f=[[0,4,4,4,2,0,0,0,2,2,0,0],[4,0,4,4,0,8,0,0,0,8,8,0],[4,4,0,4,0,0,8,0,0,0,8,8],[4,4,4,0,0,0,0,1,1,0,0,1],[2,0,0,0,0,8,8,8,2,2,0,0],[0,8,0,0,8,0,8,8,0,8,8,0],[0,0,8,0,8,8,0,8,0,0,8,8],[0,0,0,1,8,8,8,0,1,0,0,1],[2,0,0,1,2,0,0,1,0,2,0,1],[2,8,0,0,2,8,0,0,2,0,8,0],[0,8,8,0,0,8,8,0,0,8,0,8],[0,0,8,1,0,0,8,1,1,0,8,0]],d=0,p=!1,y=!1,g=!1,m=!1,x=-1,v=e*n*i,b=e,_=e*n,C=new Int32Array(12),w=[],S=[],M=[],B=[],L=eb(),U=tb();function E(j,Z,ce){return j+(Z-j)*ce}function O(j,Z,ce){return _*(ce=(ce+u)%i)+b*(Z=(Z+h)%n)+(j=(j+l)%e)}function k(j,Z,ce,de,oe,V,re){var q=3*j;if(o[q]<0){var J=(d-V)/(re-V),W=s,H=3*a;if(w[H]=ce+J,w[H+1]=de,w[H+2]=oe,!p){var se=3*j;S[H]=x*E(W[se],W[se+3],J),S[H+1]=x*E(W[se+1],W[se+4],J),S[H+2]=x*E(W[se+2],W[se+5],J)}r&&(B[a]=r[j+Math.round(J)]),o[q]=a,C[Z]=a,a+=1}else C[Z]=o[q]}function ne(j,Z,ce,de,oe,V,re){var q=3*j+1;if(o[q]<0){var J=(d-V)/(re-V),W=s,H=3*a;if(w[H]=ce,w[H+1]=de+J,w[H+2]=oe,!p){var se=3*j,$=se+3*b;S[H]=x*E(W[se],W[$],J),S[H+1]=x*E(W[se+1],W[$+1],J),S[H+2]=x*E(W[se+2],W[$+2],J)}r&&(B[a]=r[j+Math.round(J)*b]),o[q]=a,C[Z]=a,a+=1}else C[Z]=o[q]}function Y(j,Z,ce,de,oe,V,re){var q=3*j+2;if(o[q]<0){var J=(d-V)/(re-V),W=s,H=3*a;if(w[H]=ce,w[H+1]=de,w[H+2]=oe+J,!p){var se=3*j,$=se+3*_;S[H]=x*E(W[se],W[$],J),S[H+1]=x*E(W[se+1],W[$+1],J),S[H+2]=x*E(W[se+2],W[$+2],J)}r&&(B[a]=r[j+Math.round(J)*_]),o[q]=a,C[Z]=a,a+=1}else C[Z]=o[q]}function F(j){var Z=3*j;s[Z]===0&&(s[Z]=t[(j-1+v)%v]-t[(j+1)%v],s[Z+1]=t[(j-b+v)%v]-t[(j+b)%v],s[Z+2]=t[(j-_+v)%v]-t[(j+_)%v])}function te(j,Z,ce,de,oe){var V,re,q,J,W,H,se;g?(de=O(j,Z,ce),V=O(j+1,Z,ce),re=O(j,Z+1,ce),q=O(j,Z,ce+1),J=O(j+1,Z+1,ce),W=O(j+1,Z,ce+1),H=O(j,Z+1,ce+1),se=O(j+1,Z+1,ce+1)):(V=de+1,J=(re=de+b)+1,W=(q=de+_)+1,se=(H=re+_)+1);var $=0,he=t[de],me=t[V],le=t[re],D=t[J],N=t[q],pe=t[W],ue=t[H],X=t[se];he<d&&($|=1),me<d&&($|=2),le<d&&($|=8),D<d&&($|=4),N<d&&($|=16),pe<d&&($|=32),ue<d&&($|=128),X<d&&($|=64);var ye=L[$];if(ye===0)return 0;var _e=j+1,xe=Z+1,Se=ce+1;1&ye&&(p||(F(de),F(V)),k(de,0,j,Z,ce,he,me)),2&ye&&(p||(F(V),F(J)),ne(V,1,_e,Z,ce,me,D)),4&ye&&(p||(F(re),F(J)),k(re,2,j,xe,ce,le,D)),8&ye&&(p||(F(de),F(re)),ne(de,3,j,Z,ce,he,le)),16&ye&&(p||(F(q),F(W)),k(q,4,j,Z,Se,N,pe)),32&ye&&(p||(F(W),F(se)),ne(W,5,_e,Z,Se,pe,X)),64&ye&&(p||(F(H),F(se)),k(H,6,j,xe,Se,ue,X)),128&ye&&(p||(F(q),F(H)),ne(q,7,j,Z,Se,N,ue)),256&ye&&(p||(F(de),F(q)),Y(de,8,j,Z,ce,he,N)),512&ye&&(p||(F(V),F(W)),Y(V,9,_e,Z,ce,me,pe)),1024&ye&&(p||(F(J),F(se)),Y(J,10,_e,xe,ce,D,X)),2048&ye&&(p||(F(re),F(H)),Y(re,11,j,xe,ce,le,ue));for(var Me,Oe,Ne,we=$<<4,Fe=0;U[we+Fe]!==-1;)Me=U[we+Fe],Oe=U[we+Fe+1],Ne=U[we+Fe+2],y?(f[Me][Oe]&oe&&(M[c++]=C[Me],M[c++]=C[Oe]),f[Oe][Ne]&oe&&(M[c++]=C[Oe],M[c++]=C[Ne]),f[Me][Ne]&oe&&(M[c++]=C[Me],M[c++]=C[Ne])):(M[c++]=C[m?Me:Oe],M[c++]=C[m?Oe:Me],M[c++]=C[Ne]),Fe+=3}function ee(j,Z,ce,de,oe,V){let re,q,J,W,H,se,$,he,me,le,D,N,pe;if(j=j!==void 0?j:0,Z=Z!==void 0?Z:0,ce=ce!==void 0?ce:0,de=de!==void 0?de:e-1,oe=oe!==void 0?oe:n-1,V=V!==void 0?V:i-1,g||(p?(j=Math.max(0,j),Z=Math.max(0,Z),ce=Math.max(0,ce),de=Math.min(e-1,de),oe=Math.min(n-1,oe),V=Math.min(i-1,V)):(j=Math.max(1,j),Z=Math.max(1,Z),ce=Math.max(1,ce),de=Math.min(e-2,de),oe=Math.min(n-2,oe),V=Math.min(i-2,V))),g)for(he=j-2,me=Z-2,le=ce-2,D=de+2,N=oe+2,pe=V+2,H=le;H<pe;++H)for(W=me;W<N;++W)for(J=he;J<D;++J)q=3*O(J,W,H),o[q]=-1,o[q+1]=-1,o[q+2]=-1;else for(he=Math.max(0,j-2),me=Math.max(0,Z-2),le=Math.max(0,ce-2),D=Math.min(e,de+2),N=Math.min(n,oe+2),pe=Math.min(i,V+2),H=le;H<pe;++H)for($=_*H,W=me;W<N;++W)for(se=$+b*W,J=he;J<D;++J)re=3*(se+J),o[re]=-1,o[re+1]=-1,o[re+2]=-1;if(!g){var ue,X=j,ye=Z,_e=ce,xe=de,Se=oe,Me=V;for(ue=!1,H=ce;H<V;++H){for(W=Z;W<oe;++W){for(J=j;J<de;++J)if(re=e*n*H+e*W+J,t[re]>=d){_e=H,ue=!0;break}if(ue)break}if(ue)break}for(ue=!1,W=Z;W<oe;++W){for(H=_e;H<V;++H){for(J=j;J<de;++J)if(re=e*n*H+e*W+J,t[re]>=d){ye=W,ue=!0;break}if(ue)break}if(ue)break}for(ue=!1,J=j;J<de;++J){for(W=ye;W<oe;++W){for(H=_e;H<V;++H)if(re=e*n*H+e*W+J,t[re]>=d){X=J,ue=!0;break}if(ue)break}if(ue)break}for(ue=!1,H=V;H>=ce;--H){for(W=oe;W>=Z;--W){for(J=de;J>=j;--J)if(re=e*n*H+e*W+J,t[re]>=d){Me=H,ue=!0;break}if(ue)break}if(ue)break}for(ue=!1,W=oe;W>=Z;--W){for(H=Me;H>=ce;--H){for(J=de;J>=j;--J)if(re=e*n*H+e*W+J,t[re]>=d){Se=W,ue=!0;break}if(ue)break}if(ue)break}for(ue=!1,J=de;J>=j;--J){for(W=Se;W>=Z;--W){for(H=Me;H>=ce;--H)if(re=e*n*H+e*W+J,t[re]>=d){xe=J,ue=!0;break}if(ue)break}if(ue)break}p?(j=Math.max(0,X-1),Z=Math.max(0,ye-1),ce=Math.max(0,_e-1),de=Math.min(e-1,xe+1),oe=Math.min(n-1,Se+1),V=Math.min(i-1,Me+1)):(j=Math.max(1,X-1),Z=Math.max(1,ye-1),ce=Math.max(1,_e-1),de=Math.min(e-2,xe+1),oe=Math.min(n-2,Se+1),V=Math.min(i-2,Me+1))}var Oe=15;for(H=ce;H<V;++H,Oe&=-5)for($=_*H,Oe|=2,W=Z;W<oe;++W,Oe&=-3)for(se=$+b*W,Oe|=1,J=j;J<de;++J,Oe&=-2)re=se+J,te(J,W,H,re,Oe)}this.triangulate=function(j,Z,ce,de,oe){m=(d=j)<0,y=de,g=oe,(p=Z||y)||(x=d>0?-1:1,s||(s=new Float32Array(3*v)));var V=3*v;if(o&&o.length===V||(o=new Int32Array(V)),a=0,c=0,ce!==void 0){var re=ce[0].map(Math.round),q=ce[1].map(Math.round);l=e*Math.ceil(Math.abs(re[0])/e),h=n*Math.ceil(Math.abs(re[1])/n),u=i*Math.ceil(Math.abs(re[2])/i),ee(re[0],re[1],re[2],q[0],q[1],q[2])}else l=h=u=0,ee();return w.length=3*a,p||(S.length=3*a),M.length=c,r&&(B.length=a),{position:new Float32Array(w),normal:p?void 0:new Float32Array(S),index:$i(M,w.length/3),atomindex:r?new Int32Array(B):void 0,contour:y}}}ni.add("arrow",class extends ii{get primitive(){return Ou}}),ni.add("box",class extends ii{get primitive(){return Ts}}),ni.add("cone",class extends ii{get primitive(){return ku}}),ni.add("cylinder",class extends ii{get primitive(){return Ps}}),ni.add("ellipsoid",class extends ii{get primitive(){return jo}}),ni.add("octahedron",class extends ii{get primitive(){return Du}}),ni.add("sphere",class extends ii{get primitive(){return Wo}}),ni.add("tetrahedron",class extends ii{get primitive(){return Bu}}),ni.add("torus",class extends ii{get primitive(){return Fu}}),ni.add("point",class extends ii{get primitive(){return zc}}),ni.add("wideline",class extends ii{get primitive(){return Gc}}),Object.assign(mm,{__deps:[eb,tb,$i]});class Pt{constructor(e,n){this.cols=e,this.rows=n,this.size=this.cols*this.rows,this.data=new Float32Array(this.size)}copyTo(e){e.data.set(this.data)}}function bi(t,e){let n=0,i=0;const r=e.rows,s=e.cols;let o=0,a=0,c=0;const l=e.data,h=t.data;for(;n<r;a+=1,o+=s,n++)for(c=a,i=0;i<s;c+=r,i++)h[c]=l[o+i]}function wh(t,e,n){let i=0,r=0,s=0,o=0,a=0,c=0,l=0;const h=e.cols,u=e.rows,f=n.rows,d=e.data,p=n.data,y=t.data;let g=0;for(;i<u;o+=h,i++)for(c=0,r=0;r<f;l++,r++){for(a=o,g=0,s=0;s<h;a++,c++,s++)g+=d[a]*p[c];y[l]=g}}function Ud(t,e,n){const i=t.data,r=e.data,s=n.data,o=r[0],a=r[1],c=r[2],l=r[3],h=r[4],u=r[5],f=r[6],d=r[7],p=r[8],y=s[0],g=s[1],m=s[2],x=s[3],v=s[4],b=s[5],_=s[6],C=s[7],w=s[8];i[0]=o*y+a*x+c*_,i[1]=o*g+a*v+c*C,i[2]=o*m+a*b+c*w,i[3]=l*y+h*x+u*_,i[4]=l*g+h*v+u*C,i[5]=l*m+h*b+u*w,i[6]=f*y+d*x+p*_,i[7]=f*g+d*v+p*C,i[8]=f*m+d*b+p*w}function Ip(t){const e=t.rows,n=t.cols,i=t.data,r=new Array(n);for(let s=0;s<n;++s)r[s]=0;for(let s=0,o=0;s<e;++s)for(let a=0;a<n;++a,++o)r[a]+=i[o];for(let s=0;s<n;++s)r[s]/=e;return r}function Lp(t,e){const n=t.rows,i=t.cols,r=t.data;for(let s=0,o=0;s<n;++s)for(let a=0;a<i;++a,++o)r[o]-=e[a]}function Vd(t,e,n,i){i=t[e],t[e]=t[n],t[n]=i}function BC(t,e){return(t=Math.abs(t))>(e=Math.abs(e))?(e/=t,t*Math.sqrt(1+e*e)):e>0?(t/=e,e*Math.sqrt(1+t*t)):0}const OC=1192092896e-16,kC=1e-37;function nb(t,e,n,i){let r=0,s=0;const o=t.rows,a=t.cols;let c=o,l=a;c<l&&(r=1,s=c,c=l,l=s);const h=new Pt(c,c),u=new Pt(1,l),f=new Pt(l,l);if(r===0)bi(h,t);else{for(s=0;s<a*o;s++)h.data[s]=t.data[s];for(;s<l*c;s++)h.data[s]=0}if(function(d,p,y,g,m,x,v,b){const _=2*OC,C=kC;let w=0,S=0,M=0,B=0;const L=Math.max(x,30);let U=0,E=0,O=0,k=0,ne=0,Y=0,F=0,te=0,ee=0,j=0,Z=0,ce=0,de=0,oe=0,V=0,re=0,q=0,J=4660,W=0,H=0,se=0;const $=new Float64Array(v<<3);for(;w<v;w++){for(M=0,Z=0;M<x;M++)te=d[w*p+M],Z+=te*te;if($[w]=Z,g){for(M=0;M<v;M++)g[w*m+M]=0;g[w*m+w]=1}}for(;B<L;B++){for(ne=0,w=0;w<v-1;w++)for(S=w+1;S<v;S++){for(U=w*p|0,E=S*p|0,V=$[w],re=0,q=$[S],M=2,re+=d[U]*d[E],re+=d[U+1]*d[E+1];M<x;M++)re+=d[U+M]*d[E+M];if(!(Math.abs(re)<=_*Math.sqrt(V*q))){for(re*=2,ce=V-q,de=BC(re,ce),ce<0?(oe=.5*(de-ce),F=Math.sqrt(oe/de),Y=re/(de*F*2)):(Y=Math.sqrt((de+ce)/(2*de)),F=re/(de*Y*2)),V=0,q=0,M=2,ee=Y*d[U]+F*d[E],j=-F*d[U]+Y*d[E],d[U]=ee,d[E]=j,V+=ee*ee,q+=j*j,ee=Y*d[U+1]+F*d[E+1],j=-F*d[U+1]+Y*d[E+1],d[U+1]=ee,d[E+1]=j,V+=ee*ee,q+=j*j;M<x;M++)ee=Y*d[U+M]+F*d[E+M],j=-F*d[U+M]+Y*d[E+M],d[U+M]=ee,d[E+M]=j,V+=ee*ee,q+=j*j;if($[w]=V,$[S]=q,ne=1,g)for(O=w*m|0,k=S*m|0,M=2,ee=Y*g[O]+F*g[k],j=-F*g[O]+Y*g[k],g[O]=ee,g[k]=j,ee=Y*g[O+1]+F*g[k+1],j=-F*g[O+1]+Y*g[k+1],g[O+1]=ee,g[k+1]=j;M<v;M++)ee=Y*g[O+M]+F*g[k+M],j=-F*g[O+M]+Y*g[k+M],g[O+M]=ee,g[k+M]=j}}if(ne===0)break}for(w=0;w<v;w++){for(M=0,Z=0;M<x;M++)te=d[w*p+M],Z+=te*te;$[w]=Math.sqrt(Z)}for(w=0;w<v-1;w++){for(S=w,M=w+1;M<v;M++)$[S]<$[M]&&(S=M);if(w!==S&&(Vd($,w,S,Z),g)){for(M=0;M<x;M++)Vd(d,w*p+M,S*p+M,te);for(M=0;M<v;M++)Vd(g,w*m+M,S*m+M,te)}}for(w=0;w<v;w++)y[w]=$[w];if(g)for(w=0;w<b;w++){for(Z=w<v?$[w]:0;Z<=C;){for(H=1/x,M=0;M<x;M++)J=214013*J+2531011,W=256&J>>16?H:-H,d[w*p+M]=W;for(B=0;B<2;B++)for(S=0;S<w;S++){for(Z=0,M=0;M<x;M++)Z+=d[w*p+M]*d[S*p+M];for(se=0,M=0;M<x;M++)te=d[w*p+M]-Z*d[S*p+M],d[w*p+M]=te,se+=Math.abs(te);for(se=se?1/se:0,M=0;M<x;M++)d[w*p+M]*=se}for(Z=0,M=0;M<x;M++)te=d[w*p+M],Z+=te*te;Z=Math.sqrt(Z)}for(F=1/Z,M=0;M<x;M++)d[w*p+M]*=F}}(h.data,c,u.data,f.data,l,c,l,c),e){for(s=0;s<l;s++)e.data[s]=u.data[s];for(;s<a;s++)e.data[s]=0}r===0?(n&&bi(n,h),i&&bi(i,f)):(n&&bi(n,f),i&&bi(i,h))}function Ya(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function _o(t,e,n,i,r,s,o,a,c,l,h,u,f,d,p,y,g){t[0]=e,t[4]=n,t[8]=i,t[12]=r,t[1]=s,t[5]=o,t[9]=a,t[13]=c,t[2]=l,t[6]=h,t[10]=u,t[14]=f,t[3]=d,t[7]=p,t[11]=y,t[15]=g}function Sh(t,e,n){const i=e[0],r=e[4],s=e[8],o=e[12],a=e[1],c=e[5],l=e[9],h=e[13],u=e[2],f=e[6],d=e[10],p=e[14],y=e[3],g=e[7],m=e[11],x=e[15],v=n[0],b=n[4],_=n[8],C=n[12],w=n[1],S=n[5],M=n[9],B=n[13],L=n[2],U=n[6],E=n[10],O=n[14],k=n[3],ne=n[7],Y=n[11],F=n[15];t[0]=i*v+r*w+s*L+o*k,t[4]=i*b+r*S+s*U+o*ne,t[8]=i*_+r*M+s*E+o*Y,t[12]=i*C+r*B+s*O+o*F,t[1]=a*v+c*w+l*L+h*k,t[5]=a*b+c*S+l*U+h*ne,t[9]=a*_+c*M+l*E+h*Y,t[13]=a*C+c*B+l*O+h*F,t[2]=u*v+f*w+d*L+p*k,t[6]=u*b+f*S+d*U+p*ne,t[10]=u*_+f*M+d*E+p*Y,t[14]=u*C+f*B+d*O+p*F,t[3]=y*v+g*w+m*L+x*k,t[7]=y*b+g*S+m*U+x*ne,t[11]=y*_+g*M+m*E+x*Y,t[15]=y*C+g*B+m*O+x*F}function Rp(t,e,n,i){_o(t,e,0,0,0,0,n,0,0,0,0,i,0,0,0,0,1)}function Dp(t,e,n,i){_o(t,1,0,0,e,0,1,0,n,0,0,1,i,0,0,0,1)}function Bp(t,e){const n=Math.cos(e),i=Math.sin(e);_o(t,n,0,i,0,0,1,0,0,-i,0,n,0,0,0,0,1)}function ib(){return new Float32Array([1,0,0,0,1,0,0,0,1])}function gm(t,e){const n=st([e[0],e[1],e[2]]),i=st([e[4],e[5],e[6]]),r=st([e[8],e[9],e[10]]),s=st();Vn(s,i,r),t[0]=s[0],t[1]=s[1],t[2]=s[2],Vn(s,r,n),t[3]=s[0],t[4]=s[1],t[5]=s[2],Vn(s,n,i),t[6]=s[0],t[7]=s[1],t[8]=s[2]}function ym(t,e,n,i){n=n||1,i=i||!0;const r=t.length/3,s=e.length/3;let o;i&&(o=new Float32Array(3*r));const a=new Float32Array(3*r);let c;const l=new Array(20);for(c=0;c<20;++c)l[c]=new Uint32Array(r);for(c=0;c<r;++c)l[0][c]=0;let h,u,f;for(c=0;c<s;++c){var d=3*c,p=3*c+1,y=3*c+2;for(f=!0,h=0,u=l[0][e[d]];h<u;++h)if(e[p]===l[h+1][e[d]]){f=!1;break}for(f&&(l[0][e[d]]++,l[l[0][e[d]]][e[d]]=e[p]),f=!0,h=0,u=l[0][e[d]];h<u;++h)if(e[y]===l[h+1][e[d]]){f=!1;break}for(f&&(l[0][e[d]]++,l[l[0][e[d]]][e[d]]=e[y]),f=!0,h=0,u=l[0][e[p]];h<u;++h)if(e[d]===l[h+1][e[p]]){f=!1;break}for(f&&(l[0][e[p]]++,l[l[0][e[p]]][e[p]]=e[d]),f=!0,h=0,u=l[0][e[p]];h<u;++h)if(e[y]===l[h+1][e[p]]){f=!1;break}for(f&&(l[0][e[p]]++,l[l[0][e[p]]][e[p]]=e[y]),f=!0,h=0;h<l[0][e[y]];++h)if(e[d]===l[h+1][e[y]]){f=!1;break}for(f&&(l[0][e[y]]++,l[l[0][e[y]]][e[y]]=e[d]),f=!0,h=0,u=l[0][e[y]];h<u;++h)if(e[p]===l[h+1][e[y]]){f=!1;break}f&&(l[0][e[y]]++,l[l[0][e[y]]][e[y]]=e[p])}for(var g,m,x,v,b,_=.5,C=.75/4.5,w=0;w<n;++w){for(c=0;c<r;++c)if(g=3*c,(x=l[0][c])<3)a[g]=t[g],a[g+1]=t[g+1],a[g+2]=t[g+2];else if(x===3||x===4){for(a[g]=0,a[g+1]=0,a[g+2]=0,h=0;h<x;++h)m=3*l[h+1][c],a[g]+=t[m],a[g+1]+=t[m+1],a[g+2]+=t[m+2];a[g]+=_*t[g],a[g+1]+=_*t[g+1],a[g+2]+=_*t[g+2],b=_+x,a[g]/=b,a[g+1]/=b,a[g+2]/=b}else{for(a[g]=0,a[g+1]=0,a[g+2]=0,h=0;h<x;++h)m=3*l[h+1][c],a[g]+=t[m],a[g+1]+=t[m+1],a[g+2]+=t[m+2];a[g]+=1*t[g],a[g+1]+=1*t[g+1],a[g+2]+=1*t[g+2],v=1+x,a[g]/=v,a[g+1]/=v,a[g+2]/=v}if(t.set(a),i){Vc(t,e,o);var S=3*r;for(g=0;g<S;g+=3)t[g]+=-1*C*o[g],t[g+1]+=-1*C*o[g+1],t[g+2]+=-1*C*o[g+2]}}}function Vc(t,e,n){var i,r;if(n===void 0)n=new Float32Array(t.length);else for(i=0,r=n.length;i<r;i++)n[i]=0;var s=new Float32Array(3),o=new Float32Array(3),a=new Float32Array(3),c=new Float32Array(3),l=new Float32Array(3);if(e)for(i=0,r=e.length;i<r;i+=3){var h=3*e[i],u=3*e[i+1],f=3*e[i+2];Ln(s,t,h),Ln(o,t,u),Ln(a,t,f),Qt(c,a,o),Qt(l,s,o),Vn(c,c,l),n[h]+=c[0],n[h+1]+=c[1],n[h+2]+=c[2],n[u]+=c[0],n[u+1]+=c[1],n[u+2]+=c[2],n[f]+=c[0],n[f+1]+=c[1],n[f+2]+=c[2]}else for(i=0,r=t.length;i<r;i+=9)Ln(s,t,i),Ln(o,t,i+3),Ln(a,t,i+6),Qt(c,a,o),Qt(l,s,o),Vn(c,c,l),n[i]=c[0],n[i+1]=c[1],n[i+2]=c[2],n[i+3]=c[0],n[i+4]=c[1],n[i+5]=c[2],n[i+6]=c[0],n[i+7]=c[1],n[i+8]=c[2];return Nx(n),n}function rb(t){for(var e={},n=0,i=t.length;n<i;++n)e[t[n]]=!0;return e}function Hc(t,e,n,i,r){var s=1/i*3;Gx(t,t,r+(s+=n)),_h(e,e,r+s),kt(t,t,i),Pp(t,t),po(t,t,i),kt(e,e,i),qa(e,e),po(e,e,i);var o=new Float32Array(3);Qt(o,e,t),kt(o,o,i),qa(o,o),_h(o,o,1);var a=256*Math.pow(10,6),c=o[0]*o[1]*o[2]*3;a<=c&&(kt(t,t,i*=Math.pow(a/c,1/3)),Pp(t,t),po(t,t,i),kt(e,e,i),qa(e,e),po(e,e,i),Qt(o,e,t),kt(o,o,i),qa(o,o),_h(o,o,1));var l=new Float32Array(t);Ru(l,l);var h=Ya(),u=Ya();Bp(u,rn(90)),Sh(h,h,u);var f=Ya();Rp(f,-1/i,1/i,1/i),Sh(h,h,f);var d=Ya();return Dp(d,-i*l[2],-i*l[1],-i*l[0]),Sh(h,h,d),{dim:o,tran:l,matrix:h,scaleFactor:i}}Rp.__deps=[_o],Dp.__deps=[_o],Bp.__deps=[_o],gm.__deps=[st,Vn],Object.assign(ym,{__deps:[Vc]}),Object.assign(Vc,{__deps:[Qt,Vn,Ln,Nx]}),Object.assign(Hc,{__deps:[rn,Gx,_h,po,kt,Pp,qa,Qt,Ru,Ya,Sh,Dp,Rp,Bp]});class Nu{constructor(e,n,i){this.name=e||"",this.path=n||"",this.info={},this.center=new T,this.boundingBox=new Ut,i instanceof rt||i instanceof We||i instanceof Ot?this.fromGeometry(i):i&&(this.set(i.position,i.index,i.normal,i.color,i.atomindex,i.contour),this.boundingBox.setFromArray(i.position),this.boundingBox.getCenter(this.center))}get type(){return"Surface"}set(e,n,i,r,s,o=!1){this.position=e,this.index=n,this.normal=i,this.color=r,this.atomindex=s,this.size=e.length/3,this.contour=o}fromGeometry(e){let n,i,r,s;if(Ce&&fe.time("GeometrySurface.fromGeometry"),e instanceof rt?(e.computeVertexNormals(!0),n=new We().fromGeometry(e)):n=e instanceof We?e:e[0],n.boundingBox||n.computeBoundingBox(),this.boundingBox.copy(n.boundingBox),this.boundingBox.getCenter(this.center),n instanceof We){const o=n.attributes,a=!!o.normal&&o.normal.array;(!a||a[0]===0&&a[1]===0&&a[2]===0)&&n.computeVertexNormals(),i=o.position.array,r=o.index?o.index.array:null,s=o.normal.array}this.set(i,r,s,void 0,void 0),Ce&&fe.timeEnd("GeometrySurface.setGeometry")}getPosition(){return this.position}getColor(e){const n=e||{};n.surface=this;const i=this.size,r=new Float32Array(3*i),s=mt.getScheme(n);if(s.volumeColor||n.scheme==="random")for(let a=0;a<i;++a)s.volumeColorToArray(a,r,3*a);else if(s.positionColor){const a=new T,c=this.position;for(let l=0;l<i;++l){var o=3*l;a.set(c[o],c[o+1],c[o+2]),s.positionColorToArray(a,r,o)}}else if(s.atomColor&&this.atomindex){const a=n.structure.getAtomProxy(),c=this.atomindex;for(let l=0;l<i;++l)a.index=c[l],s.atomColorToArray(a,r,3*l)}else{const a=new ke(n.value);Bt(i,a.r,a.g,a.b,r)}return r}getPicking(e){return this.atomindex&&e?new Rs(this.atomindex,e):new LC(ea(this.size),this)}getNormal(){return this.normal}getSize(e,n){return Jn(this.size,e*n)}getIndex(){return this.index}getFilteredIndex(e,n){if(e&&this.atomindex){const i=new qt(e),r=n.getAtomSet(i),s=[],o=this.atomindex,a=this.index,c=a.length,l=this.contour?2:3;let h=0;for(let u=0;u<c;u+=l){let f=!0;for(let d=0;d<l;d++){const p=o[a[u+d]];if(!r.get(p)){f=!1;break}}if(f)for(let d=0;d<l;d++,h++)s[h]=a[u+d]}return $i(s,this.position.length/3)}return this.index}getAtomindex(){return this.atomindex}dispose(){}}function Gr(t,e,n,i,r){var s=new mm(t,e,n,i,r);this.getSurface=function(o,a,c,l,h,u=!1){const f=s.triangulate(o,a,c,h,u);if(a&&!h&&(ym(f.position,f.index,a,!0),f.normal=Vc(f.position,f.index)),l&&(Lu(l,f.position),f.normal)){const d=ib();gm(d,l),pm(d,f.normal)}return f}}Object.assign(Gr,{__deps:[ym,Vc,mm,Lu,pm,ib,gm]}),ec.add("surf",function(t,e){const n=t.data.args,i=t.data.params;if(n&&(self.volsurf=new Gr(n[0],n[1],n[2],n[3],n[4])),i){const r=self.volsurf.getSurface(i.isolevel,i.smooth,i.box,i.matrix,i.contour,i.wrap),s=[r.position.buffer,r.index.buffer];r.normal&&s.push(r.normal.buffer),r.atomindex&&s.push(r.atomindex.buffer),e({sd:r,p:i},s)}},[Gr]);class Nn{constructor(e,n,i,r,s,o,a){this.name=e,this.path=n,this.matrix=new Ie,this.normalMatrix=new An,this.inverseMatrix=new Ie,this.center=new T,this.boundingBox=new Ut,this.setData(i,r,s,o,a)}get type(){return"Volume"}setData(e,n,i,r,s){this.nx=n||1,this.ny=i||1,this.nz=r||1,this.data=e||new Float32Array(1),this.setAtomindex(s),this._position=new Float32Array,delete this._min,delete this._max,delete this._mean,delete this._rms,this.worker&&this.worker.terminate()}setStats(e,n,i,r){this._min=e,this._max=n,this._mean=i,this._rms=r}setMatrix(e){this.matrix.copy(e);const n=this.boundingBox,i=this.center,r=this.nx-1,s=this.ny-1,o=this.nz-1;n.makeEmpty(),n.expandByPoint(i.set(r,s,o)),n.expandByPoint(i.set(r,s,0)),n.expandByPoint(i.set(r,0,o)),n.expandByPoint(i.set(r,0,0)),n.expandByPoint(i.set(0,s,o)),n.expandByPoint(i.set(0,0,o)),n.expandByPoint(i.set(0,s,0)),n.expandByPoint(i.set(0,0,0)),n.applyMatrix4(this.matrix),n.getCenter(this.center);const a=this.matrix.elements,c=new T(a[0],a[1],a[2]),l=new T(a[4],a[5],a[6]),h=new T(a[8],a[9],a[10]),u=new T,f=this.normalMatrix.elements;u.crossVectors(l,h),f[0]=u.x,f[1]=u.y,f[2]=u.z,u.crossVectors(h,c),f[3]=u.x,f[4]=u.y,f[5]=u.z,u.crossVectors(c,l),f[6]=u.x,f[7]=u.y,f[8]=u.z,this.inverseMatrix.getInverse(this.matrix)}setAtomindex(e){this.atomindex=e}getBox(e,n,i){return i||(i=new Ut),i.set(e,e),i.expandByScalar(n),i.applyMatrix4(this.inverseMatrix),i.min.round(),i.max.round(),i}_getBox(e,n){if(!e||!n)return;this.__box||(this.__box=new Ut);const i=this.getBox(e,n,this.__box);return[i.min.toArray(),i.max.toArray()]}_makeSurface(e,n,i){const r=this.name+"@"+n.toPrecision(2),s=new Nu(r,"",e);return s.info.isolevel=n,s.info.smooth=i,s.info.volume=this,s}getSurface(e,n,i,r,s,o=!1){e=isNaN(e)?this.getValueForSigma(2):e,n=I(n,0),this.volsurf===void 0&&(this.volsurf=new Gr(this.data,this.nx,this.ny,this.nz,this.atomindex));const a=this._getBox(i,r),c=this.volsurf.getSurface(e,n,a,this.matrix.elements,s,o);return this._makeSurface(c,e,n)}getSurfaceWorker(e,n,i,r,s,o,a){if(e=isNaN(e)?this.getValueForSigma(2):e,n=n||0,window.hasOwnProperty("Worker")){this.workerPool===void 0&&(this.workerPool=new Cp("surf",2));const c={},l=this.workerPool.getNextWorker();l.postCount===0&&Object.assign(c,{args:[this.data,this.nx,this.ny,this.nz,this.atomindex]}),Object.assign(c,{params:{isolevel:e,smooth:n,box:this._getBox(i,r),matrix:this.matrix.elements,contour:s,wrap:o}}),l.post(c,void 0,h=>{const u=h.data.sd,f=h.data.p;a(this._makeSurface(u,f.isolevel,f.smooth))},h=>{console.warn("Volume.getSurfaceWorker error - trying without worker",h);const u=this.getSurface(e,n,i,r,s,o);a(u)})}else{const c=this.getSurface(e,n,i,r,s,o);a(c)}}getValueForSigma(e){return this.mean+I(e,2)*this.rms}getSigmaForValue(e){return(I(e,0)-this.mean)/this.rms}get position(){if(!this._position){const e=this.nz,n=this.ny,i=this.nx,r=new Float32Array(i*n*e*3);let s=0;for(let o=0;o<e;++o)for(let a=0;a<n;++a)for(let c=0;c<i;++c)r[s+0]=c,r[s+1]=a,r[s+2]=o,s+=3;Lu(this.matrix.elements,r),this._position=r}return this._position}getDataAtomindex(){return this.atomindex}getDataPosition(){return this.position}getDataColor(e){const n=e||{};n.volume=this,n.scale=n.scale||"Spectral",n.domain=n.domain||[this.min,this.max];const i=mt.getScheme(n),r=this.position.length/3,s=new Float32Array(3*r);for(let o=0;o<r;++o)i.volumeColorToArray(o,s,3*o);return s}getDataPicking(){const e=ea(this.position.length/3);return new Qx(e,this)}getDataSize(e,n){const i=this.data,r=this.position.length/3;let s;switch(e){case"value":case"deviation":s=new Float32Array(i);break;case"abs-value":s=new Float32Array(i);for(let o=0;o<r;++o)s[o]=Math.abs(s[o]);break;case"value-min":{s=new Float32Array(i);const o=this.min;for(let a=0;a<r;++a)s[a]-=o;break}default:s=Jn(r,e)}if(n!==1)for(let o=0;o<r;++o)s[o]*=n;return s}get min(){return this._min===void 0&&(this._min=bh(this.data)),this._min}get max(){return this._max===void 0&&(this._max=xh(this.data)),this._max}get sum(){return this._sum===void 0&&(this._sum=fm(this.data)),this._sum}get mean(){return this._mean===void 0&&(this._mean=vh(this.data)),this._mean}get rms(){return this._rms===void 0&&(this._rms=function(e){const n=e.length;let i=0;for(let r=0;r<n;++r){const s=e[r];i+=s*s}return Math.sqrt(i/n)}(this.data)),this._rms}clone(){const e=new Nn(this.name,this.path,this.data,this.nx,this.ny,this.nz,this.atomindex);return e.matrix.copy(this.matrix),e.header=Object.assign({},this.header),e}dispose(){this.workerPool&&this.workerPool.terminate()}}function K0(t){return t==="front"?Yo:t==="back"?yn:jc}At.add("shader/Mesh.vert",`#define STANDARD
uniform float clipNear;
uniform vec3 clipCenter;
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )
varying vec3 vViewPosition;
#endif
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#if defined( PICKING )
#include unpack_color
attribute float primitiveId;
varying vec3 vPickingColor;
#elif defined( NOLIGHT )
varying vec3 vColor;
#else
#include color_pars_vertex
#ifndef FLAT_SHADED
varying vec3 vNormal;
#endif
#endif
#include common
void main(){
#if defined( PICKING )
vPickingColor = unpackColor( primitiveId );
#elif defined( NOLIGHT )
vColor = color;
#else
#include color_vertex
#include beginnormal_vertex
#include defaultnormal_vertex
#ifndef FLAT_SHADED
vNormal = normalize( transformedNormal );
#endif
#endif
#include begin_vertex
#include project_vertex
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )
vViewPosition = -mvPosition.xyz;
#endif
#if defined( RADIUS_CLIP )
vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;
#endif
#include nearclip_vertex
}`),At.add("shader/Mesh.frag",`#define STANDARD
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 interiorColor;
uniform float interiorDarkening;
uniform float roughness;
uniform float metalness;
uniform float opacity;
uniform float clipNear;
uniform float clipRadius;
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )
varying vec3 vViewPosition;
#endif
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#if defined( PICKING )
uniform float objectId;
varying vec3 vPickingColor;
#elif defined( NOLIGHT )
varying vec3 vColor;
#else
#ifndef FLAT_SHADED
varying vec3 vNormal;
#endif
#include common
#include color_pars_fragment
#include fog_pars_fragment
#include bsdfs
#include lights_pars_begin
#include lights_physical_pars_fragment
#endif
void main(){
#include nearclip_fragment
#include radiusclip_fragment
#if defined( PICKING )
if( opacity < 0.3 )
discard;
gl_FragColor = vec4( vPickingColor, objectId );
#elif defined( NOLIGHT )
gl_FragColor = vec4( vColor, opacity );
#else
vec4 diffuseColor = vec4( diffuse, opacity );
ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
vec3 totalEmissiveLight = emissive;
#include color_fragment
#include roughnessmap_fragment
#include metalnessmap_fragment
#include normal_fragment_begin
#include lights_physical_fragment
#include lights_fragment_begin
#include lights_fragment_end
vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;
#include interior_fragment
gl_FragColor = vec4( outgoingLight, diffuseColor.a );
#include premultiplied_alpha_fragment
#include tonemapping_fragment
#include encodings_fragment
#include fog_fragment
#include opaque_back_fragment
#endif
}`);const J0={f:1,v2:2,v3:3,c:3};function Hd(t,e){t.matrix.copy(e),t.matrix.decompose(t.position,t.quaternion,t.scale),t.matrixWorldNeedsUpdate=!0}const Bn={opaqueBack:!1,side:"double",opacity:1,depthWrite:!0,clipNear:0,clipRadius:0,clipCenter:new T,flatShaded:!1,wireframe:!1,roughness:.4,metalness:0,diffuse:16777215,diffuseInterior:!1,useInteriorColor:!1,interiorColor:14540253,interiorDarkening:0,forceTransparent:!1,matrix:new Ie,disablePicking:!1,sortParticles:!1,background:!1},Ds={opaqueBack:{updateShader:!0},side:{updateShader:!0,property:!0},opacity:{uniform:!0},depthWrite:{property:!0},clipNear:{updateShader:!0,property:!0},clipRadius:{updateShader:!0,uniform:!0},clipCenter:{uniform:!0},flatShaded:{updateShader:!0},background:{updateShader:!0},wireframe:{updateVisibility:!0},roughness:{uniform:!0},metalness:{uniform:!0},diffuse:{uniform:!0},diffuseInterior:{updateShader:!0},useInteriorColor:{updateShader:!0},interiorColor:{uniform:!0},interiorDarkening:{uniform:!0},matrix:{}};class Wi{constructor(e,n={}){this.parameterTypes=Ds,this.geometry=new We,this.indexVersion=0,this.wireframeIndexVersion=-1,this.group=new Ot,this.wireframeGroup=new Ot,this.pickingGroup=new Ot,this.vertexShader="",this.fragmentShader="",this.isImpostor=!1,this.isText=!1,this.isSurface=!1,this.isPoint=!1,this.isLine=!1,this.dynamic=!0,this.visible=!0,this.wireframeIndexCount=0,this.parameters=Kn(n,this.defaultParameters),this.uniforms=gh.merge([He.common,{fogColor:{value:new ke(0)},fogNear:{value:0},fogFar:{value:0},opacity:{value:this.parameters.opacity},clipNear:{value:0},clipRadius:{value:this.parameters.clipRadius},clipCenter:{value:this.parameters.clipCenter}},{emissive:{value:new ke(0)},roughness:{value:this.parameters.roughness},metalness:{value:this.parameters.metalness},interiorColor:{value:new ke(this.parameters.interiorColor)},interiorDarkening:{value:this.parameters.interiorDarkening}},He.lights]),this.uniforms.diffuse.value.set(this.parameters.diffuse),this.pickingUniforms={clipNear:{value:0},objectId:{value:0},opacity:{value:this.parameters.opacity}};const i=e.position||e.position1;this._positionDataSize=i?i.length/3:0,e.primitiveId||(e.primitiveId=ea(this._positionDataSize)),this.addAttributes({position:{type:"v3",value:e.position},color:{type:"c",value:e.color},primitiveId:{type:"f",value:e.primitiveId}}),n.matrix&&(this.matrix=n.matrix),e.index&&this.initIndex(e.index),this.picking=e.picking,this.makeWireframeGeometry()}get defaultParameters(){return Bn}set matrix(e){this.setMatrix(e)}get matrix(){return this.group.matrix.clone()}get transparent(){return this.parameters.opacity<1||this.parameters.forceTransparent}get size(){return this._positionDataSize}get attributeSize(){return this.size}get pickable(){return!!this.picking&&!this.parameters.disablePicking}setMatrix(e){Hd(this.group,e),Hd(this.wireframeGroup,e),Hd(this.pickingGroup,e)}initIndex(e){this.geometry.setIndex(new Qe(e,1));const n=this.geometry.getIndex();n?n.setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0):fe.error("Index is null")}makeMaterial(){const e=K0(this.parameters.side),n=new bn({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!0,fog:!0,side:e});n.vertexColors=!0,n.extensions.derivatives=!0,n.extensions.fragDepth=this.isImpostor;const i=new bn({uniforms:this.uniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:this.transparent,depthWrite:this.parameters.depthWrite,lights:!1,fog:!0,side:e});i.vertexColors=!0;const r=new bn({uniforms:this.pickingUniforms,vertexShader:"",fragmentShader:"",depthTest:!0,transparent:!1,depthWrite:this.parameters.depthWrite,lights:!1,fog:!1,side:e,blending:or});r.vertexColors=!0,r.extensions.fragDepth=this.isImpostor,n.clipNear=this.parameters.clipNear,i.clipNear=this.parameters.clipNear,r.clipNear=this.parameters.clipNear,this.material=n,this.wireframeMaterial=i,this.pickingMaterial=r,this.updateShader()}makeWireframeGeometry(){this.makeWireframeIndex();const e=this.geometry,n=this.wireframeIndex,i=new We;i.attributes=e.attributes,n&&(i.setIndex(new Qe(n,1).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)),i.setDrawRange(0,this.wireframeIndexCount)),this.wireframeGeometry=i}makeWireframeIndex(){const e=[];function n(s,o){if(s>o){const c=s;s=o,o=c}const a=e[s];return a===void 0?(e[s]=[o],!0):!a.includes(o)&&(a.push(o),!0)}const i=this.geometry,r=i.index;if(this.parameters.wireframe)if(r){const s=r.array;let o,a=s.length;i.drawRange.count!==1/0&&(a=i.drawRange.count),this.wireframeIndex&&this.wireframeIndex.length>2*a?o=this.wireframeIndex:o=$i(2*a,i.attributes.position.count);let c=0;e.length=0;for(let l=0;l<a;l+=3){const h=s[l+0],u=s[l+1],f=s[l+2];n(h,u)&&(o[c+0]=h,o[c+1]=u,c+=2),n(u,f)&&(o[c+0]=u,o[c+1]=f,c+=2),n(f,h)&&(o[c+0]=f,o[c+1]=h,c+=2)}this.wireframeIndex=o,this.wireframeIndexCount=c,this.wireframeIndexVersion=this.indexVersion}else{const s=i.attributes.position.count;let o;o=this.wireframeIndex&&this.wireframeIndex.length>2*s?this.wireframeIndex:$i(2*s,s);for(let a=0,c=0;a<s;a+=3)o[c+0]=a,o[c+1]=a+1,o[c+2]=a+1,o[c+3]=a+2,o[c+4]=a+2,o[c+5]=a,c+=6;this.wireframeIndex=o,this.wireframeIndexCount=2*s,this.wireframeIndexVersion=this.indexVersion}else this.wireframeIndex=new Uint16Array(0),this.wireframeIndexCount=0}updateWireframeIndex(){if(this.wireframeGeometry&&this.wireframeIndex){if(this.wireframeGeometry.setDrawRange(0,1/0),this.wireframeIndexVersion<this.indexVersion&&this.makeWireframeIndex(),this.wireframeGeometry.index&&this.wireframeIndex.length>this.wireframeGeometry.index.array.length)this.wireframeGeometry.setIndex(new Qe(this.wireframeIndex,1).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0));else{const e=this.wireframeGeometry.getIndex();if(!e)return void fe.error("Index is null");e.set(this.wireframeIndex),e.needsUpdate=this.wireframeIndexCount>0,e.updateRange.count=this.wireframeIndexCount}this.wireframeGeometry.setDrawRange(0,this.wireframeIndexCount)}}getRenderOrder(){let e=0;return this.isText?e=1:this.transparent&&(e=this.isSurface?3:2),e}_getMesh(e){this.material||this.makeMaterial();const n=this.geometry,i=this[e];let r;return r=this.isLine?new on(n,i):this.isPoint?new pc(n,i):new Ht(n,i),r.frustumCulled=!1,r.renderOrder=this.getRenderOrder(),r}getMesh(){return this._getMesh("material")}getWireframeMesh(){let e;return this.material||this.makeMaterial(),this.wireframeGeometry||this.makeWireframeGeometry(),e=new on(this.wireframeGeometry,this.wireframeMaterial),e.frustumCulled=!1,e.renderOrder=this.getRenderOrder(),e}getPickingMesh(){return this._getMesh("pickingMaterial")}getShader(e,n){return ja(e,this.getDefines(n))}getVertexShader(e){return this.getShader(this.vertexShader,e)}getFragmentShader(e){return this.getShader(this.fragmentShader,e)}getDefines(e){const n={};return this.parameters.clipNear&&(n.NEAR_CLIP=1),this.parameters.clipRadius&&(n.RADIUS_CLIP=1),e==="picking"?n.PICKING=1:((e==="background"||this.parameters.background)&&(n.NOLIGHT=1),this.parameters.flatShaded&&(n.FLAT_SHADED=1),this.parameters.opaqueBack&&(n.OPAQUE_BACK=1),this.parameters.diffuseInterior&&(n.DIFFUSE_INTERIOR=1),this.parameters.useInteriorColor&&(n.USE_INTERIOR_COLOR=1)),n}getParameters(){return this.parameters}addUniforms(e){this.uniforms=gh.merge([this.uniforms,e]),this.pickingUniforms=gh.merge([this.pickingUniforms,e])}addAttributes(e){for(let n in e){let i;const r=e[n],s=this.attributeSize*J0[r.type];r.value?(s!==r.value.length&&fe.error("attribute value has wrong length",n),i=r.value):i=Ax("float32",s),this.geometry.setAttribute(n,new Qe(i,J0[r.type]).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0))}}updateRenderOrder(){const e=this.getRenderOrder();function n(i){i.renderOrder=e}this.group.children.forEach(n),this.pickingGroup&&this.pickingGroup.children.forEach(n)}updateShader(){const e=this.material,n=this.wireframeMaterial,i=this.pickingMaterial;e.vertexShader=this.getVertexShader(),e.fragmentShader=this.getFragmentShader(),e.needsUpdate=!0,n.vertexShader=this.getShader("Line.vert"),n.fragmentShader=this.getShader("Line.frag"),n.needsUpdate=!0,i.vertexShader=this.getVertexShader("picking"),i.fragmentShader=this.getFragmentShader("picking"),i.needsUpdate=!0}setParameters(e){const n=e,i=this.parameterTypes,r=this.parameters,s={},o={};let a=!1,c=!1;for(const l in n){const h=n[l];h!==void 0&&(r[l]=h,i[l]!==void 0&&(i[l].property&&(i[l].property!==!0?s[i[l].property]=h:s[l]=h),i[l].uniform&&(i[l].uniform!==!0?o[i[l].uniform]=h:o[l]=h),i[l].updateShader&&(a=!0),i[l].updateVisibility&&(c=!0),this.dynamic&&l==="wireframe"&&h===!0&&this.updateWireframeIndex(),l==="forceTransparent"&&(s.transparent=this.transparent),l==="matrix"&&(this.matrix=h)))}this.setProperties(s),this.setUniforms(o),a&&this.updateShader(),c&&this.setVisibility(this.visible)}setAttributes(e){const n=this.geometry,i=n.attributes;for(const r in e){if(r==="picking")continue;const s=e[r],o=s.length;if(r==="index"){const a=n.getIndex();if(!a){fe.error("Index is null");continue}n.setDrawRange(0,1/0),o>a.array.length?n.setIndex(new Qe(s,1).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)):(a.set(s),a.count=o,a.needsUpdate=o>0,a.updateRange.count=o,n.setDrawRange(0,o)),this.indexVersion++,this.parameters.wireframe&&this.updateWireframeIndex()}else{const a=i[r];o>a.array.length?n.setAttribute(r,new Qe(s,a.itemSize).setUsage(this.dynamic?WebGLRenderingContext.DYNAMIC_DRAW:0)):(i[r].set(s),i[r].needsUpdate=o>0,i[r].updateRange.count=o)}}}setUniforms(e){if(!e)return;const n=this.material.uniforms,i=this.wireframeMaterial.uniforms,r=this.pickingMaterial.uniforms;for(let s in e)s==="opacity"&&this.setProperties({transparent:this.transparent}),n[s]!==void 0&&(n[s].value.isVector3?n[s].value.copy(e[s]):n[s].value.set?n[s].value.set(e[s]):n[s].value=e[s]),i[s]!==void 0&&(i[s].value.isVector3?i[s].value.copy(e[s]):i[s].value.set?i[s].value.set(e[s]):i[s].value=e[s]),r[s]!==void 0&&(r[s].value.isVector3?r[s].value.copy(e[s]):r[s].value.set?r[s].value.set(e[s]):r[s].value=e[s])}setProperties(e){if(!e)return;const n=this.material,i=this.wireframeMaterial,r=this.pickingMaterial;for(const s in e){const o=s;let a=e[o];o==="transparent"?this.updateRenderOrder():o==="side"&&(a=K0(a)),n[o]=a,i[o]=a,r[o]=a}n.needsUpdate=!0,i.needsUpdate=!0,r.needsUpdate=!0}setVisibility(e){this.visible=e,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=e,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=e,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=e))}dispose(){this.material&&this.material.dispose(),this.wireframeMaterial&&this.wireframeMaterial.dispose(),this.pickingMaterial&&this.pickingMaterial.dispose(),this.geometry.dispose(),this.wireframeGeometry&&this.wireframeGeometry.dispose()}toJSON(){var e={};for(var n in this)n!=="group"&&n!=="wireframeGroup"&&n!="pickingGroup"&&n!=="picking"&&(e[n]=this[n]);return e}}class mr extends Wi{constructor(e,n={}){super(e,n),this.vertexShader="Mesh.vert",this.fragmentShader="Mesh.frag",this.addAttributes({normal:{type:"v3",value:e.normal}}),e.normal===void 0&&this.geometry.computeVertexNormals()}}class sb extends mr{constructor(){super(...arguments),this.isSurface=!0}}function Ql(t){t.visible=!0}function Q0(t){t.visible=!1}class ob{constructor(e){this.group=new Ot,this.wireframeGroup=new Ot,this.pickingGroup=new Ot,this.frontMeshes=[],this.backMeshes=[],this.size=e.size,this.side=e.parameters.side,this.visible=e.visible,this.geometry=e.geometry,this.picking=e.picking,this.group=new Ot,this.wireframeGroup=new Ot,this.pickingGroup=new Ot,this.matrix=e.matrix;const n=e,i=new e.constructor({position:new Float32Array(0)});n.makeMaterial(),i.makeMaterial(),i.picking=e.picking,i.geometry=e.geometry,i.wireframeGeometry=e.wireframeGeometry,i.setParameters(e.getParameters()),i.updateShader(),n.setParameters({side:"front"}),i.setParameters({side:"back",opacity:i.parameters.opacity}),this.buffer=e,this.frontBuffer=n,this.backBuffer=i}set matrix(e){Wi.prototype.setMatrix.call(this,e)}get matrix(){return this.group.matrix.clone()}get pickable(){return!!this.picking&&!this.parameters.disablePicking}get parameters(){return this.buffer.parameters}getParameters(){const e=Object.assign({},this.buffer.parameters);return e.side=this.side,e}getMesh(e){let n,i;return e?(i=this.backBuffer.getPickingMesh(),n=this.frontBuffer.getPickingMesh()):(i=this.backBuffer.getMesh(),n=this.frontBuffer.getMesh()),this.frontMeshes.push(n),this.backMeshes.push(i),this.setParameters({side:this.side}),new Ot().add(i,n)}getWireframeMesh(){return this.buffer.getWireframeMesh()}getPickingMesh(){return this.getMesh(!0)}setAttributes(e){this.buffer.setAttributes(e)}setParameters(e){(e=Object.assign({},e)).side==="front"?(this.frontMeshes.forEach(Ql),this.backMeshes.forEach(Q0)):e.side==="back"?(this.frontMeshes.forEach(Q0),this.backMeshes.forEach(Ql)):e.side==="double"&&(this.frontMeshes.forEach(Ql),this.backMeshes.forEach(Ql)),e.side!==void 0&&(this.side=e.side),delete e.side,e.matrix!==void 0&&(this.matrix=e.matrix),delete e.matrix,this.frontBuffer.setParameters(e),e.wireframe!==void 0&&(this.wireframe=e.wireframe,this.setVisibility(this.visible)),delete e.wireframe,this.backBuffer.setParameters(e)}setVisibility(e){this.visible=e,this.parameters.wireframe?(this.group.visible=!1,this.wireframeGroup.visible=e,this.pickable&&(this.pickingGroup.visible=!1)):(this.group.visible=e,this.wireframeGroup.visible=!1,this.pickable&&(this.pickingGroup.visible=e))}dispose(){this.frontBuffer.dispose(),this.backBuffer.dispose()}toJSON(){var e={};for(var n in this)["side","size","visible","matrix","parameters"].includes(n)&&(e[n]=this[n]);return e}}At.add("shader/Line.vert",`uniform float clipNear;
uniform vec3 clipCenter;
varying vec3 vViewPosition;
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#include color_pars_vertex
void main(){
#include color_vertex
#include begin_vertex
#include project_vertex
vViewPosition = -mvPosition.xyz;
#if defined( RADIUS_CLIP )
vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;
#endif
#include nearclip_vertex
}`),At.add("shader/Line.frag",`uniform float opacity;
uniform float clipNear;
uniform float clipRadius;
varying vec3 vViewPosition;
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#include common
#include color_pars_fragment
#include fog_pars_fragment
void main(){
#include nearclip_fragment
#include radiusclip_fragment
gl_FragColor = vec4( vColor, opacity );
#include premultiplied_alpha_fragment
#include tonemapping_fragment
#include encodings_fragment
#include fog_fragment
}`);class ab extends Wi{constructor(){super(...arguments),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag"}}class Op extends tl{constructor(e,n,i){super(e,n,i),this.type="surface",this.parameters=Object.assign({isolevelType:{type:"select",options:{value:"value",sigma:"sigma"}},isolevel:{type:"number",precision:2,max:1e3,min:-1e3},negateIsolevel:{type:"boolean"},isolevelScroll:{type:"boolean"},smooth:{type:"integer",precision:1,max:10,min:0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},boxSize:{type:"integer",precision:1,max:100,min:0},colorVolume:{type:"hidden"},contour:{type:"boolean",rebuild:!0},useWorker:{type:"boolean",rebuild:!0},wrap:{type:"boolean",rebuild:!0}},this.parameters),e instanceof Nn?(this.surface=void 0,this.volume=e):(this.surface=e,this.volume=void 0),this.boxCenter=new T,this.__boxCenter=new T,this.box=new Ut,this.__box=new Ut,this._position=new T,this.inverseMatrix=new Ie,this.setBox=function(){this._position.copy(n.translationGroup.position).negate(),this._position.applyMatrix4(this.inverseMatrix),this._position.equals(this.boxCenter)||this.setParameters({boxCenter:this._position})},this.toBePrepared=!0,this.viewer.signals.ticked.add(this.setBox,this),this.init(i)}init(e){const n=e||{};n.colorScheme=I(n.colorScheme,"uniform"),n.colorValue=I(n.colorValue,14540253),this.isolevelType=I(n.isolevelType,"sigma"),this.isolevel=I(n.isolevel,2),this.negateIsolevel=I(n.negateIsolevel,!1),this.isolevelScroll=I(n.isolevelScroll,!1),this.smooth=I(n.smooth,0),this.background=I(n.background,!1),this.opaqueBack=I(n.opaqueBack,!0),this.boxSize=I(n.boxSize,0),this.colorVolume=I(n.colorVolume,void 0),this.contour=I(n.contour,!1),this.useWorker=I(n.useWorker,!0),this.wrap=I(n.wrap,!1),super.init(n),this.inverseMatrix.getInverse(this.matrix),this.build()}attach(e){this.bufferList.forEach(n=>{this.viewer.add(n)}),this.setVisibility(this.visible),e()}prepare(e){if(this.volume){let n;if(n=this.isolevelType==="sigma"?this.volume.getValueForSigma(this.isolevel):this.isolevel,this.negateIsolevel&&(n*=-1),!this.surface||this.__isolevel!==n||this.__smooth!==this.smooth||this.__contour!==this.contour||this.__wrap!==this.wrap||this.__boxSize!==this.boxSize||this.boxSize>0&&!this.__boxCenter.equals(this.boxCenter)){this.__isolevel=n,this.__smooth=this.smooth,this.__contour=this.contour,this.__wrap=this.wrap,this.__boxSize=this.boxSize,this.__boxCenter.copy(this.boxCenter),this.__box.copy(this.box);const i=r=>{this.surface=r,e()};this.useWorker?this.volume.getSurfaceWorker(n,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap,i):i(this.volume.getSurface(n,this.smooth,this.boxCenter,this.boxSize,this.contour,this.wrap))}else e()}else e()}create(){const e={position:this.surface.getPosition(),color:this.surface.getColor(this.getColorParams()),index:this.surface.getIndex()};let n;if(this.contour)n=new ab(e,this.getBufferParams({wireframe:!1}));else{Object.assign(e,{normal:this.surface.getNormal(),picking:this.surface.getPicking()});const i=new sb(e,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1}));n=new ob(i)}this.bufferList.push(n)}update(e){if(this.bufferList.length===0)return;const n={};(e=e||{}).position&&(n.position=this.surface.getPosition()),e.color&&(n.color=this.surface.getColor(this.getColorParams())),e.index&&(n.index=this.surface.getIndex()),e.normal&&(n.normal=this.surface.getNormal()),this.bufferList.forEach(function(i){i.setAttributes(n)})}setParameters(e,n,i){return e&&e.isolevelType!==void 0&&this.volume&&(this.isolevelType==="value"&&e.isolevelType==="sigma"?this.isolevel=this.volume.getSigmaForValue(this.isolevel):this.isolevelType==="sigma"&&e.isolevelType==="value"&&(this.isolevel=this.volume.getValueForSigma(this.isolevel)),this.isolevelType=e.isolevelType),e&&e.boxCenter&&(this.boxCenter.copy(e.boxCenter),delete e.boxCenter),e&&e.wireframe&&(e.contour||e.contour===void 0&&this.contour)&&(e.wireframe=!1),super.setParameters(e,n,i),e.matrix&&this.inverseMatrix.getInverse(e.matrix),this.volume&&this.volume.getBox(this.boxCenter,this.boxSize,this.box),e&&e.colorVolume!==void 0&&n&&(n.color=!0),this.surface&&(e.isolevel!==void 0||e.negateIsolevel!==void 0||e.smooth!==void 0||e.wrap!==void 0||e.boxSize!==void 0||this.boxSize>0&&!this.__box.equals(this.box))&&this.build({position:!0,color:!0,index:!0,normal:!this.contour}),this}getColorParams(){const e=super.getColorParams();return e.volume=this.colorVolume,e}dispose(){this.viewer.signals.ticked.remove(this.setBox,this),super.dispose()}}class vt{static zoomScroll(e,n){e.trackballControls.zoom(n)}static clipNearScroll(e,n){const i=e.getParameters();e.setParameters({clipNear:i.clipNear+n/10})}static focusScroll(e,n){const i=e.getFocus(),r=Math.sign(n)*function(s,o,a){if(s>o)return s;const c=s/o;return((2*a-o)*c+(2*o-3*a))*c*c+a}((100-i)/10,5,.2);e.setFocus(i+r)}static zoomFocusScroll(e,n){e.trackballControls.zoom(n);const i=e.viewer.camera.position.z;e.setFocus(100-Math.abs(i/8))}static isolevelScroll(e,n){const i=Math.sign(n)/10;e.eachRepresentation((r,s)=>{if(r.repr instanceof Op){const o=r.getParameters();o.isolevelScroll&&r.setParameters({isolevel:o.isolevel+i})}})}static panDrag(e,n,i){e.trackballControls.pan(n,i)}static rotateDrag(e,n,i){e.trackballControls.rotate(n,i)}static zRotateDrag(e,n,i){e.trackballControls.zRotate(n,i)}static zoomDrag(e,n,i){e.trackballControls.zoom((n+i)/-2)}static zoomFocusDrag(e,n,i){e.trackballControls.zoom((n+i)/-2);const r=e.viewer.camera.position.z;e.setFocus(100-Math.abs(r/8))}static panComponentDrag(e,n,i){e.trackballControls.panComponent(n,i)}static panAtomDrag(e,n,i){e.trackballControls.panAtom(n,i)}static rotateComponentDrag(e,n,i){e.trackballControls.rotateComponent(n,i)}static movePick(e,n){n&&e.animationControls.move(n.position.clone())}static tooltipPick(e,n){const i=e.tooltip;if(e.getParameters().tooltip&&n){const r=n.mouse.position;i.innerText=n.getLabel(),i.style.bottom=window.innerHeight-r.y+3+"px",i.style.left=r.x+3+"px",i.style.display="block"}else i.style.display="none"}static measurePick(e,n){if(n&&(n.atom||n.bond)){const i=n.atom||n.closestBondAtom;n.component.measurePick(i)}else e.measureClear()}}const cb={default:[["scroll",vt.zoomScroll],["scroll-shift",vt.focusScroll],["scroll-ctrl",vt.isolevelScroll],["scroll-shift-ctrl",vt.zoomFocusScroll],["drag-left",vt.rotateDrag],["drag-right",vt.panDrag],["drag-ctrl-left",vt.panDrag],["drag-ctrl-right",vt.zRotateDrag],["drag-shift-left",vt.zoomDrag],["drag-middle",vt.zoomFocusDrag],["drag-ctrl-shift-right",vt.panComponentDrag],["drag-ctrl-shift-left",vt.rotateComponentDrag],["clickPick-right",vt.measurePick],["clickPick-ctrl-left",vt.measurePick],["clickPick-middle",vt.movePick],["clickPick-left",vt.movePick],["hoverPick",vt.tooltipPick]],pymol:[["drag-left",vt.rotateDrag],["drag-middle",vt.panDrag],["drag-right",vt.zoomDrag],["scroll",vt.focusScroll],["drag-shift-right",vt.focusScroll],["clickPick-ctrl+shift-middle",vt.movePick],["hoverPick",vt.tooltipPick]],coot:[["scroll",vt.isolevelScroll],["drag-left",vt.rotateDrag],["drag-middle",vt.panDrag],["drag-ctrl-left",vt.panDrag],["drag-right",vt.zoomFocusDrag],["drag-ctrl-right",vt.focusScroll],["clickPick-middle",vt.movePick],["hoverPick",vt.tooltipPick]],astexviewer:[["drag-left",vt.rotateDrag],["drag-ctrl-left",vt.panDrag],["drag-shift-left",vt.zoomDrag],["scroll",vt.focusScroll],["clickPick-middle",vt.movePick],["hoverPick",vt.tooltipPick]]};function e1(t){const e=t.split(/[-+]/);let n="";e.includes("scroll")&&(n="scroll"),e.includes("drag")&&(n="drag"),e.includes("click")&&(n="click"),e.includes("doubleClick")&&(n="doubleClick"),e.includes("hover")&&(n="hover"),e.includes("clickPick")&&(n="clickPick"),e.includes("hoverPick")&&(n="hoverPick");let i=0;e.includes("alt")&&(i+=1),e.includes("ctrl")&&(i+=2),e.includes("meta")&&(i+=4),e.includes("shift")&&(i+=8);let r=0;return e.includes("left")&&(r+=1),e.includes("right")&&(r+=2),e.includes("middle")&&(r+=4),[n,i,r]}class FC{constructor(e,n={}){this.stage=e,this.actionList=[],this.mouse=e.mouseObserver,this.disabled=n.disabled||!1,this.preset(n.preset||"default")}run(e,...n){if(this.disabled)return;const i=this.mouse.key||0,r=this.mouse.buttons||0;this.actionList.forEach(s=>{s.type===e&&s.key===i&&s.button===r&&s.callback(this.stage,...n)})}add(e,n){const[i,r,s]=e1(e);this.actionList.push({type:i,key:r,button:s,callback:n})}remove(e,n){const i=e.includes("*"),[r,s,o]=e1(e),a=this.actionList.filter(function(c){return!((c.type===r||i&&r==="")&&(c.key===s||i&&s===0)&&(c.button===o||i&&o===0)&&(c.callback===n||n===void 0))});this.actionList=a}preset(e){this.clear(),(cb[e]||[]).forEach(n=>this.add(n[0],n[1]))}clear(){this.actionList.length=0}}class Ba{static autoView(e){e.autoView(1e3)}static toggleAnimations(e){e.animationControls.toggle()}static toggleRock(e){e.toggleRock()}static toggleSpin(e){e.toggleSpin()}static toggleAntialiasing(e){const n=e.getParameters();e.setParameters({sampleLevel:n.sampleLevel===-1?0:-1})}}const NC={default:[["i",Ba.toggleSpin],["k",Ba.toggleRock],["p",Ba.toggleAnimations],["a",Ba.toggleAntialiasing],["r",Ba.autoView]]};class zC{constructor(e,n={}){this.stage=e,this.actionList=[],this.disabled=n.disabled||!1,this.preset(n.preset||"default")}run(e){this.disabled||this.actionList.forEach(n=>{n.key===e&&n.callback(this.stage)})}add(e,n){this.actionList.push({key:e,callback:n})}remove(e,n){const i=this.actionList.filter(function(r){return!(r.key===e&&(r.callback===n||n===void 0))});this.actionList=i}preset(e){this.clear(),(NC[e]||[]).forEach(n=>this.add(n[0],n[1]))}clear(){this.actionList.length=0}}class GC{constructor(e){this.stage=e,this.stage=e,this.mouse=e.mouseObserver,this.controls=e.mouseControls,this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this)}_onClick(e,n){const i=this.stage.pickingControls.pick(e,n);this.stage.signals.clicked.dispatch(i),this.controls.run("clickPick",i)}_onHover(e,n){const i=this.stage.pickingControls.pick(e,n);i&&this.mouse.down.equals(this.mouse.position)&&(this.stage.transformComponent=i.component,this.stage.transformAtom=i.atom),this.stage.signals.hovered.dispatch(i),this.controls.run("hoverPick",i)}dispose(){this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)}}class UC{constructor(e){this.stage=e,this.stage=e,this.mouse=e.mouseObserver,this.controls=e.mouseControls,this.mouse.signals.moved.add(this._onMove,this),this.mouse.signals.scrolled.add(this._onScroll,this),this.mouse.signals.dragged.add(this._onDrag,this),this.mouse.signals.clicked.add(this._onClick,this),this.mouse.signals.hovered.add(this._onHover,this),this.mouse.signals.doubleClicked.add(this._onDblclick,this)}_onMove(){this.stage.tooltip.style.display="none"}_onScroll(e){this.controls.run("scroll",e)}_onDrag(e,n){this.controls.run("drag",e,n)}_onClick(e,n){this.controls.run("click",e,n)}_onDblclick(e,n){this.controls.run("doubleClick",e,n)}_onHover(e,n){this.controls.run("hover",e,n)}dispose(){this.mouse.signals.moved.remove(this._onMove,this),this.mouse.signals.scrolled.remove(this._onScroll,this),this.mouse.signals.dragged.remove(this._onDrag,this),this.mouse.signals.clicked.remove(this._onClick,this),this.mouse.signals.hovered.remove(this._onHover,this)}}class VC{constructor(e){this.stage=e,this.viewer=e.viewer,this.animationControls=e.animationControls,this.viewer.signals.ticked.add(this._onTick,this)}_onTick(e){this.animationControls.run(e)}dispose(){this.viewer.signals.ticked.remove(this._onTick,this)}}const t1=!!Ix&&{passive:!0};class HC{constructor(e){this.stage=e,this.stage=e,this.controls=e.keyControls,this.domElement=e.viewer.renderer.domElement,this.domElement.setAttribute("tabIndex","-1"),this.domElement.style.outline="none",this._focusDomElement=this._focusDomElement.bind(this),this._onKeydown=this._onKeydown.bind(this),this._onKeyup=this._onKeyup.bind(this),this._onKeypress=this._onKeypress.bind(this),this.domElement.addEventListener("mousedown",this._focusDomElement),this.domElement.addEventListener("touchstart",this._focusDomElement,t1),this.domElement.addEventListener("keydown",this._onKeydown),this.domElement.addEventListener("keyup",this._onKeyup),this.domElement.addEventListener("keypress",this._onKeypress)}_onKeydown(){}_onKeyup(){}_onKeypress(e){let n;n="key"in KeyboardEvent.prototype?e.key:String.fromCharCode(e.which||e.keyCode),this.controls.run(n)}_focusDomElement(){this.domElement.focus()}dispose(){this.domElement.removeEventListener("mousedown",this._focusDomElement),this.domElement.removeEventListener("touchstart",this._focusDomElement,t1),this.domElement.removeEventListener("keydown",this._onKeypress),this.domElement.removeEventListener("keyup",this._onKeypress),this.domElement.removeEventListener("keypress",this._onKeypress)}}class $C{constructor(e,n,i,r={}){this.component=e,this.position=n,this.offsetX=I(r.offsetX,0),this.offsetY=I(r.offsetY,0),this.visible=I(r.visible,!0),this.stage=e.stage,this.viewer=e.stage.viewer,this._viewerPosition=new T,this._updateViewerPosition(),this._canvasPosition=new Te,this._cameraPosition=new T,this.element=document.createElement("div"),Object.assign(this.element.style,{display:"block",position:"absolute",pointerEvents:"none",whiteSpace:"nowrap",left:"-10000px"}),this.viewer.wrapper.appendChild(this.element),this.setContent(i),this.updateVisibility(),this.viewer.signals.rendered.add(this._update,this),this.component.signals.matrixChanged.add(this._updateViewerPosition,this)}setContent(e){const n=this.element.style.display;if(n==="none"&&(this.element.style.left="-10000px",this.element.style.display="block"),e instanceof HTMLElement)this.element.appendChild(e);else{const i=document.createElement("div");i.innerText=e,Object.assign(i.style,{backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif"}),this.element.appendChild(i)}this._clientRect=this.element.getBoundingClientRect(),n==="none"&&(this.element.style.display=n)}setVisibility(e){this.visible=e,this.updateVisibility()}getVisibility(){return this.visible&&this.component.parameters.visible}updateVisibility(){this.element.style.display=this.getVisibility()?"block":"none"}_updateViewerPosition(){this._viewerPosition.copy(this.position).applyMatrix4(this.component.matrix)}_update(){if(!this.getVisibility())return;const e=this.element.style,n=this._canvasPosition,i=this._viewerPosition,r=this._clientRect;if(this._cameraPosition.copy(i).add(this.viewer.translationGroup.position).applyMatrix4(this.viewer.rotationGroup.matrix).sub(this.viewer.camera.position),this._cameraPosition.z<0)return void(e.display="none");e.display="block";const s=this._cameraPosition.length(),o=this.viewer.scene.fog;e.opacity=(1-Jc(o.near,o.far,s)).toString(),e.zIndex=Math.round(100*(o.far-s)).toString(),this.stage.viewerControls.getPositionOnCanvas(i,n),e.bottom=this.offsetX+n.y+r.height/2+"px",e.left=this.offsetY+n.x-r.width/2+"px"}dispose(){this.viewer.wrapper.removeChild(this.element),this.viewer.signals.ticked.remove(this._update,this),this.component.signals.matrixChanged.remove(this._updateViewerPosition,this)}}const Qi=new Ie,eh=new T,n1=new Gt;class WC{constructor(e){this.component=e,this.signals={changed:new ot.Signal},this.stage=e.stage,this.viewer=e.stage.viewer}get position(){return this.component.position}get rotation(){return this.component.quaternion}changed(){this.component.updateMatrix(),this.viewer.requestRender(),this.signals.changed.dispatch()}spin(e,n){Qi.getInverse(this.viewer.rotationGroup.matrix),eh.copy(ps(e)).applyMatrix4(Qi),Qi.extractRotation(this.component.transform),Qi.premultiply(this.viewer.rotationGroup.matrix),Qi.getInverse(Qi),eh.copy(ps(e)),eh.applyMatrix4(Qi),Qi.makeRotationAxis(eh,n),n1.setFromRotationMatrix(Qi),this.component.quaternion.premultiply(n1),this.changed()}}const lb={"":"",vdw:"by vdW radius",covalent:"by covalent radius",sstruc:"by secondary structure",bfactor:"by bfactor",size:"size",data:"data",explicit:"explicit"};class gr{constructor(e={}){this.max=10,this.type=I(e.type,"size"),this.scale=I(e.scale,1),this.size=I(e.size,1),this.data=I(e.data,{})}atomRadius(e){let n;switch(this.type){case"vdw":n=e.vdw;break;case"covalent":n=e.covalent;break;case"bfactor":n=e.bfactor||1;break;case"sstruc":const i=e.sstruc;n=i==="h"||i==="g"||i==="i"||i==="e"||i==="b"?.25:Zx.includes(e.atomname)?.4:.1;break;case"data":n=I(this.data[e.index],1);break;case"explicit":n=e.radius,n===null&&(n=this.size);break;default:n=this.size}return Math.min(n*this.scale,this.max)}}gr.types=lb;const jC=new T(-1,-1,-1),qC=new Ie;class hb{constructor(e){const n=e.rows,i=n/3,r=new Pt(n,3),s=new Pt(3,3),o=new Pt(1,3),a=new Pt(3,3),c=new Pt(3,3),l=Ip(e);Lp(e,l),bi(r,e),wh(s,r,r),nb(s,o,a,c);const h=new T(l[0],l[1],l[2]),u=new T(a.data[0],a.data[3],a.data[6]),f=new T(a.data[1],a.data[4],a.data[7]),d=new T(a.data[2],a.data[5],a.data[8]),p=u.clone().multiplyScalar(Math.sqrt(o.data[0]/i)),y=f.clone().multiplyScalar(Math.sqrt(o.data[1]/i)),g=d.clone().multiplyScalar(Math.sqrt(o.data[2]/i));this.begA=h.clone().sub(p),this.endA=h.clone().add(p),this.begB=h.clone().sub(y),this.endB=h.clone().add(y),this.begC=h.clone().sub(g),this.endC=h.clone().add(g),this.center=h,this.vecA=p,this.vecB=y,this.vecC=g,this.normVecA=u,this.normVecB=f,this.normVecC=d}getBasisMatrix(e=new Ie){const n=e;return n.makeBasis(this.normVecB,this.normVecA,this.normVecC),n.determinant()<0&&n.scale(jC),n}getRotationQuaternion(e=new Gt){const n=e;return n.setFromRotationMatrix(this.getBasisMatrix(qC)),n.inverse()}getProjectedScaleForAtoms(e){let n=-1/0,i=-1/0,r=-1/0,s=-1/0,o=-1/0,a=-1/0;const c=new T,l=new T,h=this.center,u=this.normVecA,f=this.normVecB,d=this.normVecC;return e.eachAtom(function(p){ms(c.copy(p),u,h);const y=l.subVectors(c,h).normalize().dot(u),g=c.distanceTo(h);y>0?g>n&&(n=g):g>i&&(i=g),ms(c.copy(p),f,h);const m=l.subVectors(c,h).normalize().dot(f),x=c.distanceTo(h);m>0?x>r&&(r=x):x>s&&(s=x),ms(c.copy(p),d,h);const v=l.subVectors(c,h).normalize().dot(d),b=c.distanceTo(h);v>0?b>o&&(o=b):b>a&&(a=b)}),{d1a:n,d2a:r,d3a:o,d1b:-i,d2b:-s,d3b:-a}}}class nr{constructor(e,n,i,r){this.volume=e,this.setFilter(n,i,r)}get header(){return this.volume.header}get matrix(){return this.volume.matrix}get normalMatrix(){return this.volume.normalMatrix}get inverseMatrix(){return this.volume.inverseMatrix}get center(){return this.volume.center}get boundingBox(){return this.volume.boundingBox}get min(){return this.volume.min}get max(){return this.volume.max}get mean(){return this.volume.mean}get rms(){return this.volume.rms}_getFilterHash(e,n,i){return JSON.stringify([e,n,i])}setFilter(e,n,i){isNaN(e)&&this.header&&(e=this.header.DMEAN+2*this.header.ARMS),e=e===void 0||isNaN(e)?-1/0:e,n=I(n,1/0),i=I(i,!1);const r=this.volume.data,s=this.volume.position,o=this.volume.atomindex,a=this._getFilterHash(e,n,i);if(a!==this._filterHash){if(e===-1/0&&n===1/0)this.data=r,this.position=s,this.atomindex=o;else{const c=r.length;this._dataBuffer||(this._dataBuffer=new ArrayBuffer(4*c),this._positionBuffer=new ArrayBuffer(3*c*4),o&&(this._atomindexBuffer=new ArrayBuffer(4*c)));const l=new Float32Array(this._dataBuffer),h=new Float32Array(this._positionBuffer);let u;o&&(u=new Uint32Array(this._atomindexBuffer));let f=0;for(let d=0;d<c;++d){const p=3*d,y=r[d];if(!i&&y>=e&&y<=n||i&&(y<e||y>n)){const g=3*f;l[f]=y,h[g+0]=s[p+0],h[g+1]=s[p+1],h[g+2]=s[p+2],o&&u&&(u[f]=o[d]),f+=1}}this.data=new Float32Array(this._dataBuffer,0,f),this.position=new Float32Array(this._positionBuffer,0,3*f),o&&(this.atomindex=new Int32Array(this._atomindexBuffer,0,f))}this._filterHash=a}}}nr.prototype.getValueForSigma=Nn.prototype.getValueForSigma,nr.prototype.getSigmaForValue=Nn.prototype.getSigmaForValue,nr.prototype.getDataAtomindex=Nn.prototype.getDataAtomindex,nr.prototype.getDataPosition=Nn.prototype.getDataPosition,nr.prototype.getDataColor=Nn.prototype.getDataColor,nr.prototype.getDataPicking=Nn.prototype.getDataPicking,nr.prototype.getDataSize=Nn.prototype.getDataSize;class XC{constructor(e,n){const i=Vx({nodeArray1:e.atomIndex1,nodeArray2:e.atomIndex2,edgeCount:e.count,nodeCount:n});this.countArray=i.countArray,this.offsetArray=i.offsetArray,this.indexArray=i.indexArray}}class Mh extends ta{get _defaultFields(){return[["atomIndex1",1,"int32"],["atomIndex2",1,"int32"],["bondOrder",1,"int8"]]}addBond(e,n,i){this.growIfFull();const r=this.count,s=e.index,o=n.index;s<o?(this.atomIndex1[r]=s,this.atomIndex2[r]=o):(this.atomIndex2[r]=s,this.atomIndex1[r]=o),i&&(this.bondOrder[r]=i),this.count+=1}addBondIfConnected(e,n,i){return!!e.connectedTo(n)&&(this.addBond(e,n,i),!0)}}class YC extends ta{get _defaultFields(){return[["residueIndex",1,"uint32"],["atomTypeId",1,"uint16"],["x",1,"float32"],["y",1,"float32"],["z",1,"float32"],["serial",1,"int32"],["bfactor",1,"float32"],["altloc",1,"uint8"],["occupancy",1,"float32"]]}setAltloc(e,n){this.altloc[e]=n.charCodeAt(0)}getAltloc(e){const n=this.altloc[e];return n?String.fromCharCode(n):""}}class ZC extends ta{get _defaultFields(){return[["chainIndex",1,"uint32"],["atomOffset",1,"uint32"],["atomCount",1,"uint32"],["residueTypeId",1,"uint16"],["resno",1,"int32"],["sstruc",1,"uint8"],["inscode",1,"uint8"]]}setSstruc(e,n){this.sstruc[e]=n.charCodeAt(0)}getSstruc(e){const n=this.sstruc[e];return n?String.fromCharCode(n):""}setInscode(e,n){this.inscode[e]=n.charCodeAt(0)}getInscode(e){const n=this.inscode[e];return n?String.fromCharCode(n):""}}class KC extends ta{get _defaultFields(){return[["entityIndex",1,"uint16"],["modelIndex",1,"uint16"],["residueOffset",1,"uint32"],["residueCount",1,"uint32"],["chainname",4,"uint8"],["chainid",4,"uint8"]]}setChainname(e,n){const i=4*e;this.chainname[i]=n.charCodeAt(0),this.chainname[i+1]=n.charCodeAt(1),this.chainname[i+2]=n.charCodeAt(2),this.chainname[i+3]=n.charCodeAt(3)}getChainname(e){let n="";for(let i=0;i<4;++i){const r=this.chainname[4*e+i];if(!r)break;n+=String.fromCharCode(r)}return n}setChainid(e,n){const i=4*e;this.chainid[i]=n.charCodeAt(0),this.chainid[i+1]=n.charCodeAt(1),this.chainid[i+2]=n.charCodeAt(2),this.chainid[i+3]=n.charCodeAt(3)}getChainid(e){let n="";for(let i=0;i<4;++i){const r=this.chainid[4*e+i];if(!r)break;n+=String.fromCharCode(r)}return n}}class JC extends ta{get _defaultFields(){return[["chainOffset",1,"uint32"],["chainCount",1,"uint32"]]}}class gu{constructor(e){this.polymer=e,this.size=e.residueCount}getCenterIterator(e=0){const n=this.getPosition().center,i=n.length/3;let r=0,s=-1;const o=[new T,new T,new T,new T];return{size:i,next:function(){const a=this.get(s);return s+=1,a},get:function(a){a=Math.min(i-1,Math.max(0,a));const c=o[r%4],l=3*a;if(c.fromArray(n,l),e){const h=Math.min(e,a,i-a-1);for(let u=1;u<=h;++u){const f=3*u,d=(h+1-u)/(h+1);c.x+=d*n[l-f+0]+d*n[l+f+0],c.y+=d*n[l-f+1]+d*n[l+f+1],c.z+=d*n[l-f+2]+d*n[l+f+2]}c.x/=h+1,c.y/=h+1,c.z/=h+1}return r+=1,c},reset:function(){r=0,s=-1}}}getColor(e){const n=this.polymer,i=n.structure,r=n.residueCount,s=n.residueIndexStart,o=new Float32Array(3*r),a=e||{};a.structure=i;const c=mt.getScheme(a),l=i.getResidueProxy(),h=i.getAtomProxy();for(let u=0;u<r;++u)l.index=s+u,h.index=l.traceAtomIndex,c.atomColorToArray(h,o,3*u);return{color:o}}getPicking(){const e=this.polymer,n=e.structure,i=e.residueCount,r=e.residueIndexStart,s=new Float32Array(i),o=n.getResidueProxy();for(let a=0;a<i;++a)o.index=r+a,s[a]=o.traceAtomIndex;return{picking:new Rs(s,n)}}getSize(e){const n=this.polymer,i=n.structure,r=n.residueCount,s=n.residueIndexStart,o=new Float32Array(r),a=new gr(e),c=i.getResidueProxy(),l=i.getAtomProxy();for(let h=0;h<r;++h)c.index=s+h,l.index=c.traceAtomIndex,o[h]=a.atomRadius(l);return{size:o}}getPosition(){const e=this.polymer,n=e.structure,i=e.residueCount,r=i-3,s=new Float32Array(3*i),o=new Float32Array(3*i),a=new Float32Array(i),c=new Float32Array(i),l=new Float32Array(i),h=new Float32Array(i),u=new Float32Array(3*i),f=new T,d=new T,p=new T,y=new T,g=new T,m=new T,x=new T,v=new T,b=new T,_=new T,C=new T,w=new T(0,0,0),S="trace",M=n.getAtomProxy(),B=n.getAtomProxy(e.getAtomIndexByType(0,S)),L=n.getAtomProxy(e.getAtomIndexByType(1,S)),U=n.getAtomProxy(e.getAtomIndexByType(2,S));for(let F=0;F<r;++F){M.index=B.index,B.index=L.index,L.index=U.index,U.index=e.getAtomIndexByType(F+3,S);const te=3*F;f.subVectors(B,M),d.subVectors(L,B),p.subVectors(U,L),y.subVectors(f,d),g.subVectors(d,p),b.crossVectors(y,g).normalize(),b.toArray(o,te),F>0&&(a[F]=b.angleTo(_));const ee=Math.cos(y.angleTo(g));h[F]=180/Math.PI*Math.acos(ee);const j=y.length(),Z=g.length();c[F]=Math.sqrt(Z*j)/Math.max(2,2*(1-ee)),l[F]=Math.abs(d.dot(b)),m.copy(y).multiplyScalar(c[F]/j),x.copy(g).multiplyScalar(c[F]/Z),m.subVectors(B,m),x.subVectors(L,x),m.toArray(s,te+3),x.toArray(s,te+6),C.subVectors(M,w),C.toArray(u,te),_.copy(b),w.copy(m)}m.fromArray(s,3),x.fromArray(s,6),b.subVectors(m,x).normalize(),M.index=e.getAtomIndexByType(0,S),w.copy(M),v.copy(M),ms(v,b,m),v.toArray(s,0),C.subVectors(w,m),C.toArray(u,0),m.fromArray(s,3*i-6),x.fromArray(s,3*i-9),b.subVectors(m,x).normalize(),M.index=e.getAtomIndexByType(i-1,S),w.copy(M),v.copy(M),ms(v,b,m),v.toArray(s,3*i-3);for(let F=i-3;F<i;++F)m.fromArray(s,3*F),M.index=e.getAtomIndexByType(F,S),w.copy(M),C.subVectors(w,m),C.toArray(u,3*F);const E=new Float32Array(i),O=new Float32Array(i),k=new Float32Array(i),ne=new Float32Array(i);E[1]=c[0],O[1]=h[0],k[1]=c[0];for(let F=2;F<i-2;++F)E[F]=.5*(c[F-2]+c[F-1]),O[F]=.5*(h[F-2]+h[F-1]),k[F]=.5*(l[F-2]+l[F-1]),m.fromArray(o,3*(F-2)),x.fromArray(o,3*(F-1)),ne[F]=180/Math.PI*Math.acos(Math.cos(m.angleTo(x)));E[i-2]=c[i-4],O[i-2]=h[i-4],k[i-2]=l[i-4];const Y=new Float32Array(3*i);mn(o,Y,0,0,3),mn(o,Y,0,3,3);for(let F=2;F<i-2;++F)m.fromArray(o,3*(F-2)),x.fromArray(o,3*(F-1)),b.addVectors(x,m).multiplyScalar(.5).normalize(),b.toArray(Y,3*F);return mn(o,Y,3*i-12,3*i-6,3),mn(o,Y,3*i-12,3*i-3,3),{center:s,axis:Y,bending:ne,radius:E,rise:k,twist:O,resdir:u}}}class ub{constructor(e){this.polymer=e,this.helixorient=new gu(e),this.position=this.helixorient.getPosition()}getAxis(e,n,i,r,s){e=e||30,n=n||2.5,i=i!==void 0&&i;const o=this.polymer,a=o.structure,c=o.residueCount,l=o.residueIndexStart,h=this.position,u=r||{};u.structure=a;const f=mt.getScheme(u),d=new gr(s);let p=0,y=0;const g=[],m=[],x=[],v=[],b=[],_=[],C=[],w=[],S=[];let M,B,L=new Float32Array(3*c),U=new Float32Array(3*c);const E=new T,O=new T,k=a.getResidueProxy(),ne=a.getResidueProxy(),Y=a.getAtomProxy(),F=new T,te=new T;let ee=!1;for(let Z=0;Z<c;++Z)if(k.index=l+Z,F.fromArray(h.center,3*Z),Z===c-1?ee=!0:(ne.index=l+Z+1,te.fromArray(h.center,3*Z+3),(i&&k.sstruc!==ne.sstruc||F.distanceTo(te)>n||h.bending[Z]>e)&&(ee=!0)),ee){if(Z-p<4){p=Z,ee=!1;continue}Y.index=k.traceAtomIndex,L=h.axis.subarray(3*p+3,3*Z),U=h.center.subarray(3*p,3*Z+3),M=Tp(L).normalize(),B=Tp(U),E.fromArray(U),ms(E,M,B),O.fromArray(U,U.length-3),ms(O,M,B),M.subVectors(O,E),M.toArray(g,y),B.toArray(m,y),E.toArray(x,y),O.toArray(v,y),f.atomColorToArray(Y,b,y),_.push(Y.index),C.push(d.atomRadius(Y)),w.push(l+p),S.push(l+Z+1-p),y+=3,p=Z,ee=!1}const j=new Float32Array(_);return{axis:new Float32Array(g),center:new Float32Array(m),begin:new Float32Array(x),end:new Float32Array(v),color:new Float32Array(b),picking:new Rs(j,a),size:new Float32Array(C),residueOffset:w,residueCount:S}}}class QC{constructor(e){this.scoreFunction=e,this.content=[],this.scoreFunction=e}push(e){this.content.push(e),this.bubbleUp(this.content.length-1)}pop(){const e=this.content[0],n=this.content.pop();return n&&this.content.length>0&&(this.content[0]=n,this.sinkDown(0)),e}peek(){return this.content[0]}remove(e){const n=this.content.length;for(let i=0;i<n;i++)if(this.content[i]===e){const r=this.content.pop();return void(r&&i!==n-1&&(this.content[i]=r,this.scoreFunction(r)<this.scoreFunction(e)?this.bubbleUp(i):this.sinkDown(i)))}throw new Error("Node not found.")}size(){return this.content.length}bubbleUp(e){const n=this.content[e];for(;e>0;){const i=Math.floor((e+1)/2)-1,r=this.content[i];if(!(this.scoreFunction(n)<this.scoreFunction(r)))break;this.content[i]=n,this.content[e]=r,e=i}}sinkDown(e){const n=this.content.length,i=this.content[e],r=this.scoreFunction(i);let s=0,o=0;for(;;){const a=2*(e+1),c=a-1;let l=null;if(c<n){const h=this.content[c];s=this.scoreFunction(h),s<r&&(l=c)}if(a<n){const h=this.content[a];o=this.scoreFunction(h),o<(l===null?r:s)&&(l=a)}if(l===null)break;this.content[e]=this.content[l],this.content[l]=i,e=l}}}/**
 * Kdtree
 * @class
 * @author Alexander Rose <alexander.rose@weirdbyte.de>, 2016
 * @author Roman Bolzern <roman.bolzern@fhnw.ch>, 2013
 * @author I4DS http://www.fhnw.ch/i4ds, 2013
 * @license MIT License <http://www.opensource.org/licenses/mit-license.php>
 * @description
 * k-d Tree for typed arrays of 3d points (e.g. for Float32Array), in-place
 * provides fast nearest neighbour search
 *
 * Based on https://github.com/ubilabs/kd-tree-javascript by Ubilabs
 *
 * Further information (including mathematical properties)
 * http://en.wikipedia.org/wiki/Binary_tree
 * http://en.wikipedia.org/wiki/K-d_tree
 *
 * @example
 * points: [x, y, z, x, y, z, x, y, z, ...]
 * metric: function(a, b){
 *    return Math.pow(a[0]-b[0], 2) + Math.pow(a[1]-b[1], 2) + Math.pow(a[2]-b[2], 2);
 * }
 *
 * @param {Float32Array} points - points
 * @param {Function} metric - metric
 */class eT{constructor(e,n){this.points=e,this.metric=n,this.maxDepth=0,this.currentNode=0;const i=e.length/3,r=new Uint32Array(i);for(let s=0;s<i;++s)r[s]=s;this.indices=r,this.nodes=new Int32Array(4*i),this.rootIndex=this.buildTree(0,-1,0,i)}buildTree(e,n,i,r){e>this.maxDepth&&(this.maxDepth=e);const s=r-i;if(s===0)return-1;const o=4*this.currentNode,a=this.nodes;if(this.currentNode+=1,s===1)return a[o]=i,a[o+1]=-1,a[o+2]=-1,a[o+3]=n,o;const c=this.indices,l=this.points,h=i+Math.floor(s/2),u=e%3;let f,d,p,y,g,m=i,x=r-1;for(;x>m;){for(p=m+x>>1,y=l[3*c[p]+u],d=c[p],c[p]=c[x],c[x]=d,g=m,f=m;f<x;++f)l[3*c[f]+u]<y&&(d=c[g],c[g]=c[f],c[f]=d,++g);if(d=c[x],c[x]=c[g],c[g]=d,p=g,h===p)break;h<p?x=p-1:m=p+1}return a[o]=h,a[o+1]=this.buildTree(e+1,o,i,h),a[o+2]=this.buildTree(e+1,o,h+1,r),a[o+3]=n,o}getNodeDepth(e){const n=this.nodes[e+3];return n===-1?0:this.getNodeDepth(n)+1}nearest(e,n,i){const r=new QC(h=>-h[1]),s=this.nodes,o=this.points,a=this.indices,c=h=>{let u,f;const d=this.getNodeDepth(h)%3,p=3*a[s[h]],y=[o[p+0],o[p+1],o[p+2]],g=this.metric(e,y);function m(C,w){r.push([C,w]),r.size()>n&&r.pop()}const x=s[h+1],v=s[h+2];if(v===-1&&x===-1)return void((r.size()<n||g<r.peek()[1])&&g<=i&&m(h,g));u=v===-1?x:x===-1?v:e[d]<=o[p+d]?x:v,c(u),(r.size()<n||g<r.peek()[1])&&g<=i&&m(h,g);const b=[];for(let C=0;C<3;C+=1)b[C]=C===d?e[C]:o[p+C];const _=this.metric(b,y);(r.size()<n||Math.abs(_)<r.peek()[1])&&Math.abs(_)<=i&&(f=u===x?v:x,f!==-1&&c(f))};c(this.rootIndex);const l=[];for(let h=0,u=Math.min(r.size(),n);h<u;h+=1)l.push(r.content[h]);return l}verify(e,n=0){let i=1;if(e===void 0&&(e=this.rootIndex),e===-1)throw new Error("node is null");const r=n%3,s=this.nodes,o=this.points,a=this.indices,c=s[e+1],l=s[e+2];if(c!==-1){if(o[3*a[s[c]]+r]>o[3*a[s[e]]+r])throw new Error("left child is > parent!");i+=this.verify(c,n+1)}if(l!==-1){if(o[3*a[s[l]]+r]<o[3*a[s[e]]+r])throw new Error("right child is < parent!");i+=this.verify(l,n+1)}return i}}class zu{constructor(e,n=0){this.structure=e,this.index=n,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueMap=e.residueMap,this.atomMap=e.atomMap}get bondHash(){return this.structure.bondHash}get entity(){return this.structure.entityList[this.entityIndex]}get entityIndex(){return this.chainStore.entityIndex[this.chainIndex]}get modelIndex(){return this.chainStore.modelIndex[this.chainIndex]}get chainIndex(){return this.residueStore.chainIndex[this.residueIndex]}get residue(){return console.warn("residue - might be expensive"),this.structure.getResidueProxy(this.residueIndex)}get residueIndex(){return this.atomStore.residueIndex[this.index]}set residueIndex(e){this.atomStore.residueIndex[this.index]=e}get sstruc(){return this.residueStore.getSstruc(this.residueIndex)}get inscode(){return this.residueStore.getInscode(this.residueIndex)}get resno(){return this.residueStore.resno[this.residueIndex]}get chainname(){return this.chainStore.getChainname(this.chainIndex)}get chainid(){return this.chainStore.getChainid(this.chainIndex)}get residueType(){return this.residueMap.get(this.residueStore.residueTypeId[this.residueIndex])}get atomType(){return this.atomMap.get(this.atomStore.atomTypeId[this.index])}get residueAtomOffset(){return this.residueStore.atomOffset[this.residueIndex]}get resname(){return this.residueType.resname}get hetero(){return this.residueType.hetero}get atomname(){return this.atomType.atomname}get number(){return this.atomType.number}get element(){return this.atomType.element}get vdw(){return this.atomType.vdw}get covalent(){return this.atomType.covalent}get x(){return this.atomStore.x[this.index]}set x(e){this.atomStore.x[this.index]=e}get y(){return this.atomStore.y[this.index]}set y(e){this.atomStore.y[this.index]=e}get z(){return this.atomStore.z[this.index]}set z(e){this.atomStore.z[this.index]=e}get serial(){return this.atomStore.serial[this.index]}set serial(e){this.atomStore.serial[this.index]=e}get bfactor(){return this.atomStore.bfactor[this.index]}set bfactor(e){this.atomStore.bfactor[this.index]=e}get occupancy(){return this.atomStore.occupancy[this.index]}set occupancy(e){this.atomStore.occupancy[this.index]=e}get altloc(){return this.atomStore.getAltloc(this.index)}set altloc(e){this.atomStore.setAltloc(this.index,e)}get partialCharge(){return this.atomStore.partialCharge?this.atomStore.partialCharge[this.index]:null}set partialCharge(e){this.atomStore.partialCharge&&(this.atomStore.partialCharge[this.index]=e)}get radius(){return this.atomStore.radius?this.atomStore.radius[this.index]:null}set radius(e){this.atomStore.radius&&(this.atomStore.radius[this.index]=e)}get formalCharge(){return this.atomStore.formalCharge?this.atomStore.formalCharge[this.index]:null}set formalCharge(e){this.atomStore.formalCharge&&(this.atomStore.formalCharge[this.index]=e)}get aromatic(){return this.atomStore.aromatic?this.atomStore.aromatic[this.index]:this.residueType.isAromatic(this)?1:0}set aromatic(e){this.atomStore.aromatic&&(this.atomStore.aromatic[this.index]=e)}get bondCount(){return this.bondHash.countArray[this.index]}eachBond(e,n){n=n||this.structure._bp;const i=this.index,r=this.bondHash,s=r.indexArray,o=r.countArray[i],a=r.offsetArray[i];for(let c=0;c<o;++c)n.index=s[a+c],e(n)}eachBondedAtom(e,n){const i=n||this.structure._ap,r=this.index;this.eachBond(function(s){i.index=r!==s.atomIndex1?s.atomIndex1:s.atomIndex2,e(i)}),this.index=r}hasBondTo(e){let n=!1;return this.eachBondedAtom(function(i){e.index===i.index&&(n=!0)}),n}bondToElementCount(e){let n=0;const i=this.index;return this.eachBondedAtom(function(r){r.number===e&&(n+=1)}),this.index=i,n}hasBondToElement(e){return this.bondToElementCount(e)>0}isBackbone(){const e=this.residueType.backboneIndexList;return e.length>0&&e.includes(this.index-this.residueAtomOffset)}isPolymer(){if(this.structure.entityList.length>0)return this.entity.isPolymer();{const e=this.residueType.moleculeType;return e===3||e===4||e===5}}isSidechain(){return this.isPolymer()&&!this.isBackbone()}isCg(){const e=this.residueType.backboneType;return e===4||e===5||e===6}isTrace(){return this.index===this.residueType.traceAtomIndex+this.residueAtomOffset}isHetero(){return this.residueType.hetero===1}isProtein(){return this.residueType.moleculeType===3}isNucleic(){const e=this.residueType.moleculeType;return e===4||e===5}isRna(){return this.residueType.moleculeType===4}isDna(){return this.residueType.moleculeType===5}isWater(){return this.residueType.moleculeType===1}isIon(){return this.residueType.moleculeType===2}isSaccharide(){return this.residueType.moleculeType===6}isHelix(){return $x.includes(this.sstruc)}isSheet(){return Wx.includes(this.sstruc)}isTurn(){return jx.includes(this.sstruc)&&this.isProtein()}isBonded(){return this.bondHash.countArray[this.index]!==0}isRing(){return this.residueType.getRings().atomRings[this.index-this.residueAtomOffset]!==void 0}isAromatic(){return this.aromatic===1}isPolarHydrogen(){let e=!1;return this.number!==1||(e=!this.hasBondToElement(6)),e}isMetal(){return this.atomType.isMetal()}isNonmetal(){return this.atomType.isNonmetal()}isMetalloid(){return this.atomType.isMetalloid()}isHalogen(){return this.atomType.isHalogen()}isDiatomicNonmetal(){return this.atomType.isDiatomicNonmetal()}isPolyatomicNonmetal(){return this.atomType.isPolyatomicNonmetal()}isAlkaliMetal(){return this.atomType.isAlkaliMetal()}isAlkalineEarthMetal(){return this.atomType.isAlkalineEarthMetal()}isNobleGas(){return this.atomType.isNobleGas()}isTransitionMetal(){return this.atomType.isTransitionMetal()}isPostTransitionMetal(){return this.atomType.isPostTransitionMetal()}isLanthanide(){return this.atomType.isLanthanide()}isActinide(){return this.atomType.isActinide()}getDefaultValence(){return this.atomType.getDefaultValence()}getValenceList(){return this.atomType.getValenceList()}getOuterShellElectronCount(){return this.atomType.getOuterShellElectronCount()}distanceTo(e){const n=this.atomStore,i=e.atomStore,r=this.index,s=e.index,o=n.x[r]-i.x[s],a=n.y[r]-i.y[s],c=n.z[r]-i.z[s],l=o*o+a*a+c*c;return Math.sqrt(l)}connectedTo(e){const n=this.atomStore,i=e.atomStore,r=this.index,s=e.index;if(n.altloc&&i.altloc){const d=n.altloc[r],p=i.altloc[s];if(d!==0&&p!==0&&d!==32&&p!==32&&d!==p)return!1}const o=n.x[r]-i.x[s],a=n.y[r]-i.y[s],c=n.z[r]-i.z[s],l=o*o+a*a+c*c;if(l<48&&this.isCg())return!0;if(isNaN(l))return!1;const h=this.covalent+e.covalent,u=h+.3,f=h-.5;return l<u*u&&l>f*f}positionFromArray(e,n=0){return this.x=e[n+0],this.y=e[n+1],this.z=e[n+2],this}positionToArray(e=[],n=0){const i=this.index,r=this.atomStore;return e[n+0]=r.x[i],e[n+1]=r.y[i],e[n+2]=r.z[i],e}positionToVector3(e){return e===void 0&&(e=new T),e.x=this.x,e.y=this.y,e.z=this.z,e}positionFromVector3(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}positionAdd(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}positionSub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}getResidueBonds(e=!1){const n=this.residueAtomOffset,i=this.index-this.residueAtomOffset,r=this.residueType.getBonds(),s=r.atomIndices1,o=r.atomIndices2;let a,c,l,h;for(e||(h=[]),a=s.indexOf(i);a!==-1;){if(l=o[a]+n,!h)return l;h.push(l),a=s.indexOf(i,a+1)}for(c=o.indexOf(i);c!==-1;){if(l=s[c]+n,!h)return l;h.push(l),c=o.indexOf(i,c+1)}return h}qualifiedName(e=!1){var n="";return this.resname&&!e&&(n+="["+this.resname+"]"),this.resno!==void 0&&(n+=this.resno),this.inscode&&(n+="^"+this.inscode),this.chainname&&(n+=":"+this.chainname),this.atomname&&(n+="."+this.atomname),this.altloc&&(n+="%"+this.altloc),this.structure.modelStore.count>1&&(n+="/"+this.modelIndex),n}clone(){return new zu(this.structure,this.index)}toObject(){return{index:this.index,residueIndex:this.residueIndex,resname:this.resname,x:this.x,y:this.y,z:this.z,element:this.element,chainname:this.chainname,resno:this.resno,serial:this.serial,vdw:this.vdw,covalent:this.covalent,hetero:this.hetero,bfactor:this.bfactor,altloc:this.altloc,atomname:this.atomname,modelIndex:this.modelIndex}}}function db(t,e){const n=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2];return n*n+i*i+r*r}function tT(t,e){return Math.sqrt(db(t,e))}const $d=new Float32Array(3);class nT{constructor(e,n=!1){Ce&&fe.time("Kdtree build");const i=n?db:tT,r=new Float32Array(3*e.atomCount),s=new Uint32Array(e.atomCount);let o=0;e.eachAtom(function(a){r[o+0]=a.x,r[o+1]=a.y,r[o+2]=a.z,s[o/3]=a.index,o+=3}),this.atomIndices=s,this.points=r,this.kdtree=new eT(r,i),Ce&&fe.timeEnd("Kdtree build")}nearest(e,n,i){e instanceof T?e.toArray($d):e instanceof zu&&e.positionToArray($d);const r=this.kdtree.nearest($d,n,i),s=this.kdtree.indices,o=this.kdtree.nodes,a=this.atomIndices,c=[];for(let l=0,h=r.length;l<h;++l){const u=r[l],f=u[0],d=u[1];c.push({index:a[s[o[f]]],distance:d})}return c}}const iT={" ":"X","!":"Y","#":"Z",$:"-X","%":"-Y","&":"-Z","'":"Y+1/2","(":"1/2+X",")":"1/2+Y","*":"1/2-X","+":"1/2+Z",",":"1/2-Y","-":"1/2-Z",".":"X+1/2","/":"Z+1/2",0:"-X+1/2",1:"-Y+1/2",2:"-Z+1/2",3:"1/4+X",4:"1/4-Y",5:"1/4+Z",6:"1/4-X",7:"1/4+Y",8:"3/4-Y",9:"3/4+Z",":":"3/4+Y",";":"3/4+X","<":"3/4-X","=":"1/4-Z",">":"3/4-Z","?":"X-Y","@":"Y-X",A:"Z+1/3",B:"Z+2/3",C:"X+2/3",D:"Y+1/3",E:"-Y+2/3",F:"X-Y+1/3",G:"Y-X+2/3",H:"-X+1/3",I:"X+1/3",J:"Y+2/3",K:"-Y+1/3",L:"X-Y+2/3",M:"Y-X+1/3",N:"-X+2/3",O:"2/3+X",P:"1/3+Y",Q:"1/3+Z",R:"2/3-Y",S:"1/3+X-Y",T:"2/3+Y-X",U:"1/3-X",V:"2/3-X",W:"1/3-Y",X:"1/3-Z",Y:"2/3+Y",Z:"1/3+Y-X","[":"2/3+X-Y","]":"1/3+X","^":"2/3+Z",_:"2/3-Z","`":"5/6+Z",a:"1/6+Z",b:"5/6-Z",c:"1/6-Z",d:"Z+5/6",e:"Z+1/6",f:"Z+1/4",g:"+Y"},rT={"P 1":" !#","P -1":" !#$%&","P 1 2 1":" !#$!&","P 1 21 1":" !#$'&","C 1 2 1":" !#$!&()#*)&","P 1 m 1":" !# %#","P 1 c 1":" !# %+","C 1 m 1":" !# %#()#(,#","C 1 c 1":" !# %+()#(,+","P 1 2/m 1":" !# %#$!&$%&","P 1 21/m 1":" !#$)&$%& ,#","C 1 2/m 1":" !# %#$!&$%&()#(,#*)&*,&","P 1 2/c 1":" !#$!-$%& %+","P 1 21/c 1":" !#$%&$)- ,+","C 1 2/c 1":" !#$!-$%& %+()#*)-*,&(,+","P 2 2 2":" !#$%#$!& %&","P 2 2 21":" !#$%+$!- %&","P 21 21 2":" !#$%#*)&(,&","P 21 21 21":" !#*%+$)-(,&","C 2 2 21":" !#$%+$!- %&()#*,+*)-(,&","C 2 2 2":" !#$%#$!& %&()#*,#*)&(,&","F 2 2 2":" !#$%#$!& %& )+$,+$)- ,-(!+*%+*!-(%-()#*,#*)&(,&","I 2 2 2":" !#$%# %&$!&.'/01/.120'2","I 21 21 21":" !#*%+$)-(,&()+$,#*!& %-","P m m 2":" !#$%# %#$!#","P m c 21":" !#$%+ %+$!#","P c c 2":" !#$%# %+$!+","P m a 2":" !#$%#(%#*!#","P c a 21":" !#$%+(%#*!+","P n c 2":" !#$%# ,+$)+","P m n 21":" !#*%+(%+$!#","P b a 2":" !#$%#(,#*)#","P n a 21":" !#$%+(,#*)+","P n n 2":" !#$%#(,+*)+","C m m 2":" !#$%# %#$!#()#*,#(,#*)#","C m c 21":" !#$%+ %+$!#()#*,+(,+*)#","C c c 2":" !#$%# %+$!+()#*,#(,+*)+","A m m 2":" !#$%# %#$!# )+$,+ ,+$)+","A b m 2":" !#$%# ,#$)# )+$,+ %+$!+","A m a 2":" !#$%#(%#*!# )+$,+(,+*)+","A b a 2":" !#$%#(,#*)# )+$,+(%+*!+","F m m 2":" !#$%# %#$!# )+$,+ ,+$)+(!+*%+(%+*!+()#*,#(,#*)#","F d d 2":" !#$%#345675 )+$,+3896:9(!+*%+;49<79()#*,#;85<:5","I m m 2":" !#$%# %#$!#()+*,+(,+*)+","I b a 2":" !#$%#(,#*)#()+*,+ %+$!+","I m a 2":" !#$%#(%#*!#()+*,+ ,+$)+","P 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#","P 2/n 2/n 2/n":" !#$%#$!& %&*,-()-(,+*)+","P 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+","P 2/b 2/a 2/n":" !#$%#$!& %&*,&()&(,#*)#","P 21/m 2/m 2/a":" !#*%#$!&(%&$%&(!& %#*!#","P 2/n 21/n 2/a":" !#*%#*)- ,-$%&(!&(,+$)+","P 2/m 2/n 21/a":" !#*%+*!- %&$%&(!-(%+$!#","P 21/c 2/c 2/a":" !#*%#$!-(%-$%&(!& %+*!+","P 21/b 21/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#","P 21/c 21/c 2/n":" !#*,#$)-(%-$%&()& ,+*!+","P 2/b 21/c 21/m":" !#$%+$)- ,&$%& !- ,+$)#","P 21/n 21/n 2/m":" !#$%#*)-(,-$%& !&(,+*)+","P 21/m 21/m 2/n":" !#$%#*'&.,&*,&.'& %#$!#","P 21/b 2/c 21/n":" !#*,+$!-(,&$%&()- %+*)#","P 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#","P 21/n 21/m 21/a":" !#0%/$'&.12$%&.!2 1#0'/","C 2/m 2/c 21/m":" !#$%+$!- %&$%& !- %+$!#()#*,+*)-(,&*,&()-(,+*)#","C 2/m 2/c 21/a":" !#$,+$)- %&$%& )- ,+$!#()#*%+*!-(,&*,&(!-(%+*)#","C 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()#*,#*)&(,&*,&()&(,#*)#","C 2/c 2/c 2/m":" !#$%#$!- %-$%& !& %+$!+()#*,#*)-(,-*,&()&(,+*)+","C 2/m 2/m 2/a":" !#$,#$)& %&$%& )& ,#$!#()#*%#*!&(,&*,&(!&(%#*)#","C 2/c 2/c 2/a":" !#*,#$!&(,&$,-(!- ,+*!+()#$%#*)& %&*%- )-(%+$)+","F 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!# )+$,+$)- ,-$,- )- ,+$)+(!+*%+*!-(%-*%-(!-(%+*!+()#*,#*)&(,&*,&()&(,#*)#","F 2/d 2/d 2/d":" !#$%#$!& %&64=37=345675 )+$,+$)- ,-68>3:>3896:9(!+*%+*!-(%-<4>;7>;49<79()#*,#*)&(,&<8=;:=;85<:5","I 2/m 2/m 2/m":" !#$%#$!& %&$%& !& %#$!#()+*,+*)-(,-*,-()-(,+*)+","I 2/b 2/a 2/m":" !#$%#*)&(,&$%& !&(,#*)#()+*,+$!- %-*,-()- %+$!+","I 21/b 21/c 21/a":" !#*%+$)-(,&$%&(!- ,+*)#()+$,#*!& %-*,- )&(%#$!+","I 21/m 21/m 21/a":" !#$,#$)& %&$%& )& ,#$!#()+*%+*!-(,-*,-(!-(%+*)+","P 4":" !#$%#% #!$#","P 41":" !#$%+% 5!$9","P 42":" !#$%#% +!$+","P 43":" !#$%+% 9!$5","I 4":" !#$%#% #!$#()+*,+,(+)*+","I 41":" !#*,+%(5)$9()+$%#, 9!*5","P -4":" !#$%#!$&% &","I -4":" !#$%#!$&% &()+*,+)*-,(-","P 4/m":" !#$%#% #!$#$%& !&!$&% &","P 42/m":" !#$%#% +!$+$%& !&!$-% -","P 4/n":" !#$%#,(#)*#*,&()&!$&% &","P 42/n":" !#$%#,(+)*+*,-()-!$&% &","I 4/m":" !#$%#% #!$#$%& !&!$&% &()+*,+,(+)*+*,-()-)*-,(-","I 41/a":" !#*,+%(5)$9$,=(!>!$&,(-()+$%#, 9!*5*%> )=)*-% &","P 4 2 2":" !#$%#% #!$#$!& %&! &%$&","P 4 21 2":" !#$%#,(#)*#*)&(,&! &%$&","P 41 2 2":" !#$%+% 5!$9$!& %-! >%$=","P 41 21 2":" !#$%+,(5)*9*)=(,>! &%$-","P 42 2 2":" !#$%#% +!$+$!& %&! -%$-","P 42 21 2":" !#$%#,(+)*+*)-(,-! &%$&","P 43 2 2":" !#$%+% 9!$5$!& %-! =%$>","P 43 21 2":" !#$%+,(9)*5*)>(,=! &%$-","I 4 2 2":" !#$%#% #!$#$!& %&! &%$&()+*,+,(+)*+*)-(,-)(-,*-","I 41 2 2":" !#*,+%(5)$9*!> ,=)(-%$&()+$%#, 9!*5$)=(%>! &,*-","P 4 m m":" !#$%#% #!$# %#$!#%$#! #","P 4 b m":" !#$%#% #!$#(,#*)#,*#)(#","P 42 c m":" !#$%#% +!$+ %+$!+%$#! #","P 42 n m":" !#$%#,(+)*+(,+*)+%$#! #","P 4 c c":" !#$%#% #!$# %+$!+%$+! +","P 4 n c":" !#$%#% #!$#(,+*)+,*+)(+","P 42 m c":" !#$%#% +!$+ %#$!#%$+! +","P 42 b c":" !#$%#% +!$+(,#*)#,*+)(+","I 4 m m":" !#$%#% #!$# %#$!#%$#! #()+*,+,(+)*+(,+*)+,*+)(+","I 4 c m":" !#$%#% #!$# %+$!+%$+! +()+*,+,(+)*+(,#*)#,*#)(#","I 41 m d":" !#*,+%(5)$9 %#*)+%*5) 9()+$%#, 9!*5(,+$!#,$9!(5","I 41 c d":" !#*,+%(5)$9 %+*)#%*9) 5()+$%#, 9!*5(,#$!+,$5!(9","P -4 2 m":" !#$%#% &!$&$!& %&%$#! #","P -4 2 c":" !#$%#% &!$&$!- %-%$+! +","P -4 21 m":" !#$%#% &!$&*)&(,&,*#)(#","P -4 21 c":" !#$%#% &!$&*)-(,-,*+)(+","P -4 m 2":" !#$%#!$&% & %#$!#! &%$&","P -4 c 2":" !#$%#% &!$& %+$!+! -%$-","P -4 b 2":" !#$%#% &!$&(,#*)#)(&,*&","P -4 n 2":" !#$%#% &!$&(,+*)+)(-,*-","I -4 m 2":" !#$%#% &!$& %#$!#! &%$&()+*,+,(-)*-(,+*)+)(-,*-","I -4 c 2":" !#$%#% &!$& %+$!+! -%$-()+*,+,(-)*-(,#*)#)(&,*&","I -4 2 m":" !#$%#% &!$&$!& %&%$#! #()+*,+,(-)*-*)-(,-,*+)(+","I -4 2 d":" !#$%#% &!$&*!>(%>,$9) 9()+*,+,(-)*-$)= ,=%*5!(5","P 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #","P 4/m 2/c 2/c":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +","P 4/n 2/b 2/m":" !#$%#% #!$#$!& %&! &%$&*,&()&)*&,(&(,#*)#,*#)(#","P 4/n 2/n 2/c":" !#$%#% #!$#$!& %&! &%$&*,-()-)*-,(-(,+*)+,*+)(+","P 4/m 21/b 2/m":" !#$%#% #!$#*)&(,&)(&,*&$%& !&!$&% &(,#*)#,*#)(#","P 4/m 21/n 2/c":" !#$%#% #!$#*)-(,-)(-,*-$%& !&!$&% &(,+*)+,*+)(+","P 4/n 21/m 2/m":" !#$%#,(#)*#*)&(,&! &%$&*,&()&!$&% & %#$!#,*#)(#","P 4/n 2/c 2/c":" !#$%#,(#)*#*)-(,-! -%$-*,&()&!$&% & %+$!+,*+)(+","P 42/m 2/m 2/c":" !#$%#% +!$+$!& %&! -%$-$%& !&!$-% - %#$!#%$+! +","P 42/m 2/c 2/m":" !#$%#% +!$+$!- %-! &%$&$%& !&!$-% - %+$!+%$#! #","P 42/n 2/b 2/c":" !#$%#,(+)*+$!- %-)(&,*&*,-()-!$&% &(,#*)#%$+! +","P 42/n 2/n 2/m":" !#$%#,(+)*+$!& %&)(-,*-*,-()-!$&% &(,+*)+%$#! #","P 42/m 21/b 2/c":" !#$%#% +!$+*)&(,&)(-,*-$%& !&!$-% -(,#*)#,*+)(+","P 42/m 21/n 2/m":" !#$%#,./'*/*'-.,-! &%$&$%& !&'*-,.-.,/*'/%$#! #","P 42/n 21/m 2/c":" !#$%#,(+)*+*)-(,-! &%$&*,-()-!$&% & %#$!#,*+)(+","P 42/n 21/c 2/m":" !#$%#,(+)*+*)&(,&! -%$-*,-()-!$&% & %+$!+,*#)(#","I 4/m 2/m 2/m":" !#$%#% #!$#$!& %&! &%$&$%& !&!$&% & %#$!#%$#! #()+*,+,(+)*+*)-(,-)(-,*-*,-()-)*-,(-(,+*)+,*+)(+","I 4/m 2/c 2/m":" !#$%#% #!$#$!- %-! -%$-$%& !&!$&% & %+$!+%$+! +()+*,+,(+)*+*)&(,&)(&,*&*,-()-)*-,(-(,#*)#,*#)(#","I 41/a 2/m 2/d":" !#*,+%(5)$9*!> ,=)(-%$&$,=(!>!$&,(-(,+$!#,$9!(5()+$%#, 9!*5$)=(%>! &,*-*%> )=)*-% & %#*)+%*5) 9","I 41/a 2/c 2/d":" !#*,+%(5)$9*!= ,>)(&%$-$,=(!>!$&,(-(,#$!+,$5!(9()+$%#, 9!*5$)>(%=! -,*&*%> )=)*-% & %+*)#%*9) 5","P 3":" !#%?#@$#","P 31":" !#%?A@$B","P 32":" !#%?B@$A","H 3":" !#%?#@$#CDAEFAGHAIJBKLBMNB","R 3":" !## !!# ","P -3":" !#%?#@$#$%&!@&? &","H -3":" !#%?#@$#$%&!@&? &OPQRSQTUQVWXYZX[]X]Y^W[^ZV^UR_PT_SO_","R -3":" !## !!# $%&&$%%&$","P 3 1 2":" !#%?#@$#%$&@!& ?&","P 3 2 1":" !#%?#@$#! &?%&$@&","P 31 1 2":" !#%?Q@$^%$_@!X ?&","P 31 2 1":" !#%?A@$B! &?%_$@X","P 32 1 2":" !#%?^@$Q%$X@!_ ?&","P 32 2 1":" !#%?B@$A! &?%X$@_","H 3 2":" !#%?#@$#! &?%&$@&OPQRSQTUQY]X[WXVZX]Y^W[^ZV^PO_SR_UT_","R 3 2":" !## !!# %$&$&%&%$","P 3 m 1":" !#%?#@$#%$#@!# ?#","P 3 1 m":" !#%?#@$#! #?%#$@#","P 3 c 1":" !#%?#@$#%$+@!+ ?+","P 3 1 c":" !#%?#@$#! +?%+$@+","H 3 m":" !#%?#@$#%$#@!# ?#OPQRSQTUQRUQTPQOSQ]Y^W[^ZV^WV^ZY^][^","R 3 m":" !## !!# ! # #!#! ","H 3 c":" !#%?#@$#%$+@!+ ?+OPQRSQTUQRU`TP`OS`]Y^W[^ZV^WVaZYa][a","R 3 c":" !## !!# '././'/'.","P -3 1 2/m":" !#%?#@$#%$&@!& ?&$%&!@&? &! #?%#$@#","P -3 1 2/c":" !#%?#@$#%$-@!- ?-$%&!@&? &! +?%+$@+","P -3 2/m 1":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#","P -3 2/c 1":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+","H -3 2/m":" !#%?#@$#! &?%&$@&$%&!@&? &%$#@!# ?#OPQRSQTUQY]X[WXVZXVWXYZX[]XRUQTPQOSQ]Y^W[^ZV^PO_SR_UT_UR_PT_SO_WV^ZY^][^","R -3 2/m":" !## !!# %$&$&%&%$$%&&$%%&$! # #!#! ","H -3 2/c":" !#%?#@$#! -?%-$@-$%&!@&? &%$+@!+ ?+OPQRSQTUQY]b[WbVZbVWXYZX[]XRU`TP`OS`]Y^W[^ZV^POcSRcUTcUR_PT_SO_WVaZYa][a","R -3 2/c":" !## !!# 102021210$%&&$%%&$'././'/'.","P 6":" !#%?#@$#$%#!@#? #","P 61":" !#%?A@$B$%/!@d? e","P 65":" !#%?B@$A$%/!@e? d","P 62":" !#%?^@$Q$%#!@^? Q","P 64":" !#%?Q@$^$%#!@Q? ^","P 63":" !#%?#@$#$%+!@+? +","P -6":" !#%?#@$# !&%?&@$&","P 6/m":" !#%?#@$#$%#!@#? #$%&!@&? & !&%?&@$&","P 63/m":" !#%?#@$#$%+!@+? +$%&!@&? & !-%?-@$-","P 6 2 2":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&","P 61 2 2":" !#%?Q@$^$%+!@`? a! X?%&$@_%$b@!- ?c","P 65 2 2":" !#%?^@$Q$%+!@a? `! _?%&$@X%$c@!- ?b","P 62 2 2":" !#%?^@$Q$%#!@^? Q! _?%&$@X%$_@!& ?X","P 64 2 2":" !#%?Q@$^$%#!@Q? ^! X?%&$@_%$X@!& ?_","P 63 2 2":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-","P 6 m m":" !#%?#@$#$%#!@#? #%$#@!# ?#! #?%#$@#","P 6 c c":" !#%?#@$#$%#!@#? #%$+@!+ ?+! +?%+$@+","P 63 c m":" !#%?#@$#$%+!@+? +%$+@!+ ?+! #?%#$@#","P 63 m c":" !#%?#@$#$%+!@+? +%$#@!# ?#! +?%+$@+","P -6 m 2":" !#%?#@$# !&%?&@$&%$#@!# ?#%$&@!& ?&","P -6 c 2":" !#%?#@$# !-%?-@$-%$+@!+ ?+%$&@!& ?&","P -6 2 m":" !#%?#@$# !&%?&@$&! &?%&$@&! #?%#$@#","P -6 2 c":" !#%?#@$# !-%?-@$-! &?%&$@&! +?%+$@+","P 6/m 2/m 2/m":" !#%?#@$#$%#!@#? #! &?%&$@&%$&@!& ?&$%&!@&? & !&@$&%?&%$#@!# ?#! #?%#$@#","P 6/m 2/c 2/c":" !#%?#@$#$%#!@#? #! -?%-$@-%$-@!- ?-$%&!@&? & !&@$&%?&%$+@!+ ?+! +?%+$@+","P 63/m 2/c 2/m":" !#%?#@$#$%+!@+? +! -?%-$@-%$&@!& ?&$%&!@&? & !-@$-%?-%$+@!+ ?+! #?%#$@#","P 63/m 2/m 2/c":" !#%?#@$#$%+!@+? +! &?%&$@&%$-@!- ?-$%&!@&? & !-@$-%?-%$#@!# ?#! +?%+$@+","P 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ","F 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%&  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ","I 2 3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(","P 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(","I 21 3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- ","P 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$","P 2/n -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& *,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","F 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-($,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- *,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$","F 2/d -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& 64=37=345675=64=375345674=67=3453756 )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(68>3:>3896:9=<8=;:5;85<:4><7>;49;79<(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(<4>;7>;49<79>68>3:93896:8=<:=;85;:5<()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- <8=;:=;8f<:f><4>;79;49<78>6:>3893:96","I 2/m -3":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& $%& !& %#$!#&$%& !# %#$!%&$!& %# !#$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-(*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*","P 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*","I 21/a -3":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&($%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*()+$,#*g& %-+()#$,&*!- %)+(,#$!&*%- *,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$","P 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$","P 42 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","F 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$ )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*(!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%*()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$","F 41 3 2":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46 )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<(!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86","I 4 3 2":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*","P 43 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7;>46=:<5839398<5:6=4;>75:<983>7;=46","P 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<","I 41 3 2":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46","P -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ","F -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&%  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(+%*+!*-%(- +)$+,$-) -,#)(#,*&)*&,((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() +,$+)$-, -(#)*#,*&)(&,+!(+%*-!*-%(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(#,*#)*&,(&(+!*+%*-!(-%+) +,$-)$-, ","I -4 3 m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! #%$#!$&% & #!$#%$&! &%#! #%$&!$&% ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","P -4 3 n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,(","F -4 3 c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(+,*+)*-,(-(+)*+,*-)(-,+)(+,*-)*-,( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() #,$#)$&, &(#!*#%*&!(&%+! +%$-!$-% (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(#%*#!*&%(& +!$+%$-! -%#) #,$&)$&, ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! +%$+!$-% - #)$#,$&) &,#!(#%*&!*&%(","I -4 3 d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(7354<9:6>8;=357<946>:;=857394<>:6=8;()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- :;98657<=43>;9:658<=73>49:;586=7<>43","P 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","P 4/n -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$*,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/m -3 2/n":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","P 42/n -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ","F 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#!  )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-(!(-%*-!*+%(+ +,$+)$-, -)#)*#,(&)(&,*$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*%*+!(+%(-!*-$-) -, +)$+,&,(&)*#,*#)((!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&() -,$-)$+, +(#,*#)*&,(&)+!*+%(-!(-%**%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*,$+) +, -)$-*&)(&,(#)*#,-%(-!*+%*+!(()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- )(&,*&)*#,(#(+%*+!*-%(-!+)$+, -) -,$*,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$,*#)(#,(&)*&*-!(-%(+!*+%-, -)$+,$+) ","F 4/m -3 2/c":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& )(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,*$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)( )+$,+$)- ,-#()#*,&*)&(,!+(%+*!-*%-() &,$&)$#, #(#%*#!*&%(&!+!$+% -! -%$$,- )- ,+$)+&*,&()#(,#*)%-*!-(%+(!+*,$#) #, &)$&*&!(&%(#!*#%-% -!$+%$+! (!+*%+*!-(%-+ )+$,-$)- ,)#(,#*)&*,&(!(&%*&!*#%(# +%$+!$-% -!#)$#, &) &,$*%-(!-(%+*!+-$,- )+ ,+$),&*)&(,#()#*%*#!(#%(&!*&$-! -% +!$+%&, &)$#,$#) ()#*,#*)&(,&+(!+*%-*!-(%)+ ,+$)-$,- ! -%$-!$+% + #,$#)$&, &)#!*#%(&!(&%**,&()&(,#*)#-*%-(!+(%+*!,-$)- ,+ )+$%$+! +% -!$-$&) &, #)$#,&%(&!*#%*#!(","F 41/d -3 2/m":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=4664=3:>;85<79=64>3:5;89<74=6:>385;79<,$+! #%(-)*&*&)(-% #!$+,-%(&)*+,$#!  )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<68>37=;49<:5=<8>;753496:4><:=;893756,*#!(+% &)$-*-!(&, +)$#%-, &!$+%*#)((!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<<4>;:=389675>68=379;45<:8=<7>;453:96%$#) +,(&!*-$&! -,(#)*+%&% -)$#,*+!(()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>86<8=;7>3456:9><4=;:9385678>67=349;:5<%*+)(#, -!$&$-) &%(+!*#,&,(-!*#%$+) ","F 41/d -3 2/c":" !#$,+*)&(%-# !+$,&*)-(%!# ,+$)&*%-(:3>46=7<98;5;58<976=43>:97<58;>:3=46<8>;7=3496:5><8=;793456:8><7=;493:56%*#)(+, &!$-$-! &,(+)*#%&, -!$#%*+)( )+$%#*!-(,&#()+*%&$!- ,!+(,#*)-$%& :;=4<>765839;94<5:6>83=79:6543>7;=8<<4=;:>385679>64=3:9;85<78=67>345;:9<%$+) #,(-!*&$&) -%(#!*+,&%(-)*#,$+! (!+*,#$)- %&+ )#$%-*!&(,)#(%+*!&$,- 73=86>:<54;935469:<=8;>7576983=:;>4<68=37>;45<:9=<4>;:5389674>6:=389;75<,*+!(#% -)$&*-)(&% +!$#,-,(&!*+%$#) ()#*%+$!& ,-+(!#*,-$)& %)+ %#$!-*,&(7;>8<=:69435398657<>4;=:5:<94;=73>8664>3:=;89<75=68>375;49<:4=<:>;853796,$#! +%(&)*-*&!(-, #)$+%-% &)$+,*#!(","I 4/m -3 2/m":" !#$%#$!& %&# !#$%&$!& %!# %#$!&$%& ! &%$&!$#% # #%$#!$&% &!#!$#% &! &%$$%& !& %#$!#&$%& !# %#$!%&$!& %# !#$%$#! #% &!$&$&! &% #!$#%&% &!$#%$#! ()+*,+*)-(,-+()+*,-*)-(,)+(,+*)-*,-()(-,*-)*+,(+(+,*+)*-,(-)+)*+,(-)(-,**,-()-(,+*)+-*,-()+(,+*),-*)-(,+()+*,*+)(+,(-)*-*-)(-,(+)*+,-,(-)*+,*+)(","I 41/a -3 2/d":" !#*%+$)-(,&# !+*%-$)&(,!# %+*)-$,&(:3=8<>7694;5;54697<>83=:97654;=:3>8<$%&(!- ,+*)#&$%-(!+ ,#*)%&$!-(,+ )#*4<97358;=:6>6>:;=8357<94=8;>:694<573()+$,#*!& %-+()#$,&*!- %)+(,#$!&*%- 7;>46=:<5839398<5:6=4;>75:<983>7;=46*,- )&(%#$!+-*,& )#(%+$!,-*)& %#(!+$865:;943>7<=<=73>4;9:658>43=7<5869:;","P 1 1 2":" !#$%#","P 1 1 21":" !#$%+","B 1 1 2":" !#$%#(g+*%+","A 1 2 1":" !#$!& )+$)-","C 1 21 1":" !#$)&()#*!&","I 1 2 1":" !#$!&.'/0'2","I 1 21 1":" !#$)&.'/0!-","P 1 1 m":" !# !&","P 1 1 b":" !# )&","B 1 1 m":" !# !&(!+(!-","B 1 1 b":" !# )&(!+()-","P 1 1 2/m":" !# !&$%#$%&","P 1 1 21/m":" !#$%+$%& !-","B 1 1 2/m":" !# !&$%#$%&(!+(!-*%+*%-","P 1 1 2/b":" !#$,#$%& )&","P 1 1 21/b":" !#$%&$,+ )-","B 1 1 2/b":" !#$,#$%& )&(!+*,+*%-()-","P 21 2 2":" !#$!&(%&*%#","P 2 21 2":" !# ,&$)&$%#","P 21 21 2 (a)":" !#*,#.%&$'&","P 21 2 21":" !#$!&(%-*%+","P 2 21 21":" !# %&$)-$,+","C 2 2 21a)":" !#*%+(,&$)-()#$,+ %&*!-","C 2 2 2a":" !#*,#.%&$'&()#$%# ,&*!&","F 2 2 2a":" !#*,#.%&$'& '/*%/.12$!2.!/$,/ %20'2.'#$%# 1&0!&","I 2 2 2a":" !#*,#.%&$'&()+$%+*!- ,-","P 21/m 21/m 2/n a":" !#*,#$)&(%&$%&.'& ,#*!#","P 42 21 2a":" !#*,#%.+'$+$'&.%&! -,*-","I 2 3a":" !#*,#.%&$'&!# ,- '&$%/$# !-*!/$%&.%()+$%+ ,-*!-)+(%&(!-*,#*+()&$)#*,- ,"},sT=/^[1-9]$/;function fb(t){let e="";return t.length>0&&(e=":"+lm(t).join(" OR :")),new qt(e)}class Yr{constructor(e=""){this.name=e,this.partList=[]}get type(){return"Assembly"}addPart(e,n){const i=new oT(e,n);return this.partList.push(i),i}getAtomCount(e){return this.partList.reduce((n,i)=>n+i.getAtomCount(e),0)}getResidueCount(e){return this.partList.reduce((n,i)=>n+i.getResidueCount(e),0)}getInstanceCount(){let e=0;return this.partList.forEach(function(n){e+=n.matrixList.length}),e}isIdentity(e){if(this.partList.length!==1)return!1;const n=this.partList[0];if(n.matrixList.length!==1||!new Ie().equals(n.matrixList[0]))return!1;let i=[];return e.eachChain(function(r){i.push(r.chainname)}),i=lm(i),n.chainList.length===i.length}getBoundingBox(e){const n=new Ut;return this.partList.forEach(function(i){const r=i.getBoundingBox(e);n.expandByPoint(r.min),n.expandByPoint(r.max)}),n}getCenter(e){return this.getBoundingBox(e).getCenter(new T)}getSelection(){let e=[];return this.partList.forEach(function(n){e=e.concat(n.chainList)}),fb(e)}}class oT{constructor(e=[],n=[]){this.matrixList=e,this.chainList=n}get type(){return"AssemblyPart"}_getCount(e,n){let i=0;return e.eachChain(r=>{(this.chainList.length===0||this.chainList.includes(r.chainname))&&(i+=r[n])}),this.matrixList.length*i}getAtomCount(e){return this._getCount(e,"atomCount")}getResidueCount(e){return this._getCount(e,"residueCount")}getBoundingBox(e){const n=new Ut,i=new Ut,r=this.getSelection(),s=e.getBoundingBox(r);return this.matrixList.forEach(function(o){i.copy(s).applyMatrix4(o),n.expandByPoint(i.min),n.expandByPoint(i.max)}),n}getSelection(){return fb(this.chainList)}getView(e){const n=this.getSelection();return n?e.getView(n):e}getInstanceList(){const e=[];for(let n=0,i=this.matrixList.length;n<i;++n)e.push({id:n+1,name:n,matrix:this.matrixList[n]});return e}}class aT{constructor(e){this.structure=e,this.currentModelindex=null,this.currentChainid=null,this.currentResname=null,this.currentResno=null,this.currentInscode=void 0,this.currentHetero=null,this.previousResname="",this.previousHetero=null,this.ai=-1,this.ri=-1,this.ci=-1,this.mi=-1}addResidueType(e){const n=this.structure.atomStore,i=this.structure.residueStore,r=this.structure.residueMap,s=i.atomCount[e],o=i.atomOffset[e],a=new Array(s);for(let c=0;c<s;++c)a[c]=n.atomTypeId[o+c];i.residueTypeId[e]=r.add(this.previousResname,a,this.previousHetero)}addAtom(e,n,i,r,s,o,a,c){const l=this.structure.atomStore,h=this.structure.residueStore,u=this.structure.chainStore,f=this.structure.modelStore;let d=!1,p=!1,y=!1;this.currentModelindex!==e?(d=!0,p=!0,y=!0,this.mi+=1,this.ci+=1,this.ri+=1):this.currentChainid!==i?(p=!0,y=!0,this.ci+=1,this.ri+=1):this.currentResno===s&&this.currentResname===r&&this.currentInscode===c||(y=!0,this.ri+=1),this.ai+=1,d&&(f.growIfFull(),f.chainOffset[this.mi]=this.ci,f.chainCount[this.mi]=0,f.count+=1,u.modelIndex[this.ci]=this.mi),p&&(u.growIfFull(),u.setChainname(this.ci,n),u.setChainid(this.ci,i),u.residueOffset[this.ci]=this.ri,u.residueCount[this.ci]=0,u.count+=1,u.modelIndex[this.ci]=this.mi,f.chainCount[this.mi]+=1,h.chainIndex[this.ri]=this.ci),y&&(this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,this.ri>0&&this.addResidueType(this.ri-1),h.growIfFull(),h.resno[this.ri]=s,a!==void 0&&(h.sstruc[this.ri]=a.charCodeAt(0)),c!==void 0&&(h.inscode[this.ri]=c.charCodeAt(0)),h.atomOffset[this.ri]=this.ai,h.atomCount[this.ri]=0,h.count+=1,h.chainIndex[this.ri]=this.ci,u.residueCount[this.ci]+=1),l.count+=1,l.residueIndex[this.ai]=this.ri,h.atomCount[this.ri]+=1,this.currentModelindex=e,this.currentChainid=i,this.currentResname=r,this.currentResno=s,this.currentInscode=c,this.currentHetero=o}finalize(){this.previousResname=this.currentResname,this.previousHetero=this.currentHetero,this.ri>-1&&this.addResidueType(this.ri)}}function pb(t,e){if(!e)return;Ce&&fe.time("assignSecondaryStructure");const n=[];t.eachModel(function(l){l.eachChain(function(h){n.push(h.chainname)})});const i=n.slice().sort(),r=[];i.forEach(function(l){r.push(n.indexOf(l))});const s=e.helices.filter(function(l){return ls(i,l[0])>=0});s.sort(function(l,h){const u=l[0],f=h[0],d=l[1],p=h[1];if(u===f)return d===p?0:d<p?-1:1;{const y=ls(i,u),g=ls(i,f);return r[y]<r[g]?-1:1}});const o=t.residueStore;t.eachModel(function(l){let h=0;const u=s.length;if(u===0)return;let f=s[h],d=!1,p=!1;l.eachChain(function(y){let g=!1;if(y.chainname===f[0]){const m=y.residueCount,x=y.residueOffset,v=x+m;for(let b=x;b<v;++b)if(o.resno[b]===f[1]&&o.getInscode(b)===f[2]&&(d=!0),d&&(o.sstruc[b]=f[6],o.resno[b]===f[4]&&o.getInscode(b)===f[5]&&(d=!1,h+=1,h<u?(b=x-1,f=s[h],g=y.chainname!==f[0]):p=!0)),g||p)return}})});const a=e.sheets.filter(function(l){return ls(i,l[0])>=0});a.sort(function(l,h){const u=l[0],f=h[0];if(u===f)return 0;const d=ls(i,u),p=ls(i,f);return r[d]<r[p]?-1:1});const c=101;t.eachModel(function(l){let h=0;const u=a.length;if(u===0)return;let f=a[h],d=!1,p=!1;l.eachChain(function(y){let g=!1;if(y.chainname===f[0]){const m=y.residueCount,x=y.residueOffset,v=x+m;for(let b=x;b<v;++b)if(o.resno[b]===f[1]&&o.getInscode(b)===f[2]&&(d=!0),d&&(o.sstruc[b]=c,o.resno[b]===f[4]&&o.getInscode(b)===f[5]&&(d=!1,h+=1,h<u?(b=x-1,f=a[h],g=y.chainname!==f[0]):p=!0)),g||p)return}})}),Ce&&fe.timeEnd("assignSecondaryStructure")}const Gu=function(){const t=function(i,r,s,o){const a=i.structure,c=i.residueIndexStart,l=a.getResidueProxy(),h=a.getResidueProxy(),u=a.getAtomProxy(),f=a.getAtomProxy();for(let d=Math.max(0,r-2);d<=r;++d)for(let p=2;p<5;++p){if(d+p>=i.residueCount)continue;l.index=c+d,h.index=c+d+p,u.index=l.traceAtomIndex,f.index=h.traceAtomIndex;const y=u.distanceTo(f);if(Math.abs(y-s[p-2])>o)return!1}return!0},e=function(i,r){return t(i,r,[5.45,5.18,6.37],2.1)},n=function(i,r){return t(i,r,[6.1,10.4,13],1.42)};return function(i){Ce&&fe.time("calculateSecondaryStructure"),i.eachPolymer(function(r){if(r.residueCount<4)return;if(r.isCg())(function(a){const c=a.residueStore,l=a.residueIndexStart,h=new ub(a).position,u=new T,f=new T;for(let d=0,p=a.residueCount;d<p;++d){u.fromArray(h.center,3*d),f.fromArray(h.center,3*d+3);const y=u.distanceTo(f);y<2&&y>1&&h.bending[d]<20&&(c.sstruc[l+d]=104,c.sstruc[l+d+1]=104)}})(r);else{if(!r.isProtein())return;(function(a){const c=a.residueStore,l=a.residueIndexStart;for(let h=0,u=a.residueCount;h<u;++h){let f="c";e(a,h)?f="h":n(a,h)&&(f="e"),c.sstruc[l+h]=f.charCodeAt(0)}})(r)}let s,o=0;r.eachResidue(function(a){a.sstruc===s?o+=1:(o===1&&(a.index-=1,a.sstruc="c"),o=1,s=a.sstruc)})}),Ce&&fe.timeEnd("calculateSecondaryStructure")}}(),Wd="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function $c(t){const e=Wd.length;let n=t,i=0,r=Wd[n%e];for(;n>=e;)n=Math.floor(n/e),r+=Wd[n%e],i+=1;return i>=5&&fe.warn("chainname overflow"),r}function Uu(t,e=!1){Ce&&fe.time("calculateChainnames");let n=!0;if(t.eachChain(function(i){i.chainname&&(n=!1)}),n){const i=t.modelStore,r=t.chainStore,s=t.residueStore,o=function(y,g,m,x){const v=r.count;for(let b=0;b<x;++b)s.chainIndex[m+b]=v;r.growIfFull(),r.modelIndex[v]=y,r.setChainname(v,g),r.setChainid(v,g),r.residueOffset[v]=m,r.residueCount[v]=x,r.count+=1,i.chainCount[y]+=1},a=t.getAtomProxy(),c=t.getAtomProxy();let l=0,h=0,u=0,f=0;const d=[];s.count===1?d.push({mIndex:0,chainname:"A",rStart:0,rCount:1}):t.eachResidueN(2,function(y,g){let m=!1;const x=y.backboneType,v=g.backboneType,b=Es;f=y.index,y.modelIndex!==g.modelIndex||y.moleculeType!==g.moleculeType?m=!0:x!==b&&x===v&&(a.index=y.backboneEndAtomIndex,c.index=g.backboneStartAtomIndex,m=e?!a.hasBondTo(c):!a.connectedTo(c)),m||g.index!==s.count-1||(m=!0,f=g.index),m&&(d.push({mIndex:h,chainname:$c(l),rStart:u,rCount:f-u+1}),l+=1,y.modelIndex!==g.modelIndex&&(l=0,h+=1),g.index===s.count-1&&f!==g.index&&d.push({mIndex:h,chainname:$c(l),rStart:s.count-1,rCount:1}),u=g.index,f=g.index)}),r.count=0,i.chainCount.fill(0,0,i.count),i.chainOffset.fill(0,0,i.count),d.forEach(function(y){o(y.mIndex,y.chainname,y.rStart,y.rCount)});let p=0;t.eachModel(function(y){i.chainOffset[y.index]=p,p+=i.chainCount[y.index]})}Ce&&fe.timeEnd("calculateChainnames")}function yu(t,e="all"){e!=="none"&&(Ce&&fe.time("calculateBonds"),na(t,!1,e),ia(t),Ce&&fe.timeEnd("calculateBonds"))}const cT={"HIS|CD2|CG":2,"HIS|CE1|ND1":2,"ARG|CZ|NH2":2,"PHE|CE1|CZ":2,"PHE|CD2|CE2":2,"PHE|CD1|CG":2,"TRP|CD1|CG":2,"TRP|CD2|CE2":2,"TRP|CE3|CZ3":2,"TRP|CH2|CZ2":2,"ASN|CG|OD1":2,"GLN|CD|OE1":2,"TYR|CD1|CG":2,"TYR|CD2|CE2":2,"TYR|CE1|CZ":2,"ASP|CG|OD1":2,"GLU|CD|OE1":2,"G|C8|N7":2,"G|C4|C5":2,"G|C2|N3":2,"G|C6|O6":2,"C|C4|N3":2,"C|C5|C6":2,"C|C2|O2":2,"A|C2|N3":2,"A|C6|N1":2,"A|C4|C5":2,"A|C8|N7":2,"U|C5|C6":2,"U|C2|O2":2,"U|C4|O4":2,"DG|C8|N7":2,"DG|C4|C5":2,"DG|C2|N3":2,"DG|C6|O6":2,"DC|C4|N3":2,"DC|C5|C6":2,"DC|C2|O2":2,"DA|C2|N3":2,"DA|C6|N1":2,"DA|C4|C5":2,"DA|C8|N7":2,"DT|C5|C6":2,"DT|C2|O2":2,"DT|C4|O4":2};function i1(t,e,n){return[e,n]=e<n?[e,n]:[n,e],vo.includes(t)&&e==="C"&&n==="O"||tc.includes(t)&&e==="OP1"&&n==="P"?2:cT[`${t}|${e}|${n}`]||1}function na(t,e=!1,n="all"){Ce&&fe.time("calculateBondsWithin");const i=t.bondStore,r=t.rungBondStore,s=t.getAtomSet(!1),o=t.getAtomProxy(),a=t.getAtomProxy(),c=t.getBondProxy(),l=e?null:function(u){Ce&&fe.time("calculateAtomBondMap");var f=[];return u.eachBond(function(d){var p=d.atomIndex1,y=d.atomIndex2;f[p]===void 0&&(f[p]=[]),f[p][y]=d.index}),Ce&&fe.timeEnd("calculateAtomBondMap"),f}(t);let h;e||n!=="auto"||(h=new Set,l.forEach((u,f)=>{h.add(f),u.forEach(d=>{h.add(d)})})),t.eachResidue(function(u){if(!e&&l){const p=u.atomCount,y=u.atomOffset;if(p>500)return void fe.warn("more than 500 atoms, skip residue for auto-bonding",u.qualifiedName());if(n==="auto"&&u.hetero){for(let _=u.atomOffset;_<u.atomEnd;_++)if(h.has(_))return}const g=u.getBonds(),m=g.atomIndices1,x=g.atomIndices2,v=g.bondOrders,b=m.length;for(let _=0;_<b;++_){const C=m[_],w=x[_],S=C+y,M=w+y,B=l[S];B!==void 0&&B[M]!==void 0?(c.index=B[M],v[u.residueType.getBondIndex(C,w)]=c.bondOrder):(o.index=S,a.index=M,i.addBond(o,a,v[_]))}}const f=u.residueType.traceAtomIndex,d=u.residueType.rungEndAtomIndex;f!==-1&&d!==-1&&(o.index=u.traceAtomIndex,a.index=u.rungEndAtomIndex,r.addBond(o,a),s.set(o.index),s.set(a.index))}),t.atomSetDict.rung=s,Ce&&fe.timeEnd("calculateBondsWithin")}function ia(t,e=!1,n=!1){Ce&&fe.time("calculateBondsBetween");const i=t.bondStore,r=t.backboneBondStore,s=t.getAtomSet(!1),o=t.getAtomProxy(),a=t.getAtomProxy();function c(u,f){const d=u.backboneType,p=f.backboneType;if(d!==Es&&d===p){o.index=u.backboneEndAtomIndex,a.index=f.backboneStartAtomIndex;let y=!1,g=!1;n&&o.hasBondTo(a)?(y=!1,g=!0):o.connectedTo(a)&&(y=!e,g=!0),y&&i.addBond(o,a,1),g&&(o.index=u.traceAtomIndex,a.index=f.traceAtomIndex,r.addBond(o,a),s.set(o.index),s.set(a.index))}}r.count===0&&r.resize(t.residueStore.count),t.eachResidueN(2,c);const l=t.getResidueProxy(),h=t.getResidueProxy();if(t.eachChain(function(u){u.residueCount!==0&&(l.index=u.residueOffset,h.index=u.residueOffset+u.residueCount-1,c(h,l))}),t.atomSetDict.backbone=s,!e){Ce&&fe.time("calculateBondsBetween inter");const u=t.spatialHash;t.eachResidue(function(f){f.backboneType!==Es||f.isWater()||f.eachAtom(function(d){d.isMetal()||u.eachWithin(d.x,d.y,d.z,4,function(p){a.index=p,d.modelIndex!==a.modelIndex||d.residueIndex===a.residueIndex||a.isMetal()||i.addBondIfConnected(d,a,1)})})}),Ce&&fe.timeEnd("calculateBondsBetween inter")}Ce&&fe.timeEnd("calculateBondsBetween")}function xu(t){if(!t.unitcell)return;Ce&&fe.time("buildUnitcellAssembly");const e=t.unitcell,n=t.center.clone().applyMatrix4(e.cartToFrac),i=n.clone().floor(),r=function(p){const y=rT[p],g={};if(y===void 0)return console.warn(`spacegroup '${p}' not found in symop library`),g;const m=[];for(let x=0,v=y.length;x<v;x+=3){const b=[];for(let _=0;_<3;++_)b.push(iT[y[x+_]]);m.push(b)}return m.forEach(function(x){let v=0;const b=new Ie().set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1),_=b.elements;g[x.toString()]=b,x.forEach(function(C){let w=!1,S=!1;for(let M=0,B=C.length;M<B;++M){const L=C[M];if(L==="-")w=!0;else if(L==="+")w=!1;else if(L==="/")S=!0;else if(L==="X")_[0+v]=w?-1:1;else if(L==="Y")_[4+v]=w?-1:1;else if(L==="Z")_[8+v]=w?-1:1;else if(sT.test(L)){const U=parseInt(L);S?_[12+v]/=U:_[12+v]=U}else fe.warn(`getSymmetryOperations: unknown token '${L}'`)}v+=1})}),g}(e.spacegroup),s=new T,o=new T;function a(p){const y=[];return Object.keys(r).forEach(function(g){const m=r[g].clone();s.copy(n).applyMatrix4(m).floor(),o.setFromMatrixPosition(m),o.sub(s),o.add(i),p&&o.add(p),m.setPosition(o),m.multiplyMatrices(e.fracToCart,m),m.multiply(e.cartToFrac),y.push(m)}),y}const c=new Yr("UNITCELL"),l=a(),h=[];if(t.biomolDict.NCS){h.push(new Ie,...t.biomolDict.NCS.partList[0].matrixList);const p=[];l.forEach(y=>{h.forEach(g=>{p.push(y.clone().multiply(g))})}),c.addPart(p)}else c.addPart(l);const u=new T,f=new Yr("SUPERCELL"),d=Array.prototype.concat.call(a(u.set(1,0,0)),a(u.set(0,1,0)),a(u.set(0,0,1)),a(u.set(-1,0,0)),a(u.set(0,-1,0)),a(u.set(0,0,-1)),a(u.set(1,1,0)),a(u.set(1,0,1)),a(u.set(0,1,1)),a(u.set(-1,-1,0)),a(u.set(-1,0,-1)),a(u.set(0,-1,-1)),a(u.set(1,-1,-1)),a(u.set(1,1,-1)),a(u.set(1,-1,1)),a(u.set(-1,1,1)),a(u.set(-1,-1,1)),a(u.set(-1,1,-1)),a(u.set(0,1,-1)),a(u.set(0,-1,1)),a(u.set(1,0,-1)),a(u.set(-1,0,1)),a(u.set(1,-1,0)),a(u.set(-1,1,0)),a(),a(u.set(1,1,1)),a(u.set(-1,-1,-1)));if(t.biomolDict.NCS){const p=[];d.forEach(function(y){h.forEach(function(g){p.push(y.clone().multiply(g))})}),f.addPart(p)}else f.addPart(d);t.biomolDict.UNITCELL=c,t.biomolDict.SUPERCELL=f,Ce&&fe.timeEnd("buildUnitcellAssembly")}const r1=["H","C","O","N","S","P"],lT=["NA","CL","FE"];function xm(t){let e=t.toUpperCase(),n=0,i=0;for(let s=0;s<e.length;s++)if(e.charCodeAt(s)<65){if(i>0)break;++n}else i=s+1;(n>0||i<e.length)&&(e=e.substring(n,i));const r=e.length;if(r===0)return"";if(r===1)return e;if(r===2){if(lT.indexOf(e)!==-1)return e;if(r1.indexOf(e[0])!==-1)return e[0];if(e in qx)return e}return r>=3&&r1.indexOf(e[0])!==-1?e[0]:""}function Is(t){const e=t.bondHash,n=e.countArray,i=e.offsetArray,r=e.indexArray,s=t.getBondProxy();t.eachResidue(function(o){const a=o.residueType;if(a.bonds!==void 0)return;var c=o.atomOffset,l=[],h=[],u=[],f={};const d=c+o.atomCount;o.eachAtom(function(p){const y=p.index,g=i[y];for(let m=0,x=n[y];m<x;++m){s.index=r[g+m];let v=s.atomIndex1;if(v<c||v>=d)continue;let b=s.atomIndex2;if(b<c||b>=d)continue;if(v>b){const C=b;b=v,v=C}const _=v+"|"+b;f[_]===void 0&&(f[_]=!0,l.push(v-c),h.push(b-c),u.push(s.bondOrder))}}),a.bonds={atomIndices1:l,atomIndices2:h,bondOrders:u}})}const hT=[3,11,19,37,55,87],uT=[4,12,20,38,56,88],dT=[6,15,16,34],fT=[1,7,8,9,17,35,53],pT=[2,10,18,36,54,86],mT=[13,30,31,48,49,50,80,81,82,83,84,85,112],gT=[5,14,32,33,51,52,85],yT=[9,17,35,53,85];class xT{constructor(e,n,i){this.structure=e,this.atomname=n,i=i||xm(n),this.element=i,this.number=qx[i]||0,this.vdw=KA[this.number]||2,this.covalent=JA[this.number]||1.6}getDefaultValence(){const e=H0[this.number];return e?e[0]:-1}getValenceList(){return H0[this.number]||[]}getOuterShellElectronCount(){return QA[this.number]||2}isMetal(){return this.isAlkaliMetal()||this.isAlkalineEarthMetal()||this.isLanthanide()||this.isActinide()||this.isTransitionMetal()||this.isPostTransitionMetal()}isNonmetal(){return this.isDiatomicNonmetal()||this.isPolyatomicNonmetal()||this.isNobleGas()}isMetalloid(){return gT.includes(this.number)}isHalogen(){return yT.includes(this.number)}isDiatomicNonmetal(){return fT.includes(this.number)}isPolyatomicNonmetal(){return dT.includes(this.number)}isAlkaliMetal(){return hT.includes(this.number)}isAlkalineEarthMetal(){return uT.includes(this.number)}isNobleGas(){return pT.includes(this.number)}isTransitionMetal(){const e=this.number;return e>=21&&e<=29||e>=39&&e<=47||e>=72&&e<=79||e>=104&&e<=108}isPostTransitionMetal(){return mT.includes(this.number)}isLanthanide(){return this.number>=57&&this.number<=71}isActinide(){return this.number>=89&&this.number<=103}}class bT{constructor(e){this.structure=e,this.dict={},this.list=[],this.structure=e}add(e,n){const i=function(s,o){return s+"|"+o}(e=e.toUpperCase(),n=n?n.toUpperCase():xm(e));let r=this.dict[i];if(r===void 0){const s=new xT(this.structure,e,n);r=this.list.length,this.dict[i]=r,this.list.push(s)}return r}get(e){return this.list[e]}}class vT{constructor(e,n,i,r,s,o){this.structure=e,this.bondReferenceAtomIndices=[],this.resname=n,this.atomTypeIdList=i,this.hetero=r?1:0,this.chemCompType=s,this.bonds=o,this.atomCount=i.length,this.moleculeType=this.getMoleculeType(),this.backboneType=this.getBackboneType(0),this.backboneEndType=this.getBackboneType(-1),this.backboneStartType=this.getBackboneType(1),this.backboneIndexList=this.getBackboneIndexList();const a=Xa[this.backboneType],c=Xa[this.backboneStartType],l=Xa[this.backboneEndType],h=this.getAtomIndexByName(a.trace);this.traceAtomIndex=I(h,-1);const u=this.getAtomIndexByName(a.direction1);this.direction1AtomIndex=I(u,-1);const f=this.getAtomIndexByName(a.direction2);this.direction2AtomIndex=I(f,-1);const d=this.getAtomIndexByName(c.backboneStart);this.backboneStartAtomIndex=I(d,-1);const p=this.getAtomIndexByName(l.backboneEnd);let y;this.backboneEndAtomIndex=I(p,-1),y=tC.includes(n)?this.getAtomIndexByName("N1"):this.getAtomIndexByName("N3"),this.rungEndAtomIndex=I(y,-1)}getBackboneIndexList(){const e=[];let n;switch(this.moleculeType){case 3:n=rC;break;case 4:case 5:n=Zx;break;default:return e}const i=this.structure.atomMap,r=this.atomTypeIdList;for(let s=0,o=this.atomCount;s<o;++s){const a=i.get(r[s]);n.includes(a.atomname)&&e.push(s)}return e}getMoleculeType(){return this.isProtein()?3:this.isRna()?4:this.isDna()?5:this.isWater()?1:this.isIon()?2:this.isSaccharide()?6:0}getBackboneType(e){return this.hasProteinBackbone(e)?1:this.hasRnaBackbone(e)?2:this.hasDnaBackbone(e)?3:this.hasCgProteinBackbone(e)?4:this.hasCgRnaBackbone(e)?5:this.hasCgDnaBackbone(e)?6:Es}isProtein(){return this.chemCompType?qA.includes(this.chemCompType):this.hasAtomWithName("CA","C","N")||vo.includes(this.resname)}isCg(){const e=this.backboneType;return e===4||e===5||e===6}isNucleic(){return this.isRna()||this.isDna()}isRna(){return this.chemCompType?XA.includes(this.chemCompType):this.hetero!==1&&(this.hasAtomWithName(["P","O3'","O3*"],["C4'","C4*"],["O2'","O2*","F2'","F2*"])||Xx.includes(this.resname)&&this.hasAtomWithName(["O2'","O2*","F2'","F2*"]))}isDna(){return this.chemCompType?YA.includes(this.chemCompType):this.hetero!==1&&(this.hasAtomWithName(["P","O3'","O3*"],["C3'","C3*"])&&!this.hasAtomWithName(["O2'","O2*","F2'","F2*"])||Yx.includes(this.resname))}isHetero(){return this.hetero===1}isIon(){return nC.includes(this.resname)}isWater(){return mu.includes(this.resname)}isSaccharide(){return this.chemCompType?Hx.includes(this.chemCompType):iC.includes(this.resname)}isStandardAminoacid(){return vo.includes(this.resname)}isStandardBase(){return tc.includes(this.resname)}hasBackboneAtoms(e,n){const i=Xa[n];return e===-1?this.hasAtomWithName(i.trace,i.backboneEnd,i.direction1,i.direction2):e===0?this.hasAtomWithName(i.trace,i.direction1,i.direction2):e===1?this.hasAtomWithName(i.trace,i.backboneStart,i.direction1,i.direction2):this.hasAtomWithName(i.trace,i.backboneStart,i.backboneEnd,i.direction1,i.direction2)}hasProteinBackbone(e){return this.isProtein()&&this.hasBackboneAtoms(e,1)}hasRnaBackbone(e){return this.isRna()&&this.hasBackboneAtoms(e,2)}hasDnaBackbone(e){return this.isDna()&&this.hasBackboneAtoms(e,3)}hasCgProteinBackbone(e){return this.atomCount<7&&this.isProtein()&&this.hasBackboneAtoms(e,4)}hasCgRnaBackbone(e){return this.atomCount<11&&this.isRna()&&this.hasBackboneAtoms(e,5)}hasCgDnaBackbone(e){return this.atomCount<11&&this.isDna()&&this.hasBackboneAtoms(e,6)}hasBackbone(e){return this.hasProteinBackbone(e)||this.hasRnaBackbone(e)||this.hasDnaBackbone(e)||this.hasCgProteinBackbone(e)||this.hasCgRnaBackbone(e)||this.hasCgDnaBackbone(e)}getAtomIndexByName(e){const n=this.atomCount,i=this.structure.atomMap,r=this.atomTypeIdList;if(Array.isArray(e))for(let s=0;s<n;++s){const o=r[s];if(e.includes(i.get(o).atomname))return s}else for(let s=0;s<n;++s){const o=r[s];if(e===i.get(o).atomname)return s}}hasAtomWithName(...e){const n=e.length;for(let i=0;i<n;++i)if(e[i]!==void 0&&this.getAtomIndexByName(e[i])===void 0)return!1;return!0}getBonds(e){return this.bonds===void 0&&(this.bonds=function(n){const i=n.structure,r=i.getAtomProxy(),s=i.getAtomProxy(),o=n.atomCount,a=n.atomOffset,c=a+o-1,l=[],h=[],u=[];if(o>500)Ce&&fe.warn("more than 500 atoms, skip residue for auto-bonding",n.qualifiedName());else if(o>50){const f=new nT(n,!0),d=n.isCg()?1.2:2.3;for(let p=a;p<c;++p){r.index=p;const y=r.covalent+d+.3,g=f.nearest(r,1/0,y*y),m=g.length;for(let x=0;x<m;++x)s.index=g[x].index,r.index<s.index&&r.connectedTo(s)&&(l.push(r.index-a),h.push(s.index-a),u.push(i1(r.resname,r.atomname,s.atomname)))}}else for(let f=a;f<c;++f){r.index=f;for(let d=f+1;d<=c;++d)s.index=d,r.connectedTo(s)&&(l.push(f-a),h.push(d-a),u.push(i1(r.resname,r.atomname,s.atomname)))}return{atomIndices1:l,atomIndices2:h,bondOrders:u}}(e)),this.bonds}getRings(){return this.rings===void 0&&this.calculateRings(),this.rings}getBondGraph(){return this.bondGraph===void 0&&this.calculateBondGraph(),this.bondGraph}getAromatic(e){return this.aromaticAtoms===void 0&&this.calculateAromatic(this.structure.getResidueProxy(e.residueIndex)),this.aromaticAtoms}getAromaticRings(e){return this.aromaticRings===void 0&&this.calculateAromatic(e),this.aromaticRings}calculateBondGraph(){const e=this.bondGraph={},n=this.getBonds(),i=n.atomIndices1.length,r=n.atomIndices1,s=n.atomIndices2;for(let o=0;o<i;++o){const a=r[o],c=s[o];(e[a]=e[a]||[]).push(c),(e[c]=e[c]||[]).push(a)}}calculateRings(){const e=function(n,i){const r={count:i,visited:new Int32Array(i),queue:new Int32Array(i),pred:new Int32Array(i),left:new Int32Array(nc),right:new Int32Array(nc),color:new Int32Array(i),currentColor:0,rings:[],atomRings:[],bonds:n};for(let s=0;s<i;s++)r.visited[s]=-1,r.pred[s]=-1;return r}(this.getBondGraph(),this.atomCount);for(let n=0;n<e.count;n++)e.visited[n]>=0||MT(e,n);this.rings={atomRings:e.atomRings,rings:e.rings}}isAromatic(e){return this.aromaticAtoms=this.getAromatic(e),this.aromaticAtoms[e.index-e.residueAtomOffset]===1}calculateAromatic(e){const n=this.aromaticAtoms=new Uint8Array(this.atomCount),i=this.getRings().rings,r=i.map(o=>function(a){if(a.some(u=>!_T.includes(u.number)))return!1;let c=0;const l=new Pt(3,a.length),h=l.data;return a.forEach(u=>{h[c+0]=u.x,h[c+1]=u.y,h[c+2]=u.z,c+=3}),new hb(l).vecC.length()<wT}(o.map(a=>this.structure.getAtomProxy(a+e.atomOffset)))),s=this.aromaticRings=[];i.forEach((o,a)=>{r[a]&&(s.push(o),o.forEach(c=>n[c]=1))})}assignBondReferenceAtomIndices(){const e=this.getBondGraph(),n=this.getRings(),i=n.atomRings,r=n.rings,s=this.bonds,o=s.atomIndices1,a=s.atomIndices2,c=s.bondOrders,l=this.bondReferenceAtomIndices,h=s.atomIndices1.length;l.length=0;for(let u=0;u<h;++u){if(c[u]<=1)continue;let f;const d=o[u],p=a[u],y=i[d],g=i[p];if(y&&g){for(let m=0;m<y.length;m++)if(g.indexOf(y[m])!==-1){f=r[y[m]];break}}if(e[d].length>1)for(let m=0;m<e[d].length;++m){const x=e[d][m];if(x!==p&&(f===void 0||f.indexOf(x)!==-1)){l[u]=x;break}}else if(e[p].length>1)for(let m=0;m<e[p].length;++m){const x=e[p][m];if(x!==d&&(f===void 0||f.indexOf(x)!==-1)){l[u]=x;break}}}}getBondIndex(e,n){const i=this.bonds,r=i.atomIndices1,s=i.atomIndices2;let o=r.indexOf(e),a=s.indexOf(n);const c=a;for(;o!==-1;){for(;a!==-1;){if(o===a)return o;a=s.indexOf(n,a+1)}o=r.indexOf(e,o+1),a=c}}getBondReferenceAtomIndex(e,n){const i=this.getBondIndex(e,n);if(i!==void 0)return this.bondReferenceAtomIndices.length===0&&this.assignBondReferenceAtomIndices(),this.bondReferenceAtomIndices[i]}}const _T=[5,6,7,8,14,15,16,32,33,50,51,83],wT=.05;function ST(t,e,n){if(n<e)return;const{pred:i,color:r,left:s,right:o}=t,a=++t.currentColor;let c=e;for(let m=0;m<nc&&(r[c]=a,c=i[c],!(c<0));m++);let l=0,h=0,u=!1,f=0;c=n;for(let m=0;m<nc;m++){if(r[c]===a){f=c,u=!0;break}if(o[h++]=c,c=i[c],c<0)break}if(!u)return;c=e;for(let m=0;m<nc&&(s[l++]=c,f!==c)&&(c=i[c],!(c<0));m++);const d=l+h,p=new Array(d);let y=0;for(let m=0;m<l;m++)p[y++]=s[m];for(let m=h-1;m>=0;m--)p[y++]=o[m];const g=t.rings.length;for(let m=0;m<d;++m){const x=p[m];t.atomRings[x]?t.atomRings[x].push(g):t.atomRings[x]=[g]}t.rings.push(p)}function MT(t,e){const{bonds:n,visited:i,queue:r,pred:s}=t;i[e]=1,r[0]=e;let o=0,a=1;for(;o<a;){const c=r[o++],l=0;if(n[c]===void 0)continue;const h=n[c].length;for(let u=l;u<h;u++){const f=n[c][u];i[f]>0?s[f]!==c&&s[c]!==f&&ST(t,c,f):(i[f]=1,r[a++]=f,s[f]=c)}}}const nc=4;class AT{constructor(e){this.structure=e,this.dict={},this.list=[]}add(e,n,i,r="",s){const o=function(c,l,h,u=""){return c+"|"+l.join(",")+"|"+(h?1:0)+"|"+u}(e=e.toUpperCase(),n,i,r);let a=this.dict[o];if(a===void 0){const c=new vT(this.structure,e,n,i,r,s);a=this.list.length,this.dict[o]=a,this.list.push(c)}return a}get(e){return this.list[e]}}class bm{constructor(e,n=0){this.structure=e,this.index=n,this.bondStore=e.bondStore,this._v12=new T,this._v13=new T,this._ap1=this.structure.getAtomProxy(),this._ap2=this.structure.getAtomProxy(),this._ap3=this.structure.getAtomProxy()}get atom1(){return this.structure.getAtomProxy(this.atomIndex1)}get atom2(){return this.structure.getAtomProxy(this.atomIndex2)}get atomIndex1(){return this.bondStore.atomIndex1[this.index]}set atomIndex1(e){this.bondStore.atomIndex1[this.index]=e}get atomIndex2(){return this.bondStore.atomIndex2[this.index]}set atomIndex2(e){this.bondStore.atomIndex2[this.index]=e}get bondOrder(){return this.bondStore.bondOrder[this.index]}set bondOrder(e){this.bondStore.bondOrder[this.index]=e}getOtherAtomIndex(e){return e===this.atomIndex1?this.atomIndex2:this.atomIndex1}getOtherAtom(e){return this.structure.getAtomProxy(this.getOtherAtomIndex(e.index))}getReferenceAtomIndex(){const e=this._ap1,n=this._ap2;if(e.index=this.atomIndex1,n.index=this.atomIndex2,e.residueIndex!==n.residueIndex)return;const i=e.index-e.residueAtomOffset,r=n.index-n.residueAtomOffset,s=e.residueType.getBondReferenceAtomIndex(i,r);if(s!==void 0)return s+e.residueAtomOffset;console.warn("No reference atom found",e.index,n.index)}calculateShiftDir(e=new T){const n=this._ap1,i=this._ap2,r=this._ap3,s=this._v12,o=this._v13;n.index=this.atomIndex1,i.index=this.atomIndex2;const a=this.getReferenceAtomIndex();s.subVectors(n,i).normalize(),a!==void 0?(r.index=a,o.subVectors(n,r)):o.copy(n),o.normalize();let c=s.dot(o);return 1-Math.abs(c)<1e-5&&(o.set(1,0,0),c=s.dot(o),1-Math.abs(c)<1e-5&&(o.set(0,1,0),c=s.dot(o))),e.copy(o.sub(s.multiplyScalar(c))).normalize()}qualifiedName(){return this.atomIndex1+"="+this.atomIndex2}clone(){return new bm(this.structure,this.index)}toObject(){return{atomIndex1:this.atomIndex1,atomIndex2:this.atomIndex2,bondOrder:this.bondOrder}}}class vm{constructor(e,n=0){this.structure=e,this.index=n,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueMap=e.residueMap,this.atomMap=e.atomMap}get entity(){return this.structure.entityList[this.entityIndex]}get entityIndex(){return this.chainStore.entityIndex[this.chainIndex]}get chain(){return this.structure.getChainProxy(this.chainIndex)}get chainIndex(){return this.residueStore.chainIndex[this.index]}set chainIndex(e){this.residueStore.chainIndex[this.index]=e}get atomOffset(){return this.residueStore.atomOffset[this.index]}set atomOffset(e){this.residueStore.atomOffset[this.index]=e}get atomCount(){return this.residueStore.atomCount[this.index]}set atomCount(e){this.residueStore.atomCount[this.index]=e}get atomEnd(){return this.atomOffset+this.atomCount-1}get modelIndex(){return this.chainStore.modelIndex[this.chainIndex]}get chainname(){return this.chainStore.getChainname(this.chainIndex)}get chainid(){return this.chainStore.getChainid(this.chainIndex)}get resno(){return this.residueStore.resno[this.index]}set resno(e){this.residueStore.resno[this.index]=e}get sstruc(){return this.residueStore.getSstruc(this.index)}set sstruc(e){this.residueStore.setSstruc(this.index,e)}get inscode(){return this.residueStore.getInscode(this.index)}set inscode(e){this.residueStore.setInscode(this.index,e)}get residueType(){return this.residueMap.get(this.residueStore.residueTypeId[this.index])}get resname(){return this.residueType.resname}get hetero(){return this.residueType.hetero}get moleculeType(){return this.residueType.moleculeType}get backboneType(){return this.residueType.backboneType}get backboneStartType(){return this.residueType.backboneStartType}get backboneEndType(){return this.residueType.backboneEndType}get traceAtomIndex(){return this.residueType.traceAtomIndex+this.atomOffset}get direction1AtomIndex(){return this.residueType.direction1AtomIndex+this.atomOffset}get direction2AtomIndex(){return this.residueType.direction2AtomIndex+this.atomOffset}get backboneStartAtomIndex(){return this.residueType.backboneStartAtomIndex+this.atomOffset}get backboneEndAtomIndex(){return this.residueType.backboneEndAtomIndex+this.atomOffset}get rungEndAtomIndex(){return this.residueType.rungEndAtomIndex+this.atomOffset}get x(){let e=0;for(let n=this.atomOffset;n<=this.atomEnd;++n)e+=this.atomStore.x[n];return e/this.atomCount}get y(){let e=0;for(let n=this.atomOffset;n<=this.atomEnd;++n)e+=this.atomStore.y[n];return e/this.atomCount}get z(){let e=0;for(let n=this.atomOffset;n<=this.atomEnd;++n)e+=this.atomStore.z[n];return e/this.atomCount}eachAtom(e,n){const i=this.atomCount,r=this.atomOffset,s=this.structure._ap,o=r+i;if(n&&n.atomOnlyTest){const a=n.atomOnlyTest;for(let c=r;c<o;++c)s.index=c,a(s)&&e(s)}else for(let a=r;a<o;++a)s.index=a,e(s)}positionToArray(e=[],n=0){return e[n+0]=this.x,e[n+1]=this.y,e[n+2]=this.z,e}isProtein(){return this.residueType.moleculeType===3}isNucleic(){const e=this.residueType.moleculeType;return e===4||e===5}isRna(){return this.residueType.moleculeType===4}isDna(){return this.residueType.moleculeType===5}isCg(){const e=this.residueType.backboneType;return e===4||e===5||e===6}isPolymer(){if(this.structure.entityList.length>0)return this.entity.isPolymer();{const e=this.residueType.moleculeType;return e===3||e===4||e===5}}isHetero(){return this.residueType.hetero===1}isWater(){return this.residueType.moleculeType===1}isIon(){return this.residueType.moleculeType===2}isSaccharide(){return this.residueType.moleculeType===6}isStandardAminoacid(){return this.residueType.isStandardAminoacid()}isStandardBase(){return this.residueType.isStandardBase()}isHelix(){return $x.includes(this.sstruc)}isSheet(){return Wx.includes(this.sstruc)}isTurn(){return jx.includes(this.sstruc)&&this.isProtein()}getAtomType(e){return this.atomMap.get(this.atomStore.atomTypeId[e])}getResname1(){return pu[this.resname.toUpperCase()]||"X"}getBackboneType(e){switch(e){case-1:return this.residueType.backboneStartType;case 1:return this.residueType.backboneEndType;default:return this.residueType.backboneType}}getAtomIndexByName(e){let n=this.residueType.getAtomIndexByName(e);return n!==void 0&&(n+=this.atomOffset),n}hasAtomWithName(e){return this.residueType.hasAtomWithName(e)}getAtomnameList(){console.warn("getAtomnameList - might be expensive");const e=this.atomCount,n=this.atomOffset,i=new Array(e);for(let r=0;r<e;++r)i[r]=this.getAtomType(n+r).atomname;return i}connectedTo(e){const n=this.structure.getAtomProxy(this.backboneEndAtomIndex),i=this.structure.getAtomProxy(e.backboneStartAtomIndex);return!(!n||!i)&&n.connectedTo(i)}getNextConnectedResidue(){const e=this.chainStore.residueOffset[this.chainIndex],n=this.chainStore.residueCount[this.chainIndex],i=this.index+1;if(i<e+n){const r=this.structure.getResidueProxy(i);if(this.connectedTo(r))return r}else if(i===e+n){const r=this.structure.getResidueProxy(e);if(this.connectedTo(r))return r}}getPreviousConnectedResidue(e){const n=this.chainStore.residueOffset[this.chainIndex],i=this.index-1;if(i>=n){const r=I(e,this.structure.getResidueProxy());if(r.index=i,r.connectedTo(this))return r}else if(i===n-1){const r=this.chainStore.residueCount[this.chainIndex],s=I(e,this.structure.getResidueProxy());if(s.index=n+r-1,s.connectedTo(this))return s}}getBonds(){return this.residueType.getBonds(this)}getRings(){return this.residueType.getRings()}getAromaticRings(){return this.residueType.getAromaticRings(this)}qualifiedName(e=!1){let n="";return this.resname&&!e&&(n+="["+this.resname+"]"),this.resno!==void 0&&(n+=this.resno),this.inscode&&(n+="^"+this.inscode),this.chain&&(n+=":"+this.chainname),n+="/"+this.modelIndex,n}clone(){return new vm(this.structure,this.index)}toObject(){return{index:this.index,chainIndex:this.chainIndex,atomOffset:this.atomOffset,atomCount:this.atomCount,resno:this.resno,resname:this.resname,sstruc:this.sstruc}}}class jd{constructor(e,n,i){this.structure=e,this.residueIndexStart=n,this.residueIndexEnd=i,this.chainStore=e.chainStore,this.residueStore=e.residueStore,this.atomStore=e.atomStore,this.residueCount=i-n+1;const r=this.structure.getResidueProxy(this.residueIndexStart),s=this.structure.getResidueProxy(this.residueIndexEnd);this.isPrevConnected=r.getPreviousConnectedResidue()!==void 0;const o=s.getNextConnectedResidue();this.isNextConnected=o!==void 0,this.isNextNextConnected=o!==void 0&&o.getNextConnectedResidue()!==void 0,this.isCyclic=s.connectedTo(r),this.__residueProxy=this.structure.getResidueProxy()}get chainIndex(){return this.residueStore.chainIndex[this.residueIndexStart]}get modelIndex(){return this.chainStore.modelIndex[this.chainIndex]}get chainname(){return this.chainStore.getChainname(this.chainIndex)}isProtein(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isProtein()}isCg(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isCg()}isNucleic(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.isNucleic()}getMoleculeType(){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.moleculeType}getBackboneType(e){return this.__residueProxy.index=this.residueIndexStart,this.__residueProxy.getBackboneType(e)}getAtomIndexByType(e,n){this.isCyclic?e===-1?e=this.residueCount-1:e===this.residueCount&&(e=0):(e!==-1||this.isPrevConnected||(e+=1),e!==this.residueCount||this.isNextNextConnected||(e-=1));const i=this.__residueProxy;let r;switch(i.index=this.residueIndexStart+e,n){case"trace":r=i.traceAtomIndex;break;case"direction1":r=i.direction1AtomIndex;break;case"direction2":r=i.direction2AtomIndex;break;default:r=i.getAtomIndexByName(n)}return r}eachAtom(e,n){this.eachResidue(function(i){i.eachAtom(e,n)})}eachAtomN(e,n,i){const r=this.residueCount,s=new Array(e);for(let a=0;a<e;++a)s[a]=this.structure.getAtomProxy(this.getAtomIndexByType(a,i));n.apply(this,s);for(var o=e;o<r;++o){for(let a=1;a<e;++a)s[a-1].index=s[a].index;s[e-1].index=this.getAtomIndexByType(o,i),n.apply(this,s)}}eachResidue(e){const n=this.structure.getResidueProxy(),i=this.residueCount,r=this.residueIndexStart;for(let s=0;s<i;++s)n.index=r+s,e(n)}qualifiedName(){const e=this.structure.getResidueProxy(this.residueIndexStart),n=this.structure.getResidueProxy(this.residueIndexEnd);return e.qualifiedName()+" - "+n.qualifiedName()}}class _m{constructor(e,n=0){this.structure=e,this.index=n,this.chainStore=e.chainStore,this.residueStore=e.residueStore}get entity(){return this.structure.entityList[this.entityIndex]}get model(){return this.structure.getModelProxy(this.modelIndex)}get entityIndex(){return this.chainStore.entityIndex[this.index]}set entityIndex(e){this.chainStore.entityIndex[this.index]=e}get modelIndex(){return this.chainStore.modelIndex[this.index]}set modelIndex(e){this.chainStore.modelIndex[this.index]=e}get residueOffset(){return this.chainStore.residueOffset[this.index]}set residueOffset(e){this.chainStore.residueOffset[this.index]=e}get residueCount(){return this.chainStore.residueCount[this.index]}set residueCount(e){this.chainStore.residueCount[this.index]=e}get residueEnd(){return this.residueOffset+this.residueCount-1}get atomOffset(){return this.residueStore.atomOffset[this.residueOffset]}get atomEnd(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1}get atomCount(){return this.residueCount===0?0:this.atomEnd-this.atomOffset+1}get chainname(){return this.chainStore.getChainname(this.index)}set chainname(e){this.chainStore.setChainname(this.index,e)}get chainid(){return this.chainStore.getChainid(this.index)}set chainid(e){this.chainStore.setChainid(this.index,e)}eachAtom(e,n){this.eachResidue(function(i){i.eachAtom(e,n)},n)}eachResidue(e,n){const i=this.residueCount,r=this.residueOffset,s=this.structure._rp,o=r+i;if(n&&n.test){const a=n.residueOnlyTest;if(a)for(let c=r;c<o;++c)s.index=c,a(s)&&e(s);else for(let c=r;c<o;++c)s.index=c,e(s)}else for(let a=r;a<o;++a)s.index=a,e(s)}eachResidueN(e,n){const i=this.residueCount,r=this.residueOffset,s=r+i;if(i<e)return;const o=new Array(e);for(let a=0;a<e;++a)o[a]=this.structure.getResidueProxy(r+a);n.apply(this,o);for(let a=r+e;a<s;++a){for(let c=0;c<e;++c)o[c].index+=1;n.apply(this,o)}}eachPolymer(e,n){let i=0,r=0;const s=n?n.residueOnlyTest:void 0,o=this.model.structure,a=this.residueCount,c=this.residueOffset,l=c+a,h=this.structure.getResidueProxy(),u=this.structure.getResidueProxy(c),f=this.structure.getAtomProxy(),d=this.structure.getAtomProxy();let p=!0;for(let y=c+1;y<l;++y){h.index=u.index,u.index=y;const g=p?h.backboneEndType:h.backboneType,m=u.backboneType;p&&(i=h.index,p=!1),r=u.index,g!==Es&&g===m?(f.index=h.backboneEndAtomIndex,d.index=u.backboneStartAtomIndex,f&&d&&f.connectedTo(d)&&(!s||s(h)&&s(u))||(h.index-i>1&&e(new jd(o,i,h.index)),i=r)):(g!==Es&&h.index-i>1&&e(new jd(o,i,h.index)),i=r)}r-i>1&&this.structure.getResidueProxy(i).backboneEndType&&e(new jd(o,i,r))}qualifiedName(){return":"+this.chainname+"/"+this.modelIndex}clone(){return new _m(this.structure,this.index)}toObject(){return{index:this.index,residueOffset:this.residueOffset,residueCount:this.residueCount,chainname:this.chainname}}}class wm{constructor(e,n=0){this.structure=e,this.index=n,this.modelStore=e.modelStore,this.chainStore=e.chainStore,this.residueStore=e.residueStore}get chainOffset(){return this.modelStore.chainOffset[this.index]}set chainOffset(e){this.modelStore.chainOffset[this.index]=e}get chainCount(){return this.modelStore.chainCount[this.index]}set chainCount(e){this.modelStore.chainCount[this.index]=e}get residueOffset(){return this.chainStore.residueOffset[this.chainOffset]}get atomOffset(){return this.residueStore.atomOffset[this.residueOffset]}get chainEnd(){return this.chainOffset+this.chainCount-1}get residueEnd(){return this.chainStore.residueOffset[this.chainEnd]+this.chainStore.residueCount[this.chainEnd]-1}get atomEnd(){return this.residueStore.atomOffset[this.residueEnd]+this.residueStore.atomCount[this.residueEnd]-1}get residueCount(){return this.chainCount===0?0:this.residueEnd-this.residueOffset+1}get atomCount(){return this.residueCount===0?0:this.atomEnd-this.atomOffset+1}eachAtom(e,n){this.eachChain(function(i){i.eachAtom(e,n)},n)}eachResidue(e,n){this.eachChain(function(i){i.eachResidue(e,n)},n)}eachPolymer(e,n){if(n&&n.chainOnlyTest){const i=n.chainOnlyTest;this.eachChain(function(r){i(r)&&r.eachPolymer(e,n)})}else this.eachChain(function(i){i.eachPolymer(e,n)})}eachChain(e,n){const i=this.chainCount,r=this.chainOffset,s=this.structure._cp,o=r+i;if(n&&n.test){const a=n.chainOnlyTest;if(a)for(let c=r;c<o;++c)s.index=c,a(s)&&e(s);else for(let c=r;c<o;++c)s.index=c,e(s)}else for(let a=r;a<o;++a)s.index=a,e(s)}qualifiedName(){return"/"+this.index}clone(){return new wm(this.structure,this.index)}toObject(){return{index:this.index,chainOffset:this.chainOffset,chainCount:this.chainCount}}}class Bi{constructor(e="",n=""){this.signals={refreshed:new ot.Signal},this.init(e,n)}init(e,n){this.name=e,this.path=n,this.title="",this.id="",this.data={structure:this,"@spatialLookup":void 0,"@valenceModel":void 0},this.header={},this.extraData={},this.atomSetCache={},this.atomSetDict={},this.biomolDict={},this.entityList=[],this.unitcell=void 0,this.frames=[],this.boxes=[],this.validation=void 0,this.bondStore=new Mh(0),this.backboneBondStore=new Mh(0),this.rungBondStore=new Mh(0),this.atomStore=new YC(0),this.residueStore=new ZC(0),this.chainStore=new KC(0),this.modelStore=new JC(0),this.atomMap=new bT(this),this.residueMap=new AT(this),this.bondHash=void 0,this.spatialHash=void 0,this.atomSet=void 0,this.bondSet=void 0,this.center=new T,this.boundingBox=new Ut,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy()}get type(){return"Structure"}finalizeAtoms(){this.atomSet=this.getAtomSet(),this.atomCount=this.atomStore.count,this.boundingBox=this.getBoundingBox(void 0,this.boundingBox),this.center=this.boundingBox.getCenter(new T),this.spatialHash=new Uc(this.atomStore,this.boundingBox)}finalizeBonds(){this.bondSet=this.getBondSet(),this.bondCount=this.bondStore.count,this.bondHash=new XC(this.bondStore,this.atomStore.count),this.atomSetCache={},this.atomSetDict.rung||(this.atomSetDict.rung=this.getAtomSet(!1));for(let e in this.atomSetDict)this.atomSetCache["__"+e]=this.atomSetDict[e].clone()}getBondProxy(e){return new bm(this,e)}getAtomProxy(e){return new zu(this,e)}getResidueProxy(e){return new vm(this,e)}getChainProxy(e){return new _m(this,e)}getModelProxy(e){return new wm(this,e)}getBondSet(){const e=this.bondStore.count,n=new xn(e),i=this.atomSet;if(i)if(i.isAllSet())n.setAll();else if(i.isAllClear())n.clearAll();else{const r=this.getBondProxy();for(let s=0;s<e;++s)r.index=s,i.isSet(r.atomIndex1,r.atomIndex2)&&n.set(r.index)}else n.setAll();return n}getBackboneBondSet(){const e=this.backboneBondStore.count,n=new xn(e),i=this.atomSetCache.__backbone;if(i){const r=this.getBondProxy();r.bondStore=this.backboneBondStore;for(let s=0;s<e;++s)r.index=s,i.isSet(r.atomIndex1,r.atomIndex2)&&n.set(r.index)}else n.setAll();return n}getRungBondSet(){const e=this.rungBondStore.count,n=new xn(e),i=this.atomSetCache.__rung;if(i){const r=this.getBondProxy();r.bondStore=this.rungBondStore;for(let s=0;s<e;++s)r.index=s,i.isSet(r.atomIndex1,r.atomIndex2)&&n.set(r.index)}else n.setAll();return n}getAtomSet(e){const n=this.atomStore.count;if(e===void 0)return new xn(n,!0);if(e instanceof xn)return e;if(e===!0)return new xn(n,!0);if(e&&e.test){const i=e.string;if(i in this.atomSetCache)return this.atomSetCache[i];if(i==="")return new xn(n,!0);{const r=new xn(n);return this.eachAtom(function(s){r.set(s.index)},e),this.atomSetCache[i]=r,r}}return e===!1?new xn(n):new xn(n,!0)}getAtomSetWithinSelection(e,n){const i=this.spatialHash,r=this.getAtomSet(!1),s=this.getAtomProxy();return i&&this.getAtomSet(e).forEach(function(o){s.index=o,i.within(s.x,s.y,s.z,n).forEach(function(a){r.set(a)})}),r}getAtomSetWithinPoint(e,n){const i=e,r=this.getAtomSet(!1);return this.spatialHash&&this.spatialHash.within(i.x,i.y,i.z,n).forEach(function(s){r.set(s)}),r}getAtomSetWithinVolume(e,n,i,r,s){const o=new nr(e,i,r,s),a=o.getDataPosition(),c=a.length,l=o.matrix.getMaxScaleOnAxis(),h=this.getAtomSet(!1);if(!this.spatialHash)return h;for(let u=0;u<c;u+=3)this.spatialHash.within(a[u],a[u+1],a[u+2],l).forEach(function(f){h.set(f)});return h}getAtomSetWithinGroup(e){const n=this.atomStore.residueIndex,i=this.getAtomSet(!1),r=this.getResidueProxy();return this.getAtomSet(e).forEach(function(s){r.index=n[s];for(let o=r.atomOffset;o<=r.atomEnd;++o)i.set(o)}),i}getSelection(){}getStructure(){return this}eachEntity(e,n){this.entityList.forEach(function(i){n!==void 0&&i.getEntityType()!==n||e(i)})}eachBond(e,n){const i=this.getBondProxy();let r;if(n&&n.test&&(r=this.getBondSet(),this.bondSet&&r.intersection(this.bondSet)),r)r.forEach(function(s){i.index=s,e(i)});else{const s=this.bondStore.count;for(let o=0;o<s;++o)i.index=o,e(i)}}eachAtom(e,n){if(n&&n.test)this.eachModel(function(i){i.eachAtom(e,n)},n);else{const i=this.atomStore.count,r=this.getAtomProxy();for(let s=0;s<i;++s)r.index=s,e(r)}}eachResidue(e,n){if(n&&n.test){const i=this.modelStore.count,r=this.getModelProxy(),s=n.modelOnlyTest;if(s)for(let o=0;o<i;++o)r.index=o,s(r)&&r.eachResidue(e,n);else for(let o=0;o<i;++o)r.index=o,r.eachResidue(e,n)}else{const i=this.residueStore.count,r=this.getResidueProxy();for(let s=0;s<i;++s)r.index=s,e(r)}}eachResidueN(e,n){const i=this.residueStore.count;if(i<e)return;const r=new Array(e);for(let s=0;s<e;++s)r[s]=this.getResidueProxy(s);n.apply(this,r);for(let s=e;s<i;++s){for(let o=0;o<e;++o)r[o].index+=1;n.apply(this,r)}}eachPolymer(e,n){if(n&&n.modelOnlyTest){const i=n.modelOnlyTest;this.eachModel(function(r){i(r)&&r.eachPolymer(e,n)})}else this.eachModel(function(i){i.eachPolymer(e,n)})}eachChain(e,n){if(n&&n.test)this.eachModel(function(i){i.eachChain(e,n)});else{const i=this.chainStore.count,r=this.getChainProxy();for(let s=0;s<i;++s)r.index=s,e(r)}}eachModel(e,n){const i=this.modelStore.count,r=this.getModelProxy();if(n&&n.test){const s=n.modelOnlyTest;if(s)for(let o=0;o<i;++o)r.index=o,s(r)&&e(r);else for(let o=0;o<i;++o)r.index=o,e(r)}else for(let s=0;s<i;++s)r.index=s,e(r)}getAtomData(e){const n=Object.assign({},e);n.colorParams&&(n.colorParams.structure=this.getStructure());const i=n.what,r=I(n.atomSet,this.atomSet);let s,o;const a={},c=this.getAtomProxy(),l=r.getSize();i&&!i.position||(a.position=new Float32Array(3*l)),i&&!i.color||!n.colorParams||(a.color=new Float32Array(3*l),o=mt.getScheme(n.colorParams)),i&&!i.picking||(a.picking=new Rs(new Float32Array(l),this.getStructure())),i&&!i.radius||(a.radius=new Float32Array(l),s=new gr(n.radiusParams)),i&&!i.index||(a.index=new Uint32Array(l));const{position:h,color:u,picking:f,radius:d,index:p}=a;return r.forEach((y,g)=>{const m=3*g;c.index=y,h&&c.positionToArray(h,m),u&&o.atomColorToArray(c,u,m),f&&(f.array[g]=y),d&&(d[g]=s.atomRadius(c)),p&&(p[g]=y)}),a}getBondData(e){const n=Object.assign({},e);n.colorParams&&(n.colorParams.structure=this.getStructure());const i=n.what,r=I(n.bondSet,this.bondSet),s=I(n.multipleBond,"off"),o=s!=="off",a=s==="offset",c=I(n.bondScale,.4),l=I(n.bondSpacing,1);let h,u;const f={},d=this.getBondProxy();n.bondStore&&(d.bondStore=n.bondStore);const p=this.getAtomProxy(),y=this.getAtomProxy();let g;if(o){const F=d.bondStore.bondOrder;g=0,r.forEach(function(te){g+=F[te]})}else g=r.getSize();i&&!i.position||(f.position1=new Float32Array(3*g),f.position2=new Float32Array(3*g)),i&&!i.color||!n.colorParams||(f.color=new Float32Array(3*g),f.color2=new Float32Array(3*g),u=mt.getScheme(n.colorParams)),i&&!i.picking||(f.picking=new Jx(new Float32Array(g),this.getStructure(),n.bondStore)),(!i||i.radius||o&&i.position)&&(h=new gr(n.radiusParams)),i&&!i.radius||(f.radius=new Float32Array(g),n.radius2&&(f.radius2=new Float32Array(g)));const{position1:m,position2:x,color:v,color2:b,picking:_,radius:C,radius2:w}=f;let S,M,B,L,U,E,O=0;const k=new T,ne=new T,Y=new T;return r.forEach(F=>{if(M=3*O,d.index=F,p.index=d.atomIndex1,y.index=d.atomIndex2,L=d.bondOrder,m)if(o&&L>1){const te=h.atomRadius(p);E=te*c/(.5*L),d.calculateShiftDir(Y),a?(U=2*l*te,Y.multiplyScalar(U),Y.negate(),ne.subVectors(y,p).multiplyScalar(Math.max(.1,U/1.88)),p.positionToArray(m,M),y.positionToArray(x,M),L>=2&&(k.addVectors(p,Y).add(ne).toArray(m,M+3),k.addVectors(y,Y).sub(ne).toArray(x,M+3),L>=3&&(k.subVectors(p,Y).add(ne).toArray(m,M+6),k.subVectors(y,Y).sub(ne).toArray(x,M+6)))):(U=(l-c)*te,Y.multiplyScalar(U),L===2?(k.addVectors(p,Y).toArray(m,M),k.subVectors(p,Y).toArray(m,M+3),k.addVectors(y,Y).toArray(x,M),k.subVectors(y,Y).toArray(x,M+3)):L===3?(p.positionToArray(m,M),k.addVectors(p,Y).toArray(m,M+3),k.subVectors(p,Y).toArray(m,M+6),y.positionToArray(x,M),k.addVectors(y,Y).toArray(x,M+3),k.subVectors(y,Y).toArray(x,M+6)):(p.positionToArray(m,M),y.positionToArray(x,M)))}else p.positionToArray(m,M),y.positionToArray(x,M);if(v&&b&&(u.bondColorToArray(d,1,v,M),u.bondColorToArray(d,0,b,M),o&&L>1))for(S=1;S<L;++S)B=3*S+M,S0(v,M,B,3),S0(b,M,B,3);if(_&&_.array&&(_.array[O]=F,o&&L>1))for(S=1;S<L;++S)_.array[O+S]=F;if(C&&(C[O]=h.atomRadius(p),o&&L>1))for(E=C[O]*c/(a?1:.5*L),S=a?1:0;S<L;++S)C[O+S]=E;if(w&&(w[O]=h.atomRadius(y),o&&L>1))for(E=w[O]*c/(a?1:.5*L),S=a?1:0;S<L;++S)w[O+S]=E;O+=o?L:1}),f}getBackboneAtomData(e){return e=Object.assign({atomSet:this.atomSetCache.__backbone},e),this.getAtomData(e)}getBackboneBondData(e){return e=Object.assign({bondSet:this.getBackboneBondSet(),bondStore:this.backboneBondStore},e),this.getBondData(e)}getRungAtomData(e){return e=Object.assign({atomSet:this.atomSetCache.__rung},e),this.getAtomData(e)}getRungBondData(e){return e=Object.assign({bondSet:this.getRungBondSet(),bondStore:this.rungBondStore},e),this.getBondData(e)}getBoundingBox(e,n){Ce&&fe.time("getBoundingBox"),n=n||new Ut;let i=1/0,r=1/0,s=1/0,o=-1/0,a=-1/0,c=-1/0;return this.eachAtom(l=>{const h=l.x,u=l.y,f=l.z;h<i&&(i=h),u<r&&(r=u),f<s&&(s=f),h>o&&(o=h),u>a&&(a=u),f>c&&(c=f)},e),n.min.set(i,r,s),n.max.set(o,a,c),Ce&&fe.timeEnd("getBoundingBox"),n}getPrincipalAxes(e){Ce&&fe.time("getPrincipalAxes");let n=0;const i=new Pt(3,this.atomCount),r=i.data;return this.eachAtom(s=>{r[n+0]=s.x,r[n+1]=s.y,r[n+2]=s.z,n+=3},e),Ce&&fe.timeEnd("getPrincipalAxes"),new hb(i)}atomCenter(e){return e?this.getBoundingBox(e).getCenter(new T):this.center.clone()}hasCoords(){if(this._hasCoords===void 0){const e=this.atomStore;this._hasCoords=bh(e.x)!==0||xh(e.x)!==0||bh(e.y)!==0||xh(e.y)!==0||bh(e.z)!==0||xh(e.z)!==0||e.count/this.modelStore.count==1}return this._hasCoords}getSequence(e){const n=[],i=this.getResidueProxy();return this.eachAtom(function(r){i.index=r.residueIndex,r.index===i.traceAtomIndex&&n.push(i.getResname1())},e),n}getAtomIndices(e){if(e&&e.string){const n=[];return this.eachAtom(function(i){n.push(i.index)},e),new Uint32Array(n)}{const n={what:{index:!0}};return this.getAtomData(n).index}}getChainnameCount(e){const n=new Set;return this.eachChain(function(i){i.residueCount&&n.add(i.chainname)},e),n.size}updatePosition(e,n=!0){let i=0;this.eachAtom(function(r){r.positionFromArray(e,i),i+=3},void 0),this._hasCoords=void 0,n&&this.refreshPosition()}refreshPosition(){this.getBoundingBox(void 0,this.boundingBox),this.boundingBox.getCenter(this.center),this.spatialHash=new Uc(this.atomStore,this.boundingBox),this.signals.refreshed.dispatch(this)}dispose(){this.frames&&(this.frames.length=0),this.boxes&&(this.boxes.length=0),this.bondStore.dispose(),this.backboneBondStore.dispose(),this.rungBondStore.dispose(),this.atomStore.dispose(),this.residueStore.dispose(),this.chainStore.dispose(),this.modelStore.dispose(),delete this.bondSet,delete this.atomSet}}const s1=new Ut,qd=[Ou,Ts,ku,Ps,jo,Du,Wo,Bu,fu,Fu,zc,Gc],CT={aspectRatio:1.5,sphereDetail:2,radialSegments:50,disableImpostor:!1,openEnded:!1,dashedCylinder:!1,labelParams:{},pointSize:2,sizeAttenuation:!1,useTexture:!0,linewidth:2};class TT{constructor(e="shape",n={}){this.boundingBox=new Ut,this.bufferList=[],this.meshCount=0,this._primitiveData={},this.name=e,this.parameters=Kn(n,CT),qd.forEach(i=>{Object.keys(i.fields).forEach(r=>{this._primitiveData[i.getShapeKey(r)]=[]}),this._primitiveData[i.getShapeKey("name")]=[]})}addBuffer(e){this.bufferList.push(e);const n=e.geometry;return n.boundingBox||n.computeBoundingBox(),this.boundingBox.union(n.boundingBox),this}addMesh(e,n,i,r,s){let o;e=Td(e),n=Td(n),Array.isArray(i)&&(i=$i(i,e.length)),r&&(r=Td(r)),o=r===void 0||r.length==0?{position:e,color:n,index:i}:{position:e,color:n,index:i,normal:r};const a=new IC(this,Object.assign({serial:this.meshCount,name:s},o)),c=new mr(Object.assign({picking:a},o));return this.bufferList.push(c),s1.setFromArray(e),this.boundingBox.union(s1),this.meshCount+=1,this}addSphere(e,n,i,r){return Wo.objectToShape(this,{position:e,color:n,radius:i,name:r}),this}addEllipsoid(e,n,i,r,s,o){return jo.objectToShape(this,{position:e,color:n,radius:i,majorAxis:r,minorAxis:s,name:o}),this}addTorus(e,n,i,r,s,o){return Fu.objectToShape(this,{position:e,color:n,radius:i,majorAxis:r,minorAxis:s,name:o}),this}addCylinder(e,n,i,r,s){return Ps.objectToShape(this,{position1:e,position2:n,color:i,radius:r,name:s}),this}addCone(e,n,i,r,s){return ku.objectToShape(this,{position1:e,position2:n,color:i,radius:r,name:s}),this}addArrow(e,n,i,r,s){return Ou.objectToShape(this,{position1:e,position2:n,color:i,radius:r,name:s}),this}addBox(e,n,i,r,s,o){return Ts.objectToShape(this,{position:e,color:n,size:i,heightAxis:r,depthAxis:s,name:o}),this}addOctahedron(e,n,i,r,s,o){return Du.objectToShape(this,{position:e,color:n,size:i,heightAxis:r,depthAxis:s,name:o}),this}addTetrahedron(e,n,i,r,s,o){return Bu.objectToShape(this,{position:e,color:n,size:i,heightAxis:r,depthAxis:s,name:o}),this}addText(e,n,i,r){return fu.objectToShape(this,{position:e,color:n,size:i,text:r}),this}addPoint(e,n,i){return zc.objectToShape(this,{position:e,color:n,name:i}),this}addWideline(e,n,i,r,s){return this.parameters.linewidth=r,Gc.objectToShape(this,{position1:e,position2:n,color:i,name:s}),this}addLabel(e,n,i,r){return console.warn("Shape.addLabel is deprecated, use .addText instead"),this.addText(e,n,i,r)}getBufferList(){const e=[];return qd.forEach(n=>{this._primitiveData[n.getShapeKey("color")].length&&e.push(n.bufferFromShape(this,this.parameters))}),this.bufferList.concat(e)}dispose(){this.bufferList.forEach(function(e){e.dispose()}),this.bufferList.length=0,qd.forEach(e=>{Object.keys(e.fields).forEach(n=>{this._primitiveData[e.getShapeKey(n)].length=0}),this._primitiveData[e.getShapeKey("name")].length=0})}get center(){return this._center||(this._center=this.boundingBox.getCenter(new T)),this._center}get type(){return"Shape"}}class o1 extends tl{constructor(e,n,i){Array.isArray(e)||(e=[e]),super(e,n,i),this.type="buffer",this.parameters=Object.assign({},this.parameters,{colorScheme:null,colorScale:null,colorValue:null,colorDomain:null,colorMode:null}),this.buffer=e,this.init(i)}init(e){super.init(e),this.build()}create(){this.bufferList.push.apply(this.bufferList,this.buffer)}attach(e){this.bufferList.forEach(n=>{this.viewer.add(n),n.setParameters(this.getBufferParams())}),this.setVisibility(this.visible),e()}}const th=new Ie,a1=new An;class Kr extends mr{constructor(e,n={},i){super(function(c,l){const h=l.attributes.position.array,u=l.index?l.index.array:void 0,f=c.position.length/3,d=h.length/3,p=f*d,y=new Float32Array(3*p),g=new Float32Array(3*p),m=new Float32Array(3*p);let x;return u&&(x=$i(f*u.length,p)),{position:y,color:m,index:x,normal:g,primitiveId:c.primitiveId||Ap(f,d),picking:c.picking}}(e,i),n),this.updateNormals=!1;const r=i.attributes.position.array,s=i.attributes.normal.array,o=i.index?i.index.array:void 0;this.geoPosition=r,this.geoNormal=s,this.geoIndex=o,this.positionCount=e.position.length/3,this.geoPositionCount=r.length/3,this.transformedGeoPosition=new Float32Array(3*this.geoPositionCount),this.transformedGeoNormal=new Float32Array(3*this.geoPositionCount);const a=this.geometry.attributes;if(this.meshPosition=a.position.array,this.meshColor=a.color.array,this.meshNormal=a.normal.array,this.setAttributes(e),o){const c=this.geometry.getIndex();if(!c)return void fe.error("Index is null");this.meshIndex=c.array,this.makeIndex()}}setAttributes(e={},n=!1){const i=this.geometry.attributes;let r,s,o,a,c,l,h,u,f;const d=this.updateNormals;e.position&&(r=e.position,o=this.geoPosition,h=this.meshPosition,c=this.transformedGeoPosition,i.position.needsUpdate=!0,(d||n)&&(a=this.geoNormal,f=this.meshNormal,l=this.transformedGeoNormal,i.normal.needsUpdate=!0)),e.color&&(s=e.color,u=this.meshColor,i.color.needsUpdate=!0);const p=this.positionCount,y=this.geoPositionCount;for(let g=0;g<p;++g){let m,x;const v=g*y*3,b=3*g;if(r&&c&&h&&f&&o&&a&&(c.set(o),th.makeTranslation(r[b],r[b+1],r[b+2]),this.applyPositionTransform(th,g,b),Lu(th.elements,c),h.set(c,v),d&&l?(l.set(a),a1.getNormalMatrix(th),pm(a1.elements,l),f.set(l,v)):n&&f.set(a,v)),s&&u)for(m=0;m<y;++m)x=v+3*m,u[x]=s[b],u[x+1]=s[b+1],u[x+2]=s[b+2]}}makeIndex(){const e=this.geoIndex,n=this.meshIndex;if(!e)return;const i=this.positionCount,r=this.geoPositionCount,s=3*(e.length/3);for(let o=0;o<i;++o){const a=o*s,c=a+s;n.set(e,a);for(let l=a;l<c;++l)n[l]+=o*r}}}const c1=new T,mb=Object.assign({sphereDetail:1},Bn);class PT extends Kr{constructor(e,n={}){super(e,n,new Ms(1,I(n.sphereDetail,1))),this.setAttributes(e,!0)}get defaultParameters(){return mb}applyPositionTransform(e,n){const i=this._radius[n];c1.set(i,i,i),e.scale(c1)}setAttributes(e={},n){e.radius&&(this._radius=e.radius),super.setAttributes(e,n)}}At.add("shader/SphereImpostor.vert",`uniform mat4 projectionMatrixInverse;
uniform float clipNear;
varying float vRadius;
varying float vRadiusSq;
varying vec3 vPoint;
varying vec3 vPointViewPosition;
attribute vec2 mapping;
attribute float radius;
#ifdef PICKING
#include unpack_color
attribute float primitiveId;
varying vec3 vPickingColor;
#else
#include color_pars_vertex
#endif
#include matrix_scale
const mat4 D = mat4(
1.0, 0.0, 0.0, 0.0,
0.0, 1.0, 0.0, 0.0,
0.0, 0.0, 1.0, 0.0,
0.0, 0.0, 0.0, -1.0
);
mat4 transposeM( in mat4 inMatrix ) {
vec4 i0 = inMatrix[0];
vec4 i1 = inMatrix[1];
vec4 i2 = inMatrix[2];
vec4 i3 = inMatrix[3];
mat4 outMatrix = mat4(
vec4(i0.x, i1.x, i2.x, i3.x),
vec4(i0.y, i1.y, i2.y, i3.y),
vec4(i0.z, i1.z, i2.z, i3.z),
vec4(i0.w, i1.w, i2.w, i3.w)
);
return outMatrix;
}
void ComputePointSizeAndPositionInClipCoordSphere(){
vec2 xbc;
vec2 ybc;
mat4 T = mat4(
radius, 0.0, 0.0, 0.0,
0.0, radius, 0.0, 0.0,
0.0, 0.0, radius, 0.0,
position.x, position.y, position.z, 1.0
);
mat4 R = transposeM( projectionMatrix * modelViewMatrix * T );
float A = dot( R[ 3 ], D * R[ 3 ] );
float B = -2.0 * dot( R[ 0 ], D * R[ 3 ] );
float C = dot( R[ 0 ], D * R[ 0 ] );
xbc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );
xbc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );
float sx = abs( xbc[ 0 ] - xbc[ 1 ] ) * 0.5;
A = dot( R[ 3 ], D * R[ 3 ] );
B = -2.0 * dot( R[ 1 ], D * R[ 3 ] );
C = dot( R[ 1 ], D * R[ 1 ] );
ybc[ 0 ] = ( -B - sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );
ybc[ 1 ] = ( -B + sqrt( B * B - 4.0 * A * C ) ) / ( 2.0 * A );
float sy = abs( ybc[ 0 ] - ybc[ 1 ] ) * 0.5;
gl_Position.xy = vec2( 0.5 * ( xbc.x + xbc.y ), 0.5 * ( ybc.x + ybc.y ) );
gl_Position.xy -= mapping * vec2( sx, sy );
gl_Position.xy *= gl_Position.w;
}
void main(void){
#ifdef PICKING
vPickingColor = unpackColor( primitiveId );
#else
#include color_vertex
#endif
vRadius = radius * matrixScale( modelViewMatrix );
vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
mvPosition.z -= vRadius;
gl_Position = projectionMatrix * vec4( mvPosition.xyz, 1.0 );
ComputePointSizeAndPositionInClipCoordSphere();
vRadiusSq = vRadius * vRadius;
vec4 vPoint4 = projectionMatrixInverse * gl_Position;
vPoint = vPoint4.xyz / vPoint4.w;
vPointViewPosition = -mvPosition.xyz / mvPosition.w;
}`),At.add("shader/SphereImpostor.frag",`#define STANDARD
#define IMPOSTOR
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 interiorColor;
uniform float interiorDarkening;
uniform float roughness;
uniform float metalness;
uniform float opacity;
uniform float clipNear;
uniform mat4 projectionMatrix;
uniform float ortho;
varying float vRadius;
varying float vRadiusSq;
varying vec3 vPoint;
varying vec3 vPointViewPosition;
#ifdef PICKING
uniform float objectId;
varying vec3 vPickingColor;
#else
#include common
#include color_pars_fragment
#include fog_pars_fragment
#include bsdfs
#include lights_pars_begin
#include lights_physical_pars_fragment
#endif
bool flag2 = false;
bool interior = false;
vec3 cameraPos;
vec3 cameraNormal;
float calcDepth( in vec3 cameraPos ){
vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;
return 0.5 + 0.5 * clipZW.x / clipZW.y;
}
float calcClip( vec3 cameraPos ){
return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );
}
bool Impostor( out vec3 cameraPos, out vec3 cameraNormal ){
vec3 cameraSpherePos = -vPointViewPosition;
cameraSpherePos.z += vRadius;
vec3 rayOrigin = mix( vec3( 0.0, 0.0, 0.0 ), vPoint, ortho );
vec3 rayDirection = mix( normalize( vPoint ), vec3( 0.0, 0.0, 1.0 ), ortho );
vec3 cameraSphereDir = mix( cameraSpherePos, rayOrigin - cameraSpherePos, ortho );
float B = dot( rayDirection, cameraSphereDir );
float det = B * B + vRadiusSq - dot( cameraSphereDir, cameraSphereDir );
if( det < 0.0 ){
discard;
return false;
}
float sqrtDet = sqrt( det );
float posT = mix( B + sqrtDet, B + sqrtDet, ortho );
float negT = mix( B - sqrtDet, sqrtDet - B, ortho );
cameraPos = rayDirection * negT + rayOrigin;
#ifdef NEAR_CLIP
if( calcDepth( cameraPos ) <= 0.0 ){
cameraPos = rayDirection * posT + rayOrigin;
interior = true;
}else if( calcClip( cameraPos ) > 0.0 ){
cameraPos = rayDirection * posT + rayOrigin;
interior = true;
flag2 = true;
}
#else
if( calcDepth( cameraPos ) <= 0.0 ){
cameraPos = rayDirection * posT + rayOrigin;
interior = true;
}
#endif
cameraNormal = normalize( cameraPos - cameraSpherePos );
cameraNormal *= float(!interior) * 2.0 - 1.0;
return !interior;
}
void main(void){
bool flag = Impostor( cameraPos, cameraNormal );
#ifdef NEAR_CLIP
if( calcClip( cameraPos ) > 0.0 )
discard;
#endif
gl_FragDepthEXT = calcDepth( cameraPos );
if( !flag ){
#ifdef NEAR_CLIP
if( flag2 ){
gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );
}else if( gl_FragDepthEXT >= 0.0 ){
gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );
}
#else
if( gl_FragDepthEXT >= 0.0 ){
gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );
}
#endif
}
if (gl_FragDepthEXT < 0.0)
discard;
if (gl_FragDepthEXT > 1.0)
discard;
#ifdef PICKING
if( opacity < 0.3 )
discard;
gl_FragColor = vec4( vPickingColor, objectId );
#else
vec3 vNormal = cameraNormal;
vec3 vViewPosition = -cameraPos;
vec4 diffuseColor = vec4( diffuse, opacity );
ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
vec3 totalEmissiveLight = emissive;
#include color_fragment
#include roughnessmap_fragment
#include metalnessmap_fragment
#include normal_fragment_begin
#include lights_physical_fragment
#include lights_fragment_begin
#include lights_fragment_end
vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;
if( interior ){
#ifdef USE_INTERIOR_COLOR
outgoingLight.xyz = interiorColor;
#else
#ifdef DIFFUSE_INTERIOR
outgoingLight.xyz = vColor;
#endif
#endif
outgoingLight.xyz *= 1.0 - interiorDarkening;
}
gl_FragColor = vec4( outgoingLight, diffuseColor.a );
#include premultiplied_alpha_fragment
#include tonemapping_fragment
#include encodings_fragment
#include fog_fragment
#endif
}`);class Sm extends Wi{constructor(e,n,i={}){super(n,i),this.index=$i(this.indexSize,this.attributeSize),this.makeIndex(),this.initIndex(this.index),this.addAttributes({mapping:{type:e,value:null}}),this.setAttributes({primitiveId:ea(this.size)})}get attributeSize(){return this.size*this.mappingSize}get indexSize(){return this.size*this.mappingIndicesSize}addAttributes(e){const n={};for(const i in e){const r=e[i];n[i]={type:r.type,value:null}}super.addAttributes(n)}getAttributeIndex(e){return 3*e*this.mappingSize}setAttributes(e){e&&!e.position&&e.position1&&e.position2&&(e.position=Fi(e.position1,e.position2));const n=this.size,i=this.mappingSize,r=this.geometry.attributes;let s,o,a,c,l,h,u;for(const f in e)if(f!=="index"&&f!=="picking"){o=e[f],s=r[f],a=s.itemSize,c=s.array;for(let d=0;d<n;++d){l=d*a,h=l*i;for(let p=0;p<i;++p){u=h+a*p;for(let y=0;y<a;++y)c[u+y]=o[l+y]}}s.needsUpdate=!0}}makeMapping(){const e=this.size,n=this.mapping,i=this.mappingSize,r=this.mappingItemSize,s=this.geometry.attributes.mapping.array;for(let o=0;o<e;o++)s.set(n,o*r*i)}makeIndex(){const e=this.size,n=this.mappingSize,i=this.mappingIndices,r=this.mappingIndicesSize,s=this.index;for(let o=0;o<e;o++){const a=o*r,c=o*n;s.set(i,a);for(let l=0;l<r;++l)s[a+l]+=c}}}const ET=new Float32Array([-1,1,-1,-1,1,1,1,-1]),IT=new Uint16Array([0,1,2,1,3,2]);class Mm extends Sm{constructor(e,n={}){super("v2",e,n)}get mapping(){return ET}get mappingIndices(){return IT}get mappingIndicesSize(){return 6}get mappingSize(){return 4}get mappingItemSize(){return 2}}class LT extends Mm{constructor(e,n={}){super(e,n),this.isImpostor=!0,this.vertexShader="SphereImpostor.vert",this.fragmentShader="SphereImpostor.frag",this.addUniforms({projectionMatrixInverse:{value:new Ie},ortho:{value:0}}),this.addAttributes({radius:{type:"f",value:null}}),this.setAttributes(e),this.makeMapping()}}Object.assign({disableImpostor:!1},mb);const Jr=class{constructor(t,e){return!ki||e&&e.disableImpostor?new PT(t,e):new LT(t,e)}};function RT(t,e,n,i){const r=n-t,s=i-e;return Math.sqrt(r*r+s*s)}Qn.add("sphere",Jr),At.add("shader/Point.vert",`uniform float clipNear;
uniform float clipRadius;
uniform vec3 clipCenter;
uniform float size;
uniform float canvasHeight;
uniform float pixelRatio;
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#if defined( PICKING )
#include unpack_color
attribute float primitiveId;
varying vec3 vPickingColor;
#else
#include color_pars_vertex
varying vec3 vViewPosition;
#endif
#include common
void main(){
#if defined( PICKING )
vPickingColor = unpackColor( primitiveId );
#else
#include color_vertex
#endif
#include begin_vertex
#include project_vertex
#ifdef USE_SIZEATTENUATION
gl_PointSize = size * pixelRatio * ( ( canvasHeight / 2.0 ) / -mvPosition.z );
#else
gl_PointSize = size * pixelRatio;
#endif
#ifndef PICKING
vViewPosition = -mvPosition.xyz;
#endif
#if defined( RADIUS_CLIP )
vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;
#endif
#include nearclip_vertex
#include radiusclip_vertex
}`),At.add("shader/Point.frag",`uniform vec3 diffuse;
uniform float opacity;
uniform float clipNear;
uniform float clipRadius;
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#ifdef USE_MAP
uniform sampler2D map;
#endif
#if defined( PICKING )
uniform float objectId;
varying vec3 vPickingColor;
#else
#include common
#include color_pars_fragment
#include fog_pars_fragment
varying vec3 vViewPosition;
#endif
void main(){
#include nearclip_fragment
#include radiusclip_fragment
#if defined( PICKING )
#ifdef USE_MAP
if( texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) ).a < 0.5 )
discard;
#endif
if( opacity < 0.3 )
discard;
gl_FragColor = vec4( vPickingColor, objectId );
#else
vec3 outgoingLight = vec3( 0.0 );
vec4 diffuseColor = vec4( diffuse, 1.0 );
#ifdef USE_MAP
diffuseColor *= texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );
#endif
#include color_fragment
#include alphatest_fragment
outgoingLight = diffuseColor.rgb;
gl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );
#include premultiplied_alpha_fragment
#include tonemapping_fragment
#include encodings_fragment
#include fog_fragment
#endif
}`);const DT=Object.assign({pointSize:1,sizeAttenuation:!0,sortParticles:!1,alphaTest:.5,useTexture:!1,forceTransparent:!1,edgeBleach:0},Bn),BT=Object.assign({pointSize:{uniform:"size"},sizeAttenuation:{updateShader:!0},sortParticles:{},alphaTest:{updateShader:!0},useTexture:{updateShader:!0},forceTransparent:{},edgeBleach:{uniform:!0}},Ds);class Am extends Wi{constructor(e,n={}){super(e,n),this.parameterTypes=BT,this.vertexShader="Point.vert",this.fragmentShader="Point.frag",this.isPoint=!0,this.addUniforms({size:{value:this.parameters.pointSize},canvasHeight:{value:1},pixelRatio:{value:1},map:{value:null}})}get defaultParameters(){return DT}makeMaterial(){super.makeMaterial(),this.makeTexture();const e=this.material,n=this.wireframeMaterial,i=this.pickingMaterial;e.uniforms.map.value=this.tex,e.needsUpdate=!0,n.uniforms.map.value=this.tex,n.needsUpdate=!0,i.uniforms.map.value=this.tex,i.needsUpdate=!0}makeTexture(){this.tex&&this.tex.dispose(),this.tex=function(e){const n=e||{},i=I(n.width,256),r=I(n.height,256),s=[i/2,r/2],o=Math.min(i/2,r/2),a=I(n.delta,1/(o+1))*o;let c=0,l=0;const h=new Uint8Array(i*r*4);for(let f=0,d=h.length;f<d;f+=4){const p=1-Jc(o-a,o,RT(c,l,s[0],s[1]));h[f]=255*p,h[f+1]=255*p,h[f+2]=255*p,h[f+3]=255*p,++c===i&&(c=0,l++)}const u=new cr(h,i,r);return u.needsUpdate=!0,u}({delta:this.parameters.edgeBleach})}getDefines(e){const n=super.getDefines(e);return this.parameters.sizeAttenuation&&(n.USE_SIZEATTENUATION=1),this.parameters.useTexture&&(n.USE_MAP=1),this.parameters.alphaTest>0&&this.parameters.alphaTest<=1&&(n.ALPHATEST=this.parameters.alphaTest.toPrecision(2)),n}setUniforms(e){e&&e.edgeBleach!==void 0&&(this.makeTexture(),e.map=this.tex),super.setUniforms(e)}dispose(){super.dispose(),this.tex&&this.tex.dispose()}}Qn.add("point",Am);class l1 extends tl{constructor(e,n,i){super(e,n,i),this.type="dot",this.parameters=Object.assign({thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdOut:{type:"boolean",rebuild:!0},dotType:{type:"select",rebuild:!0,options:{"":"",sphere:"sphere",point:"point"}},radiusType:{type:"select",options:{"":"",value:"value","abs-value":"abs-value","value-min":"value-min",deviation:"deviation",size:"size"}},radius:{type:"number",precision:3,max:10,min:.001,property:"size"},scale:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,disableImpostor:!0,pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{colorScheme:{type:"select",update:"color",options:{"":"",value:"value",uniform:"uniform",random:"random"}}}),e instanceof Nn?(this.surface=void 0,this.volume=new nr(e)):(this.surface=e,this.volume=void 0),this.init(i)}init(e){var n=e||{};n.colorScheme=I(n.colorScheme,"uniform"),n.colorValue=I(n.colorValue,14540253),this.thresholdType=I(n.thresholdType,"sigma"),this.thresholdMin=I(n.thresholdMin,2),this.thresholdMax=I(n.thresholdMax,1/0),this.thresholdOut=I(n.thresholdOut,!1),this.dotType=I(n.dotType,"point"),this.radius=I(n.radius,.1),this.scale=I(n.scale,1),this.pointSize=I(n.pointSize,1),this.sizeAttenuation=I(n.sizeAttenuation,!0),this.sortParticles=I(n.sortParticles,!1),this.useTexture=I(n.useTexture,!1),this.alphaTest=I(n.alphaTest,.5),this.forceTransparent=I(n.forceTransparent,!1),this.edgeBleach=I(n.edgeBleach,0),super.init(n),this.build()}attach(e){this.bufferList.forEach(n=>{this.viewer.add(n)}),this.setVisibility(this.visible),e()}create(){var e={};if(this.volume){var n,i,r=this.volume;this.thresholdType==="sigma"?(n=r.getValueForSigma(this.thresholdMin),i=r.getValueForSigma(this.thresholdMax)):(n=this.thresholdMin,i=this.thresholdMax),r.setFilter(n,i,this.thresholdOut),Object.assign(e,{position:r.getDataPosition(),color:r.getDataColor(this.getColorParams())}),this.dotType==="sphere"&&Object.assign(e,{radius:r.getDataSize(this.radius,this.scale),picking:r.getDataPicking()})}else{var s=this.surface;Object.assign(e,{position:s.getPosition(),color:s.getColor(this.getColorParams())}),this.dotType==="sphere"&&Object.assign(e,{radius:s.getSize(this.radius,this.scale),picking:s.getPicking()})}this.dotType==="sphere"?this.dotBuffer=new Jr(e,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!1})):this.dotBuffer=new Am(e,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach})),this.bufferList.push(this.dotBuffer)}update(e={}){if(this.bufferList.length===0)return;const n={};e.color&&(this.volume?Object.assign(n,{color:this.volume.getDataColor(this.getColorParams())}):Object.assign(n,{color:this.surface.getColor(this.getColorParams())})),this.dotType==="sphere"&&(e.radius||e.scale)&&(this.volume?Object.assign(n,{radius:this.volume.getDataSize(this.radius,this.scale)}):Object.assign(n,{radius:this.surface.getSize(this.radius,this.scale)})),this.dotBuffer.setAttributes(n)}setParameters(e,n={},i){return e&&e.thresholdType!==void 0&&this.volume instanceof Nn&&(this.thresholdType==="value"&&e.thresholdType==="sigma"?(this.thresholdMin=this.volume.getSigmaForValue(this.thresholdMin),this.thresholdMax=this.volume.getSigmaForValue(this.thresholdMax)):this.thresholdType==="sigma"&&e.thresholdType==="value"&&(this.thresholdMin=this.volume.getValueForSigma(this.thresholdMin),this.thresholdMax=this.volume.getValueForSigma(this.thresholdMax)),this.thresholdType=e.thresholdType),e&&e.radiusType!==void 0&&(e.radiusType==="radius"?this.radius=.1:this.radius=parseFloat(e.radiusType),n.radius=!0,this.dotType!=="sphere"||ki&&!this.disableImpostor||(i=!0)),e&&e.radius!==void 0&&(n.radius=!0,this.dotType!=="sphere"||ki&&!this.disableImpostor||(i=!0)),e&&e.scale!==void 0&&(n.scale=!0,this.dotType!=="sphere"||ki&&!this.disableImpostor||(i=!0)),super.setParameters(e,n,i),this}}At.add("shader/Image.vert",`uniform float clipRadius;
uniform vec3 clipCenter;
varying vec2 vUv;
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )
varying vec3 vViewPosition;
#endif
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
void main() {
#include begin_vertex
#include project_vertex
vUv = uv;
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )
vViewPosition = -mvPosition.xyz;
#endif
#if defined( RADIUS_CLIP )
vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;
#endif
}`),At.add("shader/Image.frag",`uniform sampler2D map;
uniform float opacity;
uniform vec2 mapSize;
uniform float clipNear;
uniform float clipRadius;
varying vec2 vUv;
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )
varying vec3 vViewPosition;
#endif
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#if defined( PICKING )
uniform sampler2D pickingMap;
uniform float objectId;
#else
#include fog_pars_fragment
#endif
#if defined( CUBIC_INTERPOLATION )
#if defined( CATMULROM_FILTER ) || defined( MITCHELL_FILTER )
#if defined( CATMULROM_FILTER )
const float B = 0.0;
const float C = 0.5;
#elif defined( MITCHELL_FILTER )
const float B = 0.333;
const float C = 0.333;
#endif
float filter( float x ){
float f = x;
if( f < 0.0 ){
f = -f;
}
if( f < 1.0 ){
return ( ( 12.0 - 9.0 * B - 6.0 * C ) * ( f * f * f ) +
( -18.0 + 12.0 * B + 6.0 *C ) * ( f * f ) +
( 6.0 - 2.0 * B ) ) / 6.0;
}else if( f >= 1.0 && f < 2.0 ){
return ( ( -B - 6.0 * C ) * ( f * f * f )
+ ( 6.0 * B + 30.0 * C ) * ( f *f ) +
( - ( 12.0 * B ) - 48.0 * C ) * f +
8.0 * B + 24.0 * C ) / 6.0;
}else{
return 0.0;
}
}
#elif defined( BSPLINE_FILTER )
float filter( float x ){
float f = x;
if( f < 0.0 ){
f = -f;
}
if( f >= 0.0 && f <= 1.0 ){
return ( 2.0 / 3.0 ) + ( 0.5 ) * ( f * f * f ) - ( f * f );
}else if( f > 1.0 && f <= 2.0 ){
return 1.0 / 6.0 * pow( ( 2.0 - f ), 3.0 );
}
return 1.0;
}
#else
float filter( float x ){
return 1.0;
}
#endif
vec4 biCubic( sampler2D tex, vec2 texCoord ){
vec2 texelSize = 1.0 / mapSize;
texCoord -= texelSize / 2.0;
vec4 nSum = vec4( 0.0 );
float nDenom = 0.0;
vec2 cell = fract( texCoord * mapSize );
for( float m = -1.0; m <= 2.0; ++m ){
for( float n = -1.0; n <= 2.0; ++n ){
vec4 vecData = texture2D(
tex, texCoord + texelSize * vec2( m, n )
);
float c = filter( m - cell.x ) * filter( -n + cell.y );
nSum += vecData * c;
nDenom += c;
}
}
return nSum / nDenom;
}
#endif
void main(){
#include nearclip_fragment
#include radiusclip_fragment
#if defined( CUBIC_INTERPOLATION )
gl_FragColor = biCubic( map, vUv );
#else
gl_FragColor = texture2D( map, vUv );
#endif
#if defined( PICKING )
if( gl_FragColor.a < 0.3 )
discard;
gl_FragColor = vec4( texture2D( pickingMap, vUv ).xyz, objectId );
#else
if( gl_FragColor.a < 0.01 )
discard;
gl_FragColor.a *= opacity;
#include fog_fragment
#endif
}`);const OT=new Uint16Array([0,1,2,1,3,2]),kT=new Float32Array([0,1,0,0,1,1,1,0]),FT=Object.assign({filter:"nearest",forceTransparent:!0},Bn),NT=Object.assign({filter:{updateShader:!0,uniform:!0}},Ds);class zT extends Wi{constructor(e,n){super({position:e.position,index:OT,picking:e.picking},n),this.parameterTypes=NT,this.alwaysTransparent=!0,this.hasWireframe=!1,this.vertexShader="Image.vert",this.fragmentShader="Image.frag";const{imageData:i,width:r,height:s}=e,o=new cr(i,r,s);o.flipY=!0,this.tex=o;const a=i.length,c=new Uint8Array(a);for(let h=0;h<a;h+=4){const u=h/4;c[h]=u>>16&255,c[h+1]=u>>8&255,c[h+2]=255&u}const l=new cr(c,r,s);l.flipY=!0,l.minFilter=zt,l.magFilter=zt,this.pickingTex=l,this.addUniforms({map:{value:o},pickingMap:{value:l},mapSize:{value:new Te(r,s)}}),this.geometry.setAttribute("uv",new Qe(kT,2))}get defaultParameters(){return FT}getDefines(e){const n=super.getDefines(e),i=this.parameters.filter;return i.startsWith("cubic")&&(n.CUBIC_INTERPOLATION=1,i.endsWith("bspline")?n.BSPLINE_FILTER=1:i.endsWith("catmulrom")?n.CATMULROM_FILTER=1:i.endsWith("mitchell")&&(n.MITCHELL_FILTER=1)),n}updateTexture(){const e=this.tex,n=this.parameters.filter;n.startsWith("cubic")?(e.minFilter=zt,e.magFilter=zt):n==="linear"?(e.minFilter=gn,e.magFilter=gn):(e.minFilter=zt,e.magFilter=zt),e.needsUpdate=!0,this.pickingTex.needsUpdate=!0}makeMaterial(){super.makeMaterial(),this.updateTexture();const e=this.material;e.uniforms.map.value=this.tex,e.blending=Br,e.needsUpdate=!0;const n=this.wireframeMaterial;n.uniforms.map.value=this.tex,n.blending=Br,n.needsUpdate=!0;const i=this.pickingMaterial;i.uniforms.map.value=this.tex,i.uniforms.pickingMap.value=this.pickingTex,i.blending=Br,i.needsUpdate=!0}setUniforms(e){e&&e.filter!==void 0&&(this.updateTexture(),e.map=this.tex),super.setUniforms(e)}}class GT{constructor(e,n){const i=n||{};this.dimension=I(i.dimension,"x"),this.positionType=I(i.positionType,"percent"),this.position=I(i.position,30),this.thresholdType=I(i.thresholdType,"sigma"),this.thresholdMin=I(i.thresholdMin,-1/0),this.thresholdMax=I(i.thresholdMax,1/0),this.normalize=I(i.normalize,!1),this.volume=e}getPositionFromCoordinate(e){const n=this.dimension,i=this.volume,r=i.matrix,s=new T().setFromMatrixPosition(r)[n],o=new T().setFromMatrixScale(r)[n];let a;return a=n==="x"?i.nx:n==="y"?i.ny:i.nz,Math.round(((e-s)/(a/100)+1)/o)}getData(e){e=e||{};const n=this.volume,i=n.data,r=n.matrix;let s;function o(ee){return Math.round(ee/100*(s-1))}function a(ee,j,Z,ce){return 3*(Z*n.ny*n.nx+j*n.nx+ee)+ce}s=this.positionType==="coordinate"?this.getPositionFromCoordinate(this.position):this.position;const c=new Float32Array(12),l=new T;let h,u,f,d,p,y=0,g=0,m=0,x=n.nx,v=n.ny,b=n.nz;function _(ee,j,Z,ce){l.set(ee,j,Z).applyMatrix4(r).toArray(c,ce)}this.dimension==="x"?(f=o(n.nx),d=n.ny-1,p=n.nz-1,h=n.nz,u=n.ny,y=f,x=y+1,_(f,0,0,0),_(f,d,0,3),_(f,0,p,6),_(f,d,p,9)):this.dimension==="y"?(f=n.nx-1,d=o(n.ny),p=n.nz-1,h=n.nz,u=n.nx,g=d,v=g+1,_(0,d,0,0),_(f,d,0,3),_(0,d,p,6),_(f,d,p,9)):this.dimension==="z"&&(f=n.nx-1,d=n.ny-1,p=o(n.nz),h=n.nx,u=n.ny,m=p,b=m+1,_(0,0,p,0),_(0,d,p,3),_(f,0,p,6),_(f,d,p,9));let C=0,w=0;const S=new Uint8Array(h*u*4),M=new Float32Array(h*u);let B,L;this.thresholdType==="sigma"?(B=n.getValueForSigma(this.thresholdMin),L=n.getValueForSigma(this.thresholdMax)):(B=this.thresholdMin,L=this.thresholdMax);const U=Object.assign({},e.colorParams,{volume:n});this.normalize&&(U.domain=[0,1]);const E=mt.getScheme(U),O=new Float32Array(3),k=E.getScale();let ne,Y=0,F=0;if(this.normalize){Y=1/0,ne=-1/0;for(let ee=g;ee<v;++ee)for(let j=y;j<x;++j)for(let Z=m;Z<b;++Z){const ce=i[a(j,ee,Z,0)/3];ce<Y&&(Y=ce),ce>ne&&(ne=ce)}F=ne-Y}for(let ee=g;ee<v;++ee)for(let j=y;j<x;++j)for(let Z=m;Z<b;++Z){const ce=a(j,ee,Z,0)/3;let de=i[ce];this.normalize&&(de=(de-Y)/F),E.colorToArray(k(de),O),S[C]=Math.round(255*O[0]),S[C+1]=Math.round(255*O[1]),S[C+2]=Math.round(255*O[2]),S[C+3]=de>B&&de<L?255:0,M[w]=ce,++w,C+=4}const te=new DC(M,n);return{position:c,imageData:S,width:h,height:u,picking:te}}}class UT extends tl{constructor(e,n,i){super(e,n,i),this.type="slice",this.parameters=Object.assign({filter:{type:"select",buffer:!0,options:{nearest:"nearest",linear:"linear","cubic-bspline":"cubic-bspline","cubic-catmulrom":"cubic-catmulrom","cubic-mitchell":"cubic-mitchell"}},positionType:{type:"select",rebuild:!0,options:{percent:"percent",coordinate:"coordinate"}},position:{type:"range",step:.1,max:100,min:1,rebuild:!0},dimension:{type:"select",rebuild:!0,options:{x:"x",y:"y",z:"z"}},thresholdType:{type:"select",rebuild:!0,options:{value:"value",sigma:"sigma"}},thresholdMin:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},thresholdMax:{type:"number",precision:3,max:1/0,min:-1/0,rebuild:!0},normalize:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null,linewidth:null,colorScheme:null,roughness:null,metalness:null,diffuse:null}),this.volume=e,this.init(i)}init(e){const n=this.volume,i=e||{};i.colorDomain=I(i.colorDomain,[n.min,n.max]),i.colorScheme=I(i.colorScheme,"value"),i.colorScale=I(i.colorScale,"Spectral"),this.colorScheme="value",this.dimension=I(i.dimension,"x"),this.filter=I(i.filter,"cubic-bspline"),this.positionType=I(i.positionType,"percent"),this.position=I(i.position,30),this.thresholdType=I(i.thresholdType,"sigma"),this.thresholdMin=I(i.thresholdMin,-1/0),this.thresholdMax=I(i.thresholdMax,1/0),this.normalize=I(i.normalize,!1),super.init(i),this.build()}attach(e){this.bufferList.forEach(n=>{this.viewer.add(n)}),this.setVisibility(this.visible),e()}create(){const e=new GT(this.volume,{positionType:this.positionType,position:this.position,dimension:this.dimension,thresholdType:this.thresholdType,thresholdMin:this.thresholdMin,thresholdMax:this.thresholdMax,normalize:this.normalize}),n=new zT(e.getData({colorParams:this.getColorParams()}),this.getBufferParams({filter:this.filter}));this.bufferList.push(n)}}function Xd(t){fe.error(`makeRepresentation: representation type ${t} unknown`)}const Cm={name:"some element",status:""};class gb{constructor(e,n={}){this.stage=e,this.signals={statusChanged:new ot.Signal,nameChanged:new ot.Signal,disposed:new ot.Signal},this.parameters=Kn(n,this.defaultParameters),this.uuid=hm()}get defaultParameters(){return Cm}get name(){return this.parameters.name}setStatus(e){return this.parameters.status=e,this.signals.statusChanged.dispatch(e),this}setName(e){return this.parameters.name=e,this.signals.nameChanged.dispatch(e),this}dispose(){this.signals.disposed.dispatch()}}const VT=Object.assign({visible:!0},Cm);class HT extends gb{constructor(e,n,i={},r){super(e,Object.assign({name:n.type},i)),this.parent=r,this.signals=Object.assign({visibilityChanged:new ot.Signal,parametersChanged:new ot.Signal},this.signals),this.setRepresentation(n)}get defaultParameters(){return VT}get visible(){return this.parameters.visible}get type(){return"representation"}getType(){return this.repr.type}setRepresentation(e){this._disposeRepresentation(),this.repr=e,this.stage.tasks.listen(this.repr.tasks),this.updateVisibility()}_disposeRepresentation(){this.repr&&(this.stage.tasks.unlisten(this.repr.tasks),this.repr.dispose())}dispose(){this.parent&&this.parent.hasRepresentation(this)?this.parent.removeRepresentation(this):(this._disposeRepresentation(),this.signals.disposed.dispatch())}setVisibility(e){return this.parameters.visible=e,this.updateVisibility(),this.signals.visibilityChanged.dispatch(this.parameters.visible),this}getVisibility(){return this.parent?this.parent.parameters.visible&&this.parameters.visible:this.parameters.visible}toggleVisibility(){return this.setVisibility(!this.parameters.visible)}updateVisibility(){this.repr.setVisibility(this.getVisibility())}update(e){return this.repr.update(e),this}build(e){return this.repr.build(e),this}setSelection(e){const n=this.repr;return n.setSelection&&n.setSelection(e),this}setParameters(e){return this.repr.setParameters(e),this.signals.parametersChanged.dispatch(this.repr.getParameters()),this}getParameters(){return this.repr.getParameters()}setColor(e){return this.repr.setColor(e),this}}const Qs=new Ie,$T=new T,yb={name:"",status:"",visible:!0};class Vu{constructor(e,n,i={}){this.stage=e,this.object=n,this.signals={representationAdded:new ot.Signal,representationRemoved:new ot.Signal,visibilityChanged:new ot.Signal,matrixChanged:new ot.Signal,statusChanged:new ot.Signal,nameChanged:new ot.Signal,disposed:new ot.Signal},this.reprList=[],this.annotationList=[],this.matrix=new Ie,this.position=new T,this.quaternion=new Gt,this.scale=new T(1,1,1),this.transform=new Ie,this.parameters=Kn(i,this.defaultParameters),this.uuid=hm(),this.viewer=e.viewer,this.controls=new WC(this)}get defaultParameters(){return yb}get name(){return this.parameters.name}get status(){return this.parameters.status}get visible(){return this.parameters.visible}setPosition(e){return Array.isArray(e)?this.position.fromArray(e):this.position.copy(e),this.updateMatrix(),this}setRotation(e){if(Array.isArray(e))if(e.length===3){const n=new Ur().fromArray(e);this.quaternion.setFromEuler(n)}else this.quaternion.fromArray(e);else e instanceof Ur?this.quaternion.setFromEuler(e):this.quaternion.copy(e);return this.updateMatrix(),this}setScale(e){return this.scale.set(e,e,e),this.updateMatrix(),this}setTransform(e){return this.transform.copy(e),this.updateMatrix(),this}updateMatrix(){const e=this.getCenterUntransformed($T);this.matrix.makeTranslation(-e.x,-e.y,-e.z),Qs.makeRotationFromQuaternion(this.quaternion),this.matrix.premultiply(Qs),Qs.makeScale(this.scale.x,this.scale.y,this.scale.z),this.matrix.premultiply(Qs);const n=this.position;Qs.makeTranslation(n.x+e.x,n.y+e.y,n.z+e.z),this.matrix.premultiply(Qs),this.matrix.premultiply(this.transform),this.updateRepresentationMatrices(),this.stage.viewer.updateBoundingBox(),this.signals.matrixChanged.dispatch(this.matrix)}updateRepresentationMatrices(){this.reprList.forEach(e=>{e.setParameters({matrix:this.matrix})})}addAnnotation(e,n,i){const r=new $C(this,e,n,i);return this.annotationList.push(r),r}eachAnnotation(e){this.annotationList.slice().forEach(e)}removeAnnotation(e){const n=this.annotationList.indexOf(e);n!==-1&&(this.annotationList.splice(n,1),e.dispose())}removeAllAnnotations(){this.eachAnnotation(e=>e.dispose()),this.annotationList.length=0}_addRepresentation(e,n,i,r=!1){const s=i||{},o=this.stage.getParameters();s.matrix=this.matrix.clone(),s.quality=s.quality||o.quality,s.disableImpostor=I(s.disableImpostor,!o.impostor),s.useWorker=I(s.useWorker,o.workerDefault),s.visible=I(s.visible,!0);const a=Object.assign({},s,{visible:this.parameters.visible&&s.visible}),c=function(h,u,f,d){var p;if(Ce&&fe.time("makeRepresentation "+h),u instanceof Bi){if(!(p=Xt.get(h)))return void Xd(h)}else if(u instanceof Nu)if(h==="surface")p=Op;else{if(h!=="dot")return void Xd(h);p=l1}else if(u instanceof Nn)if(h==="surface")p=Op;else if(h==="dot")p=l1;else{if(h!=="slice")return void Xd(h);p=UT}else if(u instanceof TT)p=o1,u=u.getBufferList();else{if(h!=="buffer")return void fe.error("makeRepresentation: object "+u+" unknown");p=o1}const y=new p(u,f,d);return Ce&&fe.timeEnd("makeRepresentation "+h),y}(e,n,this.viewer,a),l=new HT(this.stage,c,s,this);return r||(this.reprList.push(l),this.signals.representationAdded.dispatch(l)),l}addBufferRepresentation(e,n){return this._addRepresentation.call(this,"buffer",e,n)}hasRepresentation(e){return this.reprList.indexOf(e)!==-1}eachRepresentation(e){this.reprList.slice().forEach(e)}removeRepresentation(e){const n=this.reprList.indexOf(e);n!==-1&&(this.reprList.splice(n,1),e.dispose(),this.signals.representationRemoved.dispatch(e))}updateRepresentations(e){this.reprList.forEach(n=>n.update(e)),this.stage.viewer.requestRender()}removeAllRepresentations(){this.eachRepresentation(e=>e.dispose())}dispose(){this.removeAllAnnotations(),this.removeAllRepresentations(),this.reprList.length=0,this.signals.disposed.dispatch()}setVisibility(e){return this.parameters.visible=e,this.eachRepresentation(n=>n.updateVisibility()),this.eachAnnotation(n=>n.updateVisibility()),this.signals.visibilityChanged.dispatch(e),this}setStatus(e){return this.parameters.status=e,this.signals.statusChanged.dispatch(e),this}setName(e){return this.parameters.name=e,this.signals.nameChanged.dispatch(e),this}getBox(...e){return this.getBoxUntransformed(...e).clone().applyMatrix4(this.matrix)}getCenter(...e){return this.getCenterUntransformed(...e).clone().applyMatrix4(this.matrix)}getZoom(...e){return this.stage.getZoomForBox(this.getBox(...e))}getBoxUntransformed(...e){return new Ut}getCenterUntransformed(...e){return this.getBoxUntransformed().getCenter(new T)}autoView(e){this.stage.animationControls.zoomMove(this.getCenter(),this.getZoom(),I(e,0))}}class xb{constructor(e=[]){this.list=e;const n=e.length;for(let i=0;i<n;++i)e[i].signals.disposed.add(this._remove,this)}_remove(e){const n=this.list.indexOf(e);n!==-1&&this.list.splice(n,1)}get first(){return this.list.length>0?this.list[0]:void 0}forEach(e){return this.list.forEach(e),this}dispose(){return this.forEach(e=>e.dispose())}}class bb extends xb{setParameters(e){return this.forEach(n=>n.setParameters(e))}setVisibility(e){return this.forEach(n=>n.setVisibility(e))}setSelection(e){return this.forEach(n=>n.setSelection(e))}setColor(e){return this.forEach(n=>n.setColor(e))}update(e){return this.forEach(n=>n.update(e))}build(e){return this.forEach(n=>n.build(e))}dispose(e){return this.forEach(n=>n.dispose())}}const WT=Object.assign({defaultStep:1,defaultTimeout:50,defaultInterpolateType:"",defaultInterpolateStep:5,defaultMode:"loop",defaultDirection:"forward",initialFrame:0},Cm);class jT extends gb{constructor(e,n,i={}){super(e,Object.assign({name:n.name},i)),this.trajectory=n,this.signals=Object.assign(this.signals,{frameChanged:new ot.Signal,playerChanged:new ot.Signal,countChanged:new ot.Signal,parametersChanged:new ot.Signal}),n.signals.frameChanged.add(r=>{this.signals.frameChanged.dispatch(r)}),n.signals.playerChanged.add(r=>{this.signals.playerChanged.dispatch(r)}),n.signals.countChanged.add(r=>{this.signals.countChanged.dispatch(r)}),i.initialFrame!==void 0&&this.setFrame(i.initialFrame)}get defaultParameters(){return WT}get type(){return"trajectory"}setFrame(e){this.trajectory.setFrame(e)}setParameters(e={}){this.trajectory.setParameters(e),this.signals.parametersChanged.dispatch(e)}dispose(){this.trajectory.dispose(),super.dispose()}}class vb{constructor(e,n){this.name=e,this.path=n,this.coordinates=[],this.boxes=[],this.times=[],this.timeOffset=0,this.deltaTime=1}get type(){return"Frames"}}class _b{constructor(e,n){let i,r;if(this.A=new Pt(3,3),this.W=new Pt(1,3),this.U=new Pt(3,3),this.V=new Pt(3,3),this.VH=new Pt(3,3),this.R=new Pt(3,3),this.tmp=new Pt(3,3),this.c=new Pt(3,3),e instanceof Bi)i=e.atomCount;else{if(!(e instanceof Float32Array))return;i=e.length/3}if(n instanceof Bi)r=n.atomCount;else{if(!(n instanceof Float32Array))return;r=n.length/3}const s=Math.min(i,r),o=new Pt(3,s),a=new Pt(3,s);this.coords1t=new Pt(s,3),this.coords2t=new Pt(s,3),this.transformationMatrix=new Ie,this.c.data.set([1,0,0,0,1,0,0,0,-1]),this.prepCoords(e,o,s,!1),this.prepCoords(n,a,s,!1),this._superpose(o,a)}_superpose(e,n){this.mean1=Ip(e),this.mean2=Ip(n),Lp(e,this.mean1),Lp(n,this.mean2),bi(this.coords1t,e),bi(this.coords2t,n),wh(this.A,this.coords2t,this.coords1t),nb(this.A,this.W,this.U,this.V),function(f,d){const p=f.data,y=d.data,g=p[4],m=p[8],x=p[5],v=p[7],b=p[0],_=b*g,C=b*x,w=p[3],S=p[1],M=w*S,B=p[2],L=w*B,U=p[6],E=U*S,O=U*B,k=1/(_*m-C*v-M*m+L*v+E*x-O*g);y[0]=(g*m-x*v)*k,y[1]=-(S*m-B*v)*k,y[2]=-(-S*x+B*g)*k,y[3]=-(w*m-x*U)*k,y[4]=(b*m-O)*k,y[5]=-(C-L)*k,y[6]=-(-w*v+g*U)*k,y[7]=-(b*v-E)*k,y[8]=(_-M)*k}(this.V,this.VH),Ud(this.R,this.U,this.VH),function(f){const d=f.data;return d[0]*d[4]*d[8]-d[0]*d[5]*d[7]-d[3]*d[1]*d[8]+d[3]*d[2]*d[7]+d[6]*d[1]*d[5]-d[6]*d[2]*d[4]}(this.R)<0&&(Ce&&fe.log("R not a right handed system"),Ud(this.tmp,this.c,this.VH),Ud(this.R,this.U,this.tmp));const i=new Pt(4,4),r=new Pt(4,4),s=new Pt(4,4),o=new Pt(4,4),a=new Pt(4,4),c=new Pt(4,4),l=this.R.data,h=this.mean1,u=this.mean2;o.data.set([1,0,0,-h[0],0,1,0,-h[1],0,0,1,-h[2],0,0,0,1]),a.data.set([l[0],l[1],l[2],0,l[3],l[4],l[5],0,l[6],l[7],l[8],0,0,0,0,1]),c.data.set([1,0,0,u[0],0,1,0,u[1],0,0,1,u[2],0,0,0,1]),bi(r,o),wh(i,a,r),bi(s,i),wh(r,c,s),bi(i,r),this.transformationMatrix.elements=i.data}prepCoords(e,n,i,r){let s=0;const o=n.data;let a=3,c=3*i;if(r&&(c=4*i,a=4),e instanceof Bi)e.eachAtom(function(l){s<c&&(o[s+0]=l.x,o[s+1]=l.y,o[s+2]=l.z,r&&(o[s+3]=1),s+=a)});else if(e instanceof Float32Array)for(;s<c;s+=a)s<c&&(o[s]=e[s],o[s+1]=e[s+1],o[s+2]=e[s+2],r&&(o[s+3]=1));else fe.warn("prepCoords: input type unknown")}transform(e){let n;if(e instanceof Bi)n=e.atomCount;else{if(!(e instanceof Float32Array))return;n=e.length/3}const i=new Pt(4,n),r=new Pt(n,4);this.prepCoords(e,i,n,!0);const s=this.transformationMatrix,o=s.determinant();if(!o)return o;const a=new Pt(4,4);a.data=s.elements,function(h,u,f){let d=0,p=0,y=0,g=0,m=0,x=0,v=0,b=0;const _=u.cols,C=u.rows,w=f.cols,S=u.data,M=f.data,B=h.data;let L=0;for(;d<C;g+=_,d++)for(v=0,p=0;p<w;b++,v++,p++){for(x=v,m=g,L=0,y=0;y<_;m++,x+=w,y++)L+=S[m]*M[x];B[b]=L}}(r,i,a);let c=0;const l=r.data;if(e instanceof Bi){e.eachAtom(function(f){f.x=l[c],f.y=l[c+1],f.z=l[c+2],c+=4});const h=new Ie;h.getInverse(s);const u=e.biomolDict;for(let f in u)u.hasOwnProperty(f)&&u[f].partList.forEach(function(d){d.matrixList.forEach(function(p){p.premultiply(s),p.multiply(h)})})}else if(e instanceof Float32Array){const h=4*n;for(;c<h;c+=4)e[c]=l[c],e[c+1]=l[c+1],e[c+2]=l[c+2]}else fe.warn("transform: input type unknown");return this.transformationMatrix}}const qT={step:1,timeout:50,start:0,end:0,interpolateType:"",interpolateStep:5,mode:"loop",direction:"forward"};class XT{constructor(e,n={}){this.signals={startedRunning:new ot.Signal,haltedRunning:new ot.Signal},this._run=!1,this._previousTime=0,this._currentTime=0,this._currentStep=1,e.signals.playerChanged.add(r=>{r!==this&&this.pause()},this);const i=I(e.frameCount,1);this.traj=e,this.parameters=Kn(n,qT),this.parameters.end=Math.min(I(n.end,i-1),i-1),this.parameters.step=I(n.step,Math.ceil((i+1)/100)),this._currentFrame=this.parameters.start,this._direction=this.parameters.direction==="bounce"?"forward":this.parameters.direction,e.signals.countChanged.add(r=>{this.parameters.end=Math.min(I(this.parameters.end,r-1),r-1)},this),this._animate=this._animate.bind(this)}get isRunning(){return this._run}setParameters(e={}){Mx(this.parameters,e),e.direction!==void 0&&this.parameters.direction!=="bounce"&&(this._direction=this.parameters.direction)}_animate(){if(!this._run)return;this._currentTime=window.performance.now();const e=this._currentTime-this._previousTime,n=this.parameters.interpolateType?this.parameters.interpolateStep:1,i=this.parameters.timeout/n,r=this.traj;if(r&&r.frameCount&&!r.inProgress&&e>=i)if(this.parameters.interpolateType)if(this._currentStep>this.parameters.interpolateStep&&(this._currentStep=1),this._currentStep===1&&(this._currentFrame=this._nextInterpolated()),r.hasFrame(this._currentFrame)){this._currentStep+=1;const s=this._currentStep/(this.parameters.interpolateStep+1),[o,a,c,l]=this._currentFrame;r.setFrameInterpolated(o,a,c,l,s,this.parameters.interpolateType),this._previousTime=this._currentTime}else r.loadFrame(this._currentFrame);else{const s=this._next();r.hasFrame(s)?(r.setFrame(s),this._previousTime=this._currentTime):r.loadFrame(s)}window.requestAnimationFrame(this._animate)}_next(){const e=this.parameters;let n;return n=this._direction==="forward"?this.traj.currentFrame+e.step:this.traj.currentFrame-e.step,(n>e.end||n<e.start)&&(e.direction==="bounce"&&(this._direction==="forward"?this._direction="backward":this._direction="forward"),e.mode==="once"?(this.pause(),n=e.direction==="forward"?e.end:e.direction==="backward"||this._direction==="forward"?e.start:e.end):this._direction==="forward"?(n=e.start,e.interpolateType&&(n=Math.min(e.end,n+e.step))):(n=e.end,e.interpolateType&&(n=Math.max(e.start,n-e.step)))),n}_nextInterpolated(){const e=this.parameters,n=this._next();let i,r,s;return this._direction==="forward"?(i=Math.max(e.start,n-e.step),r=Math.max(e.start,n-2*e.step),s=Math.max(e.start,n-3*e.step)):(i=Math.min(e.end,n+e.step),r=Math.min(e.end,n+2*e.step),s=Math.min(e.end,n+3*e.step)),[n,i,r,s]}toggle(){this._run?this.pause():this.play()}play(){if(!this._run){this.traj.player!==this&&this.traj.setPlayer(this),this._currentStep=1;const e=this.parameters,n=this.traj.currentFrame;let i=Math.ceil(n/e.step)*e.step;e.direction==="forward"&&n>=e.end?i=e.start:e.direction==="backward"&&n<=e.start&&(i=e.end),this.traj.setFrame(i),this._run=!0,this._animate(),this.signals.startedRunning.dispatch()}}pause(){this._run=!1,this.signals.haltedRunning.dispatch()}stop(){this.pause(),this.traj.setFrame(this.parameters.start)}}class Hu{constructor(e,n,i={}){this.signals={countChanged:new ot.Signal,frameChanged:new ot.Signal,playerChanged:new ot.Signal},this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this._frameCount=0,this._currentFrame=-1,this._disposed=!1,this.deltaTime=I(i.deltaTime,0),this.timeOffset=I(i.timeOffset,0),this.centerPbc=I(i.centerPbc,!1),this.removePbc=I(i.removePbc,!1),this.removePeriodicity=I(i.removePeriodicity,!1),this.superpose=I(i.superpose,!1),this.name=e.replace(/^.*[\\/]/,""),this.trajPath=e,this.selection=new qt(I(i.sele,"backbone and not hydrogen")),this.selection.signals.stringChanged.add(()=>{this.selectionIndices=this.structure.getAtomIndices(this.selection),this._resetCache(),this._saveInitialCoords(),this.setFrame(this._currentFrame)})}get frameCount(){return this._frameCount}get currentFrame(){return this._currentFrame}_init(e){this.setStructure(e),this._loadFrameCount(),this.setPlayer(new XT(this))}_loadFrameCount(){}setStructure(e){this.structure=e,this.atomCount=e.atomCount,this.backboneIndices=this._getIndices(new qt("backbone and not hydrogen")),this._makeAtomIndices(),this._saveStructureCoords(),this.selectionIndices=this._getIndices(this.selection),this._resetCache(),this._saveInitialCoords(),this.setFrame(this._currentFrame)}_saveInitialCoords(){this.structure.hasCoords()?(this.initialCoords=new Float32Array(this.structureCoords),this._makeSuperposeCoords()):this.frameCache[0]?(this.initialCoords=new Float32Array(this.frameCache[0]),this._makeSuperposeCoords()):this.loadFrame(0,()=>this._saveInitialCoords())}_saveStructureCoords(){this.structureCoords=this.structure.getAtomData({what:{position:!0}}).position}setSelection(e){return this.selection.setString(e),this}_getIndices(e){let n=0;const i=e.test,r=[];return i&&this.structure.eachAtom(s=>{i(s)&&r.push(n),n+=1}),r}_makeSuperposeCoords(){const e=3*this.selectionIndices.length;this.coords1=new Float32Array(e),this.coords2=new Float32Array(e);const n=this.initialCoords,i=this.coords2;for(let r=0;r<e;r+=3){const s=3*this.selectionIndices[r/3];i[r+0]=n[s+0],i[r+1]=n[s+1],i[r+2]=n[s+2]}}_makeAtomIndices(){fe.error("Trajectory._makeAtomIndices not implemented")}_resetCache(){this.frameCache={},this.loadQueue={},this.boxCache={},this.pathCache={},this.frameCacheSize=0,this.initialCoords=new Float32Array(0)}setParameters(e={}){let n=!1;e.centerPbc!==void 0&&e.centerPbc!==this.centerPbc&&(this.centerPbc=e.centerPbc,n=!0),e.removePeriodicity!==void 0&&e.removePeriodicity!==this.removePeriodicity&&(this.removePeriodicity=e.removePeriodicity,n=!0),e.removePbc!==void 0&&e.removePbc!==this.removePbc&&(this.removePbc=e.removePbc,n=!0),e.superpose!==void 0&&e.superpose!==this.superpose&&(this.superpose=e.superpose,n=!0),this.deltaTime=I(e.deltaTime,this.deltaTime),this.timeOffset=I(e.timeOffset,this.timeOffset),n&&(this._resetCache(),this.setFrame(this._currentFrame))}hasFrame(e){return Array.isArray(e)?e.every(n=>!!this.frameCache[n]):!!this.frameCache[e]}setFrame(e,n){return e===void 0||(this.inProgress=!0,e===-1||this.frameCache[e]?(this._updateStructure(e),n&&n()):this.loadFrame(e,()=>{this._updateStructure(e),n&&n()})),this}_interpolate(e,n,i,r,s,o){const a=this.frameCache;let c;c=o==="spline"?function(l,h,u,f,d){const p=l.length,y=new Float32Array(p);for(let g=0;g<p;g+=3){const m=g+1,x=g+2;y[g]=rr(f[g],u[g],h[g],l[g],d,1),y[m]=rr(f[m],u[m],h[m],l[m],d,1),y[x]=rr(f[x],u[x],h[x],l[x],d,1)}return y}(a[e],a[n],a[i],a[r],s):function(l,h,u){const f=l.length,d=new Float32Array(f);for(let p=0;p<f;p+=3){const y=p+1,g=p+2;d[p]=ri(h[p],l[p],u),d[y]=ri(h[y],l[y],u),d[g]=ri(h[g],l[g],u)}return d}(a[e],a[n],s),this.structure.updatePosition(c),this._currentFrame=e,this.signals.frameChanged.dispatch(e)}setFrameInterpolated(e,n,i,r,s,o,a){if(e===void 0)return this;const c=this.frameCache,l=[];return c[r]||l.push(r),c[i]||l.push(i),c[n]||l.push(n),c[e]||l.push(e),l.length?this.loadFrame(l,()=>{this._interpolate(e,n,i,r,s,o),a&&a()}):(this._interpolate(e,n,i,r,s,o),a&&a()),this}loadFrame(e,n){Array.isArray(e)?e.forEach(i=>{this.loadQueue[i]||this.frameCache[i]||(this.loadQueue[i]=!0,this._loadFrame(i,()=>{delete this.loadQueue[i]}))}):this.loadQueue[e]||this.frameCache[e]||(this.loadQueue[e]=!0,this._loadFrame(e,()=>{delete this.loadQueue[e],n&&n()}))}_loadFrame(e,n){fe.error("Trajectory._loadFrame not implemented",e,n)}_updateStructure(e){this._disposed?console.error("updateStructure: traj disposed"):(e===-1?this.structureCoords&&this.structure.updatePosition(this.structureCoords):this.structure.updatePosition(this.frameCache[e]),this.structure.trajectory={name:this.trajPath,frame:e},this._currentFrame=e,this.inProgress=!1,this.signals.frameChanged.dispatch(e))}_doSuperpose(e){const n=3*this.selectionIndices.length,i=this.coords1,r=this.coords2;for(let s=0;s<n;s+=3){const o=3*this.selectionIndices[s/3];i[s+0]=e[o+0],i[s+1]=e[o+1],i[s+2]=e[o+2]}new _b(i,r).transform(e)}_process(e,n,i,r){if(this._setFrameCount(r),n){if(this.backboneIndices.length>0&&this.centerPbc){const s=[n[0],n[4],n[8]],o=function(a,c,l){return[Dd(c,l[0],3,0,a),Dd(c,l[1],3,1,a),Dd(c,l[2],3,2,a)]}(this.backboneIndices,i,s);(function(a,c,l){if(l[0]===0||l[8]===0||l[4]===0)return;const h=a.length,u=l[0],f=l[1],d=l[2],p=-c[0]+u+u/2,y=-c[1]+f+f/2,g=-c[2]+d+d/2;for(let m=0;m<h;m+=3)a[m+0]=(a[m+0]+p)%u,a[m+1]=(a[m+1]+y)%f,a[m+2]=(a[m+2]+g)%d})(i,o,s)}if(this.removePeriodicity){const s=function(o){return[vh(o,3,0),vh(o,3,1),vh(o,3,2)]}(i);(function(o,a,c){if(a[0]===0||a[8]===0||a[4]===0)return;const l=o.length;for(let h=3;h<l;h+=3)for(let u=0;u<3;++u){const f=(o[h+u]-c[u])/a[3*u+u];Math.abs(f)>.5&&(o[h+u]-=a[3*u+u]*Math.round(f))}})(i,n,s)}this.removePbc&&function(s,o){if(o[0]===0||o[8]===0||o[4]===0)return;const a=s.length;for(let c=3;c<a;c+=3)for(let l=0;l<3;++l){const h=s[c+l]-s[c-3+l];if(Math.abs(h)>.9*o[3*l+l])if(h>0)for(let u=0;u<3;++u)s[c+u]-=o[3*l+u];else for(let u=0;u<3;++u)s[c+u]+=o[3*l+u]}}(i,n)}this.selectionIndices.length>0&&this.coords1&&this.superpose&&this._doSuperpose(i),this.frameCache[e]=i,this.boxCache[e]=n,this.frameCacheSize+=1}_setFrameCount(e){e!==this._frameCount&&(this._frameCount=e,this.signals.countChanged.dispatch(e))}dispose(){this._resetCache(),this._disposed=!0,this.player&&this.player.stop()}setPlayer(e){this.player=e,this.signals.playerChanged.dispatch(e)}getFrameTime(e){return this.timeOffset+e*this.deltaTime}}class YT extends Hu{constructor(e,n,i){const r=i||{};r.timeOffset=I(r.timeOffset,e.timeOffset),r.deltaTime=I(r.deltaTime,e.deltaTime),super("",n,r),this.name=e.name,this.path=e.path,this.frames=e.coordinates,this.boxes=e.boxes,this._init(n)}get type(){return"frames"}_makeAtomIndices(){this.structure.type==="StructureView"?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0}_loadFrame(e,n){let i;const r=this.frames[e];if(this.atomIndices){const a=this.atomIndices,c=a.length;i=new Float32Array(3*c);for(let l=0;l<c;++l){const h=3*l,u=3*a[l];i[h+0]=r[u+0],i[h+1]=r[u+1],i[h+2]=r[u+2]}}else i=new Float32Array(r);const s=this.boxes[e],o=this.frames.length;this._process(e,s,i,o),typeof n=="function"&&n()}_loadFrameCount(){this.frames&&this._setFrameCount(this.frames.length)}}class ZT extends Hu{constructor(e,n,i){super("",n,i),this._init(n)}get type(){return"structure"}_makeAtomIndices(){this.structure.atomSet&&this.structure.atomSet.getSize()<this.structure.atomStore.count?this.atomIndices=this.structure.getAtomIndices():this.atomIndices=void 0}_loadFrame(e,n){let i;const r=this.structure,s=r.frames[e];if(this.atomIndices){const c=this.atomIndices,l=c.length;i=new Float32Array(3*l);for(let h=0;h<l;++h){const u=3*h,f=3*c[h];i[u+0]=s[f+0],i[u+1]=s[f+1],i[u+2]=s[f+2]}}else i=new Float32Array(s);const o=r.boxes[e],a=r.frames.length;this._process(e,o,i,a),typeof n=="function"&&n()}_loadFrameCount(){this._setFrameCount(this.structure.frames.length)}}class KT extends Hu{constructor(e,n,i){super(e,n,i),this._init(n)}get type(){return"remote"}_makeAtomIndices(){const e=[];if(this.structure.type==="StructureView"){const n=this.structure.getAtomIndices(),i=n.length;let r=n[0],s=n[0];for(let o=1;o<i;++o){const a=n[o];s+1<a&&(e.push([r,s+1]),r=a),s=a}e.push([r,s+1])}else e.push([0,this.atomCount]);this.atomIndices=e}_loadFrame(e,n){const i=new XMLHttpRequest,r=Ed.getFrameUrl(this.trajPath,e),s=Ed.getFrameParams(this.trajPath,this.atomIndices);i.open("POST",r,!0),i.responseType="arraybuffer",i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.addEventListener("load",()=>{const o=i.response;if(!o)return void fe.error(`empty arrayBuffer for '${r}'`);const a=new Int32Array(o,0,1)[0],c=new Float32Array(o,8,9),l=new Float32Array(o,44);this._process(e,c,l,a),typeof n=="function"&&n()},!1),i.send(s)}_loadFrameCount(){const e=new XMLHttpRequest,n=Ed.getCountUrl(this.trajPath);e.open("GET",n,!0),e.addEventListener("load",()=>{this._setFrameCount(parseInt(e.response))},!1),e.send()}}class JT extends Hu{constructor(e,n,i){super("",n,i),this.requestCallback=e,this._init(n)}get type(){return"callback"}_makeAtomIndices(){const e=[];if(this.structure.type==="StructureView"){const n=this.structure.getAtomIndices(),i=n.length;let r=n[0],s=n[0];for(let o=1;o<i;++o){const a=n[o];s+1<a&&(e.push([r,s+1]),r=a),s=a}e.push([r,s+1])}else e.push([0,this.atomCount]);this.atomIndices=e}_loadFrame(e,n){this.requestCallback((i,r,s,o)=>{this._process(i,r,s,o),typeof n=="function"&&n()},e,this.atomIndices)}_loadFrameCount(){this.requestCallback(e=>this._setFrameCount(e))}}Bi.prototype.getView=function(t){return new wb(this,t)};class wb extends Bi{constructor(e,n){super(),this.structure=e,this.selection=n,this.center=new T,this.boundingBox=new Ut,this._bp=this.getBondProxy(),this._ap=this.getAtomProxy(),this._rp=this.getResidueProxy(),this._cp=this.getChainProxy(),this.selection&&this.selection.signals.stringChanged.add(this.refresh,this),this.structure.signals.refreshed.add(this.refresh,this),this.refresh()}init(){}get type(){return"StructureView"}get name(){return this.structure.name}get path(){return this.structure.path}get title(){return this.structure.title}get id(){return this.structure.id}get data(){return this.structure.data}get atomSetDict(){return this.structure.atomSetDict}get biomolDict(){return this.structure.biomolDict}get entityList(){return this.structure.entityList}get unitcell(){return this.structure.unitcell}get frames(){return this.structure.frames}get boxes(){return this.structure.boxes}get validation(){return this.structure.validation}get bondStore(){return this.structure.bondStore}get backboneBondStore(){return this.structure.backboneBondStore}get rungBondStore(){return this.structure.rungBondStore}get atomStore(){return this.structure.atomStore}get residueStore(){return this.structure.residueStore}get chainStore(){return this.structure.chainStore}get modelStore(){return this.structure.modelStore}get atomMap(){return this.structure.atomMap}get residueMap(){return this.structure.residueMap}get bondHash(){return this.structure.bondHash}get spatialHash(){return this.structure.spatialHash}get _hasCoords(){return this.structure._hasCoords}set _hasCoords(e){this.structure._hasCoords=e}refresh(){Ce&&fe.time("StructureView.refresh"),this.atomSetCache={};const e=this.structure;if(this.selection.isAllSelection()&&e!==this&&e.atomSet&&e.bondSet){this.atomSet=e.atomSet.clone(),this.bondSet=e.bondSet.clone();for(let n in this.atomSetDict){const i=this.atomSetDict[n];this.atomSetCache["__"+n]=i.clone()}this.atomCount=e.atomCount,this.bondCount=e.bondCount,this.boundingBox.copy(e.boundingBox),this.center.copy(e.center)}else if(this.selection.isNoneSelection()&&e!==this&&e.atomSet&&e.bondSet){this.atomSet=new xn(e.atomCount),this.bondSet=new xn(e.bondCount);for(let n in this.atomSetDict)this.atomSetCache["__"+n]=new xn(e.atomCount);this.atomCount=0,this.bondCount=0,this.boundingBox.makeEmpty(),this.center.set(0,0,0)}else{this.atomSet=this.getAtomSet(this.selection,!0),e.atomSet&&(this.atomSet=this.atomSet.intersection(e.atomSet)),this.bondSet=this.getBondSet();for(let n in this.atomSetDict){const i=this.atomSetDict[n];this.atomSetCache["__"+n]=i.makeIntersection(this.atomSet)}this.atomCount=this.atomSet.getSize(),this.bondCount=this.bondSet.getSize(),this.boundingBox=this.getBoundingBox(),this.center=this.boundingBox.getCenter(new T)}Ce&&fe.timeEnd("StructureView.refresh"),this.signals.refreshed.dispatch()}setSelection(e){this.selection=e,this.refresh()}getSelection(e){const n=[];e&&e.string&&n.push(e.string);const i=this.structure.getSelection();i&&i.string&&n.push(i.string),this.selection&&this.selection.string&&n.push(this.selection.string);let r="";return n.length>0&&(r=`( ${n.join(" ) AND ( ")} )`),new qt(r)}getStructure(){return this.structure.getStructure()}eachBond(e,n){this.structure.eachBond(e,this.getSelection(n))}eachAtom(e,n){const i=this.getAtomProxy(),r=this.getAtomSet(n),s=this.atomStore.count;if(r.getSize()<s)r.forEach(function(o){i.index=o,e(i)});else for(let o=0;o<s;++o)i.index=o,e(i)}eachResidue(e,n){this.structure.eachResidue(e,this.getSelection(n))}eachResidueN(e,n){console.error("StructureView.eachResidueN() not implemented")}eachChain(e,n){this.structure.eachChain(e,this.getSelection(n))}eachModel(e,n){this.structure.eachModel(e,this.getSelection(n))}getAtomSet(e,n=!1){let i=this.structure.getAtomSet(e);return!n&&this.atomSet&&(i=i.makeIntersection(this.atomSet)),i}getAtomIndices(e){return this.structure.getAtomIndices(this.getSelection(e))}refreshPosition(){return this.structure.refreshPosition()}dispose(){this.selection&&this.selection.signals.stringChanged.remove(this.refresh,this),this.structure.signals.refreshed.remove(this.refresh,this),this.structure=new Bi,delete this.atomSet,delete this.bondSet}}const QT=[[4,0,-2,-1,-2,0,-2,-1,-1,-1,-1,-2,-1,-1,-1,1,0,0,-3,-2],[0,9,-3,-4,-2,-3,-3,-1,-3,-1,-1,-3,-3,-3,-3,-1,-1,-1,-2,-2],[-2,-3,6,2,-3,-1,-1,-3,-1,-4,-3,1,-1,0,-2,0,-1,-3,-4,-3],[-1,-4,2,5,-3,-2,0,-3,1,-3,-2,0,-1,2,0,0,-1,-2,-3,-2],[-2,-2,-3,-3,6,-3,-1,0,-3,0,0,-3,-4,-3,-3,-2,-2,-1,1,3],[0,-3,-1,-2,-3,6,-2,-4,-2,-4,-3,0,-2,-2,-2,0,-2,-3,-2,-3],[-2,-3,-1,0,-1,-2,8,-3,-1,-3,-2,1,-2,0,0,-1,-2,-3,-2,2],[-1,-1,-3,-3,0,-4,-3,4,-3,2,1,-3,-3,-3,-3,-2,-1,3,-3,-1],[-1,-3,-1,1,-3,-2,-1,-3,5,-2,-1,0,-1,1,2,0,-1,-2,-3,-2],[-1,-1,-4,-3,0,-4,-3,2,-2,4,2,-3,-3,-2,-2,-2,-1,1,-2,-1],[-1,-1,-3,-2,0,-3,-2,1,-1,2,5,-2,-2,0,-1,-1,-1,1,-1,-1],[-2,-3,1,0,-3,0,1,-3,0,-3,-2,6,-2,0,0,1,0,-3,-4,-2],[-1,-3,-1,-1,-4,-2,-2,-3,-1,-3,-2,-2,7,-1,-2,-1,-1,-2,-4,-3],[-1,-3,0,2,-3,-2,0,-3,1,-2,0,0,-1,5,1,0,-1,-2,-2,-1],[-1,-3,-2,0,-3,-2,0,-3,2,-2,-1,0,-2,1,5,-1,-1,-3,-3,-2],[1,-1,0,0,-2,0,-1,-2,0,-2,-1,1,-1,0,-1,4,1,-2,-3,-2],[0,-1,-1,-1,-2,-2,-2,-1,-1,-1,-1,0,-1,-1,-1,1,5,0,-2,-2],[0,-1,-3,-2,-1,-3,-3,3,-2,1,1,-3,-2,-2,-3,-2,0,4,-3,-1],[-3,-2,-4,-3,1,-2,-2,-3,-3,-2,-1,-4,-4,-2,-3,-3,-2,-3,11,2],[-2,-2,-3,-2,3,-3,2,-1,-2,-1,-1,-2,-3,-1,-2,-2,-2,-1,2,7]];function h1(t,e){let n,i=0;const r={};return e.forEach(function(s){n=0;const o={};s.forEach(function(a){o[t[n++]]=a}),r[t[i++]]=o}),r}const eP={blosum62:h1("ARNDCQEGHILKMFPSTWYVBZ?",[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,-1,-1,-2,-2,-1,-3,-3,-2],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1],[-2,-1,3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1]]),blosum62x:h1("ACDEFGHIKLMNPQRSTVWY",QT)};class tP{constructor(e,n,i=-10,r=-1,s="blosum62"){this.seq1=e,this.seq2=n,this.gapPenalty=i,this.gapExtensionPenalty=r,s&&(this.substMatrix=eP[s])}initMatrices(){this.n=this.seq1.length,this.m=this.seq2.length,this.score=void 0,this.ali="",this.S=[],this.V=[],this.H=[];for(let e=0;e<=this.n;++e){this.S[e]=[],this.V[e]=[],this.H[e]=[];for(let n=0;n<=this.m;++n)this.S[e][n]=0,this.V[e][n]=0,this.H[e][n]=0}for(let e=0;e<=this.n;++e)this.S[e][0]=this.gap(0),this.H[e][0]=-1/0;for(let e=0;e<=this.m;++e)this.S[0][e]=this.gap(0),this.V[0][e]=-1/0;this.S[0][0]=0}gap(e){return this.gapPenalty+e*this.gapExtensionPenalty}makeScoreFn(){const e=this.seq1,n=this.seq2,i=this.substMatrix;return i?function(r,s){const o=e[r],a=n[s];try{return i[o][a]}catch{return-4}}:(fe.warn("Alignment: no subst matrix"),function(r,s){return e[r]===n[s]?5:-3})}calc(){Ce&&fe.time("Alignment.calc"),this.initMatrices();const e=this.gap(0),n=this.makeScoreFn(),i=this.gapExtensionPenalty,r=this.V,s=this.H,o=this.S,a=this.n,c=this.m;let l,h,u,f,d;for(let p=1;p<=a;++p){h=o[p-1],l=r[p-1],u=r[p],f=s[p],d=o[p];for(let y=1;y<=c;++y)u[y]=Math.max(h[y]+e,l[y]+i),f[y]=Math.max(d[y-1]+e,f[y-1]+i),d[y]=Math.max(h[y-1]+n(p-1,y-1),u[y],f[y])}Ce&&fe.timeEnd("Alignment.calc"),Ce&&fe.log(this.S,this.V,this.H)}trace(){Ce&&fe.time("Alignment.trace"),this.ali1="",this.ali2="";const e=this.makeScoreFn();let n,i=this.n,r=this.m;for(this.S[i][r]>=this.V[i][r]?(n="S",this.score=this.S[i][r]):this.V[i][r]>=this.H[i][r]?(n="V",this.score=this.V[i][r]):(n="H",this.score=this.H[i][r]),Ce&&fe.log("Alignment: SCORE",this.score),Ce&&fe.log("Alignment: S, V, H",this.S[i][r],this.V[i][r],this.H[i][r]);i>0&&r>0;)n==="S"?this.S[i][r]===this.S[i-1][r-1]+e(i-1,r-1)?(this.ali1=this.seq1[i-1]+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--i,--r,n="S"):this.S[i][r]===this.V[i][r]?n="V":this.S[i][r]===this.H[i][r]?n="H":(--i,--r):n==="V"?this.V[i][r]===this.V[i-1][r]+this.gapExtensionPenalty?(this.ali1=this.seq1[i-1]+this.ali1,this.ali2="-"+this.ali2,--i,n="V"):this.V[i][r]===this.S[i-1][r]+this.gap(0)?(this.ali1=this.seq1[i-1]+this.ali1,this.ali2="-"+this.ali2,--i,n="S"):--i:n==="H"?this.H[i][r]===this.H[i][r-1]+this.gapExtensionPenalty?(this.ali1="-"+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--r,n="H"):this.H[i][r]===this.S[i][r-1]+this.gap(0)?(this.ali1="-"+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--r,n="S"):--r:fe.error("Alignment: no matrix");for(;i>0;)this.ali1=this.seq1[i-1]+this.ali1,this.ali2="-"+this.ali2,--i;for(;r>0;)this.ali1="-"+this.ali1,this.ali2=this.seq2[r-1]+this.ali2,--r;Ce&&fe.timeEnd("Alignment.trace"),Ce&&fe.log([this.ali1,this.ali2])}}function nP(t,e,n=!1,i="",r=""){let s,o,a,c,l;if(n){let u=t,f=e;i&&r&&(u=t.getView(new qt(i)),f=e.getView(new qt(r)));const d=u.getSequence(),p=f.getSequence(),y=new tP(d.join(""),p.join(""));let g,m;y.calc(),y.trace(),s=0,o=0,a=y.ali1.length;const x=[],v=[];for(let S=0;S<a;++S){const M=y.ali1[S],B=y.ali2[S];g=0,m=0,M==="-"?v[o]=!1:(v[o]=!0,g=1),B==="-"?x[s]=!1:(x[s]=!0,m=1),s+=g,o+=m}const b=[],_=[],C=u.getAtomProxy(),w=f.getAtomProxy();s=0,u.eachResidue(function(S){S.traceAtomIndex!==void 0&&S.traceAtomIndex===S.getAtomIndexByName("CA")&&(x[s]&&(C.index=S.getAtomIndexByName("CA"),b.push(C.x,C.y,C.z)),s+=1)}),s=0,f.eachResidue(function(S){S.traceAtomIndex!==void 0&&S.traceAtomIndex===S.getAtomIndexByName("CA")&&(v[s]&&(w.index=S.getAtomIndexByName("CA"),_.push(w.x,w.y,w.z)),s+=1)}),c=new Float32Array(b),l=new Float32Array(_)}else c=t.getView(new qt(`${i} and .CA`)),l=e.getView(new qt(`${r} and .CA`));const h=new _b(c,l).transform(t);return t.refreshPosition(),h}const iP=Object.assign({sele:"",defaultAssembly:""},yb);class kp extends Vu{constructor(e,n,i={}){super(e,n,Object.assign({name:n.name},i)),this.structure=n,this.trajList=[],this.signals=Object.assign(this.signals,{trajectoryAdded:new ot.Signal,trajectoryRemoved:new ot.Signal,defaultAssemblyChanged:new ot.Signal}),this.initSelection(this.parameters.sele),this.pickBuffer=function(r){let s=0,o=0;const a=[];return{has:function(c){return a.indexOf(c)!==-1},get:function(c){return a[c]},push:function(c){a[s]=c,s=(r+s+1)%r,++o},get count(){return o},get data(){return a.slice(0,Math.min(o,r))},clear:function(){o=0,s=0,a.length=0}}}(4),this.pickDict=function(){const r={};return{has:function(s){return r[JSON.stringify(s)]!==void 0},add:function(s,o){r[JSON.stringify(s)]=o},del:function(s){delete r[JSON.stringify(s)]},get values(){return Object.keys(r).map(s=>r[s])}}}(),this.spacefillRepresentation=this.addRepresentation("spacefill",{sele:"none",opacity:La.opacity,color:La.color,disablePicking:!0,radiusType:"data"},!0),this.distanceRepresentation=this.addRepresentation("distance",La,!0),this.angleRepresentation=this.addRepresentation("angle",La,!0),this.dihedralRepresentation=this.addRepresentation("dihedral",La,!0),this.measureRepresentations=new bb([this.spacefillRepresentation,this.distanceRepresentation,this.angleRepresentation,this.dihedralRepresentation]),this.setDefaultAssembly(this.parameters.defaultAssembly),this.structure.signals.refreshed.add(()=>{this.updateRepresentations({position:!0})})}get defaultParameters(){return iP}get type(){return"structure"}initSelection(e){this.selection=new qt(e),this.structureView=new wb(this.structure,this.selection),this.selection.signals.stringChanged.add(()=>{this.structureView.setSelection(this.selection),this.rebuildRepresentations(),this.rebuildTrajectories()})}setSelection(e){return this.parameters.sele=e,this.selection.setString(e),this}setDefaultAssembly(e){if(this.structure.biomolDict[e]===void 0&&(e=""),this.parameters.defaultAssembly!==e){const n={defaultAssembly:e};this.reprList.forEach(i=>i.setParameters(n)),this.measureRepresentations.setParameters(n),this.parameters.defaultAssembly=e,this.signals.defaultAssemblyChanged.dispatch(e)}return this}rebuildRepresentations(){this.reprList.forEach(e=>{e.build()}),this.measureRepresentations.build()}rebuildTrajectories(){this.trajList.forEach(e=>{e.trajectory.setStructure(this.structureView)})}updateRepresentations(e){super.updateRepresentations(e),this.measureRepresentations.update(e)}updateRepresentationMatrices(){super.updateRepresentationMatrices(),this.measureRepresentations.setParameters({matrix:this.matrix})}addRepresentation(e,n={},i=!1){n.defaultAssembly=this.parameters.defaultAssembly;const r=this._addRepresentation(e,this.structureView,n,i);return i||r.signals.parametersChanged.add(()=>this.measureUpdate()),r}addTrajectory(e="",n={}){const i=function(s,o,a){let c;return c=s&&s instanceof vb?new YT(s,o,a):!s&&o.frames?new ZT(s,o,a):s&&typeof s=="function"?new JT(s,o,a):new KT(s,o,a),c}(e,this.structureView,n),r=new jT(this.stage,i,n);return this.trajList.push(r),this.signals.trajectoryAdded.dispatch(r),r}removeTrajectory(e){const n=this.trajList.indexOf(e);n!==-1&&this.trajList.splice(n,1),e.dispose(),this.signals.trajectoryRemoved.dispatch(e)}dispose(){this.trajList.slice().forEach(e=>e.dispose()),this.trajList.length=0,this.structure.dispose(),this.measureRepresentations.dispose(),super.dispose()}autoView(e,n){typeof e=="number"&&(n=e,e=""),this.stage.animationControls.zoomMove(this.getCenter(e),this.getZoom(e),I(n,0))}getBoxUntransformed(e){let n;return n=e?this.structureView.getBoundingBox(new qt(e)):this.structureView.boundingBox,n}getCenterUntransformed(e){return e&&typeof e=="string"?this.structure.atomCenter(new qt(e)):this.structure.center}superpose(e,n,i,r){return nP(this.structureView,e.structureView,n,i,r),this.updateRepresentations({position:!0}),this}getMaxRepresentationRadius(e){let n=0;const i=this.structure.getAtomProxy(e);return this.eachRepresentation(r=>{if(r.getVisibility()){const s=r.repr;n=Math.max(s.getAtomRadius(i),n)}}),n}measurePick(e){const n=this.pickBuffer.count;if(this.lastPick===e.index&&n>=1){if(n>1){const i=this.pickBuffer.data,r=this.pickBuffer.data.sort();this.pickDict.has(r)?this.pickDict.del(r):this.pickDict.add(r,i),n===2?this.distanceRepresentation.setParameters({atomPair:this.pickDict.values.filter(s=>s.length===2)}):n===3?this.angleRepresentation.setParameters({atomTriple:this.pickDict.values.filter(s=>s.length===3)}):n===4&&this.dihedralRepresentation.setParameters({atomQuad:this.pickDict.values.filter(s=>s.length===4)})}this.pickBuffer.clear(),this.lastPick=void 0}else this.pickBuffer.has(e.index)||this.pickBuffer.push(e.index),this.lastPick=e.index;this.measureUpdate()}measureClear(){this.pickBuffer.clear(),this.lastPick=void 0,this.spacefillRepresentation.setSelection("none")}measureBuild(){const e=this.measureData();this.distanceRepresentation.setParameters({atomPair:e.distance}),this.angleRepresentation.setParameters({atomTriple:e.angle}),this.dihedralRepresentation.setParameters({atomQuad:e.dihedral})}measureUpdate(){const e=this.pickBuffer.data,n={};e.forEach(i=>{const r=Math.max(.1,this.getMaxRepresentationRadius(i));n[i]=r*(2.3-Jc(.1,2,r))}),this.spacefillRepresentation.setSelection(e.length?"@"+e.join(","):"none"),e.length&&this.spacefillRepresentation.setParameters({radiusData:n})}measureData(){const e=this.pickDict.values;return{distance:e.filter(n=>n.length===2),angle:e.filter(n=>n.length===3),dihedral:e.filter(n=>n.length===4)}}removeAllMeasurements(e){const n=this.pickDict,i=n.values,r=function(s){i.filter(o=>o.length===s).forEach(o=>n.del(o.slice().sort()))};(!e||1&e)&&r(2),(!e||2&e)&&r(3),(!e||4&e)&&r(4),this.measureBuild()}removeMeasurement(e){this.pickDict.del(e.slice().sort()),this.measureBuild()}addMeasurement(e){if(e.length<2||e.length>4)return;const n=e.slice().sort();this.pickDict.has(n)||this.pickDict.add(n,e),this.measureBuild()}}$o.add("structure",kp),$o.add("structureview",kp);class Sb extends Vu{constructor(e,n,i={}){super(e,n,Object.assign({name:n.name},i)),this.surface=n}get type(){return"surface"}addRepresentation(e,n={}){return this._addRepresentation(e,this.surface,n)}getBoxUntransformed(){return this.surface.boundingBox}getCenterUntransformed(){return this.surface.center}dispose(){this.surface.dispose(),super.dispose()}}$o.add("surface",Sb);class Mb extends Vu{constructor(e,n,i={}){super(e,n,Object.assign({name:n.name},i)),this.volume=n}get type(){return"volume"}addRepresentation(e,n={}){return this._addRepresentation(e,this.volume,n)}getBoxUntransformed(){return this.volume.boundingBox}getCenterUntransformed(){return this.volume.center}dispose(){this.volume.dispose(),super.dispose()}}$o.add("volume",Mb);class u1 extends xb{addRepresentation(e,n){return this.forEach(i=>i.addRepresentation(e,n))}autoView(e){return this.forEach(n=>n.autoView(e))}}function d1(t,e){return t instanceof RegExp?e.name.match(t)!==null:e.name===t}const rP=new T,sP={impostor:!0,quality:"medium",workerDefault:!0,sampleLevel:0,backgroundColor:"black",rotateSpeed:2,zoomSpeed:1.2,panSpeed:1,clipNear:0,clipFar:100,clipDist:10,clipMode:"scene",clipScale:"relative",fogNear:50,fogFar:100,cameraFov:40,cameraEyeSep:.3,cameraType:"perspective",lightColor:14540253,lightIntensity:1,ambientColor:14540253,ambientIntensity:.2,hoverTimeout:0,tooltip:!0,mousePreset:"default"};class oP{constructor(e,n={}){this.signals={parametersChanged:new ot.Signal,fullscreenChanged:new ot.Signal,componentAdded:new ot.Signal,componentRemoved:new ot.Signal,clicked:new ot.Signal,hovered:new ot.Signal},this.tasks=new Bx,this.compList=[],this.defaultFileParams={},this.logList=[],this.viewer=new LA(e),this.viewer.renderer&&(this.tooltip=document.createElement("div"),Object.assign(this.tooltip.style,{display:"none",position:"fixed",zIndex:"1000000",pointerEvents:"none",backgroundColor:"rgba( 0, 0, 0, 0.6 )",color:"lightgrey",padding:"8px",fontFamily:"sans-serif"}),this.viewer.container.appendChild(this.tooltip),this.mouseObserver=new RA(this.viewer.renderer.domElement),this.viewerControls=new FA(this),this.trackballControls=new DA(this),this.pickingControls=new OA(this),this.animationControls=new VA(this),this.mouseControls=new FC(this),this.keyControls=new zC(this),this.pickingBehavior=new GC(this),this.mouseBehavior=new UC(this),this.animationBehavior=new VC(this),this.keyBehavior=new HC(this),this.spinAnimation=this.animationControls.spin([0,1,0],.005),this.spinAnimation.pause(!0),this.rockAnimation=this.animationControls.rock([0,1,0],.005),this.rockAnimation.pause(!0),this.parameters=Kn(n,sP),this.setParameters(this.parameters),this.viewer.animate())}setParameters(e={}){Mx(this.parameters,e);const n=e,i=this.parameters,r=this.viewer,s=this.trackballControls;return n.quality!==void 0&&this.setQuality(i.quality),n.impostor!==void 0&&this.setImpostor(i.impostor),n.rotateSpeed!==void 0&&(s.rotateSpeed=i.rotateSpeed),n.zoomSpeed!==void 0&&(s.zoomSpeed=i.zoomSpeed),n.panSpeed!==void 0&&(s.panSpeed=i.panSpeed),n.mousePreset!==void 0&&this.mouseControls.preset(i.mousePreset),this.mouseObserver.setParameters({hoverTimeout:i.hoverTimeout}),r.setClip(i.clipNear,i.clipFar,i.clipDist,i.clipMode,i.clipScale),r.setFog(void 0,i.fogNear,i.fogFar),r.setCamera(i.cameraType,i.cameraFov,i.cameraEyeSep),r.setSampling(i.sampleLevel),r.setBackground(i.backgroundColor),r.setLight(i.lightColor,i.lightIntensity,i.ambientColor,i.ambientIntensity),this.signals.parametersChanged.dispatch(this.getParameters()),this}log(e){console.log("STAGE LOG",e),this.logList.push(e)}getParameters(){return Object.assign({},this.parameters)}defaultFileRepresentation(e){if(e instanceof kp){let n,i,r;e.setSelection("/0");const s=e.structure;if(s.biomolDict.BU1){const u=s.biomolDict.BU1;n=u.getAtomCount(s),i=u.getResidueCount(s),r=u.getInstanceCount(),e.setDefaultAssembly("BU1")}else n=s.getModelProxy(0).atomCount,i=s.getModelProxy(0).residueCount,r=1;let o=n;Lx&&(o*=4);const a=s.atomStore.count/s.residueStore.count<2;a&&(o*=10);let c="chainname",l="RdYlBu",h=!1;if(s.getChainnameCount(new qt("polymer and /0"))===1&&(c="residueindex",l="Spectral",h=!0),Ce&&console.log(o,n,r,a),i/r<4)e.addRepresentation("ball+stick",{colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"});else if(r>5&&o>15e3||o>7e5){let u=Math.min(2,Math.max(.1,6e3/(o/r)));a&&(u=Math.min(u,.5)),e.addRepresentation("surface",{colorScheme:c,colorScale:l,colorReverse:h,sele:"polymer",surfaceType:"av",probeRadius:1.4,scaleFactor:u,useWorker:!1})}else o>25e4?e.addRepresentation("backbone",{colorScheme:c,colorScale:l,colorReverse:h,lineOnly:!0}):o>1e5?e.addRepresentation("backbone",{colorScheme:c,colorScale:l,colorReverse:h,quality:"low",disableImpostor:!0,radiusScale:2}):o>8e4?e.addRepresentation("backbone",{colorScheme:c,colorScale:l,colorReverse:h,radiusScale:2}):(e.addRepresentation("cartoon",{colorScheme:c,colorScale:l,colorReverse:h,radiusScale:.7,aspectRatio:5,quality:"auto"}),o<5e4&&e.addRepresentation("base",{colorScheme:c,colorScale:l,colorReverse:h,quality:"auto"}),e.addRepresentation("ball+stick",{sele:"ligand",colorScheme:"element",radiusScale:2,aspectRatio:1.5,bondScale:.3,bondSpacing:.75,quality:"auto"}));e.structure.frames.length&&e.addTrajectory()}else(e instanceof Sb||e instanceof Mb)&&e.addRepresentation("surface");this.tasks.onZeroOnce(this.autoView,this)}loadFile(e,n={}){const i=Object.assign({},this.defaultFileParams,n),r=Un(e).name;this.tasks.increment(),this.log(`loading file '${r}'`);const s=I(i.ext,Un(e).ext);let o;return o=it.isTrajectory(s)?Promise.reject(new Error(`loadFile: ext '${s}' is a trajectory and must be loaded into a structure component`)):w0(e,i),o.then(a=>{this.log(`loaded '${r}'`);const c=this.addComponentFromObject(a,i);return i.defaultRepresentation&&this.defaultFileRepresentation(c),this.tasks.decrement(),c},a=>{this.tasks.decrement();const c=`error loading file: '${a}'`;throw this.log(c),c})}loadScript(e){const n=Un(e).name;return this.log(`loading script '${n}'`),w0(e).then(i=>{this.tasks.increment(),this.log(`running script '${n}'`),i.run(this).then(()=>{this.tasks.decrement(),this.log(`finished script '${n}'`)}),this.log(`called script '${n}'`)},i=>{this.tasks.decrement();const r=`errored script '${n}' "${i}"`;throw this.log(r),r})}addComponent(e){e?(this.compList.push(e),this.signals.componentAdded.dispatch(e)):fe.warn("Stage.addComponent: no component given")}addComponentFromObject(e,n={}){const i=$o.get(e.type);if(i){const r=new i(this,e,n);return this.addComponent(r),r}fe.warn("no component for object type",e.type)}removeComponent(e){const n=this.compList.indexOf(e);n!==-1&&(this.compList.splice(n,1),e.dispose(),this.signals.componentRemoved.dispatch(e))}removeAllComponents(){this.compList.slice().forEach(e=>this.removeComponent(e))}handleResize(){this.viewer.handleResize()}setSize(e,n){const i=this.viewer.container;i!==document.body&&(e!==void 0&&(i.style.width=e),n!==void 0&&(i.style.height=n),this.handleResize())}toggleFullscreen(e){if(!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled))return void fe.log("fullscreen mode (currently) not possible");const n=this;function i(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function r(){if(!i()&&n.lastFullscreenElement){const s=n.lastFullscreenElement;s.style.width=s.dataset.normalWidth||"",s.style.height=s.dataset.normalHeight||"",document.removeEventListener("fullscreenchange",r),document.removeEventListener("mozfullscreenchange",r),document.removeEventListener("webkitfullscreenchange",r),document.removeEventListener("MSFullscreenChange",r),n.handleResize(),n.signals.fullscreenChanged.dispatch(!1)}}e=e||this.viewer.container,this.lastFullscreenElement=e,i()?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():(e.dataset.normalWidth=e.style.width||"",e.dataset.normalHeight=e.style.height||"",e.style.width=window.screen.width+"px",e.style.height=window.screen.height+"px",e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),document.addEventListener("fullscreenchange",r),document.addEventListener("mozfullscreenchange",r),document.addEventListener("webkitfullscreenchange",r),document.addEventListener("MSFullscreenChange",r),this.handleResize(),this.signals.fullscreenChanged.dispatch(!0),setTimeout(function(){n.handleResize()},100))}setSpin(e){e?(this.spinAnimation.resume(!0),this.rockAnimation.pause(!0)):this.spinAnimation.pause(!0)}setRock(e){e?(this.rockAnimation.resume(!0),this.spinAnimation.pause(!0)):this.rockAnimation.pause(!0)}toggleSpin(){this.setSpin(this.spinAnimation.paused)}toggleRock(){this.setRock(this.rockAnimation.paused)}getFocus(){const e=this.parameters;if(e.clipMode!=="scene")return 0;let n=e.clipNear;return e.clipScale==="absolute"&&(n=this.viewer.absoluteToRelative(n)),2*n}setFocus(e){if(this.parameters.clipMode!=="scene")return;let n,i,r,s;this.parameters.clipScale==="relative"?(n=Mp(e/2,0,49.9),i=100-n,r=50,s=function(o){return Mp(o,0,100)}(2*i-50)):(n=this.viewer.relativeToAbsolute(e/2),i=n,r=0,s=2*i),this.setParameters({clipNear:n,clipFar:i,fogNear:r,fogFar:s})}getZoomForBox(e){const n=e.getSize(rP),i=Math.max(n.x,n.y,n.z),r=Math.min(n.x,n.y,n.z);let s=i+Math.sqrt(r);const o=rn(this.viewer.perspectiveCamera.fov),a=this.viewer.width,c=this.viewer.height,l=c<a?1:a/c;return s=Math.abs(.5*s/l/Math.sin(o/2)),s+=this.parameters.clipDist,-s}getBox(){return this.viewer.boundingBox}getZoom(){return this.getZoomForBox(this.getBox())}getCenter(e){return this.getBox().getCenter(e||new T)}autoView(e){this.animationControls.zoomMove(this.getCenter(),this.getZoom(),I(e,0))}makeImage(e={}){return new Promise((n,i)=>{this.tasks.onZeroOnce(()=>{this.tasks.increment(),this.viewer.makeImage(e).then(r=>{this.tasks.decrement(),n(r)}).catch(r=>{this.tasks.decrement(),i(r)})})})}setImpostor(e){this.parameters.impostor=e;const n=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation(function(i){if(!n.includes(i.getType()))return;const r=i.getParameters();r.disableImpostor=!e,i.build(r)})}setQuality(e){this.parameters.quality=e;const n=["tube","cartoon","ribbon","trace","rope"],i=["spacefill","ball+stick","licorice","hyperball","backbone","rocket","helixorient","contact","distance","dot"];this.eachRepresentation(function(r){const s=r.getParameters();if(!n.includes(r.getType())){if(!i.includes(r.getType()))return;if(!s.disableImpostor)return void(r.repr.quality=e)}s.quality=e,r.build(s)})}eachComponent(e,n){this.compList.slice().forEach(i=>{n!==void 0&&n!==i.type||e(i)})}eachRepresentation(e,n){this.eachComponent(i=>{i.reprList.slice().forEach(r=>{n!==void 0&&n!==r.getType()||e(r,i)})})}getComponentsByName(e){const n=[];return this.eachComponent(i=>{(e===void 0||d1(e,i))&&n.push(i)}),new u1(n)}getComponentsByObject(e){const n=[];return this.eachComponent(i=>{i.object===e&&n.push(i)}),new u1(n)}getRepresentationsByName(e){const n=[];return this.eachRepresentation((i,r)=>{(e===void 0||d1(e,i))&&n.push(i)}),new bb(n)}measureClear(){this.eachComponent(e=>e.measureClear(),"structure")}measureUpdate(){this.eachComponent(e=>e.measureUpdate(),"structure")}dispose(){this.tasks.dispose(),this.viewer.dispose(),this.mouseObserver.dispose()}}class aP extends Vu{constructor(e,n,i={}){super(e,n,Object.assign({name:n.name},i)),this.shape=n}get type(){return"shape"}addRepresentation(e,n={}){return this._addRepresentation(e,this.shape,n)}getBoxUntransformed(){return this.shape.boundingBox}getCenterUntransformed(){return this.shape.center}dispose(){this.shape.dispose(),super.dispose()}}function Lt(t,e,n,i){var r,s=arguments.length,o=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,n):i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(s<3?r(o):s>3?r(e,n,o):r(e,n))||o);return s>3&&o&&Object.defineProperty(e,n,o),o}$o.add("shape",aP);class f1 extends Et{constructor(e){super(e),e.scale||(this.parameters.scale="rainbow",this.parameters.reverse=I(e.reverse,!0)),this.scalePerModel={},e.structure.eachModel(n=>{this.parameters.domain=[n.atomOffset,n.atomEnd],this.scalePerModel[n.index]=this.getScale()})}atomColor(e){return this.scalePerModel[e.modelIndex](e.index)}}Lt([It],f1.prototype,"atomColor",null),mt.add("atomindex",f1);class p1 extends Et{constructor(e){if(super(e),e.scale||(this.parameters.scale="OrRd"),!e.domain){let n,i=1/0,r=-1/0;e.sele&&(n=new qt(e.sele)),e.structure.eachAtom(function(s){const o=s.bfactor;i=Math.min(i,o),r=Math.max(r,o)},n),this.parameters.domain=[i,r]}this.bfactorScale=this.getScale()}atomColor(e){return this.bfactorScale(e.bfactor)}}Lt([It],p1.prototype,"atomColor",null),mt.add("bfactor",p1);class m1 extends Et{constructor(e){super(e),this.chainidDictPerModel={},this.scalePerModel={},e.scale||(this.parameters.scale="Spectral"),e.structure.eachModel(n=>{let i=0;const r={};n.eachChain(function(s){r[s.chainid]===void 0&&(r[s.chainid]=i,i+=1)}),this.parameters.domain=[0,i-1],this.chainidDictPerModel[n.index]=r,this.scalePerModel[n.index]=this.getScale()})}atomColor(e){const n=this.chainidDictPerModel[e.modelIndex];return this.scalePerModel[e.modelIndex](n[e.chainid])}}Lt([It],m1.prototype,"atomColor",null),mt.add("chainid",m1);class g1 extends Et{constructor(e){super(e),this.scalePerModel={},e.scale||(this.parameters.scale="Spectral"),e.structure.eachModel(n=>{this.parameters.domain=[n.chainOffset,n.chainEnd],this.scalePerModel[n.index]=this.getScale()})}atomColor(e){return this.scalePerModel[e.modelIndex](e.chainIndex)}}Lt([It],g1.prototype,"atomColor",null),mt.add("chainindex",g1);class y1 extends Et{constructor(e){super(e),this.chainnameDictPerModel={},this.scalePerModel={},e.scale||(this.parameters.scale="Spectral"),e.structure.eachModel(n=>{let i=0;const r={};n.eachChain(function(s){r[s.chainname]===void 0&&(r[s.chainname]=i,i+=1)}),this.parameters.domain=[0,i-1],this.chainnameDictPerModel[n.index]=r,this.scalePerModel[n.index]=this.getScale()})}atomColor(e){const n=this.chainnameDictPerModel[e.modelIndex];return this.scalePerModel[e.modelIndex](n[e.chainname])}}Lt([It],y1.prototype,"atomColor",null),mt.add("chainname",y1);class x1 extends Et{constructor(e){super(e),this.rsrzDict={},this.rsccDict={},e.scale||(this.parameters.scale="RdYlBu"),this.rsrzScale=this.getScale({domain:[2,0]}),this.rsccScale=this.getScale({domain:[.678,1]});const n=e.structure.validation;n&&(this.rsrzDict=n.rsrzDict,this.rsccDict=n.rsccDict)}atomColor(e){let n=e.resno+"";e.inscode&&(n+="^"+e.inscode),e.chainname&&(n+=":"+e.chainname),n+="/"+e.modelIndex;const i=this.rsrzDict[n];if(i!==void 0)return this.rsrzScale(i);const r=this.rsccDict[n];return r!==void 0?this.rsccScale(r):9474192}}Lt([It],x1.prototype,"atomColor",null),mt.add("densityfit",x1);const Yd={ARG:{CD:.1,CZ:.5,NE:-.1},ASN:{CG:.55,OD1:-.55},ASP:{CB:-.16,CG:.36,OD1:-.6,OD2:-.6},CYS:{CB:.19,SG:-.19},GLN:{CD:.55,OE1:-.55},GLU:{CD:.36,CG:-.16,OE1:-.6,OE2:-.6},HIS:{CB:.1,CD2:.2,CE1:.45,CG:.15,ND1:.05,NE2:.05},LYS:{CE:.25,NZ:.75},MET:{CE:.06,CG:.06,SD:-.12},PTR:{C:.55,CA:.1,CZ:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SEP:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,O1P:-.85,O2P:-.85,O3P:-.85,OG1:-1.1,P:1.4},SER:{CB:.25,OG:-.25},THR:{CB:.25,OG1:-.25},TPO:{C:.55,CA:.1,CB:.25,N:-.35,O:-.55,OG1:-1.1,O1P:-.85,O2P:-.85,O3P:-.85,P:1.4},TRP:{CD1:.06,CD2:.1,CE2:-.04,CE3:-.03,CG:-.03,NE1:-.06},TYR:{CZ:.25,OH:-.25},backbone:{C:.55,O:-.55,N:-.35,CA:.1}};class b1 extends Et{constructor(e){super(e),this.delta=new T,this.hCharges=[],e.scale||(this.parameters.scale="rwb"),e.domain||(this.parameters.domain=[-50,50]),this.scale=this.getScale(),this.charges=new Float32Array(e.structure.atomCount);const n=[];e.structure.eachAtom(r=>{var s;if(this.charges[r.index]=((s=r).partialCharge!==null?s.partialCharge:s.isProtein()&&(Yd[s.resname]&&Yd[s.resname][s.atomname]||Yd.backbone[s.atomname])||0)*r.occupancy,r.atomname==="N"){if(r.bondCount>=3||r.bondToElementCount(1))return;const o=function(a,c=new T){let l=!1,h=!1,u=!1;return c.set(2*a.x,2*a.y,2*a.z),a.eachBondedAtom(function(f){if(!l)return f.atomname==="H"?(c.set(f.x,f.y,f.z),void(l=!0)):void(h||f.atomname!=="CA"?u||f.atomname!=="C"||(u=!0,c.sub(f)):(c.sub(f),h=!0))}),l?c:h&&u?(c.normalize(),c.multiplyScalar(1.04),c.add(a),c):void 0}(r);o!==void 0&&(n.push(o),this.hCharges.push(.25*r.occupancy))}});const i=e.structure.getBoundingBox();i.expandByScalar(1.04),this.hStore=function(r){const s=r.length,o=new Float32Array(s),a=new Float32Array(s),c=new Float32Array(s);for(let l=0;l<r.length;l++){const h=r[l];o[l]=h.x,a[l]=h.y,c[l]=h.z}return{x:o,y:a,z:c,count:s}}(n),this.hHash=new Uc(this.hStore,i),this.hash=new Uc(e.structure.atomStore,i)}positionColor(e){const n=this.charges,i=this.hCharges;let r=0;return this.hash.eachWithin(e.x,e.y,e.z,12,(s,o)=>{const a=n[s];a!==0&&(r+=a/o)}),this.hHash.eachWithin(e.x,e.y,e.z,12,(s,o)=>{const a=i[s];a!==0&&(r+=a/o)}),this.scale(332*r)}}Lt([It],b1.prototype,"positionColor",null),mt.add("electrostatic",b1);const v1={H:16777215,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578e4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:9699476,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32e3,AC:7384058,TH:47871,PA:41471,U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998,DS:16777215,RG:16777215,CN:16777215,UUT:16777215,FL:16777215,UUP:16777215,LV:16777215,UUH:16777215,D:16777152,T:16777120};class _1 extends Et{constructor(e){e.value=I(e.value,v1.C),super(e)}atomColor(e){const n=e.element;return n==="C"?this.parameters.value:v1[n]||16777215}}Lt([It],_1.prototype,"atomColor",null),mt.add("element",_1);class w1 extends Et{constructor(e){super(e),e.scale||(this.parameters.scale="Spectral"),e.domain||(this.parameters.domain=[0,e.structure.entityList.length-1]),this.entityindexScale=this.getScale()}atomColor(e){return this.entityindexScale(e.entityIndex)}}Lt([It],w1.prototype,"atomColor",null),mt.add("entityindex",w1);class S1 extends Et{atomColor(e){const n=e.entity;switch(n?n.entityType:void 0){case 1:return 8374655;case 2:return 16629894;case 3:return 12496596;case 4:return 3697840;default:return 16777113}}}Lt([It],S1.prototype,"atomColor",null),mt.add("entitytype",S1);class M1 extends Et{constructor(e){super(e),this.geoAtomDict={},this.geoDict={};const n=e.structure.validation;n&&(this.geoAtomDict=n.geoAtomDict,this.geoDict=n.geoDict)}atomColor(e){let n,i=e.resno+"";e.inscode&&(i+="^"+e.inscode),e.chainname&&(i+=":"+e.chainname),i+="/"+e.modelIndex;const r=this.geoAtomDict[i];r!==void 0?(s=r[e.atomname]||0,n=16843009*((s=(858993459&(s-=s>>1&1431655765))+(s>>2&858993459))+(s>>4)&252645135)>>24):n=this.geoDict[i]||0;var s;return n===0?2188972:n===1?16703627:n===2?16018755:n>=3?10813478:9474192}}Lt([It],M1.prototype,"atomColor",null),mt.add("geoquality",M1);class A1 extends Et{constructor(e){super(e),this.resHF={},e.scale||(this.parameters.scale="RdYlGn");for(const n in $0)this.resHF[n]=$0[n][0];if(this.defaultResidueHydrophobicity=eC[0],!e.domain){let n=1/0,i=-1/0;for(const r in this.resHF){const s=this.resHF[r];n=Math.min(n,s),i=Math.max(i,s)}this.parameters.domain=[n,0,i]}this.hfScale=this.getScale()}atomColor(e){return this.hfScale(this.resHF[e.resname]||this.defaultResidueHydrophobicity)}}Lt([It],A1.prototype,"atomColor",null),mt.add("hydrophobicity",A1);class C1 extends Et{constructor(e){super(e),e.scale||(this.parameters.scale="rainbow"),e.domain||(this.parameters.domain=[0,e.structure.modelStore.count]),this.modelindexScale=this.getScale()}atomColor(e){return this.modelindexScale(e.modelIndex)}}Lt([It],C1.prototype,"atomColor",null),mt.add("modelindex",C1);class T1 extends Et{atomColor(e){switch(e.residueType.moleculeType){case 1:return 3697840;case 2:return 15729279;case 3:return 12496596;case 4:return 16629894;case 5:return 12540695;case 6:return 8374655;default:return 16777113}}}Lt([It],T1.prototype,"atomColor",null),mt.add("moleculetype",T1);class P1 extends Et{constructor(e){super(e),e.scale||(this.parameters.scale="PuBu"),e.domain||(this.parameters.domain=[0,1]),this.occupancyScale=this.getScale()}atomColor(e){return this.occupancyScale(e.occupancy)}}Lt([It],P1.prototype,"atomColor",null),mt.add("occupancy",P1);class E1 extends Et{constructor(e){super(e),e.scale||(this.parameters.scale="rwb"),e.domain||(this.parameters.domain=[-1,1]),this.partialchargeScale=this.getScale()}atomColor(e){return this.partialchargeScale(e.partialCharge||0)}}function Zd(){return 16777215*Math.random()}Lt([It],E1.prototype,"atomColor",null),mt.add("partialcharge",E1);class nh extends Et{atomColor(){return Zd()}volumeColor(){return Zd()}positionColor(){return Zd()}}Lt([It],nh.prototype,"atomColor",null),Lt([It],nh.prototype,"volumeColor",null),Lt([It],nh.prototype,"positionColor",null),mt.add("random",nh);class I1 extends Et{constructor(e){super(e),this.rciDict={},e.scale||(this.parameters.scale="RdYlBu"),this.rciScale=this.getScale({domain:[.6,0]});const n=e.structure.validation;n&&(this.rciDict=n.rciDict)}atomColor(e){let n=`[${e.resname}]${e.resno}`;e.chainname&&(n+=":"+e.chainname);const i=this.rciDict[n];return i!==void 0?this.rciScale(i):9474192}}Lt([It],I1.prototype,"atomColor",null),mt.add("randomcoilindex",I1);class L1 extends Et{constructor(e){super(e),this.scalePerChain={},e.scale||(this.parameters.scale="rainbow",this.parameters.reverse=I(e.reverse,!0)),e.structure.eachChain(n=>{this.parameters.domain=[n.residueOffset,n.residueEnd],this.scalePerChain[n.index]=this.getScale()})}atomColor(e){return this.scalePerChain[e.chainIndex](e.residueIndex)}}Lt([It],L1.prototype,"atomColor",null),mt.add("residueindex",L1);const cP={ALA:9240460,ARG:124,ASN:16743536,ASP:10485826,CYS:16777072,GLN:16731212,GLU:6684672,GLY:16777215,HIS:7368959,ILE:19456,LEU:4546117,LYS:4671416,MET:12099650,PHE:5459026,PRO:5395026,SER:16740418,THR:12078080,TRP:5195264,TYR:9203788,VAL:16747775,ASX:16711935,GLX:16711935,ASH:16711935,GLH:16711935,A:14423100,G:3329330,I:10145074,X:8190976,C:16766720,T:4286945,U:4251856,D:35723,DA:14423100,DG:3329330,DI:10145074,DX:8190976,DC:16766720,DT:4286945,DU:4251856,DD:35723};class R1 extends Et{atomColor(e){return cP[e.resname]||16711935}}Lt([It],R1.prototype,"atomColor",null),mt.add("resname",R1);const lP=16711808,hP=10485888,uP=6291584,dP=16762880,fP=6324479,pP=16777215,mP=11403518,gP=16580962,yP=10921722;class D1 extends Et{constructor(e){super(e),this.residueProxy=e.structure.getResidueProxy()}atomColor(e){const n=e.sstruc,i=this.residueProxy;return n==="h"?lP:n==="g"?hP:n==="i"?uP:n==="e"||n==="b"?dP:n==="t"?fP:(i.index=e.residueIndex,i.isDna()?mP:i.isRna()?gP:i.isSaccharide()?yP:i.isProtein()||n==="s"||n==="l"?pP:8421504)}}Lt([It],D1.prototype,"atomColor",null),mt.add("sstruc",D1);class Kd extends Et{constructor(e){var n,i;super(e),e.scale||(this.parameters.scale="rwb"),this.atomData=(n=this.parameters.data)===null||n===void 0?void 0:n.atomData,this.bondData=(i=this.parameters.data)===null||i===void 0?void 0:i.bondData,this.scale=this.getScale(this.parameters)}atomColor(e){var n;const i=(n=this.atomData)===null||n===void 0?void 0:n[e.index];return i!==void 0?this.scale(i):this.parameters.value}bondColor(e,n){var i;const r=(i=this.bondData)===null||i===void 0?void 0:i[e.index];return r!==void 0?this.scale(r):this.atomProxy?(this.atomProxy.index=n?e.atomIndex1:e.atomIndex2,this.atomColor(this.atomProxy)):this.parameters.value}}Lt([It],Kd.prototype,"atomColor",null),Lt([It],Kd.prototype,"bondColor",null),mt.add("structuredata",Kd);class Oa extends Et{atomColor(){return this.parameters.value}bondColor(){return this.parameters.value}valueColor(){return this.parameters.value}volumeColor(){return this.parameters.value}}Lt([It],Oa.prototype,"atomColor",null),Lt([It],Oa.prototype,"bondColor",null),Lt([It],Oa.prototype,"valueColor",null),Lt([It],Oa.prototype,"volumeColor",null),mt.add("uniform",Oa);class B1 extends Et{constructor(e){super(e),this.valueScale=this.getScale()}volumeColor(e){return this.valueScale(this.parameters.volume.data[e])}}Lt([It],B1.prototype,"volumeColor",null),mt.add("value",B1);class O1 extends Et{constructor(e){super(e),this.vec=new T,this.valueScale=this.getScale()}positionColor(e){const n=this.parameters.volume;if(!n||!n.inverseMatrix)return this.parameters.value;const i=this.vec,r=n.data,s=n.nx,o=n.ny,a=s*o;i.copy(e),i.applyMatrix4(n.inverseMatrix);const c=Math.floor(i.x),l=Math.floor(i.y),h=Math.floor(i.z),u=(h*o+l)*s+c,f=u+1,d=u+s,p=u+a,y=d+1,g=p+1,m=d+a,x=m+1,v=r[u],b=r[f],_=r[d],C=r[p],w=r[y],S=r[g],M=r[m],B=r[x],L=i.x-c,U=i.y-l,E=i.z-h,O=ri(v,b,L),k=ri(C,S,L),ne=ri(_,w,L),Y=ri(M,B,L),F=ri(O,ne,U),te=ri(k,Y,U),ee=ri(F,te,E);return this.valueScale(ee)}}Lt([It],O1.prototype,"positionColor",null),mt.add("volume",O1);class Cn extends tl{constructor(e,n,i){const r=i||{};if(super(e,n,r),this.type="structure",this.parameters=Object.assign({radiusType:{type:"select",options:gr.types},radiusData:{type:"hidden"},radiusSize:{type:"number",precision:3,max:10,min:.001},radiusScale:{type:"number",precision:3,max:10,min:.001},assembly:null,defaultAssembly:{type:"hidden"}},this.parameters),this.selection=new qt(r.sele),this.dataList=[],this.structure=e,this.structureView=this.structure.getView(this.selection),e.biomolDict){const s={default:"default","":e.unitcell?"AU":"FULL"};Object.keys(e.biomolDict).forEach(function(o){s[o]=o}),this.parameters.assembly={type:"select",options:s,rebuild:!0}}else this.parameters.assembly=null}get defaultScale(){return{vdw:1,covalent:1,bfactor:.01,sstruc:1}}init(e){const n=e||{};n.colorScheme=I(n.colorScheme,"element"),this.setRadius(n.radius,n),this.radiusType=I(n.radiusType,"vdw"),this.radiusData=I(n.radiusData,{}),this.radiusSize=I(n.radiusSize,1),this.radiusScale=I(n.radiusScale,1),this.assembly=I(n.assembly,"default"),this.defaultAssembly=I(n.defaultAssembly,""),n.quality==="auto"&&(n.quality=this.getQuality()),super.init(n),this.selection.signals.stringChanged.add(()=>{this.build()}),this.build()}setRadius(e,n){const i=Object.keys(lb);return typeof e=="string"&&i.includes(e.toLowerCase())?n.radiusType=e:e!==void 0&&(n.radiusType="size",n.radiusSize=e),this}getAssembly(){const e=this.assembly==="default"?this.defaultAssembly:this.assembly;return this.structure.biomolDict[e]}getQuality(){let e;const n=this.structureView,i=this.getAssembly();return e=i?i.getAtomCount(n):n.atomCount,Lx&&(e*=4),n.atomStore.count/n.residueStore.count<2&&(e*=10),e<15e3?"high":e<8e4?"medium":"low"}create(){if(this.structureView.atomCount===0)return;if(!this.structureView.hasCoords())return void(this.needsBuild=!0);this.needsBuild=!1;const e=this.getAssembly();if(e)e.partList.forEach((n,i)=>{const r=n.getView(this.structureView);if(r.atomCount===0)return;const s=this.createData(r,i);s&&(s.sview=r,s.instanceList=n.getInstanceList(),this.dataList.push(s))});else{const n=this.createData(this.structureView,0);n&&(n.sview=this.structureView,this.dataList.push(n))}}update(e){!this.lazy||this.visible?this.needsBuild?this.build():this.dataList.forEach(n=>{n.bufferList.length>0&&this.updateData(e,n)},this):Object.assign(this.lazyProps.what,e)}updateData(e,n){this.build()}getColorParams(){return Object.assign(Object.assign({},super.getColorParams()),{structure:this.structure})}getRadiusParams(e){return{type:this.radiusType,scale:this.radiusScale,size:this.radiusSize,data:this.radiusData}}getAtomParams(e,n){return Object.assign({what:e,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},n)}getBondParams(e,n){return Object.assign({what:e,colorParams:this.getColorParams(),radiusParams:this.getRadiusParams()},n)}getAtomRadius(e){return this.structureView.atomSet.isSet(e.index)?new gr(this.getRadiusParams()).atomRadius(e):0}setSelection(e,n){return this.selection.setString(e,n),this}setParameters(e,n={},i=!1){const r=e||{};return this.setRadius(r.radius,r),r.radiusType===void 0&&r.radiusData===void 0&&r.radiusSize===void 0&&r.radiusScale===void 0||(n.radius=!0,ki&&!this.disableImpostor||(i=!0)),r.defaultAssembly!==void 0&&r.defaultAssembly!==this.defaultAssembly&&(this.assembly==="default"&&r.assembly===void 0||r.assembly==="default")&&(i=!0),super.setParameters(r,n,i),this}getParameters(){return Object.assign(super.getParameters(),{sele:this.selection?this.selection.string:void 0,defaultAssembly:this.defaultAssembly})}attach(e){const n=this.viewer,i=this.bufferList;this.dataList.forEach(function(r){r.bufferList.forEach(function(s){i.push(s),n.add(s,r.instanceList)})}),this.setVisibility(this.visible),e()}clear(){this.dataList.length=0,super.clear()}dispose(){this.structureView.dispose(),super.dispose()}}class Tm extends Cn{constructor(e,n,i){super(e,n,i),this.n=0,this.parameters=Object.assign({labelVisible:{type:"boolean"},labelSize:{type:"number",precision:3,max:10,min:.001},labelColor:{type:"color"},labelFontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:"fontFamily"},labelFontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:"fontStyle"},labelFontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:"fontWeight"},labelsdf:{type:"boolean",buffer:"sdf"},labelXOffset:{type:"number",precision:1,max:20,min:-20,buffer:"xOffset"},labelYOffset:{type:"number",precision:1,max:20,min:-20,buffer:"yOffset"},labelZOffset:{type:"number",precision:1,max:20,min:-20,buffer:"zOffset"},labelAttachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},labelBorder:{type:"boolean",buffer:"showBorder"},labelBorderColor:{type:"color",buffer:"borderColor"},labelBorderWidth:{type:"number",precision:2,max:.3,min:0,buffer:"borderWidth"},labelBackground:{type:"boolean",rebuild:!0},labelBackgroundColor:{type:"color",buffer:"backgroundColor"},labelBackgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},labelBackgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:"backgroundOpacity"},labelFixedSize:{type:"boolean",buffer:"fixedSize"},lineOpacity:{type:"range",min:0,max:1,step:.01},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters,{flatShaded:null})}init(e){const n=e||{};this.labelVisible=I(n.labelVisible,!0),this.labelSize=I(n.labelSize,2),this.labelColor=I(n.labelColor,16777215),this.labelFontFamily=I(n.labelFontFamily,"sans-serif"),this.labelFontStyle=I(n.labelFontstyle,"normal"),this.labelFontWeight=I(n.labelFontWeight,"bold"),this.labelsdf=I(n.labelsdf,Ex==="Chrome"),this.labelXOffset=I(n.labelXOffset,0),this.labelYOffset=I(n.labelYOffset,0),this.labelZOffset=I(n.labelZOffset,.5),this.labelAttachment=I(n.labelAttachment,"bottom-left"),this.labelBorder=I(n.labelBorder,!1),this.labelBorderColor=I(n.labelBorderColor,"lightgrey"),this.labelBorderWidth=I(n.labelBorderWidth,.15),this.labelBackground=I(n.labelBackground,!1),this.labelBackgroundColor=I(n.labelBackgroundColor,"lightgrey"),this.labelBackgroundMargin=I(n.labelBackgroundMargin,.5),this.labelBackgroundOpacity=I(n.labelBackgroundOpacity,1),this.labelFixedSize=I(n.labelFixedSize,!1),this.lineOpacity=I(n.lineOpacity,1),this.linewidth=I(n.linewidth,2),super.init(n)}update(e){e.position?this.build():super.update(e)}updateData(e,n){const i={};if(e&&!e.labelSize||Object.assign(i,{size:Jn(this.n,this.labelSize)}),!e||e.labelColor){const r=new ke(this.labelColor);Object.assign(i,{color:Bt(this.n,r.r,r.g,r.b)})}this.textBuffer.setAttributes(i)}setParameters(e,n={},i=!1){return e&&e.labelSize&&(n.labelSize=!0),e&&(e.labelColor||e.labelColor===0)&&(n.labelColor=!0,i=!0),super.setParameters(e,n,i),e&&e.opacity!==void 0&&this.textBuffer.setParameters({opacity:1}),e&&e.labelVisible!==void 0&&this.setVisibility(this.visible),this}setVisibility(e,n){return super.setVisibility(e,!0),this.textBuffer&&this.textBuffer.setVisibility(this.labelVisible&&this.visible),n||this.viewer.requestRender(),this}getLabelBufferParams(e={}){return super.getBufferParams(Object.assign({fontFamily:this.labelFontFamily,fontStyle:this.labelFontStyle,fontWeight:this.labelFontWeight,sdf:this.labelsdf,xOffset:this.labelXOffset,yOffset:this.labelYOffset,zOffset:this.labelZOffset,attachment:this.labelAttachment,showBorder:this.labelBorder,borderColor:this.labelBorderColor,borderWidth:this.labelBorderWidth,showBackground:this.labelBackground,backgroundColor:this.labelBackgroundColor,backgroundMargin:this.labelBackgroundMargin,backgroundOpacity:this.labelBackgroundOpacity,fixedSize:this.labelFixedSize,disablePicking:!0,visible:this.labelVisible},e,{opacity:1}))}getAtomRadius(){return 0}}function Pm(t,e){const n=t.getAtomProxy(),i=new qt,r=e.length;if(r===0)return new Float32Array(0);const s=e[0].length,o=t.getAtomSet(),a=new Float32Array(r*s*3);let c=0;return e.forEach(function(l){let h=!1;for(let u=0;u<s;u++){const f=l[u];if(typeof f=="number"&&Number.isInteger(f)){if(!o.get(f)){h=!0;break}n.index=f}else{i.setString(f);const p=t.getAtomIndices(i);if(!p.length){h=!0;break}n.index=p[0]}let d=c+3*u;a[d++]=n.x,a[d++]=n.y,a[d++]=n.z}h||(c+=3*s)}),a.subarray(0,c)}function gi(t,e,n,i,r){const s=Math.cos(r),o=Math.sin(r);t[0]=e[0]+n[0]*s+i[0]*o,t[1]=e[1]+n[1]*s+i[1]*o,t[2]=e[2]+n[2]*s+i[2]*o}function k1(t,e,n,i,r,s,o){for(let a=0;a<e;a++){for(let c=0;c<n;c++)i[c]=t[c*e+a];F1(i,r,s,o,n);for(let c=0;c<n;c++)t[c*e+a]=r[c]}for(let a=0;a<n;a++){for(let c=0;c<e;c++)i[c]=t[a*e+c];F1(i,r,s,o,e);for(let c=0;c<e;c++)t[a*e+c]=Math.sqrt(r[c])}}function F1(t,e,n,i,r){n[0]=0,i[0]=Number.MIN_SAFE_INTEGER,i[1]=Number.MAX_SAFE_INTEGER;for(let s=1,o=0;s<r;s++){let a=(t[s]+s*s-(t[n[o]]+n[o]*n[o]))/(2*s-2*n[o]);for(;a<=i[o];)o--,a=(t[s]+s*s-(t[n[o]]+n[o]*n[o]))/(2*s-2*n[o]);o++,n[o]=s,i[o]=a,i[o+1]=Number.MAX_SAFE_INTEGER}for(let s=0,o=0;s<r;s++){for(;i[o+1]<s;)o++;e[s]=(s-n[o])*(s-n[o])+t[n[o]]}}At.add("shader/SDFFont.vert",`uniform float clipNear;
uniform float clipRadius;
uniform vec3 clipCenter;
uniform float xOffset;
uniform float yOffset;
uniform float zOffset;
uniform bool ortho;
uniform float canvasHeight;
uniform float pixelRatio;
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )
varying vec3 vViewPosition;
#endif
varying vec2 texCoord;
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#if defined( PICKING )
#include unpack_color
attribute float primitiveId;
varying vec3 vPickingColor;
#else
#include color_pars_vertex
#endif
attribute vec2 mapping;
attribute vec2 inputTexCoord;
attribute float inputSize;
#include matrix_scale
#include common
void main(void){
#if defined( PICKING )
vPickingColor = unpackColor( primitiveId );
#else
#include color_vertex
#endif
texCoord = inputTexCoord;
float scale = matrixScale( modelViewMatrix );
float _xOffset = xOffset * scale;
float _yOffset = yOffset * scale;
float _zOffset = zOffset * scale;
if( texCoord.x == 10.0 ){
_zOffset -= 0.001;
}
vec4 cameraPos = modelViewMatrix * vec4( position, 1.0 );
#ifdef FIXED_SIZE
if ( ortho ) {
scale /= pixelRatio * (( canvasHeight / 2.0 ) / -cameraPosition.z) * 0.1;
} else {
scale /= pixelRatio * (( canvasHeight / 2.0 ) / -cameraPos.z) * 0.1;
}
#endif
vec4 cameraCornerPos = vec4( cameraPos.xyz, 1.0 );
cameraCornerPos.xy += mapping * inputSize * 0.01 * scale;
cameraCornerPos.x += _xOffset;
cameraCornerPos.y += _yOffset;
if( ortho ){
cameraCornerPos.xyz += normalize( -cameraPosition ) * _zOffset;
} else {
cameraCornerPos.xyz += normalize( -cameraCornerPos.xyz ) * _zOffset;
}
gl_Position = projectionMatrix * cameraCornerPos;
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || ( !defined( PICKING ) && !defined( NOLIGHT ) )
vViewPosition = -cameraCornerPos.xyz;
#endif
#if defined( RADIUS_CLIP )
vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;
#endif
#include nearclip_vertex
#include radiusclip_vertex
}`),At.add("shader/SDFFont.frag",`uniform sampler2D fontTexture;
uniform float opacity;
uniform bool showBorder;
uniform vec3 borderColor;
uniform float borderWidth;
uniform vec3 backgroundColor;
uniform float backgroundOpacity;
uniform float clipNear;
uniform float clipRadius;
varying vec3 vViewPosition;
varying vec2 texCoord;
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#if defined( PICKING )
uniform float objectId;
varying vec3 vPickingColor;
const vec3 vColor = vec3( 0.0 );
#else
#include common
#include color_pars_fragment
#include fog_pars_fragment
#endif
const float gamma = 2.2 * 1.4142 / 128.0;
const float padding = 0.75;
void main(){
#include nearclip_fragment
#include radiusclip_fragment
if( texCoord.x > 1.0 ){
gl_FragColor = vec4( backgroundColor, backgroundOpacity );
}else{
float sdf = texture2D( fontTexture, texCoord ).a;
if( showBorder ) sdf += borderWidth;
float a = smoothstep(padding - gamma, padding + gamma, sdf);
if( a < 0.2 ) discard;
a *= opacity;
vec3 outgoingLight = vColor;
if( showBorder && sdf < ( padding + borderWidth ) ){
outgoingLight = borderColor;
}
gl_FragColor = vec4( outgoingLight, a );
}
#if defined( PICKING )
if( opacity < 0.3 )
discard;
gl_FragColor = vec4( vPickingColor, objectId );
#else
#include premultiplied_alpha_fragment
#include tonemapping_fragment
#include encodings_fragment
#include fog_fragment
#endif
}`);const Jd={},xP={font:"sans-serif",size:36,style:"normal",variant:"normal",weight:"normal",outline:3,width:1024,height:1024};class bP{constructor(e={}){this.gamma=1,this.mapped={},this.scratchW=0,this.scratchH=0,this.currentX=0,this.currentY=0,this.cutoff=.25,this.parameters=Kn(e,xP);const n=this.parameters;this.radius=n.size/8,this.padding=n.size/3;const i=this.lineHeight=n.size+2*n.outline+Math.round(n.size/4),r=this.maxWidth=n.width/4,s=this.canvas=document.createElement("canvas");s.width=r,s.height=i;const o=this.context=this.canvas.getContext("2d");o.font=`${n.style} ${n.variant} ${n.weight} ${n.size}px ${n.font}`,o.fillStyle="black",o.textAlign="left",o.textBaseline="bottom",o.lineJoin="round",this.gridOuter=new Float64Array(i*r),this.gridInner=new Float64Array(i*r),this.f=new Float64Array(Math.max(i,r)),this.d=new Float64Array(Math.max(i,r)),this.z=new Float64Array(Math.max(i,r)+1),this.v=new Int16Array(Math.max(i,r)),this.data=new Uint8Array(n.width*n.height*4),this.canvas2=document.createElement("canvas"),this.canvas2.width=n.width,this.canvas2.height=n.height,this.context2=this.canvas2.getContext("2d"),this.placeholder=this.map("");for(let a=32;a<=126;++a)this.map(String.fromCharCode(a));this.map(""),this.map(""),this.texture=new gc(this.canvas2),this.texture.flipY=!1,this.texture.needsUpdate=!0}map(e){const n=this.parameters;return this.mapped[e]===void 0&&(this.draw(e),this.currentX+this.scratchW>n.width&&(this.currentX=0,this.currentY+=this.scratchH),this.currentY+this.scratchH>n.height&&console.warn("canvas to small"),this.mapped[e]={x:this.currentX,y:this.currentY,w:this.scratchW,h:this.scratchH},this.context2.drawImage(this.canvas,0,0,this.scratchW,this.scratchH,this.currentX,this.currentY,this.scratchW,this.scratchH),this.currentX+=this.scratchW),this.mapped[e]}get(e){return this.mapped[e]||this.placeholder}draw(e){const n=this.parameters,i=this.lineHeight,r=n.outline,s=this.context,o=this.maxWidth,a=r,c=i-n.outline,l=s.measureText(e),h=Math.min(o,Math.ceil(l.width+2*a+1)),u=h*i;s.clearRect(0,0,h,i),s.fillText(e,a,c);const f=s.getImageData(0,0,h,i),d=f.data;for(let p=0;p<u;p++){const y=f.data[4*p+3]/255;this.gridOuter[p]=y===1?0:y===0?Number.MAX_SAFE_INTEGER:Math.pow(Math.max(0,.5-y),2),this.gridInner[p]=y===1?Number.MAX_SAFE_INTEGER:y===0?0:Math.pow(Math.max(0,y-.5),2)}k1(this.gridOuter,h,i,this.f,this.d,this.v,this.z),k1(this.gridInner,h,i,this.f,this.d,this.v,this.z);for(let p=0;p<u;p++){const y=this.gridOuter[p]-this.gridInner[p];d[4*p+3]=Math.max(0,Math.min(255,Math.round(255-255*(y/this.radius+this.cutoff))))}s.putImageData(f,0,0),this.scratchW=h,this.scratchH=i}}const vP=Object.assign({fontFamily:"sans-serif",fontStyle:"normal",fontWeight:"bold",fontSize:36,xOffset:0,yOffset:0,zOffset:.5,attachment:"bottom-left",showBorder:!1,borderColor:"lightgrey",borderWidth:.15,showBackground:!1,backgroundColor:"lightgrey",backgroundMargin:.5,backgroundOpacity:1,forceTransparent:!0,fixedSize:!1},Bn),_P=Object.assign({fontFamily:{uniform:!0},fontStyle:{uniform:!0},fontWeight:{uniform:!0},fontSize:{uniform:!0},xOffset:{uniform:!0},yOffset:{uniform:!0},zOffset:{uniform:!0},showBorder:{uniform:!0},borderColor:{uniform:!0},borderWidth:{uniform:!0},backgroundColor:{uniform:!0},backgroundOpacity:{uniform:!0},fixedSize:{updateShader:!0}},Ds);function N1(t,e){const n=t.position.length/3;let i=0;for(let r=0;r<n;++r)i+=t.text[r].length;return e.showBackground&&(i+=n),i}class ra extends Mm{constructor(e,n={}){super({position:new Float32Array(3*N1(e,n)),color:new Float32Array(3*N1(e,n)),picking:new EC},n),this.parameterTypes=_P,this.alwaysTransparent=!0,this.hasWireframe=!1,this.isText=!0,this.vertexShader="SDFFont.vert",this.fragmentShader="SDFFont.frag",this.text=e.text,this.positionCount=e.position.length/3,this.addUniforms({fontTexture:{value:null},xOffset:{value:this.parameters.xOffset},yOffset:{value:this.parameters.yOffset},zOffset:{value:this.parameters.zOffset},ortho:{value:!1},showBorder:{value:this.parameters.showBorder},borderColor:{value:new ke(this.parameters.borderColor)},borderWidth:{value:this.parameters.borderWidth},backgroundColor:{value:new ke(this.parameters.backgroundColor)},backgroundOpacity:{value:this.parameters.backgroundOpacity},canvasHeight:{value:1},pixelRatio:{value:1}}),this.addAttributes({inputTexCoord:{type:"v2",value:null},inputSize:{type:"f",value:null}}),this.setAttributes(e),this.makeTexture(),this.makeMapping()}get defaultParameters(){return vP}makeMaterial(){super.makeMaterial();const e=this.texture,n=this.material;n.transparent=!0,n.extensions.derivatives=!0,n.lights=!1,n.uniforms.fontTexture.value=e,n.needsUpdate=!0;const i=this.wireframeMaterial;i.transparent=!0,i.extensions.derivatives=!0,i.lights=!1,i.uniforms.fontTexture.value=e,i.needsUpdate=!0;const r=this.pickingMaterial;r.extensions.derivatives=!0,r.lights=!1,r.uniforms.fontTexture.value=e,r.needsUpdate=!0}setAttributes(e={}){let n,i,r,s,o,a;const c=this.text,l=this.geometry.attributes;e.position&&(n=e.position,s=l.position.array,l.position.needsUpdate=!0),e.size&&(i=e.size,o=l.inputSize.array,l.inputSize.needsUpdate=!0),e.color&&(r=e.color,a=l.color.array,l.color.needsUpdate=!0);const h=this.positionCount;let u,f,d,p,y,g=0;for(let m=0;m<h;++m)for(f=3*m,d=c[m],y=d.length,this.parameters.showBackground&&(y+=1),p=0;p<y;++p,++g)for(let x=0;x<4;x++)u=4*g*3+3*x,n&&(s[u]=n[f],s[u+1]=n[f+1],s[u+2]=n[f+2]),i&&(o[4*g+x]=i[m]),r&&(a[u]=r[f],a[u+1]=r[f+1],a[u+2]=r[f+2])}makeTexture(){this.textAtlas=function(e){const n=JSON.stringify(e);return Jd[n]===void 0&&(Jd[n]=new bP(e)),Jd[n]}({font:this.parameters.fontFamily,style:this.parameters.fontStyle,weight:this.parameters.fontWeight,size:this.parameters.fontSize}),this.texture=this.textAtlas.texture}makeMapping(){const e=this.textAtlas,n=this.text,i=this.parameters.attachment,r=e.lineHeight*this.parameters.backgroundMargin*.1-10,s=this.geometry.attributes,o=s.inputTexCoord.array,a=s.mapping.array,c=this.positionCount;let l,h,u,f,d,p,y,g,m=0;for(let x=0;x<c;++x){for(u=n[x],f=0,p=u.length,d=0;d<p;++d)l=e.get(u[d]),f+=l.w-2*e.parameters.outline;for(g=i.startsWith("top")?e.lineHeight/1.25:i.startsWith("middle")?e.lineHeight/2.5:0,y=i.endsWith("right")?f:i.endsWith("center")?f/2:0,y+=e.parameters.outline,g+=e.parameters.outline,this.parameters.showBackground&&(h=2*m*4,a[h+0]=-e.lineHeight/6-y-r,a[h+1]=e.lineHeight-g+r,a[h+2]=-e.lineHeight/6-y-r,a[h+3]=0-g-r,a[h+4]=f+e.lineHeight/6-y+2*e.parameters.outline+r,a[h+5]=e.lineHeight-g+r,a[h+6]=f+e.lineHeight/6-y+2*e.parameters.outline+r,a[h+7]=0-g-r,o[h+0]=10,o[h+2]=10,o[h+4]=10,o[h+6]=10,m+=1),f=0,d=0;d<p;++d,++m){l=e.get(u[d]),h=2*m*4,a[h+0]=f-y,a[h+1]=l.h-g,a[h+2]=f-y,a[h+3]=0-g,a[h+4]=f+l.w-y,a[h+5]=l.h-g,a[h+6]=f+l.w-y,a[h+7]=0-g;const v=e.parameters.width,b=e.parameters.height,_=[l.x/v,l.y/b,l.x/v,(l.y+l.h)/b,(l.x+l.w)/v,l.y/b,(l.x+l.w)/v,(l.y+l.h)/b];o.set(_,h),f+=l.w-2*e.parameters.outline}}s.inputTexCoord.needsUpdate=!0,s.mapping.needsUpdate=!0}getDefines(e){const n=super.getDefines(e);return this.parameters.fixedSize&&(n.FIXED_SIZE=1),n}setUniforms(e){!e||e.fontFamily===void 0&&e.fontStyle===void 0&&e.fontWeight===void 0&&e.fontSize===void 0||(this.makeTexture(),this.makeMapping(),this.texture.needsUpdate=!0,e.fontTexture=this.texture),super.setUniforms(e)}}Qn.add("text",ra),At.add("shader/WideLine.vert",`
uniform float clipNear;
uniform vec3 clipCenter;
uniform float linewidth;
uniform vec2 resolution;
uniform mat4 projectionMatrixInverse;
attribute vec2 mapping;
attribute vec3 position1;
attribute vec3 position2;
#ifdef PICKING
#include unpack_color
attribute float primitiveId;
varying vec3 vPickingColor;
#else
attribute vec3 color2;
varying vec3 vColor;
varying vec3 vColor2;
varying float flag;
varying vec3 vViewPosition;
#endif
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
void trimSegment( const in vec4 start, inout vec4 end ) {
float a = projectionMatrix[ 2 ][ 2 ]; float b = projectionMatrix[ 3 ][ 2 ]; float nearEstimate = - 0.5 * b / a;
float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );
end.xyz = mix( start.xyz, end.xyz, alpha );
}
void main() {
float aspect = resolution.x / resolution.y;
#ifdef PICKING
vPickingColor = unpackColor( primitiveId );
#else
flag = mapping.y;
vColor = color;
vColor2 = color2;
#endif
vec4 start = modelViewMatrix * vec4( position1, 1.0 );
vec4 end = modelViewMatrix * vec4( position2, 1.0 );
bool perspective = ( projectionMatrix[ 2 ][ 3 ] == -1.0 ); if ( perspective ) {
if ( start.z < 0.0 && end.z >= 0.0 ) {
trimSegment( start, end );
} else if ( end.z < 0.0 && start.z >= 0.0 ) {
trimSegment( end, start );
}
}
vec4 clipStart = projectionMatrix * start;
vec4 clipEnd = projectionMatrix * end;
vec2 ndcStart = clipStart.xy / clipStart.w;
vec2 ndcEnd = clipEnd.xy / clipEnd.w;
vec2 dir = ndcEnd - ndcStart;
dir.x *= aspect;
dir = normalize( dir );
vec2 offset = vec2( dir.y, - dir.x );
dir.x /= aspect;
offset.x /= aspect;
if ( mapping.x < 0.0 ) offset *= - 1.0;
offset *= linewidth;
offset /= resolution.y;
vec4 clip = ( mapping.y < 0.5 ) ? clipStart : clipEnd;
offset *= clip.w;
clip.xy += offset;
gl_Position = clip;
#ifndef PICKING
vViewPosition = ( projectionMatrixInverse * clip ).xyz;
#endif
#if defined( RADIUS_CLIP )
vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;
#endif
#include nearclip_vertex
}`),At.add("shader/WideLine.frag",`uniform vec3 diffuse;
uniform float opacity;
uniform float clipNear;
uniform float clipRadius;
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
#ifdef PICKING
uniform float objectId;
varying vec3 vPickingColor;
#else
#include common
#include fog_pars_fragment
varying vec3 vViewPosition;
varying vec3 vColor;
varying vec3 vColor2;
varying float flag;
#endif
void main() {
#include nearclip_fragment
#include radiusclip_fragment
#if defined( PICKING )
if( opacity < 0.3 )
discard;
gl_FragColor = vec4( vPickingColor, objectId );
#else
vec3 outgoingLight = vec3( 0.0 );
vec4 diffuseColor = vec4( diffuse, 1.0 );
if ( flag < 0.0 ) {
diffuseColor.rgb *= vColor;
} else {
diffuseColor.rgb *= vColor2;
}
#include alphatest_fragment
outgoingLight = diffuseColor.rgb;
gl_FragColor = vec4( outgoingLight, diffuseColor.a * opacity );
#include premultiplied_alpha_fragment
#include tonemapping_fragment
#include encodings_fragment
#include fog_fragment
#endif
}`);const wP=Object.assign({linewidth:2},Bn),SP=Object.assign({linewidth:{uniform:!0}},Ds);class yr extends Mm{constructor(e,n={}){super(e,n),this.parameterTypes=SP,this.vertexShader="WideLine.vert",this.fragmentShader="WideLine.frag",!e.color2&&e.color&&(e.color2=e.color),this.addUniforms({linewidth:{value:this.parameters.linewidth},resolution:{value:new Te},projectionMatrixInverse:{value:new Ie}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null}}),this.setAttributes(e),this.makeMapping()}get defaultParameters(){return wP}setParameters(e){super.setParameters(e)}}Qn.add("wideline",yr);class MP extends Tm{constructor(e,n,i){super(e,n,i),this.type="angle",this.parameters=Object.assign({atomTriple:{type:"hidden",rebuild:!0},vectorVisible:{type:"boolean",default:!0},arcVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(i)}init(e){const n=e||{};n.side=I(n.side,"double"),n.opacity=I(n.opacity,.5),this.atomTriple=I(n.atomTriple,[]),this.arcVisible=I(n.arcVisible,!0),this.sectorVisible=I(n.sectorVisible,!0),this.vectorVisible=I(n.vectorVisible,!0),super.init(n)}createData(e){if(!e.atomCount||!this.atomTriple.length)return;const n=function(a,c){return function(l){const h=[],u=l.length/9;for(let p=0;p<u;p++){let y=!0;for(let g=p;g<p+3;g+=3)l[g]===l[g+3]&&l[g+1]===l[g+4]&&l[g+2]===l[g+5]&&(y=!1);y&&h.push(p)}const f=new Float32Array(9*h.length);let d=0;return h.forEach(function(p){mn(l,f,9*p,9*d,9),d++}),f}(Pm(a,c))}(e,this.atomTriple),i=function(a,c={}){const l=I(c.angleStep,Math.PI/90),h=a.length/9,u=new Float32Array(h),f=new Float32Array(3*h),d=new Array(h),p=new Float32Array(6*h),y=new Float32Array(6*h),g=new Array(h),m=new Array(h),x=new Array(h);let v=0;const b=st(),_=st(),C=st(),w=st(),S=st(),M=st(),B=st(),L=st(),U=st();for(var E=0;E<h;E++){let j=9*E;Ln(b,a,j),Ln(_,a,j+3),Ln(C,a,j+6);let Z=6*E;lt(b,p,Z),lt(_,y,Z),lt(_,p,Z+3),lt(C,y,Z+3),Qt(w,b,_),Qt(S,C,_),nn(w,w),nn(S,S),Vn(M,w,S);const ce=zr(M),de=Fn(w,S),oe=u[E]=Math.atan2(ce,de);d[E]=(kx*oe).toFixed(1)+"",zr(M)===0&&(M[0]=1,M[1]=0,M[2]=0),Vn(B,M,w),nn(B,B),gi(L,_,w,B,oe/2),lt(L,f,3*E);const V=Math.ceil(oe/l),re=new Float32Array(9*V);x[E]=re;const q=new Float32Array(3*V),J=new Float32Array(3*V);g[E]=q,m[E]=J,yi(U,_,w);const W=function(se,$){const he=9*$,me=3*$;lt(_,re,he),lt(U,re,he+3),lt(U,q,me),gi(U,_,w,B,se),lt(U,re,he+6),lt(U,J,me)};let H=0;for(let se=l;se<oe;se+=l)W(se,H),H++;W(oe,H),v+=V}const O=3*v,k=9*v,ne=new Float32Array(O),Y=new Float32Array(O),F=new Float32Array(k);let te=0,ee=0;for(let j=0;j<h;j++){const Z=g[j],ce=m[j];mn(Z,ne,0,ee,Z.length),mn(ce,Y,0,ee,ce.length),ee+=Z.length;const de=x[j];mn(de,F,0,te,de.length),te+=de.length}return{labelPosition:f,labelText:d,vectorPosition1:p,vectorPosition2:y,arcPosition1:ne,arcPosition2:Y,sectorPosition:F}}(n),r=this.n=i.labelPosition.length/3,s=new ke(this.labelColor);this.textBuffer=new ra({position:i.labelPosition,size:Jn(r,this.labelSize),color:Bt(r,s.r,s.g,s.b),text:i.labelText},this.getLabelBufferParams());const o=new ke(this.colorValue);return this.vectorBuffer=new yr(Ep({position1:i.vectorPosition1,position2:i.vectorPosition2,color:Bt(2*r,o.r,o.g,o.b),color2:Bt(2*r,o.r,o.g,o.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.vectorVisible,opacity:this.lineOpacity})),this.arcLength=i.arcPosition1.length/3,this.arcBuffer=new yr(Ep({position1:i.arcPosition1,position2:i.arcPosition2,color:Bt(this.arcLength,o.r,o.g,o.b),color2:Bt(this.arcLength,o.r,o.g,o.b)}),this.getBufferParams({linewidth:this.linewidth,visible:this.arcVisible,opacity:this.lineOpacity})),this.sectorLength=i.sectorPosition.length/3,this.sectorBuffer=new mr({position:i.sectorPosition,color:Bt(this.sectorLength,o.r,o.g,o.b)},this.getBufferParams({visible:this.sectorVisible})),{bufferList:[this.textBuffer,this.vectorBuffer,this.arcBuffer,this.sectorBuffer]}}updateData(e,n){super.updateData(e,n);const i={},r={},s={};if(e.color){const o=new ke(this.colorValue);Object.assign(i,{color:Bt(2*this.n,o.r,o.g,o.b),color2:Bt(2*this.n,o.r,o.g,o.b)}),Object.assign(r,{color:Bt(this.arcLength,o.r,o.g,o.b),color2:Bt(this.arcLength,o.r,o.g,o.b)}),Object.assign(s,{color:Bt(this.sectorLength,o.r,o.g,o.b)})}this.vectorBuffer.setAttributes(i),this.arcBuffer.setAttributes(r),this.sectorBuffer.setAttributes(s)}setParameters(e){return super.setParameters(e,{},!1),!e||e.vectorVisible===void 0&&e.arcVisible===void 0&&e.sectorVisible===void 0||this.setVisibility(this.visible),e&&e.lineOpacity&&(this.vectorBuffer.setParameters({opacity:e.lineOpacity}),this.arcBuffer.setParameters({opacity:e.lineOpacity})),e&&e.opacity!==void 0&&(this.vectorBuffer.setParameters({opacity:this.lineOpacity}),this.arcBuffer.setParameters({opacity:this.lineOpacity})),e&&e.linewidth&&(this.vectorBuffer.setParameters({linewidth:e.linewidth}),this.arcBuffer.setParameters({linewidth:e.linewidth})),this}setVisibility(e,n){return super.setVisibility(e,!0),this.vectorBuffer&&this.vectorBuffer.setVisibility(this.vectorVisible&&this.visible),this.arcBuffer&&this.arcBuffer.setVisibility(this.arcVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),n||this.viewer.requestRender(),this}}Xt.add("angle",MP);const z1=new T,Qd=new T,ef=new T,AP=new T(0,1,0),Em=Object.assign({radialSegments:1,openEnded:!0},Bn);function G1(t={}){const e=I(t.radialSegments,10),n=I(t.openEnded,!0),i=new Ie().makeRotationX(Math.PI/2),r=new hr(1,1,1,e,1,n);return r.applyMatrix4(i),r}class Ab extends Kr{constructor(e,n={}){super(function(s,o={}){const a=G1(o),c=s.position1.length,l=a.attributes.position.array.length/3,h=c/3,u=new Float32Array(2*h*l);return Ap(h,l,0,u),Ap(h,l,h*l,u),{position:new Float32Array(2*c),color:new Float32Array(2*c),primitiveId:u,picking:s.picking}}(e,n),n,G1(n)),this.updateNormals=!0;const i=e.position1.length,r=e.radius.length;this.__center=new Float32Array(i),this._position=new Float32Array(2*i),this._color=new Float32Array(2*i),this._from=new Float32Array(2*i),this._to=new Float32Array(2*i),this._radius=new Float32Array(2*r),this.setAttributes(e,!0)}get defaultParameters(){return Em}applyPositionTransform(e,n,i){Qd.fromArray(this._from,i),ef.fromArray(this._to,i),e.lookAt(Qd,ef,AP);const r=this._radius[n];z1.set(r,r,Qd.distanceTo(ef)),e.scale(z1)}setAttributes(e={},n){const i={};e.position1&&e.position2&&(Fi(e.position1,e.position2,this.__center),Fi(e.position1,this.__center,this._position),Fi(this.__center,e.position2,this._position,e.position1.length),this._from.set(e.position1),this._from.set(this.__center,e.position1.length),this._to.set(this.__center),this._to.set(e.position2,this.__center.length),i.position=this._position),e.color&&e.color2&&(this._color.set(e.color),this._color.set(e.color2,e.color.length),i.color=this._color),e.radius&&(this._radius.set(e.radius),this._radius.set(e.radius,e.radius.length),i.radius=this._radius),super.setAttributes(i,n)}}At.add("shader/CylinderImpostor.vert",`
attribute vec3 mapping;
attribute vec3 position1;
attribute vec3 position2;
attribute float radius;
varying vec3 axis;varying vec4 base_radius;varying vec4 end_b;varying vec3 U;varying vec3 V;
varying vec4 w;
#ifdef PICKING
#include unpack_color
attribute float primitiveId;
varying vec3 vPickingColor;
#else
attribute vec3 color2;
varying vec3 vColor1;
varying vec3 vColor2;
#endif
uniform mat4 modelViewMatrixInverse;
uniform float ortho;
#include matrix_scale
void main(){
#ifdef PICKING
vPickingColor = unpackColor( primitiveId );
#else
vColor1 = color;
vColor2 = color2;
#endif
base_radius.w = radius * matrixScale( modelViewMatrix );
vec3 center = position;
vec3 dir = normalize( position2 - position1 );
float ext = length( position2 - position1 ) / 2.0;
vec3 cam_dir;
if( ortho == 0.0 ){
cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 0, 1 ) ).xyz - center;
}else{
cam_dir = ( modelViewMatrixInverse * vec4( 0, 0, 1, 0 ) ).xyz;
}
cam_dir = normalize( cam_dir );
vec3 ldir;
float b = dot( cam_dir, dir );
end_b.w = b;
if( b < 0.0 )
ldir = -ext * dir;
else
ldir = ext * dir;
vec3 left = radius * normalize( cross( cam_dir, ldir ) );
vec3 up = radius * normalize( cross( left, ldir ) );
axis = normalize( normalMatrix * ldir );
U = normalize( normalMatrix * up );
V = normalize( normalMatrix * left );
vec4 base4 = modelViewMatrix * vec4( center - ldir, 1.0 );
base_radius.xyz = base4.xyz / base4.w;
vec4 end4 = modelViewMatrix * vec4( center + ldir, 1.0 );
end_b.xyz = end4.xyz / end4.w;
w = modelViewMatrix * vec4(
center + mapping.x*ldir + mapping.y*left + mapping.z*up, 1.0
);
gl_Position = projectionMatrix * w;
gl_Position.z = 0.99;
}`),At.add("shader/CylinderImpostor.frag",`#define STANDARD
#define IMPOSTOR
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 interiorColor;
uniform float interiorDarkening;
uniform float roughness;
uniform float metalness;
uniform float opacity;
uniform float clipNear;
uniform mat4 projectionMatrix;
uniform float ortho;
varying vec3 axis;
varying vec4 base_radius;
varying vec4 end_b;
varying vec3 U;
varying vec3 V;
varying vec4 w;
#ifdef PICKING
uniform float objectId;
varying vec3 vPickingColor;
#else
varying vec3 vColor1;
varying vec3 vColor2;
#include common
#include fog_pars_fragment
#include bsdfs
#include lights_pars_begin
#include lights_physical_pars_fragment
#endif
bool interior = false;
float distSq3( vec3 v3a, vec3 v3b ){
return (
( v3a.x - v3b.x ) * ( v3a.x - v3b.x ) +
( v3a.y - v3b.y ) * ( v3a.y - v3b.y ) +
( v3a.z - v3b.z ) * ( v3a.z - v3b.z )
);
}
float calcDepth( in vec3 cameraPos ){
vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;
return 0.5 + 0.5 * clipZW.x / clipZW.y;
}
float calcClip( vec3 cameraPos ){
return dot( vec4( cameraPos, 1.0 ), vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );
}
void main(){
vec3 ray_target = w.xyz / w.w;
vec3 base = base_radius.xyz; float vRadius = base_radius.w; vec3 end = end_b.xyz; float b = end_b.w;
vec3 ray_origin = vec3(0.0); vec3 ortho_ray_direction = vec3(0.0, 0.0, 1.0); vec3 persp_ray_direction = normalize(ray_origin - ray_target);
vec3 ray_direction = mix(persp_ray_direction, ortho_ray_direction, ortho);

mat3 basis = mat3( U, V, axis );
vec3 diff = ray_target - 0.5 * (base + end);

vec3 P = diff * basis;
float dz = dot( axis, ray_direction );
float radius2 = vRadius*vRadius;
vec3 D = vec3(dot(U, ray_direction),
dot(V, ray_direction),
dz);
float a0 = P.x*P.x + P.y*P.y - radius2;
float a1 = P.x*D.x + P.y*D.y;
float a2 = D.x*D.x + D.y*D.y;
float d = a1*a1 - a0*a2;
if (d < 0.0) {
discard;
}
float dist = (-a1 + sqrt(d)) / a2;
vec3 surface_point = ray_target + dist * ray_direction;
vec3 base_to_surface = surface_point - base;
vec3 _normal = normalize( base_to_surface - axis * dot(base_to_surface, axis) );
float base_cap_test = dot( base_to_surface, axis );
float end_cap_test = dot((surface_point - end), axis);
#ifndef CAP
vec3 new_point2 = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;
vec3 tmp_point2 = new_point2 - base;
#endif
if (base_cap_test < 0.0) {
float dNV;
float near;
vec3 front_point;
if ( ortho == 1.0 ) {
front_point = ray_target;
} else {
dNV = dot(-axis, ray_direction);
near = dot(-axis, (base)) / dNV;
front_point = ray_direction * near + ray_origin;
}
if (dot(front_point - base, front_point-base) > radius2) {
discard;
}
#ifdef CAP
surface_point = front_point;
_normal = axis;
#else
surface_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;
dNV = dot(-axis, ray_direction);
near = dot(axis, end) / dNV;
new_point2 = ray_direction * near + ray_origin;
if (dot(new_point2 - end, new_point2-base) < radius2) {
discard;
}
interior = true;
#endif
}
if( end_cap_test > 0.0 )
{
float dNV;
float near;
vec3 end_point;
if ( ortho == 1.0 ) {
end_point = ray_target;
} else {
dNV = dot(axis, ray_direction);
if (dNV < 0.0) {
discard;
}
near = dot(axis, end) / dNV;
end_point = ray_direction * near + ray_origin;
}

if( dot(end_point - end, end_point-base) > radius2 ) {
discard;
}
#ifdef CAP
surface_point = end_point;
_normal = axis;
#else
surface_point = ray_target + ( (-a1 - sqrt(d)) / a2 ) * ray_direction;
dNV = dot(-axis, ray_direction);
near = dot(-axis, (base)) / dNV;
new_point2 = ray_direction * near + ray_origin;
if (dot(new_point2 - base, new_point2-base) < radius2) {
discard;
}
interior = true;
#endif
}
gl_FragDepthEXT = calcDepth( surface_point );

#ifdef NEAR_CLIP
if( calcClip( surface_point ) > 0.0 ){
dist = (-a1 - sqrt(d)) / a2;
surface_point = ray_target + dist * ray_direction;
if( calcClip( surface_point ) > 0.0 ) {
discard;
}
interior = true;
gl_FragDepthEXT = calcDepth( surface_point );
if( gl_FragDepthEXT >= 0.0 ){
gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / vRadius ) );
}
}else if( gl_FragDepthEXT <= 0.0 ){
dist = (-a1 - sqrt(d)) / a2;
surface_point = ray_target + dist * ray_direction;
interior = true;
gl_FragDepthEXT = calcDepth( surface_point );
if( gl_FragDepthEXT >= 0.0 ){
gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );
}
}
#else
if( gl_FragDepthEXT <= 0.0 ){
dist = (-a1 - sqrt(d)) / a2;
surface_point = ray_target + dist * ray_direction;
interior = true;
gl_FragDepthEXT = calcDepth( surface_point );
if( gl_FragDepthEXT >= 0.0 ){
gl_FragDepthEXT = 0.0 + ( 0.0000001 / vRadius );
}
}
#endif
if (gl_FragDepthEXT < 0.0) {
discard;
}
if (gl_FragDepthEXT > 1.0) {
discard;
}
#ifdef PICKING
if( opacity < 0.3 )
discard;
gl_FragColor = vec4( vPickingColor, objectId );
#else
vec3 vViewPosition = -surface_point;
vec3 vNormal = _normal;
vec3 vColor;
if( distSq3( surface_point, end ) < distSq3( surface_point, base ) ){
if( b < 0.0 ){
vColor = vColor1;
}else{
vColor = vColor2;
}
}else{
if( b > 0.0 ){
vColor = vColor1;
}else{
vColor = vColor2;
}
}
vec4 diffuseColor = vec4( diffuse, opacity );
ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
vec3 totalEmissiveLight = emissive;
#include color_fragment
#include roughnessmap_fragment
#include metalnessmap_fragment
vec3 normal = normalize( vNormal );
vec3 geometryNormal = normal;
#include lights_physical_fragment
#include lights_fragment_begin
#include lights_fragment_end
vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;
if( interior ){
#ifdef USE_INTERIOR_COLOR
outgoingLight.xyz = interiorColor;
#else
#ifdef DIFFUSE_INTERIOR
outgoingLight.xyz = vColor;
#endif
#endif
outgoingLight.xyz *= 1.0 - interiorDarkening;
}
gl_FragColor = vec4( outgoingLight, diffuseColor.a );
#include premultiplied_alpha_fragment
#include tonemapping_fragment
#include encodings_fragment
#include fog_fragment
#endif
}`);const CP=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]),TP=new Uint16Array([0,1,2,1,4,2,2,4,3,4,5,3]);class U1 extends Sm{constructor(e,n={}){super("v3",e,n)}get mapping(){return CP}get mappingIndices(){return TP}get mappingIndicesSize(){return 12}get mappingSize(){return 6}get mappingItemSize(){return 3}}const Cb=Object.assign({openEnded:!1},Bn),PP=Object.assign({openEnded:{updateShader:!0}},Ds);class EP extends U1{constructor(e,n={}){super(e,n),this.parameterTypes=PP,this.isImpostor=!0,this.vertexShader="CylinderImpostor.vert",this.fragmentShader="CylinderImpostor.frag",this.addUniforms({modelViewMatrixInverse:{value:new Ie},ortho:{value:0}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null}}),this.setAttributes(e),this.makeMapping()}get defaultParameters(){return Cb}getDefines(e){const n=U1.prototype.getDefines.call(this,e);return this.parameters.openEnded||(n.CAP=1),n}}Object.assign({disableImpostor:!1},Em,Cb);const vr=class{constructor(t,e={}){return!t.color2&&t.color&&(t.color2=t.color),!ki||e&&e.disableImpostor?new Ab(t,e):new EP(t,e)}};Qn.add("cylinder",vr);class IP extends Cn{constructor(e,n,i){super(e,n,i),this.type="axes",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0,showAxes:{type:"boolean",rebuild:!0},showBox:{type:"boolean",rebuild:!0}},this.parameters,{assembly:null}),this.init(i)}init(e){const n=e||{};n.radiusSize=I(n.radiusSize,.5),n.colorValue=I(n.colorValue,"lightgreen"),n.useInteriorColor=I(n.useInteriorColor,!0),this.showAxes=I(n.showAxes,!0),this.showBox=I(n.showBox,!1),super.init(n)}getPrincipalAxes(){let e;const n=this.getAssembly();return n&&(e=n.partList[0].getSelection()),this.structureView.getPrincipalAxes(e)}getAxesData(e){const n=this.getPrincipalAxes(),i=new ke(this.colorValue);let r=0,s=0;this.showAxes&&(r+=6,s+=3),this.showBox&&(r+=8,s+=12);const o=new Float32Array(3*r),a=Bt(r,i.r,i.g,i.b),c=Jn(r,this.radiusSize),l=new Float32Array(3*s),h=new Float32Array(3*s),u=Bt(s,i.r,i.g,i.b),f=Jn(s,this.radiusSize);let d=0;if(this.showAxes){const y=function(g,m){g.toArray(o,2*d),m.toArray(o,2*d+3),g.toArray(l,d),m.toArray(h,d),d+=3};y(n.begA,n.endA),y(n.begB,n.endB),y(n.begC,n.endC)}if(this.showBox){const y=new T,{d1a:g,d2a:m,d3a:x,d1b:v,d2b:b,d3b:_}=n.getProjectedScaleForAtoms(e);let C=2*d;const w=function(B,L,U){y.copy(n.center).addScaledVector(n.normVecA,B).addScaledVector(n.normVecB,L).addScaledVector(n.normVecC,U),y.toArray(o,C),C+=3};w(g,m,x),w(g,m,_),w(g,b,_),w(g,b,x),w(v,b,_),w(v,b,x),w(v,m,x),w(v,m,_);let S=d;const M=function(B,L){y.fromArray(o,2*d+3*B).toArray(l,S),y.fromArray(o,2*d+3*L).toArray(h,S),S+=3};M(0,1),M(0,3),M(0,6),M(1,2),M(1,7),M(2,3),M(2,4),M(3,5),M(4,5),M(4,7),M(5,6),M(6,7)}const p=new AC(n);return{vertex:{position:o,color:a,radius:c,picking:p},edge:{position1:l,position2:h,color:u,color2:u,radius:f,picking:p}}}create(){const e=this.getAxesData(this.structureView);this.sphereBuffer=new Jr(e.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new vr(e.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]})}createData(e){}updateData(e,n){const i=this.getAxesData(n.sview),r={},s={};e&&!e.position||(Object.assign(r,{position:i.vertex.position}),Object.assign(s,{position1:i.edge.position1,position2:i.edge.position2})),e&&!e.color||(Object.assign(r,{color:i.vertex.color}),Object.assign(s,{color:i.edge.color,color2:i.edge.color})),e&&!e.radius||(Object.assign(r,{radius:i.vertex.radius}),Object.assign(s,{radius:i.edge.radius})),this.sphereBuffer.setAttributes(r),this.cylinderBuffer.setAttributes(s)}}Xt.add("axes",IP);class $u extends Cn{constructor(e,n,i){super(e,n,i),this.type="ball+stick",this.parameters=Object.assign({sphereDetail:!0,radialSegments:!0,openEnded:!0,disableImpostor:!0,aspectRatio:{type:"number",precision:1,max:10,min:1},lineOnly:{type:"boolean",rebuild:!0},cylinderOnly:{type:"boolean",rebuild:!0},multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondScale:{type:"number",precision:2,max:1,min:.01},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0}},this.parameters),this.init(i)}init(e){var n=e||{};n.radiusType=I(n.radiusType,"size"),n.radiusSize=I(n.radiusSize,.15),n.useInteriorColor=I(n.useInteriorColor,!0),this.aspectRatio=I(n.aspectRatio,2),this.lineOnly=I(n.lineOnly,!1),this.cylinderOnly=I(n.cylinderOnly,!1),this.multipleBond=I(n.multipleBond,"off"),this.bondSpacing=I(n.bondSpacing,1),this.bondScale=I(n.bondScale,.4),this.linewidth=I(n.linewidth,2),super.init(n)}getAtomRadius(e){return this.aspectRatio*super.getAtomRadius(e)}getAtomParams(e,n){var i=super.getAtomParams(e,n);return i.radiusParams.scale*=this.aspectRatio,i}getAtomData(e,n,i){return e.getAtomData(this.getAtomParams(n,i))}getBondParams(e,n){return n=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,bondScale:this.bondScale},n),super.getBondParams(e,n)}getBondData(e,n,i){return e.getBondData(this.getBondParams(n,i))}createData(e){const n=[];if(this.lineOnly)this.lineBuffer=new yr(this.getBondData(e,{position:!0,color:!0,picking:!0}),this.getBufferParams({linewidth:this.linewidth})),n.push(this.lineBuffer);else{const i=new vr(this.getBondData(e),this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}));if(n.push(i),!this.cylinderOnly){const r=new Jr(this.getAtomData(e),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0}));n.push(r)}}return{bufferList:n}}updateData(e,n){this.multipleBond!=="off"&&e&&e.radius&&(e.position=!0);const i=this.getBondData(n.sview,e);if(this.lineOnly){const a={};e&&!e.position||Object.assign(a,{position1:i.position1,position2:i.position2}),e&&!e.color||Object.assign(a,{color:i.color,color2:i.color2}),n.bufferList[0].setAttributes(a)}else{var r={};if(e&&!e.position||Object.assign(r,{position1:i.position1,position2:i.position2}),e&&!e.color||Object.assign(r,{color:i.color,color2:i.color2}),e&&!e.radius||Object.assign(r,{radius:i.radius}),n.bufferList[0].setAttributes(r),!this.cylinderOnly){var s=this.getAtomData(n.sview,e),o={};e&&!e.position||Object.assign(o,{position:s.position}),e&&!e.color||Object.assign(o,{color:s.color}),e&&!e.radius||Object.assign(o,{radius:s.radius}),n.bufferList[1].setAttributes(o)}}}setParameters(e={}){let n=!1;const i={};return(e.aspectRatio||e.bondSpacing||e.bondScale)&&(Object.assign(i,{radius:!0}),ki&&!this.disableImpostor||(n=!0)),super.setParameters(e,i,n),this}}Xt.add("ball+stick",$u);class LP extends $u{constructor(e,n,i){super(e,n,i),this.type="backbone",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null}),this.init(i)}init(e){var n=e||{};n.aspectRatio=I(n.aspectRatio,1),n.radiusSize=I(n.radiusSize,.25),super.init(n)}getAtomRadius(e){return e.isTrace()?super.getAtomRadius(e):0}getAtomData(e,n,i){return e.getBackboneAtomData(this.getAtomParams(n,i))}getBondData(e,n,i){return e.getBackboneBondData(this.getBondParams(n,i))}}Xt.add("backbone",LP);class RP extends $u{constructor(e,n,i){super(e,n,i),this.type="base",this.parameters=Object.assign({},this.parameters,{multipleBond:null,bondSpacing:null})}init(e){let n=e||{};n.aspectRatio=I(n.aspectRatio,1),n.radiusSize=I(n.radiusSize,.3),super.init(n)}getAtomData(e,n,i){return e.getRungAtomData(this.getAtomParams(n,i))}getBondData(e,n,i){let r=this.getBondParams(n,i);return Object.assign(r.colorParams,{rung:!0}),e.getRungBondData(r)}}Xt.add("base",RP);class DP{constructor(e,n){this.m=e,this.tension=n,this.dt=1/this.m,this.delta=1e-4,this.vec1=new T,this.vec2=new T,this.vDir=new T,this.vTan=new T,this.vNorm=new T,this.vBin=new T,this.m2=Math.ceil(this.m/2)}interpolateToArr(e,n,i,r,s,o,a){o[a+0]=rr(e.x,n.x,i.x,r.x,s,this.tension),o[a+1]=rr(e.y,n.y,i.y,r.y,s,this.tension),o[a+2]=rr(e.z,n.z,i.z,r.z,s,this.tension)}interpolateToVec(e,n,i,r,s,o){o.x=rr(e.x,n.x,i.x,r.x,s,this.tension),o.y=rr(e.y,n.y,i.y,r.y,s,this.tension),o.z=rr(e.z,n.z,i.z,r.z,s,this.tension)}interpolatePosition(e,n,i,r,s,o){for(var a=0;a<this.m;++a){var c=o+3*a,l=this.dt*a;this.interpolateToArr(e,n,i,r,l,s,c)}}interpolateTangent(e,n,i,r,s,o){for(var a=0;a<this.m;++a){var c=this.dt*a,l=c-this.delta,h=c+this.delta,u=o+3*a;l<0&&(l=0),h>1&&(h=1),this.interpolateToVec(e,n,i,r,l,this.vec1),this.interpolateToVec(e,n,i,r,h,this.vec2),this.vec2.sub(this.vec1).normalize(),this.vec2.toArray(s,u)}}vectorSubdivide(e,n,i,r,s){let o,a=n.next(),c=n.next(),l=n.next();const h=n.size,u=h-1;let f=r||0;for(let d=0;d<u;++d)o=a,a=c,c=l,l=n.next(),e.apply(this,[o,a,c,l,i,f]),f+=3*this.m;s&&(o=n.get(h-2),a=n.get(h-1),c=n.get(0),l=n.get(1),e.apply(this,[o,a,c,l,i,f]),f+=3*this.m)}getPosition(e,n,i,r){e.reset(),this.vectorSubdivide(this.interpolatePosition,e,n,i,r);var s=e.size-1,o=s*this.m*3;r&&(o+=3*this.m);var a=e.get(r?0:s);n[o]=a.x,n[o+1]=a.y,n[o+2]=a.z}getTangent(e,n,i,r){e.reset(),this.vectorSubdivide(this.interpolateTangent,e,n,i,r);let s=(e.size-1)*this.m*3;r&&(s+=3*this.m),mn(n,n,s-3,s,3)}interpolateNormalDir(e,n,i,r,s,o,a,c,l,h,u,f,d){for(let p=0;p<this.m;++p){let y=f+3*p;d&&(y+=3*this.m2);const g=this.dt*p;this.interpolateToVec(e,n,i,r,g,this.vec1),this.interpolateToVec(s,o,a,c,g,this.vec2),this.vDir.subVectors(this.vec2,this.vec1).normalize(),this.vTan.fromArray(l,y),this.vBin.crossVectors(this.vDir,this.vTan).normalize(),this.vBin.toArray(u,y),this.vNorm.crossVectors(this.vTan,this.vBin).normalize(),this.vNorm.toArray(h,y)}}interpolateNormal(e,n,i,r,s){for(var o=0;o<this.m;++o){var a=s+3*o;e.copy(this.vNorm),this.vTan.fromArray(n,a),this.vBin.crossVectors(e,this.vTan).normalize(),this.vBin.toArray(r,a),this.vNorm.crossVectors(this.vTan,this.vBin).normalize(),this.vNorm.toArray(i,a)}}getNormal(e,n,i,r,s,o){this.vNorm.set(0,0,1);const a=e-1;let c=s||0;for(var l=0;l<a;++l)this.interpolateNormal(this.vDir,n,i,r,c),c+=3*this.m;o&&(this.interpolateNormal(this.vDir,n,i,r,c),c+=3*this.m),this.vBin.toArray(r,c),this.vNorm.toArray(i,c)}getNormalDir(e,n,i,r,s,o,a,c){e.reset(),n.reset();const l=new T,h=new T,u=new T,f=new T,d=new T,p=new T().copy(e.next()),y=new T().copy(e.next()),g=new T().copy(e.next()),m=new T,x=new T().copy(n.next()),v=new T().copy(n.next()),b=new T().copy(n.next());this.vNorm.set(0,0,1);let _=e.size,C=_-1,w=o||0;for(var S=0;S<C;++S)d.copy(p),p.copy(y),y.copy(g),g.copy(e.next()),m.copy(x),x.copy(v),v.copy(b),b.copy(n.next()),S===0?(l.subVectors(m,d),h.subVectors(x,p),l.dot(h)<0&&(h.multiplyScalar(-1),x.addVectors(p,h)),u.subVectors(v,y),h.dot(u)<0&&(u.multiplyScalar(-1),v.addVectors(y,u))):u.copy(f),f.subVectors(b,g),u.dot(f)<0&&(f.multiplyScalar(-1),b.addVectors(g,f)),this.interpolateNormalDir(d,p,y,g,m,x,v,b,i,r,s,w,c),w+=3*this.m;if(a&&(d.copy(e.get(_-2)),p.copy(e.get(_-1)),y.copy(e.get(0)),g.copy(e.get(1)),m.copy(n.get(_-2)),x.copy(n.get(_-1)),v.copy(n.get(0)),b.copy(n.get(1)),u.copy(f),f.subVectors(b,g),u.dot(f)<0&&(f.multiplyScalar(-1),b.addVectors(g,f)),this.interpolateNormalDir(d,p,y,g,m,x,v,b,i,r,s,w,c),w+=3*this.m),c){this.vBin.fromArray(s,3*this.m2),this.vNorm.fromArray(r,3*this.m2);for(var M=0;M<this.m2;++M)this.vBin.toArray(s,3*M),this.vNorm.toArray(r,3*M)}else this.vBin.toArray(s,w),this.vNorm.toArray(r,w)}interpolateColor(e,n,i,r,s){var o,a;for(o=0;o<this.m2;++o)a=s+3*o,i.apply(this,[e,r,a]);for(o=this.m2;o<this.m;++o)a=s+3*o,i.apply(this,[n,r,a])}getColor(e,n,i,r,s){let o;e.reset(),e.next();let a=e.next();for(var c=e.size,l=c-1,h=r||0,u=0;u<l;++u)o=a,a=e.next(),this.interpolateColor(o,a,n,i,h),h+=3*this.m;s&&(o=e.get(c-1),a=e.get(0),this.interpolateColor(o,a,n,i,h),h+=3*this.m),i[h]=i[h-3],i[h+1]=i[h-2],i[h+2]=i[h-1]}interpolatePicking(e,n,i,r,s){var o;for(o=0;o<this.m2;++o)r[s+o]=i.apply(this,[e]);for(o=this.m2;o<this.m;++o)r[s+o]=i.apply(this,[n])}getPicking(e,n,i,r,s){let o;e.reset(),e.next();let a=e.next();const c=e.size,l=c-1;let h=r||0;for(var u=0;u<l;++u)o=a,a=e.next(),this.interpolatePicking(o,a,n,i,h),h+=this.m;s&&(o=e.get(c-1),a=e.get(0),this.interpolatePicking(o,a,n,i,h),h+=this.m),i[h]=i[h-1]}interpolateSize(e,n,i,r,s){const o=i.apply(this,[e]),a=i.apply(this,[n]);for(let c=0;c<this.m;++c){let l=c/this.m;r[s+c]=(1-l)*o+l*a}}getSize(e,n,i,r,s){let o;e.reset(),e.next();let a=e.next();const c=e.size,l=c-1;let h=r||0;for(var u=0;u<l;++u)o=a,a=e.next(),this.interpolateSize(o,a,n,i,h),h+=this.m;s&&(o=e.get(c-1),a=e.get(0),this.interpolateSize(o,a,n,i,h),h+=this.m),i[h]=i[h-1]}}class qo{constructor(e,n){this.polymer=e,this.size=e.residueCount;var i=n||{};this.directional=i.directional||!1,this.positionIterator=i.positionIterator||!1,this.subdiv=i.subdiv||1,this.smoothSheet=i.smoothSheet||!1,i.tension?this.tension=i.tension:this.tension=this.polymer.isNucleic()?.5:.9,this.interpolator=new DP(this.subdiv,this.tension)}getAtomIterator(e,n){const i=this.polymer,r=i.structure,s=i.residueCount;let o=0,a=-1;const c=[r.getAtomProxy(),r.getAtomProxy(),r.getAtomProxy(),r.getAtomProxy()],l=[new T,new T,new T,new T];var h=r.getAtomProxy(),u=r.getAtomProxy();function f(d){var p=c[o%4];if(p.index=i.getAtomIndexByType(d,e),n&&d>0&&d<s&&p.sstruc==="e"){var y=l[o%4];return h.index=i.getAtomIndexByType(d+1,e),u.index=i.getAtomIndexByType(d-1,e),y.addVectors(h,u).add(p).add(p).multiplyScalar(.25),o+=1,y}return o+=1,p}return{size:s,next:function(){var d=f(a);return a+=1,d},get:f,reset:function(){o=0,a=-1}}}getSubdividedColor(e){var n=this.subdiv,i=this.polymer,r=(i.residueCount-1)*n*3+3;i.isCyclic&&(r+=3*n);var s=new Float32Array(r),o=this.getAtomIterator("trace"),a=e||{};a.structure=i.structure;var c=mt.getScheme(a);return this.interpolator.getColor(o,function(l,h,u){c.atomColorToArray(l,h,u)},s,0,i.isCyclic),{color:s}}getSubdividedPicking(){var e=this.subdiv,n=this.polymer,i=(n.residueCount-1)*e+1;n.isCyclic&&(i+=e);var r=n.structure,s=this.getAtomIterator("trace"),o=new Float32Array(i);return this.interpolator.getPicking(s,function(a){return a.index},o,0,n.isCyclic),{picking:new Rs(o,r)}}getSubdividedPosition(){return{position:this.getPosition()}}getSubdividedOrientation(){const e=this.getTangent(),n=this.getNormals(e);return{tangent:e,normal:n.normal,binormal:n.binormal}}getSubdividedSize(e){var n=this.subdiv,i=this.polymer,r=(i.residueCount-1)*n+1;i.isCyclic&&(r+=n);var s=new Float32Array(r),o=this.getAtomIterator("trace"),a=new gr(e);return this.interpolator.getSize(o,function(c){return a.atomRadius(c)},s,0,i.isCyclic),{size:s}}getPosition(){const e=this.subdiv,n=this.polymer;let i=(n.residueCount-1)*e*3+3;n.isCyclic&&(i+=3*e);const r=new Float32Array(i),s=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getPosition(s,r,0,n.isCyclic),r}getTangent(){const e=this.subdiv,n=this.polymer;let i=(this.size-1)*e*3+3;n.isCyclic&&(i+=3*e);const r=new Float32Array(i),s=this.positionIterator||this.getAtomIterator("trace",this.smoothSheet);return this.interpolator.getTangent(s,r,0,n.isCyclic),r}getNormals(e){const n=this.subdiv,i=this.polymer,r=i.isProtein(),s=this.size;let o=(s-1)*n*3+3;i.isCyclic&&(o+=3*n);const a=new Float32Array(o),c=new Float32Array(o);if(this.directional&&!this.polymer.isCg()){const l=this.getAtomIterator("direction1"),h=this.getAtomIterator("direction2");this.interpolator.getNormalDir(l,h,e,a,c,0,i.isCyclic,r)}else this.interpolator.getNormal(s,e,a,c,0,i.isCyclic);return{normal:a,binormal:c}}}const V1=new T,ih=new T,BP=Object.assign({radialSegments:4,capped:!1,aspectRatio:1},Bn);class OP extends mr{constructor(e,n={}){super(function(i,r={}){const s=I(r.radialSegments,4),o=I(r.capped,!1),a=o?s:0,c=o?s-2:0,l=i.position.length/3,h=l*s*3+2*a*3,u=2*(l-1)*s*3+2*c*3;return{position:new Float32Array(h),color:new Float32Array(h),index:$i(u,h/3),normal:new Float32Array(h),picking:i.picking}}(e,n),n),this.capVertices=this.parameters.capped?this.parameters.radialSegments:0,this.capTriangles=this.parameters.capped?this.parameters.radialSegments-2:0,this.size2=e.position.length/3,e.primitiveId=ea(this.size2),this.setAttributes(e),this.makeIndex()}get defaultParameters(){return BP}setAttributes(e={}){const n=this.parameters.aspectRatio,i=this.size2,r=i-1,s=this.parameters.radialSegments,o=this.geometry.attributes;let a,c,l,h,u,f,d,p,y,g,m,x,v;e.position&&(a=e.position,c=e.normal,l=e.binormal,h=e.tangent,f=e.size,p=o.position.array,g=o.normal.array,o.position.needsUpdate=!0,o.normal.needsUpdate=!0),e.color&&(u=e.color,y=o.color.array,o.color.needsUpdate=!0),e.primitiveId&&(d=e.primitiveId,m=o.primitiveId.array,o.primitiveId.needsUpdate=!0);let b=0,_=0,C=0,w=0,S=0,M=0,B=0,L=0,U=0,E=0;const O=[],k=[],ne=[],Y=[],F=[],te=[];if(a)for(let ee=0;ee<s;++ee){const j=ee/s*2*Math.PI;O[ee]=n*Math.cos(j),k[ee]=Math.sin(j),ne[ee]=n*Math.cos(j-.01),Y[ee]=Math.sin(j-.01),F[ee]=n*Math.cos(j+.01),te[ee]=Math.sin(j+.01)}for(let ee=0;ee<i;++ee){x=3*ee,v=x*s,a&&h&&c&&l&&f&&(V1.set(h[x],h[x+1],h[x+2]),_=c[x],C=c[x+1],w=c[x+2],S=l[x],M=l[x+1],B=l[x+2],L=a[x],U=a[x+1],E=a[x+2],b=f[ee]);for(let j=0;j<s;++j){const Z=v+3*j;if(a){const ce=-b*O[j],de=b*k[j],oe=-b*ne[j],V=b*Y[j],re=-b*F[j],q=b*te[j];p[Z]=L+ce*_+de*S,p[Z+1]=U+ce*C+de*M,p[Z+2]=E+ce*w+de*B,ih.set(re*_+q*S-(oe*_+V*S),re*C+q*M-(oe*C+V*M),re*w+q*B-(oe*w+V*B)).cross(V1),g[Z]=ih.x,g[Z+1]=ih.y,g[Z+2]=ih.z}u&&(y[Z]=u[x],y[Z+1]=u[x+1],y[Z+2]=u[x+2]),d&&(m[ee*s+j]=d[ee])}}x=0,v=3*i*s;for(let ee=0;ee<s;++ee){const j=x+3*ee,Z=v+3*ee;a&&h&&(p[Z]=p[j],p[Z+1]=p[j+1],p[Z+2]=p[j+2],g[Z]=h[x],g[Z+1]=h[x+1],g[Z+2]=h[x+2]),u&&(y[Z]=y[j],y[Z+1]=y[j+1],y[Z+2]=y[j+2]),d&&(m[i*s+ee]=m[0+ee])}x=3*(i-1)*s,v=3*(i+1)*s;for(let ee=0;ee<s;++ee){const j=x+3*ee,Z=v+3*ee;a&&h&&(p[Z]=p[j],p[Z+1]=p[j+1],p[Z+2]=p[j+2],g[Z]=h[3*r],g[Z+1]=h[3*r+1],g[Z+2]=h[3*r+2]),u&&(y[Z]=y[j],y[Z+1]=y[j+1],y[Z+2]=y[j+2]),d&&(m[(i+1)*s+ee]=m[(i-1)*s+ee])}}makeIndex(){const e=this.geometry.getIndex();if(!e)return void fe.error("Index is null");const n=e.array,i=this.size2,r=i-1,s=this.capTriangles,o=this.parameters.radialSegments,a=this.parameters.radialSegments+1;let c,l;for(let u=0;u<r;++u){const f=u*o*3*2,d=u*o,p=(u+1)*o;for(let y=0;y<o;++y)l=f+3*y*2,n[l]=d+y,n[l+1]=d+(y+1)%o,n[l+2]=p+y,n[l+3]=p+y,n[l+4]=d+(y+1)%o,n[l+5]=p+(y+1)%o}const h=[0];for(let u=1;u<a/2;++u)h.push(u),o-u!==u&&h.push(o-u);l=r*o*3*2,c=i*o;for(let u=0;u<h.length-2;++u)u%2==0?(n[l+3*u+0]=c+h[u+0],n[l+3*u+1]=c+h[u+1],n[l+3*u+2]=c+h[u+2]):(n[l+3*u+0]=c+h[u+2],n[l+3*u+1]=c+h[u+1],n[l+3*u+2]=c+h[u+0]);l=r*o*3*2+3*s,c=i*o+o;for(let u=0;u<h.length-2;++u)u%2==0?(n[l+3*u+0]=c+h[u+0],n[l+3*u+1]=c+h[u+1],n[l+3*u+2]=c+h[u+2]):(n[l+3*u+0]=c+h[u+2],n[l+3*u+1]=c+h[u+1],n[l+3*u+2]=c+h[u+0])}}class Im extends Cn{constructor(e,n,i){super(e,n,i),this.type="cartoon",this.parameters=Object.assign({aspectRatio:{type:"number",precision:1,max:10,min:1,rebuild:!0},subdiv:{type:"integer",max:50,min:1,rebuild:!0},radialSegments:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},capped:{type:"boolean",rebuild:!0},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters),this.init(i)}init(e){var n=e||{};n.colorScheme=I(n.colorScheme,"chainname"),n.colorScale=I(n.colorScale,"RdYlBu"),n.radiusType=I(n.radiusType,"sstruc"),n.radiusScale=I(n.radiusScale,.7),n.useInteriorColor=I(n.useInteriorColor,!0),this.aspectRatio=I(n.aspectRatio,5),this.tension=I(n.tension,NaN),this.capped=I(n.capped,!0),this.smoothSheet=I(n.smoothSheet,!1),n.quality==="low"?(this.subdiv=3,this.radialSegments=6):n.quality==="medium"?this.subdiv=6:n.quality==="high"?this.subdiv=12:this.subdiv=I(n.subdiv,6),super.init(n)}getSplineParams(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:this.aspectRatio!==1,smoothSheet:this.smoothSheet},e)}getSpline(e){return new qo(e,this.getSplineParams())}getAspectRatio(e){return e.isCg()?1:this.aspectRatio}getAtomRadius(e){return e.isTrace()?super.getAtomRadius(e):0}createData(e){let n=[],i=[];return this.structure.eachPolymer(r=>{if(r.residueCount<4)return;i.push(r);const s=this.getSpline(r),o=this.getAspectRatio(r),a=s.getSubdividedPosition(),c=s.getSubdividedOrientation(),l=s.getSubdividedColor(this.getColorParams()),h=s.getSubdividedPicking(),u=s.getSubdividedSize(this.getRadiusParams());n.push(new OP(Object.assign({},a,c,l,h,u),this.getBufferParams({radialSegments:this.radialSegments,aspectRatio:o,capped:this.capped})))},e.getSelection()),{bufferList:n,polymerList:i}}updateData(e,n){Ce&&fe.time(this.type+" repr update"),e=e||{};for(var i=0,r=n.polymerList.length;i<r;++i){var s={},o=n.polymerList[i],a=this.getSpline(o),c=this.getAspectRatio(o);if(Object.assign(n.bufferList[i],{aspectRatio:c}),e.position||e.radius){var l=a.getSubdividedPosition(),h=a.getSubdividedOrientation(),u=a.getSubdividedSize(this.getRadiusParams(c));s.position=l.position,s.normal=h.normal,s.binormal=h.binormal,s.tangent=h.tangent,s.size=u.size}if(e.color){var f=a.getSubdividedColor(this.getColorParams());s.color=f.color}if(e.picking){var d=a.getSubdividedPicking();s.picking=d.picking}n.bufferList[i].setAttributes(s)}Ce&&fe.timeEnd(this.type+" repr update")}setParameters(e){var n={};return e&&e.aspectRatio&&(n.radius=!0),e&&e.tension&&(n.position=!0),super.setParameters(e,n,!1),this}}Xt.add("cartoon",Im);class kP extends Cn{constructor(e,n,i){super(e,n,i),this.type="contact",this.parameters=Object.assign({hydrogenBond:{type:"boolean",rebuild:!0},weakHydrogenBond:{type:"boolean",rebuild:!0},waterHydrogenBond:{type:"boolean",rebuild:!0},backboneHydrogenBond:{type:"boolean",rebuild:!0},hydrophobic:{type:"boolean",rebuild:!0},halogenBond:{type:"boolean",rebuild:!0},ionicInteraction:{type:"boolean",rebuild:!0},metalCoordination:{type:"boolean",rebuild:!0},cationPi:{type:"boolean",rebuild:!0},piStacking:{type:"boolean",rebuild:!0},filterSele:{type:"text",rebuild:!0},labelVisible:{type:"boolean",rebuild:!0},labelFixedSize:{type:"boolean",buffer:"fixedSize"},labelSize:{type:"number",precision:3,max:10,min:.001,rebuild:!0},labelUnit:{type:"select",rebuild:!0,options:{"":"",angstrom:"angstrom",nm:"nm"}},maxHydrophobicDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondSulfurDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHbondAccAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondDonAngle:{type:"integer",max:180,min:0,rebuild:!0},maxHbondAccPlaneAngle:{type:"integer",max:90,min:0,rebuild:!0},maxHbondDonPlaneAngle:{type:"integer",max:90,min:0,rebuild:!0},maxPiStackingDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxPiStackingAngle:{type:"integer",max:180,min:0,rebuild:!0},maxCationPiDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxCationPiOffset:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxIonicDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},maxHalogenBondAngle:{type:"integer",max:180,min:0,rebuild:!0},maxMetalDist:{type:"number",precision:1,max:10,min:.1,rebuild:!0},refineSaltBridges:{type:"boolean",rebuild:!0},masterModelIndex:{type:"integer",max:1e3,min:-1,rebuild:!0},lineOfSightDistFactor:{type:"number",precision:1,max:10,min:0,rebuild:!0},radialSegments:!0,disableImpostor:!0},this.parameters),this.init(i)}init(e){var n=e||{};n.radiusSize=I(n.radiusSize,.05),n.useInteriorColor=I(n.useInteriorColor,!0),this.hydrogenBond=I(n.hydrogenBond,!0),this.weakHydrogenBond=I(n.weakHydrogenBond,!1),this.waterHydrogenBond=I(n.waterHydrogenBond,!1),this.backboneHydrogenBond=I(n.backboneHydrogenBond,!1),this.hydrophobic=I(n.hydrophobic,!1),this.halogenBond=I(n.halogenBond,!0),this.ionicInteraction=I(n.ionicInteraction,!0),this.metalCoordination=I(n.metalCoordination,!0),this.cationPi=I(n.cationPi,!0),this.piStacking=I(n.piStacking,!0),this.filterSele=I(n.filterSele,""),this.labelVisible=I(n.labelVisible,!1),this.labelFixedSize=I(n.labelFixedSize,!1),this.labelSize=I(n.labelSize,2),this.labelUnit=I(n.labelUnit,""),this.maxHydrophobicDist=I(n.maxHydrophobicDist,4),this.maxHbondDist=I(n.maxHbondDist,3.5),this.maxHbondSulfurDist=I(n.maxHbondSulfurDist,4.1),this.maxHbondAccAngle=I(n.maxHbondAccAngle,45),this.maxHbondDonAngle=I(n.maxHbondDonAngle,45),this.maxHbondAccPlaneAngle=I(n.maxHbondAccPlaneAngle,90),this.maxHbondDonPlaneAngle=I(n.maxHbondDonPlaneAngle,30),this.maxPiStackingDist=I(n.maxPiStackingDist,5.5),this.maxPiStackingOffset=I(n.maxPiStackingOffset,2),this.maxPiStackingAngle=I(n.maxPiStackingAngle,30),this.maxCationPiDist=I(n.maxCationPiDist,6),this.maxCationPiOffset=I(n.maxCationPiOffset,2),this.maxIonicDist=I(n.maxIonicDist,5),this.maxHalogenBondDist=I(n.maxHalogenBondDist,3.5),this.maxHalogenBondAngle=I(n.maxHalogenBondAngle,30),this.maxMetalDist=I(n.maxMetalDist,3),this.refineSaltBridges=I(n.refineSaltBridges,!0),this.masterModelIndex=I(n.masterModelIndex,-1),this.lineOfSightDistFactor=I(n.lineOfSightDistFactor,1),super.init(n)}getAtomRadius(){return 0}getContactData(e){const n={maxHydrophobicDist:this.maxHydrophobicDist,maxHbondDist:this.maxHbondDist,maxHbondSulfurDist:this.maxHbondSulfurDist,maxHbondAccAngle:this.maxHbondAccAngle,maxHbondDonAngle:this.maxHbondDonAngle,maxHbondAccPlaneAngle:this.maxHbondAccPlaneAngle,maxHbondDonPlaneAngle:this.maxHbondDonPlaneAngle,maxPiStackingDist:this.maxPiStackingDist,maxPiStackingOffset:this.maxPiStackingOffset,maxPiStackingAngle:this.maxPiStackingAngle,maxCationPiDist:this.maxCationPiDist,maxCationPiOffset:this.maxCationPiOffset,maxIonicDist:this.maxIonicDist,maxHalogenBondDist:this.maxHalogenBondDist,maxHalogenBondAngle:this.maxHalogenBondAngle,maxMetalDist:this.maxMetalDist,refineSaltBridges:this.refineSaltBridges,masterModelIndex:this.masterModelIndex,lineOfSightDistFactor:this.lineOfSightDistFactor},i={hydrogenBond:this.hydrogenBond,weakHydrogenBond:this.weakHydrogenBond,waterHydrogenBond:this.waterHydrogenBond,backboneHydrogenBond:this.backboneHydrogenBond,hydrophobic:this.hydrophobic,halogenBond:this.halogenBond,ionicInteraction:this.ionicInteraction,metalCoordination:this.metalCoordination,cationPi:this.cationPi,piStacking:this.piStacking,radius:this.radiusSize*this.radiusScale,filterSele:this.filterSele};return MC(_C(e,n),e,i)}createData(e){const n=this.getContactData(e),i=[new vr(WA(n),this.getBufferParams({sphereDetail:1,dullInterior:!0,disableImpostor:this.disableImpostor}))];if(this.labelVisible){const r={size:this.labelSize,unit:this.labelUnit};i.push(new ra(function(s,o){const a=Fi(s.position1,s.position2),c=[],l=Iu(s.position1,s.position2),h=l.length/3;for(let u=0;u<h;u++){const f=3*u,d=Math.sqrt(Math.pow(l[f],2)+Math.pow(l[f+1],2)+Math.pow(l[f+2],2));switch(o.unit){case"angstrom":c[u]=d.toFixed(2)+" ";break;case"nm":c[u]=(d/10).toFixed(2)+" nm";break;default:c[u]=d.toFixed(2)}}return{position:a,size:Jn(a.length/3,o.size),color:s.color,text:c}}(n,r),this.getBufferParams({fixedSize:this.labelFixedSize})))}return{bufferList:i}}}Xt.add("contact",kP);class FP extends Tm{constructor(e,n,i){super(e,n,i),this.type="dihedral",this.parameters=Object.assign({atomQuad:{type:"hidden",rebuild:!0},extendLine:{type:"boolean",rebuild:!0,default:!0},lineVisible:{type:"boolean",default:!0},planeVisible:{type:"boolean",default:!0},sectorVisible:{type:"boolean",default:!0}},this.parameters),this.init(i)}init(e){const n=e||{};n.side=I(n.side,"double"),n.opacity=I(n.opacity,.5),this.atomQuad=I(n.atomQuad,[]),this.extendLine=I(n.extendLine,!0),this.lineVisible=I(n.lineVisible,!0),this.planeVisible=I(n.planeVisible,!0),this.sectorVisible=I(n.sectorVisible,!0),super.init(n)}createData(e){if(!e.atomCount||!this.atomQuad.length)return;const n=function(a,c={}){const l=I(c.angleStep,Math.PI/90),h=a.length,u=a.length/12,f=new Float32Array(u),d=new Float32Array(3*u),p=new Array(u),y=new Array(u),g=new Array(u),m=new Array(u),x=new Array(u);let v=0,b=0,_=0;const C=st(),w=st(),S=st(),M=st(),B=st(),L=st(),U=st(),E=st(),O=st(),k=st(),ne=st(),Y=st(),F=st(),te=st(),ee=st();let j=0;for(var Z=0;Z<h;Z+=12){if(Ln(C,a,Z),Ln(w,a,Z+3),Ln(S,a,Z+6),Ln(M,a,Z+9),Qt(B,C,w),Qt(L,S,w),zr(L)===0)continue;Qt(U,M,S),kt(E,L,.5),yi(O,w,E),nn(B,B),nn(L,L),nn(U,U),Qt(E,C,O);const H=Fn(E,L)>0;Qt(E,M,O);const se=Fn(E,L)<0;if(kt(E,L,Fn(L,B)),Qt(k,B,E),kt(E,L,Fn(L,U)),Qt(ne,U,E),zr(k)===0||zr(ne)===0)continue;nn(k,k),nn(ne,ne);const $=f[j]=$A(k,ne);p[j]=(kx*$).toFixed(1)+"",Vn(te,k,L),nn(te,te),Fn(te,ne)<0&&Ru(te,te),gi(E,O,k,te,$/2),lt(E,d,3*j);const he=Math.ceil($/l),me=he+(c.extendLine?4:2),le=c.extendLine?36:0,D=new Float32Array(3*me),N=new Float32Array(3*me),pe=new Float32Array(9*he),ue=new Float32Array(le);y[j]=D,g[j]=N,m[j]=pe,x[j]=ue,c.extendLine&&(H?(Qt(E,C,S),nn(E,E),kt(Y,E,1/Fn(k,E)),yi(Y,Y,S)):(kt(Y,B,1/Fn(k,B)),yi(Y,Y,w)),se?(Qt(E,M,w),nn(E,E),kt(F,E,1/Fn(ne,E)),yi(F,F,w)):(kt(F,U,1/Fn(ne,U)),yi(F,F,S))),yi(ee,O,k);let X=0;c.extendLine?(lt(C,D,X),lt(Y,N,X),X+=3,lt(Y,D,X),lt(ee,N,X),X+=3,lt(Y,ue,0),lt(ee,ue,3),lt(H?S:w,ue,6),lt(H?S:w,ue,9),lt(ee,ue,12),lt(O,ue,15)):(lt(O,D,X),lt(ee,N,X),X+=3);const ye=function(xe,Se){const Me=9*Se;lt(O,pe,Me),lt(ee,pe,Me+3),lt(ee,D,X),gi(ee,O,k,te,xe),lt(ee,pe,Me+6),lt(ee,N,X),X+=3};let _e=0;for(let xe=l;xe<$;xe+=l)ye(xe,_e++);ye($,_e++),c.extendLine?(lt(ee,D,3*(me-2)),lt(F,N,3*(me-2)),lt(F,D,3*(me-1)),lt(M,N,3*(me-1)),lt(F,ue,18),lt(ee,ue,21),lt(se?w:S,ue,24),lt(se?w:S,ue,27),lt(ee,ue,30),lt(O,ue,33)):(lt(ee,D,X),lt(O,N,X),X+=3),v+=3*me,b+=9*he,_+=le,j+=1}const ce=j,de=new Float32Array(v),oe=new Float32Array(v),V=new Float32Array(b),re=new Float32Array(_);let q=0,J=0,W=0;for(let H=0;H<ce;H++){const se=y[H],$=g[H],he=m[H],me=x[H];mn(se,de,0,q,se.length),mn($,oe,0,q,$.length),mn(he,V,0,J,he.length),mn(me,re,0,W,me.length),q+=se.length,J+=he.length,W+=me.length}return{labelPosition:d.subarray(0,3*ce),labelText:p.slice(0,ce),linePosition1:de,linePosition2:oe,planePosition:re,sectorPosition:V}}(Pm(e,this.atomQuad),{extendLine:this.extendLine}),i=this.n=n.labelText.length,r=new ke(this.labelColor);this.textBuffer=new ra({position:n.labelPosition,size:Jn(i,this.labelSize),color:Bt(i,r.r,r.g,r.b),text:n.labelText},this.getLabelBufferParams());const s=new ke(this.colorValue);this.lineLength=n.linePosition1.length/3;const o=Bt(this.lineLength,s.r,s.g,s.b);return this.lineBuffer=new yr(Ep({position1:n.linePosition1,position2:n.linePosition2,color:o,color2:o}),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),this.planeLength=n.planePosition.length/3,this.planeBuffer=new mr({position:n.planePosition,color:Bt(this.planeLength,s.r,s.g,s.b)},this.getBufferParams({visible:this.planeVisible})),this.sectorLength=n.sectorPosition.length/3,this.sectorBuffer=new mr({position:n.sectorPosition,color:Bt(this.sectorLength,s.r,s.g,s.b)},this.getBufferParams({visible:this.sectorVisible})),{bufferList:[this.textBuffer,this.lineBuffer,this.planeBuffer,this.sectorBuffer]}}updateData(e,n){super.updateData(e,n);const i={},r={},s={};if(e.color){const o=new ke(this.colorValue);Object.assign(i,{color:Bt(this.lineLength,o.r,o.g,o.b),color2:Bt(this.lineLength,o.r,o.g,o.b)}),Object.assign(r,{color:Bt(this.planeLength,o.r,o.g,o.b)}),Object.assign(s,{color:Bt(this.sectorLength,o.r,o.g,o.b)})}this.lineBuffer.setAttributes(i),this.planeBuffer.setAttributes(r),this.sectorBuffer.setAttributes(s)}setParameters(e){return super.setParameters(e,{},!1),!e||e.lineVisible===void 0&&e.sectorVisible===void 0&&e.planeVisible===void 0||this.setVisibility(this.visible),e&&e.lineOpacity&&this.lineBuffer.setParameters({opacity:e.lineOpacity}),e&&e.opacity!==void 0&&this.lineBuffer.setParameters({opacity:this.lineOpacity}),e&&e.linewidth&&this.lineBuffer.setParameters({linewidth:e.linewidth}),this}setVisibility(e,n){return super.setVisibility(e,!0),this.lineBuffer&&this.lineBuffer.setVisibility(this.lineVisible&&this.visible),this.planeBuffer&&this.planeBuffer.setVisibility(this.planeVisible&&this.visible),this.sectorBuffer&&this.sectorBuffer.setVisibility(this.sectorVisible&&this.visible),n||this.viewer.requestRender(),this}}Xt.add("dihedral",FP);function tf(t,e){function n(r,s){return s in r}const i=Object.assign({},t);for(const r in i)n(i,r)&&n(e,r)&&(i[r]=I(e[r],i[r]));return i}function fi(t,e){const n=new ke(t),i=new Float32Array(3*e);return Bt(e,n.r,n.g,n.b,i),i}class NP extends Cn{constructor(e,n,i){super(e,n,i),this.type="dihedral-histogram",this.parameters=Object.assign({histogramsData:{type:"hidden",rebuild:!0},histogramBinBorderVisible:{type:"boolean",default:!0},scaleBinToSectorArea:{type:"boolean",rebuild:!0,default:!1}},this.parameters),this.init(i)}init(e){const n=e||{},i=tf({histogramBinBorderColor:"grey",adjacentBondArrowColor:"black",distantBondArrowColor:"magenta",frontHistogramColor:"green",backHistogramColor:"blue",opaqueMiddleDiscColor:"white"},n);Object.assign(this,i);const r=tf({histogramsData:[],histogramOpacity:1,opaqueMiddleDiscVisible:!0,opaqueMiddleDiscOpacity:1,histogramBinBorderVisible:!0,histogramBinBorderWidth:1,histogramBinBorderOpacity:.5,bondArrowVisible:!0,bondArrowWidth:2,bondArrowOpacity:1,scaleBinToSectorArea:!1},n);Object.assign(this,r),this.histogramsData.forEach(s=>{const o=tf(i,s);Object.assign(s,o)}),n.side=I(n.side,"double"),n.opacity=I(n.opacity,.5),n.radiusType=I(n.radiusType,"size"),n.radiusSize=I(n.radiusSize,.15),super.init(n)}getHistogramBinBorderBufferParameters(){return this.getBufferParams({linewidth:this.histogramBinBorderWidth,visible:this.histogramBinBorderVisible,opacity:this.histogramBinBorderOpacity})}getBondArrowsBufferParameters(){return this.getBufferParams({linewidth:this.bondArrowWidth,visible:this.bondArrowVisible,opacity:this.bondArrowOpacity})}getOpaqueMiddleDiscBufferParameters(){return this.getBufferParams({visible:this.opaqueMiddleDiscVisible,opacity:this.opaqueMiddleDiscOpacity})}getHistogramBufferParameters(){return this.getBufferParams({visible:!0,opacity:this.histogramOpacity,side:"double"})}createData(e){if(!e.atomCount||!this.histogramsData.length)return;this.histogramsData.forEach(a=>a.atomPositions=Pm(e,[a.atomQuad]));const n=this.scaleBinToSectorArea?function(a){return Math.sqrt(a)}:function(a){return a};function i(a){const c=a.map(u=>u.length),l=new Float32Array(fm(c));let h=0;for(let u=0;u<a.length;u++)l.set(a[u],h),h+=a[u].length;return l}function r(a,c){return new yr({position1:i(a.map(l=>l.startPoints)),position2:i(a.map(l=>l.endPoints)),color:i(a.map(l=>l.startColors)),color2:i(a.map(l=>l.endColors))},c)}function s(a,c){return new mr({position:i(a.map(l=>l.triangles)),color:i(a.map(l=>l.triangleColors))},c)}this.histogramsData.forEach(a=>a.histogram360Scaled=a.histogram360.map(n));const o=[];for(let a=0;a<this.histogramsData.length;a++){let c,l=this.histogramsData[a];l.histogram360.length>=3&&(c=zP(l)),c!==void 0&&o.push(c)}return this.frontHistogramBinBordersBuffer=r(o.map(a=>a.frontHistogramBinBorders),this.getHistogramBinBorderBufferParameters()),this.backHistogramBinBordersBuffer=r(o.map(a=>a.backHistogramBinBorders),this.getHistogramBinBorderBufferParameters()),this.adjacentBondArrowsBuffer=r(o.map(a=>a.adjacentBondArrows),this.getBondArrowsBufferParameters()),this.distantBondArrowsBuffer=r(o.map(a=>a.distantBondArrows),this.getBondArrowsBufferParameters()),this.opaqueMiddleDiscBuffer=s(o.map(a=>a.opaqueMiddleDisc),this.getOpaqueMiddleDiscBufferParameters()),this.frontHistogramBuffer=s(o.map(a=>a.frontHistogram),this.getHistogramBufferParameters()),this.backHistogramBuffer=s(o.map(a=>a.backHistogram),this.getHistogramBufferParameters()),{bufferList:[].concat(this.frontHistogramBinBordersBuffer,this.backHistogramBinBordersBuffer,this.adjacentBondArrowsBuffer,this.distantBondArrowsBuffer,this.opaqueMiddleDiscBuffer,this.frontHistogramBuffer,this.backHistogramBuffer)}}setParameters(e){return super.setParameters(e,{},!1),e&&e.histogramBinBorderVisible!==void 0&&this.setVisibility(this.visible),this}setVisibility(e,n){return super.setVisibility(e,!0),this.frontHistogramBinBordersBuffer&&this.frontHistogramBinBordersBuffer.setVisibility(this.histogramBinBorderVisible),this.backHistogramBinBordersBuffer&&this.backHistogramBinBordersBuffer.setVisibility(this.histogramBinBorderVisible),n||this.viewer.requestRender(),this}}function zP(t){const e=t.atomPositions,n=t.histogram360Scaled,i=n.length<=180?360:2*n.length,r={triangles:new Float32Array(3*i*3),triangleColors:fi(t.opaqueMiddleDiscColor,3*i)},s={triangles:new Float32Array(3*n.length*3),triangleColors:fi(t.frontHistogramColor,3*n.length)},o={triangles:new Float32Array(3*n.length*3),triangleColors:fi(t.backHistogramColor,3*n.length)},a={startPoints:new Float32Array(3*n.length),endPoints:new Float32Array(3*n.length),startColors:fi(t.histogramBinBorderColor,n.length),endColors:fi(t.histogramBinBorderColor,n.length)},c={startPoints:new Float32Array(3*n.length),endPoints:new Float32Array(3*n.length),startColors:fi(t.histogramBinBorderColor,n.length),endColors:fi(t.histogramBinBorderColor,n.length)},l={startPoints:new Float32Array(6),endPoints:new Float32Array(6),startColors:fi(t.adjacentBondArrowColor,n.length),endColors:fi(t.adjacentBondArrowColor,n.length)},h={startPoints:new Float32Array(6),endPoints:new Float32Array(6),startColors:fi(t.distantBondArrowColor,n.length),endColors:fi(t.distantBondArrowColor,n.length)},u=st(),f=st(),d=st(),p=st(),y=st(),g=st(),m=st(),x=st(),v=st(),b=st(),_=st(),C=st(),w=st(),S=st(),M=st(),B=st(),L=[u,f,d,p];for(let te=0;te<L.length;te++)Ln(L[te],e,3*te);if(Qt(y,u,f),Qt(g,d,f),Qt(x,p,d),zr(g)===0||(kt(M,g,.5),yi(v,f,M),nn(y,y),nn(g,g),nn(x,x),Ru(m,g),kt(M,m,Fn(m,y)),Qt(b,y,M),kt(M,g,Fn(g,x)),Qt(_,x,M),zr(b)===0||zr(_)===0))return;nn(b,b),nn(_,_);const U=Math.acos(Fn(b,_));Vn(C,m,b),Vn(w,g,_),nn(C,C),nn(w,w);let E=U;Fn(C,_)<0&&(E=-U),yi(S,v,b);const O=Math.max.apply(null,n),k=2*Math.PI/n.length;function ne(te,ee,j,Z,ce){const de=3*ee*3;lt(v,te,de);const oe=Number(n[ee])/O;kt(M,j,oe),kt(B,Z,oe),gi(S,v,M,B,ee*ce),lt(S,te,de+3),gi(S,v,M,B,(ee+1)*ce),lt(S,te,de+6)}function Y(te,ee,j,Z,ce){mn(v,l.startPoints,0,3*j,v.length),gi(M,v,Z,ce,0+0*k),mn(M,l.endPoints,0,3*j,v.length),mn(v,h.startPoints,0,3*j,v.length),gi(M,v,Z,ce,E),mn(M,h.endPoints,0,3*j,v.length);for(let de=0;de<n.length;de++)mn(v,ee.startPoints,0,3*de,v.length),gi(M,v,Z,ce,0+k*de),mn(M,ee.endPoints,0,3*de,M.length);for(let de=0;de<n.length;de++)ne(te.triangles,de,Z,ce,k)}const F=2*Math.PI/i;for(let te=0;te<i;te++){const ee=3*te*3;lt(v,r.triangles,ee),gi(S,v,b,C,te*F),lt(S,r.triangles,ee+3),gi(S,v,b,C,(te+1)*F),lt(S,r.triangles,ee+6)}return kt(M,g,-.01),yi(v,v,M),Y(s,a,0,b,C),kt(M,g,.02),yi(v,v,M),Y(o,c,1,_,w),{opaqueMiddleDisc:r,frontHistogram:s,backHistogram:o,frontHistogramBinBorders:a,backHistogramBinBorders:c,adjacentBondArrows:l,distantBondArrows:h}}Xt.add("dihedral-histogram",NP);class GP extends Tm{constructor(e,n,i){super(e,n,i),this.type="distance",this.parameters=Object.assign({radialSegments:!0,openEnded:!0,disableImpostor:!0,labelUnit:{type:"select",rebuild:!0,options:{"":"",angstrom:"angstrom",nm:"nm"}},useCylinder:{type:"boolean",rebuild:!0},atomPair:{type:"hidden",rebuild:!0}},this.parameters),this.init(i)}init(e){const n=e||{};n.linewidth=I(n.linewidth,5),n.radiusType=I(n.radiusType,"size"),n.radiusSize=I(n.radiusSize,.2),this.labelUnit=I(n.labelUnit,""),this.useCylinder=I(n.useCylinder,!1),this.atomPair=I(n.atomPair,[]),super.init(n)}getDistanceData(e,n){let i=n.length;const r=new Array(i);let s=new Float32Array(3*i);const o=new qt,a=new qt,c=new Mh,l=e.getAtomProxy(),h=e.getAtomProxy();let u=0;const f=e.getAtomSet();n.forEach((p,y)=>{let g=p[0],m=p[1];if(typeof g=="number"&&Number.isInteger(g)&&typeof m=="number"&&Number.isInteger(m)){if(!f.get(g)||!f.get(m))return void(u+=1);l.index=g,h.index=m}else{o.setString(g),a.setString(m);var x=e.getAtomIndices(o),v=e.getAtomIndices(a);if(!x.length||!v.length)return void(u+=1);l.index=x[0],h.index=v[0]}c.addBond(l,h,1),y-=u;var b=l.distanceTo(h);switch(this.labelUnit){case"angstrom":r[y]=b.toFixed(2)+" ";break;case"nm":r[y]=(b/10).toFixed(2)+" nm";break;default:r[y]=b.toFixed(2)}var _=3*y;s[_+0]=(l.x+h.x)/2,s[_+1]=(l.y+h.y)/2,s[_+2]=(l.z+h.z)/2}),u>0&&(i-=u,s=s.subarray(0,3*i));var d=new xn(c.count,!0);return{text:r,position:s,bondSet:d,bondStore:c}}getBondData(e,n,i){const r=e.getBondData(this.getBondParams(n,i));return r.picking&&(r.picking=new PC(r.picking.array,r.picking.structure,i.bondStore)),r}createData(e){if(!e.atomCount||!this.atomPair.length)return;const n=this.atomPair.length,i=new ke(this.labelColor),r=this.getDistanceData(e,this.atomPair);this.textBuffer=new ra({position:r.position,size:Jn(n,this.labelSize),color:Bt(n,i.r,i.g,i.b),text:r.text},this.getLabelBufferParams());const s={bondSet:r.bondSet,bondStore:r.bondStore},o=this.getBondData(e,{position:!0,color:!0,picking:!0,radius:this.useCylinder},s);return this.useCylinder?this.distanceBuffer=new vr(o,this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})):this.distanceBuffer=new yr(Ux(o),this.getBufferParams({linewidth:this.linewidth,visible:this.lineVisible,opacity:this.lineOpacity})),{bondSet:r.bondSet,bondStore:r.bondStore,position:r.position,bufferList:[this.textBuffer,this.distanceBuffer]}}updateData(e,n){super.updateData(e,n);const i={bondSet:n.bondSet,bondStore:n.bondStore},r=this.getBondData(n.sview,e,i),s={};e&&!e.color||Object.assign(s,{color:r.color,color2:r.color2}),e&&!e.radius||Object.assign(s,{radius:r.radius}),this.distanceBuffer.setAttributes(s)}setParameters(e){return super.setParameters(e,{},!1),this.useCylinder||(e&&e.lineOpacity&&this.distanceBuffer.setParameters({opacity:e.lineOpacity}),e&&e.opacity!==void 0&&this.distanceBuffer.setParameters({opacity:this.lineOpacity}),e&&e.linewidth&&this.distanceBuffer.setParameters({linewidth:e.linewidth})),this}}function nf(t){return 2*(t.position.length/3)*3}Xt.add("distance",GP);const UP=Object.assign({scale:1,color:"grey"},Bn);class H1 extends Wi{constructor(e,n={}){super({position:new Float32Array(nf(e)),color:new Float32Array(nf(e))},n),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag";const i=new ke(this.parameters.color),r=this.geometry.attributes;Bt(nf(e)/3,i.r,i.g,i.b,r.color.array),this.setAttributes(e)}get defaultParameters(){return UP}setAttributes(e={}){const n=this.geometry.attributes;let i,r,s;e.position&&e.vector&&(i=e.position,r=e.vector,s=n.position.array,n.position.needsUpdate=!0);const o=this.size/2,a=this.parameters.scale;if(i&&r)for(let c=0;c<o;c++){const l=2*c*3,h=3*c;s[l+0]=i[h+0],s[l+1]=i[h+1],s[l+2]=i[h+2],s[l+3]=i[h+0]+r[h+0]*a,s[l+4]=i[h+1]+r[h+1]*a,s[l+5]=i[h+2]+r[h+2]*a}}}class VP extends Cn{constructor(e,n,i){super(e,n,i),this.type="helixorient",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(i)}init(e){const n=e||{};n.colorScheme=I(n.colorScheme,"sstruc"),n.radiusType=I(n.radiusType,"size"),n.radiusSize=I(n.radiusSize,.15),n.radiusScale=I(n.radiusScale,1),n.useInteriorColor=I(n.useInteriorColor,!0),super.init(n)}createData(e){const n=[],i=[];return this.structure.eachPolymer(r=>{if(r.residueCount<4)return;i.push(r);const s=new gu(r),o=s.getPosition(),a=s.getColor(this.getColorParams()),c=s.getSize(this.getRadiusParams()),l=s.getPicking();n.push(new Jr({position:o.center,color:a.color,radius:c.size,picking:l.picking},this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),new H1({position:o.center,vector:o.axis},this.getBufferParams({color:"skyblue",scale:1})),new H1({position:o.center,vector:o.resdir},this.getBufferParams({color:"lightgreen",scale:1})))},e.getSelection()),{bufferList:n,polymerList:i}}updateData(e,n){Ce&&fe.time(this.type+" repr update"),e=e||{};for(let i=0,r=n.polymerList.length;i<r;++i){const s=3*i,o={},a=n.polymerList[i],c=new gu(a);if(e.position){const l=c.getPosition();Object.assign(o,{position:l.center}),n.bufferList[s+1].setAttributes({position:l.center,vector:l.axis}),n.bufferList[s+2].setAttributes({position:l.center,vector:l.resdir})}n.bufferList[s].setAttributes(o)}Ce&&fe.timeEnd(this.type+" repr update")}}Xt.add("helixorient",VP);class Tb extends $u{constructor(e,n,i){super(e,n,i),this.type="licorice",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}init(e){var n=e||{};n.aspectRatio=1,super.init(n)}}Xt.add("licorice",Tb),At.add("shader/HyperballStickImpostor.vert",`
attribute vec3 mapping;
attribute float radius;
attribute float radius2;
attribute vec3 position1;
attribute vec3 position2;
varying mat4 matrix_near;
varying vec4 prime1;
varying vec4 prime2;
varying float vRadius;
varying float vRadius2;
#ifdef PICKING
#include unpack_color
attribute float primitiveId;
varying vec3 vPickingColor;
#else
attribute vec3 color2;
varying vec3 vColor1;
varying vec3 vColor2;
#endif
uniform float shrink;
uniform mat4 modelViewProjectionMatrix;
uniform mat4 modelViewProjectionMatrixInverse;
void main(){
vRadius = radius;
vRadius2 = radius2;
vec4 spaceposition;
vec3 position_atom1;
vec3 position_atom2;
vec4 vertex_position;
#ifdef PICKING
vPickingColor = unpackColor( primitiveId );
#else
vColor1 = color;
vColor2 = color2;
#endif
float radius1 = radius;
position_atom1 = position1;
position_atom2 = position2;
float distance = distance( position_atom1, position_atom2 );
spaceposition.z = mapping.z * distance;
if (radius1 > radius2) {
spaceposition.y = mapping.y * 1.5 * radius1;
spaceposition.x = mapping.x * 1.5 * radius1;
} else {
spaceposition.y = mapping.y * 1.5 * radius2;
spaceposition.x = mapping.x * 1.5 * radius2;
}
spaceposition.w = 1.0;
vec4 e3 = vec4( 1.0 );
vec3 e1, e1_temp, e2, e2_temp;
e3.xyz = normalize(position_atom1-position_atom2);
if (e3.z == 0.0) { e3.z = 0.0000000000001;}
if ( (position_atom1.x - position_atom2.x) == 0.0) { position_atom1.x += 0.001;}
if ( (position_atom1.y - position_atom2.y) == 0.0) { position_atom1.y += 0.001;}
if ( (position_atom1.z - position_atom2.z) == 0.0) { position_atom1.z += 0.001;}
vec4 focus = vec4( 1.0 );
focus.x = ( position_atom1.x*position_atom1.x - position_atom2.x*position_atom2.x +
( radius2*radius2 - radius1*radius1 )*e3.x*e3.x/shrink )/(2.0*(position_atom1.x - position_atom2.x));
focus.y = ( position_atom1.y*position_atom1.y - position_atom2.y*position_atom2.y +
( radius2*radius2 - radius1*radius1 )*e3.y*e3.y/shrink )/(2.0*(position_atom1.y - position_atom2.y));
focus.z = ( position_atom1.z*position_atom1.z - position_atom2.z*position_atom2.z +
( radius2*radius2 - radius1*radius1 )*e3.z*e3.z/shrink )/(2.0*(position_atom1.z - position_atom2.z));
e1.x = 1.0;
e1.y = 1.0;
e1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;
e1_temp = e1 - focus.xyz;
e1 = normalize(e1_temp);
e2_temp = e1.yzx * e3.zxy - e1.zxy * e3.yzx;
e2 = normalize(e2_temp);
mat3 R= mat3( e1.xyz, e2.xyz, e3.xyz );
vertex_position.xyz = R * spaceposition.xyz;
vertex_position.w = 1.0;
vertex_position.x += (position_atom1.x+position_atom2.x) / 2.0;
vertex_position.y += (position_atom1.y+position_atom2.y) / 2.0;
vertex_position.z += (position_atom1.z+position_atom2.z) / 2.0;
gl_Position = modelViewProjectionMatrix * vertex_position;
vec4 i_near, i_far;
vec4 near = gl_Position;
near.z = 0.0 ;
near = modelViewProjectionMatrixInverse * near;
i_near = near;
vec4 far = gl_Position;
far.z = far.w ;
i_far = modelViewProjectionMatrixInverse * far;
prime1 = vec4( position_atom1 - (position_atom1 - focus.xyz)*shrink, 1.0 );
prime2 = vec4( position_atom2 - (position_atom2 - focus.xyz)*shrink, 1.0 );
float Rsquare = (radius1*radius1/shrink) - (
(position_atom1.x - focus.x)*(position_atom1.x - focus.x) +
(position_atom1.y - focus.y)*(position_atom1.y - focus.y) +
(position_atom1.z - focus.z)*(position_atom1.z - focus.z)
);
focus.w = Rsquare;
matrix_near = mat4( i_near, i_far, focus, e3 );
gl_Position.z = 1.0;
}`),At.add("shader/HyperballStickImpostor.frag",`#define STANDARD
#define IMPOSTOR
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 interiorColor;
uniform float interiorDarkening;
uniform float roughness;
uniform float metalness;
uniform float opacity;
uniform float clipNear;
uniform float shrink;
uniform mat4 modelViewMatrix;
uniform mat4 modelViewProjectionMatrix;
uniform mat4 modelViewMatrixInverseTranspose;
uniform mat4 projectionMatrix;
varying mat4 matrix_near;
varying vec4 prime1;
varying vec4 prime2;
varying float vRadius;
varying float vRadius2;
#ifdef PICKING
uniform float objectId;
varying vec3 vPickingColor;
#else
varying vec3 vColor1;
varying vec3 vColor2;
#include common
#include fog_pars_fragment
#include bsdfs
#include lights_pars_begin
#include lights_physical_pars_fragment
#endif
bool interior = false;
float calcClip( vec4 cameraPos ){
return dot( cameraPos, vec4( 0.0, 0.0, 1.0, clipNear - 0.5 ) );
}
float calcClip( vec3 cameraPos ){
return calcClip( vec4( cameraPos, 1.0 ) );
}
float calcDepth( in vec3 cameraPos ){
vec2 clipZW = cameraPos.z * projectionMatrix[2].zw + projectionMatrix[3].zw;
return 0.5 + 0.5 * clipZW.x / clipZW.y;
}
struct Ray {
vec3 origin ;
vec3 direction ;
};
bool cutoff_plane (vec3 M, vec3 cutoff, vec3 x3){
float a = x3.x;
float b = x3.y;
float c = x3.z;
float d = -x3.x*cutoff.x-x3.y*cutoff.y-x3.z*cutoff.z;
float l = a*M.x+b*M.y+c*M.z+d;
if (l<0.0) {return true;}
else{return false;}
}
vec3 isect_surf(Ray r, mat4 matrix_coef){
vec4 direction = vec4(r.direction, 0.0);
vec4 origin = vec4(r.origin, 1.0);
float a = dot(direction,(matrix_coef*direction));
float b = dot(origin,(matrix_coef*direction));
float c = dot(origin,(matrix_coef*origin));
float delta =b*b-a*c;
gl_FragColor.a = 1.0;
if (delta<0.0){
discard;
}
float t1 =(-b-sqrt(delta))/a;
return r.origin+t1*r.direction;
}
vec3 isect_surf2(Ray r, mat4 matrix_coef){
vec4 direction = vec4(r.direction, 0.0);
vec4 origin = vec4(r.origin, 1.0);
float a = dot(direction,(matrix_coef*direction));
float b = dot(origin,(matrix_coef*direction));
float c = dot(origin,(matrix_coef*origin));
float delta =b*b-a*c;
gl_FragColor.a = 1.0;
if (delta<0.0){
discard;
}
float t2 =(-b+sqrt(delta))/a;
return r.origin+t2*r.direction;
}
Ray primary_ray(vec4 near1, vec4 far1){
vec3 near=near1.xyz/near1.w;
vec3 far=far1.xyz/far1.w;
return Ray(near,far-near);
}
float update_z_buffer(vec3 M, mat4 ModelViewP){
float depth1;
vec4 Ms=(ModelViewP*vec4(M,1.0));
return depth1=(1.0+Ms.z/Ms.w)/2.0;
}
void main(){
float radius = max( vRadius, vRadius2 );
vec4 i_near, i_far, focus;
vec3 e3, e1, e1_temp, e2;
i_near = vec4(matrix_near[0][0],matrix_near[0][1],matrix_near[0][2],matrix_near[0][3]);
i_far = vec4(matrix_near[1][0],matrix_near[1][1],matrix_near[1][2],matrix_near[1][3]);
focus = vec4(matrix_near[2][0],matrix_near[2][1],matrix_near[2][2],matrix_near[2][3]);
e3 = vec3(matrix_near[3][0],matrix_near[3][1],matrix_near[3][2]);
e1.x = 1.0;
e1.y = 1.0;
e1.z = ( (e3.x*focus.x + e3.y*focus.y + e3.z*focus.z) - e1.x*e3.x - e1.y*e3.y)/e3.z;
e1_temp = e1 - focus.xyz;
e1 = normalize(e1_temp);
e2 = normalize(cross(e1,e3));
vec4 equation = focus;
float shrinkfactor = shrink;
float t1 = -1.0/(1.0-shrinkfactor);
float t2 = 1.0/(shrinkfactor);
vec4 colonne1, colonne2, colonne3, colonne4;
mat4 mat;
vec3 equation1 = vec3(t2,t2,t1);
float A1 = - e1.x*equation.x - e1.y*equation.y - e1.z*equation.z;
float A2 = - e2.x*equation.x - e2.y*equation.y - e2.z*equation.z;
float A3 = - e3.x*equation.x - e3.y*equation.y - e3.z*equation.z;
float A11 = equation1.x*e1.x*e1.x + equation1.y*e2.x*e2.x + equation1.z*e3.x*e3.x;
float A21 = equation1.x*e1.x*e1.y + equation1.y*e2.x*e2.y + equation1.z*e3.x*e3.y;
float A31 = equation1.x*e1.x*e1.z + equation1.y*e2.x*e2.z + equation1.z*e3.x*e3.z;
float A41 = equation1.x*e1.x*A1 + equation1.y*e2.x*A2 + equation1.z*e3.x*A3;
float A22 = equation1.x*e1.y*e1.y + equation1.y*e2.y*e2.y + equation1.z*e3.y*e3.y;
float A32 = equation1.x*e1.y*e1.z + equation1.y*e2.y*e2.z + equation1.z*e3.y*e3.z;
float A42 = equation1.x*e1.y*A1 + equation1.y*e2.y*A2 + equation1.z*e3.y*A3;
float A33 = equation1.x*e1.z*e1.z + equation1.y*e2.z*e2.z + equation1.z*e3.z*e3.z;
float A43 = equation1.x*e1.z*A1 + equation1.y*e2.z*A2 + equation1.z*e3.z*A3;
float A44 = equation1.x*A1*A1 + equation1.y*A2*A2 + equation1.z*A3*A3 - equation.w;
colonne1 = vec4(A11,A21,A31,A41);
colonne2 = vec4(A21,A22,A32,A42);
colonne3 = vec4(A31,A32,A33,A43);
colonne4 = vec4(A41,A42,A43,A44);
mat = mat4(colonne1,colonne2,colonne3,colonne4);
Ray ray = primary_ray(i_near,i_far) ;
vec3 M;
M = isect_surf(ray, mat);
if (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }
vec4 M1 = vec4(M,1.0);
vec4 M2 = mat*M1;
vec3 _normal = ( modelViewMatrixInverseTranspose * M2 ).xyz;
gl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;
#ifdef NEAR_CLIP
if( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 ){
M = isect_surf2(ray, mat);
if( calcClip( modelViewMatrix * vec4( M, 1.0 ) ) > 0.0 )
discard;
interior = true;
gl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;
if( gl_FragDepthEXT >= 0.0 ){
gl_FragDepthEXT = max( 0.0, calcDepth( vec3( - ( clipNear - 0.5 ) ) ) + ( 0.0000001 / radius ) );
}
}else if( gl_FragDepthEXT <= 0.0 ){
M = isect_surf2(ray, mat);
interior = true;
gl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix);
if( gl_FragDepthEXT >= 0.0 ){
gl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );
}
}
#else
if( gl_FragDepthEXT <= 0.0 ){
M = isect_surf2(ray, mat);
interior = true;
gl_FragDepthEXT = update_z_buffer(M, modelViewProjectionMatrix) ;
if( gl_FragDepthEXT >= 0.0 ){
gl_FragDepthEXT = 0.0 + ( 0.0000001 / radius );
}
}
#endif
if (cutoff_plane(M, prime1.xyz, -e3) || cutoff_plane(M, prime2.xyz, e3)){ discard; }
if (gl_FragDepthEXT < 0.0)
discard;
if (gl_FragDepthEXT > 1.0)
discard;
float distance_ratio = ((M.x-prime2.x)*e3.x + (M.y-prime2.y)*e3.y +(M.z-prime2.z)*e3.z) /
distance(prime2.xyz,prime1.xyz);
#ifdef PICKING
if( opacity < 0.3 )
discard;
gl_FragColor = vec4( vPickingColor, objectId );
#else
vec3 vViewPosition = -( modelViewMatrix * vec4( M, 1.0 ) ).xyz;
vec3 vNormal = _normal;
vec3 vColor;
if( distance_ratio>0.5 ){
vColor = vColor1;
}else{
vColor = vColor2;
}
vec4 diffuseColor = vec4( diffuse, opacity );
ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
vec3 totalEmissiveLight = emissive;
#include color_fragment
#include roughnessmap_fragment
#include metalnessmap_fragment
vec3 normal = normalize( vNormal );
vec3 geometryNormal = normal;
#include lights_physical_fragment
#include lights_fragment_begin
#include lights_fragment_end
vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveLight;
if( interior ){
#ifdef USE_INTERIOR_COLOR
outgoingLight.xyz = interiorColor;
#else
#ifdef DIFFUSE_INTERIOR
outgoingLight.xyz = vColor;
#endif
#endif
outgoingLight.xyz *= 1.0 - interiorDarkening;
}
gl_FragColor = vec4( outgoingLight, diffuseColor.a );
#include premultiplied_alpha_fragment
#include tonemapping_fragment
#include encodings_fragment
#include fog_fragment
#endif
}`);const HP=new Float32Array([-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,-1,1,1]),$P=new Uint16Array([0,1,2,0,2,3,1,5,6,1,6,2,4,6,5,4,7,6,0,7,4,0,3,7,0,5,1,0,4,5,3,2,6,3,6,7]);class WP extends Sm{constructor(e,n={}){super("v3",e,n)}get mapping(){return HP}get mappingIndices(){return $P}get mappingIndicesSize(){return 36}get mappingSize(){return 8}get mappingItemSize(){return 3}}const Pb=Object.assign({shrink:.14},Bn),jP=Object.assign({shrink:{uniform:!0}},Ds);class qP extends WP{constructor(e,n={}){super(e,n),this.parameterTypes=jP,this.isImpostor=!0,this.vertexShader="HyperballStickImpostor.vert",this.fragmentShader="HyperballStickImpostor.frag",this.addUniforms({modelViewProjectionMatrix:{value:new Ie},modelViewProjectionMatrixInverse:{value:new Ie},modelViewMatrixInverseTranspose:{value:new Ie},shrink:{value:this.parameters.shrink}}),this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null},radius2:{type:"f",value:null}}),this.setAttributes(e),this.makeMapping()}get defaultParameters(){return Pb}}Object.assign({disableImpostor:!1},Em,Pb);const XP=class{constructor(t,e={}){return!ki||e&&e.disableImpostor?(t.radius=function(n,i){const r=n.length,s=new Float32Array(r);for(let o=0;o<r;o++)s[o]=Math.min(n[o],i[o]);return s}(t.radius,t.radius2),new Ab(t,e)):new qP(t,e)}};class YP extends Tb{constructor(e,n,i){super(e,n,i),this.type="hyperball",this.parameters=Object.assign({shrink:{type:"number",precision:3,max:1,min:.001,buffer:!0}},this.parameters,{multipleBond:null,bondSpacing:null})}init(e){var n=e||{};n.radiusScale=I(n.radiusScale,.2),n.radiusType=I(n.radiusType,"vdw"),n.useInteriorColor=I(n.useInteriorColor,!0),this.shrink=I(n.shrink,.12),super.init(n)}getBondParams(e,n){return e&&!e.radius||(n=Object.assign({radius2:!0},n)),super.getBondParams(e,n)}createData(e){var n=new Jr(e.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0}));return this.__center=new Float32Array(3*e.bondCount),{bufferList:[n,new XP(e.getBondData(this.getBondParams()),this.getBufferParams({shrink:this.shrink,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))]}}updateData(e,n){var i=n.sview.getAtomData(this.getAtomParams()),r=n.sview.getBondData(this.getBondParams()),s={},o={};if(!e||e.position){Object.assign(s,{position:i.position});var a=r.position1,c=r.position2;Object.assign(o,{position:Fi(a,c,this.__center),position1:a,position2:c})}e&&!e.color||(Object.assign(s,{color:i.color}),Object.assign(o,{color:r.color,color2:r.color2})),e&&!e.radius||(Object.assign(s,{radius:i.radius}),Object.assign(o,{radius:r.radius,radius2:r.radius2})),n.bufferList[0].setAttributes(s),n.bufferList[1].setAttributes(o)}}Xt.add("hyperball",YP);class Fp{constructor(e,n={},i=""){this.type=e,this.text=n,this.format=i,this.errorLogged=!1}atomLabel(e){let n;switch(this.type){case"atomname":n=e.atomname;break;case"atomindex":n=`${e.index}`;break;case"occupancy":n=e.occupancy.toFixed(2);break;case"bfactor":n=e.bfactor.toFixed(2);break;case"serial":n=`${e.serial}`;break;case"element":n=e.element;break;case"atom":n=`${e.atomname}|${e.index}`;break;case"resname":n=e.resname;break;case"resno":n=`${e.resno}`;break;case"res":n=`${pu[e.resname.toUpperCase()]||e.resname}${e.resno}`;break;case"residue":const i=pu[e.resname.toUpperCase()];n=i&&!e.inscode?`${i}${e.resno}`:`[${e.resname}]${e.resno}${e.inscode}`;break;case"text":n=this.text[e.index];break;case"format":try{n=Sx.sprintf(this.format,e)}catch(r){this.errorLogged||(this.errorLogged=!0,console.log(r.message))}break;default:n=e.qualifiedName()}return n===void 0?"":n}}Fp.types={"":"",atomname:"atom name",atomindex:"atom index",occupancy:"occupancy",bfactor:"b-factor",serial:"serial",element:"element",atom:"atom name + index",resname:"residue name",resno:"residue no",res:"one letter code + no",residue:"[residue name] + no + inscode",text:"text",format:"format",qualified:"qualified name"};class ZP extends Cn{constructor(e,n,i){super(e,n,i),this.type="label",this.parameters=Object.assign({labelType:{type:"select",options:Fp.types,rebuild:!0},labelText:{type:"hidden",rebuild:!0},labelFormat:{type:"text",rebuild:!0},labelGrouping:{type:"select",options:{atom:"atom",residue:"residue"},rebuild:!0},fontFamily:{type:"select",options:{"sans-serif":"sans-serif",monospace:"monospace",serif:"serif"},buffer:!0},fontStyle:{type:"select",options:{normal:"normal",italic:"italic"},buffer:!0},fontWeight:{type:"select",options:{normal:"normal",bold:"bold"},buffer:!0},xOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},yOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},zOffset:{type:"number",precision:1,max:20,min:-20,buffer:!0},attachment:{type:"select",options:{"bottom-left":"bottom-left","bottom-center":"bottom-center","bottom-right":"bottom-right","middle-left":"middle-left","middle-center":"middle-center","middle-right":"middle-right","top-left":"top-left","top-center":"top-center","top-right":"top-right"},rebuild:!0},showBorder:{type:"boolean",buffer:!0},borderColor:{type:"color",buffer:!0},borderWidth:{type:"number",precision:2,max:.3,min:0,buffer:!0},showBackground:{type:"boolean",rebuild:!0},backgroundColor:{type:"color",buffer:!0},backgroundMargin:{type:"number",precision:2,max:2,min:0,rebuild:!0},backgroundOpacity:{type:"range",step:.01,max:1,min:0,buffer:!0},fixedSize:{type:"boolean",buffer:!0}},this.parameters,{side:null,flatShaded:null,wireframe:null,linewidth:null,roughness:null,metalness:null,diffuse:null}),this.init(i)}init(e){const n=e||{};this.labelType=I(n.labelType,"res"),this.labelText=I(n.labelText,{}),this.labelFormat=I(n.labelFormat,""),this.labelGrouping=I(n.labelGrouping,"atom"),this.fontFamily=I(n.fontFamily,"sans-serif"),this.fontStyle=I(n.fontStyle,"normal"),this.fontWeight=I(n.fontWeight,"bold"),this.xOffset=I(n.xOffset,0),this.yOffset=I(n.yOffset,0),this.zOffset=I(n.zOffset,.5),this.attachment=I(n.attachment,"bottom-left"),this.showBorder=I(n.showBorder,!1),this.borderColor=I(n.borderColor,"lightgrey"),this.borderWidth=I(n.borderWidth,.15),this.showBackground=I(n.showBackground,!1),this.backgroundColor=I(n.backgroundColor,"lightgrey"),this.backgroundMargin=I(n.backgroundMargin,.5),this.backgroundOpacity=I(n.backgroundOpacity,1),this.fixedSize=I(n.fixedSize,!1),super.init(n)}getTextData(e,n){const i=this.getAtomParams(n),r=new Fp(this.labelType,this.labelText,this.labelFormat);let s,o,a,c,l,h,u;if(this.labelGrouping==="atom"){const f=e.getAtomData(i);s=f.position,o=f.radius,a=f.color,n&&!n.text||(c=[],e.eachAtom(d=>c.push(r.atomLabel(d))))}else if(this.labelGrouping==="residue"){n&&!n.position||(l=[]),n&&!n.color||(u=[]),n&&!n.radius||(h=[]),n&&!n.text||(c=[]),i.colorParams&&(i.colorParams.structure=e.getStructure());const f=mt.getScheme(i.colorParams),d=new gr(i.radiusParams),p=e.getAtomProxy();let y=0;e.eachResidue(g=>{const m=3*y;g.isProtein()||g.isNucleic()?(p.index=g.traceAtomIndex,n&&!n.position||p.positionToArray(l,m)):(p.index=g.atomOffset,n&&!n.position||g.positionToArray(l,m)),n&&!n.color||f.atomColorToArray(p,u,m),n&&!n.radius||(h[y]=d.atomRadius(p)),n&&!n.text||c.push(r.atomLabel(p)),++y}),n&&!n.position||(s=new Float32Array(l)),n&&!n.color||(a=new Float32Array(u)),n&&!n.radius||(o=new Float32Array(h))}return{position:s,size:o,color:a,text:c}}createData(e){return{bufferList:[new ra(this.getTextData(e,{position:!0,color:!0,radius:!0,text:!0}),this.getBufferParams({fontFamily:this.fontFamily,fontStyle:this.fontStyle,fontWeight:this.fontWeight,xOffset:this.xOffset,yOffset:this.yOffset,zOffset:this.zOffset,attachment:this.attachment,showBorder:this.showBorder,borderColor:this.borderColor,borderWidth:this.borderWidth,showBackground:this.showBackground,backgroundColor:this.backgroundColor,backgroundMargin:this.backgroundMargin,backgroundOpacity:this.backgroundOpacity,fixedSize:this.fixedSize}))]}}updateData(e,n){n.bufferList[0].setAttributes(this.getTextData(n.sview,e))}getAtomRadius(){return 0}}function KP(t){const e=t.getAtomSet(),n=t.getBondSet(),i=t.getBondProxy();return n.forEach(function(r){i.index=r,e.clear(i.atomIndex1),e.clear(i.atomIndex2)}),e}Xt.add("label",ZP);class JP extends Cn{constructor(e,n,i){super(e,n,i),this.type="line",this.parameters=Object.assign({multipleBond:{type:"select",rebuild:!0,options:{off:"off",symmetric:"symmetric",offset:"offset"}},bondSpacing:{type:"number",precision:2,max:2,min:.5},linewidth:{type:"integer",max:50,min:1,buffer:!0},lines:{type:"boolean",rebuild:!0},crosses:{type:"select",rebuild:!0,options:{off:"off",lone:"lone",all:"all"}},crossSize:{type:"number",precision:2,max:2,min:.1}},this.parameters,{flatShaded:null,side:null,wireframe:null,roughness:null,metalness:null}),this.init(i)}init(e){var n=e||{};this.multipleBond=I(n.multipleBond,"off"),this.bondSpacing=I(n.bondSpacing,1),this.linewidth=I(n.linewidth,2),this.lines=I(n.lines,!0),this.crosses=I(n.crosses,"lone"),this.crossSize=I(n.crossSize,.4),super.init(n)}getAtomRadius(e){return .1}getBondParams(e,n){return n=Object.assign({multipleBond:this.multipleBond,bondSpacing:this.bondSpacing,radiusParams:{type:"size",size:.1,scale:1}},n),super.getBondParams(e,n)}_crossData(e,n){if(e&&!e.position&&!e.color)return;const i={};this.crosses==="lone"&&Object.assign(i,{atomSet:KP(n)});const r=n.getAtomData(this.getAtomParams(e,i)),s={},o=r.position,a=r.color,c=r.picking,l=(o||a).length,h=3*l;let u=new Float32Array(0),f=new Float32Array(0),d=new Float32Array(0),p=new Float32Array(0),y=0,g=new Float32Array(0);e&&!e.position||(u=s.position1=new Float32Array(h),f=s.position2=new Float32Array(h),y=this.crossSize/2),e&&!e.color||(d=s.color=new Float32Array(h),p=s.color2=new Float32Array(h)),e&&!e.picking||(g=new Float32Array(3*r.picking.array.length));for(let m=0;m<l;m++){const x=3*m,v=3*x;if(!e||e.position){const b=o[x],_=o[x+1],C=o[x+2];u[v]=b-y,u[v+1]=_,u[v+2]=C,f[v]=b+y,f[v+1]=_,f[v+2]=C,u[v+3]=b,u[v+4]=_-y,u[v+5]=C,f[v+3]=b,f[v+4]=_+y,f[v+5]=C,u[v+6]=b,u[v+7]=_,u[v+8]=C-y,f[v+6]=b,f[v+7]=_,f[v+8]=C+y}if(!e||e.color){const b=v+9;for(let _=v;_<b;_+=3)d[_]=p[_]=a[x],d[_+1]=p[_+1]=a[x+1],d[_+2]=p[_+2]=a[x+2]}e&&!e.picking||(g[x]=g[x+1]=g[x+2]=c.array[m])}return e&&!e.picking||(s.picking=new Rs(g,c.structure)),s}createData(e){const n={position:!0,color:!0,picking:!0},i=[];if(this.lines){const r=e.getBondData(this.getBondParams(n)),s=new yr(r,this.getBufferParams({linewidth:this.linewidth}));i.push(s)}if(this.crosses!=="off"){const r=new yr(this._crossData(n,e),this.getBufferParams({linewidth:this.linewidth}));i.push(r)}return{bufferList:i}}updateData(e,n){let i=0;if(this.lines){const r=n.sview.getBondData(this.getBondParams(e)),s={};e&&!e.position||Object.assign(s,{position1:r.position1,position2:r.position2}),e&&!e.color||Object.assign(s,{color:r.color,color2:r.color2}),n.bufferList[i++].setAttributes(s)}if(this.crosses!=="off"){const r=this._crossData(e,n.sview),s={};e&&!e.position||Object.assign(s,{position1:r.position1,position2:r.position2}),e&&!e.color||Object.assign(s,{color:r.color,color2:r.color2}),n.bufferList[i++].setAttributes(s)}}setParameters(e){var n={};return e&&(e.bondSpacing||e.crossSize)&&Object.assign(n,{position:!0}),super.setParameters(e,n,!1),this}}function Eb(t,e,n,i,r){const s=new(i=i||Int32Array)(t*e*n*(r=r||1));function o(a,c,l){return((a*e+c)*n+l)*r}return{data:s,index:o,set:function(a,c,l,...h){const u=o(a,c,l);for(let f=0;f<r;++f)s[u+f]=h[f]},toArray:function(a,c,l,h=[],u=0){const f=o(a,c,l);for(let d=0;d<r;++d)h[u+d]=s[f+d]},fromArray:function(a,c,l,h,u=0){const f=o(a,c,l);for(let d=0;d<r;++d)s[f+d]=h[u+d]},copy:function(a){s.set(a.data)}}}function Ah(t,e,n){var i=rb(e),r=Nc(t);t.length===0&&(r[0].set([0,0,0]),r[1].set([0,0,0]));var s,o,a,c,l,h,u,f,d,p,y,g,m,x,v,b=r[0],_=r[1];function C(Y,F,te,ee,j){s=F||1.4,o=te||2,g=j||!0;var Z=0;for(var ce in i)Z=Math.max(Z,ce);var de=Hc(b,_,Z,o,Y?s:0);c=de.dim[0],l=de.dim[1],h=de.dim[2],u=de.matrix,f=de.tran,o=de.scaleFactor,d={},p={},L(Y),y=s*o,a=ee||s/o,m=new Uint8Array(c*l*h),Y&&(x=new Float64Array(c*l*h)),g&&(v=new Int32Array(c*l*h))}var w=1,S=2,M=4,B=[new Int32Array([1,0,0]),new Int32Array([-1,0,0]),new Int32Array([0,1,0]),new Int32Array([0,-1,0]),new Int32Array([0,0,1]),new Int32Array([0,0,-1]),new Int32Array([1,1,0]),new Int32Array([1,-1,0]),new Int32Array([-1,1,0]),new Int32Array([-1,-1,0]),new Int32Array([1,0,1]),new Int32Array([1,0,-1]),new Int32Array([-1,0,1]),new Int32Array([-1,0,-1]),new Int32Array([0,1,1]),new Int32Array([0,1,-1]),new Int32Array([0,-1,1]),new Int32Array([0,-1,-1]),new Int32Array([1,1,1]),new Int32Array([1,1,-1]),new Int32Array([1,-1,1]),new Int32Array([-1,1,1]),new Int32Array([1,-1,-1]),new Int32Array([-1,-1,1]),new Int32Array([-1,1,-1]),new Int32Array([-1,-1,-1])];function L(Y){var F,te,ee,j,Z,ce,de,oe,V,re;for(var q in i)if(F=parseFloat(q),!d[q]){for(ce=(de=Y?(F+s)*o+.5:F*o+.5)*de,oe=Math.floor(de)+1,V=new Int32Array(oe*oe),re=0,te=0;te<oe;++te)for(ee=0;ee<oe;++ee)(j=te*te+ee*ee)>ce?V[re]=-1:(Z=Math.sqrt(ce-j),V[re]=Math.floor(Z)),++re;p[q]=oe,d[q]=V}}function U(Y){var F,te,ee,j,Z,ce,de,oe,V,re,q,J,W,H,se,$,he,me,le=3*Y,D=Y;F=Math.floor(.5+o*(t[le]+f[0])),te=Math.floor(.5+o*(t[le+1]+f[1])),ee=Math.floor(.5+o*(t[le+2]+f[2]));var N,pe=e[D],ue=d[pe],X=0,ye=l*h,_e=p[pe];for(re=0;re<_e;++re)for(q=0;q<_e;++q){if((N=ue[X])!==-1){for($=-1;$<2;++$)for(he=-1;he<2;++he)for(me=-1;me<2;++me)if($!==0&&he!==0&&me!==0){for(de=$*re,V=me*q,J=0;J<=N;++J)if(H=te+(oe=J*he),se=ee+V,!((W=F+de)<0||H<0||se<0||W>=c||H>=l||se>=h)){var xe=W*ye+H*h+se;if(g)if(m[xe]&w){if(m[xe]&w){var Se=v[xe];Se!==le&&de*de+oe*oe+V*V<(j=F+de-Math.floor(.5+o*(t[Se]+f[0])))*j+(Z=te+oe-Math.floor(.5+o*(t[Se+1]+f[1])))*Z+(ce=ee+V-Math.floor(.5+o*(t[Se+2]+f[2])))*ce&&(v[xe]=Y)}}else m[xe]|=w,v[xe]=Y;else m[xe]|=w}}}X++}}function E(Y){var F,te;for(console.time("EDTSurface fillvoxels"),F=0,te=m.length;F<te;++F)m[F]=0,Y&&(x[F]=-1),g&&(v[F]=-1);for(F=0,te=t.length/3;F<te;++F)U(F);for(F=0,te=m.length;F<te;++F)m[F]&w&&(m[F]|=S);console.timeEnd("EDTSurface fillvoxels")}function O(Y){var F,te,ee,j,Z,ce,de,oe,V,re,q,J,W,H,se,$,he,me,le,D=3*Y,N=Y,pe=0;F=Math.floor(.5+o*(t[D]+f[0])),te=Math.floor(.5+o*(t[D+1]+f[1])),ee=Math.floor(.5+o*(t[D+2]+f[2]));var ue=e[N],X=l*h;for(W=0,le=p[ue];W<le;++W)for(H=0;H<le;++H){if(d[ue][pe]!==-1){for($=-1;$<2;++$)for(he=-1;he<2;++he)for(me=-1;me<2;++me)if($!==0&&he!==0&&me!==0){for(de=$*W,V=me*H,se=0;se<=d[ue][pe];++se)if(q=te+(oe=se*he),J=ee+V,!((re=F+de)<0||q<0||J<0||re>=c||q>=l||J>=h)){var ye=re*X+q*h+J;if(m[ye]&S){if(g){var _e=v[ye];de*de+oe*oe+V*V<(j=Math.floor(.5+o*(t[_e]+f[0])))*j+(Z=Math.floor(.5+o*(t[_e+1]+f[1])))*Z+(ce=Math.floor(.5+o*(t[_e+2]+f[2])))*ce&&(v[ye]=Y)}}else m[ye]|=S,g&&(v[ye]=Y)}}}pe++}}function k(){var Y,F,te,ee;console.time("EDTSurface fastdistancemap");var j,Z=Eb(c,l,h,Uint16Array,3),ce=l*h,de=y*y,oe=0;for(Y=0;Y<c;++Y)for(F=0;F<l;++F)for(te=0;te<h;++te)m[j=Y*ce+F*h+te]&=~S,m[j]&w&&m[j]&M&&(Z.set(Y,F,te,Y,F,te),x[j]=0,m[j]|=S,oe+=1);var V=new Int32Array(3*oe),re=0,q=new Int32Array(3*oe),J=0;for(Y=0;Y<c;++Y)for(F=0;F<l;++F)for(te=0;te<h;++te)m[j=Y*ce+F*h+te]&M&&(V[re]=Y,V[re+1]=F,V[re+2]=te,re+=3,m[j]&=~M);do for(J=ne(V,Z,re,q),re=0,Y=0,ee=J;Y<ee;Y+=3)j=ce*q[Y]+h*q[Y+1]+q[Y+2],m[j]&=~M,x[j]<=1.0404*de&&(V[re]=q[Y],V[re+1]=q[Y+1],V[re+2]=q[Y+2],re+=3);while(re>0);var W,H=a*a,se=new Uint16Array(3);for(Y=0;Y<c;++Y)for(F=0;F<l;++F)for(te=0;te<h;++te)m[j=Y*ce+F*h+te]&=~M,m[j]&w&&(m[j]&S&&!(m[j]&S&&x[j]>=H)||(m[j]|=M,g&&m[j]&S&&(Z.toArray(Y,F,te,se),W=se[0]*ce+se[1]*h+se[2],v[j]=v[W])));console.timeEnd("EDTSurface fastdistancemap")}function ne(Y,F,te,ee){var j,Z,ce,de,oe,V,re,q,J,W,H,se,$=new Uint16Array(3),he=0;if(te===0)return he;var me=-1,le=-1,D=-1,N=l*h;for(re=0,J=te;re<J;re+=3)for(j=Y[re],Z=Y[re+1],ce=Y[re+2],F.toArray(j,Z,ce,$),q=0;q<6;++q)me=j+(se=B[q])[0],le=Z+se[1],D=ce+se[2],me<c&&me>-1&&le<l&&le>-1&&D<h&&D>-1&&(m[H=me*N+h*le+D]&w&&!(m[H]&S)?(F.fromArray(me,le,D,$),W=(de=me-$[0])*de+(oe=le-$[1])*oe+(V=D-$[2])*V,x[H]=W,m[H]|=S,m[H]|=M,ee[he]=me,ee[he+1]=le,ee[he+2]=D,he+=3):m[H]&w&&m[H]&S&&(W=(de=me-$[0])*de+(oe=le-$[1])*oe+(V=D-$[2])*V)<x[H]&&(F.fromArray(me,le,D,$),x[H]=W,m[H]&M||(m[H]|=M,ee[he]=me,ee[he+1]=le,ee[he+2]=D,he+=3)));for(re=0,J=te;re<J;re+=3)for(j=Y[re],Z=Y[re+1],ce=Y[re+2],F.toArray(j,Z,ce,$),q=6;q<18;q++)me=j+(se=B[q])[0],le=Z+se[1],D=ce+se[2],me<c&&me>-1&&le<l&&le>-1&&D<h&&D>-1&&(m[H=me*N+h*le+D]&w&&!(m[H]&S)?(F.fromArray(me,le,D,$),W=(de=me-$[0])*de+(oe=le-$[1])*oe+(V=D-$[2])*V,x[H]=W,m[H]|=S,m[H]|=M,ee[he]=me,ee[he+1]=le,ee[he+2]=D,he+=3):m[H]&w&&m[H]&S&&(W=(de=me-$[0])*de+(oe=le-$[1])*oe+(V=D-$[2])*V)<x[H]&&(F.fromArray(me,le,D,$),x[H]=W,m[H]&M||(m[H]|=M,ee[he]=me,ee[he+1]=le,ee[he+2]=D,he+=3)));for(re=0,J=te;re<J;re+=3)for(j=Y[re],Z=Y[re+1],ce=Y[re+2],F.toArray(j,Z,ce,$),q=18;q<26;q++)me=j+(se=B[q])[0],le=Z+se[1],D=ce+se[2],me<c&&me>-1&&le<l&&le>-1&&D<h&&D>-1&&(m[H=me*N+h*le+D]&w&&!(m[H]&S)?(F.fromArray(me,le,D,$),W=(de=me-$[0])*de+(oe=le-$[1])*oe+(V=D-$[2])*V,x[H]=W,m[H]|=S,m[H]|=M,ee[he]=me,ee[he+1]=le,ee[he+2]=D,he+=3):m[H]&w&&m[H]&S&&(W=(de=me-$[0])*de+(oe=le-$[1])*oe+(V=D-$[2])*V)<x[H]&&(F.fromArray(me,le,D,$),x[H]=W,m[H]&M||(m[H]|=M,ee[he]=me,ee[he+1]=le,ee[he+2]=D,he+=3)));return he}this.getVolume=function(Y,F,te,ee,j){console.time("EDTSurface.getVolume");var Z=Y!=="vws";C(Z,F,te,ee,j),E(Z),function(){var oe,V,re,q=l*h;for(oe=0;oe<c;++oe)for(V=0;V<h;++V)for(re=0;re<l;++re){var J=oe*q+re*h+V;if(m[J]&w)for(var W=0;W<26;){var H=oe+B[W][0],se=V+B[W][2],$=re+B[W][1];if(H>-1&&H<c&&$>-1&&$<l&&se>-1&&se<h&&!(m[H*q+$*h+se]&w)){m[J]|=M;break}W++}}}(),Y!=="ms"&&Y!=="ses"||k(),Y==="ses"&&(L(!1),function(){var oe,V;for(oe=0,V=m.length;oe<V;++oe)m[oe]&=~S;for(oe=0,V=t.length/3;oe<V;++oe)O(oe)}()),function(oe){var V,re=m.length;if(oe==="vws")for(V=0;V<re;++V)m[V]&=~M,m[V]=m[V]&S?1:0;else if(oe==="ms")for(V=0;V<re;++V)m[V]&=~S,m[V]&M&&(m[V]|=S),m[V]&=~M,m[V]=m[V]&S?1:0;else if(oe==="ses")for(V=0;V<re;++V)m[V]&M&&m[V]&S?m[V]&=~M:m[V]&M&&!(m[V]&S)&&(m[V]|=S),m[V]=m[V]&S?1:0;else if(oe==="sas")for(V=0;V<re;++V)m[V]&=~M,m[V]=m[V]&S?1:0}(Y);for(var ce=0,de=v.length;ce<de;++ce)v[ce]=n[v[ce]];return console.timeEnd("EDTSurface.getVolume"),{data:m,nx:h,ny:l,nz:c,atomindex:v}},this.getSurface=function(Y,F,te,ee,j,Z,ce){var de=this.getVolume(Y,F,te,ee,j);return new Gr(de.data,de.nx,de.ny,de.nz,de.atomindex).getSurface(1,Z,void 0,u,ce)}}function Ib(t,e,n,i,r,s,o){o=Math.max(.1,o);var a=t.length,c=r[0],l=r[1],h=r[2],u=s[0],f=s[1],d=s[2];function p(te,ee){return Math.floor((te-ee)/o)}for(var y,g,m,x=p(u,c)+1,v=p(f,l)+1,b=p(d,h)+1,_=x*v*b,C=v*b,w=[],S=0;S<a;S++){var M=(y=t[S],g=e[S],m=n[S],(p(y,c)*v+p(g,l))*b+p(m,h));w[M]===void 0?w[M]=[S]:w[M].push(S)}var B=new Uint32Array(_),L=new Uint16Array(_),U=new Uint32Array(a),E=0,O=0;for(S=0;S<_;S++){var k=B[S]=E,ne=w[S];if(ne!==void 0)for(var Y=0;Y<ne.length;Y++)U[E]=ne[Y],E++;var F=E-k;L[S]=F,F>O&&(O=F)}return{neighbourListLength:27*O+1,withinRadii:function(te,ee,j,Z,ce){for(var de=0,oe=p(te,c),V=p(ee,l),re=p(j,h),q=Math.max(0,oe-1),J=Math.max(0,V-1),W=Math.max(0,re-1),H=Math.min(x,oe+2),se=Math.min(v,V+2),$=Math.min(b,re+2),he=q;he<H;++he)for(var me=he*C,le=J;le<se;++le)for(var D=le*b,N=W;N<$;++N)for(var pe=me+D+N,ue=B[pe],X=ue+L[pe],ye=ue;ye<X;ye++){var _e=U[ye],xe=t[_e]-te,Se=e[_e]-ee,Me=n[_e]-j,Oe=i[_e]+Z;xe*xe+Se*Se+Me*Me<=Oe*Oe&&(ce[de++]=U[ye])}ce[de]=-1}}}function Ch(t,e,n){const i=e.length,r=new Float32Array(i),s=new Float32Array(i),o=new Float32Array(i);for(let oe=0;oe<i;oe++){const V=3*oe;r[oe]=t[V],s[oe]=t[V+1],o[oe]=t[V+2]}let a=Nc(t);t.length===0&&(a[0].set([0,0,0]),a[1].set([0,0,0]));const c=a[0],l=a[1];let h,u,f,d,p,y,g,m,x,v,b,_,C,w,S,M,B,L,U=-1;const E=new Float32Array([0,0,0]),O=new Float32Array([0,0,0]),k=new Float32Array([0,0,0]),ne=new Float32Array([0,0,0]);let Y;function F(oe,V,re,q){d=I(oe,1.4),p=I(V,2),y=I(re,!0),g=I(q,30),h=new Float32Array(i),u=new Float32Array(i);for(let W=0;W<h.length;++W){var J=e[W]+d;h[W]=J,u[W]=J*J}f=0;for(let W=0;W<h.length;++W)h[W]>f&&(f=h[W]);(function(){const W=Hc(c,l,f,p,0);p=W.scaleFactor,m=W.dim,x=W.matrix,Y=Math.max(5,2+Math.floor(d*p)),v=Jn(m[0]*m[1]*m[2],-1001),b=new Int32Array(v.length),_=new Float32Array(m[0]),C=new Float32Array(m[1]),w=new Float32Array(m[2]),te(_,c[0],1/p),te(C,c[1],1/p),te(w,c[2],1/p)})(),function(){var W=0,H=2*Math.PI/g;M=new Float32Array(g),S=new Float32Array(g);for(var se=0;se<g;se++)M[se]=Math.cos(W),S[se]=Math.sin(W),W+=H}(),B=Ib(r,s,o,h,c,l,2.01*f),L=new Int32Array(B.neighbourListLength),U=-1}function te(oe,V,re){for(let q=0;q<oe.length;q++)oe[q]=V+re*q}function ee(oe,V,re,q,J){let W;if(U!==-1){if(W=U,W!==q&&W!==J&&j(W,oe,V,re))return W;U=-1}var H=0;for(W=L[H];W>=0;){if(W!==q&&W!==J&&j(W,oe,V,re))return U=W,W;W=L[++H]}return U=-1,-1}function j(oe,V,re,q){var J=3*oe,W=u[oe],H=t[J]-V,se=t[J+1]-re,$=t[J+2]-q;return H*H+se*se+$*$<W}function Z(){for(var oe=0;oe<i;oe++){var V=r[oe],re=s[oe],q=o[oe],J=h[oe],W=u[oe];B.withinRadii(V,re,q,J,L);for(var H=Math.ceil(J*p),se=Math.floor(p*(V-c[0])),$=Math.floor(p*(re-c[1])),he=Math.floor(p*(q-c[2])),me=Math.max(0,se-H),le=Math.max(0,$-H),D=Math.max(0,he-H),N=Math.min(m[0],se+H+2),pe=Math.min(m[1],$+H+2),ue=Math.min(m[2],he+H+2),X=me;X<N;X++)for(var ye=_[X]-V,_e=m[1]*m[2]*X,xe=le;xe<pe;xe++)for(var Se=C[xe]-re,Me=ye*ye+Se*Se,Oe=_e+m[2]*xe,Ne=D;Ne<ue;Ne++){var we=w[Ne]-q,Fe=Me+we*we;if(Fe<W){var je=Ne+Oe;v[je]<0&&(v[je]=-v[je]);var Be=Math.sqrt(Fe),tt=J/Be,Ue=ye*tt,yt=Se*tt,Rt=we*tt;if(ee(Ue+=V,yt+=re,Rt+=q,oe,-1)===-1){var Vt=J-Be;Vt<v[je]&&(v[je]=Vt,y&&(b[je]=oe))}}}}}function ce(oe,V){var re=h[oe],q=h[V],J=E[0]=r[V]-r[oe],W=E[1]=s[V]-s[oe],H=E[2]=o[V]-o[oe],se=J*J+W*W+H*H,$=Math.sqrt(se),he=re*((re*re+$*$-q*q)/(2*re*$));nn(E,E),function(Mt,Le){Mt[0]=Mt[1]=Mt[2]=1,Le[0]!==0?Mt[0]=(Le[1]+Le[2])/-Le[0]:Le[1]!==0?Mt[1]=(Le[0]+Le[2])/-Le[1]:Le[2]!==0&&(Mt[2]=(Le[0]+Le[1])/-Le[2])}(k,E),nn(k,k),Vn(ne,E,k),nn(ne,ne);var me=Math.sqrt(re*re-he*he);kt(k,k,me),kt(ne,ne,me),kt(E,E,he),O[0]=E[0]+r[oe],O[1]=E[1]+s[oe],O[2]=E[2]+o[oe],U=-1;for(var le=Y,D=0;D<g;D++){var N=M[D],pe=S[D],ue=O[0]+N*k[0]+pe*ne[0],X=O[1]+N*k[1]+pe*ne[1],ye=O[2]+N*k[2]+pe*ne[2];if(ee(ue,X,ye,oe,V)===-1)for(var _e=Math.floor(p*(ue-c[0])),xe=Math.floor(p*(X-c[1])),Se=Math.floor(p*(ye-c[2])),Me=Math.max(0,_e-le),Oe=Math.max(0,xe-le),Ne=Math.max(0,Se-le),we=Math.min(m[0],_e+le+2),Fe=Math.min(m[1],xe+le+2),je=Math.min(m[2],Se+le+2),Be=Me;Be<we;Be++){J=ue-_[Be];for(var tt=m[1]*m[2]*Be,Ue=Oe;Ue<Fe;Ue++)for(var yt=J*J+(W=X-C[Ue])*W,Rt=tt+m[2]*Ue,Vt=Ne;Vt<je;Vt++){se=yt+(H=ye-w[Vt])*H;var dt=Vt+Rt,xt=v[dt];if(xt>0&&se<xt*xt&&(v[dt]=Math.sqrt(se),y)){const Mt=J*E[0]+W*E[1]+H*E[2];b[dt]=Mt<0?V:oe}}}}}function de(oe,V,re){console.time("AVSurface.getVolume"),console.time("AVSurface.init"),F(oe,V,re),console.timeEnd("AVSurface.init"),console.time("AVSurface.projectPoints"),Z(),console.timeEnd("AVSurface.projectPoints"),console.time("AVSurface.projectTorii"),function(){for(var q=0;q<i;q++){B.withinRadii(r[q],s[q],o[q],h[q],L);for(var J=0,W=L[J];W>=0;)q<W&&ce(q,W),W=L[++J]}}(),console.timeEnd("AVSurface.projectTorii"),function(){for(var q=0;q<v.length;q++)v[q]<0&&(v[q]=0)}(),function(){for(var q=0;q<b.length;q++)b[q]=n[b[q]]}(),console.timeEnd("AVSurface.getVolume")}this.getSurface=function(oe,V,re,q,J,W,H){return de(V,re,J),new Gr(v,m[2],m[1],m[0],b).getSurface(V,!1,void 0,x,H)}}Xt.add("line",JP),Object.assign(Ah,{__deps:[Hc,rb,Gr,Nc,Eb]}),Object.assign(Ch,{__deps:[Hc,Gr,Jn,Nc,kt,Vn,nn,Ib,I]}),ec.add("molsurf",function(t,e){const n=t.data.args,i=t.data.params;if(n&&i){const r=new(i.type==="av"?Ch:Ah)(n.coordList,n.radiusList,n.indexList).getSurface(i.type,i.probeRadius,i.scaleFactor,i.cutoff,!0,i.smooth,i.contour),s=[r.position.buffer,r.index.buffer];r.normal&&s.push(r.normal.buffer),r.atomindex&&s.push(r.atomindex.buffer),e({sd:r,p:i},s)}},[Ah,Ch]);class QP{constructor(e){this.structure=e}_getAtomData(e){return this.structure.getAtomData({what:{position:!0,radius:!0,index:!0},radiusParams:I(e.radiusParams,{type:"vdw",scale:1})})}_makeSurface(e,n){var i=new Nu(n.name,"",e);return i.info.type=n.type,i.info.probeRadius=n.probeRadius,i.info.scaleFactor=n.scaleFactor,i.info.smooth=n.smooth,i.info.cutoff=n.cutoff,i}getSurface(e){const n=e||{},i=this._getAtomData(e),r=i.position,s=i.radius,o=i.index,a=new(n.type==="av"?Ch:Ah)(r,s,o).getSurface(n.type,n.probeRadius,n.scaleFactor,n.cutoff,!0,n.smooth,n.contour);return this._makeSurface(a,n)}getSurfaceWorker(e,n){const i=Object.assign({},e);if(window.hasOwnProperty("Worker")){this.worker===void 0&&(this.worker=new Fx("molsurf"));const r=this._getAtomData(e),s=r.position,o=r.radius,a=r.index,c={args:{coordList:s,radiusList:o,indexList:a},params:i},l=[s.buffer,o.buffer,a.buffer];this.worker.post(c,l,h=>{n(this._makeSurface(h.data.sd,i))},h=>{console.warn("MolecularSurface.getSurfaceWorker error - trying without worker",h),this.worker.terminate(),this.worker=void 0;const u=this.getSurface(i);n(u)})}else{const r=this.getSurface(i);n(r)}}dispose(){this.worker&&this.worker.terminate()}}class eE extends Cn{constructor(e,n,i){super(e,n,i),this.type="surface",this.parameters=Object.assign({surfaceType:{type:"select",rebuild:!0,options:{vws:"vws",sas:"sas",ms:"ms",ses:"ses",av:"av"}},probeRadius:{type:"number",precision:1,max:20,min:0,rebuild:!0},smooth:{type:"integer",precision:1,max:10,min:0,rebuild:!0},scaleFactor:{type:"number",precision:1,max:5,min:0,rebuild:!0},cutoff:{type:"number",precision:2,max:50,min:0,rebuild:!0},contour:{type:"boolean",rebuild:!0},background:{type:"boolean",rebuild:!0},opaqueBack:{type:"boolean",buffer:!0},filterSele:{type:"text",rebuild:!0},colorVolume:{type:"hidden"},useWorker:{type:"boolean",rebuild:!0}},this.parameters,{radius:null,scale:null}),this.__infoList=[],this.structure.signals.refreshed.add(()=>{this.__forceNewMolsurf=!0}),this.toBePrepared=!0,this.init(i)}init(e){const n=e||{};n.colorScheme=I(n.colorScheme,"uniform"),n.colorValue=I(n.colorValue,14540253),n.disablePicking=I(n.disablePicking,!0),this.surfaceType=I(n.surfaceType,"ms"),this.probeRadius=I(n.probeRadius,1.4),this.smooth=I(n.smooth,2),this.scaleFactor=I(n.scaleFactor,2),this.cutoff=I(n.cutoff,0),this.contour=I(n.contour,!1),this.background=I(n.background,!1),this.opaqueBack=I(n.opaqueBack,!0),this.filterSele=I(n.filterSele,""),this.colorVolume=I(n.colorVolume,void 0),this.useWorker=I(n.useWorker,!0),super.init(e)}prepareData(e,n,i){let r=this.__infoList[n];if(r||(r={},this.__infoList[n]=r),r.molsurf&&r.sele===e.selection.string)i(n);else{if(this.filterSele){const a=e.structure.getView(new qt(this.filterSele)),c=a.boundingBox.getSize(new T),l=Math.max(c.x,c.y,c.z),h=e.getAtomSetWithinPoint(a.center,l/2+6);if((e=e.getView(new qt(e.getAtomSetWithinSelection(h,3).toSeleString()))).atomCount===0)return void i(n)}r.sele=e.selection.string,r.molsurf=new QP(e);const s=this.getSurfaceParams(),o=a=>{r.surface=a,i(n)};this.useWorker?r.molsurf.getSurfaceWorker(s,o):o(r.molsurf.getSurface(s))}}prepare(e){if((this.__forceNewMolsurf||this.__sele!==this.selection.string||this.__surfaceParams!==JSON.stringify(this.getSurfaceParams()))&&(this.__infoList.forEach(s=>{s&&s.molsurf&&s.molsurf.dispose()}),this.__infoList.length=0),this.structureView.atomCount===0)return void e();const n=()=>{this.__sele=this.selection.string,this.__surfaceParams=JSON.stringify(this.getSurfaceParams()),this.__forceNewMolsurf=!1,e()},i=this.assembly==="default"?this.defaultAssembly:this.assembly,r=this.structure.biomolDict[i];r?r.partList.forEach((s,o)=>{const a=s.getView(this.structureView);this.prepareData(a,o,c=>{c===r.partList.length-1&&n()})}):this.prepareData(this.structureView,0,n)}createData(e,n){const i=this.__infoList[n],r=i.surface;if(!r)return;const s={position:r.getPosition(),color:r.getColor(this.getColorParams()),index:r.getFilteredIndex(this.filterSele,e)},o=[];if(r.contour){const a=new ab(s,this.getBufferParams({wireframe:!1}));o.push(a)}else{Object.assign(s,{normal:r.getNormal(),picking:r.getPicking(e.getStructure())});const a=new sb(s,this.getBufferParams({background:this.background,opaqueBack:this.opaqueBack,dullInterior:!1}));if(this.getBufferParams().side=="double"){const c=new ob(a);o.push(c)}else o.push(a)}return{bufferList:o,info:i}}updateData(e,n){const i={};if(e.position||e.radius)return this.__forceNewMolsurf=!0,void this.build();e.color&&(i.color=n.info.surface.getColor(this.getColorParams())),e.index&&(i.index=n.info.surface.getFilteredIndex(this.filterSele,n.sview)),n.bufferList[0].setAttributes(i)}setParameters(e,n={},i){return e&&e.filterSele&&(n.index=!0),e&&e.colorVolume!==void 0&&(n.color=!0),e&&e.wireframe&&(e.contour||e.contour===void 0&&this.contour)&&(e.wireframe=!1),super.setParameters(e,n,i),this}getSurfaceParams(e={}){return Object.assign({type:this.surfaceType,probeRadius:this.probeRadius,scaleFactor:this.scaleFactor,smooth:this.smooth&&!this.contour,cutoff:this.cutoff,contour:this.contour,useWorker:this.useWorker,radiusParams:this.getRadiusParams()},e)}getColorParams(){const e=super.getColorParams();return e.volume=this.colorVolume,e}getAtomRadius(){return 0}clear(){super.clear()}dispose(){this.__infoList.forEach(e=>{e&&e.molsurf&&e.molsurf.dispose()}),this.__infoList.length=0,super.dispose()}}Xt.add("surface",eE);class tE extends Cn{constructor(e,n,i){super(e,n,i),this.type="point",this.parameters=Object.assign({pointSize:{type:"number",precision:1,max:100,min:0,buffer:!0},sizeAttenuation:{type:"boolean",buffer:!0},sortParticles:{type:"boolean",rebuild:!0},useTexture:{type:"boolean",buffer:!0},alphaTest:{type:"range",step:.001,max:1,min:0,buffer:!0},forceTransparent:{type:"boolean",buffer:!0},edgeBleach:{type:"range",step:.001,max:1,min:0,buffer:!0}},this.parameters,{flatShaded:null,wireframe:null,linewidth:null,side:null,roughness:null,metalness:null}),this.init(i)}init(e){var n=e||{};this.pointSize=I(n.pointSize,1),this.sizeAttenuation=I(n.sizeAttenuation,!0),this.sortParticles=I(n.sortParticles,!1),this.useTexture=I(n.useTexture,!1),this.alphaTest=I(n.alphaTest,.5),this.forceTransparent=I(n.forceTransparent,!1),this.edgeBleach=I(n.edgeBleach,0),super.init(n)}createData(e){var n=e.getAtomData(this.getAtomParams({position:!0,color:!0,picking:!0}));return{bufferList:[new Am(n,this.getBufferParams({pointSize:this.pointSize,sizeAttenuation:this.sizeAttenuation,sortParticles:this.sortParticles,useTexture:this.useTexture,alphaTest:this.alphaTest,forceTransparent:this.forceTransparent,edgeBleach:this.edgeBleach}))]}}updateData(e,n){var i=n.sview.getAtomData(this.getAtomParams(e)),r={};e&&!e.position||Object.assign(r,{position:i.position}),e&&!e.color||Object.assign(r,{color:i.color}),n.bufferList[0].setAttributes(r)}getAtomRadius(){return .1}}Xt.add("point",tE),At.add("shader/Ribbon.vert",`#define STANDARD
uniform float clipNear;
uniform vec3 clipCenter;
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )
varying vec3 vViewPosition;
#endif
#if defined( RADIUS_CLIP )
varying vec3 vClipCenter;
#endif
attribute vec3 dir;
attribute float size;
#ifdef PICKING
#include unpack_color
attribute float primitiveId;
varying vec3 vPickingColor;
#else
#include color_pars_vertex
#ifndef FLAT_SHADED
varying vec3 vNormal;
#endif
#endif
#include common
void main(void){
#ifdef PICKING
vPickingColor = unpackColor( primitiveId );
#else
#include color_vertex
#include beginnormal_vertex
#include defaultnormal_vertex
#ifndef FLAT_SHADED
vNormal = normalize( transformedNormal );
#endif
#endif
#include begin_vertex
transformed += normalize( dir ) * size;
#include project_vertex
#if defined( NEAR_CLIP ) || defined( RADIUS_CLIP ) || !defined( PICKING )
vViewPosition = -mvPosition.xyz;
#endif
#if defined( RADIUS_CLIP )
vClipCenter = -( modelViewMatrix * vec4( clipCenter, 1.0 ) ).xyz;
#endif
#include nearclip_vertex
}`);const nE=new Uint16Array([0,1,2,1,3,2]);function ka(t){return 3*(4*(t.position.length/3-1))}class iE extends mr{constructor(e,n={}){super({position:new Float32Array(ka(e)),color:new Float32Array(ka(e)),index:$i(ka(e),ka(e)/3),normal:new Float32Array(ka(e)),picking:e.picking},n),this.vertexShader="Ribbon.vert";const i=e.position.length/3-1,r=4*i,s=3*r;this.addAttributes({dir:{type:"v3",value:new Float32Array(s)}}),this.addAttributes({size:{type:"f",value:new Float32Array(r)}}),e.primitiveId=ea(i),this.setAttributes(e),this.makeIndex()}setAttributes(e={}){const n=this.size/4,i=this.geometry.attributes;let r,s,o,a,c,l,h,u,f,d,p,y,g,m,x,v,b,_,C;e.position&&(r=e.position,h=i.position.array,i.position.needsUpdate=!0),e.normal&&(s=e.normal,u=i.normal.array,i.normal.needsUpdate=!0),e.size&&(o=e.size,f=i.size.array,i.size.needsUpdate=!0),e.dir&&(a=e.dir,d=i.dir.array,i.dir.needsUpdate=!0),e.color&&(c=e.color,p=i.color.array,i.color.needsUpdate=!0),e.primitiveId&&(l=e.primitiveId,y=i.primitiveId.array,i.primitiveId.needsUpdate=!0);let w=o?o[0]:null;for(g=0;g<n;++g){for(_=3*g,x=3*g*4,b=4*g,r&&(h[x]=h[x+3]=r[_],h[x+1]=h[x+4]=r[_+1],h[x+2]=h[x+5]=r[_+2],h[x+6]=h[x+9]=r[_+3],h[x+7]=h[x+10]=r[_+4],h[x+8]=h[x+11]=r[_+5]),s&&(u[x]=u[x+3]=-s[_],u[x+1]=u[x+4]=-s[_+1],u[x+2]=u[x+5]=-s[_+2],u[x+6]=u[x+9]=-s[_+3],u[x+7]=u[x+10]=-s[_+4],u[x+8]=u[x+11]=-s[_+5]),m=0;m<4;++m)v=x+3*m,c&&(p[v]=c[_],p[v+1]=c[_+1],p[v+2]=c[_+2]),l&&(y[b+m]=l[g]);o&&(C=o[g],w!==o[g]?(f[b]=w,f[b+1]=w,f[b+2]=C,f[b+3]=C):(f[b]=C,f[b+1]=C,f[b+2]=C,f[b+3]=C),w=C),a&&(d[x]=a[_],d[x+1]=a[_+1],d[x+2]=a[_+2],d[x+3]=-a[_],d[x+4]=-a[_+1],d[x+5]=-a[_+2],d[x+6]=a[_+3],d[x+7]=a[_+4],d[x+8]=a[_+5],d[x+9]=-a[_+3],d[x+10]=-a[_+4],d[x+11]=-a[_+5])}}makeIndex(){const e=this.geometry.getIndex();if(!e)return void fe.error("Index is null");const n=e.array,i=n.length/4/3;for(let r=0;r<i;++r){const s=6*r,o=4*r;n.set(nE,s);for(let a=0;a<6;++a)n[s+a]+=o}}}class rE extends Cn{constructor(e,n,i){super(e,n,i),this.type="ribbon",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{side:null,wireframe:null,linewidth:null}),this.init(i)}init(e){var n=e||{};n.colorScheme=I(n.colorScheme,"chainname"),n.colorScale=I(n.colorScale,"RdYlBu"),n.radiusType=I(n.radiusType,"sstruc"),n.radiusScale=I(n.radiusScale,4),n.quality==="low"?this.subdiv=3:n.quality==="medium"?this.subdiv=6:n.quality==="high"?this.subdiv=12:this.subdiv=I(n.subdiv,6),this.tension=I(n.tension,NaN),this.smoothSheet=I(n.smoothSheet,!1),super.init(n)}getSplineParams(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!0,smoothSheet:this.smoothSheet},e)}getAtomRadius(e){return e.isTrace()?super.getAtomRadius(e):0}createData(e){var n=[],i=[];return this.structure.eachPolymer(r=>{if(!(r.residueCount<4)){i.push(r);var s=new qo(r,this.getSplineParams()),o=s.getSubdividedPosition(),a=s.getSubdividedOrientation(),c=s.getSubdividedColor(this.getColorParams()),l=s.getSubdividedPicking(),h=s.getSubdividedSize(this.getRadiusParams());n.push(new iE({position:o.position,normal:a.binormal,dir:a.normal,color:c.color,size:h.size,picking:l.picking},this.getBufferParams()))}},e.getSelection()),{bufferList:n,polymerList:i}}updateData(e,n){e=e||{};var i=0,r=n.polymerList.length;for(i=0;i<r;++i){var s={},o=new qo(n.polymerList[i],this.getSplineParams());if(e.position){var a=o.getSubdividedPosition(),c=o.getSubdividedOrientation();Object.assign(s,{position:a.position,normal:c.binormal,dir:c.normal})}if(e.radius||e.scale){var l=o.getSubdividedSize(this.getRadiusParams());Object.assign(s,{size:l.size})}if(e.color){var h=o.getSubdividedColor(this.getColorParams());Object.assign(s,{color:h.color})}n.bufferList[i].setAttributes(s)}}setParameters(e){var n={};return e&&e.tension&&Object.assign(n,{position:!0}),super.setParameters(e,n,!1),this}}Xt.add("ribbon",rE);class sE extends Cn{constructor(e,n,i){super(e,n,i),this.type="rocket",this.parameters=Object.assign({localAngle:{type:"integer",max:180,min:0,rebuild:!0},centerDist:{type:"number",precision:1,max:10,min:0,rebuild:!0},ssBorder:{type:"boolean",rebuild:!0},radialSegments:!0,openEnded:!0,disableImpostor:!0},this.parameters),this.init(i)}init(e){let n=e||{};n.colorScheme=I(n.colorScheme,"sstruc"),n.radiusSize=I(n.radiusSize,1.5),n.radiusScale=I(n.radiusScale,1),n.openEnded=I(n.openEnded,!1),n.useInteriorColor=I(n.useInteriorColor,!0),this.localAngle=I(n.localAngle,30),this.centerDist=I(n.centerDist,2.5),this.ssBorder=I(n.ssBorder,!1),super.init(n)}createData(e){let n=0;const i=[],r=[];this.structure.eachPolymer(c=>{if(c.residueCount<4||c.isNucleic())return;const l=new ub(c),h=l.getAxis(this.localAngle,this.centerDist,this.ssBorder,this.getColorParams(),this.getRadiusParams());n+=h.size.length,i.push(h),r.push(l)},e.getSelection());const s={begin:new Float32Array(3*n),end:new Float32Array(3*n),size:new Float32Array(n),color:new Float32Array(3*n),picking:{}};let o=new Float32Array(n),a=0;return i.forEach(function(c){s.begin.set(c.begin,3*a),s.end.set(c.end,3*a),s.size.set(c.size,a),s.color.set(c.color,3*a),o.set(c.picking.array,a),a+=c.size.length}),n&&(s.picking=new Rs(o,e.getStructure())),{bufferList:[new vr({position1:s.begin,position2:s.end,color:s.color,color2:s.color,radius:s.size,picking:s.picking},this.getBufferParams({openEnded:this.openEnded,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0}))],axisList:i,helixbundleList:r,axisData:s}}updateData(e,n){if((e=e||{}).position)this.build();else{var i={};if(e.color||e.radius){var r=0;n.helixbundleList.forEach(s=>{var o=s.getAxis(this.localAngle,this.centerDist,this.ssBorder,this.getColorParams(),this.getRadiusParams());e.color&&n.axisData.color.set(o.color,3*r),(e.radius||e.scale)&&n.axisData.size.set(o.size,r),r+=o.size.length}),e.color&&Object.assign(i,{color:n.axisData.color,color2:n.axisData.color}),(e.radius||e.scale)&&Object.assign(i,{radius:n.axisData.size})}n.bufferList[0].setAttributes(i)}}}Xt.add("rocket",sE);class oE extends Im{constructor(e,n,i){super(e,n,i),this.type="rope",this.parameters=Object.assign({smooth:{type:"integer",max:15,min:0,rebuild:!0}},this.parameters,{aspectRatio:null,smoothSheet:null})}init(e){var n=e||{};n.aspectRatio=1,n.tension=I(n.tension,.5),n.radiusScale=I(n.radiusScale,5),n.smoothSheet=!1,this.smooth=I(n.smooth,2),super.init(n)}getSpline(e){var n=new gu(e);return new qo(e,this.getSplineParams({directional:!1,positionIterator:n.getCenterIterator(this.smooth)}))}}Xt.add("rope",oE);class aE extends Cn{constructor(e,n,i){super(e,n,i),this.type="spacefill",this.parameters=Object.assign({sphereDetail:!0,disableImpostor:!0},this.parameters),this.init(i)}init(e){var n=e||{};n.useInteriorColor=I(n.useInteriorColor,!0),super.init(n)}createData(e){return{bufferList:[new Jr(e.getAtomData(this.getAtomParams()),this.getBufferParams({sphereDetail:this.sphereDetail,dullInterior:!0,disableImpostor:this.disableImpostor}))]}}updateData(e,n){var i=n.sview.getAtomData(this.getAtomParams(e)),r={};e&&!e.position||Object.assign(r,{position:i.position}),e&&!e.color||Object.assign(r,{color:i.color}),e&&!e.radius||Object.assign(r,{radius:i.radius}),n.bufferList[0].setAttributes(r)}}function $1(t){return 3*(t.position.length/3-1)*2}Xt.add("spacefill",aE);class cE extends Wi{constructor(e,n={}){super({position:new Float32Array($1(e)),color:new Float32Array($1(e))},n),this.isLine=!0,this.vertexShader="Line.vert",this.fragmentShader="Line.frag",this.setAttributes(e)}setAttributes(e){let n,i,r,s;const o=this.geometry.attributes;if(e.position&&(n=e.position,r=o.position.array,o.position.needsUpdate=!0),e.color&&(i=e.color,s=o.color.array,o.color.needsUpdate=!0),!n&&!i)return void fe.warn("TraceBuffer.prototype.setAttributes no data");let a,c;const l=this.size-1;for(let h=0;h<l;++h)a=3*h,c=3*h*2,n&&(r[c]=n[a],r[c+1]=n[a+1],r[c+2]=n[a+2],r[c+3]=n[a+3],r[c+4]=n[a+4],r[c+5]=n[a+5]),i&&(s[c]=i[a],s[c+1]=i[a+1],s[c+2]=i[a+2],s[c+3]=i[a+3],s[c+4]=i[a+4],s[c+5]=i[a+5])}}class lE extends Cn{constructor(e,n,i){super(e,n,i),this.type="trace",this.parameters=Object.assign({subdiv:{type:"integer",max:50,min:1,rebuild:!0},tension:{type:"number",precision:1,max:1,min:.1},smoothSheet:{type:"boolean",rebuild:!0}},this.parameters,{flatShaded:null,side:null,wireframe:null}),this.init(i)}init(e){var n=e||{};n.colorScheme=I(n.colorScheme,"chainname"),n.colorScale=I(n.colorScale,"RdYlBu"),n.quality==="low"?this.subdiv=3:n.quality==="medium"?this.subdiv=6:n.quality==="high"?this.subdiv=12:this.subdiv=I(n.subdiv,6),this.tension=I(n.tension,NaN),this.smoothSheet=I(n.smoothSheet,!1),super.init(n)}getSplineParams(e){return Object.assign({subdiv:this.subdiv,tension:this.tension,directional:!1,smoothSheet:this.smoothSheet},e)}getAtomRadius(e){return e.isTrace()?.1:0}createData(e){var n=[],i=[];return this.structure.eachPolymer(r=>{if(!(r.residueCount<4)){i.push(r);var s=new qo(r,this.getSplineParams()),o=s.getSubdividedPosition(),a=s.getSubdividedColor(this.getColorParams());n.push(new cE(Object.assign({},o,a),this.getBufferParams()))}},e.getSelection()),{bufferList:n,polymerList:i}}updateData(e,n){e=e||{};var i=0,r=n.polymerList.length;for(i=0;i<r;++i){var s={},o=new qo(n.polymerList[i],this.getSplineParams());if(e.position){var a=o.getSubdividedPosition();Object.assign(s,{position:a.position})}if(e.color){var c=o.getSubdividedColor(this.getColorParams());Object.assign(s,{color:c.color})}n.bufferList[i].setAttributes(s)}}setParameters(e){var n={};return e&&e.tension&&Object.assign(n,{position:!0}),super.setParameters(e,n,!1),this}}Xt.add("trace",lE);class hE extends Im{constructor(e,n,i){super(e,n,i),this.type="tube",this.parameters=Object.assign({},this.parameters,{aspectRatio:null})}init(e){var n=e||{};n.aspectRatio=1,n.radiusScale=I(n.radiusScale,2),n.quality==="low"&&(this.radialSegments=5),super.init(n)}getSplineParams(){return super.getSplineParams({directional:!1})}}Xt.add("tube",hE);class uE extends Cn{constructor(e,n,i){super(e,n,i),this.type="unitcell",this.parameters=Object.assign({radiusSize:{type:"number",precision:3,max:10,min:.001},sphereDetail:!0,radialSegments:!0,disableImpostor:!0},this.parameters,{assembly:null}),this.init(i)}init(e){const n=e||{};let i=.5;this.structure.unitcell&&(i=Math.cbrt(this.structure.unitcell.volume)/200),n.radiusSize=I(n.radiusSize,i),n.colorValue=I(n.colorValue,"orange"),n.useInteriorColor=I(n.useInteriorColor,!0),super.init(n)}getUnitcellData(e){return e.unitcell.getData(e)}create(){const e=this.structureView.getStructure();if(!e.unitcell)return;const n=this.getUnitcellData(e);this.sphereBuffer=new Jr(n.vertex,this.getBufferParams({sphereDetail:this.sphereDetail,disableImpostor:this.disableImpostor,dullInterior:!0})),this.cylinderBuffer=new vr(n.edge,this.getBufferParams({openEnded:!0,radialSegments:this.radialSegments,disableImpostor:this.disableImpostor,dullInterior:!0})),this.dataList.push({sview:this.structureView,bufferList:[this.sphereBuffer,this.cylinderBuffer]})}createData(e){}updateData(e,n){const i=n.sview.getStructure();if(!i.unitcell)return;const r=this.getUnitcellData(i),s={},o={};e&&!e.position||(Object.assign(s,{position:r.vertex.position}),Object.assign(o,{position1:r.edge.position1,position2:r.edge.position2})),e&&!e.color||(Object.assign(s,{color:r.vertex.color}),Object.assign(o,{color:r.edge.color,color2:r.edge.color2})),e&&!e.radius||(Object.assign(s,{radius:r.vertex.radius}),Object.assign(o,{radius:r.edge.radius})),this.sphereBuffer.setAttributes(s),this.cylinderBuffer.setAttributes(o)}}Xt.add("unitcell",uE);class dE extends Cn{constructor(e,n,i){super(e,n,i),this.type="validation",this.parameters=Object.assign({},this.parameters,{radiusType:null,radiusSize:null,radiusScale:null}),this.init(i)}init(e){const n=e||{};n.colorValue=I(n.colorValue,"#f0027f"),n.useInteriorColor=I(n.useInteriorColor,!0),super.init(n)}createData(e){if(!e.validation)return;const n=e.validation.getClashData({structure:e,color:this.colorValue});return{bufferList:[new vr(n,this.getBufferParams({openEnded:!1}))]}}}Xt.add("validation",dE);const W1=new T,rf=new T,sf=new T,fE=new T(0,1,0),pE=Object.assign({radialSegments:60,openEnded:!1},Bn);class Lb extends Kr{constructor(e,n={}){super({position:new Float32Array(e.position1.length),color:e.color,picking:e.picking},n,function(i={}){const r=new Cc(1,1,I(i.radialSegments,60),1,I(i.openEnded,!1));return r.applyMatrix4(new Ie().makeRotationX(-Math.PI/2)),r}(n)),this.updateNormals=!0,this._position=new Float32Array(e.position1.length),this.setAttributes(e,!0)}get defaultParameters(){return pE}applyPositionTransform(e,n,i){rf.fromArray(this._position1,i),sf.fromArray(this._position2,i),e.lookAt(rf,sf,fE);const r=this._radius[n];W1.set(r,r,rf.distanceTo(sf)),e.scale(W1)}setAttributes(e={},n){e.position1&&e.position2&&(Fi(e.position1,e.position2,this._position),this._position1=e.position1,this._position2=e.position2,e.position=this._position),e.radius&&(this._radius=e.radius),super.setAttributes(e,n)}}Qn.add("cone",Lb);class mE{constructor(e=[]){this.geometryList=e}computeBoundingBox(){this.boundingBox?this.boundingBox.empty():this.boundingBox=new Ut,this.geometryList.forEach(e=>{e.boundingBox||e.computeBoundingBox(),this.boundingBox.union(e.boundingBox)})}}const gE=Object.assign({aspectRatio:1.5,radialSegments:50,openEnded:!1,disableImpostor:!1},Bn);class yE{constructor(e,n={}){this.group=new Ot,this.wireframeGroup=new Ot,this.pickingGroup=new Ot,this.visible=!0,this.parameters=Kn(n,this.defaultParameters),this.splitPosition=new Float32Array(e.position1.length),this.cylinderRadius=new Float32Array(e.radius.length);const i=this.makeAttributes(e),r={radialSegments:this.parameters.radialSegments,openEnded:this.parameters.openEnded,disableImpostor:this.parameters.disableImpostor};this.cylinderBuffer=new vr(i.cylinder,r),this.coneBuffer=new Lb(i.cone,r),this.geometry=new mE([this.cylinderBuffer.geometry,this.coneBuffer.geometry]),this.matrix=I(n.matrix,new Ie),this.picking=e.picking}get defaultParameters(){return gE}set matrix(e){Wi.prototype.setMatrix.call(this,e)}get matrix(){return this.group.matrix.clone()}get pickable(){return!!this.picking}makeAttributes(e={}){const n=this.splitPosition,i=this.cylinderRadius,r=this.parameters.aspectRatio;let s,o;const a={},c={};if(e.radius){for(s=0,o=i.length;s<o;++s)i[s]=e.radius[s]/r;a.radius=i,c.radius=e.radius}if(e.position1&&e.position2){const l=new T,h=new T,u=new T,f=new T;for(s=0,o=n.length;s<o;s+=3){l.fromArray(e.position1,s),h.fromArray(e.position2,s),u.subVectors(l,h);const d=u.length(),p=i[s/3]*r*2,y=Math.min(d,p);u.setLength(y),f.copy(h).add(u),f.toArray(n,s)}a.position1=e.position1,a.position2=n,c.position1=n,c.position2=e.position2}return e.color&&(a.color=e.color,a.color2=e.color,c.color=e.color),{cylinder:a,cone:c}}getMesh(){return new Ot().add(this.cylinderBuffer.getMesh(),this.coneBuffer.getMesh())}getWireframeMesh(){return new Ot().add(this.cylinderBuffer.getWireframeMesh(),this.coneBuffer.getWireframeMesh())}getPickingMesh(){return new Ot().add(this.cylinderBuffer.getPickingMesh(),this.coneBuffer.getPickingMesh())}setAttributes(e={}){const n=this.makeAttributes(e);this.cylinderBuffer.setAttributes(n.cylinder),this.coneBuffer.setAttributes(n.cone)}setParameters(e={}){(e=Object.assign({},e))&&e.matrix!==void 0&&(this.matrix=e.matrix),delete e.matrix,e&&e.wireframe!==void 0&&(this.parameters.wireframe=e.wireframe,this.setVisibility(this.visible)),this.cylinderBuffer.setParameters(e),this.coneBuffer.setParameters(e)}setVisibility(e){Wi.prototype.setVisibility.call(this,e)}dispose(){this.cylinderBuffer.dispose(),this.coneBuffer.dispose()}}Qn.add("arrow",yE);const j1=new T,of=new T,af=new T,xE=new T(0,0,0);class bE extends Kr{constructor(e,n={}){super(e,n,new Yc(1,1,1)),this.updateNormals=!0,this.setAttributes(e,!0)}applyPositionTransform(e,n,i){of.fromArray(this._heightAxis,i),af.fromArray(this._depthAxis,i),e.lookAt(xE,of,af),j1.set(this._size[n],af.length(),of.length()),e.scale(j1)}setAttributes(e={},n){e.size&&(this._size=e.size),e.heightAxis&&(this._heightAxis=e.heightAxis),e.depthAxis&&(this._depthAxis=e.depthAxis),super.setAttributes(e,n)}}Qn.add("box",bE);const q1=new T,cf=new T,lf=new T,vE=new T(0,0,0),_E=Object.assign({sphereDetail:2},Bn);class wE extends Kr{constructor(e,n={}){super(e,n,new Ms(1,I(n.sphereDetail,2))),this.updateNormals=!0,this.setAttributes(e,!0)}get defaultParameters(){return _E}applyPositionTransform(e,n,i){cf.fromArray(this._majorAxis,i),lf.fromArray(this._minorAxis,i),e.lookAt(vE,cf,lf),q1.set(this._radius[n],lf.length(),cf.length()),e.scale(q1)}setAttributes(e={},n){e.radius&&(this._radius=e.radius),e.majorAxis&&(this._majorAxis=e.majorAxis),e.minorAxis&&(this._minorAxis=e.minorAxis),super.setAttributes(e,n)}}Qn.add("ellipsoid",wE);const X1=new T,hf=new T,uf=new T,SE=new T(0,0,0);class ME extends Kr{constructor(e,n={}){super(e,n,new Ss(1,0)),this.updateNormals=!0,this.setAttributes(e,!0)}applyPositionTransform(e,n,i){hf.fromArray(this._heightAxis,i),uf.fromArray(this._depthAxis,i),e.lookAt(SE,hf,uf),X1.set(this._size[n],uf.length(),hf.length()),e.scale(X1)}setAttributes(e={},n){e.size&&(this._size=e.size),e.heightAxis&&(this._heightAxis=e.heightAxis),e.depthAxis&&(this._depthAxis=e.depthAxis),super.setAttributes(e,n)}}Qn.add("octahedron",ME);const Y1=new T,df=new T,ff=new T,AE=new T(0,0,0);class CE extends Kr{constructor(e,n={}){super(e,n,new To(1,0)),this.updateNormals=!0,this.setAttributes(e,!0)}applyPositionTransform(e,n,i){df.fromArray(this._heightAxis,i),ff.fromArray(this._depthAxis,i),e.lookAt(AE,df,ff),Y1.set(this._size[n],ff.length(),df.length()),e.scale(Y1)}setAttributes(e={},n){e.size&&(this._size=e.size),e.heightAxis&&(this._heightAxis=e.heightAxis),e.depthAxis&&(this._depthAxis=e.depthAxis),super.setAttributes(e,n)}}Qn.add("tetrahedron",CE);const Z1=new T,K1=new T,J1=new T,TE=new T(0,0,0),PE=Object.assign({radiusRatio:.2,radialSegments:16,tubularSegments:32},Bn);class EE extends Kr{constructor(e,n={}){super(e,n,new Eo(1,I(n.radiusRatio,.2),I(n.radialSegments,16),I(n.tubularSegments,32))),this.updateNormals=!0,this.setAttributes(e,!0)}get defaultParameters(){return PE}applyPositionTransform(e,n,i){K1.fromArray(this._majorAxis,i),J1.fromArray(this._minorAxis,i),e.lookAt(TE,K1,J1);const r=this._radius[n];Z1.set(r,r,r),e.scale(Z1)}setAttributes(e={},n){e.radius&&(this._radius=e.radius),e.majorAxis&&(this._majorAxis=e.majorAxis),e.minorAxis&&(this._minorAxis=e.minorAxis),super.setAttributes(e,n)}}Qn.add("torus",EE);class wi{constructor(e,n){var i=n||{};this.streamer=e,this.name=I(i.name,""),this.path=I(i.path,"")}get type(){return""}get __objName(){return""}get isBinary(){return!1}get isJson(){return!1}get isXml(){return!1}parse(){return this.streamer.read().then(()=>(this._beforeParse(),this._parse(),this._afterParse(),this[this.__objName]))}_parse(){}_beforeParse(){}_afterParse(){Ce&&fe.log(this[this.__objName])}}class _r extends wi{constructor(e,n){var i=n||{};super(e,i),this.firstModelOnly=I(i.firstModelOnly,!1),this.asTrajectory=I(i.asTrajectory,!1),this.cAlphaOnly=I(i.cAlphaOnly,!1),this.structure=new Bi(this.name,this.path),this.structureBuilder=new aT(this.structure)}get type(){return"structure"}get __objName(){return"structure"}}class bu{constructor(e,n,i="",r,s=[]){this.structure=e,this.index=n,this.description=i,this.entityType=function(o){switch(o=o.toLowerCase()){case"polymer":return 1;case"non-polymer":return 2;case"macrolide":return 3;case"water":return 4;default:return 0}}(r||""),this.chainIndexList=s,s.forEach(function(o){e.chainStore.entityIndex[o]=n})}get type(){return function(e){switch(e){case 1:return"polymer";case 2:return"non-polymer";case 3:return"macrolide";case 4:return"water";default:return}}(this.entityType)}getEntityType(){return this.entityType}isPolymer(){return this.entityType===1}isNonPolymer(){return this.entityType===2}isMacrolide(){return this.entityType===3}isWater(){return this.entityType===4}eachChain(e){const n=this.structure.getChainProxy();this.chainIndexList.forEach(function(i){n.index=i,e(n)})}}const IE={a:1,b:1,c:1,alpha:90,beta:90,gamma:90,spacegroup:"P 1"};class vu{constructor(e=IE){this.cartToFrac=new Ie,this.fracToCart=new Ie,this.a=e.a,this.b=e.b,this.c=e.c,this.alpha=e.alpha,this.beta=e.beta,this.gamma=e.gamma,this.spacegroup=e.spacegroup;const n=rn(this.alpha),i=rn(this.beta),r=rn(this.gamma),s=Math.cos(n),o=Math.cos(i),a=Math.cos(r),c=Math.sin(i),l=Math.sin(r);if(this.volume=this.a*this.b*this.c*Math.sqrt(1-s*s-o*o-a*a+2*s*o*a),e.cartToFrac===void 0){const h=this.a*this.b*l/this.volume,u=(o*a-s)/(c*l);this.fracToCart.set(this.a,0,0,0,this.b*a,this.b*l,0,0,this.c*o,-this.c*c*u,1/h,0,0,0,0,1).transpose(),this.cartToFrac.getInverse(this.fracToCart)}else this.cartToFrac.copy(e.cartToFrac),this.fracToCart.getInverse(this.cartToFrac)}getPosition(e){const n=new Float32Array(24);if(e.unitcell){const i=e.unitcell,r=e.center.clone().applyMatrix4(i.cartToFrac).floor(),s=new T;let o=0;const a=function(c,l,h){s.set(c,l,h).add(r).applyMatrix4(i.fracToCart).toArray(n,o),o+=3};a(0,0,0),a(1,0,0),a(0,1,0),a(0,0,1),a(1,1,0),a(1,0,1),a(0,1,1),a(1,1,1)}return n}getCenter(e){return function(n,i=new T){const r=n.length;for(let s=0;s<r;s+=3)i.x+=n[s],i.y+=n[s+1],i.z+=n[s+2];return i.divideScalar(r/3),i}(this.getPosition(e))}getData(e,n={}){const i=I(n.colorValue,"orange"),r=I(n.radius,Math.cbrt(this.volume)/200),s=new ke(i),o=new T,a=this.getPosition(e),c=Bt(8,s.r,s.g,s.b),l=Jn(8,r),h=new Float32Array(36),u=new Float32Array(36),f=Bt(12,s.r,s.g,s.b),d=Jn(12,r);let p=0;function y(m,x){o.fromArray(a,3*m).toArray(h,p),o.fromArray(a,3*x).toArray(u,p),p+=3}y(0,1),y(0,2),y(0,3),y(1,4),y(1,5),y(2,6),y(3,5),y(4,7),y(5,7),y(2,4),y(7,6),y(3,6);const g=new RC(this,e);return{vertex:{position:a,color:c,radius:l,picking:g},edge:{position1:h,position2:u,color:f,color2:f,radius:d,picking:g}}}}const _u={1:"h",2:"h",3:"i",4:"h",5:"g",6:"h",7:"h",8:"h",9:"h",10:"h",0:"h"},LE=["DAL","DAR","DSG","DAS","DCY","DGL","DGN","DHI","DIL","DLE","DLY","MED","DPN","DPR","DSN","DTH","DTR","DTY","DVA","DNE"],RE=["MOL_ID","MOLECULE","CHAIN","FRAGMENT","SYNONYM","EC","ENGINEERED","MUTATION","OTHER_DETAILS"],Q1=/\s+/;function ey(t,e,n){let i=`${t}`;return e&&(i+=`:${e}`),n&&(i+=`^${n}`),i}class ic extends _r{constructor(e,n){const i=n||{};super(e,i),this.hex=I(i.hex,!1),this.inferBonds=I(i.inferBonds,"all")}get type(){return"pdb"}_parse(){Ce&&fe.time("PdbParser._parse "+this.name);let e=!1;const n=this.streamer.peekLines(1)[0],i=n.substr(62,4),r=n.substr(72,4);i===r&&r.trim()&&(e=!0);const s=this.type==="pqr",o=this.type==="pdbqt",a=this.structure,c=this.structureBuilder,l=this.hex;let h=10,u=10;const f=this.firstModelOnly,d=this.asTrajectory,p=this.cAlphaOnly,y=a.frames,g=a.boxes;let m,x,v=!1;const b=a.biomolDict;let _,C,w,S,M,B,L,U,E,O,k,ne,Y,F,te,ee,j,Z,ce,de,oe,V,re={};const q={},J={},W=[];let H,se;const $={},he={},me={};let le,D,N,pe,ue,X,ye;const _e={};let xe;const Se={helices:[],sheets:[]},Me=Se.helices,Oe=Se.sheets,Ne=a.atomMap,we=a.atomStore;we.resize(Math.round(this.streamer.data.length/80)),(s||o)&&we.addField("partialCharge",1,"float32"),s&&we.addField("radius",1,"float32");const Fe=a.getAtomProxy(),je=a.getAtomProxy();let Be=0,tt=0,Ue=!0;this.streamer.eachChunkOfLines(function(Rt){(function(Vt,dt,xt){for(let Mt=Vt;Mt<dt;++Mt)if(S=xt[Mt],M=S.substr(0,6),M==="ATOM  "||M==="HETATM"){if(Ue&&(d?(v?(m=new Float32Array(3*we.count),y.push(m)):m=[],x=0):f||(re={}),le=1,D=le.toString(),N=!0,Ue=!1),f&&tt>0)continue;let Le,Ye,Ve,Xe,wt,K=0;if(s){if(Xe=S.split(Q1),K=Xe.length===10?1:0,ne=Xe[2],p&&ne!=="CA")continue;Le=parseFloat(Xe[6-K]),Ye=parseFloat(Xe[7-K]),Ve=parseFloat(Xe[8-K])}else{if(ne=S.substr(12,4).trim(),p&&ne!=="CA")continue;Le=parseFloat(S.substr(30,8)),Ye=parseFloat(S.substr(38,8)),Ve=parseFloat(S.substr(46,8))}if(d){const ge=3*x;if(m[ge+0]=Le,m[ge+1]=Ye,m[ge+2]=Ve,x+=1,v)continue}s?(B=parseInt(Xe[1]),wt="",Y=S[0]==="H",L=K?"":Xe[4],U=parseInt(Xe[5-K]),k="",E=Xe[3],te="",O=1):(B=parseInt(S.substr(6,5),h),l&&B===99999&&(h=16),Y=S[0]==="H",L=S[21].trim(),U=parseInt(S.substr(22,4),u),l&&U===9999&&(u=16),k=S[26].trim(),E=S.substr(17,4).trim()||"MOL",F=parseFloat(S.substr(60,6)),te=S[16].trim(),O=parseFloat(S.substr(54,6)),e||(o?(wt=S.substr(76,3).trim(),wt in W0&&(wt=W0[wt])):(wt=S.substr(76,2).trim(),L||(L=S.substr(72,4).trim())),ee=parseInt((S.substr(79,1)+S.substr(78,1)).trim()))),we.growIfFull(),we.atomTypeId[Be]=Ne.add(ne,wt),we.x[Be]=Le,we.y[Be]=Ye,we.z[Be]=Ve,we.serial[Be]=B,we.altloc[Be]=te.charCodeAt(0),we.occupancy[Be]=isNaN(O)?0:O,s?(we.partialCharge[Be]=parseFloat(Xe[9-K]),we.radius[Be]=parseFloat(Xe[10-K])):(we.bfactor[Be]=isNaN(F)?0:F,o&&(we.partialCharge[Be]=parseFloat(S.substr(70,6))),isFinite(ee)&&(we.formalCharge||we.addField("formalCharge",1,"int8"),we.formalCharge[Be]=ee));const Ae=ey(U,L,k);!Y||he[Ae]||LE.includes(E)?N||pe===L||(le+=1,D=le.toString()):pe===L&&X===E&&(mu.includes(E)||ue===U&&ye===k)||(le+=1,D=le.toString(),ue=U,X=E,ye=k),c.addAtom(tt,L,D,E,U,Y,void 0,k),re[B]=Be,Be+=1,N=!1,pe=L}else if(M==="CONECT"){const Le=re[parseInt(S.substr(6,5))],Ye=[11,16,21,26],Ve={};if(Le===void 0)continue;for(let Xe=0;Xe<4;++Xe){let wt=parseInt(S.substr(Ye[Xe],5));if(!Number.isNaN(wt)&&(wt=re[wt],wt!==void 0))if(Le<wt?(Fe.index=Le,je.index=wt):(Fe.index=wt,je.index=Le),Ve[wt]!==void 0)a.bondStore.bondOrder[Ve[wt]]+=1;else{const K=Fe.index+"|"+je.index;J[K]===void 0&&(J[K]=!0,Ve[wt]=a.bondStore.count,a.bondStore.addBond(Fe,je,1))}}}else if(M==="HELIX "){j=S[19].trim(),Z=parseInt(S.substr(21,4)),ce=S[25].trim(),de=S[31].trim(),oe=parseInt(S.substr(33,4)),V=S[37].trim();let Le=parseInt(S.substr(39,1));Le=(_u[Le]||_u[0]).charCodeAt(0),Me.push([j,Z,ce,de,oe,V,Le])}else if(M==="SHEET ")j=S[21].trim(),Z=parseInt(S.substr(22,4)),ce=S[26].trim(),de=S[32].trim(),oe=parseInt(S.substr(33,4)),V=S[37].trim(),Oe.push([j,Z,ce,de,oe,V]);else if(M==="HETNAM")$[S.substr(11,3)]=S.substr(15).trim();else if(M==="SEQRES"){const Le=S[11].trim();Le!==xe&&(_e[Le]=[],xe=Le),_e[Le].push(...S.substr(19).trim().split(Q1))}else if(M==="MODRES"){const Le=S.substr(12,3).trim(),Ye=S[16].trim(),Ve=S[22].trim(),Xe=parseInt(S.substr(18,4).trim()),wt=ey(Xe,Ye,Ve);he[wt]={resname:Le,chainname:Ye,inscode:Ve,resno:Xe}}else if(M==="COMPND"){const Le=S.substr(10,70).trim(),Ye=Le.indexOf(":"),Ve=Le.substring(0,Ye);let Xe;RE.includes(Ve)?(se=Ve,Xe=Le.substring(Ye+2)):Xe=Le,Xe=Xe.replace(/;$/,""),se==="MOL_ID"?(H={chainList:[],name:""},W.push(H)):se==="MOLECULE"?(H.name&&(H.name+=" "),H.name+=Xe):se==="CHAIN"&&Array.prototype.push.apply(H.chainList,Xe.split(/\s*,\s*/))}else if(S.startsWith("TER")){const Le=a.getChainProxy(a.chainStore.count-1);me[Le.chainname]=Le.index,le+=1,D=le.toString(),N=!0}else if(M==="REMARK"&&S.substr(7,3)==="350"){if(S.substr(11,12)==="BIOMOLECULE:"){let Le=S.substr(23).trim();/^(0|[1-9][0-9]*)$/.test(Le)&&(Le="BU"+Le),_=new Yr(Le),b[Le]=_}else if(S.substr(13,5)==="BIOMT"){const Le=S.split(/\s+/),Ye=parseInt(S[18])-1;Ye===0&&(w=new Ie,C.matrixList.push(w));const Ve=w.elements;Ve[0+Ye]=parseFloat(Le[4]),Ve[4+Ye]=parseFloat(Le[5]),Ve[8+Ye]=parseFloat(Le[6]),Ve[12+Ye]=parseFloat(Le[7])}else if(S.substr(11,30)==="APPLY THE FOLLOWING TO CHAINS:"||S.substr(11,30)==="                   AND CHAINS:"){S.substr(11,5)==="APPLY"&&(C=_.addPart());const Le=S.substr(41,30).split(",");for(let Ye=0,Ve=Le.length;Ye<Ve;++Ye){const Xe=Le[Ye].trim();Xe&&C.chainList.push(Xe)}}}else if(M==="HEADER")a.id=S.substr(62,4);else if(M==="TITLE ")a.title+=(a.title?" ":"")+S.substr(10,70).trim();else if(M==="MODEL ")Ue=!0;else if(M==="ENDMDL"||S.trim()==="END"){if(Ue)continue;d&&!v&&(y.push(new Float32Array(m)),v=!0),tt+=1,Ue=!0}else if(S.substr(0,5)==="MTRIX"){if(S[59]==="1")continue;if(!_||_.name!=="NCS"){const Xe="NCS";_=new Yr(Xe),b[Xe]=_,C=_.addPart()}const Le=S.split(/\s+/),Ye=parseInt(S[5])-1;Ye===0&&(w=new Ie,C.matrixList.push(w));const Ve=w.elements;Ve[0+Ye]=parseFloat(Le[2]),Ve[4+Ye]=parseFloat(Le[3]),Ve[8+Ye]=parseFloat(Le[4]),Ve[12+Ye]=parseFloat(Le[5])}else if(S.substr(0,5)==="ORIGX"){q.origx||(q.origx=new Ie);const Le=S.split(/\s+/),Ye=parseInt(S[5])-1,Ve=q.origx.elements;Ve[0+Ye]=parseFloat(Le[1]),Ve[4+Ye]=parseFloat(Le[2]),Ve[8+Ye]=parseFloat(Le[3]),Ve[12+Ye]=parseFloat(Le[4])}else if(S.substr(0,5)==="SCALE"){q.scale||(q.scale=new Ie);const Le=S.split(/\s+/),Ye=parseInt(S[5])-1,Ve=q.scale.elements;Ve[0+Ye]=parseFloat(Le[1]),Ve[4+Ye]=parseFloat(Le[2]),Ve[8+Ye]=parseFloat(Le[3]),Ve[12+Ye]=parseFloat(Le[4])}else if(M==="CRYST1"){const Le=parseFloat(S.substr(6,9)),Ye=parseFloat(S.substr(15,9)),Ve=parseFloat(S.substr(24,9)),Xe=parseFloat(S.substr(33,7)),wt=parseFloat(S.substr(40,7)),K=parseFloat(S.substr(47,7)),Ae=S.substr(55,11).trim(),ge=new Float32Array(9);ge[0]=Le,ge[4]=Ye,ge[8]=Ve,g.push(ge),tt===0&&(q.a=Le,q.b=Ye,q.c=Ve,q.alpha=Xe,q.beta=wt,q.gamma=K,q.spacegroup=Ae)}})(0,Rt.length,Rt)}),c.finalize();const yt=W.length;if(yt){a.eachChain(function(xt){xt.entityIndex=yt}),W.forEach(function(xt,Mt){const Le=xt.chainList.map(function(Ye){return me[Ye]});a.entityList.push(new bu(a,Mt,xt.name,"polymer",Le))});let Rt=W.length;const Vt=a.getResidueProxy(),dt={};a.eachChain(function(xt){xt.entityIndex===yt&&(Vt.index=xt.residueOffset,dt[Vt.resname]||(dt[Vt.resname]=[]),dt[Vt.resname].push(xt.index))}),Object.keys(dt).forEach(function(xt){const Mt=dt[xt];let Le="non-polymer",Ye=$[xt]||xt;mu.includes(xt)&&(Ye="water",Le="water"),a.entityList.push(new bu(a,Rt,Ye,Le,Mt)),Rt+=1})}q.a!==void 0?a.unitcell=new vu(q):a.unitcell=void 0,(Me.length||Oe.length)&&pb(a,Se),a.finalizeAtoms(),e||Uu(a),yu(a,this.inferBonds),a.finalizeBonds(),Me.length||Oe.length||Gu(a),xu(a),Ce&&fe.timeEnd("PdbParser._parse "+this.name)}}it.add("pdb",ic),it.add("pdb1",ic),it.add("ent",ic);const DE=/\s+/,ty=/'((?:(?!'\s).)*)'|"((?:(?!"\s).)*)"|(\S+)/g,Fa=/"/g,Na=/^['"]+|['"]+$/g,BE=/^\D{1,2}/;function ny(t){return!t||t[0]!==t[t.length-1]||t[0]!=="'"&&t[0]!=='"'?t:t.substring(1,t.length-1)}function kn(t,e){Array.isArray(t[e])||Object.keys(t).forEach(function(n){t[n]=[t[n]]})}function Wn(t){return t!=="?"}function rh(t,e){return Wn(t)?t:e}function iy(t){switch(t.toLowerCase()){case"?":case"sing":return 1;case"doub":return 2;case"trip":return 3;case"quad":return 4}return 0}class pf extends _r{get type(){return"cif"}_parse(){fe.time("CifParser._parse "+this.name);var e,n,i,r,s,o,a,c,l,h,u,f,d,p,y,g,m,x,v,b,_,C,w=this.structure,S=this.structureBuilder,M=this.firstModelOnly,B=this.asTrajectory,L=this.cAlphaOnly,U=w.frames,E={},O={},k={},ne=!1,Y=null,F=!1,te=!1,ee=!1,j=[],Z=null,ce=null,de=null,oe=null,V=[],re=w.atomMap,q=w.atomStore;q.resize(this.streamer.data.length/100);var J,W=0,H=0;if(this.streamer.eachChunkOfLines(function($){(function(he,me,le){for(var D=he;D<me;++D)if(i=le[D],((r=i.trim())||ne||te)&&r[0]!=="#")if(r.substring(0,5)==="data_")E.data=r.substring(5).trim();else if(r[0]===";")ne?(te?(Z===j.length&&(Z=0),j[Z].push(Y),Z+=1):de===!1?E[ce]=Y:E[ce][de]=Y,ne=!1,Y=null):(ne=!0,Y=r.substring(1));else if(r==="loop_")te=!0,ee=!0,j.length=0,V.length=0,Z=0;else if(r[0]==="_"){var N,pe,ue;if(te&&!ee&&(te=!1),te)pe=(N=r.split("."))[0].substring(1),ue=N[1],N.length===1?(ue=!1,E[pe]||(E[pe]=[]),j.push(E[pe])):(E[pe]||(E[pe]={}),E[pe][ue]?Ce&&fe.warn(pe,ue,"already exists"):(E[pe][ue]=[],j.push(E[pe][ue]),V.push(ue))),ce=pe,de=ue,oe=!0;else{var X=r.match(ty),ye=X[0],_e=X[1];pe=(N=ye.split("."))[0].substring(1),ue=N[1],N.length===1?(ue=!1,E[pe]=_e):(E[pe]||(E[pe]={}),E[pe][ue]?Ce&&fe.warn(pe,ue,"already exists"):E[pe][ue]=_e),_e||(F=!0),ce=pe,de=ue}}else if(ne)Y+=i;else if(te){if(!r)continue;if(ce==="atom_site"){const xe=r.split(DE);oe&&(s=V.indexOf("auth_asym_id"),o=V.indexOf("auth_seq_id"),a=V.indexOf("label_seq_id"),c=V.indexOf("label_atom_id"),l=V.indexOf("label_comp_id"),h=V.indexOf("label_asym_id"),u=V.indexOf("label_entity_id"),f=V.indexOf("label_alt_id"),x=V.indexOf("Cartn_x"),v=V.indexOf("Cartn_y"),b=V.indexOf("Cartn_z"),p=V.indexOf("id"),y=V.indexOf("type_symbol"),d=V.indexOf("group_PDB"),_=V.indexOf("B_iso_or_equiv"),g=V.indexOf("pdbx_PDB_model_num"),m=V.indexOf("pdbx_PDB_ins_code"),C=V.indexOf("occupancy"),oe=!1,J=parseInt(xe[g]),B&&(e=[],n=0));const Se=parseInt(xe[g]);if(J!==Se&&(B&&(H===0&&U.push(new Float32Array(e)),e=new Float32Array(3*q.count),U.push(e),n=0),H+=1),J=Se,M&&H>0)continue;const Me=xe[c].replace(Fa,"");if(L&&Me!=="CA")continue;const Oe=parseFloat(xe[x]),Ne=parseFloat(xe[v]),we=parseFloat(xe[b]);if(B){const Le=3*n;if(e[Le+0]=Oe,e[Le+1]=Ne,e[Le+2]=we,n+=1,H>0)continue}const Fe=xe[l],je=parseInt(xe[o!==-1?o:a]);let Be=xe[m];Be=Be==="?"?"":Be;const tt=xe[s],Ue=xe[h],yt=xe[d][0]==="H",Rt=xe[y],Vt=parseFloat(xe[_]),dt=parseFloat(xe[C]);let xt=xe[f];if(xt=xt==="."?"":xt,q.growIfFull(),q.atomTypeId[W]=re.add(Me,Rt),q.x[W]=Oe,q.y[W]=Ne,q.z[W]=we,q.serial[W]=parseInt(xe[p]),q.bfactor[W]=isNaN(Vt)?0:Vt,q.occupancy[W]=isNaN(dt)?0:dt,q.altloc[W]=xt.charCodeAt(0),S.addAtom(H,tt,Ue,Fe,je,yt,void 0,Be),Ce){const Le=O[Ue];Le!==void 0&&Le!==tt&&Ce&&fe.warn(Le,tt)}O[Ue]=tt;const Mt=xe[u];k[Mt]||(k[Mt]=new Set),k[Mt].add(w.chainStore.count-1),W+=1}else{const xe=r.match(ty),Se=xe.length;Z===j.length&&(Z=0);for(let Me=0;Me<Se;++Me)j[Z+Me].push(xe[Me]);Z+=Se}ee=!1}else if(r[0]==="'"&&r[r.length-1]==="'"){const xe=r.substring(1,r.length-1);de===!1?E[ce]=xe:E[ce][de]=xe}else F?de===!1?E[ce]=r:E[ce][de]=r:Ce&&fe.log("CifParser._parse: unknown state",r);else ne=!1,te=!1,F=!1,j.length=0,Z=null,ce=null,de=null,oe=null,V.length=0})(0,$.length,$)}),E.chem_comp&&E.chem_comp_atom&&!E.struct)(function($,he,me){const le=he.atomStore,D=he.atomMap;let N,pe;const ue=$.chem_comp,X=$.chem_comp_atom,ye=$.chem_comp_bond;ue&&(ue.name&&(he.title=ue.name.trim().replace(Na,"")),ue.id&&(he.id=ue.id.trim().replace(Na,"")));var _e={};if(X){var xe,Se,Me,Oe;for(kn(X,"comp_id"),pe=X.comp_id.length,N=0;N<pe;++N)le.growIfFull(),xe=X.atom_id[N].replace(Fa,""),Se=X.type_symbol[N],_e[xe]=N,le.atomTypeId[N]=D.add(xe,Se),le.x[N]=X.model_Cartn_x[N],le.y[N]=X.model_Cartn_y[N],le.z[N]=X.model_Cartn_z[N],le.serial[N]=N,Me=X.pdbx_component_comp_id[N],Oe=X.pdbx_residue_numbering?X.pdbx_residue_numbering[N]:1,me.addAtom(0,"","",Me,Oe,!0);for(N=0;N<pe;++N){var Ne=N+pe;le.growIfFull(),xe=X.atom_id[N].replace(Fa,""),Se=X.type_symbol[N],le.atomTypeId[Ne]=D.add(xe,Se),le.x[Ne]=X.pdbx_model_Cartn_x_ideal[N],le.y[Ne]=X.pdbx_model_Cartn_y_ideal[N],le.z[Ne]=X.pdbx_model_Cartn_z_ideal[N],le.serial[Ne]=Ne,Me=X.pdbx_component_comp_id[N],Oe=X.pdbx_residue_numbering?X.pdbx_residue_numbering[N]:1,me.addAtom(1,"","",Me,Oe,!0)}}if(X&&ye){var we,Fe,je;kn(ye,"comp_id"),pe=ye.comp_id.length;var Be=X.comp_id.length,tt=he.getAtomProxy(),Ue=he.getAtomProxy();for(N=0;N<pe;++N)we=ye.atom_id_1[N].replace(Fa,""),Fe=ye.atom_id_2[N].replace(Fa,""),je=iy(ye.value_order[N]),tt.index=_e[we],Ue.index=_e[Fe],he.bondStore.growIfFull(),he.bondStore.addBond(tt,Ue,je),tt.index+=Be,Ue.index+=Be,he.bondStore.growIfFull(),he.bondStore.addBond(tt,Ue,je)}})(E,w,S),S.finalize(),w.finalizeAtoms(),w.finalizeBonds(),Is(w);else if(E.atom_site_type_symbol&&E.atom_site_label&&E.atom_site_fract_x)(function($,he,me){var le,D=he.atomStore,N=he.atomMap;$.data&&(he.id=$.data,he.name=$.data),he.unitcell=new vu({a:parseFloat($.cell_length_a),b:parseFloat($.cell_length_b),c:parseFloat($.cell_length_c),alpha:parseFloat($.cell_angle_alpha),beta:parseFloat($.cell_angle_beta),gamma:parseFloat($.cell_angle_gamma),spacegroup:ny($["symmetry_space_group_name_H-M"])});const pe=new T,ue=new T,X=$.atom_site_type_symbol.length,ye={};for(let we=0;we<X;++we){D.growIfFull();const Fe=$.atom_site_label[we],je=$.atom_site_type_symbol[we];let Be=ye[je];if(!Be){const tt=je.match(BE);ye[je]=Be=(le=tt==null?void 0:tt[0])!==null&&le!==void 0?le:je}D.atomTypeId[we]=N.add(Fe,Be),pe.set($.atom_site_fract_x[we],$.atom_site_fract_y[we],$.atom_site_fract_z[we]),pe.applyMatrix4(he.unitcell.fracToCart),ue.add(pe),D.x[we]=pe.x,D.y[we]=pe.y,D.z[we]=pe.z,$.atom_site_occupancy&&(D.occupancy[we]=parseFloat($.atom_site_occupancy[we])),D.serial[we]=we,me.addAtom(0,"","","HET",1,!0)}ue.divideScalar(X),he.center=ue,xu(he);const _e=new T,xe=new T,Se=he.biomolDict.SUPERCELL.partList[0].matrixList;let Me=X;function Oe(we){return N.get(D.atomTypeId[we]).covalent}const Ne=new Ie;for(let we=0;we<X;++we){const Fe=Oe(we);pe.set(D.x[we],D.y[we],D.z[we]),Se.forEach(function(je){if(!Ne.equals(je)){_e.copy(pe),_e.applyMatrix4(je);for(let Be=0;Be<X;++Be){xe.set(D.x[Be],D.y[Be],D.z[Be]);const tt=_e.distanceToSquared(xe),Ue=Oe(Be)+Fe,yt=Ue+.3,Rt=Ue-.5;if(tt<yt*yt&&tt>Rt*Rt)return D.growIfFull(),D.atomTypeId[Me]=D.atomTypeId[we],D.x[Me]=_e.x,D.y[Me]=_e.y,D.z[Me]=_e.z,D.occupancy[Me]=D.occupancy[we],D.serial[Me]=Me,D.altloc[Me]=65,me.addAtom(0,"","","HET",1,!0),void(Me+=1)}}})}})(E,w,S),S.finalize(),w.finalizeAtoms(),yu(w),w.finalizeBonds();else{var se=function($,he,me){var le,D,N,pe,ue=[],X=[],ye=$.struct_conf;if(ye!=null&&ye.pdbx_PDB_helix_class)for(kn(ye,"id"),le=0,D=ye.beg_auth_seq_id.length;le<D;++le){var _e=parseInt(ye.pdbx_PDB_helix_class[le]);Number.isNaN(_e)||(N=ye.pdbx_beg_PDB_ins_code[le],pe=ye.pdbx_end_PDB_ins_code[le],ue.push([me[ye.beg_label_asym_id[le]],parseInt(ye.beg_auth_seq_id[le]),rh(N,""),me[ye.end_label_asym_id[le]],parseInt(ye.end_auth_seq_id[le]),rh(pe,""),(_u[_e]||_u[0]).charCodeAt(0)]))}var xe=$.struct_sheet_range;if(xe)for(kn(xe,"id"),le=0,D=xe.beg_auth_seq_id.length;le<D;++le)N=xe.pdbx_beg_PDB_ins_code[le],pe=xe.pdbx_end_PDB_ins_code[le],X.push([me[xe.beg_label_asym_id[le]],parseInt(xe.beg_auth_seq_id[le]),rh(N,""),me[xe.end_label_asym_id[le]],parseInt(xe.end_auth_seq_id[le]),rh(pe,"")]);return!(!ye&&!xe)&&{helices:ue,sheets:X}}(E,0,O);if(function($,he,me){var le={},D=he.biomolDict;if($.pdbx_struct_oper_list){var N=$.pdbx_struct_oper_list;kn(N,"id"),N.id.forEach(function(je,Be){var tt=new Ie,Ue=tt.elements;Ue[0]=parseFloat(N["matrix[1][1]"][Be]),Ue[1]=parseFloat(N["matrix[1][2]"][Be]),Ue[2]=parseFloat(N["matrix[1][3]"][Be]),Ue[4]=parseFloat(N["matrix[2][1]"][Be]),Ue[5]=parseFloat(N["matrix[2][2]"][Be]),Ue[6]=parseFloat(N["matrix[2][3]"][Be]),Ue[8]=parseFloat(N["matrix[3][1]"][Be]),Ue[9]=parseFloat(N["matrix[3][2]"][Be]),Ue[10]=parseFloat(N["matrix[3][3]"][Be]),Ue[3]=parseFloat(N["vector[1]"][Be]),Ue[7]=parseFloat(N["vector[2]"][Be]),Ue[11]=parseFloat(N["vector[3]"][Be]),tt.transpose(),le[je]=tt})}if($.pdbx_struct_assembly_gen){var pe=$.pdbx_struct_assembly_gen;kn(pe,"assembly_id");var ue=function(je){var Be={};return je.replace(/[()']/g,"").split(",").forEach(function(tt){if(tt.includes("-"))for(var Ue=tt.split("-"),yt=parseInt(Ue[0]),Rt=parseInt(Ue[1]);yt<=Rt;++yt)Be[yt]=le[yt];else Be[tt]=le[tt]}),Be};pe.assembly_id.forEach(function(je,Be){var tt={},Ue=pe.oper_expression[Be].replace(/['"]\(|['"]/g,"");if(Ue.includes(")(")||Ue.indexOf("(")>0){Ue=Ue.split("(");var yt=ue(Ue[0]),Rt=ue(Ue[1]);Object.keys(yt).forEach(function(Ve){Object.keys(Rt).forEach(function(Xe){var wt=new Ie;wt.multiplyMatrices(yt[Ve],Rt[Xe]),tt[Ve+"x"+Xe]=wt})})}else tt=ue(Ue);var Vt=[];for(var dt in tt)Vt.push(tt[dt]);var xt=je;/^(0|[1-9][0-9]*)$/.test(xt)&&(xt="BU"+xt);for(var Mt=pe.asym_id_list[Be].split(","),Le=0,Ye=Mt.length;Le<Ye;++Le)Mt[Le]=me[Mt[Le]];D[xt]===void 0&&(D[xt]=new Yr(xt)),D[xt].addPart(Vt,Mt)})}if($.struct_ncs_oper){var X=$.struct_ncs_oper;kn(X,"id");var ye="NCS";D[ye]=new Yr(ye);var _e=D[ye].addPart();X.id.forEach(function(je,Be){if(X.code[Be]!=="given"){var tt=new Ie,Ue=tt.elements;Ue[0]=parseFloat(X["matrix[1][1]"][Be]),Ue[1]=parseFloat(X["matrix[1][2]"][Be]),Ue[2]=parseFloat(X["matrix[1][3]"][Be]),Ue[4]=parseFloat(X["matrix[2][1]"][Be]),Ue[5]=parseFloat(X["matrix[2][2]"][Be]),Ue[6]=parseFloat(X["matrix[2][3]"][Be]),Ue[8]=parseFloat(X["matrix[3][1]"][Be]),Ue[9]=parseFloat(X["matrix[3][2]"][Be]),Ue[10]=parseFloat(X["matrix[3][3]"][Be]),Ue[3]=parseFloat(X["vector[1]"][Be]),Ue[7]=parseFloat(X["vector[2]"][Be]),Ue[11]=parseFloat(X["vector[3]"][Be]),tt.transpose(),_e.matrixList.push(tt)}}),_e.matrixList.length===0&&delete D[ye]}const xe={};if($.cell){const je=$.cell,Be=parseFloat(je.length_a),tt=parseFloat(je.length_b),Ue=parseFloat(je.length_c),yt=new Float32Array(9);yt[0]=Be,yt[4]=tt,yt[8]=Ue,he.boxes.push(yt),xe.a=Be,xe.b=tt,xe.c=Ue,xe.alpha=parseFloat(je.angle_alpha),xe.beta=parseFloat(je.angle_beta),xe.gamma=parseFloat(je.angle_gamma)}$.symmetry&&(xe.spacegroup=ny($.symmetry["space_group_name_H-M"]));var Se=new Ie;if($.database_PDB_matrix){var Me=$.database_PDB_matrix,Oe=Se.elements;Oe[0]=parseFloat(Me["origx[1][1]"]),Oe[1]=parseFloat(Me["origx[1][2]"]),Oe[2]=parseFloat(Me["origx[1][3]"]),Oe[4]=parseFloat(Me["origx[2][1]"]),Oe[5]=parseFloat(Me["origx[2][2]"]),Oe[6]=parseFloat(Me["origx[2][3]"]),Oe[8]=parseFloat(Me["origx[3][1]"]),Oe[9]=parseFloat(Me["origx[3][2]"]),Oe[10]=parseFloat(Me["origx[3][3]"]),Oe[3]=parseFloat(Me["origx_vector[1]"]),Oe[7]=parseFloat(Me["origx_vector[2]"]),Oe[11]=parseFloat(Me["origx_vector[3]"]),Se.transpose(),xe.origx=Se}var Ne=new Ie;if($.atom_sites){var we=$.atom_sites,Fe=Ne.elements;Fe[0]=parseFloat(we["fract_transf_matrix[1][1]"]),Fe[1]=parseFloat(we["fract_transf_matrix[1][2]"]),Fe[2]=parseFloat(we["fract_transf_matrix[1][3]"]),Fe[4]=parseFloat(we["fract_transf_matrix[2][1]"]),Fe[5]=parseFloat(we["fract_transf_matrix[2][2]"]),Fe[6]=parseFloat(we["fract_transf_matrix[2][3]"]),Fe[8]=parseFloat(we["fract_transf_matrix[3][1]"]),Fe[9]=parseFloat(we["fract_transf_matrix[3][2]"]),Fe[10]=parseFloat(we["fract_transf_matrix[3][3]"]),Fe[3]=parseFloat(we["fract_transf_vector[1]"]),Fe[7]=parseFloat(we["fract_transf_vector[2]"]),Fe[11]=parseFloat(we["fract_transf_vector[3]"]),Ne.transpose(),xe.scale=Ne}xe.a!==void 0?he.unitcell=new vu(xe):he.unitcell=void 0}(E,w,O),function($,he,me){var le=$.struct_conn;if(le){kn(le,"id");for(var D=/"/g,N=he.getAtomProxy(),pe=he.getAtomProxy(),ue={},X=0,ye=le.id.length;X<ye;++X){var _e=le.conn_type_id[X];if(_e!=="hydrog"&&_e!=="mismat"&&_e!=="saltbr"&&le.ptnr1_symmetry[X]==="1_555"&&le.ptnr2_symmetry[X]==="1_555"){var xe=le.pdbx_ptnr1_PDB_ins_code[X],Se=le.pdbx_ptnr1_label_alt_id[X],Me=le.ptnr1_auth_seq_id[X]+(Wn(xe)?"^"+xe:"")+":"+me[le.ptnr1_label_asym_id[X]]+"."+le.ptnr1_label_atom_id[X].replace(D,"")+(Wn(Se)?"%"+Se:""),Oe=ue[Me];if(!Oe){var Ne=new qt(Me);if(Ne.selection.error){Ce&&fe.warn("invalid selection for connection",Me);continue}Oe=he.getAtomIndices(Ne),ue[Me]=Oe}var we=le.pdbx_ptnr2_PDB_ins_code[X],Fe=le.pdbx_ptnr2_label_alt_id[X],je=le.ptnr2_auth_seq_id[X]+(Wn(we)?"^"+we:"")+":"+me[le.ptnr2_label_asym_id[X]]+"."+le.ptnr2_label_atom_id[X].replace(D,"")+(Wn(Fe)?"%"+Fe:""),Be=ue[je];if(!Be){var tt=new qt(je);if(tt.selection.error){Ce&&fe.warn("invalid selection for connection",je);continue}Be=he.getAtomIndices(tt),ue[je]=Be}var Ue=Oe.length,yt=Be.length;if(Ue>yt){var Rt=Ue;Ue=yt,yt=Rt;var Vt=Oe;Oe=Be,Be=Vt}if(Ue!==0&&yt!==0)for(var dt=0;dt<yt;++dt)N.index=Oe[dt%Ue],pe.index=Be[dt],N&&pe?he.bondStore.addBond(N,pe,iy(le.pdbx_value_order[X])):fe.log("atoms for connection not found");else Ce&&fe.warn("no atoms found for",Me,je)}}}}(E,w,O),function($,he,me){if($.entity){kn($.entity,"id");for(var le=$.entity,D=le.id.length,N=0;N<D;++N){var pe=le.pdbx_description[N],ue=le.type[N],X=Array.from(me[le.id[N]]);he.entityList[N]=new bu(he,N,pe,ue,X)}}}(E,w,k),E.struct&&E.struct.title&&(w.title=E.struct.title.trim().replace(Na,"")),E.entry&&E.entry.id&&(w.id=E.entry.id.trim().replace(Na,"")),E.pdbx_audit_revision_history){if(E.pdbx_audit_revision_history.revision_date){kn(E.pdbx_audit_revision_history,"revision_date");const $=E.pdbx_audit_revision_history.revision_date.filter(Wn);$.length&&(w.header.releaseDate=$[0])}if(E.pdbx_database_status.recvd_initial_deposition_date){kn(E.pdbx_database_status,"recvd_initial_deposition_date");const $=E.pdbx_database_status.recvd_initial_deposition_date.filter(Wn);$.length&&(w.header.depositionDate=$[0])}}else if(E.database_PDB_rev){if(E.database_PDB_rev.date){kn(E.database_PDB_rev,"date");const $=E.database_PDB_rev.date.filter(Wn);$.length&&(w.header.releaseDate=$[0])}if(E.database_PDB_rev.date_original){kn(E.database_PDB_rev,"date_original");const $=E.database_PDB_rev.date_original.filter(Wn);$.length&&(w.header.depositionDate=$[0])}}E.reflns&&E.reflns.d_resolution_high?Wn(E.reflns.d_resolution_high)&&(w.header.resolution=parseFloat(E.reflns.d_resolution_high)):E.refine&&E.refine.ls_d_res_high&&Wn(E.refine.ls_d_res_high)&&(w.header.resolution=parseFloat(E.refine.ls_d_res_high)),E.refine&&E.refine.ls_R_factor_R_free&&Wn(E.refine.ls_R_factor_R_free)&&(w.header.rFree=parseFloat(E.refine.ls_R_factor_R_free)),E.refine&&E.refine.ls_R_factor_R_work&&Wn(E.refine.ls_R_factor_R_work)&&(w.header.rWork=parseFloat(E.refine.ls_R_factor_R_work)),E.exptl&&E.exptl.method&&(kn(E.exptl,"method"),w.header.experimentalMethods=E.exptl.method.map(function($){return $.replace(Na,"")})),S.finalize(),w.finalizeAtoms(),yu(w),w.finalizeBonds(),se?pb(w,se):Gu(w),xu(w),w.extraData.cif=E}Ce&&fe.timeEnd("CifParser._parse "+this.name)}}it.add("cif",pf),it.add("mcif",pf),it.add("mmcif",pf);it.add("gro",class extends _r{get type(){return"gro"}_parse(){Ce&&fe.time("GroParser._parse "+this.name);var t,e,n=this.structure,i=this.structureBuilder,r=this.firstModelOnly,s=this.asTrajectory,o=this.cAlphaOnly,a=n.frames,c=n.boxes,l=this.streamer.peekLines(3);n.title=l[0].trim();var h,u,f,d,p=5+(l[2].length-l[2].lastIndexOf(".")-1),y=20+p,g=20+2*p,m=parseInt(l[1]),x=m+3,v=n.atomMap,b=n.atomStore;b.resize(m);var _=0,C=0,w=0;this.streamer.eachChunkOfLines(function(S){(function(M,B,L){for(var U=M;U<B;++U){var E=++w-1,O=L[U];if(O){if(E%x==0)s&&(t=new Float32Array(3*m),a.push(t),e=0);else if(E%x!=1)if(E%x==x-1){var k=O.trim().split(/\s+/),ne=new Float32Array(9);if(ne[0]=10*parseFloat(k[0]),ne[4]=10*parseFloat(k[1]),ne[8]=10*parseFloat(k[2]),c.push(ne),r)return!0;C+=1}else{if(h=O.substr(10,5).trim(),o&&h!=="CA")continue;var Y=10*parseFloat(O.substr(20,p)),F=10*parseFloat(O.substr(y,p)),te=10*parseFloat(O.substr(g,p));if(s){var ee=3*e;if(t[ee+0]=Y,t[ee+1]=F,t[ee+2]=te,e+=1,E>x)continue}u=O.substr(5,5).trim(),f=parseInt(O.substr(0,5)),d=parseInt(O.substr(15,5)),b.growIfFull(),b.atomTypeId[_]=v.add(h),b.x[_]=Y,b.y[_]=F,b.z[_]=te,b.serial[_]=d,i.addAtom(C,"","",u,f,!1,"l"),_+=1}}}})(0,S.length,S)}),i.finalize(),n.finalizeAtoms(),Uu(n),yu(n),n.finalizeBonds(),Gu(n),Ce&&fe.timeEnd("GroParser._parse "+this.name)}});var OE=["mmtfVersion","mmtfProducer","unitCell","spaceGroup","structureId","title","depositionDate","releaseDate","experimentalMethods","resolution","rFree","rWork","bioAssemblyList","ncsOperatorList","entityList","groupList","numBonds","numAtoms","numGroups","numChains","numModels","groupsPerChain","chainsPerModel"].concat(["xCoordList","yCoordList","zCoordList","groupIdList","groupTypeList","chainIdList","bFactorList","atomIdList","altLocList","occupancyList","secStructList","insCodeList","sequenceIndexList","chainNameList","bondAtomList","bondOrderList"]);function nl(t,e,n){return e?new t(e.buffer,e.byteOffset,e.byteLength/(n||1)):void 0}function Np(t){return nl(DataView,t)}function mf(t){return nl(Int8Array,t)}function wu(t){return nl(Int32Array,t,4)}function za(t,e){var n=t.length/2;e||(e=new Int16Array(n));for(var i=0,r=0;i<n;++i,r+=2)e[i]=t[r]<<8^t[r+1]<<0;return e}function Ei(t,e){var n=t.length/4;e||(e=new Int32Array(n));for(var i=0,r=0;i<n;++i,r+=4)e[i]=t[r]<<24^t[r+1]<<16^t[r+2]<<8^t[r+3]<<0;return e}function Su(t,e,n){var i=t.length,r=1/e;n||(n=new Float32Array(i));for(var s=0;s<i;++s)n[s]=t[s]*r;return n}function sh(t,e){var n,i;if(!e){var r=0;for(n=0,i=t.length;n<i;n+=2)r+=t[n+1];e=new t.constructor(r)}var s=0;for(n=0,i=t.length;n<i;n+=2)for(var o=t[n],a=t[n+1],c=0;c<a;++c)e[s]=o,++s;return e}function Rb(t,e){var n=t.length;e||(e=new t.constructor(n)),n&&(e[0]=t[0]);for(var i=1;i<n;++i)e[i]=t[i]+e[i-1];return e}function Mu(t,e){var n,i,r=t instanceof Int8Array?127:32767,s=-r-1,o=t.length;if(!e){var a=0;for(n=0;n<o;++n)t[n]<r&&t[n]>s&&++a;e=new Int32Array(a)}for(n=0,i=0;n<o;){for(var c=0;t[n]===r||t[n]===s;)c+=t[n],++n;c+=t[n],++n,e[i]=c,++i}return e}function ry(t,e,n){return Su(Mu(t,wu(n)),e,n)}function kE(t,e,n){var i=Mu(t,wu(n));return function(r,s,o){return Su(Rb(r,wu(o)),s,o)}(i,e,nl(Float32Array,i,4))}function Db(t){var e=0,n=new DataView(t.buffer);function i(c){for(var l={},h=0;h<c;h++)l[a()]=a();return l}function r(c){var l=t.subarray(e,e+c);return e+=c,l}function s(c){var l=t.subarray(e,e+c);e+=c;var h=65535;if(c>h){for(var u=[],f=0;f<l.length;f+=h)u.push(String.fromCharCode.apply(null,l.subarray(f,f+h)));return u.join("")}return String.fromCharCode.apply(null,l)}function o(c){for(var l=new Array(c),h=0;h<c;h++)l[h]=a();return l}function a(){var c,l,h=t[e];if(!(128&h))return e++,h;if((240&h)==128)return e++,i(l=15&h);if((240&h)==144)return e++,o(l=15&h);if((224&h)==160)return e++,s(l=31&h);if((224&h)==224)return c=n.getInt8(e),e++,c;switch(h){case 192:return e++,null;case 194:return e++,!1;case 195:return e++,!0;case 196:return l=n.getUint8(e+1),e+=2,r(l);case 197:return l=n.getUint16(e+1),e+=3,r(l);case 198:return l=n.getUint32(e+1),e+=5,r(l);case 202:return c=n.getFloat32(e+1),e+=5,c;case 203:return c=n.getFloat64(e+1),e+=9,c;case 204:return c=t[e+1],e+=2,c;case 205:return c=n.getUint16(e+1),e+=3,c;case 206:return c=n.getUint32(e+1),e+=5,c;case 208:return c=n.getInt8(e+1),e+=2,c;case 209:return c=n.getInt16(e+1),e+=3,c;case 210:return c=n.getInt32(e+1),e+=5,c;case 217:return l=n.getUint8(e+1),e+=2,s(l);case 218:return l=n.getUint16(e+1),e+=3,s(l);case 219:return l=n.getUint32(e+1),e+=5,s(l);case 220:return l=n.getUint16(e+1),e+=3,o(l);case 221:return l=n.getUint32(e+1),e+=5,o(l);case 222:return l=n.getUint16(e+1),e+=3,i(l);case 223:return l=n.getUint32(e+1),e+=5,i(l)}throw new Error("Unknown type 0x"+h.toString(16))}return a()}function FE(t,e,n,i){switch(t){case 1:return function(s,o){var a=s.length;o||(o=new Float32Array(a/4));for(var c=Np(o),l=Np(s),h=0,u=0,f=a/4;h<f;++h,u+=4)c.setFloat32(u,l.getFloat32(u),!0);return o}(e);case 2:return mf(e);case 3:return za(e);case 4:return Ei(e);case 5:return nl(Uint8Array,e);case 6:return sh(Ei(e),new Uint8Array(n));case 7:return sh(Ei(e));case 8:return Rb(sh(Ei(e)),r);case 9:return function(s,o,a){return Su(sh(s,wu(a)),o,a)}(Ei(e),Ei(i)[0]);case 10:return kE(za(e),Ei(i)[0]);case 11:return Su(za(e),Ei(i)[0]);case 12:return ry(za(e),Ei(i)[0]);case 13:return ry(mf(e),Ei(i)[0]);case 14:return Mu(za(e));case 15:return Mu(mf(e))}var r}function NE(t,e){var n=(e=e||{}).ignoreFields,i={};return OE.forEach(function(r){var s,o,a,c,l,h=!!n&&n.indexOf(r)!==-1,u=t[r];h||u===void 0||(u instanceof Uint8Array?i[r]=FE.apply(null,(o=Np(s=u),a=o.getInt32(0),c=o.getInt32(4),l=s.subarray(8,12),[a,s=s.subarray(12),c,l])):i[r]=u)}),i}const zE={0:105,1:115,2:104,3:101,4:103,5:98,6:116,7:108,"-1":NaN};it.add("mmtf",class extends _r{get type(){return"mmtf"}get isBinary(){return!0}_parse(){let t,e,n,i,r;Ce&&fe.time("MmtfParser._parse "+this.name);const s=this.structure,o=NE(Db(this.streamer.data));let a,c,l,h,u,f;if(["depositionDate","releaseDate","resolution","rFree","rWork","experimentalMethods"].forEach(function(F){o[F]!==void 0&&(s.header[F]=o[F])}),s.id=o.structureId,s.title=o.title,s.atomStore.addField("formalCharge",1,"int8"),this.firstModelOnly||this.asTrajectory){for(u=1,h=o.chainsPerModel[0],l=0,t=0,e=h;t<e;++t)l+=o.groupsPerChain[t];for(c=0,t=0,e=l;t<e;++t)r=o.groupList[o.groupTypeList[t]],c+=r.atomNameList.length;a=o.numBonds,f=[h]}else a=o.numBonds,c=o.numAtoms,l=o.numGroups,h=o.numChains,u=o.numModels,f=o.chainsPerModel;if(a+=l,this.asTrajectory)for(t=0,e=o.numModels;t<e;++t){const F=new Float32Array(3*c),te=c*t;for(n=0;n<c;++n){const ee=3*n,j=n+te;F[ee]=o.xCoordList[j],F[ee+1]=o.yCoordList[j],F[ee+2]=o.zCoordList[j]}s.frames.push(F)}const d=new Uint32Array(a),p=new Uint32Array(a),y=new Uint8Array(a),g=new Uint32Array(c),m=new Int8Array(c),x=new Uint32Array(l),v=new Uint32Array(l),b=new Uint16Array(l),_=new Uint16Array(h),C=new Uint32Array(h),w=new Uint32Array(h),S=new Uint32Array(u),M=new Uint32Array(u);let B=0;for(t=0,e=u;t<e;++t){const F=f[t];for(S[t]=B,M[t]=F,n=0;n<F;++n)_[n+B]=t;B+=F}const L=o.groupsPerChain;let U=0;for(t=0,e=h;t<e;++t){const F=L[t];for(C[t]=U,w[t]=F,n=0;n<F;++n)x[n+U]=t;U+=F}let E=0,O=0;for(t=0,e=l;t<e;++t){r=o.groupList[o.groupTypeList[t]];const F=r.atomNameList.length,te=r.formalChargeList,ee=r.bondAtomList,j=r.bondOrderList;for(n=0,i=j.length;n<i;++n)d[O]=E+ee[2*n],p[O]=E+ee[2*n+1],y[O]=j[n],O+=1;for(v[t]=E,b[t]=F,n=0;n<F;++n)g[E]=t,m[E]=te[n],E+=1}const k=o.bondAtomList;if(k)for(o.bondOrderList&&y.set(o.bondOrderList,O),t=0,e=k.length;t<e;t+=2){const F=k[t],te=k[t+1];F<c&&te<c&&(d[O]=F,p[O]=te,O+=1)}s.bondStore.length=y.length,s.bondStore.count=O,s.bondStore.atomIndex1=d,s.bondStore.atomIndex2=p,s.bondStore.bondOrder=y,s.atomStore.length=c,s.atomStore.count=c,s.atomStore.residueIndex=g,s.atomStore.atomTypeId=new Uint16Array(c),s.atomStore.x=o.xCoordList.subarray(0,c),s.atomStore.y=o.yCoordList.subarray(0,c),s.atomStore.z=o.zCoordList.subarray(0,c),s.atomStore.serial=o.atomIdList.subarray(0,c),s.atomStore.bfactor=o.bFactorList.subarray(0,c),s.atomStore.altloc=o.altLocList.subarray(0,c),s.atomStore.occupancy=o.occupancyList.subarray(0,c),s.atomStore.formalCharge=m,s.residueStore.length=l,s.residueStore.count=l,s.residueStore.chainIndex=x,s.residueStore.residueTypeId=o.groupTypeList,s.residueStore.atomOffset=v,s.residueStore.atomCount=b,s.residueStore.resno=o.groupIdList.subarray(0,l),s.residueStore.sstruc=o.secStructList.subarray(0,l),s.residueStore.inscode=o.insCodeList.subarray(0,l),s.chainStore.length=h,s.chainStore.count=h,s.chainStore.entityIndex=new Uint16Array(h),s.chainStore.modelIndex=_,s.chainStore.residueOffset=C,s.chainStore.residueCount=w,s.chainStore.chainname=o.chainNameList.subarray(0,4*h),s.chainStore.chainid=o.chainIdList.subarray(0,4*h),s.modelStore.length=u,s.modelStore.count=u,s.modelStore.chainOffset=S,s.modelStore.chainCount=M;let ne={};for(t=0,e=o.groupList.length;t<e;++t){const F=o.groupList[t],te=[];for(n=0,i=F.atomNameList.length;n<i;++n){const V=F.elementList[n].toUpperCase(),re=F.atomNameList[n];te.push(s.atomMap.add(re,V))}const ee=F.chemCompType.toUpperCase(),j=ZA.includes(ee),Z=F.bondOrderList.length,ce=new Array(Z),de=new Array(Z);for(n=0;n<Z;++n)ce[n]=F.bondAtomList[2*n],de[n]=F.bondAtomList[2*n+1];const oe={atomIndices1:ce,atomIndices2:de,bondOrders:F.bondOrderList};ne[t]=s.residueMap.add(F.groupName,te,j,ee,oe)}for(t=0,e=l;t<e;++t)s.residueStore.residueTypeId[t]=ne[s.residueStore.residueTypeId[t]];for(t=0,e=s.atomStore.count;t<e;++t){const F=s.atomStore.residueIndex[t],te=s.residueMap.list[s.residueStore.residueTypeId[F]],ee=s.residueStore.atomOffset[F];s.atomStore.atomTypeId[t]=te.atomTypeIdList[t-ee]}if(o.secStructList){const F=o.secStructList.length;for(t=0,e=s.residueStore.count;t<e;++t){const te=zE[s.residueStore.sstruc[t%F]];te!==void 0&&(s.residueStore.sstruc[t]=te)}}if(o.entityList&&o.entityList.forEach(function(F,te){s.entityList[te]=new bu(s,te,F.description,F.type,F.chainIndexList)}),o.bioAssemblyList&&o.bioAssemblyList.forEach(function(F,te){const ee=te+1,j=new Yr(""+ee);s.biomolDict["BU"+ee]=j;let Z={};F.transformList.forEach(function(ce){const de=new Ie().fromArray(ce.matrix).transpose(),oe=ce.chainIndexList.map(function(re){let q="";for(let J=0;J<4;++J){const W=o.chainNameList[4*re+J];if(!W)break;q+=String.fromCharCode(W)}return q}),V=Z[oe.toString()];V?V.matrixList.push(de):Z[oe.toString()]=j.addPart([de],oe)})}),o.ncsOperatorList){const F="NCS",te=new Yr(F),ee=te.addPart();o.ncsOperatorList.forEach(function(j){const Z=new Ie().fromArray(j).transpose();ee.matrixList.push(Z)}),ee.matrixList.length>0&&(s.biomolDict[F]=te)}const Y=o.unitCell;Y&&Array.isArray(Y)&&Y[0]?s.unitcell=new vu({a:Y[0],b:Y[1],c:Y[2],alpha:Y[3],beta:Y[4],gamma:Y[5],spacegroup:o.spaceGroup}):s.unitcell=void 0,ia(s,!0),na(s,!0),s.finalizeAtoms(),s.finalizeBonds(),xu(s),Ce&&fe.timeEnd("MmtfParser._parse "+this.name)}});const gf=/\s+/,GE={1:1,2:2,3:3,am:1,ar:1,du:1,un:1,nc:0};it.add("mol2",class extends _r{get type(){return"mol2"}_parse(){Ce&&fe.time("Mol2Parser._parse "+this.name);const t=this.structure,e=this.structureBuilder,n=this.firstModelOnly,i=this.asTrajectory,r=t.frames;let s,o,a=!1;const c=t.atomMap,l=t.atomStore;l.resize(Math.round(this.streamer.data.length/60)),l.addField("partialCharge",1,"float32");let h=0,u=0,f=0,d=-1,p=0,y=0;const g=t.getAtomProxy(),m=t.getAtomProxy();this.streamer.eachChunkOfLines(function(x){(function(v,b,_){for(let C=v;C<b;++C){const w=_[C].trim();if(w!==""&&w[0]!=="#"){if(w[0]==="@")w==="@<TRIPOS>MOLECULE"?(y=1,u=0,++d):w==="@<TRIPOS>ATOM"?(y=2,f=l.count,i&&(o=0,s=new Float32Array(3*p),r.push(s),d>0&&(a=!0))):y=w==="@<TRIPOS>BOND"?3:0;else if(y===1){if(u===0)t.title=w,t.id=w;else if(u===1){const S=w.split(gf);p=parseInt(S[0])}++u}else if(y===2){const S=w.split(gf);if(n&&d>0)continue;const M=parseFloat(S[2]),B=parseFloat(S[3]),L=parseFloat(S[4]);if(i){const F=3*o;if(s[F+0]=M,s[F+1]=B,s[F+2]=L,o+=1,a)continue}const U=S[0],E=S[1],O=S[5].split(".")[0],k=S[6]?parseInt(S[6]):1,ne=S[7]?S[7]:"",Y=S[8]?parseFloat(S[8]):0;l.growIfFull(),l.atomTypeId[h]=c.add(E,O),l.x[h]=M,l.y[h]=B,l.z[h]=L,l.serial[h]=U,l.partialCharge[h]=Y,e.addAtom(d,"","",ne,k,!0),h+=1}else if(y===3){if(n&&d>0||i&&d>0)continue;const S=w.split(gf);g.index=parseInt(S[1])-1+f,m.index=parseInt(S[2])-1+f;const M=GE[S[3]];t.bondStore.addBond(g,m,M)}}}})(0,x.length,x)}),e.finalize(),t.finalizeAtoms(),Uu(t),na(t,!0),ia(t,!0),t.finalizeBonds(),Is(t),Gu(t),Ce&&fe.timeEnd("Mol2Parser._parse "+this.name)}});it.add("pdbqt",class extends ic{get type(){return"pdbqt"}});it.add("pqr",class extends ic{get type(){return"pqr"}});const UE=/> +<(.+)>/;class yf extends _r{get type(){return"sdf"}_parse(){Ce&&fe.time("SdfParser._parse "+this.name);const e=this.structure,n=this.structureBuilder,i=this.firstModelOnly,r=this.asTrajectory,s=this.streamer.peekLines(2);e.id=s[0].trim(),e.title=s[1].trim();const o=e.frames;let a,c,l=!1;const h=e.atomMap,u=e.atomStore;u.resize(Math.round(this.streamer.data.length/50)),u.addField("formalCharge",1,"int8");const f=e.getAtomProxy(),d=e.getAtomProxy();let p=0,y=0,g=0,m=0;const x=[];let v,b,_,C,w,S,M,B,L,U,E,O,k,ne,Y=!1,F={};e.extraData.sdf=x;let te=!1,ee=!1,j=!1,Z=[],ce=[];const de=new Map;this.streamer.eachChunkOfLines(function(oe){(function(V,re,q){for(let J=V;J<re;++J){const W=q[J];if(te&&W&&(Z=W.substring(7).split(" "),ce.length&&(Z=[...ce,...Z],ce=[]),Z[Z.length-1]==="-"))Z.pop(),ce=Z;else{if(W.substr(0,4)==="$$$$")y=-1,++g,m=u.count,x.push(F),F={},Y=!1,te=!1;else if(y===3)te=W.indexOf(" V3000")>-1,te?de.clear():(b=parseInt(W.substr(0,3)),_=parseInt(W.substr(3,3)),C=4,w=C+b,S=w,M=S+_,r&&(c=0,a=new Float32Array(3*b),o.push(a),g>0&&(l=!0)));else if(te&&Z[0]==="COUNTS")b=parseInt(Z[1]),r&&(c=0,a=new Float32Array(3*b),o.push(a),g>0&&(l=!0));else if(te&&Z.length==2)Z[1]==="ATOM"?Z[0]==="BEGIN"?ee=!0:Z[0]==="END"&&(ee=!1):Z[1]==="BOND"&&(Z[0]==="BEGIN"?j=!0:Z[0]==="END"&&(j=!1));else if(ee||!te&&y>=C&&y<w){if(i&&g>0)continue;let H=0;if(te){if(B=parseFloat(Z[2]),L=parseFloat(Z[3]),U=parseFloat(Z[4]),O=Z[1],k=parseInt(Z[0]),de.set(k,p),E=O+k,Z.length>6){let se=Z.slice(6).find($=>$.indexOf("CHG=")===0);se&&(H=parseInt(se.substring(4)))}}else B=parseFloat(W.substr(0,10)),L=parseFloat(W.substr(10,10)),U=parseFloat(W.substr(20,10)),O=W.substr(31,3).trim(),E=O+(p-m+1);if(r){const se=3*c;if(a[se+0]=B,a[se+1]=L,a[se+2]=U,c+=1,l)continue}u.growIfFull(),u.atomTypeId[p]=h.add(E,O),u.x[p]=B,u.y[p]=L,u.z[p]=U,u.serial[p]=te?k:p,u.formalCharge[p]=H,n.addAtom(g,"","","HET",1,!0),p+=1}else if(j||!te&&y>=S&&y<M){if(i&&g>0||r&&g>0)continue;te?(f.index=de.get(parseInt(Z[2])),d.index=de.get(parseInt(Z[3])),ne=parseInt(Z[1])):(f.index=parseInt(W.substr(0,3))-1+m,d.index=parseInt(W.substr(3,3))-1+m,ne=parseInt(W.substr(6,3))),e.bondStore.addBond(f,d,ne)}else if(W.substr(0,6)==="M  CHG"){const H=parseInt(W.substr(6,3));for(let se=0,$=10;se<H;++se,$+=8){const he=parseInt(W.substr($,3))-1+m,me=parseInt(W.substr($+4,3));u.formalCharge[he]=me}}else W.charAt(0)===">"&&(v=W.match(UE))?(Y=v[1],F[Y]=[]):Y!==!1&&W&&F[Y].push(W);++y}}})(0,oe.length,oe)}),n.finalize(),e.finalizeAtoms(),e.finalizeBonds(),Is(e),Ce&&fe.timeEnd("SdfParser._parse "+this.name)}_postProcess(){Is(this.structure)}}it.add("sdf",yf),it.add("sd",yf),it.add("mol",yf);function Ga(t,e,n){return parseInt(t.substr(e,n).trim())}class sy extends _r{get type(){return"prmtop"}_parse(){Ce&&fe.time("PrmtopParser._parse "+this.name);const e=this.structure,n=this.structureBuilder,i=e.atomMap,r=e.atomStore;r.addField("partialCharge",1,"float32"),r.addField("radius",1,"float32");const s=[],o={},a=["NATOM","NTYPES","NBONH","MBONA","NTHETH","MTHETA","NPHIH","MPHIA","NHPARM","NPARM","NNB","NRES","NBONA","NTHETA","NPHIA","NUMBND","NUMANG","NPTRA","NATYP","NPHB","IFPERT","NBPER","NGPER","NDPER","MBPER","MGPER","MDPER","IFBOX","NMXRS","IFCAP","NUMEXTRA","NCOPY"];let c,l,h,u,f;a.forEach(w=>{o[w]=0});let d,p,y,g,m,x=new Uint8Array(0);this.streamer.eachChunkOfLines(function(w){(function(S,M,B){for(let L=S;L<M;++L){const U=B[L],E=U.trim();if(E&&!U.startsWith("%FORMAT")){if(U.startsWith("%FLAG")){const O=U.substr(5).trim();g=0,O==="TITLE"?y=0:O==="POINTERS"?y=1:O==="ATOM_NAME"?y=2:O==="CHARGE"?y=3:O==="MASS"?y=4:O==="RESIDUE_LABEL"?y=5:O==="RESIDUE_POINTER"?y=6:O==="BONDS_INC_HYDROGEN"?(m=0,y=7):O==="BONDS_WITHOUT_HYDROGEN"?(m=o.NBONH,y=8):y=O==="RADII"?9:void 0}else if(y===0)s.push(E);else if(y===1){const O=Math.min(g+10,32);for(let ne=0;g<O;++ne,++g)o[a[g]]=parseInt(U.substr(8*ne,8).trim());c=new Array(o.NATOM),l=new Float32Array(o.NATOM),h=new Float32Array(o.NATOM),r.resize(o.NATOM);const k=o.NBONH+o.MBONA;u=new Uint32Array(k),f=new Uint32Array(k),x=new Uint8Array(k),d=new Array(o.NRES),p=new Uint32Array(o.NRES)}else if(y===2){const O=Math.min(g+20,o.NATOM);for(let k=0;g<O;++k,++g)c[g]=U.substr(4*k,4).trim()}else if(y===3){const O=Math.min(g+5,o.NATOM);for(let k=0;g<O;++k,++g)l[g]=parseFloat(U.substr(16*k,16))/18.2223}else if(y!==4){if(y===5){const O=Math.min(g+20,o.NRES);for(let k=0;g<O;++k,++g)d[g]=U.substr(4*k,4).trim()}else if(y===6){const O=Math.min(g+10,o.NRES);for(let k=0;g<O;++k,++g)p[g]=Ga(U,8*k,8)}else if(y===7){const O=Math.min(g+10,3*o.NBONH);for(let k=0;g<O;++k,++g){const ne=g%3;ne===0&&(u[m]=Ga(U,8*k,8)/3),ne===1&&(f[m]=Ga(U,8*k,8)/3,x[m]=1,++m)}}else if(y===8){const O=Math.min(g+10,3*o.MBONA);for(let k=0;g<O;++k,++g){const ne=g%3;ne===0&&(u[m]=Ga(U,8*k,8)/3),ne===1&&(f[m]=Ga(U,8*k,8)/3,x[m]=1,++m)}}else if(y===9){const O=Math.min(g+5,o.NATOM);for(let k=0;g<O;++k,++g)h[g]=parseFloat(U.substr(16*k,16))}}}}})(0,w.length,w)}),e.title=s.join(" ");const v=o.NATOM;let b=0,_=d[0],C=1;for(let w=0;w<v;++w)w+1===p[b+1]&&(++b,_=d[b],C=b+1),r.atomTypeId[w]=i.add(c[w]),r.serial[w]=w+1,n.addAtom(0,"","",_,C,!1);r.partialCharge.set(l),r.radius.set(h),e.bondStore.length=x.length,e.bondStore.count=x.length,e.bondStore.atomIndex1=u,e.bondStore.atomIndex2=f,e.bondStore.bondOrder=x,n.finalize(),e.finalizeAtoms(),e.finalizeBonds(),na(e,!0),ia(e,!0,!0),Uu(e,!0),Is(e),Ce&&fe.timeEnd("PrmtopParser._parse "+this.name)}}it.add("prmtop",sy),it.add("parm7",sy);const oh=/\s+/,VE=/(^\*|REMARK)*/;it.add("psf",class extends _r{get type(){return"psf"}_parse(){Ce&&fe.time("PsfParser._parse "+this.name);const t=this.structure,e=this.structureBuilder,n=t.atomMap,i=t.atomStore;i.addField("partialCharge",1,"float32");const r=[];let s,o,a,c,l,h,u=0,f=0,d=0;this.streamer.eachChunkOfLines(function(p){(function(y,g,m){for(let x=y;x<g;++x){const v=m[x].trim();if(v){if(s===2){const b=v.split(oh),_=parseInt(b[0]),C=b[1],w=parseInt(b[2]),S=b[3],M=b[4],B=parseFloat(b[6]);C!==a&&(o=$c(f),++f),i.growIfFull(),i.atomTypeId[u]=n.add(M),i.serial[u]=_,i.partialCharge[u]=B,e.addAtom(0,o,o,S,w,!1),u+=1,a=C}else if(s===3){const b=v.split(oh);for(let _=0,C=b.length;_<C;_+=2)c[d]=parseInt(b[_])-1,l[d]=parseInt(b[_+1])-1,h[d]=1,d+=1}else if(s===1)r.push(v.replace(VE,"").trim());else if(s!==4){if(s!==5){if(s!==6)if(v.includes("!NATOM")){s=2;const b=parseInt(v.split(oh)[0]);i.resize(b)}else if(v.includes("!NBOND")){s=3;const b=parseInt(v.split(oh)[0]);c=new Uint32Array(b),l=new Uint32Array(b),h=new Uint8Array(b)}else v.includes("!NTITLE")?s=1:v.includes("!NTHETA")?s=4:v.includes("!NPHI")?s=5:v.includes("!NIMPHI")&&(s=6)}}}else s=void 0}})(0,p.length,p)}),t.title=r.join(" "),t.bondStore.length=h.length,t.bondStore.count=d,t.bondStore.atomIndex1=c,t.bondStore.atomIndex2=l,t.bondStore.bondOrder=h,e.finalize(),t.finalizeAtoms(),t.finalizeBonds(),na(t,!0),ia(t,!0,!0),Is(t),Ce&&fe.timeEnd("PsfParser._parse "+this.name)}});const HE=/\[ (.+) \]/,ah=/\s+/;it.add("top",class extends _r{get type(){return"top"}_parse(){Ce&&fe.time("TopParser._parse "+this.name);const t=this.structure,e=this.structureBuilder,n=t.atomMap,i=t.bondStore,r=t.atomStore;r.addField("partialCharge",1,"float32");const s=[],o={};let a,c;this.streamer.eachChunkOfLines(function(x){(function(v,b,_){for(let C=v;C<b;++C){const w=_[C];let S=w.trim();if(!S||S[0]==="*"||S[0]===";")continue;if(S.startsWith("#include"))throw new Error("TopParser: #include statements not allowed");const M=w.match(HE);if(M!==null){const L=M[1];L==="moleculetype"?(c=2,a={atoms:[],bonds:[]}):c=L==="atoms"?3:L==="bonds"?4:L==="system"?0:L==="molecules"?1:void 0;continue}const B=S.indexOf(";");if(B!==-1&&(S=S.substring(0,B).trim()),c===2){const L=S.split(ah)[0];o[L]=a}else if(c===3){const L=S.split(ah);a.atoms.push([parseInt(L[2]),L[3],L[4],parseFloat(L[6])])}else if(c===4){const L=S.split(ah);a.bonds.push([parseInt(L[0]),parseInt(L[1])])}else if(c===0)t.title=S;else if(c===1){const L=S.split(ah);s.push([L[0],parseInt(L[1])])}}})(0,x.length,x)});let l=0,h=0;s.forEach(function(x){const[v,b]=x,_=o[v];l+=b*_.atoms.length,h+=b*_.bonds.length}),r.resize(l),i.resize(h);let u,f=0,d=0,p=0,y=0,g=0,m=0;s.forEach(function(x){const[v,b]=x,_=o[v],C=$c(y);for(let w=0;w<b;++w){u=-1;const S=mu.includes(v)?C:$c(p);_.atoms.forEach(function(M){const[B,L,U,E]=M;B!==u&&++d,r.atomTypeId[f]=n.add(U),r.serial[f]=f+1,r.partialCharge[f]=E,e.addAtom(0,C,S,L,d+1,!1),++f,u=B}),_.bonds.forEach(function(M){i.atomIndex1[g]=m+M[0]-1,i.atomIndex2[g]=m+M[1]-1,++g}),++p,m+=_.atoms.length}++y}),i.count=h,e.finalize(),t.finalizeAtoms(),t.finalizeBonds(),na(t,!0),ia(t,!0,!0),Is(t),Ce&&fe.timeEnd("TopParser._parse "+this.name)}});class Wu extends wi{constructor(e,n){super(e,n),this.frames=new vb(this.name,this.path)}get type(){return"trajectory"}get __objName(){return"frames"}}function jn(t,e){if(t)throw new TypeError("Not a valid NetCDF v3.x file: "+e)}function Bb(t){t.offset%4!=0&&t.skip(4-t.offset%4)}function zp(t){const e=t.readUint32(),n=t.readChars(e);return Bb(t),n}it.add("dcd",class extends Wu{get type(){return"dcd"}get isBinary(){return!0}_parse(){Ce&&fe.time("DcdParser._parse "+this.name);const t=Qo(this.streamer.data),e=new DataView(t),n=this.frames,i=n.coordinates,r=n.boxes,s={};let o=0;const a=new Int32Array(t,0,23),c=a[0]!==e.getInt32(0);if(a[0]!==84){const g=t.byteLength;for(let m=0;m<g;m+=4)e.setFloat32(m,e.getFloat32(m),!0)}a[0]!==84&&fe.error("dcd bad format, header block start"),String.fromCharCode(e.getUint8(4),e.getUint8(5),e.getUint8(6),e.getUint8(7))!=="CORD"&&fe.error("dcd bad format, format string");let l=!1,h=!1,u=!1;a[22]!==0&&(l=!0,a[12]!==0&&(h=!0),a[13]===1&&(u=!0)),s.NSET=a[2],s.ISTART=a[3],s.NSAVC=a[4],s.NAMNF=a[10],s.DELTA=l?e.getFloat32(44,c):e.getFloat64(44,c),a[22]!==84&&fe.error("dcd bad format, header block end"),o=o+84+8;const f=e.getInt32(o,c),d=o+1;if((f-4)%80!=0&&fe.error("dcd bad format, title block start"),s.TITLE=hu(new Uint8Array(t,d,f)),e.getInt32(d+f+4-1,c)!==f&&fe.error("dcd bad format, title block end"),o=o+f+8,e.getInt32(o,c)!==4&&fe.error("dcd bad format, natom block start"),s.NATOM=e.getInt32(o+4,c),e.getInt32(o+8,c)!==4&&fe.error("dcd bad format, natom block end"),o=o+4+8,s.NAMNF>0)return void fe.error("dcd format with fixed atoms unsupported, aborting");const p=s.NATOM,y=4*p;for(let g=0,m=s.NSET;g<m;++g){if(h){o+=4;const v=new Float32Array(9);v[0]=e.getFloat64(o,c),v[4]=e.getFloat64(o+16,c),v[8]=e.getFloat64(o+40,c),r.push(v),o+=48,o+=4}const x=new Float32Array(3*p);for(let v=0;v<3;++v){e.getInt32(o,c)!==y&&fe.error("dcd bad format, coord block start",g,v),o+=4;const b=new Float32Array(t,o,p);for(let _=0;_<p;++_)x[3*_+v]=b[_];o+=y,e.getInt32(o,c)!==y&&fe.error("dcd bad format, coord block end",g,v),o+=4}i.push(x),u&&(o+=4+e.getInt32(o,c)+4)}s.DELTA&&(n.deltaTime=20.45482949774598*s.DELTA),s.ISTART>=1&&(n.timeOffset=(s.ISTART-1)*n.deltaTime),Ce&&fe.timeEnd("DcdParser._parse "+this.name)}});const en={BYTE:1,CHAR:2,SHORT:3,INT:4,FLOAT:5,DOUBLE:6};function Ob(t){switch(Number(t)){case en.BYTE:return"byte";case en.CHAR:return"char";case en.SHORT:return"short";case en.INT:return"int";case en.FLOAT:return"float";case en.DOUBLE:return"double";default:return"undefined"}}function oy(t){switch(Number(t)){case en.BYTE:case en.CHAR:return 1;case en.SHORT:return 2;case en.INT:case en.FLOAT:return 4;case en.DOUBLE:return 8;default:return-1}}function ay(t){switch(String(t)){case"byte":return en.BYTE;case"char":return en.CHAR;case"short":return en.SHORT;case"int":return en.INT;case"float":return en.FLOAT;case"double":return en.DOUBLE;default:return-1}}function ch(t,e){if(t!==1){const n=new Array(t);for(let i=0;i<t;i++)n[i]=e();return n}return e()}function Gp(t,e,n){switch(e){case en.BYTE:return t.readBytes(n);case en.CHAR:return function(i){return i.charCodeAt(i.length-1)===0?i.substring(0,i.length-1):i}(t.readChars(n));case en.SHORT:return ch(n,t.readInt16.bind(t));case en.INT:return ch(n,t.readInt32.bind(t));case en.FLOAT:return ch(n,t.readFloat32.bind(t));case en.DOUBLE:return ch(n,t.readFloat64.bind(t));default:return void jn(!0,"non valid type "+e)}}const mo=0,$E=10,WE=11,jE=12;function qE(t,e){const n={recordDimension:{length:t.readUint32()}};n.version=e;const i=function(s){let o,a,c;const l=s.readUint32();if(l===mo)return jn(s.readUint32()!==mo,"wrong empty tag for list of dimensions"),[];{jn(l!==$E,"wrong tag for list of dimensions");const h=s.readUint32();o=new Array(h);for(let u=0;u<h;u++){const f=zp(s),d=s.readUint32();d===0&&(a=u,c=f),o[u]={name:f,size:d}}return{dimensions:o,recordId:a,recordName:c}}}(t);n.recordDimension.id=i.recordId,n.recordDimension.name=i.recordName,n.dimensions=i.dimensions,n.globalAttributes=cy(t);const r=function(s,o,a){const c=s.readUint32();let l,h=0;if(c===mo)return jn(s.readUint32()!==mo,"wrong empty tag for list of variables"),[];{jn(c!==WE,"wrong tag for list of variables");const u=s.readUint32();l=new Array(u);for(let f=0;f<u;f++){const d=zp(s),p=s.readUint32(),y=new Array(p);for(let b=0;b<p;b++)y[b]=s.readUint32();const g=cy(s),m=s.readUint32();jn(m<1&&m>6,"non valid type "+m);const x=s.readUint32();let v=s.readUint32();a===2&&(jn(v>0,"offsets larger than 4GB not supported"),v=s.readUint32()),y[0]===o&&(h+=x),l[f]={name:d,dimensions:y,attributes:g,type:Ob(m),size:x,offset:v,record:y[0]===o}}}return{variables:l,recordStep:h}}(t,i.recordId,e);return n.variables=r.variables,n.recordDimension.recordStep=r.recordStep,n}function cy(t){let e;const n=t.readUint32();if(n===mo)return jn(t.readUint32()!==mo,"wrong empty tag for list of attributes"),[];{jn(n!==jE,"wrong tag for list of attributes");const i=t.readUint32();e=new Array(i);for(let r=0;r<i;r++){const s=zp(t),o=t.readUint32();jn(o<1||o>6,"non valid type "+o);const a=t.readUint32(),c=Gp(t,o,a);Bb(t),e[r]={name:s,type:Ob(o),value:c}}}return e}class kb{constructor(e){const n=new _A(e);n.setBigEndian(),jn(n.readChars(3)!=="CDF","should start with CDF");const i=n.readByte();jn(i>2,"unknown version"),this.header=qE(n,i),this.buffer=n}get version(){return this.header.version===1?"classic format":"64-bit offset format"}get recordDimension(){return this.header.recordDimension}get dimensions(){return this.header.dimensions}get globalAttributes(){return this.header.globalAttributes}get variables(){return this.header.variables}hasDataVariable(e){return this.header.variables.findIndex(function(n){return n.name===e})!==-1}getDataVariable(e){let n;return n=typeof e=="string"?this.header.variables.find(function(i){return i.name===e}):e,jn(n===void 0,"variable not found"),this.buffer.seek(n.offset),n.record?function(i,r,s){const o=ay(r.type),a=r.size?r.size/oy(o):1,c=s.length,l=new Array(c),h=s.recordStep;for(let u=0;u<c;u++){const f=i.offset;l[u]=Gp(i,o,a),i.seek(f+h)}return l}(this.buffer,n,this.header.recordDimension):function(i,r){const s=ay(r.type),o=r.size/oy(s),a=new Array(o);for(let c=0;c<o;c++)a[c]=Gp(i,s,1);return a}(this.buffer,n)}}class xf extends Wu{get type(){return"nctraj"}get isBinary(){return!0}_parse(){Ce&&fe.time("NctrajParser._parse "+this.name);const e=new kb(this.streamer.data),n=this.frames,i=n.coordinates,r=n.boxes,s=n.times;e.getDataVariable("coordinates").forEach(function(o){i.push(new Float32Array(o))}),e.hasDataVariable("cell_lengths")&&e.getDataVariable("cell_lengths").forEach(function(o){r.push(new Float32Array(o))}),e.hasDataVariable("time")&&e.getDataVariable("time").forEach(function(o){s.push(o)}),s.length>=1&&(n.timeOffset=s[0]),s.length>=2&&(n.deltaTime=s[1]-s[0]),Ce&&fe.timeEnd("NctrajParser._parse "+this.name)}}it.add("nctraj",xf),it.add("ncdf",xf),it.add("nc",xf);it.add("trr",class extends Wu{get type(){return"trr"}get isBinary(){return!0}_parse(){Ce&&fe.time("TrrParser._parse "+this.name);const t=Qo(this.streamer.data),e=new DataView(t),n=this.frames,i=n.coordinates,r=n.boxes,s=n.times;let o=0;for(;;){o+=8;const a=e.getInt32(o);o+=4,o+=a;const c=e.getInt32(o+8),l=e.getInt32(o+12),h=e.getInt32(o+16),u=e.getInt32(o+28),f=e.getInt32(o+32),d=e.getInt32(o+36),p=e.getInt32(o+40);o+=52;const y=c/9,g=3*p;if(y===8?s.push(e.getFloat64(o)):s.push(e.getFloat32(o)),o+=2*y,c){const m=new Float32Array(9);if(y===8)for(let x=0;x<9;++x)m[x]=10*e.getFloat64(o),o+=8;else for(let x=0;x<9;++x)m[x]=10*e.getFloat32(o),o+=4;r.push(m)}if(o+=l,o+=h,u){let m;if(y===8){m=new Float32Array(g);for(let x=0;x<g;++x)m[x]=10*e.getFloat64(o),o+=8}else{const x=new Uint32Array(t,o,g);for(let v=0;v<g;++v){const b=x[v];x[v]=(255&b)<<24|(65280&b)<<8|b>>8&65280|b>>24&255}m=new Float32Array(t,o,g);for(let v=0;v<g;++v)m[v]*=10,o+=4}i.push(m)}if(o+=f,o+=d,o>=t.byteLength)break}s.length>=1&&(n.timeOffset=s[0]),s.length>=2&&(n.deltaTime=s[1]-s[0]),Ce&&fe.timeEnd("TrrParser._parse "+this.name)}});const eo=new Uint32Array([0,0,0,0,0,0,0,0,0,8,10,12,16,20,25,32,40,50,64,80,101,128,161,203,256,322,406,512,645,812,1024,1290,1625,2048,2580,3250,4096,5060,6501,8192,10321,13003,16384,20642,26007,32768,41285,52015,65536,82570,104031,131072,165140,208063,262144,330280,416127,524287,660561,832255,1048576,1321122,1664510,2097152,2642245,3329021,4194304,5284491,6658042,8388607,10568983,13316085,16777216]);function bf(t){let e=1,n=0;for(;t>=e&&n<32;)n++,e<<=1;return n}const Ua=new Uint8Array(32);function XE(t,e){let n=1,i=0;Ua[0]=1;for(let s=0;s<t;s++){let o,a=0;for(o=0;o<n;o++)a+=Ua[o]*e[s],Ua[o]=255&a,a>>=8;for(;a!==0;)Ua[o++]=255&a,a>>=8;n=o}let r=1;for(n--;Ua[n]>=r;)i++,r*=2;return i+8*n}function hs(t,e,n,i){const r=(1<<n)-1;let s=i[1],o=i[2],a=t[0],c=0;for(;n>=8;)o=o<<8|e[a++],c|=o>>s<<n-8,n-=8;return n>0&&(s<n&&(s+=8,o=o<<8|e[a++]),s-=n,c|=o>>s&(1<<n)-1),c&=r,t[0]=a,t[1]=s,t[2]=o,c}const pi=new Int32Array(32);function ly(t,e,n,i,r,s,o){let a=0;for(pi[1]=0,pi[2]=0,pi[3]=0;i>8;)pi[a++]=hs(t,e,8,o),i-=8;i>0&&(pi[a++]=hs(t,e,i,o));for(let c=n-1;c>0;c--){let l=0;for(let h=a-1;h>=0;h--){l=l<<8|pi[h];const u=l/r[c]|0;pi[h]=u,l-=u*r[c]}s[c]=l}s[0]=pi[0]|pi[1]<<8|pi[2]<<16|pi[3]<<24}it.add("xtc",class extends Wu{get type(){return"xtc"}get isBinary(){return!0}_parse(){Ce&&fe.time("XtcParser._parse "+this.name);const t=Qo(this.streamer.data),e=new DataView(t),n=this.frames,i=n.coordinates,r=n.boxes,s=n.times,o=new Int32Array(6),a=new Int32Array(3),c=new Int32Array(3),l=new Uint32Array(3),h=new Float32Array(3),u=new Float32Array(3);let f=0;const d=new Int32Array(3),p=new Uint32Array(d.buffer);for(;;){let y;const g=e.getInt32(f+4);f+=12;const m=3*g;s.push(e.getFloat32(f)),f+=4;const x=new Float32Array(9);for(let v=0;v<9;++v)x[v]=10*e.getFloat32(f),f+=4;if(r.push(x),g<=9){y=new Float32Array(g);for(let v=0;v<g;++v)y[v]=e.getFloat32(f),f+=4}else{d[0]=d[1]=d[2]=0,a[0]=a[1]=a[2]=0,l[0]=l[1]=l[2]=0,c[0]=c[1]=c[2]=0,h[0]=h[1]=h[2]=0,u[0]=u[1]=u[2]=0,y=new Float32Array(m);let v=0;const b=e.getInt32(f);f+=4;const _=e.getFloat32(f);let C;f+=4,o[0]=e.getInt32(f),o[1]=e.getInt32(f+4),o[2]=e.getInt32(f+8),o[3]=e.getInt32(f+12),o[4]=e.getInt32(f+16),o[5]=e.getInt32(f+20),a[0]=o[3]-o[0]+1,a[1]=o[4]-o[1]+1,a[2]=o[5]-o[2]+1,f+=24,(a[0]|a[1]|a[2])>16777215?(c[0]=bf(a[0]),c[1]=bf(a[1]),c[2]=bf(a[2]),C=0):C=XE(3,a);let w=e.getInt32(f);f+=4;let S=w-1;S=9>S?9:S;let M=eo[S]/2|0,B=eo[w]/2|0;l[0]=l[1]=l[2]=eo[w];let L=4*Math.ceil(e.getInt32(f)/4);f+=4;const U=1/_;let E=0,O=0;const k=new Uint8Array(t,f);for(h[0]=h[1]=h[2]=0;O<b;){C===0?(h[0]=hs(d,k,c[0],p),h[1]=hs(d,k,c[1],p),h[2]=hs(d,k,c[2],p)):ly(d,k,3,C,a,h,p),O++,h[0]+=o[0],h[1]+=o[1],h[2]+=o[2],u[0]=h[0],u[1]=h[1],u[2]=h[2];let ne=0;if(hs(d,k,1,p)===1&&(E=hs(d,k,5,p),ne=E%3,E-=ne,ne--),E>0){h[0]=h[1]=h[2]=0;for(let Y=0;Y<E;Y+=3){if(ly(d,k,3,w,l,h,p),O++,h[0]+=u[0]-B,h[1]+=u[1]-B,h[2]+=u[2]-B,Y===0){let F=h[0];h[0]=u[0],u[0]=F,F=h[1],h[1]=u[1],u[1]=F,F=h[2],h[2]=u[2],u[2]=F,y[v++]=u[0]*U,y[v++]=u[1]*U,y[v++]=u[2]*U}else u[0]=h[0],u[1]=h[1],u[2]=h[2];y[v++]=h[0]*U,y[v++]=h[1]*U,y[v++]=h[2]*U}}else y[v++]=h[0]*U,y[v++]=h[1]*U,y[v++]=h[2]*U;if(w+=ne,ne<0?(B=M,M=w>9?eo[w-1]/2|0:0):ne>0&&(M=B,B=eo[w]/2|0),l[0]=l[1]=l[2]=eo[w],l[0]===0||l[1]===0||l[2]===0)return void console.error("(xdrfile error) Undefined error.")}f+=L}for(let v=0;v<m;v++)y[v]*=10;if(i.push(y),f>=t.byteLength)break}s.length>=1&&(n.timeOffset=s[0]),s.length>=2&&(n.deltaTime=s[1]-s[0]),Ce&&fe.timeEnd("XtcParser._parse "+this.name)}});class il extends wi{constructor(e,n){const i=n||{};super(e,i),this.volume=new Nn(this.name,this.path),this.voxelSize=I(i.voxelSize,1)}get type(){return"volume"}get __objName(){return"volume"}_afterParse(){this.volume.setMatrix(this.getMatrix()),super._afterParse()}getMatrix(){return new Ie}}const YE=/\s+/,ZE=/-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?/g,lh=.529177210859;class hy extends il{get type(){return"cube"}_parse(){Ce&&fe.time("CubeParser._parse "+this.name);const e=this.volume,n=this.streamer.peekLines(6),i={},r=lh*this.voxelSize;function s(h,u){var f=n[h].trim().split(YE)[u];return parseFloat(f)}i.atomCount=Math.abs(s(2,0)),i.originX=s(2,1)*lh,i.originY=s(2,2)*lh,i.originZ=s(2,3)*lh,i.NVX=s(3,0),i.NVY=s(4,0),i.NVZ=s(5,0),i.basisX=new T(s(3,1),s(3,2),s(3,3)).multiplyScalar(r),i.basisY=new T(s(4,1),s(4,2),s(4,3)).multiplyScalar(r),i.basisZ=new T(s(5,1),s(5,2),s(5,3)).multiplyScalar(r);const o=new Float32Array(i.NVX*i.NVY*i.NVZ);let a=0,c=0;const l=s(2,0)>0?0:1;this.streamer.eachChunkOfLines(function(h){(function(u,f,d){for(let p=u;p<f;++p){const y=d[p].trim();if(y!==""&&c>=i.atomCount+6+l){const g=y.match(ZE);for(let m=0,x=g.length;m<x;++m)o[a]=parseFloat(g[m]),++a}++c}})(0,h.length,h)}),e.header=i,e.setData(o,i.NVZ,i.NVY,i.NVX),Ce&&fe.timeEnd("CubeParser._parse "+this.name)}getMatrix(){const e=this.volume.header,n=new Ie;return n.multiply(new Ie().makeTranslation(e.originX,e.originY,e.originZ)),n.multiply(new Ie().makeBasis(e.basisZ,e.basisY,e.basisX)),n}}it.add("cub",hy),it.add("cube",hy);class uy extends il{get type(){return"dsn6"}get isBinary(){return!0}_parse(){Ce&&fe.time("Dsn6Parser._parse "+this.name);const e=this.volume,n={};let i,r;const s=Qo(this.streamer.data),o=new Int16Array(s),a=new Uint8Array(s),c=String.fromCharCode.apply(null,a.subarray(0,512));if(c.startsWith(":-)"))n.xStart=parseInt(c.substr(10,5)),n.yStart=parseInt(c.substr(15,5)),n.zStart=parseInt(c.substr(20,5)),n.xExtent=parseInt(c.substr(32,5)),n.yExtent=parseInt(c.substr(38,5)),n.zExtent=parseInt(c.substr(42,5)),n.xRate=parseInt(c.substr(52,5)),n.yRate=parseInt(c.substr(58,5)),n.zRate=parseInt(c.substr(62,5)),n.xlen=parseFloat(c.substr(73,10))*this.voxelSize,n.ylen=parseFloat(c.substr(83,10))*this.voxelSize,n.zlen=parseFloat(c.substr(93,10))*this.voxelSize,n.alpha=parseFloat(c.substr(103,10)),n.beta=parseFloat(c.substr(113,10)),n.gamma=parseFloat(c.substr(123,10)),i=parseFloat(c.substr(138,12))/100,r=parseInt(c.substr(155,8)),n.sigma=100*parseFloat(c.substr(170,12));else{if(o[18]!==100)for(let M=0,B=o.length;M<B;++M){const L=o[M];o[M]=(255&L)<<8|L>>8&255}n.xStart=o[0],n.yStart=o[1],n.zStart=o[2],n.xExtent=o[3],n.yExtent=o[4],n.zExtent=o[5],n.xRate=o[6],n.yRate=o[7],n.zRate=o[8];const w=1/o[17],S=w*this.voxelSize;n.xlen=o[9]*S,n.ylen=o[10]*S,n.zlen=o[11]*S,n.alpha=o[12]*w,n.beta=o[13]*w,n.gamma=o[14]*w,i=o[15]/100,r=o[16],n.gamma=o[14]*w}e.header=n,Ce&&fe.log(n,i,r);const l=new Float32Array(n.xExtent*n.yExtent*n.zExtent);let h=512;const u=Math.ceil(n.xExtent/8),f=Math.ceil(n.yExtent/8),d=Math.ceil(n.zExtent/8);for(var p=0;p<d;++p)for(var y=0;y<f;++y)for(var g=0;g<u;++g)for(var m=0;m<8;++m)for(var x=8*p+m,v=0;v<8;++v)for(var b=8*y+v,_=0;_<8;++_){var C=8*g+_;if(!(C<n.xExtent&&b<n.yExtent&&x<n.zExtent)){h+=8-_;break}l[(C*n.yExtent+b)*n.zExtent+x]=(a[h]-r)/i,++h}e.setData(l,n.zExtent,n.yExtent,n.xExtent),n.sigma&&e.setStats(void 0,void 0,void 0,n.sigma),Ce&&fe.timeEnd("Dsn6Parser._parse "+this.name)}getMatrix(){const e=this.volume.header,n=[e.xlen,0,0],i=[e.ylen*Math.cos(Math.PI/180*e.gamma),e.ylen*Math.sin(Math.PI/180*e.gamma),0],r=[e.zlen*Math.cos(Math.PI/180*e.beta),e.zlen*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0];r[2]=Math.sqrt(e.zlen*e.zlen*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-r[1]*r[1]);const s=[[],n,i,r],o=[0,e.xRate,e.yRate,e.zRate],a=[0,1,2,3],c=new Ie;return c.set(s[a[1]][0]/o[a[1]],s[a[2]][0]/o[a[2]],s[a[3]][0]/o[a[3]],0,s[a[1]][1]/o[a[1]],s[a[2]][1]/o[a[2]],s[a[3]][1]/o[a[3]],0,s[a[1]][2]/o[a[1]],s[a[2]][2]/o[a[2]],s[a[3]][2]/o[a[3]],0,0,0,0,1),c.multiply(new Ie().makeRotationY(rn(90))),c.multiply(new Ie().makeTranslation(-e.zStart,e.yStart,e.xStart)),c.multiply(new Ie().makeScale(-1,1,1)),c}}it.add("dsn6",uy),it.add("brix",uy);const hh=/\s+/;class Fb extends il{get type(){return"dx"}_parse(){Ce&&fe.time("DxParser._parse "+this.name);const e=this.volume,n=this.streamer.peekLines(30),i=this.parseHeaderLines(n),r=this.volume.header,s=i.dataLineStart,o=r.nx*r.ny*r.nz,a=new Float32Array(o);let c=0,l=0;this.streamer.eachChunkOfLines(function(h){(function(u,f,d){for(let p=u;p<f;++p){if(c<o&&l>s){const y=d[p].trim();if(y!==""){const g=y.split(hh);for(let m=0,x=g.length;m<x;++m)a[c]=parseFloat(g[m]),++c}}++l}})(0,h.length,h)}),e.setData(a,r.nz,r.ny,r.nx),Ce&&fe.timeEnd("DxParser._parse "+this.name)}parseHeaderLines(e){const n={},i=e.length;let r=0,s=0,o=0;for(let a=0;a<i;++a){let c;const l=e[a];if(l.startsWith("object 1"))c=l.split(hh),n.nx=parseInt(c[5]),n.ny=parseInt(c[6]),n.nz=parseInt(c[7]);else if(l.startsWith("origin"))c=l.split(hh),n.xmin=parseFloat(c[1]),n.ymin=parseFloat(c[2]),n.zmin=parseFloat(c[3]);else if(l.startsWith("delta"))c=l.split(hh),o===0?n.hx=parseFloat(c[1])*this.voxelSize:o===1?n.hy=parseFloat(c[2])*this.voxelSize:o===2&&(n.hz=parseFloat(c[3])*this.voxelSize),o+=1;else if(l.startsWith("object 3")){r=a,s+=l.length+1;break}s+=l.length+1}return this.volume.header=n,{dataLineStart:r,headerByteCount:s}}getMatrix(){const e=this.volume.header,n=new Ie;return n.multiply(new Ie().makeRotationY(rn(90))),n.multiply(new Ie().makeTranslation(-e.zmin,e.ymin,e.xmin)),n.multiply(new Ie().makeScale(-e.hz,e.hy,e.hx)),n}}it.add("dx",Fb);it.add("dxbin",class extends Fb{get type(){return"dxbin"}get isBinary(){return!0}_parse(){Ce&&fe.time("DxbinParser._parse "+this.name);const t=Qo(this.streamer.data),e=function(c,l=10485760,h=`
`){let u="",f=[];for(let d=0;d<c.length;d+=l){const p=hu(c.subarray(d,d+l)),y=p.lastIndexOf(h);if(y===-1)u+=p;else{const g=u+p.substr(0,y);f=f.concat(g.split(h)),u=y===p.length-h.length?"":p.substr(y+h.length)}}return u!==""&&f.push(u),f}(new Uint8Array(t,0,1e3)),n=this.parseHeaderLines(e),i=this.volume.header,r=n.headerByteCount,s=i.nx*i.ny*i.nz,o=new DataView(t),a=new Float32Array(s);for(let c=0;c<s;++c)a[c]=o.getFloat64(8*c+r,!0);this.volume.setData(a,i.nz,i.ny,i.nx),Ce&&fe.timeEnd("DxbinParser._parse "+this.name)}});class vf extends il{get type(){return"mrc"}get isBinary(){return!0}_parse(){Ce&&fe.time("MrcParser._parse "+this.name);const e=this.volume,n={},i=Qo(this.streamer.data),r=new Int32Array(i,0,56),s=new Float32Array(i,0,56),o=new DataView(i);if(n.MAP=String.fromCharCode(o.getUint8(208),o.getUint8(209),o.getUint8(210),o.getUint8(211)),n.MACHST=[o.getUint8(212),o.getUint8(213)],n.MACHST[0]===17&&n.MACHST[1]===17){const c=i.byteLength;for(let l=0;l<c;l+=4)o.setFloat32(l,o.getFloat32(l),!0)}let a;if(n.NX=r[0],n.NY=r[1],n.NZ=r[2],n.MODE=r[3],n.NXSTART=r[4],n.NYSTART=r[5],n.NZSTART=r[6],n.MX=r[7],n.MY=r[8],n.MZ=r[9],n.xlen=s[10]*this.voxelSize,n.ylen=s[11]*this.voxelSize,n.zlen=s[12]*this.voxelSize,n.alpha=s[13],n.beta=s[14],n.gamma=s[15],n.MAPC=r[16],n.MAPR=r[17],n.MAPS=r[18],n.DMIN=s[19],n.DMAX=s[20],n.DMEAN=s[21],n.ISPG=r[22],n.NSYMBT=r[23],n.LSKFLG=r[24],n.originX=s[49],n.originY=s[50],n.originZ=s[51],n.ARMS=s[54],e.header=n,n.MODE===2)a=new Float32Array(i,1024+n.NSYMBT,n.NX*n.NY*n.NZ);else if(n.MODE===0){if(a=new Float32Array(new Int8Array(i,1024+n.NSYMBT,n.NX*n.NY*n.NZ)),r[39]===-128&&r[40]===127){const c=(n.DMAX-n.DMIN)/255,l=.5*(n.DMIN+n.DMAX+c);for(let h=0,u=a.length;h<u;++h)a[h]=c*a[h]+l}}else fe.error("MrcParser unknown mode",n.MODE);e.setData(a,n.NX,n.NY,n.NZ),n.ARMS!==0&&e.setStats(n.DMIN,n.DMAX,n.DMEAN,n.ARMS),Ce&&fe.timeEnd("MrcParser._parse "+this.name)}getMatrix(){const e=this.volume.header,n=[e.xlen,0,0],i=[e.ylen*Math.cos(Math.PI/180*e.gamma),e.ylen*Math.sin(Math.PI/180*e.gamma),0],r=[e.zlen*Math.cos(Math.PI/180*e.beta),e.zlen*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0];r[2]=Math.sqrt(e.zlen*e.zlen*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-r[1]*r[1]);const s=[[],n,i,r],o=[0,e.MX,e.MY,e.MZ],a=[0,e.MAPC,e.MAPR,e.MAPS],c=new Ie;return c.set(s[a[1]][0]/o[a[1]],s[a[2]][0]/o[a[2]],s[a[3]][0]/o[a[3]],0,s[a[1]][1]/o[a[1]],s[a[2]][1]/o[a[2]],s[a[3]][1]/o[a[3]],0,s[a[1]][2]/o[a[1]],s[a[2]][2]/o[a[2]],s[a[3]][2]/o[a[3]],0,0,0,0,1),c.setPosition(new T(e.originX,e.originY,e.originZ)),c.multiply(new Ie().makeTranslation(e.NXSTART,e.NYSTART,e.NZSTART)),c}}it.add("mrc",vf),it.add("ccp4",vf),it.add("map",vf);const KE=/\s+/;function _f(t){return t.trim().split(KE).map(parseFloat)}class dy extends il{get type(){return"xplor"}_parse(){Ce&&fe.time("XplorParser._parse "+this.name);const e=this.volume,n=this.streamer.peekLines(8),i={};let r;r=n[2].startsWith("REMARKS")?parseInt(n[1].substring(0,8))+2:5;const s=r+3,o=_f(n[r]);i.NA=o[0],i.AMIN=o[1],i.AMAX=o[2],i.NB=o[3],i.BMIN=o[4],i.BMAX=o[5],i.NC=o[6],i.CMIN=o[7],i.CMAX=o[8];const a=_f(n[r+1]);i.a=a[0]*this.voxelSize,i.b=a[1]*this.voxelSize,i.c=a[2]*this.voxelSize,i.alpha=a[3],i.beta=a[4],i.gamma=a[5];const c=i.AMAX-i.AMIN+1,l=i.BMAX-i.BMIN+1,h=i.CMAX-i.CMIN+1,u=c*l*h,f=new Float32Array(u),d=Math.ceil(1+c*l/6);let p=0,y=0;this.streamer.eachChunkOfLines(function(g){(function(m,x,v){for(let b=m;b<x;++b){const _=v[b];if(y>=s&&(y-s)%d!=0&&p<u)for(let C=0,w=6;C<w;++C){const S=parseFloat(_.substr(12*C,12));if(isNaN(S))break;f[p++]=S}else if(p===u){const C=_.trim();if(C&&C!=="-9999"){const w=_f(_);i.RAVE=w[0],i.RSIGMA=w[1]}}++y}})(0,g.length,g)}),e.header=i,e.setData(f,c,l,h),i.RAVE!==0&&i.RSIGMA!==1&&e.setStats(void 0,void 0,i.RAVE,i.RSIGMA),Ce&&fe.timeEnd("XplorParser._parse "+this.name)}getMatrix(){const e=this.volume.header,n=[e.a,0,0],i=[e.b*Math.cos(Math.PI/180*e.gamma),e.b*Math.sin(Math.PI/180*e.gamma),0],r=[e.c*Math.cos(Math.PI/180*e.beta),e.c*(Math.cos(Math.PI/180*e.alpha)-Math.cos(Math.PI/180*e.gamma)*Math.cos(Math.PI/180*e.beta))/Math.sin(Math.PI/180*e.gamma),0];r[2]=Math.sqrt(e.c*e.c*Math.sin(Math.PI/180*e.beta)*Math.sin(Math.PI/180*e.beta)-r[1]*r[1]);const s=[[],n,i,r],o=[0,e.NA,e.NB,e.NC],a=[0,1,2,3],c=new Ie;return c.set(s[a[1]][0]/o[a[1]],s[a[2]][0]/o[a[2]],s[a[3]][0]/o[a[3]],0,s[a[1]][1]/o[a[1]],s[a[2]][1]/o[a[2]],s[a[3]][1]/o[a[3]],0,s[a[1]][2]/o[a[1]],s[a[2]][2]/o[a[2]],s[a[3]][2]/o[a[3]],0,0,0,0,1),c.multiply(new Ie().makeTranslation(e.AMIN,e.BMIN,e.CMIN)),c}}function Yt(t,e,n){let i,r,s;t/=360,e/=100,n/=100;const o=Math.floor(6*t),a=6*t-o,c=n*(1-e),l=n*(1-a*e),h=n*(1-(1-a)*e);switch(o%6){case 0:i=n,r=h,s=c;break;case 1:i=l,r=n,s=c;break;case 2:i=c,r=n,s=h;break;case 3:i=c,r=l,s=n;break;case 4:i=h,r=c,s=n;break;case 5:i=n,r=c,s=l}return[i,r,s]}it.add("xplor",dy),it.add("cns",dy);const Up={red:Yt(0,100,100),orange:Yt(20,100,100),gold:Yt(40,100,100),yellow:Yt(60,100,100),lime:Yt(80,100,100),green:Yt(120,80,100),sea:Yt(150,100,100),cyan:Yt(180,100,85),sky:Yt(210,75,95),blue:Yt(240,70,100),purple:Yt(275,75,100),magenta:Yt(300,95,100),hotpink:Yt(335,100,100),pink:Yt(350,55,100),peach:Yt(25,75,100),lilac:Yt(275,55,100),pinktint:Yt(340,30,100),peachtint:Yt(25,50,100),yellowtint:Yt(60,50,100),greentint:Yt(135,40,100),bluetint:Yt(220,40,100),lilactint:Yt(275,35,100),white:Yt(0,0,100),gray:Yt(0,0,50),brown:Yt(20,45,75),deadwhite:[1,1,1],deadblack:[0,0,0],invisible:[0,0,0]},JE=/[\s,]+/,Nb=/[^{}\s]*{[^{}]+}|[^{}\s]+/g,Vp=/^{+|}+$/g,QE=/^['"]+|['"]+$/g,zb=/\s*=\s*/g;function uh(t){let e,n,i,r=[];const s=(t=t.replace(zb,"=")).match(Nb);for(let o=1;o<s.length;++o){const a=s[o];if(a[0]==="{")e=a.substring(1,a.length-1);else{const c=a.split("=");c.length===2&&(c[0]==="color"?n=Up[c[1]]:c[0]==="width"?i=parseInt(c[1]):c[0]==="master"&&r.push(c[1].replace(Vp,"")))}}return{listName:e,listColor:n,listMasters:r,listWidth:i}}function dh(t){const e=(t=t.trim()).indexOf("{"),n=t.indexOf("}"),i=t.substr(n+1).split(JE),r=t.substr(e+1,n-1),s=[parseFloat(i[i.length-3]),parseFloat(i[i.length-2]),parseFloat(i[i.length-1])];let o,a,c,l=!1,h=!1;for(let u=4;u<=i.length;u++){const f=i[i.length-u];f in Up&&(o=Up[i[i.length-u]]),f.startsWith("width")&&(a=parseInt(f.substring(5))),f.startsWith("r=")&&(c=parseFloat(f.split("=")[1])),f.startsWith("P")&&(l=!0),f.startsWith("X")&&(h=!0)}return{label:r,position:s,color:o,radius:c,width:a,isLineBreak:l,isTriangleBreak:h}}function wf(t){const e=t.indexOf("{"),n=t.indexOf("}");return t.substring(e!==-1?e+1:0,n!==-1?n:void 0).trim()}function eI(t){const e=t.indexOf("}");return e===-1?void 0:t.substr(e+1).trim()}function Sf(t){let e="",n=[],i={};const r=(t=t.replace(zb,"=")).match(Nb);for(let s=1;s<r.length;++s){const o=r[s];if(o[0]==="{")e=o.substring(1,o.length-1);else{const a=o.split("=");a.length===2?a[0]==="master"?n.push(a[1].replace(Vp,"")):i[a[0]]=a[1].replace(Vp,""):i[a[0]]=!0}}return{groupName:e,groupFlags:i,groupMasters:n}}it.add("kin",class extends wi{get type(){return"kin"}get __objName(){return"kinemage"}_parse(){Ce&&fe.time(`KinParser._parse ${this.name}`);const t={kinemage:void 0,onewidth:void 0,"1viewid":void 0,pdbfile:void 0,texts:[],text:"",captions:[],caption:"",groupDict:{},subgroupDict:{},masterDict:{},pointmasterDict:{},dotLists:[],vectorLists:[],ballLists:[],ribbonLists:[]};let e,n;this.kinemage=t;let i,r,s,o,a,c,l,h,u,f,d,p,y,g,m,x,v,b,_,C,w,S,M=!1,B="",L=!1,U="",E=null,O=null,k=!1,ne="",Y=!1,F="",te=!1,ee=!1;if(this.streamer.eachChunkOfLines(function(j){(function(Z,ce,de){for(let V=Z;V<ce;++V){const re=de[V];if(re[0]==="@"&&(M=!1,L=!1,k=!1,Y=!1,te=!1,ee=!1),re)if(re.startsWith("@dotlist")){let{listColor:q,listName:J,listMasters:W}=uh(re);M=!0,B="",r=[],s=[],o=[],i=q,e&&(W=W.concat(e)),n&&(W=W.concat(n)),t.dotLists.push({name:J,masterArray:W,labelArray:r,positionArray:s,colorArray:o})}else if(re.startsWith("@vectorlist")){let{listMasters:q,listName:J,listWidth:W,listColor:H}=uh(re);q&&q.forEach(function(se){t.masterDict[se]||(t.masterDict[se]={indent:!1,visible:!1})}),L=!0,U="",E=null,O=null,l=[],h=[],u=[],f=[],d=[],p=[],a=H,c=[],W&&c.push(W),e&&(q=q.concat(e)),n&&(q=q.concat(n)),t.vectorLists.push({name:J,masterArray:q,label1Array:l,label2Array:h,position1Array:u,position2Array:f,color1Array:d,color2Array:p,width:c})}else if(re.startsWith("@balllist")){let{listName:q,listColor:J,listMasters:W}=uh(re);W&&W.forEach(function(H){t.masterDict[H]||(t.masterDict[H]={indent:!1,visible:!1})}),k=!0,ne="",m=[],y=[],x=[],v=[],g=J,e&&(W=W.concat(e)),n&&(W=W.concat(n)),t.ballLists.push({name:q,masterArray:W,labelArray:m,radiusArray:y,positionArray:x,colorArray:v})}else if(re.startsWith("@ribbonlist")||re.startsWith("@trianglelist")){let{listMasters:q,listName:J,listColor:W}=uh(re);q&&q.forEach(function(H){t.masterDict[H]||(t.masterDict[H]={indent:!1,visible:!1})}),Y=!0,F="",_=[],C=[],w=[],S=[],b=W,e&&(q=q.concat(e)),n&&(q=q.concat(n)),t.ribbonLists.push({name:J,masterArray:q,labelArray:_,positionArray:C,breakArray:w,colorArray:S})}else if(re.startsWith("@text"))te=!0,t.texts.push(re.substr(5));else if(re.startsWith("@caption"))ee=!0,t.captions.push(re.substr(8));else if(M){let{label:q,color:J,position:W}=dh(re);q==='"'?q=B:B=q,J===void 0&&(J=i),r.push(q),s.push(...W),o.push(...J)}else if(L){let q=re.replace(/(?!^){/g,`
{`).split(/\n/);for(var oe=0;oe<q.length;oe++){let J=q[oe],{label:W,color:H,width:se,position:$,isLineBreak:he}=dh(J);W==='"'?W=U:U=W,H===void 0&&(H=a),he||E!==null&&(se&&c.push(se),l.push(U),u.push(...E),d.push(...O),h.push(W),f.push(...$),p.push(...H)),U=W,E=$,O=H}}else if(k){let{label:q,radius:J,color:W,position:H}=dh(re);q==='"'?q=ne:ne=q,J===void 0&&(J=1),W===void 0&&(W=g),m.push(q),y.push(J),x.push(...H),v.push(...W)}else if(Y){let{label:q,color:J,position:W,isTriangleBreak:H}=dh(re);q==='"'?q=F:F=q,J===void 0&&(J=b),_.push(q),C.push(...W),w.push(H),S.push(...J)}else if(te)t.texts.push(re);else if(ee)t.captions.push(re);else if(re.startsWith("@kinemage"))t.kinemage=parseInt(re.substr(9).trim());else if(re.startsWith("@onewidth"))t.onewidth=!0;else if(re.startsWith("@1viewid"))t["1viewid"]=wf(re);else if(re.startsWith("@pdbfile"))t.pdbfile=wf(re);else if(re.startsWith("@group")){let{groupName:q,groupFlags:J,groupMasters:W}=Sf(re);t.groupDict[q]||(t.groupDict[q]={dominant:!1,animate:!1},e=W),e&&e.forEach(function(H){t.masterDict[H]||(t.masterDict[H]={indent:!1,visible:!1})});for(let H in J)t.groupDict[q][H]=J[H]}else if(re.startsWith("@subgroup")){const{groupName:q,groupFlags:J,groupMasters:W}=Sf(re);t.subgroupDict[q]||(t.subgroupDict[q]={dominant:!1,animate:!1},n=W),n&&n.forEach(function(H){t.masterDict[H]||(t.masterDict[H]={indent:!1,visible:!1})});for(let H in J)t.subgroupDict[q][H]=J[H]}else if(re.startsWith("@master")){const q=wf(re),J=eI(re);t.masterDict[q]||(t.masterDict[q]={indent:!1,visible:!1}),J==="on"?t.masterDict[q].visible=!0:J==="off"?t.masterDict[q].visible=!1:J==="indent"&&(t.masterDict[q].indent=!0)}else if(re.startsWith("@pointmaster")){const{groupName:q,groupFlags:J}=Sf(re);t.pointmasterDict[q]={id:Object.keys(J)[0].replace(QE,"")}}else console.log(re);else M=!1,L=!1,k=!1,Y=!1}})(0,j.length,j)}),t.text=t.texts.join(`
`).trim(),t.caption=t.captions.join(`
`).trim(),t.ribbonLists){let j=[];t.ribbonLists.forEach(function(Z){j.push(function(ce){let{labelArray:de,positionArray:oe,colorArray:V,breakArray:re}=ce,q=[],J=[],W=[],H=[];for(let se=0;se<re.length/3;se++){let $=3*se,he=9*se;re[$+1]||re[$+2]||(q.push(de[$]),q.push(de[$+1]),q.push(de[$+2]),H.push(re[$]),H.push(re[$+1]),H.push(re[$+2]),J.push(oe[he]),J.push(oe[he+1]),J.push(oe[he+2]),J.push(oe[he+3]),J.push(oe[he+4]),J.push(oe[he+5]),J.push(oe[he+6]),J.push(oe[he+7]),J.push(oe[he+8]),W.push(V[he]),W.push(V[he+1]),W.push(V[he+2]),W.push(V[he+3]),W.push(V[he+4]),W.push(V[he+5]),W.push(V[he+6]),W.push(V[he+7]),W.push(V[he+8]))}return{name:ce.name,masterArray:ce.masterArray,labelArray:q,positionArray:J,breakArray:H,colorArray:W}}(function(ce){let{labelArray:de,positionArray:oe,colorArray:V,breakArray:re}=ce,q=[];for(let $=0;$<3*(de.length-2);++$)q[$]=de[$-2*Math.floor($/3)];let J=[];for(let $=0;$<3*(re.length-2);++$)J[$]=re[$-2*Math.floor($/3)];let W=[];for(let $=0;$<9*(oe.length/3-2);++$)W[$]=oe[$-6*Math.floor($/9)];let H=[];for(let $=0;$<9*(V.length/3-2);++$)H[$]=V[$-6*Math.floor($/9)];let se=[];for(let $=0;$<W.length/3;++$)se.push(new T(W[3*$],W[3*$]+1,W[3*$]+2));return{name:ce.name,masterArray:ce.masterArray,labelArray:q,positionArray:W,breakArray:J,colorArray:H}}(Z)))}),t.ribbonLists=j}Ce&&fe.timeEnd(`KinParser._parse ${this.name}`)}});class Gb extends wi{constructor(e,n){super(e,n),this.loader=this.getLoader(),this.surface=new Nu(this.name,this.path)}get type(){return"surface"}get __objName(){return"surface"}_parse(){var e=this.loader.parse(this.streamer.asText());this.surface.fromGeometry(e)}}const Hp=function(){this.regexp={vertex_pattern:/^v\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,normal_pattern:/^vn\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,uv_pattern:/^vt\s+([\d.+\-eE]+)\s+([\d.+\-eE]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /}};Hp.prototype={constructor:Hp,setPath:function(t){this.path=t},_createParserState:function(){var t={objects:[],object:{},vertices:[],normals:[],startObject:function(e,n){if(this.object&&this.object.fromDeclaration===!1)return this.object.name=e,void(this.object.fromDeclaration=n!==!1);this.object={name:e||"",geometry:{vertices:[],normals:[]},fromDeclaration:n!==!1},this.objects.push(this.object)},parseVertexIndex:function(e,n){var i=parseInt(e,10);return 3*(i>=0?i-1:i+n/3)},parseNormalIndex:function(e,n){var i=parseInt(e,10);return 3*(i>=0?i-1:i+n/3)},addVertex:function(e,n,i){var r=this.vertices,s=this.object.geometry.vertices;s.push(r[e+0]),s.push(r[e+1]),s.push(r[e+2]),s.push(r[n+0]),s.push(r[n+1]),s.push(r[n+2]),s.push(r[i+0]),s.push(r[i+1]),s.push(r[i+2])},addVertexLine:function(e){var n=this.vertices,i=this.object.geometry.vertices;i.push(n[e+0]),i.push(n[e+1]),i.push(n[e+2])},addNormal:function(e,n,i){var r=this.normals,s=this.object.geometry.normals;s.push(r[e+0]),s.push(r[e+1]),s.push(r[e+2]),s.push(r[n+0]),s.push(r[n+1]),s.push(r[n+2]),s.push(r[i+0]),s.push(r[i+1]),s.push(r[i+2])},addFace:function(e,n,i,r,s,o,a,c){var l,h=this.vertices.length,u=this.parseVertexIndex(e,h),f=this.parseVertexIndex(n,h),d=this.parseVertexIndex(i,h);if(r===void 0?this.addVertex(u,f,d):(l=this.parseVertexIndex(r,h),this.addVertex(u,f,l),this.addVertex(f,d,l)),s!==void 0){var p=this.normals.length;u=this.parseNormalIndex(s,p),f=s===o?u:this.parseNormalIndex(o,p),d=s===a?u:this.parseNormalIndex(a,p),r===void 0?this.addNormal(u,f,d):(l=this.parseNormalIndex(c,p),this.addNormal(u,f,l),this.addNormal(f,d,l))}},addLineGeometry:function(e){this.object.geometry.type="Line";for(var n=this.vertices.length,i=0,r=e.length;i<r;i++)this.addVertexLine(this.parseVertexIndex(e[i],n))}};return t.startObject("",!1),t},parse:function(t){var e,n,i=this._createParserState();t.indexOf(`\r
`)!==-1&&(t=t.replace(/\r\n/g,`
`)),t.indexOf(`\\
`)!==-1&&(t=t.replace(/\\\n/g,""));var r=t.split(`
`),s="",o="",a="",c=[],l=typeof"".trimLeft=="function";for(e=0,n=r.length;e<n;e++)if(s=r[e],(s=l?s.trimLeft():s.trim()).length!==0&&(o=s.charAt(0))!=="#"){if(o==="v"){if((a=s.charAt(1))===" "&&(c=this.regexp.vertex_pattern.exec(s))!==null)i.vertices.push(parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]));else if(a==="n"&&(c=this.regexp.normal_pattern.exec(s))!==null)i.normals.push(parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]));else if(a!=="t"||this.regexp.uv_pattern.exec(s)===null)throw new Error("Unexpected vertex/normal/uv line: '"+s+"'")}else if(o==="f"){if((c=this.regexp.face_vertex_uv_normal.exec(s))!==null)i.addFace(c[1],c[4],c[7],c[10],c[3],c[6],c[9],c[12]);else if(this.regexp.face_vertex_uv.exec(s)===null)if((c=this.regexp.face_vertex_normal.exec(s))!==null)i.addFace(c[1],c[3],c[5],c[7],c[2],c[4],c[6],c[8]);else{if((c=this.regexp.face_vertex.exec(s))===null)throw new Error("Unexpected face line: '"+s+"'");i.addFace(c[1],c[2],c[3],c[4])}}else if(o==="l"){var h=s.substring(1).trim().split(" "),u=[],f=[];if(s.indexOf("/")===-1)u=h;else for(var d=0,p=h.length;d<p;d++){var y=h[d].split("/");y[0]!==""&&u.push(y[0]),y[1]!==""&&f.push(y[1])}i.addLineGeometry(u,f)}else if((c=this.regexp.object_pattern.exec(s))!==null){var g=c[0].substr(1).trim();i.startObject(g)}else if(!this.regexp.material_use_pattern.test(s)){if(!this.regexp.material_library_pattern.test(s)){if(this.regexp.smoothing_pattern.exec(s)===null){if(s==="\0")continue;throw new Error("Unexpected line: '"+s+"'")}}}}var m=[];for(e=0,n=i.objects.length;e<n;e++){var x=i.objects[e].geometry;if(x.vertices.length!==0){var v=new We;v.setAttribute("position",new Qe(new Float32Array(x.vertices),3)),x.normals.length>0?v.setAttribute("normal",new Qe(new Float32Array(x.normals),3)):v.computeVertexNormals(),m.push(v)}}return m}};it.add("obj",class extends Gb{get type(){return"obj"}getLoader(){return new Hp}});const $p=function(){this.propertyNameMapping={}};$p.prototype={constructor:$p,setPropertyNameMapping:function(t){this.propertyNameMapping=t},bin2str:function(t){for(var e=new Uint8Array(t),n="",i=0;i<t.byteLength;i++)n+=String.fromCharCode(e[i]);return n},isASCII:function(t){return this.parseHeader(this.bin2str(t)).format==="ascii"},parse:function(t){return t instanceof ArrayBuffer?this.isASCII(t)?this.parseASCII(this.bin2str(t)):this.parseBinary(t):this.parseASCII(t)},parseHeader:function(t){var e="",n=0,i=/ply([\s\S]*)end_header\s/.exec(t);i!==null&&(e=i[1],n=i[0].length);for(var r,s,o,a,c,l,h={comments:[],elements:[],headerLength:n},u=e.split(`
`),f=0;f<u.length;f++){var d=u[f];if((d=d.trim())!=="")switch(s=(o=d.split(/\s+/)).shift(),d=o.join(" "),s){case"format":h.format=o[0],h.version=o[1];break;case"comment":h.comments.push(d);break;case"element":r!==void 0&&h.elements.push(r),(r={}).name=o[0],r.count=parseInt(o[1]),r.properties=[];break;case"property":r.properties.push((a=o,c=this.propertyNameMapping,l=void 0,(l={type:a[0]}).type==="list"?(l.name=a[3],l.countType=a[1],l.itemType=a[2]):l.name=a[1],l.name in c&&(l.name=c[l.name]),l));break;default:console.log("unhandled",s,o)}}return r!==void 0&&h.elements.push(r),h},parseASCIINumber:function(t,e){switch(e){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(t);case"float":case"double":case"float32":case"float64":return parseFloat(t)}},parseASCIIElement:function(t,e){for(var n=e.split(/\s+/),i={},r=0;r<t.length;r++)if(t[r].type==="list"){for(var s=[],o=this.parseASCIINumber(n.shift(),t[r].countType),a=0;a<o;a++)s.push(this.parseASCIINumber(n.shift(),t[r].itemType));i[t[r].name]=s}else i[t[r].name]=this.parseASCIINumber(n.shift(),t[r].type);return i},parseASCII:function(t){var e,n=new rt,i=this.parseHeader(t),r="";(e=/end_header\s([\s\S]*)$/.exec(t))!==null&&(r=e[1]);var s=r.split(`
`),o=0,a=0;n.useColor=!1;for(var c=0;c<s.length;c++){var l=s[c];if((l=l.trim())!==""){a>=i.elements[o].count&&(o++,a=0);var h=this.parseASCIIElement(i.elements[o].properties,l);this.handleElement(n,i.elements[o].name,h),a++}}return this.postProcess(n)},postProcess:function(t){if(t.useColor){for(var e=0;e<t.faces.length;e++)t.faces[e].vertexColors=[t.colors[t.faces[e].a],t.colors[t.faces[e].b],t.colors[t.faces[e].c]];t.elementsNeedUpdate=!0}return t.computeBoundingSphere(),t},handleElement:function(t,e,n){if(e==="vertex"){if(t.vertices.push(new T(n.x,n.y,n.z)),"red"in n&&"green"in n&&"blue"in n){t.useColor=!0;var i=new ke;i.setRGB(n.red/255,n.green/255,n.blue/255),t.colors.push(i)}}else if(e==="face"){var r=n.vertex_indices;r.length===3?t.faces.push(new ds(r[0],r[1],r[2])):r.length===4&&t.faces.push(new ds(r[0],r[1],r[3]),new ds(r[1],r[2],r[3]))}},binaryRead:function(t,e,n,i){switch(n){case"int8":case"char":return[t.getInt8(e),1];case"uint8":case"uchar":return[t.getUint8(e),1];case"int16":case"short":return[t.getInt16(e,i),2];case"uint16":case"ushort":return[t.getUint16(e,i),2];case"int32":case"int":return[t.getInt32(e,i),4];case"uint32":case"uint":return[t.getUint32(e,i),4];case"float32":case"float":return[t.getFloat32(e,i),4];case"float64":case"double":return[t.getFloat64(e,i),8]}},binaryReadElement:function(t,e,n,i){for(var r,s={},o=0,a=0;a<n.length;a++)if(n[a].type==="list"){var c=[],l=(r=this.binaryRead(t,e+o,n[a].countType,i))[0];o+=r[1];for(var h=0;h<l;h++)r=this.binaryRead(t,e+o,n[a].itemType,i),c.push(r[0]),o+=r[1];s[n[a].name]=c}else r=this.binaryRead(t,e+o,n[a].type,i),s[n[a].name]=r[0],o+=r[1];return[s,o]},parseBinary:function(t){for(var e,n=new rt,i=this.parseHeader(this.bin2str(t)),r=i.format==="binary_little_endian",s=new DataView(t,i.headerLength),o=0,a=0;a<i.elements.length;a++)for(var c=0;c<i.elements[a].count;c++){o+=(e=this.binaryReadElement(s,o,i.elements[a].properties,r))[1];var l=e[0];this.handleElement(n,i.elements[a].name,l)}return this.postProcess(n)}};it.add("ply",class extends Gb{get type(){return"ply"}getLoader(){return new $p}});it.add("csv",class extends wi{constructor(t,e){const n=e||{};super(t,n),this.delimiter=I(n.delimiter,","),this.comment=I(n.comment,"#"),this.columnNames=I(n.columnNames,!1),this.table={name:this.name,path:this.path,columnNames:[],data:[]}}get type(){return"csv"}get __objName(){return"table"}_parse(){const t=this.table.data,e=new RegExp("\\s*"+this.delimiter+"\\s*");let n=0;this.streamer.eachChunkOfLines(i=>{const r=i.length;for(let s=0;s<r;++s){const o=i[s].trim();if(o.startsWith(this.comment))continue;const a=o.split(e);n===0?this.table.columnNames=a:o&&t.push(a),++n}})}});it.add("json",class extends wi{constructor(t,e){const n=e||{};super(t,n),this.string=I(n.string,!1),this.json={name:this.name,path:this.path,data:{}}}get type(){return"json"}get __objName(){return"json"}get isJson(){return!0}_parse(){this.streamer.isBinary()||this.string?this.json.data=JSON.parse(this.streamer.asText()):this.json.data=this.streamer.data}});it.add("msgpack",class extends wi{constructor(t,e){super(t,e||{}),this.msgpack={name:this.name,path:this.path,data:void 0}}get type(){return"msgpack"}get __objName(){return"msgpack"}get isBinary(){return!0}_parse(){Ce&&fe.time("MsgpackParser._parse "+this.name),this.msgpack.data=Db(this.streamer.data),Ce&&fe.timeEnd("MsgpackParser._parse "+this.name)}});it.add("netcdf",class extends wi{constructor(t,e){super(t,e||{}),this.netcdf={name:this.name,path:this.path,data:void 0}}get type(){return"netcdf"}get __objName(){return"netcdf"}get isBinary(){return!0}_parse(){Ce&&fe.time("NetcdfParser._parse "+this.name),this.netcdf.data=new kb(this.streamer.data),Ce&&fe.timeEnd("NetcdfParser._parse "+this.name)}});class fy extends wi{constructor(e,n){super(e,n),this.text={name:this.name,path:this.path,data:""}}get type(){return"text"}get __objName(){return"text"}_parse(){this.text.data=this.streamer.asText()}}it.add("txt",fy),it.add("text",fy);const tI=/^['"]|['"]$/g,nI=/^<([\w-:.]+)\s*/,iI=/^([^<]*)/,rI=/([\w:-]+)\s*=\s*("[^"]*"|'[^']*'|\w+)\s*/;function sI(t){return t=t.trim().replace(/<!--[\s\S]*?-->/g,""),{declaration:e(),root:n()};function e(){if(!r(/^<\?xml\s*/))return;const a={attributes:{}};for(;!s()&&!o("?>");){const c=i();if(!c)return a;a.attributes[c.name]=c.value}return r(/\?>\s*/),a}function n(){const a=r(nI);if(!a)return;const c={name:a[1],attributes:{},children:[]};for(;!(s()||o(">")||o("?>")||o("/>"));){const h=i();if(!h)return c;c.attributes[h.name]=h.value}if(r(/^\s*\/>\s*/))return c;let l;for(r(/\??>\s*/),c.content=function(){const h=r(iI);return h?h[1]:""}();l=n();)c.children.push(l);return r(/^<\/[\w-:.]+>\s*/),c}function i(){const a=r(rI);var c;if(a)return{name:a[1],value:(c=a[2],c.replace(tI,""))}}function r(a){const c=t.match(a);if(c)return t=t.slice(c[0].length),c}function s(){return t.length===0}function o(a){return t.indexOf(a)===0}}class Ub extends wi{constructor(e,n){const i=n||{};super(e,i),this.useDomParser=I(i.useDomParser,!1),this.xml={name:this.name,path:this.path,data:{}}}get type(){return"xml"}get __objName(){return"xml"}get isXml(){return!0}__xmlParser(e){return sI(e)}__domParser(e){return new window.DOMParser().parseFromString(e,"text/xml")}_parse(){Ce&&fe.time("XmlParser._parse "+this.name),this.useDomParser?this.streamer.data instanceof Document?this.xml.data=this.streamer.data:this.xml.data=this.__domParser(this.streamer.asText()):this.xml.data=this.__xmlParser(this.streamer.asText()),Ce&&fe.timeEnd("XmlParser._parse "+this.name)}}function fn(t,e){const n=t.getNamedItem(e);return n!==null?n.value:""}function py(t,e,n=!1){const i=fn(t,"icode").trim(),r=fn(t,"chain").trim(),s=fn(t,"altcode");let o=fn(t,"resnum");return i&&(o+="^"+i),r&&(o+=":"+r),e&&(o+="."+e),n&&s.trim()&&(o+="%"+s),o+="/"+(parseInt(fn(t,"model"))-1),o}function oI(t){const e=fn(t,"chain").trim();let n=`[${fn(t,"rescode")}]${fn(t,"resnum")}`;return e&&(n+=`:${e}`),n}function Mf(t,e,n){t[e]===void 0?t[e]=n:t[e]|=n}function Af(t,e){return t!==null&&t.value===e}function aI(t,e,n){let i=0;const r=e.getElementsByTagName("clash");for(let s=0,o=r.length;s<o;++s)if(t[fn(r[s].attributes,"cid")]){i+=1;break}return e.getElementsByTagName("angle-outlier").length>0&&(i+=1),e.getElementsByTagName("bond-outlier").length>0&&(i+=1),e.getElementsByTagName("plane-outlier").length>0&&(i+=1),Af(n.getNamedItem("rota"),"OUTLIER")&&(i+=1),Af(n.getNamedItem("rama"),"OUTLIER")&&(i+=1),Af(n.getNamedItem("RNApucker"),"outlier")&&(i+=1),i}it.add("xml",Ub);class cI{constructor(e,n){this.name=e,this.path=n,this.rsrzDict={},this.rsccDict={},this.rciDict={},this.clashDict={},this.clashArray=[],this.geoDict={},this.geoAtomDict={},this.atomDict={},this.clashSele="NONE"}get type(){return"validation"}fromXml(e){Ce&&fe.time("Validation.fromXml");const n=this.rsrzDict,i=this.rsccDict,r=this.rciDict,s=this.clashDict,o=this.clashArray,a=this.geoDict,c=this.geoAtomDict,l=this.atomDict,h=e.getElementsByTagName("Entry");if(h.length===1){const p=h[0].getElementsByTagName("chemical_shift_list");if(p.length===1){const y=p[0].getElementsByTagName("random_coil_index");for(let g=0,m=y.length;g<m;++g){const x=y[g].attributes;r[oI(x)]=parseFloat(fn(x,"value"))}}}const u=e.getElementsByTagName("ModelledSubgroup"),f={},d=[];Ce&&fe.time("Validation.fromXml#clashDict");for(let p=0,y=u.length;p<y;++p){const g=u[p],m=g.attributes,x=py(m);m.getNamedItem("rsrz")!==null&&(n[x]=parseFloat(fn(m,"rsrz"))),m.getNamedItem("rscc")!==null&&(i[x]=parseFloat(fn(m,"rscc")));const v=e.createAttribute("sele");v.value=x,m.setNamedItem(v);const b=g.getElementsByTagName("clash");for(let _=0,C=b.length;_<C;++_){const w=b[_].attributes,S=fn(w,"atom");if(xm(S)!=="H"){const M=fn(w,"cid"),B=py(m,S,!0);if(l[B]=!0,f[M]===void 0)f[M]={sele1:B,res1:x};else{const L=f[M];L.res1!==x&&(L.sele2=B,L.res2=x,d.push(L.res1,x),s[M]=L,o.push(L))}}}}Ce&&fe.timeEnd("Validation.fromXml#clashDict");for(let p=0,y=u.length;p<y;++p){const g=u[p],m=g.attributes,x=fn(m,"sele");if(fn(m,"seq")!=="."){const v=aI(s,g,m);v>0&&(a[x]=v)}else{const v=g.getElementsByTagName("clash"),b=g.getElementsByTagName("mog-bond-outlier"),_=g.getElementsByTagName("mog-angle-outlier");if(b.length>0||_.length>0||v.length>0){const C={};c[x]=C;for(let w=0,S=v.length;w<S;++w){const M=v[w].attributes;s[fn(M,"cid")]&&Mf(C,fn(M,"atom"),1)}for(let w=0,S=b.length;w<S;++w)fn(b[w].attributes,"atoms").split(",").forEach(function(M){Mf(C,M,2)});for(let w=0,S=_.length;w<S;++w)fn(_[w].attributes,"atoms").split(",").forEach(function(M){Mf(C,M,4)})}}}this.clashSele=d.length?d.join(" OR "):"NONE",Ce&&fe.timeEnd("Validation.fromXml")}getClashData(e){Ce&&fe.time("Validation.getClashData");const n=e||{},i=n.structure,r=i.atomSet,s=new ke(I(n.color,"#f0027f")),o=i.getAtomProxy(),a=i.getAtomProxy(),c=new T,l=new T,h=new T,u=this.clashArray,f=u.length,d=new Float32Array(3*f),p=new Float32Array(3*f),y=Bt(f,s.r,s.g,s.b),g=new Float32Array(f),m=new Float32Array(f);Ce&&fe.time("Validation.getClashData#atomDict");const x=this.atomDict;i.eachAtom(function(b){const _=function(C){const w=C.inscode,S=C.chainname,M=C.atomname,B=C.altloc;let L=C.resno+"";return w&&(L+="^"+w),S&&(L+=":"+S),M&&(L+="."+M),B&&(L+="%"+B),L+="/"+C.modelIndex,L}(b);x[_]===!0&&(x[_]=b.index)}),Ce&&fe.timeEnd("Validation.getClashData#atomDict");let v=0;return u.forEach(function(b,_){if(o.index=x[b.sele1],a.index=x[b.sele2],o.index===void 0||a.index===void 0||!r.isSet(o.index,a.index))return;c.subVectors(a,o).setLength(o.vdw),l.copy(o).add(c),c.subVectors(o,a).setLength(a.vdw),h.copy(a).add(c);const C=o.distanceTo(a)/2,w=Math.sqrt(o.vdw*o.vdw-C*C),S=Math.sqrt(a.vdw*a.vdw-C*C);l.toArray(d,3*v),h.toArray(p,3*v),g[v]=(w+S)/2,m[v]=_,++v}),Ce&&fe.timeEnd("Validation.getClashData"),{position1:d.subarray(0,3*v),position2:p.subarray(0,3*v),color:y.subarray(0,3*v),color2:y.subarray(0,3*v),radius:g.subarray(0,v),picking:new TC(m.subarray(0,v),this,i)}}}function Vb(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)}function wo(t,e,n,i,r){if(e.subarray&&t.subarray)t.set(e.subarray(n,n+i),r);else for(var s=0;s<i;s++)t[r+s]=e[n+s]}function Wp(t,e,n,i){for(var r=65535&t|0,s=t>>>16&65535|0,o=0;n!==0;){n-=o=n>2e3?2e3:n;do s=s+(r=r+e[i++]|0)|0;while(--o);r%=65521,s%=65521}return r|s<<16|0}it.add("validation",class extends Ub{constructor(t,e){super(t,e||{}),this.useDomParser=!0,this.validation=new cI(this.name,this.path)}get __objName(){return"validation"}get isXml(){return!0}_parse(){super._parse(),Ce&&fe.time("ValidationParser._parse "+this.name),this.validation.fromXml(this.xml.data),Ce&&fe.timeEnd("ValidationParser._parse "+this.name)}});var lI=function(){for(var t,e=[],n=0;n<256;n++){t=n;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e}();function Ii(t,e,n,i){var r=lI,s=i+n;t^=-1;for(var o=i;o<s;o++)t=t>>>8^r[255&(t^e[o])];return-1^t}var fh=30,hI=12;function uI(t,e){var n,i,r,s,o,a,c,l,h,u,f,d,p,y,g,m,x,v,b,_,C,w,S,M,B;n=t.state,i=t.next_in,M=t.input,r=i+(t.avail_in-5),s=t.next_out,B=t.output,o=s-(e-t.avail_out),a=s+(t.avail_out-257),c=n.dmax,l=n.wsize,h=n.whave,u=n.wnext,f=n.window,d=n.hold,p=n.bits,y=n.lencode,g=n.distcode,m=(1<<n.lenbits)-1,x=(1<<n.distbits)-1;e:do{p<15&&(d+=M[i++]<<p,p+=8,d+=M[i++]<<p,p+=8),v=y[d&m];t:for(;;){if(d>>>=b=v>>>24,p-=b,(b=v>>>16&255)===0)B[s++]=65535&v;else{if(!(16&b)){if(!(64&b)){v=y[(65535&v)+(d&(1<<b)-1)];continue t}if(32&b){n.mode=hI;break e}t.msg="invalid literal/length code",n.mode=fh;break e}_=65535&v,(b&=15)&&(p<b&&(d+=M[i++]<<p,p+=8),_+=d&(1<<b)-1,d>>>=b,p-=b),p<15&&(d+=M[i++]<<p,p+=8,d+=M[i++]<<p,p+=8),v=g[d&x];n:for(;;){if(d>>>=b=v>>>24,p-=b,!(16&(b=v>>>16&255))){if(!(64&b)){v=g[(65535&v)+(d&(1<<b)-1)];continue n}t.msg="invalid distance code",n.mode=fh;break e}if(C=65535&v,p<(b&=15)&&(d+=M[i++]<<p,(p+=8)<b&&(d+=M[i++]<<p,p+=8)),(C+=d&(1<<b)-1)>c){t.msg="invalid distance too far back",n.mode=fh;break e}if(d>>>=b,p-=b,C>(b=s-o)){if((b=C-b)>h&&n.sane){t.msg="invalid distance too far back",n.mode=fh;break e}if(w=0,S=f,u===0){if(w+=l-b,b<_){_-=b;do B[s++]=f[w++];while(--b);w=s-C,S=B}}else if(u<b){if(w+=l+u-b,(b-=u)<_){_-=b;do B[s++]=f[w++];while(--b);if(w=0,u<_){_-=b=u;do B[s++]=f[w++];while(--b);w=s-C,S=B}}}else if(w+=u-b,b<_){_-=b;do B[s++]=f[w++];while(--b);w=s-C,S=B}for(;_>2;)B[s++]=S[w++],B[s++]=S[w++],B[s++]=S[w++],_-=3;_&&(B[s++]=S[w++],_>1&&(B[s++]=S[w++]))}else{w=s-C;do B[s++]=B[w++],B[s++]=B[w++],B[s++]=B[w++],_-=3;while(_>2);_&&(B[s++]=B[w++],_>1&&(B[s++]=B[w++]))}break}}break}}while(i<r&&s<a);i-=_=p>>3,d&=(1<<(p-=_<<3))-1,t.next_in=i,t.next_out=s,t.avail_in=i<r?r-i+5:5-(i-r),t.avail_out=s<a?a-s+257:257-(s-a),n.hold=d,n.bits=p}var to=15,my=852,gy=592,yy=0,Cf=1,xy=2,dI=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],fI=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],pI=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],mI=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];function rc(t,e,n,i,r,s,o,a){var c,l,h,u,f,d,p,y,g,m=a.bits,x=0,v=0,b=0,_=0,C=0,w=0,S=0,M=0,B=0,L=0,U=null,E=0,O=new Uint16Array(to+1),k=new Uint16Array(to+1),ne=null,Y=0;for(x=0;x<=to;x++)O[x]=0;for(v=0;v<i;v++)O[e[n+v]]++;for(C=m,_=to;_>=1&&O[_]===0;_--);if(C>_&&(C=_),_===0)return r[s++]=20971520,r[s++]=20971520,a.bits=1,0;for(b=1;b<_&&O[b]===0;b++);for(C<b&&(C=b),M=1,x=1;x<=to;x++)if(M<<=1,(M-=O[x])<0)return-1;if(M>0&&(t===yy||_!==1))return-1;for(k[1]=0,x=1;x<to;x++)k[x+1]=k[x]+O[x];for(v=0;v<i;v++)e[n+v]!==0&&(o[k[e[n+v]]++]=v);if(t===yy?(U=ne=o,d=19):t===Cf?(U=dI,E-=257,ne=fI,Y-=257,d=256):(U=pI,ne=mI,d=-1),L=0,v=0,x=b,f=s,w=C,S=0,h=-1,u=(B=1<<C)-1,t===Cf&&B>my||t===xy&&B>gy)return 1;for(;;){p=x-S,o[v]<d?(y=0,g=o[v]):o[v]>d?(y=ne[Y+o[v]],g=U[E+o[v]]):(y=96,g=0),c=1<<x-S,b=l=1<<w;do r[f+(L>>S)+(l-=c)]=p<<24|y<<16|g|0;while(l!==0);for(c=1<<x-1;L&c;)c>>=1;if(c!==0?(L&=c-1,L+=c):L=0,v++,--O[x]==0){if(x===_)break;x=e[n+o[v]]}if(x>C&&(L&u)!==h){for(S===0&&(S=C),f+=b,M=1<<(w=x-S);w+S<_&&!((M-=O[w+S])<=0);)w++,M<<=1;if(B+=1<<w,t===Cf&&B>my||t===xy&&B>gy)return 1;r[h=L&u]=C<<24|w<<16|f-s|0}}return L!==0&&(r[f+L]=x-S<<24|64<<16|0),a.bits=C,0}var Hb=1,$b=2,Xo=0,Ni=-2,Wb=1,er=12,Jt=30,gI=852,yI=592;function by(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function xI(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function bI(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,function(n){var i;return n&&n.state?(i=n.state,n.total_in=n.total_out=i.total=0,n.msg="",i.wrap&&(n.adler=1&i.wrap),i.mode=Wb,i.last=0,i.havedict=0,i.dmax=32768,i.head=null,i.hold=0,i.bits=0,i.lencode=i.lendyn=new Int32Array(gI),i.distcode=i.distdyn=new Int32Array(yI),i.sane=1,i.back=-1,Xo):Ni}(t)):Ni}function vI(t,e){var n,i;return t?(i=new xI,t.state=i,i.window=null,n=function(r,s){var o,a;return r&&r.state?(a=r.state,s<0?(o=0,s=-s):(o=1+(s>>4),s<48&&(s&=15)),s&&(s<8||s>15)?Ni:(a.window!==null&&a.wbits!==s&&(a.window=null),a.wrap=o,a.wbits=s,bI(r))):Ni}(t,e),n!==Xo&&(t.state=null),n):Ni}var Tf,Pf,vy=!0;function _I(t){if(vy){var e;for(Tf=new Int32Array(512),Pf=new Int32Array(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(rc(Hb,t.lens,0,288,Tf,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;rc($b,t.lens,0,32,Pf,0,t.work,{bits:5}),vy=!1}t.lencode=Tf,t.lenbits=9,t.distcode=Pf,t.distbits=5}function jb(t,e,n,i){var r,s=t.state;return s.window===null&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),i>=s.wsize?(wo(s.window,e,n-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):((r=s.wsize-s.wnext)>i&&(r=i),wo(s.window,e,n-i,r,s.wnext),(i-=r)?(wo(s.window,e,n-i,i,0),s.wnext=i,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0}function wI(t,e){var n,i,r,s,o,a,c,l,h,u,f,d,p,y,g,m,x,v,b,_,C,w,S,M,B=0,L=new Uint8Array(4),U=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&t.avail_in!==0)return Ni;(n=t.state).mode===er&&(n.mode=13),o=t.next_out,r=t.output,c=t.avail_out,s=t.next_in,i=t.input,a=t.avail_in,l=n.hold,h=n.bits,u=a,f=c,w=Xo;e:for(;;)switch(n.mode){case Wb:if(n.wrap===0){n.mode=13;break}for(;h<16;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if(2&n.wrap&&l===35615){n.check=0,L[0]=255&l,L[1]=l>>>8&255,n.check=Ii(n.check,L,2,0),l=0,h=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&l)<<8)+(l>>8))%31){t.msg="incorrect header check",n.mode=Jt;break}if((15&l)!=8){t.msg="unknown compression method",n.mode=Jt;break}if(h-=4,C=8+(15&(l>>>=4)),n.wbits===0)n.wbits=C;else if(C>n.wbits){t.msg="invalid window size",n.mode=Jt;break}n.dmax=1<<C,t.adler=n.check=1,n.mode=512&l?10:er,l=0,h=0;break;case 2:for(;h<16;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if(n.flags=l,(255&n.flags)!=8){t.msg="unknown compression method",n.mode=Jt;break}if(57344&n.flags){t.msg="unknown header flags set",n.mode=Jt;break}n.head&&(n.head.text=l>>8&1),512&n.flags&&(L[0]=255&l,L[1]=l>>>8&255,n.check=Ii(n.check,L,2,0)),l=0,h=0,n.mode=3;case 3:for(;h<32;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}n.head&&(n.head.time=l),512&n.flags&&(L[0]=255&l,L[1]=l>>>8&255,L[2]=l>>>16&255,L[3]=l>>>24&255,n.check=Ii(n.check,L,4,0)),l=0,h=0,n.mode=4;case 4:for(;h<16;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}n.head&&(n.head.xflags=255&l,n.head.os=l>>8),512&n.flags&&(L[0]=255&l,L[1]=l>>>8&255,n.check=Ii(n.check,L,2,0)),l=0,h=0,n.mode=5;case 5:if(1024&n.flags){for(;h<16;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}n.length=l,n.head&&(n.head.extra_len=l),512&n.flags&&(L[0]=255&l,L[1]=l>>>8&255,n.check=Ii(n.check,L,2,0)),l=0,h=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&((d=n.length)>a&&(d=a),d&&(n.head&&(C=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),wo(n.head.extra,i,s,d,C)),512&n.flags&&(n.check=Ii(n.check,i,d,s)),a-=d,s+=d,n.length-=d),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(a===0)break e;d=0;do C=i[s+d++],n.head&&C&&n.length<65536&&(n.head.name+=String.fromCharCode(C));while(C&&d<a);if(512&n.flags&&(n.check=Ii(n.check,i,d,s)),a-=d,s+=d,C)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(a===0)break e;d=0;do C=i[s+d++],n.head&&C&&n.length<65536&&(n.head.comment+=String.fromCharCode(C));while(C&&d<a);if(512&n.flags&&(n.check=Ii(n.check,i,d,s)),a-=d,s+=d,C)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;h<16;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if(l!==(65535&n.check)){t.msg="header crc mismatch",n.mode=Jt;break}l=0,h=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=er;break;case 10:for(;h<32;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}t.adler=n.check=by(l),l=0,h=0,n.mode=11;case 11:if(n.havedict===0)return t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,n.hold=l,n.bits=h,2;t.adler=n.check=1,n.mode=er;case er:if(e===5||e===6)break e;case 13:if(n.last){l>>>=7&h,h-=7&h,n.mode=27;break}for(;h<3;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}switch(n.last=1&l,h-=1,3&(l>>>=1)){case 0:n.mode=14;break;case 1:if(_I(n),n.mode=20,e===6){l>>>=2,h-=2;break e}break;case 2:n.mode=17;break;case 3:t.msg="invalid block type",n.mode=Jt}l>>>=2,h-=2;break;case 14:for(l>>>=7&h,h-=7&h;h<32;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if((65535&l)!=(l>>>16^65535)){t.msg="invalid stored block lengths",n.mode=Jt;break}if(n.length=65535&l,l=0,h=0,n.mode=15,e===6)break e;case 15:n.mode=16;case 16:if(d=n.length){if(d>a&&(d=a),d>c&&(d=c),d===0)break e;wo(r,i,s,d,o),a-=d,s+=d,c-=d,o+=d,n.length-=d;break}n.mode=er;break;case 17:for(;h<14;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if(n.nlen=257+(31&l),l>>>=5,h-=5,n.ndist=1+(31&l),l>>>=5,h-=5,n.ncode=4+(15&l),l>>>=4,h-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=Jt;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;h<3;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}n.lens[U[n.have++]]=7&l,l>>>=3,h-=3}for(;n.have<19;)n.lens[U[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,S={bits:n.lenbits},w=rc(0,n.lens,0,19,n.lencode,0,n.work,S),n.lenbits=S.bits,w){t.msg="invalid code lengths set",n.mode=Jt;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;m=(B=n.lencode[l&(1<<n.lenbits)-1])>>>16&255,x=65535&B,!((g=B>>>24)<=h);){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if(x<16)l>>>=g,h-=g,n.lens[n.have++]=x;else{if(x===16){for(M=g+2;h<M;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if(l>>>=g,h-=g,n.have===0){t.msg="invalid bit length repeat",n.mode=Jt;break}C=n.lens[n.have-1],d=3+(3&l),l>>>=2,h-=2}else if(x===17){for(M=g+3;h<M;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}h-=g,C=0,d=3+(7&(l>>>=g)),l>>>=3,h-=3}else{for(M=g+7;h<M;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}h-=g,C=0,d=11+(127&(l>>>=g)),l>>>=7,h-=7}if(n.have+d>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=Jt;break}for(;d--;)n.lens[n.have++]=C}}if(n.mode===Jt)break;if(n.lens[256]===0){t.msg="invalid code -- missing end-of-block",n.mode=Jt;break}if(n.lenbits=9,S={bits:n.lenbits},w=rc(Hb,n.lens,0,n.nlen,n.lencode,0,n.work,S),n.lenbits=S.bits,w){t.msg="invalid literal/lengths set",n.mode=Jt;break}if(n.distbits=6,n.distcode=n.distdyn,S={bits:n.distbits},w=rc($b,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,S),n.distbits=S.bits,w){t.msg="invalid distances set",n.mode=Jt;break}if(n.mode=20,e===6)break e;case 20:n.mode=21;case 21:if(a>=6&&c>=258){t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,n.hold=l,n.bits=h,uI(t,f),o=t.next_out,r=t.output,c=t.avail_out,s=t.next_in,i=t.input,a=t.avail_in,l=n.hold,h=n.bits,n.mode===er&&(n.back=-1);break}for(n.back=0;m=(B=n.lencode[l&(1<<n.lenbits)-1])>>>16&255,x=65535&B,!((g=B>>>24)<=h);){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if(m&&!(240&m)){for(v=g,b=m,_=x;m=(B=n.lencode[_+((l&(1<<v+b)-1)>>v)])>>>16&255,x=65535&B,!(v+(g=B>>>24)<=h);){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}l>>>=v,h-=v,n.back+=v}if(l>>>=g,h-=g,n.back+=g,n.length=x,m===0){n.mode=26;break}if(32&m){n.back=-1,n.mode=er;break}if(64&m){t.msg="invalid literal/length code",n.mode=Jt;break}n.extra=15&m,n.mode=22;case 22:if(n.extra){for(M=n.extra;h<M;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}n.length+=l&(1<<n.extra)-1,l>>>=n.extra,h-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;m=(B=n.distcode[l&(1<<n.distbits)-1])>>>16&255,x=65535&B,!((g=B>>>24)<=h);){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if(!(240&m)){for(v=g,b=m,_=x;m=(B=n.distcode[_+((l&(1<<v+b)-1)>>v)])>>>16&255,x=65535&B,!(v+(g=B>>>24)<=h);){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}l>>>=v,h-=v,n.back+=v}if(l>>>=g,h-=g,n.back+=g,64&m){t.msg="invalid distance code",n.mode=Jt;break}n.offset=x,n.extra=15&m,n.mode=24;case 24:if(n.extra){for(M=n.extra;h<M;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}n.offset+=l&(1<<n.extra)-1,l>>>=n.extra,h-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=Jt;break}n.mode=25;case 25:if(c===0)break e;if(d=f-c,n.offset>d){if((d=n.offset-d)>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=Jt;break}d>n.wnext?(d-=n.wnext,p=n.wsize-d):p=n.wnext-d,d>n.length&&(d=n.length),y=n.window}else y=r,p=o-n.offset,d=n.length;d>c&&(d=c),c-=d,n.length-=d;do r[o++]=y[p++];while(--d);n.length===0&&(n.mode=21);break;case 26:if(c===0)break e;r[o++]=n.length,c--,n.mode=21;break;case 27:if(n.wrap){for(;h<32;){if(a===0)break e;a--,l|=i[s++]<<h,h+=8}if(f-=c,t.total_out+=f,n.total+=f,f&&(t.adler=n.check=n.flags?Ii(n.check,r,f,o-f):Wp(n.check,r,f,o-f)),f=c,(n.flags?l:by(l))!==n.check){t.msg="incorrect data check",n.mode=Jt;break}l=0,h=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;h<32;){if(a===0)break e;a--,l+=i[s++]<<h,h+=8}if(l!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=Jt;break}l=0,h=0}n.mode=29;case 29:w=1;break e;case Jt:w=-3;break e;case 31:return-4;default:return Ni}return t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,n.hold=l,n.bits=h,(n.wsize||f!==t.avail_out&&n.mode<Jt&&(n.mode<27||e!==4))&&jb(t,t.output,t.next_out,f-t.avail_out),u-=t.avail_in,f-=t.avail_out,t.total_in+=u,t.total_out+=f,n.total+=f,n.wrap&&f&&(t.adler=n.check=n.flags?Ii(n.check,r,f,t.next_out-f):Wp(n.check,r,f,t.next_out-f)),t.data_type=n.bits+(n.last?64:0)+(n.mode===er?128:0)+(n.mode===20||n.mode===15?256:0),(u===0&&f===0||e===4)&&w===Xo&&(w=-5),w}function SI(t,e){var n,i=e.length;return t&&t.state?(n=t.state).wrap!==0&&n.mode!==11?Ni:n.mode===11&&Wp(1,e,i,0)!==n.check?-3:jb(t,e,i,i)?(n.mode=31,-4):(n.havedict=1,Xo):Ni}var qb=!0,Xb=!0;try{String.fromCharCode.apply(null,[0])}catch{qb=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Xb=!1}for(var Wc=new Uint8Array(256),Lr=0;Lr<256;Lr++)Wc[Lr]=Lr>=252?6:Lr>=248?5:Lr>=240?4:Lr>=224?3:Lr>=192?2:1;function MI(t){var e,n,i,r,s,o=t.length,a=0;for(r=0;r<o;r++)(64512&(n=t.charCodeAt(r)))==55296&&r+1<o&&(64512&(i=t.charCodeAt(r+1)))==56320&&(n=65536+(n-55296<<10)+(i-56320),r++),a+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(a),s=0,r=0;s<a;r++)(64512&(n=t.charCodeAt(r)))==55296&&r+1<o&&(64512&(i=t.charCodeAt(r+1)))==56320&&(n=65536+(n-55296<<10)+(i-56320),r++),n<128?e[s++]=n:n<2048?(e[s++]=192|n>>>6,e[s++]=128|63&n):n<65536?(e[s++]=224|n>>>12,e[s++]=128|n>>>6&63,e[s++]=128|63&n):(e[s++]=240|n>>>18,e[s++]=128|n>>>12&63,e[s++]=128|n>>>6&63,e[s++]=128|63&n);return e}function AI(t,e){var n,i,r,s,o=e||t.length,a=new Array(2*o);for(i=0,n=0;n<o;)if((r=t[n++])<128)a[i++]=r;else if((s=Wc[r])>4)a[i++]=65533,n+=s-1;else{for(r&=s===2?31:s===3?15:7;s>1&&n<o;)r=r<<6|63&t[n++],s--;s>1?a[i++]=65533:r<65536?a[i++]=r:(r-=65536,a[i++]=55296|r>>10&1023,a[i++]=56320|1023&r)}return function(c,l){if(l<65537&&(c.subarray&&Xb||!c.subarray&&qb))return String.fromCharCode.apply(null,Vb(c,l));for(var h="",u=0;u<l;u++)h+=String.fromCharCode(c[u]);return h}(a,i)}function CI(t,e){var n;for((e=e||t.length)>t.length&&(e=t.length),n=e-1;n>=0&&(192&t[n])==128;)n--;return n<0||n===0?e:n+Wc[t[n]]>e?n:e}Wc[254]=Wc[254]=1;var ao=0,TI={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};function PI(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}function EI(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var _y=Object.prototype.toString;function go(t){if(!(this instanceof go))return new go(t);this.options=function(o){for(var a=Array.prototype.slice.call(arguments,1);a.length;){var c=a.shift();if(c){if(typeof c!="object")throw new TypeError(c+"must be non-object");for(var l in c)c.hasOwnProperty(l)&&(o[l]=c[l])}}return o}({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new PI,this.strm.avail_out=0;var n,i,r,s=vI(this.strm,e.windowBits);if(s!==ao)throw new Error(TI[s]);this.header=new EI,n=this.strm,i=this.header,n&&n.state&&(!(2&(r=n.state).wrap)||(r.head=i,i.done=!1))}go.prototype.push=function(t,e){var n,i,r,s,o,a,c=this.strm,l=this.options.chunkSize,h=this.options.dictionary,u=!1;if(this.ended)return!1;i=e===~~e?e:e===!0?4:0,typeof t=="string"?c.input=function(f){for(var d=new Uint8Array(f.length),p=0,y=d.length;p<y;p++)d[p]=f.charCodeAt(p);return d}(t):_y.call(t)==="[object ArrayBuffer]"?c.input=new Uint8Array(t):c.input=t,c.next_in=0,c.avail_in=c.input.length;do{if(c.avail_out===0&&(c.output=new Uint8Array(l),c.next_out=0,c.avail_out=l),(n=wI(c,0))===2&&h&&(a=typeof h=="string"?MI(h):_y.call(h)==="[object ArrayBuffer]"?new Uint8Array(h):h,n=SI(this.strm,a)),n===-5&&u===!0&&(n=ao,u=!1),n!==1&&n!==ao)return this.onEnd(n),this.ended=!0,!1;c.next_out&&(c.avail_out!==0&&n!==1&&(c.avail_in!==0||i!==4&&i!==2)||(this.options.to==="string"?(r=CI(c.output,c.next_out),s=c.next_out-r,o=AI(c.output,r),c.next_out=s,c.avail_out=l-s,s&&wo(c.output,c.output,r,s,0),this.onData(o)):this.onData(Vb(c.output,c.next_out)))),c.avail_in===0&&c.avail_out===0&&(u=!0)}while((c.avail_in>0||c.avail_out===0)&&n!==1);return n===1&&(i=4),i===4?(n=function(f){if(!f||!f.state)return Ni;var d=f.state;return d.window&&(d.window=null),f.state=null,Xo}(this.strm),this.onEnd(n),this.ended=!0,n===ao):i!==2||(this.onEnd(ao),c.avail_out=0,!0)},go.prototype.onData=function(t){this.chunks.push(t)},go.prototype.onEnd=function(t){t===ao&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=function(e){var n,i,r,s,o,a;for(r=0,n=0,i=e.length;n<i;n++)r+=e[n].length;for(a=new Uint8Array(r),s=0,n=0,i=e.length;n<i;n++)o=e[n],a.set(o,s),s+=o.length;return a}(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},dm.add("gz",function(t){let e;t instanceof ArrayBuffer&&(t=new Uint8Array(t));try{e=function(n,i){var r=new go(i);if(r.push(n,!0),r.err)throw r.msg;return r.result}(t)}catch{e=t}return e});class rl{}const Yb="//mmtf.rcsb.org/v1.0/",Ef=Yb+"full/",II=Yb+"reduced/";Nr.add("rcsb",new class extends rl{getUrl(t){const e=Un(t),n=e.name.substr(0,4);let i;return!["pdb","cif"].includes(e.ext)||e.compressed!==!1&&e.compressed!=="gz"?e.ext==="mmtf"?i=e.base.endsWith(".bb")?II+n:Ef+n:(e.ext&&fe.warn("unsupported ext",e.ext),i=Ef+n):i="//files.rcsb.org/download/"+e.path,am()+i}getExt(t){return Un(t).ext||"mmtf"}});const wy="//pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/",Sy="/SDF?record_type=3d";Nr.add("pubchem",new class extends rl{getUrl(t){const e=Un(t),n=e.name;let i;return e.ext&&e.ext!=="sdf"&&fe.warn("unsupported ext",e.ext),i=wy+n+Sy,am()+i}getExt(t){return Un(t).ext||"sdf"}});class If extends rl{getUrl(e){return e}getExt(e){return Un(e).ext}}Nr.add("ftp",new If),Nr.add("http",new If),Nr.add("https",new If);const My="//alphafold.ebi.ac.uk/files/AF-",Ay="-F1-model_v2.pdb";Nr.add("alphafold",new class extends rl{getUrl(t){const e=Un(t),n=e.name;let i;return e.ext&&e.ext!=="pdb"&&fe.warn("unsupported AF ext",e.ext),i=My+n+Ay,am()+i}getExt(t){return Un(t).ext||"pdb"}});const LI=/^((http|https|ftp):)*\/\//;class RI extends rl{constructor(e=""){super(),this.baseUrl=e}getUrl(e){const n=Un(e);let i=this.baseUrl+n.path;return LI.test(this.baseUrl)||(i=function(r){const s=window.location,o=s.pathname,a=o.substring(0,o.lastIndexOf("/")+1);return s.origin+a+r}(i)),i}getExt(e){return Un(e).ext}}function Cy(t,e){return{type:"integer",max:t,min:e}}function no(t,e,n){return{type:"number",precision:t,max:e,min:n}}function io(t,e,n){return{type:"range",step:t,max:e,min:n}}function Va(...t){return{type:"select",options:t.reduce((e,n)=>Object.assign(Object.assign({},e),{[n]:n}),{})}}Va("auto","low","medium","high"),io(1,5,-1),no(1,10,0),no(1,10,0),no(1,10,0),io(1,100,0),io(1,100,0),Cy(200,0),Va("scene","camera"),Va("relative","absolute"),io(1,100,0),io(1,100,0),Va("perspective","orthographic","stereo"),no(3,1,.01),io(1,120,15),no(2,10,0),no(2,10,0),Cy(1e4,-1),Va(...Object.keys(cb));function DI(t,e,n,i,r){const s=n.residueStore.count,o=n.getResidueProxy(),a=t.msaview.relativePxToBp(e,i);for(let c=0;c<s;++c)if(o.index=c,o.resno===a+r-1)return o}Nr.add("data",new RI("https://files.rcsb.org/download/"));const OI=Zb(function({model:t}){const e=Ai.useRef([]),[n,i]=Ai.useState("cartoon"),[r,s]=Ai.useState([]),[o,a]=Ai.useState(),[c,l]=Ai.useState(!1),{msaview:h,nglSelection:u}=t,{selectedStructures:f,mouseCol:d}=h,p=Kb(f),y=Ai.useCallback(g=>{if(g){const m=new oP(g);a(m)}},[]);return Ai.useEffect(()=>()=>o==null?void 0:o.dispose(),[o]),Ai.useEffect(()=>{!p.length||!o||(async()=>{window.addEventListener("resize",()=>{o.handleResize()});const g=await Promise.all(p.map(m=>o.loadFile(`data://${m.structure.pdb}.pdb`)));s(g),o.signals.hovered.add(m=>{var x;if(m&&(m.atom||m.bond)){const v=m.atom||m.closestBondAtom;h.setMouseoveredColumn(v.resno-((x=p[0])==null?void 0:x.structure.startPos),v.chainname,m.picker.structure.name)}})})()},[h,p,o]),Ai.useEffect(()=>{if(o){for(const g of r)g.removeAllRepresentations(),g.addRepresentation(n,{sele:u});o.autoView()}},[n,r,o,u]),Ai.useEffect(()=>{p.length&&!c&&r.forEach((g,m)=>{if(e.current.length&&g.removeAnnotation(e.current[m]),e.current=[],d!==void 0){const x=g.structure,v=DI(t,p[m].id,x,d,p[0].structure.startPos);if(v){const b=x.getAtomProxy();b.index=v.atomOffset,e.current.push(g.addAnnotation(b.positionToVector3(),v.qualifiedName()))}}o==null||o.viewer.requestRender()})},[t,d,p,o==null?void 0:o.viewer,r,c]),f.length?Ci.jsxs("div",{style:{padding:20},children:[Ci.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[Ci.jsx(Jb,{onClick:()=>h.clearSelectedStructures(),variant:"contained",children:"Clear"}),Ci.jsx("div",{style:{width:20}}),Ci.jsxs(Qb,{value:n,onChange:g=>i(g.target.value),children:[Ci.jsx(Dm,{value:"cartoon",children:"cartoon"}),Ci.jsx(Dm,{value:"ball+stick",children:"ball+stick"})]}),Ci.jsx("div",{style:{width:20}}),Ci.jsx(ev,{variant:"outlined",label:"Selection",value:u,onChange:g=>t.setNGLSelection(g.target.value)})]}),Ci.jsx("div",{ref:y,style:{width:600,height:400},onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1)})]}):null});export{OI as default};
//# sourceMappingURL=ProteinPanel-HUkUo4id.js.map
